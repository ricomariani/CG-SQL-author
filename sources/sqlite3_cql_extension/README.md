# SQLite3 CQL Extension

<!-- build_requirements_start -->
## Requirements

### Local SQLite3

- Code source must be available to compile the extension (sqlite3ext.h).
- The compiled SQLite3 binary must allow loading extensions
- The checked in Sqlite should do the job `export SQLITE_PATH=../sqlite`
- The version of the binary must match the version of the code source

```bash
git clone https://github.com/sqlite/sqlite.git && cd sqlite
./configure && make sqlite3-all.c
gcc -g -O0 -DSQLITE_ENABLE_LOAD_EXTENSION -o sqlite3 sqlite3-all.c shell.c
```
<!-- build_requirements_end -->


## Build the Demo and Execute

```bash
demo.sh
```

### Essential Files

* `Sample.sql`
  * contains the CQL that we are trying to project into SQLite
* `TestCases.sql`
  * contains test cases that use the procedures in the Sample and verify their output
  * the test cases are written in CQL but they invoke the sample code via the SQLite
    mechanism not my calling it directly
* `cqlsqlite3extension.py`
  * This is the python that creates the necessary glue code to invoke the procedures
* `cql_sqlite_extension.h` and `cql_sqlite_extension.c`
  * These contain the standard helper functions needed to do table valued functions

### Generated:

* `out/Sample.c` `out/Sample.h`
  * the normal C code that corrsponds to `Sample.sql`
* `out/Sample.json`
  * the JSON schema for `Sample.sql` generated with `--rt json_schema`
* `out/SampleInterop.c`
  * the interop glue generated by `cqlsqlite3extension.py`
* `out/TestCases.c`  `out/TestCases.h`
  * the normal C code output that corresponds `to TestCases.sql`
* `out/demo`
  * the demonstration file including the validation code interoperability from the above


## Build the Demo with additional test verification

```bash
test.sh
```

This is used mainly in the Github CICD, it runs the demo with its internal tests and
also verifies the output against the reference.

## Build Sample Interop as an Extension

```bash
./make_extension.sh
```

This is the original formulation of the extension feature, it makes a loadable extension
in the output file `out/cqlextension.so` which can be loaded with `.load out/cqlextension`
in the `sqlite3` shell.  The `make_extension.sh` file exercises this with the with the
`test_extension.sql`.  The output of the tests is verified against a reference
`test_extension.out.ref`.

## Use the Extension

```bash
SQLITE_PATH/sqlite3 ":memory:" -cmd ".load out/cqlextension" "SELECT * from hello_world();"
```
