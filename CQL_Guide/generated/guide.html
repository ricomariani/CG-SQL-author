<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>The CQL Programming Language</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">The CQL Programming Language</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#chapter-1-introduction"
id="toc-chapter-1-introduction">Chapter 1: Introduction</a>
<ul>
<li><a href="#getting-started" id="toc-getting-started">Getting
Started</a></li>
<li><a href="#why-did-this-work" id="toc-why-did-this-work">Why did this
work?</a></li>
<li><a href="#variables-and-arithmetic"
id="toc-variables-and-arithmetic">Variables and Arithmetic</a></li>
<li><a href="#basic-conversion-rules"
id="toc-basic-conversion-rules">Basic Conversion Rules</a></li>
<li><a href="#preprocessing-features"
id="toc-preprocessing-features">Preprocessing Features</a></li>
</ul></li>
<li><a href="#chapter-2-using-data"
id="toc-chapter-2-using-data">Chapter 2: Using Data</a>
<ul>
<li><a href="#a-sample-program" id="toc-a-sample-program">A Sample
Program</a></li>
<li><a href="#providing-a-suitable-database"
id="toc-providing-a-suitable-database">Providing a Suitable
Database</a></li>
<li><a href="#declaring-schema" id="toc-declaring-schema">Declaring
Schema</a></li>
<li><a href="#explaining-the-new-hello-world"
id="toc-explaining-the-new-hello-world">Explaining The New Hello
World</a></li>
<li><a href="#introducing-cursors"
id="toc-introducing-cursors">Introducing Cursors</a></li>
<li><a href="#going-crazy" id="toc-going-crazy">Going Crazy</a></li>
</ul></li>
<li><a href="#chapter-3-expressions-literals-nullability-sensitivity"
id="toc-chapter-3-expressions-literals-nullability-sensitivity">Chapter
3: Expressions, Literals, Nullability, Sensitivity</a>
<ul>
<li><a href="#expression-examples"
id="toc-expression-examples">Expression Examples</a></li>
<li><a href="#operator-precedence" id="toc-operator-precedence">Operator
Precedence</a></li>
<li><a href="#order-of-evaluation" id="toc-order-of-evaluation">Order of
Evaluation</a></li>
<li><a href="#variables-columns-basic-types-and-nullability"
id="toc-variables-columns-basic-types-and-nullability">Variables,
Columns, Basic Types and Nullability</a></li>
<li><a href="#types-of-literals" id="toc-types-of-literals">Types of
Literals</a></li>
<li><a href="#const-and-enumerations"
id="toc-const-and-enumerations">Const and Enumerations</a></li>
<li><a href="#named-types" id="toc-named-types">Named Types</a></li>
<li><a href="#type-kinds" id="toc-type-kinds">Type Kinds</a></li>
<li><a href="#nullability" id="toc-nullability">Nullability</a></li>
<li><a href="#expression-types" id="toc-expression-types">Expression
Types</a></li>
<li><a href="#case-expressions" id="toc-case-expressions">CASE
Expressions</a></li>
<li><a href="#marking-data-as-sensitive"
id="toc-marking-data-as-sensitive">Marking Data as Sensitive</a></li>
<li><a href="#reference-semantics"
id="toc-reference-semantics">Reference Semantics</a></li>
<li><a href="#function-return-values"
id="toc-function-return-values">Function Return Values</a></li>
<li><a href="#comparison" id="toc-comparison">Comparison</a></li>
<li><a href="#object" id="toc-object"><code>OBJECT</code></a></li>
<li><a href="#text" id="toc-text"><code>TEXT</code></a></li>
<li><a href="#blob" id="toc-blob"><code>BLOB</code></a></li>
<li><a href="#sample-code" id="toc-sample-code">Sample Code</a></li>
</ul></li>
<li><a href="#chapter-4-procedures-functions-and-control-flow"
id="toc-chapter-4-procedures-functions-and-control-flow">Chapter 4:
Procedures, Functions, and Control Flow</a>
<ul>
<li><a href="#out-parameters" id="toc-out-parameters">Out
Parameters</a></li>
<li><a href="#procedure-calls" id="toc-procedure-calls">Procedure
Calls</a></li>
<li><a href="#the-if-statement" id="toc-the-if-statement">The IF
statement</a></li>
<li><a href="#the-while-statement" id="toc-the-while-statement">The
WHILE statement</a></li>
<li><a href="#the-switch-statement" id="toc-the-switch-statement">The
SWITCH Statement</a></li>
<li><a href="#the-try-catch-and-throw-statements"
id="toc-the-try-catch-and-throw-statements">The TRY, CATCH, and THROW
Statements</a></li>
<li><a href="#procedures-as-functions-motivation-and-example"
id="toc-procedures-as-functions-motivation-and-example">Procedures as
Functions: Motivation and Example</a></li>
</ul></li>
<li><a
href="#chapter-5-types-of-cursors-shapes-out-and-out-union-and-fetch"
id="toc-chapter-5-types-of-cursors-shapes-out-and-out-union-and-fetch">Chapter
5: Types of Cursors, Shapes, OUT and OUT UNION, and FETCH</a>
<ul>
<li><a href="#statement-cursors" id="toc-statement-cursors">Statement
Cursors</a></li>
<li><a href="#value-cursors" id="toc-value-cursors">Value
Cursors</a></li>
<li><a href="#out-statement" id="toc-out-statement">OUT
Statement</a></li>
<li><a href="#out-union-statement" id="toc-out-union-statement">OUT
UNION Statement</a></li>
<li><a href="#result-set-cursors" id="toc-result-set-cursors">Result Set
Cursors</a></li>
<li><a href="#reshaping-data-cursor-like-forms"
id="toc-reshaping-data-cursor-like-forms">Reshaping Data, Cursor
<code>LIKE</code> forms</a></li>
<li><a href="#fetch-statement-specifics"
id="toc-fetch-statement-specifics">Fetch Statement Specifics</a></li>
<li><a href="#calling-procedures-with-argument-bundles"
id="toc-calling-procedures-with-argument-bundles">Calling Procedures
with Argument Bundles</a></li>
<li><a href="#using-named-argument-bundles"
id="toc-using-named-argument-bundles">Using Named Argument
Bundles</a></li>
<li><a href="#the-columnslike-construct-in-the-select-statement"
id="toc-the-columnslike-construct-in-the-select-statement">The
COLUMNS/LIKE construct in the SELECT statement</a></li>
<li><a href="#missing-data-columns-nulls-and-dummy-data"
id="toc-missing-data-columns-nulls-and-dummy-data">Missing Data Columns,
Nulls and Dummy Data</a></li>
<li><a href="#generalized-cursor-lifetimes-aka-cursor-boxing"
id="toc-generalized-cursor-lifetimes-aka-cursor-boxing">Generalized
Cursor Lifetimes aka Cursor “Boxing”</a></li>
</ul></li>
<li><a href="#chapter-6-calling-procedures-defined-elsewhere"
id="toc-chapter-6-calling-procedures-defined-elsewhere">Chapter 6:
Calling Procedures Defined Elsewhere</a>
<ul>
<li><a href="#declaring-procedures-defined-elsewhere"
id="toc-declaring-procedures-defined-elsewhere">Declaring Procedures
Defined Elsewhere</a></li>
<li><a href="#simple-procedures-database-free"
id="toc-simple-procedures-database-free">Simple Procedures (database
free):</a></li>
<li><a href="#procedures-that-use-the-database"
id="toc-procedures-that-use-the-database">Procedures that use the
database</a></li>
<li><a href="#procedures-that-create-a-result-set"
id="toc-procedures-that-create-a-result-set">Procedures that create a
result set</a></li>
<li><a href="#procedures-that-return-a-single-row-with-a-value-cursor"
id="toc-procedures-that-return-a-single-row-with-a-value-cursor">Procedures
that return a single row with a value cursor</a></li>
<li><a href="#procedures-that-return-a-full-result-set"
id="toc-procedures-that-return-a-full-result-set">Procedures that return
a full result set</a></li>
<li><a href="#exporting-declared-symbols-automatically"
id="toc-exporting-declared-symbols-automatically">Exporting Declared
Symbols Automatically</a></li>
<li><a href="#declaration-examples"
id="toc-declaration-examples">Declaration Examples</a></li>
</ul></li>
<li><a href="#chapter-7-cql-result-sets"
id="toc-chapter-7-cql-result-sets">Chapter 7: CQL Result Sets</a>
<ul>
<li><a href="#results-sets-from-out-union"
id="toc-results-sets-from-out-union">Results Sets From
<code>OUT UNION</code></a></li>
<li><a href="#a-working-example" id="toc-a-working-example">A Working
Example</a></li>
<li><a href="#nested-result-sets-parentchild"
id="toc-nested-result-sets-parentchild">Nested Result Sets
(Parent/Child)</a></li>
</ul></li>
<li><a href="#chapter-8-functions" id="toc-chapter-8-functions">Chapter
8: Functions</a>
<ul>
<li><a href="#function-types" id="toc-function-types">Function
Types</a></li>
<li><a href="#sql-functions-with-unchecked-parameter-types"
id="toc-sql-functions-with-unchecked-parameter-types">SQL Functions with
Unchecked Parameter Types</a></li>
<li><a href="#notes-on-builtin-functions"
id="toc-notes-on-builtin-functions">Notes on Builtin Functions</a></li>
</ul></li>
<li><a href="#chapter-9-statements-summary-and-error-checking"
id="toc-chapter-9-statements-summary-and-error-checking">Chapter 9:
Statements Summary and Error Checking</a>
<ul>
<li><a href="#the-primary-sql-statements"
id="toc-the-primary-sql-statements">The Primary SQL Statements</a></li>
<li><a href="#the-primary-procedure-statements"
id="toc-the-primary-procedure-statements">The Primary Procedure
Statements</a></li>
<li><a href="#the-meta-statements" id="toc-the-meta-statements">The
“Meta” Statements</a></li>
<li><a href="#important-program-fragments"
id="toc-important-program-fragments">Important Program
Fragments</a></li>
<li><a href="#special-note-on-the-joinusing-form"
id="toc-special-note-on-the-joinusing-form">Special Note on the
JOIN…USING form</a></li>
</ul></li>
<li><a href="#chapter-10-schema-management-features"
id="toc-chapter-10-schema-management-features">Chapter 10: Schema
Management Features</a>
<ul>
<li><a href="#annotations" id="toc-annotations">Annotations</a></li>
<li><a href="#semantics" id="toc-semantics">Semantics</a></li>
<li><a href="#allowable-changes" id="toc-allowable-changes">Allowable
changes</a></li>
<li><a href="#prosecution" id="toc-prosecution">Prosecution</a></li>
<li><a href="#example-migration" id="toc-example-migration">Example
Migration</a></li>
<li><a href="#sample-upgrade-script"
id="toc-sample-upgrade-script">Sample Upgrade Script</a></li>
<li><a href="#schema-regions" id="toc-schema-regions">Schema
Regions</a></li>
<li><a href="#unsubscription-and-resubscription-features"
id="toc-unsubscription-and-resubscription-features">Unsubscription and
Resubscription Features</a></li>
</ul></li>
<li><a href="#chapter-11-previous-schema-validation"
id="toc-chapter-11-previous-schema-validation">Chapter 11: Previous
Schema Validation</a>
<ul>
<li><a href="#basic-usage" id="toc-basic-usage">Basic Usage</a></li>
</ul></li>
<li><a href="#chapter-12-testability-features"
id="toc-chapter-12-testability-features">Chapter 12: Testability
Features</a>
<ul>
<li><a href="#dummy-data" id="toc-dummy-data">Dummy Data</a></li>
<li><a href="#autotest-attributes" id="toc-autotest-attributes">Autotest
Attributes</a></li>
</ul></li>
<li><a href="#chapter-13-json-output"
id="toc-chapter-13-json-output">Chapter 13: JSON Output</a>
<ul>
<li><a href="#tables" id="toc-tables">Tables</a></li>
<li><a href="#region-information" id="toc-region-information">Region
Information</a></li>
<li><a href="#attributes" id="toc-attributes">Attributes</a></li>
<li><a href="#global-attributes" id="toc-global-attributes">Global
attributes</a></li>
<li><a href="#foreign-keys" id="toc-foreign-keys">Foreign Keys</a></li>
<li><a href="#unique-keys" id="toc-unique-keys">Unique Keys</a></li>
<li><a href="#check-expressions" id="toc-check-expressions">Check
Expressions</a></li>
<li><a href="#columns" id="toc-columns">Columns</a></li>
<li><a href="#virtual-tables" id="toc-virtual-tables">Virtual
Tables</a></li>
<li><a href="#views-1" id="toc-views-1">Views</a></li>
<li><a href="#projections" id="toc-projections">Projections</a></li>
<li><a href="#dependencies" id="toc-dependencies">Dependencies</a></li>
<li><a href="#indices-1" id="toc-indices-1">Indices</a></li>
<li><a href="#procedures" id="toc-procedures">Procedures</a></li>
<li><a href="#interfaces" id="toc-interfaces">Interfaces</a></li>
<li><a href="#procecdure-declarations"
id="toc-procecdure-declarations">Procecdure Declarations</a></li>
<li><a href="#function-declarations"
id="toc-function-declarations">Function Declarations</a></li>
<li><a href="#return-type" id="toc-return-type">Return Type</a></li>
<li><a href="#regions" id="toc-regions">Regions</a></li>
<li><a href="#ad-hoc-migrations" id="toc-ad-hoc-migrations">Ad Hoc
Migrations</a></li>
<li><a href="#enums" id="toc-enums">Enums</a></li>
<li><a href="#constant-groups" id="toc-constant-groups">Constant
Groups</a></li>
<li><a href="#subscriptions"
id="toc-subscriptions">Subscriptions</a></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul></li>
<li><a href="#chapter-14-cql-shared-fragments"
id="toc-chapter-14-cql-shared-fragments">Chapter 14: CQL Shared
Fragments</a>
<ul>
<li><a href="#shared-fragments-with-conditionals"
id="toc-shared-fragments-with-conditionals">Shared Fragments with
Conditionals</a></li>
<li><a href="#shared-fragments-as-expressions"
id="toc-shared-fragments-as-expressions">Shared Fragments as
Expressions</a></li>
</ul></li>
<li><a href="#chapter-15-query-plan-generation"
id="toc-chapter-15-query-plan-generation">Chapter 15: Query Plan
Generation</a>
<ul>
<li><a href="#query-plan-generation-compilation-steps"
id="toc-query-plan-generation-compilation-steps">Query Plan Generation
Compilation Steps</a></li>
<li><a href="#special-handling-of-cql-features-in-query-plan-generation"
id="toc-special-handling-of-cql-features-in-query-plan-generation">Special
Handling of CQL features in Query Plan Generation</a></li>
</ul></li>
<li><a href="#chapter-16-advanced-blob-features"
id="toc-chapter-16-advanced-blob-features">Chapter 16: Advanced Blob
Features</a>
<ul>
<li><a href="#blob-storage" id="toc-blob-storage">Blob Storage</a></li>
<li><a href="#backed-tables" id="toc-backed-tables">Backed
Tables</a></li>
</ul></li>
<li><a href="#chapter-17-vault-sensitive-encoding-for-privacy"
id="toc-chapter-17-vault-sensitive-encoding-for-privacy">Chapter 17:
Vault Sensitive – Encoding for Privacy</a>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#basics-of-operation" id="toc-basics-of-operation">Basics
of Operation</a></li>
<li><a href="#vaulting-mechanics" id="toc-vaulting-mechanics">Vaulting
Mechanics</a></li>
<li><a href="#adopting-vault-sensitive"
id="toc-adopting-vault-sensitive">Adopting Vault Sensitive</a></li>
</ul></li>
<li><a href="#appendix-1-command-line-options"
id="toc-appendix-1-command-line-options">Appendix 1: Command Line
Options</a>
<ul>
<li><a href="#with-no-options" id="toc-with-no-options">With No
Options</a></li>
<li><a href="#in-file" id="toc-in-file">–in file</a></li>
<li><a href="#sem" id="toc-sem">–sem</a></li>
<li><a href="#ast" id="toc-ast">–ast</a></li>
<li><a href="#echo" id="toc-echo">–echo</a></li>
<li><a href="#dot" id="toc-dot">–dot</a></li>
<li><a href="#cg-output1-output2" id="toc-cg-output1-output2">–cg
output1 output2 …</a></li>
<li><a href="#nolines" id="toc-nolines">–nolines</a></li>
<li><a href="#global_proc-name" id="toc-global_proc-name">–global_proc
name</a></li>
<li><a href="#compress" id="toc-compress">–compress</a></li>
<li><a href="#test" id="toc-test">–test</a></li>
<li><a href="#dev" id="toc-dev">–dev</a></li>
<li><a href="#c_include_namespace"
id="toc-c_include_namespace">–c_include_namespace</a></li>
<li><a href="#c_include_path"
id="toc-c_include_path">–c_include_path</a></li>
<li><a href="#objc_c_include_path"
id="toc-objc_c_include_path">–objc_c_include_path</a></li>
<li><a href="#result-types-rt" id="toc-result-types-rt">Result Types
(–rt *)</a></li>
</ul></li>
<li><a href="#appendix-2-cql-grammar"
id="toc-appendix-2-cql-grammar">Appendix 2: CQL Grammar</a>
<ul>
<li><a href="#operators-and-literals"
id="toc-operators-and-literals">Operators and Literals</a></li>
<li><a href="#statementtype-keywords"
id="toc-statementtype-keywords">Statement/Type Keywords</a></li>
<li><a href="#rules" id="toc-rules">Rules</a></li>
</ul></li>
<li><a href="#appendix-3-control-directives"
id="toc-appendix-3-control-directives">Appendix 3: Control
Directives</a>
<ul>
<li><a href="#deprecated-attributes"
id="toc-deprecated-attributes">Deprecated attributes</a></li>
</ul></li>
<li><a href="#appendix-4-cql-error-codes"
id="toc-appendix-4-cql-error-codes">Appendix 4: CQL Error Codes</a>
<ul>
<li><a href="#cql0001-operands-must-be-an-integer-type-not-real"
id="toc-cql0001-operands-must-be-an-integer-type-not-real">CQL0001:
operands must be an integer type, not real</a></li>
<li><a href="#cql0002-left-operand-cannot-be-an-object-in-operator"
id="toc-cql0002-left-operand-cannot-be-an-object-in-operator">CQL0002:
left operand cannot be an object in ‘operator’</a></li>
<li><a href="#cql0003-left-operand-cannot-be-an-object-in-operator"
id="toc-cql0003-left-operand-cannot-be-an-object-in-operator">CQL0003:
left operand cannot be an object in ‘operator’</a></li>
<li><a href="#cql0004-left-operand-cannot-be-a-blob-in-operator"
id="toc-cql0004-left-operand-cannot-be-a-blob-in-operator">CQL0004: left
operand cannot be a blob in ‘operator’</a></li>
<li><a href="#cql0005-right-operand-cannot-be-a-blob-in-operator"
id="toc-cql0005-right-operand-cannot-be-a-blob-in-operator">CQL0005:
right operand cannot be a blob in ‘operator’</a></li>
<li><a href="#cql0007-left-operand-cannot-be-a-string-in-operator"
id="toc-cql0007-left-operand-cannot-be-a-string-in-operator">CQL0007:
left operand cannot be a string in ‘operator’</a></li>
<li><a href="#cql0008-right-operand-cannot-be-a-string-in-operator"
id="toc-cql0008-right-operand-cannot-be-a-string-in-operator">CQL0008:
right operand cannot be a string in ‘operator’</a></li>
<li><a href="#cql0009-incompatible-types-in-expression-subject"
id="toc-cql0009-incompatible-types-in-expression-subject">CQL0009:
incompatible types in expression ‘subject’</a></li>
<li><a href="#cql0010-incompatible-types-in-expression-subject"
id="toc-cql0010-incompatible-types-in-expression-subject">CQL0010:
incompatible types in expression ‘subject’</a></li>
<li><a href="#cql0011-incompatible-types-in-expression-subject"
id="toc-cql0011-incompatible-types-in-expression-subject">CQL0011:
incompatible types in expression ‘subject’</a></li>
<li><a href="#cql0012-incompatible-types-in-expression-subject"
id="toc-cql0012-incompatible-types-in-expression-subject">CQL0012:
incompatible types in expression ‘subject’</a></li>
<li><a
href="#cql0013-cannot-assigncopy-possibly-null-expression-to-not-null-target-target"
id="toc-cql0013-cannot-assigncopy-possibly-null-expression-to-not-null-target-target">CQL0013:
cannot assign/copy possibly null expression to not null target
‘target’</a></li>
<li><a
href="#cql0014-cannot-assigncopy-sensitive-expression-to-not-null-target-target"
id="toc-cql0014-cannot-assigncopy-sensitive-expression-to-not-null-target-target">CQL0014:
cannot assign/copy sensitive expression to not null target
‘target’</a></li>
<li><a href="#cql0015-expected-numeric-expression-context"
id="toc-cql0015-expected-numeric-expression-context">CQL0015: expected
numeric expression ‘context’</a></li>
<li><a href="#cql0016-duplicate-table-name-in-join-table"
id="toc-cql0016-duplicate-table-name-in-join-table">CQL0016: duplicate
table name in join ‘table’</a></li>
<li><a
href="#cql0017-index-was-present-but-now-it-does-not-exist-use-delete-instead-index"
id="toc-cql0017-index-was-present-but-now-it-does-not-exist-use-delete-instead-index">CQL0017:
index was present but now it does not exist (use <code>@delete</code>
instead) ‘index’</a></li>
<li><a href="#cql0018-duplicate-index-name-index"
id="toc-cql0018-duplicate-index-name-index">CQL0018: duplicate index
name ‘index’</a></li>
<li><a href="#cql0019-create-index-table-name-not-found-table_name"
id="toc-cql0019-create-index-table-name-not-found-table_name">CQL0019:
create index table name not found ‘table_name’</a></li>
<li><a
href="#cql0020-duplicate-constraint-name-in-table-constraint_name"
id="toc-cql0020-duplicate-constraint-name-in-table-constraint_name">CQL0020:
duplicate constraint name in table ‘constraint_name’</a></li>
<li><a
href="#cql0021-foreign-key-refers-to-non-existent-table-table_name"
id="toc-cql0021-foreign-key-refers-to-non-existent-table-table_name">CQL0021:
foreign key refers to non-existent table ‘table_name’</a></li>
<li><a
href="#cql0022-exact-type-of-both-sides-of-a-foreign-key-must-match-expected-expected_type-found-actual_type-key_name"
id="toc-cql0022-exact-type-of-both-sides-of-a-foreign-key-must-match-expected-expected_type-found-actual_type-key_name">CQL0022:
exact type of both sides of a foreign key must match (expected
expected_type; found actual_type) ‘key_name’</a></li>
<li><a
href="#cql0023-number-of-columns-on-both-sides-of-a-foreign-key-must-match"
id="toc-cql0023-number-of-columns-on-both-sides-of-a-foreign-key-must-match">CQL0023:
number of columns on both sides of a foreign key must match</a></li>
<li><a href="#cql0025-version-number-in-annotation-must-be-positive"
id="toc-cql0025-version-number-in-annotation-must-be-positive">CQL0025:
version number in annotation must be positive</a></li>
<li><a href="#cql0026-duplicate-version-annotation"
id="toc-cql0026-duplicate-version-annotation">CQL0026: duplicate version
annotation</a></li>
<li><a
href="#cql0027-a-procedure-can-appear-in-only-one-annotation-procedure_name"
id="toc-cql0027-a-procedure-can-appear-in-only-one-annotation-procedure_name">CQL0027:
a procedure can appear in only one annotation ‘procedure_name’</a></li>
<li><a
href="#cql0028-fk-reference-must-be-exactly-one-column-with-the-correct-type-column_name"
id="toc-cql0028-fk-reference-must-be-exactly-one-column-with-the-correct-type-column_name">CQL0028:
FK reference must be exactly one column with the correct type
‘column_name’</a></li>
<li><a
href="#cql0029-autoincrement-column-must-be-long_integer-primary-key-column-name"
id="toc-cql0029-autoincrement-column-must-be-long_integer-primary-key-column-name">CQL0029:
autoincrement column must be [LONG_]INTEGER PRIMARY KEY ‘column
name’</a></li>
<li><a
href="#cql0030-a-column-attribute-was-specified-twice-on-the-same-column-column_name"
id="toc-cql0030-a-column-attribute-was-specified-twice-on-the-same-column-column_name">CQL0030:
a column attribute was specified twice on the same column
‘column_name’</a></li>
<li><a
href="#cql0031-column-cant-be-primary-key-and-also-unique-key-column"
id="toc-cql0031-column-cant-be-primary-key-and-also-unique-key-column">CQL0031:
column can’t be primary key and also unique key ‘column’</a></li>
<li><a
href="#cql0032-created-columns-must-be-at-the-end-and-must-be-in-version-order-column"
id="toc-cql0032-created-columns-must-be-at-the-end-and-must-be-in-version-order-column">CQL0032:
created columns must be at the end and must be in version order”,
‘column’</a></li>
<li><a
href="#cql0033-columns-in-a-table-marked-recreate-cannot-have-create-or-delete-column"
id="toc-cql0033-columns-in-a-table-marked-recreate-cannot-have-create-or-delete-column">CQL0033:
columns in a table marked <span class="citation"
data-cites="recreate">@recreate</span> cannot have <span
class="citation" data-cites="create">@create</span> or
<code>@delete</code>, ‘column’</a></li>
<li><a
href="#cql0034-createdelete-version-numbers-can-only-be-applied-to-columns-that-are-nullable-or-have-a-default-value-column"
id="toc-cql0034-createdelete-version-numbers-can-only-be-applied-to-columns-that-are-nullable-or-have-a-default-value-column">CQL0034:
create/delete version numbers can only be applied to columns that are
nullable or have a default value ‘column’</a></li>
<li><a
href="#cql0035-column-delete-version-cant-be-column-create-version-column"
id="toc-cql0035-column-delete-version-cant-be-column-create-version-column">CQL0035:
column delete version can’t be &lt;= column create version”,
‘column’</a></li>
<li><a
href="#cql0036-column-delete-version-cant-be-the-table-create-version-column"
id="toc-cql0036-column-delete-version-cant-be-the-table-create-version-column">CQL0036:
column delete version can’t be &lt;= the table create version
‘column’</a></li>
<li><a
href="#cql0037-column-delete-version-cant-be-the-table-delete-version"
id="toc-cql0037-column-delete-version-cant-be-the-table-delete-version">CQL0037:
column delete version can’t be &gt;= the table delete version</a></li>
<li><a
href="#cql0038-column-create-version-cant-be-the-table-create-version-column"
id="toc-cql0038-column-create-version-cant-be-the-table-create-version-column">CQL0038:
column create version can’t be <code>&lt;=</code> the table create
version ‘column’</a></li>
<li><a
href="#cql0039-column-create-version-cant-be-the-table-delete-version-column"
id="toc-cql0039-column-create-version-cant-be-the-table-delete-version-column">CQL0039:
column create version can’t be <code>&gt;=</code> the table delete
version ‘column’</a></li>
<li><a href="#cql0040-table-can-only-have-one-autoinc-column-column"
id="toc-cql0040-table-can-only-have-one-autoinc-column-column">CQL0040:
table can only have one autoinc column ‘column’</a></li>
<li><a href="#cql0041-tables-cannot-have-object-columns-column"
id="toc-cql0041-tables-cannot-have-object-columns-column">CQL0041:
tables cannot have object columns ‘column’</a></li>
<li><a href="#cql0042-left-operand-must-be-a-string-in-likematchglob"
id="toc-cql0042-left-operand-must-be-a-string-in-likematchglob">CQL0042:
left operand must be a string in ‘LIKE/MATCH/GLOB’</a></li>
<li><a href="#cql0043-right-operand-must-be-a-string-in-likematchglob"
id="toc-cql0043-right-operand-must-be-a-string-in-likematchglob">CQL0043:
right operand must be a string in ‘LIKE/MATCH/GLOB’</a></li>
<li><a
href="#cql0044-operator-may-only-appear-in-the-context-of-a-sql-statement-match"
id="toc-cql0044-operator-may-only-appear-in-the-context-of-a-sql-statement-match">CQL0044:
operator may only appear in the context of a SQL statement
‘MATCH’</a></li>
<li><a href="#cql0045-blob-operand-not-allowed-in-operator"
id="toc-cql0045-blob-operand-not-allowed-in-operator">CQL0045: blob
operand not allowed in ‘operator’</a></li>
<li><a href="#cql0046-object-operand-not-allowed-in-operator"
id="toc-cql0046-object-operand-not-allowed-in-operator">CQL0046: object
operand not allowed in ‘operator’</a></li>
<li><a href="#cql0047-string-operand-not-allowed-in-operator"
id="toc-cql0047-string-operand-not-allowed-in-operator">CQL0047: string
operand not allowed in ‘operator’</a></li>
<li><a href="#cql0051-argument-can-only-be-used-in-count"
id="toc-cql0051-argument-can-only-be-used-in-count">CQL0051: argument
can only be used in count(<em>) ’</em>’</a></li>
<li><a href="#cql0052-select-cannot-be-used-with-no-from-clause"
id="toc-cql0052-select-cannot-be-used-with-no-from-clause">CQL0052:
select * cannot be used with no FROM clause</a></li>
<li><a href="#cql0053-select-table.-cannot-be-used-with-no-from-clause"
id="toc-cql0053-select-table.-cannot-be-used-with-no-from-clause">CQL0053:
select [table].* cannot be used with no FROM clause</a></li>
<li><a href="#cql0054-table-not-found-table"
id="toc-cql0054-table-not-found-table">CQL0054: table not found
‘table’</a></li>
<li><a href="#cql0055-all-columns-in-the-select-must-have-a-name"
id="toc-cql0055-all-columns-in-the-select-must-have-a-name">CQL0055: all
columns in the select must have a name</a></li>
<li><a
href="#cql0056-null-expression-has-no-type-to-imply-a-needed-type-variable"
id="toc-cql0056-null-expression-has-no-type-to-imply-a-needed-type-variable">CQL0056:
NULL expression has no type to imply a needed type ‘variable’</a></li>
<li><a
href="#cql0057-if-multiple-selects-all-must-have-the-same-column-count"
id="toc-cql0057-if-multiple-selects-all-must-have-the-same-column-count">CQL0057:
if multiple selects, all must have the same column count</a></li>
<li><a
href="#cql0058-if-multiple-selects-all-column-names-must-be-identical-so-they-have-unambiguous-names-error-in-column-n-x-vs.-y"
id="toc-cql0058-if-multiple-selects-all-column-names-must-be-identical-so-they-have-unambiguous-names-error-in-column-n-x-vs.-y">CQL0058:
if multiple selects, all column names must be identical so they have
unambiguous names; error in column N: ‘X’ vs. ‘Y’</a></li>
<li><a
href="#cql0059-a-variable-name-might-be-ambiguous-with-a-column-name-this-is-an-anti-pattern-name"
id="toc-cql0059-a-variable-name-might-be-ambiguous-with-a-column-name-this-is-an-anti-pattern-name">CQL0059:
a variable name might be ambiguous with a column name, this is an
anti-pattern ‘name’</a></li>
<li><a
href="#cql0060-referenced-table-can-be-independently-recreated-so-it-cannot-be-used-in-a-foreign-key-referenced_table"
id="toc-cql0060-referenced-table-can-be-independently-recreated-so-it-cannot-be-used-in-a-foreign-key-referenced_table">CQL0060:
referenced table can be independently recreated so it cannot be used in
a foreign key, ‘referenced_table’</a></li>
<li><a
href="#cql0061-if-multiple-selects-all-columns-must-be-an-exact-type-match-expected-expected_type-found-actual_type-column"
id="toc-cql0061-if-multiple-selects-all-columns-must-be-an-exact-type-match-expected-expected_type-found-actual_type-column">CQL0061:
if multiple selects, all columns must be an exact type match (expected
expected_type; found actual_type) ‘column’</a></li>
<li><a
href="#cql0062-if-multiple-selects-all-columns-must-be-an-exact-type-match-including-nullability-expected-expected_type-found-actual_type-column"
id="toc-cql0062-if-multiple-selects-all-columns-must-be-an-exact-type-match-including-nullability-expected-expected_type-found-actual_type-column">CQL0062:
if multiple selects, all columns must be an exact type match (including
nullability) (expected expected_type; found actual_type)
‘column’</a></li>
<li><a
href="#cql0063-cant-mix-and-match-out-statement-with-selectcall-for-return-values-procedure_name"
id="toc-cql0063-cant-mix-and-match-out-statement-with-selectcall-for-return-values-procedure_name">CQL0063:
can’t mix and match out statement with select/call for return values
‘procedure_name’</a></li>
<li><a
href="#cql0064-object-variables-may-not-appear-in-the-context-of-a-sql-statement"
id="toc-cql0064-object-variables-may-not-appear-in-the-context-of-a-sql-statement">CQL0064:
object variables may not appear in the context of a SQL
statement</a></li>
<li><a href="#cql0065-identifier-is-ambiguous-name"
id="toc-cql0065-identifier-is-ambiguous-name">CQL0065: identifier is
ambiguous ‘name’</a></li>
<li><a
href="#cql0066-if-a-table-is-marked-recreate-its-indices-must-be-in-its-schema-region-index_name"
id="toc-cql0066-if-a-table-is-marked-recreate-its-indices-must-be-in-its-schema-region-index_name">CQL0066:
if a table is marked <code>@recreate</code>, its indices must be in its
schema region ‘index_name’</a></li>
<li><a href="#cql0067-cursor-was-not-used-with-fetch-cursor-cursor_name"
id="toc-cql0067-cursor-was-not-used-with-fetch-cursor-cursor_name">CQL0067:
cursor was not used with ‘fetch [cursor]’ ‘cursor_name’</a></li>
<li><a href="#cql0068-field-not-found-in-cursor-field"
id="toc-cql0068-field-not-found-in-cursor-field">CQL0068: field not
found in cursor ‘field’</a></li>
<li><a href="#cql0069-name-not-found-name"
id="toc-cql0069-name-not-found-name">CQL0069: name not found
‘name’</a></li>
<li><a href="#cql0070-incompatible-object-type-incompatible_type"
id="toc-cql0070-incompatible-object-type-incompatible_type">CQL0070:
incompatible object type ‘incompatible_type’</a></li>
<li><a
href="#cql0071-first-operand-cannot-be-a-blob-in-betweennot-between"
id="toc-cql0071-first-operand-cannot-be-a-blob-in-betweennot-between">CQL0071:
first operand cannot be a blob in ‘BETWEEN/NOT BETWEEN’</a></li>
<li><a
href="#cql0072-first-operand-cannot-be-a-blob-in-betweennot-between"
id="toc-cql0072-first-operand-cannot-be-a-blob-in-betweennot-between">CQL0072:
first operand cannot be a blob in ‘BETWEEN/NOT BETWEEN’</a></li>
<li><a
href="#cql0073-cast-may-only-appear-in-the-context-of-sql-statement"
id="toc-cql0073-cast-may-only-appear-in-the-context-of-sql-statement">CQL0073:
CAST may only appear in the context of SQL statement</a></li>
<li><a href="#cql0074-too-few-arguments-provided-coalesce"
id="toc-cql0074-too-few-arguments-provided-coalesce">CQL0074: too few
arguments provided ‘coalesce’</a></li>
<li><a href="#cql0075-incorrect-number-of-arguments-ifnull"
id="toc-cql0075-incorrect-number-of-arguments-ifnull">CQL0075: incorrect
number of arguments ‘ifnull’</a></li>
<li><a
href="#cql0076-null-literal-is-useless-in-function-ifnullcoalesce"
id="toc-cql0076-null-literal-is-useless-in-function-ifnullcoalesce">CQL0076:
NULL literal is useless in function ‘ifnull/coalesce’</a></li>
<li><a
href="#cql0077-encountered-arg-known-to-be-not-null-before-the-end-of-the-list-rendering-the-rest-useless-expression"
id="toc-cql0077-encountered-arg-known-to-be-not-null-before-the-end-of-the-list-rendering-the-rest-useless-expression">CQL0077:
encountered arg known to be not null before the end of the list,
rendering the rest useless ‘expression’</a></li>
<li><a
href="#cql0078-not-in-select-is-only-allowed-inside-of-select-lists-where-on-and-having-clauses"
id="toc-cql0078-not-in-select-is-only-allowed-inside-of-select-lists-where-on-and-having-clauses">CQL0078:
[not] in (select …) is only allowed inside of select lists, where, on,
and having clauses</a></li>
<li><a href="#cql0079-function-got-incorrect-number-of-arguments-name"
id="toc-cql0079-function-got-incorrect-number-of-arguments-name">CQL0079:
function got incorrect number of arguments ‘name’</a></li>
<li><a href="#cql0080-function-may-not-appear-in-this-context-name"
id="toc-cql0080-function-may-not-appear-in-this-context-name">CQL0080:
function may not appear in this context ‘name’</a></li>
<li><a
href="#cql0081-aggregates-only-make-sense-if-there-is-a-from-clause-name"
id="toc-cql0081-aggregates-only-make-sense-if-there-is-a-from-clause-name">CQL0081:
aggregates only make sense if there is a FROM clause ‘name’</a></li>
<li><a href="#cql0082-argument-must-be-numeric"
id="toc-cql0082-argument-must-be-numeric">CQL0082: argument must be
numeric</a></li>
<li><a href="#cql0083-argument-must-be-numeric-sum"
id="toc-cql0083-argument-must-be-numeric-sum">CQL0083: argument must be
numeric ‘SUM’</a></li>
<li><a
href="#cql0084-second-argument-must-be-a-string-in-function-group_concat"
id="toc-cql0084-second-argument-must-be-a-string-in-function-group_concat">CQL0084:
second argument must be a string in function ‘group_concat’</a></li>
<li><a href="#cql0085-all-arguments-must-be-strings-strftime"
id="toc-cql0085-all-arguments-must-be-strings-strftime">CQL0085: all
arguments must be strings ‘strftime’</a></li>
<li><a
href="#cql0086-first-argument-must-be-a-string-in-function-function"
id="toc-cql0086-first-argument-must-be-a-string-in-function-function">CQL0086:
first argument must be a string in function ‘function’</a></li>
<li><a href="#cql0087-first-argument-must-be-of-type-real-function"
id="toc-cql0087-first-argument-must-be-of-type-real-function">CQL0087:
first argument must be of type real ‘function’</a></li>
<li><a
href="#cql0088-user-function-may-not-appear-in-the-context-of-a-sql-statement-function_name"
id="toc-cql0088-user-function-may-not-appear-in-the-context-of-a-sql-statement-function_name">CQL0088:
user function may not appear in the context of a SQL statement
‘function_name’</a></li>
<li><a
href="#cql0089-user-function-may-only-appear-in-the-context-of-a-sql-statement-function_name"
id="toc-cql0089-user-function-may-only-appear-in-the-context-of-a-sql-statement-function_name">CQL0089:
user function may only appear in the context of a SQL statement
‘function_name’</a></li>
<li><a
href="#cql0090-objectt-set-has-a-t-that-is-not-a-procedure-with-a-result-set-name"
id="toc-cql0090-objectt-set-has-a-t-that-is-not-a-procedure-with-a-result-set-name">CQL0090:
<code>object&lt;T SET&gt;</code> has a T that is not a procedure with a
result set, ‘name’</a></li>
<li><a
href="#cql0091-objectt-set-has-a-t-that-is-not-a-public-procedure-with-a-result-set-name"
id="toc-cql0091-objectt-set-has-a-t-that-is-not-a-public-procedure-with-a-result-set-name">CQL0091:
<code>object&lt;T SET&gt;</code> has a T that is not a public procedure
with a result set, ‘name’</a></li>
<li><a href="#cql0092-raise-may-only-be-used-in-a-trigger-statement"
id="toc-cql0092-raise-may-only-be-used-in-a-trigger-statement">CQL0092:
RAISE may only be used in a trigger statement</a></li>
<li><a href="#cql0093-raise-2nd-argument-must-be-a-string"
id="toc-cql0093-raise-2nd-argument-must-be-a-string">CQL0093: RAISE 2nd
argument must be a string</a></li>
<li><a href="#cql0094-function-not-yet-implemented-function"
id="toc-cql0094-function-not-yet-implemented-function">CQL0094: function
not yet implemented ‘function’</a></li>
<li><a href="#cql0095-tableview-not-defined-name"
id="toc-cql0095-tableview-not-defined-name">CQL0095: table/view not
defined ‘name’</a></li>
<li><a
href="#cql0096-join-using-column-not-found-on-the-left-side-of-the-join-column_name"
id="toc-cql0096-join-using-column-not-found-on-the-left-side-of-the-join-column_name">CQL0096:
join using column not found on the left side of the join
‘column_name’</a></li>
<li><a
href="#cql0097-join-using-column-not-found-on-the-right-side-of-the-join-column_name"
id="toc-cql0097-join-using-column-not-found-on-the-right-side-of-the-join-column_name">CQL0097:
join using column not found on the right side of the join
‘column_name’</a></li>
<li><a
href="#cql0098-leftright-column-types-in-join-using-do-not-match-exactly-column_name"
id="toc-cql0098-leftright-column-types-in-join-using-do-not-match-exactly-column_name">CQL0098:
left/right column types in join USING(…) do not match exactly
‘column_name’</a></li>
<li><a href="#cql0099-having-clause-requires-group-by-clause"
id="toc-cql0099-having-clause-requires-group-by-clause">CQL0099: HAVING
clause requires GROUP BY clause</a></li>
<li><a href="#cql0100-duplicate-common-table-name-name"
id="toc-cql0100-duplicate-common-table-name-name">CQL0100: duplicate
common table name ‘name’</a></li>
<li><a
href="#cql0101-too-few-column-names-specified-in-common-table-expression-name"
id="toc-cql0101-too-few-column-names-specified-in-common-table-expression-name">CQL0101:
too few column names specified in common table expression
‘name’</a></li>
<li><a
href="#cql0102-too-many-column-names-specified-in-common-table-expression-name"
id="toc-cql0102-too-many-column-names-specified-in-common-table-expression-name">CQL0102:
too many column names specified in common table expression
‘name’</a></li>
<li><a href="#cql0103-duplicate-tableview-name-name"
id="toc-cql0103-duplicate-tableview-name-name">CQL0103: duplicate
table/view name ‘name’</a></li>
<li><a
href="#cql0104-view-was-present-but-now-it-does-not-exist-use-delete-instead-name"
id="toc-cql0104-view-was-present-but-now-it-does-not-exist-use-delete-instead-name">CQL0104:
view was present but now it does not exist (use <code>@delete</code>
instead) ‘name’</a></li>
<li><a href="#cql0105-object-was-a-view-but-is-now-a-table-name"
id="toc-cql0105-object-was-a-view-but-is-now-a-table-name">CQL0105:
object was a view but is now a table ‘name’</a></li>
<li><a
href="#cql0106-trigger-was-present-but-now-it-does-not-exist-use-delete-instead-name"
id="toc-cql0106-trigger-was-present-but-now-it-does-not-exist-use-delete-instead-name">CQL0106:
trigger was present but now it does not exist (use <code>@delete</code>
instead) ‘name’</a></li>
<li><a href="#cql0107-delete-version-cant-be-create-version-name"
id="toc-cql0107-delete-version-cant-be-create-version-name">CQL0107:
delete version can’t be &lt;= create version ‘name’</a></li>
<li><a href="#cql0108-table-in-drop-statement-does-not-exist-table_name"
id="toc-cql0108-table-in-drop-statement-does-not-exist-table_name">CQL0108:
table in drop statement does not exist ‘table_name’</a></li>
<li><a href="#cql0109-cannot-drop-a-view-with-drop-table-view_name"
id="toc-cql0109-cannot-drop-a-view-with-drop-table-view_name">CQL0109:
cannot drop a view with drop table ‘view_name’</a></li>
<li><a href="#cql0110-view-in-drop-statement-does-not-exist-view_name"
id="toc-cql0110-view-in-drop-statement-does-not-exist-view_name">CQL0110:
view in drop statement does not exist ‘view_name’</a></li>
<li><a href="#cql0111-cannot-drop-a-table-with-drop-view-name"
id="toc-cql0111-cannot-drop-a-table-with-drop-view-name">CQL0111: cannot
drop a table with drop view ‘name’</a></li>
<li><a
href="#cql0112-index-in-drop-statement-was-not-declared-index_name"
id="toc-cql0112-index-in-drop-statement-was-not-declared-index_name">CQL0112:
index in drop statement was not declared ‘index_name’</a></li>
<li><a href="#cql0113-trigger-in-drop-statement-was-not-declared-name"
id="toc-cql0113-trigger-in-drop-statement-was-not-declared-name">CQL0113:
trigger in drop statement was not declared ‘name’</a></li>
<li><a
href="#cql0114-current-schema-cant-go-back-to-recreate-semantics-for-table_name"
id="toc-cql0114-current-schema-cant-go-back-to-recreate-semantics-for-table_name">CQL0114:
current schema can’t go back to recreate semantics for
‘table_name’</a></li>
<li><a
href="#cql0115-current-create-version-not-equal-to-previous-create-version-for-table"
id="toc-cql0115-current-create-version-not-equal-to-previous-create-version-for-table">CQL0115:
current create version not equal to previous create version for
‘table’</a></li>
<li><a
href="#cql0116-current-delete-version-not-equal-to-previous-delete-version-for-table"
id="toc-cql0116-current-delete-version-not-equal-to-previous-delete-version-for-table">CQL0116:
current delete version not equal to previous delete version for
‘table’</a></li>
<li><a href="#cql0117-delete-procedure-changed-in-object-table_name"
id="toc-cql0117-delete-procedure-changed-in-object-table_name">CQL0117:
<code>@delete</code> procedure changed in object ‘table_name’</a></li>
<li><a href="#cql0118-create-procedure-changed-in-object-table_name"
id="toc-cql0118-create-procedure-changed-in-object-table_name">CQL0118:
<code>@create</code> procedure changed in object ‘table_name’</a></li>
<li><a
href="#cql0119-column-name-is-different-between-previous-and-current-schema-name"
id="toc-cql0119-column-name-is-different-between-previous-and-current-schema-name">CQL0119:
column name is different between previous and current schema
‘name’</a></li>
<li><a
href="#cql0120-column-type-is-different-between-previous-and-current-schema-name"
id="toc-cql0120-column-type-is-different-between-previous-and-current-schema-name">CQL0120:
column type is different between previous and current schema
‘name’</a></li>
<li><a
href="#cql0121-column-current-create-version-not-equal-to-previous-create-version-name"
id="toc-cql0121-column-current-create-version-not-equal-to-previous-create-version-name">CQL0121:
column current create version not equal to previous create version
‘name’</a></li>
<li><a
href="#cql0122-column-current-delete-version-not-equal-to-previous-delete-version-name"
id="toc-cql0122-column-current-delete-version-not-equal-to-previous-delete-version-name">CQL0122:
column current delete version not equal to previous delete version
‘name’</a></li>
<li><a href="#cql0123-column-delete-procedure-changed-name"
id="toc-cql0123-column-delete-procedure-changed-name">CQL0123: column
<code>@delete</code> procedure changed ‘name’</a></li>
<li><a href="#cql0124-column-create-procedure-changed-name"
id="toc-cql0124-column-create-procedure-changed-name">CQL0124: column
<code>@create</code> procedure changed ‘name’</a></li>
<li><a
href="#cql0125-column-current-default-value-not-equal-to-previous-default-value-column"
id="toc-cql0125-column-current-default-value-not-equal-to-previous-default-value-column">CQL0125:
column current default value not equal to previous default value
‘column’</a></li>
<li><a
href="#cql0126-table-was-present-but-now-it-does-not-exist-use-delete-instead-table"
id="toc-cql0126-table-was-present-but-now-it-does-not-exist-use-delete-instead-table">CQL0126:
table was present but now it does not exist (use <code>@delete</code>
instead) ‘table’</a></li>
<li><a href="#cql0127-object-was-a-table-but-is-now-a-view-name"
id="toc-cql0127-object-was-a-table-but-is-now-a-view-name">CQL0127:
object was a table but is now a view ‘name’</a></li>
<li><a
href="#cql0128-table-has-a-column-that-is-different-in-the-previous-and-current-schema-column"
id="toc-cql0128-table-has-a-column-that-is-different-in-the-previous-and-current-schema-column">CQL0128:
table has a column that is different in the previous and current schema
‘column’</a></li>
<li><a
href="#cql0129-a-column-was-removed-from-the-table-rather-than-marked-with-delete-column_name"
id="toc-cql0129-a-column-was-removed-from-the-table-rather-than-marked-with-delete-column_name">CQL0129:
a column was removed from the table rather than marked with
<code>@delete</code> ‘column_name’</a></li>
<li><a
href="#cql0130-table-has-columns-added-without-marking-them-create-column_name"
id="toc-cql0130-table-has-columns-added-without-marking-them-create-column_name">CQL0130:
table has columns added without marking them <code>@create</code>
‘column_name’</a></li>
<li><a
href="#cql0131-table-has-newly-added-columns-that-are-marked-both-create-and-delete-column_name"
id="toc-cql0131-table-has-newly-added-columns-that-are-marked-both-create-and-delete-column_name">CQL0131:
table has newly added columns that are marked both <code>@create</code>
and <code>@delete</code> ‘column_name’</a></li>
<li><a
href="#cql0132-table-has-a-facet-that-is-different-in-the-previous-and-current-schema-table_name"
id="toc-cql0132-table-has-a-facet-that-is-different-in-the-previous-and-current-schema-table_name">CQL0132:
table has a facet that is different in the previous and current schema
‘table_name’</a></li>
<li><a
href="#cql0133-non-column-facets-have-been-removed-from-the-table-name"
id="toc-cql0133-non-column-facets-have-been-removed-from-the-table-name">CQL0133:
non-column facets have been removed from the table ‘name’</a></li>
<li><a
href="#cql0134-table-has-a-new-non-column-facet-in-the-current-schema-table_name"
id="toc-cql0134-table-has-a-new-non-column-facet-in-the-current-schema-table_name">CQL0134:
table has a new non-column facet in the current schema
‘table_name’</a></li>
<li><a
href="#cql0135-table-create-statement-attributes-different-than-previous-version-table_name"
id="toc-cql0135-table-create-statement-attributes-different-than-previous-version-table_name">CQL0135:
table create statement attributes different than previous version
‘table_name’</a></li>
<li><a href="#cql0136-trigger-already-exists-trigger_name"
id="toc-cql0136-trigger-already-exists-trigger_name">CQL0136: trigger
already exists ‘trigger_name’</a></li>
<li><a href="#cql0137-tableview-not-found-name"
id="toc-cql0137-tableview-not-found-name">CQL0137: table/view not found
‘name’</a></li>
<li><a
href="#cql0138-a-trigger-on-a-view-must-be-the-instead-of-form-name"
id="toc-cql0138-a-trigger-on-a-view-must-be-the-instead-of-form-name">CQL0138:
a trigger on a view must be the INSTEAD OF form ‘name’</a></li>
<li><a
href="#cql0139-temp-objects-may-not-have-versioning-annotations-object_name"
id="toc-cql0139-temp-objects-may-not-have-versioning-annotations-object_name">CQL0139:
temp objects may not have versioning annotations ‘object_name’</a></li>
<li><a
href="#cql0140-columns-in-a-temp-table-may-not-have-versioning-attributes-column_name"
id="toc-cql0140-columns-in-a-temp-table-may-not-have-versioning-attributes-column_name">CQL0140:
columns in a temp table may not have versioning attributes
‘column_name’</a></li>
<li><a
href="#cql0141-table-has-an-autoincrement-column-it-cannot-also-be-without-rowid-table_name"
id="toc-cql0141-table-has-an-autoincrement-column-it-cannot-also-be-without-rowid-table_name">CQL0141:
table has an AUTOINCREMENT column; it cannot also be WITHOUT ROWID
‘table_name’</a></li>
<li><a href="#cql0142-duplicate-column-name-column_name"
id="toc-cql0142-duplicate-column-name-column_name">CQL0142: duplicate
column name ‘column_name’</a></li>
<li><a href="#cql0143-more-than-one-primary-key-in-table-table_name"
id="toc-cql0143-more-than-one-primary-key-in-table-table_name">CQL0143:
more than one primary key in table ‘table_name’</a></li>
<li><a href="#cql0144-cannot-alter-a-view-view_name"
id="toc-cql0144-cannot-alter-a-view-view_name">CQL0144: cannot alter a
view ‘view_name’</a></li>
<li><a
href="#cql0144-table-in-alter-statement-does-not-exist-table_name"
id="toc-cql0144-table-in-alter-statement-does-not-exist-table_name">CQL0144:
table in alter statement does not exist ‘table_name’</a></li>
<li><a
href="#cql0145-version-annotations-not-valid-in-alter-statement-column_name"
id="toc-cql0145-version-annotations-not-valid-in-alter-statement-column_name">CQL0145:
version annotations not valid in alter statement ‘column_name’</a></li>
<li><a
href="#cql0146-adding-an-auto-increment-column-is-not-allowed-column_name"
id="toc-cql0146-adding-an-auto-increment-column-is-not-allowed-column_name">CQL0146:
adding an auto increment column is not allowed ‘column_name’</a></li>
<li><a
href="#cql0147-adding-a-not-nullable-column-with-no-default-value-is-not-allowed-column_name"
id="toc-cql0147-adding-a-not-nullable-column-with-no-default-value-is-not-allowed-column_name">CQL0147:
adding a not nullable column with no default value is not allowed
‘column_name’</a></li>
<li><a
href="#cql0148-added-column-must-already-be-reflected-in-declared-schema-with-create-exact-name-match-required-column_name"
id="toc-cql0148-added-column-must-already-be-reflected-in-declared-schema-with-create-exact-name-match-required-column_name">CQL0148:
added column must already be reflected in declared schema, with
<code>@create</code>, exact name match required ‘column_name’</a></li>
<li><a
href="#cql0149-added-column-must-be-an-exact-match-for-the-column-type-declared-in-the-table-column_name"
id="toc-cql0149-added-column-must-be-an-exact-match-for-the-column-type-declared-in-the-table-column_name">CQL0149:
added column must be an exact match for the column type declared in the
table ‘column_name’</a></li>
<li><a href="#cql0150-expected-numeric-expression-in-if-predicate"
id="toc-cql0150-expected-numeric-expression-in-if-predicate">CQL0150:
expected numeric expression in IF predicate</a></li>
<li><a
href="#cql0151-table-in-delete-statement-does-not-exist-table_name"
id="toc-cql0151-table-in-delete-statement-does-not-exist-table_name">CQL0151:
table in delete statement does not exist ‘table_name’</a></li>
<li><a href="#cql0152-cannot-delete-from-a-view-view_name"
id="toc-cql0152-cannot-delete-from-a-view-view_name">CQL0152: cannot
delete from a view ‘view_name’</a></li>
<li><a
href="#cql0153-duplicate-target-column-name-in-update-statement-column_name"
id="toc-cql0153-duplicate-target-column-name-in-update-statement-column_name">CQL0153:
duplicate target column name in update statement ‘column_name’</a></li>
<li><a
href="#cql0154-table-in-update-statement-does-not-exist-table_name"
id="toc-cql0154-table-in-update-statement-does-not-exist-table_name">CQL0154:
table in update statement does not exist ‘table_name’</a></li>
<li><a href="#cql0155-cannot-update-a-view-view_name"
id="toc-cql0155-cannot-update-a-view-view_name">CQL0155: cannot update a
view ‘view_name’</a></li>
<li><a href="#cql0156-seed-expression-must-be-a-non-nullable-integer"
id="toc-cql0156-seed-expression-must-be-a-non-nullable-integer">CQL0156:
seed expression must be a non-nullable integer</a></li>
<li><a href="#cql0157-count-of-columns-differs-from-count-of-values"
id="toc-cql0157-count-of-columns-differs-from-count-of-values">CQL0157:
count of columns differs from count of values</a></li>
<li><a
href="#cql0158-required-column-missing-in-insert-statement-column_name"
id="toc-cql0158-required-column-missing-in-insert-statement-column_name">CQL0158:
required column missing in INSERT statement ‘column_name’</a></li>
<li><a href="#cql0159-cannot-add-an-index-to-a-virtual-table-table_name"
id="toc-cql0159-cannot-add-an-index-to-a-virtual-table-table_name">CQL0159:
cannot add an index to a virtual table ‘table_name’</a></li>
<li><a
href="#cql0160-table-in-insert-statement-does-not-exist-table_name"
id="toc-cql0160-table-in-insert-statement-does-not-exist-table_name">CQL0160:
table in insert statement does not exist ‘table_name’</a></li>
<li><a href="#cql0161-cannot-insert-into-a-view-view_name"
id="toc-cql0161-cannot-insert-into-a-view-view_name">CQL0161: cannot
insert into a view ‘view_name’</a></li>
<li><a
href="#cql0162-cannot-add-a-trigger-to-a-virtual-table-table_name"
id="toc-cql0162-cannot-add-a-trigger-to-a-virtual-table-table_name">CQL0162:
cannot add a trigger to a virtual table ‘table_name’</a></li>
<li><a
href="#cql0163-from-arguments-construct-is-only-valid-inside-a-procedure"
id="toc-cql0163-from-arguments-construct-is-only-valid-inside-a-procedure">CQL0163:
FROM ARGUMENTS construct is only valid inside a procedure</a></li>
<li><a
href="#cql0164-cannot-use-alter-table-on-a-virtual-table-table_name"
id="toc-cql0164-cannot-use-alter-table-on-a-virtual-table-table_name">CQL0164:
cannot use ALTER TABLE on a virtual table ‘table_name’</a></li>
<li><a
href="#cql0165-fetch-values-is-only-for-value-cursors-not-for-sqlite-cursors-cursor_name"
id="toc-cql0165-fetch-values-is-only-for-value-cursors-not-for-sqlite-cursors-cursor_name">CQL0165:
fetch values is only for value cursors, not for sqlite cursors
‘cursor_name’</a></li>
<li><a href="#cql0166-count-of-columns-differs-from-count-of-values"
id="toc-cql0166-count-of-columns-differs-from-count-of-values">CQL0166:
count of columns differs from count of values</a></li>
<li><a
href="#cql0167-required-column-missing-in-fetch-statement-column_name"
id="toc-cql0167-required-column-missing-in-fetch-statement-column_name">CQL0167:
required column missing in FETCH statement ‘column_name’</a></li>
<li><a
href="#cql0168-cql-has-no-good-way-to-generate-dummy-blobs-not-supported-for-now"
id="toc-cql0168-cql-has-no-good-way-to-generate-dummy-blobs-not-supported-for-now">CQL0168:
CQL has no good way to generate dummy blobs; not supported for
now</a></li>
<li><a href="#cql0169-enum-not-found-enum_name"
id="toc-cql0169-enum-not-found-enum_name">CQL0169: enum not found
‘enum_name’</a></li>
<li><a
href="#cql0170-cast-is-redundant-remove-to-reduce-code-size-expression"
id="toc-cql0170-cast-is-redundant-remove-to-reduce-code-size-expression">CQL0170:
cast is redundant, remove to reduce code size ‘expression’</a></li>
<li><a href="#cql0171-name-not-found-name"
id="toc-cql0171-name-not-found-name">CQL0171: name not found
‘name’</a></li>
<li><a href="#cql0172-name-list-has-duplicate-name-name"
id="toc-cql0172-name-list-has-duplicate-name-name">CQL0172: name list
has duplicate name ‘name’</a></li>
<li><a href="#cql0173-variable-not-found-variable_name"
id="toc-cql0173-variable-not-found-variable_name">CQL0173: variable not
found ‘variable_name’</a></li>
<li><a href="#cql0174-cannot-set-a-cursor-cursor_name"
id="toc-cql0174-cannot-set-a-cursor-cursor_name">CQL0174: cannot set a
cursor ‘cursor_name’</a></li>
<li><a href="#cql0175-duplicate-parameter-name-parameter_name"
id="toc-cql0175-duplicate-parameter-name-parameter_name">CQL0175:
duplicate parameter name ‘parameter_name’</a></li>
<li><a
href="#cql0176-indicated-procedure-or-group-already-has-a-recreate-action-name"
id="toc-cql0176-indicated-procedure-or-group-already-has-a-recreate-action-name">CQL0176:
indicated procedure or group already has a recreate action
‘name’</a></li>
<li><a
href="#cql0177-global-constants-must-be-either-constant-numeric-expressions-or-string-literals-constant_definition"
id="toc-cql0177-global-constants-must-be-either-constant-numeric-expressions-or-string-literals-constant_definition">CQL0177:
global constants must be either constant numeric expressions or string
literals ‘constant_definition’</a></li>
<li><a href="#cql0178-proc-has-no-result-like_name"
id="toc-cql0178-proc-has-no-result-like_name">CQL0178: proc has no
result ‘like_name’</a></li>
<li><a
href="#cql0179-shared-fragments-must-consist-of-exactly-one-top-level-statement-procedure_name"
id="toc-cql0179-shared-fragments-must-consist-of-exactly-one-top-level-statement-procedure_name">CQL0179:
shared fragments must consist of exactly one top level statement
‘procedure_name’</a></li>
<li><a
href="#cql0180-duplicate-column-name-in-result-not-allowed-column_name"
id="toc-cql0180-duplicate-column-name-in-result-not-allowed-column_name">CQL0180:
duplicate column name in result not allowed ‘column_name’</a></li>
<li><a href="#cql0181-autodrop-temp-table-does-not-exist-name"
id="toc-cql0181-autodrop-temp-table-does-not-exist-name">CQL0181:
autodrop temp table does not exist ‘name’</a></li>
<li><a href="#cql0182-autodrop-target-is-not-a-table-name"
id="toc-cql0182-autodrop-target-is-not-a-table-name">CQL0182: autodrop
target is not a table ‘name’</a></li>
<li><a href="#cql0183-autodrop-target-must-be-a-temporary-table-name"
id="toc-cql0183-autodrop-target-must-be-a-temporary-table-name">CQL0183:
autodrop target must be a temporary table ‘name’</a></li>
<li><a href="#cql0184-stored-procedures-cannot-be-nested-name"
id="toc-cql0184-stored-procedures-cannot-be-nested-name">CQL0184: stored
procedures cannot be nested ‘name’</a></li>
<li><a href="#cql0185-proc-name-conflicts-with-func-name-name"
id="toc-cql0185-proc-name-conflicts-with-func-name-name">CQL0185: proc
name conflicts with func name ‘name’</a></li>
<li><a href="#cql0186-duplicate-stored-proc-name-name"
id="toc-cql0186-duplicate-stored-proc-name-name">CQL0186: duplicate
stored proc name ‘name’</a></li>
<li><a
href="#cql0187-schema_upgrade_version-not-declared-or-doesnt-match-upgrade-version-n-for-proc-name"
id="toc-cql0187-schema_upgrade_version-not-declared-or-doesnt-match-upgrade-version-n-for-proc-name">CQL0187:
<span class="citation"
data-cites="schema_upgrade_version">@schema_upgrade_version</span> not
declared or doesn’t match upgrade version <code>N</code> for proc
‘name’</a></li>
<li><a
href="#cql0188-procedure-is-supposed-to-do-schema-migration-but-it-doesnt-have-any-dml-name"
id="toc-cql0188-procedure-is-supposed-to-do-schema-migration-but-it-doesnt-have-any-dml-name">CQL0188:
procedure is supposed to do schema migration but it doesn’t have any DML
‘name’</a></li>
<li><a
href="#cql0189-procedure-declarationsdefinitions-do-not-match-name"
id="toc-cql0189-procedure-declarationsdefinitions-do-not-match-name">CQL0189:
procedure declarations/definitions do not match ‘name’</a></li>
<li><a href="#cql0190-duplicate-column-name-name"
id="toc-cql0190-duplicate-column-name-name">CQL0190: duplicate column
name ‘name’</a></li>
<li><a
href="#cql0191-declared-functions-must-be-top-level-function_name"
id="toc-cql0191-declared-functions-must-be-top-level-function_name">CQL0191:
declared functions must be top level ‘function_name’</a></li>
<li><a href="#cql0192-func-name-conflicts-with-proc-name-name"
id="toc-cql0192-func-name-conflicts-with-proc-name-name">CQL0192: func
name conflicts with proc name ‘name’</a></li>
<li><a href="#cql0193-duplicate-function-name-name"
id="toc-cql0193-duplicate-function-name-name">CQL0193: duplicate
function name ‘name’</a></li>
<li><a href="#cql0194-declared-procedures-must-be-top-level-name"
id="toc-cql0194-declared-procedures-must-be-top-level-name">CQL0194:
declared procedures must be top level ‘name’</a></li>
<li><a href="#cql0195-proc-name-conflicts-with-func-name-name"
id="toc-cql0195-proc-name-conflicts-with-func-name-name">CQL0195: proc
name conflicts with func name ‘name’</a></li>
<li><a
href="#cql0196-procedure-declarationsdefinitions-do-not-match-name"
id="toc-cql0196-procedure-declarationsdefinitions-do-not-match-name">CQL0196:
procedure declarations/definitions do not match ‘name’</a></li>
<li><a href="#cql0197-duplicate-variable-name-in-the-same-scope-name"
id="toc-cql0197-duplicate-variable-name-in-the-same-scope-name">CQL0197:
duplicate variable name in the same scope ‘name’</a></li>
<li><a href="#cql0198-global-variable-hides-tableview-name-name"
id="toc-cql0198-global-variable-hides-tableview-name-name">CQL0198:
global variable hides table/view name ‘name’</a></li>
<li><a
href="#cql0199-cursor-requires-a-procedure-that-returns-a-result-set-via-select-procedure_name"
id="toc-cql0199-cursor-requires-a-procedure-that-returns-a-result-set-via-select-procedure_name">CQL0199:
cursor requires a procedure that returns a result set via select
‘procedure_name’</a></li>
<li><a href="#cql0200-variable-is-not-a-cursor-another_cursor"
id="toc-cql0200-variable-is-not-a-cursor-another_cursor">CQL0200:
variable is not a cursor ‘another_cursor’</a></li>
<li><a
href="#cql0201-expanding-from-arguments-there-is-no-argument-matching-required_arg"
id="toc-cql0201-expanding-from-arguments-there-is-no-argument-matching-required_arg">CQL0201:
expanding FROM ARGUMENTS, there is no argument matching
‘required_arg’</a></li>
<li><a href="#cql0202-must-be-a-cursor-proc-table-or-view-like_name"
id="toc-cql0202-must-be-a-cursor-proc-table-or-view-like_name">CQL0202:
must be a cursor, proc, table, or view ‘like_name’</a></li>
<li><a
href="#cql0203-cursor-requires-a-procedure-that-returns-a-cursor-with-out-cursor_name"
id="toc-cql0203-cursor-requires-a-procedure-that-returns-a-cursor-with-out-cursor_name">CQL0203:
cursor requires a procedure that returns a cursor with OUT
‘cursor_name’</a></li>
<li><a href="#cql0205-not-a-cursor-name"
id="toc-cql0205-not-a-cursor-name">CQL0205: not a cursor ‘name’</a></li>
<li><a href="#cql0206-duplicate-name-in-list-name"
id="toc-cql0206-duplicate-name-in-list-name">CQL0206: duplicate name in
list ‘name’</a></li>
<li><a
href="#cql0207-expected-a-variable-name-for-out-or-inout-argument-param_name"
id="toc-cql0207-expected-a-variable-name-for-out-or-inout-argument-param_name">CQL0207:
expected a variable name for OUT or INOUT argument ‘param_name’</a></li>
<li><a
href="#cql0208-shared-fragments-cannot-have-any-out-or-inout-parameters-param_name"
id="toc-cql0208-shared-fragments-cannot-have-any-out-or-inout-parameters-param_name">CQL0208:
shared fragments cannot have any out or in/out parameters
‘param_name’</a></li>
<li><a
href="#cql0209-proc-out-parameter-arg-must-be-an-exact-type-match-expected-expected_type-found-actual_type-param_name"
id="toc-cql0209-proc-out-parameter-arg-must-be-an-exact-type-match-expected-expected_type-found-actual_type-param_name">CQL0209:
proc out parameter: arg must be an exact type match (expected
expected_type; found actual_type) ‘param_name’</a></li>
<li><a
href="#cql0210-proc-out-parameter-arg-must-be-an-exact-type-match-even-nullability"
id="toc-cql0210-proc-out-parameter-arg-must-be-an-exact-type-match-even-nullability">CQL0210:
proc out parameter: arg must be an exact type match (even
nullability)</a></li>
<li><a
href="#cql0211-procedure-without-trailing-out-parameter-used-as-function-procedure_name"
id="toc-cql0211-procedure-without-trailing-out-parameter-used-as-function-procedure_name">CQL0211:
procedure without trailing OUT parameter used as function
‘procedure_name’</a></li>
<li><a href="#cql0212-too-few-arguments-provided-to-procedure-name"
id="toc-cql0212-too-few-arguments-provided-to-procedure-name">CQL0212:
too few arguments provided to procedure ‘name’</a></li>
<li><a href="#cql0213-procedure-had-errors-cant-call.-procedure_name"
id="toc-cql0213-procedure-had-errors-cant-call.-procedure_name">CQL0213:
procedure had errors, can’t call. ‘procedure_name’</a></li>
<li><a
href="#cql0214-procedures-with-results-can-only-be-called-using-a-cursor-in-global-context-name"
id="toc-cql0214-procedures-with-results-can-only-be-called-using-a-cursor-in-global-context-name">CQL0214:
procedures with results can only be called using a cursor in global
context ‘name’</a></li>
<li><a
href="#cql0215-value-cursors-are-not-used-with-fetch-c-or-fetch-c-into-cursor_name"
id="toc-cql0215-value-cursors-are-not-used-with-fetch-c-or-fetch-c-into-cursor_name">CQL0215:
value cursors are not used with FETCH C, or FETCH C INTO
‘cursor_name’</a></li>
<li><a href="#cql0216-fetch-variable-not-found-cursor_name"
id="toc-cql0216-fetch-variable-not-found-cursor_name">CQL0216: FETCH
variable not found ‘cursor_name’</a></li>
<li><a
href="#cql0217-number-of-variables-did-not-match-count-of-columns-in-cursor-cursor_name"
id="toc-cql0217-number-of-variables-did-not-match-count-of-columns-in-cursor-cursor_name">CQL0217:
number of variables did not match count of columns in cursor
‘cursor_name’</a></li>
<li><a
href="#cql0218-continue-must-be-inside-of-a-loop-or-while-statement"
id="toc-cql0218-continue-must-be-inside-of-a-loop-or-while-statement">CQL0218:
continue must be inside of a ‘loop’ or ‘while’ statement</a></li>
<li><a
href="#cql0219-leave-must-be-inside-of-a-loop-while-or-switch-statement"
id="toc-cql0219-leave-must-be-inside-of-a-loop-while-or-switch-statement">CQL0219:
leave must be inside of a ‘loop’, ‘while’, or ‘switch’
statement</a></li>
<li><a
href="#cql0220-savepoint-has-not-been-mentioned-yet-probably-wrong-name"
id="toc-cql0220-savepoint-has-not-been-mentioned-yet-probably-wrong-name">CQL0220:
savepoint has not been mentioned yet, probably wrong ‘name’</a></li>
<li><a
href="#cql0221-savepoint-has-not-been-mentioned-yet-probably-wrong-name"
id="toc-cql0221-savepoint-has-not-been-mentioned-yet-probably-wrong-name">CQL0221:
savepoint has not been mentioned yet, probably wrong ‘name’</a></li>
<li><a
href="#cql0222-out-cursor-statement-only-makes-sense-inside-of-a-procedure"
id="toc-cql0222-out-cursor-statement-only-makes-sense-inside-of-a-procedure">CQL0222:
out cursor statement only makes sense inside of a procedure</a></li>
<li><a
href="#cql0223-cursor-was-not-fetched-with-the-auto-fetch-syntax-fetch-cursor-cursor_name"
id="toc-cql0223-cursor-was-not-fetched-with-the-auto-fetch-syntax-fetch-cursor-cursor_name">CQL0223:
cursor was not fetched with the auto-fetch syntax ‘fetch [cursor]’
‘cursor_name’</a></li>
<li><a
href="#cql0224-a-call-statement-inside-sql-may-call-only-a-shared-fragment-i.e.-attributecqlshared_fragment"
id="toc-cql0224-a-call-statement-inside-sql-may-call-only-a-shared-fragment-i.e.-attributecqlshared_fragment">CQL0224:
a CALL statement inside SQL may call only a shared fragment i.e. <span
class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment)</a></li>
<li><a
href="#cql0225-switching-to-previous-schema-validation-mode-must-be-outside-of-any-proc"
id="toc-cql0225-switching-to-previous-schema-validation-mode-must-be-outside-of-any-proc">CQL0225:
switching to previous schema validation mode must be outside of any
proc</a></li>
<li><a
href="#cql0226-schema-upgrade-declaration-must-be-outside-of-any-proc"
id="toc-cql0226-schema-upgrade-declaration-must-be-outside-of-any-proc">CQL0226:
schema upgrade declaration must be outside of any proc</a></li>
<li><a
href="#cql0227-schema-upgrade-declaration-must-come-before-any-tables-are-declared"
id="toc-cql0227-schema-upgrade-declaration-must-come-before-any-tables-are-declared">CQL0227:
schema upgrade declaration must come before any tables are
declared</a></li>
<li><a href="#cql0228-schema-upgrade-version-must-be-a-positive-integer"
id="toc-cql0228-schema-upgrade-version-must-be-a-positive-integer">CQL0228:
schema upgrade version must be a positive integer</a></li>
<li><a
href="#cql0229-schema-upgrade-version-declaration-may-only-appear-once"
id="toc-cql0229-schema-upgrade-version-declaration-may-only-appear-once">CQL0229:
schema upgrade version declaration may only appear once</a></li>
<li><a
href="#cql0230-schema-upgrade-version-declaration-must-be-outside-of-any-proc"
id="toc-cql0230-schema-upgrade-version-declaration-must-be-outside-of-any-proc">CQL0230:
schema upgrade version declaration must be outside of any proc</a></li>
<li><a
href="#cql0231-schema-upgrade-version-declaration-must-come-before-any-tables-are-declared"
id="toc-cql0231-schema-upgrade-version-declaration-must-come-before-any-tables-are-declared">CQL0231:
schema upgrade version declaration must come before any tables are
declared</a></li>
<li><a
href="#cql0232-nested-select-expression-must-return-exactly-one-column"
id="toc-cql0232-nested-select-expression-must-return-exactly-one-column">CQL0232:
nested select expression must return exactly one column</a></li>
<li><a
href="#cql0233-procedure-previously-declared-as-schema-upgrade-proc-it-can-have-no-args-procedure_name"
id="toc-cql0233-procedure-previously-declared-as-schema-upgrade-proc-it-can-have-no-args-procedure_name">CQL0233:
procedure previously declared as schema upgrade proc, it can have no
args ‘procedure_name’</a></li>
<li><a
href="#cql0234-autodrop-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name"
id="toc-cql0234-autodrop-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name">CQL0234:
autodrop annotation can only go on a procedure that returns a result set
‘procedure_name’</a></li>
<li><a
href="#cql0235-too-many-arguments-provided-to-procedure-procedure_name"
id="toc-cql0235-too-many-arguments-provided-to-procedure-procedure_name">CQL0235:
too many arguments provided to procedure ‘procedure_name’</a></li>
<li><a
href="#cql0236-autodrop-annotation-can-only-go-on-a-procedure-that-uses-the-database-name"
id="toc-cql0236-autodrop-annotation-can-only-go-on-a-procedure-that-uses-the-database-name">CQL0236:
autodrop annotation can only go on a procedure that uses the database
‘name’</a></li>
<li><a
href="#cql0237-strict-fk-validation-requires-that-some-on-update-option-be-selected-for-every-foreign-key"
id="toc-cql0237-strict-fk-validation-requires-that-some-on-update-option-be-selected-for-every-foreign-key">CQL0237:
strict FK validation requires that some ON UPDATE option be selected for
every foreign key</a></li>
<li><a
href="#cql0238-strict-fk-validation-requires-that-some-on-delete-option-be-selected-for-every-foreign-key"
id="toc-cql0238-strict-fk-validation-requires-that-some-on-delete-option-be-selected-for-every-foreign-key">CQL0238:
strict FK validation requires that some ON DELETE option be selected for
every foreign key</a></li>
<li><a
href="#cql0239-annotation-column-does-not-exist-in-result-set-column_name"
id="toc-cql0239-annotation-column-does-not-exist-in-result-set-column_name">CQL0239:
‘annotation’ column does not exist in result set ‘column_name’</a></li>
<li><a
href="#cql0240-identity-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name"
id="toc-cql0240-identity-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name">CQL0240:
identity annotation can only go on a procedure that returns a result set
‘procedure_name’</a></li>
<li><a
href="#cql0241-concat-may-only-appear-in-the-context-of-sql-statement"
id="toc-cql0241-concat-may-only-appear-in-the-context-of-sql-statement">CQL0241:
CONCAT may only appear in the context of SQL statement</a></li>
<li><a href="#cql0242-lossy-conversion-from-type-type"
id="toc-cql0242-lossy-conversion-from-type-type">CQL0242: lossy
conversion from type ‘type’</a></li>
<li><a href="#cql0243-blob-operand-must-be-converted-to-string-first-in"
id="toc-cql0243-blob-operand-must-be-converted-to-string-first-in">CQL0243:
blob operand must be converted to string first in ‘||’</a></li>
<li><a href="#cql0244-unknown-schema-region-region"
id="toc-cql0244-unknown-schema-region-region">CQL0244: unknown schema
region ‘region’</a></li>
<li><a href="#cql0245-schema-region-already-defined-region"
id="toc-cql0245-schema-region-already-defined-region">CQL0245: schema
region already defined ‘region’</a></li>
<li><a
href="#cql0246-schema-regions-do-not-nest-end-the-current-region-before-starting-a-new-one"
id="toc-cql0246-schema-regions-do-not-nest-end-the-current-region-before-starting-a-new-one">CQL0246:
schema regions do not nest; end the current region before starting a new
one</a></li>
<li><a
href="#cql0247-you-must-begin-a-schema-region-before-you-can-end-one"
id="toc-cql0247-you-must-begin-a-schema-region-before-you-can-end-one">CQL0247:
you must begin a schema region before you can end one</a></li>
<li><a
href="#cql0248-schema-region-directives-may-not-appear-inside-of-a-procedure"
id="toc-cql0248-schema-region-directives-may-not-appear-inside-of-a-procedure">CQL0248:
schema region directives may not appear inside of a procedure</a></li>
<li><a
href="#cql0249-function-is-not-a-table-valued-function-function_name"
id="toc-cql0249-function-is-not-a-table-valued-function-function_name">CQL0249:
function is not a table-valued-function ‘function_name’</a></li>
<li><a href="#cql0250-table-valued-function-not-declared-function_name"
id="toc-cql0250-table-valued-function-not-declared-function_name">CQL0250:
table-valued function not declared ‘function_name’</a></li>
<li><a href="#cql0251-unused" id="toc-cql0251-unused">CQL0251
Unused</a></li>
<li><a href="#cql0252-proc-literal-can-only-appear-inside-of-procedures"
id="toc-cql0252-proc-literal-can-only-appear-inside-of-procedures">CQL0252:
<span class="citation" data-cites="PROC">@PROC</span> literal can only
appear inside of procedures</a></li>
<li><a href="#cql0253-unused" id="toc-cql0253-unused">CQL0253
Unused</a></li>
<li><a
href="#cql0254-switching-to-previous-schema-validation-mode-not-allowed-if-schema_upgrade_version-was-used"
id="toc-cql0254-switching-to-previous-schema-validation-mode-not-allowed-if-schema_upgrade_version-was-used">CQL0254:
switching to previous schema validation mode not allowed if
<code>@schema_upgrade_version</code> was used</a></li>
<li><a href="#cql0255-unused" id="toc-cql0255-unused">CQL0255
Unused</a></li>
<li><a href="#cql0256-unused" id="toc-cql0256-unused">CQL0256
Unused</a></li>
<li><a href="#cql0257-argument-must-be-a-string-or-numeric-in-function"
id="toc-cql0257-argument-must-be-a-string-or-numeric-in-function">CQL0257:
argument must be a string or numeric in ‘function’</a></li>
<li><a href="#cql0258-unused" id="toc-cql0258-unused">CQL0258
Unused</a></li>
<li><a href="#cql0259-unused" id="toc-cql0259-unused">CQL0259
Unused</a></li>
<li><a href="#cql0260-unused" id="toc-cql0260-unused">CQL0260
Unused</a></li>
<li><a
href="#cql0261-cursor-did-not-originate-from-a-sqlite-statement-it-only-has-values-cursor_name"
id="toc-cql0261-cursor-did-not-originate-from-a-sqlite-statement-it-only-has-values-cursor_name">CQL0261:
cursor did not originate from a SQLite statement, it only has values
‘cursor_name’</a></li>
<li><a
href="#cql0262-like-arguments-used-on-a-procedure-with-no-arguments-procedure_name"
id="toc-cql0262-like-arguments-used-on-a-procedure-with-no-arguments-procedure_name">CQL0262:
LIKE … ARGUMENTS used on a procedure with no arguments
‘procedure_name’</a></li>
<li><a
href="#cql0263-non-ansi-joins-are-forbidden-if-strict-join-mode-is-enabled."
id="toc-cql0263-non-ansi-joins-are-forbidden-if-strict-join-mode-is-enabled.">CQL0263:
non-ANSI joins are forbidden if strict join mode is enabled.</a></li>
<li><a href="#cql0264-unused" id="toc-cql0264-unused">CQL0264
Unused</a></li>
<li><a href="#cql0265-unused" id="toc-cql0265-unused">CQL0265
Unused</a></li>
<li><a href="#cql0266-unused" id="toc-cql0266-unused">CQL0266
Unused</a></li>
<li><a href="#cql0267-unused" id="toc-cql0267-unused">CQL0267
Unused</a></li>
<li><a href="#cql0268-unused" id="toc-cql0268-unused">CQL0268
Unused</a></li>
<li><a
href="#cql0269-at-least-part-of-this-unique-key-is-redundant-with-previous-unique-keys"
id="toc-cql0269-at-least-part-of-this-unique-key-is-redundant-with-previous-unique-keys">CQL0269:
at least part of this unique key is redundant with previous unique
keys</a></li>
<li><a
href="#cql0270-use-fetch-from-for-procedures-that-returns-a-cursor-with-out-cursor"
id="toc-cql0270-use-fetch-from-for-procedures-that-returns-a-cursor-with-out-cursor">CQL0270:
use FETCH FROM for procedures that returns a cursor with OUT
‘cursor’</a></li>
<li><a
href="#cql0271-offset-clause-may-only-be-used-if-limit-is-also-present"
id="toc-cql0271-offset-clause-may-only-be-used-if-limit-is-also-present">CQL0271:
OFFSET clause may only be used if LIMIT is also present</a></li>
<li><a
href="#cql0272-columns-referenced-in-the-foreign-key-statement-should-match-exactly-a-unique-key-in-parent-table"
id="toc-cql0272-columns-referenced-in-the-foreign-key-statement-should-match-exactly-a-unique-key-in-parent-table">CQL0272:
columns referenced in the foreign key statement should match exactly a
unique key in parent table</a></li>
<li><a
href="#cql0273-autotest-attribute-has-incorrect-format-in-dummy_test"
id="toc-cql0273-autotest-attribute-has-incorrect-format-in-dummy_test">CQL0273:
autotest attribute has incorrect format (…) in ‘dummy_test’</a></li>
<li><a
href="#cql0274-autotest-attribute-dummy_test-has-non-existent-table"
id="toc-cql0274-autotest-attribute-dummy_test-has-non-existent-table">CQL0274:
autotest attribute ‘dummy_test’ has non existent table</a></li>
<li><a
href="#cql0275-autotest-attribute-dummy_test-has-non-existent-column"
id="toc-cql0275-autotest-attribute-dummy_test-has-non-existent-column">CQL0275:
autotest attribute ‘dummy_test’ has non existent column</a></li>
<li><a
href="#cql0276-autotest-attribute-dummy_test-has-invalid-value-type-in"
id="toc-cql0276-autotest-attribute-dummy_test-has-invalid-value-type-in">CQL0276:
autotest attribute ‘dummy_test’ has invalid value type in</a></li>
<li><a href="#cql0277-autotest-has-incorrect-format"
id="toc-cql0277-autotest-has-incorrect-format">CQL0277: autotest has
incorrect format</a></li>
<li><a href="#cql0278-autotest-attribute-name-is-not-valid"
id="toc-cql0278-autotest-attribute-name-is-not-valid">CQL0278: autotest
attribute name is not valid</a></li>
<li><a
href="#cql0279-columns-referenced-in-an-upsert-conflict-target-must-exactly-match-a-unique-key-the-target-table"
id="toc-cql0279-columns-referenced-in-an-upsert-conflict-target-must-exactly-match-a-unique-key-the-target-table">CQL0279:
columns referenced in an UPSERT conflict target must exactly match a
unique key the target table</a></li>
<li><a
href="#cql0280-upsert-statement-requires-a-where-clause-if-the-insert-clause-uses-select"
id="toc-cql0280-upsert-statement-requires-a-where-clause-if-the-insert-clause-uses-select">CQL0280:
upsert statement requires a where clause if the insert clause uses
select</a></li>
<li><a
href="#cql0281-upsert-statement-does-not-include-table-name-in-the-update-statement"
id="toc-cql0281-upsert-statement-does-not-include-table-name-in-the-update-statement">CQL0281:
upsert statement does not include table name in the update
statement</a></li>
<li><a href="#cql0282-update-statement-require-table-name"
id="toc-cql0282-update-statement-require-table-name">CQL0282: update
statement require table name</a></li>
<li><a href="#cql0283-upsert-syntax-only-support-insert-into"
id="toc-cql0283-upsert-syntax-only-support-insert-into">CQL0283: upsert
syntax only support INSERT INTO</a></li>
<li><a
href="#cql0284-ad-hoc-schema-migration-directive-must-provide-a-procedure-to-run"
id="toc-cql0284-ad-hoc-schema-migration-directive-must-provide-a-procedure-to-run">CQL0284:
ad hoc schema migration directive must provide a procedure to
run</a></li>
<li><a
href="#cql0285-ad-hoc-schema-migration-directive-version-number-changed-procedure_name"
id="toc-cql0285-ad-hoc-schema-migration-directive-version-number-changed-procedure_name">CQL0285:
ad hoc schema migration directive version number changed
‘procedure_name’</a></li>
<li><a
href="#cql0286-ad-hoc-schema-migration-directive-was-removed-this-is-not-allowed-procedure_name"
id="toc-cql0286-ad-hoc-schema-migration-directive-was-removed-this-is-not-allowed-procedure_name">CQL0286:
ad hoc schema migration directive was removed; this is not allowed
‘procedure_name’</a></li>
<li><a href="#cql0287-unused" id="toc-cql0287-unused">CQL0287
Unused</a></li>
<li><a href="#cql0288-unused" id="toc-cql0288-unused">CQL0288
Unused</a></li>
<li><a
href="#cql0289-upsert-statement-are-forbidden-if-strict-upsert-statement-mode-is-enabled"
id="toc-cql0289-upsert-statement-are-forbidden-if-strict-upsert-statement-mode-is-enabled">CQL0289:
upsert statement are forbidden if strict upsert statement mode is
enabled</a></li>
<li><a href="#cql0290-unused" id="toc-cql0290-unused">CQL0290
Unused</a></li>
<li><a
href="#cql0291-region-links-into-the-middle-of-a-deployable-region-you-must-point-to-the-root-of-deployable_region-not-into-the-middle-error_region"
id="toc-cql0291-region-links-into-the-middle-of-a-deployable-region-you-must-point-to-the-root-of-deployable_region-not-into-the-middle-error_region">CQL0291:
region links into the middle of a deployable region; you must point to
the root of <code>&lt;deployable_region&gt;</code> not into the middle:
<code>&lt;error_region&gt;</code></a></li>
<li><a
href="#cql0292-explain-statement-is-only-available-in-dev-mode-because-its-result-set-may-vary-between-sqlite-versions"
id="toc-cql0292-explain-statement-is-only-available-in-dev-mode-because-its-result-set-may-vary-between-sqlite-versions">CQL0292:
explain statement is only available in dev mode because its result set
may vary between sqlite versions</a></li>
<li><a href="#cql0293-only-explain-query-plan-statement-is-supported"
id="toc-cql0293-only-explain-query-plan-statement-is-supported">CQL0293:
only [EXPLAIN QUERY PLAN …] statement is supported</a></li>
<li><a
href="#cql0294-window-function-invocations-can-only-appear-in-the-select-list-of-a-select-statement"
id="toc-cql0294-window-function-invocations-can-only-appear-in-the-select-list-of-a-select-statement">CQL0294:
window function invocations can only appear in the select list of a
select statement</a></li>
<li><a href="#cql0295-window-name-is-not-defined"
id="toc-cql0295-window-name-is-not-defined">CQL0295: window name is not
defined</a></li>
<li><a href="#cql0296-window-name-definition-is-not-used"
id="toc-cql0296-window-name-definition-is-not-used">CQL0296: window name
definition is not used</a></li>
<li><a href="#cql0297-from-shape-is-redundant-if-column-list-is-empty"
id="toc-cql0297-from-shape-is-redundant-if-column-list-is-empty">CQL0297:
FROM [shape] is redundant if column list is empty</a></li>
<li><a
href="#cql0298-cannot-read-from-a-cursor-without-fields-cursor_name"
id="toc-cql0298-cannot-read-from-a-cursor-without-fields-cursor_name">CQL0298:
cannot read from a cursor without fields ‘cursor_name’</a></li>
<li><a href="#cql0299-cursor-has-too-few-fields-shape_name"
id="toc-cql0299-cursor-has-too-few-fields-shape_name">CQL0299: [cursor]
has too few fields, ‘shape_name’</a></li>
<li><a
href="#cql0300-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name"
id="toc-cql0300-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name">CQL0300:
argument must be an integer (between 1 and max integer) in function
‘function_name’</a></li>
<li><a
href="#cql0301-second-argument-must-be-an-integer-between-0-and-max-integer-in-function-function_name"
id="toc-cql0301-second-argument-must-be-an-integer-between-0-and-max-integer-in-function-function_name">CQL0301:
second argument must be an integer (between 0 and max integer) in
function ‘function_name’</a></li>
<li><a
href="#cql0302-first-and-third-arguments-must-be-compatible-in-function-function_name"
id="toc-cql0302-first-and-third-arguments-must-be-compatible-in-function-function_name">CQL0302:
first and third arguments must be compatible in function
‘function_name’</a></li>
<li><a
href="#cql0303-second-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name"
id="toc-cql0303-second-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name">CQL0303:
second argument must be an integer between 1 and max integer in function
‘function_name’</a></li>
<li><a
href="#cql0304-distinct-may-only-be-used-with-one-explicit-argument-in-an-aggregate-function"
id="toc-cql0304-distinct-may-only-be-used-with-one-explicit-argument-in-an-aggregate-function">CQL0304:
DISTINCT may only be used with one explicit argument in an aggregate
function</a></li>
<li><a
href="#cql0305-distinct-may-only-be-used-in-function-that-are-aggregated-or-user-defined"
id="toc-cql0305-distinct-may-only-be-used-in-function-that-are-aggregated-or-user-defined">CQL0305:
DISTINCT may only be used in function that are aggregated or user
defined</a></li>
<li><a
href="#cql0306-filter-clause-may-only-be-used-in-function-that-are-aggregated-or-user-defined"
id="toc-cql0306-filter-clause-may-only-be-used-in-function-that-are-aggregated-or-user-defined">CQL0306:
FILTER clause may only be used in function that are aggregated or user
defined</a></li>
<li><a
href="#cql0307-return-statement-should-be-in-a-procedure-and-not-at-the-top-level"
id="toc-cql0307-return-statement-should-be-in-a-procedure-and-not-at-the-top-level">CQL0307:
return statement should be in a procedure and not at the top
level</a></li>
<li><a
href="#cql0308-statement-should-be-the-last-thing-in-a-statement-list"
id="toc-cql0308-statement-should-be-the-last-thing-in-a-statement-list">CQL0308:
statement should be the last thing in a statement list</a></li>
<li><a
href="#cql0309-new-table-must-be-added-with-createnumber-or-later-table_name"
id="toc-cql0309-new-table-must-be-added-with-createnumber-or-later-table_name">CQL0309:
new table must be added with <span class="citation"
data-cites="create">@create</span>([number]) or later
‘table_name’</a></li>
<li><a
href="#cql0310-new-column-must-be-added-with-createnumber-or-later-column_name"
id="toc-cql0310-new-column-must-be-added-with-createnumber-or-later-column_name">CQL0310:
new column must be added with <span class="citation"
data-cites="create">@create</span>([number]) or later”
‘column_name’</a></li>
<li><a
href="#cql0311-objects-deployment-region-changed-from-to-object_name"
id="toc-cql0311-objects-deployment-region-changed-from-to-object_name">CQL0311:
object’s deployment region changed from ‘<previous_region>’ to
‘<current_region>’ ‘object_name’</a></li>
<li><a
href="#cql0312-window-function-invocation-are-forbidden-if-strict-window-function-mode-is-enabled"
id="toc-cql0312-window-function-invocation-are-forbidden-if-strict-window-function-mode-is-enabled">CQL0312:
window function invocation are forbidden if strict window function mode
is enabled</a></li>
<li><a
href="#cql0313-blob-literals-may-only-appear-in-the-context-of-a-sql-statement"
id="toc-cql0313-blob-literals-may-only-appear-in-the-context-of-a-sql-statement">CQL0313:
blob literals may only appear in the context of a SQL statement</a></li>
<li><a
href="#cql0314-select-function-does-not-require-a-declaration-it-is-a-cql-built-in"
id="toc-cql0314-select-function-does-not-require-a-declaration-it-is-a-cql-built-in">CQL0314:
select function does not require a declaration, it is a CQL
built-in</a></li>
<li><a
href="#cql0315-mandatory-column-with-no-default-value-in-insert-into-name-default-values-statement."
id="toc-cql0315-mandatory-column-with-no-default-value-in-insert-into-name-default-values-statement.">CQL0315:
mandatory column with no default value in INSERT INTO name DEFAULT
VALUES statement.</a></li>
<li><a
href="#cql0316-upsert-clause-is-not-compatible-with-default-values"
id="toc-cql0316-upsert-clause-is-not-compatible-with-default-values">CQL0316:
upsert-clause is not compatible with DEFAULT VALUES</a></li>
<li><a href="#cql0317-char-function-arguments-must-be-integer"
id="toc-cql0317-char-function-arguments-must-be-integer">CQL0317: char
function arguments must be integer</a></li>
<li><a href="#cql0318-unused" id="toc-cql0318-unused">CQL0318
Unused</a></li>
<li><a href="#cql0319-unused" id="toc-cql0319-unused">CQL0319
Unused</a></li>
<li><a href="#cql0320-unused" id="toc-cql0320-unused">CQL0320
Unused</a></li>
<li><a href="#cql0321-migration-proc-not-allowed-on-object-object_name"
id="toc-cql0321-migration-proc-not-allowed-on-object-object_name">CQL0321:
migration proc not allowed on object ‘object_name’</a></li>
<li><a href="#cql0322-unused" id="toc-cql0322-unused">CQL0322
Unused</a></li>
<li><a
href="#cql0323-calls-to-undeclared-procedures-are-forbidden-declaration-missing-or-typo-procedure"
id="toc-cql0323-calls-to-undeclared-procedures-are-forbidden-declaration-missing-or-typo-procedure">CQL0323:
calls to undeclared procedures are forbidden; declaration missing or
typo ‘procedure’</a></li>
<li><a
href="#cql0324-referenced-table-was-created-in-a-later-version-so-it-cannot-be-used-in-a-foreign-key-referenced_table"
id="toc-cql0324-referenced-table-was-created-in-a-later-version-so-it-cannot-be-used-in-a-foreign-key-referenced_table">CQL0324:
referenced table was created in a later version so it cannot be used in
a foreign key ‘referenced_table’</a></li>
<li><a href="#cql0325-ok_table_scan-attribute-must-be-a-name"
id="toc-cql0325-ok_table_scan-attribute-must-be-a-name">CQL0325:
ok_table_scan attribute must be a name</a></li>
<li><a
href="#cql0326-table-name-in-ok_table_scan-does-not-exist-table_name"
id="toc-cql0326-table-name-in-ok_table_scan-does-not-exist-table_name">CQL0326:
table name in ok_table_scan does not exist ‘table_name’</a></li>
<li><a
href="#cql0327-a-value-should-not-be-assigned-to-attribute_name-attribute"
id="toc-cql0327-a-value-should-not-be-assigned-to-attribute_name-attribute">CQL0327:
a value should not be assigned to ‘attribute_name’ attribute</a></li>
<li><a
href="#cql0328-attribute_name-attribute-may-only-be-added-to-a-statement_name"
id="toc-cql0328-attribute_name-attribute-may-only-be-added-to-a-statement_name">CQL0328:
‘attribute_name’ attribute may only be added to a
‘statement_name’</a></li>
<li><a
href="#cql0329-ok_table_scan-attribute-can-only-be-used-in-a-create-procedure-statement"
id="toc-cql0329-ok_table_scan-attribute-can-only-be-used-in-a-create-procedure-statement">CQL0329:
ok_table_scan attribute can only be used in a create procedure
statement</a></li>
<li><a href="#cql0330-unused" id="toc-cql0330-unused">CQL0330
Unused</a></li>
<li><a href="#cql0331-unused" id="toc-cql0331-unused">CQL0331
Unused</a></li>
<li><a href="#cql0332-unused" id="toc-cql0332-unused">CQL0332
Unused</a></li>
<li><a href="#cql0333-unused" id="toc-cql0333-unused">CQL0333
Unused</a></li>
<li><a
href="#cql0334-dummy_seed-dummy_nullables-dummy_defaults-many-only-be-used-with-a-single-values-row"
id="toc-cql0334-dummy_seed-dummy_nullables-dummy_defaults-many-only-be-used-with-a-single-values-row">CQL0334:
<span class="citation" data-cites="dummy_seed">@dummy_seed</span> <span
class="citation" data-cites="dummy_nullables">@dummy_nullables</span>
<span class="citation"
data-cites="dummy_defaults">@dummy_defaults</span> many only be used
with a single VALUES row</a></li>
<li><a
href="#cql0336-select-statement-with-values-clause-requires-a-non-empty-list-of-values"
id="toc-cql0336-select-statement-with-values-clause-requires-a-non-empty-list-of-values">CQL0336:
select statement with VALUES clause requires a non empty list of
values</a></li>
<li><a
href="#cql0337-number-of-columns-values-for-each-row-should-be-identical-in-values-clause"
id="toc-cql0337-number-of-columns-values-for-each-row-should-be-identical-in-values-clause">CQL0337:
number of columns values for each row should be identical in VALUES
clause</a></li>
<li><a
href="#cql0338-name-of-a-migration-procedure-may-not-end-in-_crc-procedure_name"
id="toc-cql0338-name-of-a-migration-procedure-may-not-end-in-_crc-procedure_name">CQL0338:
name of a migration procedure may not end in ’_crc’
‘procedure_name’</a></li>
<li><a
href="#cql0339-without-rowid-tables-are-forbidden-if-strict-without-rowid-mode-is-enabled"
id="toc-cql0339-without-rowid-tables-are-forbidden-if-strict-without-rowid-mode-is-enabled">CQL0339:
WITHOUT ROWID tables are forbidden if strict without rowid mode is
enabled</a></li>
<li><a
href="#cql0340-from-arguments-used-in-a-procedure-with-no-arguments-procedure_name"
id="toc-cql0340-from-arguments-used-in-a-procedure-with-no-arguments-procedure_name">CQL0340:
FROM ARGUMENTS used in a procedure with no arguments
‘procedure_name’</a></li>
<li><a
href="#cql0341-argument-must-be-a-variable-in-function-function_name"
id="toc-cql0341-argument-must-be-a-variable-in-function-function_name">CQL0341:
argument must be a variable in function ‘function_name’</a></li>
<li><a
href="#cql0342-cursor-arguments-must-have-identical-column-count-function_name"
id="toc-cql0342-cursor-arguments-must-have-identical-column-count-function_name">CQL0342:
cursor arguments must have identical column count
‘function_name’</a></li>
<li><a href="#cql0343-all-arguments-must-be-blob-cql_get_blob_size"
id="toc-cql0343-all-arguments-must-be-blob-cql_get_blob_size">CQL0343:
all arguments must be blob ‘cql_get_blob_size’</a></li>
<li><a
href="#cql0344-argument-must-be-a-nullable-type-but-not-constant-null-in-function"
id="toc-cql0344-argument-must-be-a-nullable-type-but-not-constant-null-in-function">CQL0344:
argument must be a nullable type (but not constant NULL) in
‘function’</a></li>
<li><a href="#cql0345-arguments-must-be-of-type-blob-function_name"
id="toc-cql0345-arguments-must-be-of-type-blob-function_name">CQL0345:
arguments must be of type blob ‘function_name’</a></li>
<li><a
href="#cql0346-expression-must-be-of-type-objectt-cursor-where-t-is-a-valid-shape-name-variable"
id="toc-cql0346-expression-must-be-of-type-objectt-cursor-where-t-is-a-valid-shape-name-variable">CQL0346:
expression must be of type <code>object&lt;T cursor&gt;</code> where T
is a valid shape name ‘variable’</a></li>
<li><a
href="#cql0347-select-function-may-not-return-type-object-function_name"
id="toc-cql0347-select-function-may-not-return-type-object-function_name">CQL0347:
select function may not return type OBJECT ‘function_name’</a></li>
<li><a href="#cql0348-collate-applied-to-a-non-text-column-column_name"
id="toc-cql0348-collate-applied-to-a-non-text-column-column_name">CQL0348:
collate applied to a non-text column ‘column_name’</a></li>
<li><a
href="#cql0349-column-definitions-may-not-come-after-constraints-column_name"
id="toc-cql0349-column-definitions-may-not-come-after-constraints-column_name">CQL0349:
column definitions may not come after constraints ‘column_name’</a></li>
<li><a
href="#cql0350-statement-must-appear-inside-of-a-proc-savepoint-block"
id="toc-cql0350-statement-must-appear-inside-of-a-proc-savepoint-block">CQL0350:
statement must appear inside of a PROC SAVEPOINT block</a></li>
<li><a
href="#cql0351-statement-should-be-in-a-procedure-and-at-the-top-level"
id="toc-cql0351-statement-should-be-in-a-procedure-and-at-the-top-level">CQL0351:
statement should be in a procedure and at the top level</a></li>
<li><a
href="#cql0352-use-commit-return-or-rollback-return-in-within-a-proc-savepoint-block"
id="toc-cql0352-use-commit-return-or-rollback-return-in-within-a-proc-savepoint-block">CQL0352:
use COMMIT RETURN or ROLLBACK RETURN in within a proc savepoint
block</a></li>
<li><a href="#cql0353-evaluation-of-constant-failed"
id="toc-cql0353-evaluation-of-constant-failed">CQL0353: evaluation of
constant failed</a></li>
<li><a href="#cql0354-duplicate-enum-member-enum_name"
id="toc-cql0354-duplicate-enum-member-enum_name">CQL0354: duplicate enum
member ‘enum_name’</a></li>
<li><a href="#cql0355-evaluation-failed-enum_name"
id="toc-cql0355-evaluation-failed-enum_name">CQL0355: evaluation failed
‘enum_name’</a></li>
<li><a href="#cql0356-enum-definitions-do-not-match-name"
id="toc-cql0356-enum-definitions-do-not-match-name">CQL0356: enum
definitions do not match ‘name’</a></li>
<li><a href="#cql0357-enum-does-not-contain-enum_name"
id="toc-cql0357-enum-does-not-contain-enum_name">CQL0357: enum does not
contain ‘enum_name’</a></li>
<li><a href="#cql0358-declared-enums-must-be-top-level-enum"
id="toc-cql0358-declared-enums-must-be-top-level-enum">CQL0358: declared
enums must be top level ‘enum’</a></li>
<li><a href="#cql0359-duplicate-type-declaration-type_name"
id="toc-cql0359-duplicate-type-declaration-type_name">CQL0359: duplicate
type declaration ‘type_name’</a></li>
<li><a href="#cql0360-unknown-type-type_name"
id="toc-cql0360-unknown-type-type_name">CQL0360: unknown type
‘type_name’</a></li>
<li><a
href="#cql0361-return-data-type-in-a-create-function-declaration-can-only-be-text-blob-or-object"
id="toc-cql0361-return-data-type-in-a-create-function-declaration-can-only-be-text-blob-or-object">CQL0361:
return data type in a create function declaration can only be Text, Blob
or Object</a></li>
<li><a
href="#cql0362-hidden-column-attribute-must-be-the-first-attribute-if-present"
id="toc-cql0362-hidden-column-attribute-must-be-the-first-attribute-if-present">CQL0362:
HIDDEN column attribute must be the first attribute if present</a></li>
<li><a href="#cql0363-all-arguments-must-be-names-vault_sensitive"
id="toc-cql0363-all-arguments-must-be-names-vault_sensitive">CQL0363:
all arguments must be names ‘vault_sensitive’</a></li>
<li><a
href="#cql0364-vault_sensitive-annotation-can-only-go-on-a-procedure-that-uses-the-database"
id="toc-cql0364-vault_sensitive-annotation-can-only-go-on-a-procedure-that-uses-the-database">CQL0364:
vault_sensitive annotation can only go on a procedure that uses the
database</a></li>
<li><a href="#cql0365-enforce_pop-used-but-there-is-nothing-to-pop"
id="toc-cql0365-enforce_pop-used-but-there-is-nothing-to-pop">CQL0365:
<span class="citation" data-cites="enforce_pop">@enforce_pop</span> used
but there is nothing to pop</a></li>
<li><a
href="#cql0366-transaction-operations-disallowed-while-strict-transaction-enforcement-is-on"
id="toc-cql0366-transaction-operations-disallowed-while-strict-transaction-enforcement-is-on">CQL0366:
transaction operations disallowed while STRICT TRANSACTION enforcement
is on</a></li>
<li><a href="#cql0367-an-attribute-was-specified-twice-attribute_name"
id="toc-cql0367-an-attribute-was-specified-twice-attribute_name">CQL0367:
an attribute was specified twice ‘attribute_name’</a></li>
<li><a
href="#cql0368-strict-select-if-nothing-requires-that-all-select-expressions-include-if-nothing"
id="toc-cql0368-strict-select-if-nothing-requires-that-all-select-expressions-include-if-nothing">CQL0368:
strict select if nothing requires that all (select …) expressions
include ‘if nothing’</a></li>
<li><a
href="#cql0369-select-if-nothing-construct-is-for-use-in-top-level-expressions-not-inside-of-other-dml"
id="toc-cql0369-select-if-nothing-construct-is-for-use-in-top-level-expressions-not-inside-of-other-dml">CQL0369:
(SELECT … IF NOTHING) construct is for use in top level expressions, not
inside of other DML</a></li>
<li><a
href="#cql0370-due-to-a-memory-leak-bug-in-old-sqlite-versions-the-select-part-of-an-insert-must-not-have-a-top-level-join-or-compound-operator.-use-with-and-a-cte-or-a-nested-select-to-work-around-this."
id="toc-cql0370-due-to-a-memory-leak-bug-in-old-sqlite-versions-the-select-part-of-an-insert-must-not-have-a-top-level-join-or-compound-operator.-use-with-and-a-cte-or-a-nested-select-to-work-around-this.">CQL0370:
due to a memory leak bug in old SQLite versions, the select part of an
insert must not have a top level join or compound operator. Use WITH and
a CTE, or a nested select to work around this.</a></li>
<li><a
href="#cql0371-table-valued-function-used-in-a-leftrightcross-context-this-would-hit-a-sqlite-bug.-wrap-it-in-a-cte-instead."
id="toc-cql0371-table-valued-function-used-in-a-leftrightcross-context-this-would-hit-a-sqlite-bug.-wrap-it-in-a-cte-instead.">CQL0371:
table valued function used in a left/right/cross context; this would hit
a SQLite bug. Wrap it in a CTE instead.</a></li>
<li><a
href="#cql0372-select-if-nothing-or-null-null-is-redundant-use-select-if-nothing-null-instead."
id="toc-cql0372-select-if-nothing-or-null-null-is-redundant-use-select-if-nothing-null-instead.">CQL0372:
SELECT … IF NOTHING OR NULL NULL is redundant; use SELECT … IF NOTHING
NULL instead.</a></li>
<li><a
href="#cql0373-comparing-against-null-always-yields-null-use-is-and-is-not-instead."
id="toc-cql0373-comparing-against-null-always-yields-null-use-is-and-is-not-instead.">CQL0373:
comparing against NULL always yields NULL; use IS and IS NOT
instead.</a></li>
<li><a href="#cql0374-select-expression-is-equivalent-to-null."
id="toc-cql0374-select-expression-is-equivalent-to-null.">CQL0374:
SELECT expression is equivalent to NULL.</a></li>
<li><a
href="#cql0377-table-transitioning-from-recreate-to-create-must-use-createnncqlfrom_recreate-table-name"
id="toc-cql0377-table-transitioning-from-recreate-to-create-must-use-createnncqlfrom_recreate-table-name">CQL0377:
table transitioning from <code>@recreate</code> to <code>@create</code>
must use <code>@create(nn,cql:from_recreate)</code> ‘table
name’</a></li>
<li><a
href="#cql0378-built-in-migration-procedure-not-valid-in-this-context-name"
id="toc-cql0378-built-in-migration-procedure-not-valid-in-this-context-name">CQL0378:
built-in migration procedure not valid in this context ‘name’</a></li>
<li><a href="#cql0379-unknown-built-in-migration-procedure-name"
id="toc-cql0379-unknown-built-in-migration-procedure-name">CQL0379:
unknown built-in migration procedure ‘name’</a></li>
<li><a href="#cql0380-when-expression-cannot-be-evaluated-to-a-constant"
id="toc-cql0380-when-expression-cannot-be-evaluated-to-a-constant">CQL0380:
WHEN expression cannot be evaluated to a constant</a></li>
<li><a href="#cql0381-case-expression-must-be-a-not-null-integral-type"
id="toc-cql0381-case-expression-must-be-a-not-null-integral-type">CQL0381:
case expression must be a not-null integral type</a></li>
<li><a
href="#cql0382-type-of-a-when-expression-is-bigger-than-the-type-of-the-switch-expression"
id="toc-cql0382-type-of-a-when-expression-is-bigger-than-the-type-of-the-switch-expression">CQL0382:
type of a WHEN expression is bigger than the type of the SWITCH
expression</a></li>
<li><a href="#cql0383-switch-all-values-is-useless-with-an-else-clause"
id="toc-cql0383-switch-all-values-is-useless-with-an-else-clause">CQL0383:
switch … ALL VALUES is useless with an ELSE clause</a></li>
<li><a
href="#cql0384-switch-statement-did-not-have-any-actual-statements-in-it"
id="toc-cql0384-switch-statement-did-not-have-any-actual-statements-in-it">CQL0384:
switch statement did not have any actual statements in it</a></li>
<li><a href="#cql0385-when-clauses-contain-duplicate-values-value"
id="toc-cql0385-when-clauses-contain-duplicate-values-value">CQL0385:
WHEN clauses contain duplicate values ‘value’</a></li>
<li><a
href="#cql0386-switch-all-values-is-used-but-the-switch-expression-is-not-an-enum-type"
id="toc-cql0386-switch-all-values-is-used-but-the-switch-expression-is-not-an-enum-type">CQL0386:
SWITCH … ALL VALUES is used but the switch expression is not an enum
type</a></li>
<li><a
href="#cql0387-a-value-exists-in-the-enum-that-is-not-present-in-the-switch-enum_member"
id="toc-cql0387-a-value-exists-in-the-enum-that-is-not-present-in-the-switch-enum_member">CQL0387:
a value exists in the enum that is not present in the switch
‘enum_member’</a></li>
<li><a
href="#cql0388-a-value-exists-in-the-switch-that-is-not-present-in-the-enum-numeric_value"
id="toc-cql0388-a-value-exists-in-the-switch-that-is-not-present-in-the-enum-numeric_value">CQL0388:
a value exists in the switch that is not present in the enum
‘numeric_value’</a></li>
<li><a
href="#cql0389-declare-out-requires-that-the-procedure-be-already-declared"
id="toc-cql0389-declare-out-requires-that-the-procedure-be-already-declared">CQL0389:
DECLARE OUT requires that the procedure be already declared</a></li>
<li><a
href="#cql0390-declare-out-call-used-on-a-procedure-with-no-missing-out-arguments"
id="toc-cql0390-declare-out-call-used-on-a-procedure-with-no-missing-out-arguments">CQL0390:
DECLARE OUT CALL used on a procedure with no missing OUT
arguments</a></li>
<li><a href="#cql0391-close-cannot-be-used-on-a-boxed-cursor"
id="toc-cql0391-close-cannot-be-used-on-a-boxed-cursor">CQL0391: CLOSE
cannot be used on a boxed cursor</a></li>
<li><a
href="#cql0392-when-deleting-a-virtual-table-you-must-specify-deletenn-cqlmodule_must_not_be_deleted_see_docs_for_cql0392-as-a-reminder-not-to-delete-the-module-for-this-virtual-table"
id="toc-cql0392-when-deleting-a-virtual-table-you-must-specify-deletenn-cqlmodule_must_not_be_deleted_see_docs_for_cql0392-as-a-reminder-not-to-delete-the-module-for-this-virtual-table">CQL0392:
when deleting a virtual table you must specify <span class="citation"
data-cites="delete">@delete</span>(nn,
cql:module_must_not_be_deleted_see_docs_for_CQL0392) as a reminder not
to delete the module for this virtual table</a></li>
<li><a
href="#cql0393-not-deterministic-user-function-cannot-appear-in-a-constraint-expression-function_name"
id="toc-cql0393-not-deterministic-user-function-cannot-appear-in-a-constraint-expression-function_name">CQL0393:
not deterministic user function cannot appear in a constraint expression
‘function_name’</a></li>
<li><a
href="#cql0394-nested-select-expressions-may-not-appear-inside-of-a-constraint-expression"
id="toc-cql0394-nested-select-expressions-may-not-appear-inside-of-a-constraint-expression">CQL0394:
nested select expressions may not appear inside of a constraint
expression</a></li>
<li><a
href="#cql0395-table-valued-functions-may-not-be-used-in-an-expression-context-function_name"
id="toc-cql0395-table-valued-functions-may-not-be-used-in-an-expression-context-function_name">CQL0395:
table valued functions may not be used in an expression context
‘function_name’</a></li>
<li><a
href="#cql0396-versioning-attributes-may-not-be-used-on-ddl-inside-a-procedure"
id="toc-cql0396-versioning-attributes-may-not-be-used-on-ddl-inside-a-procedure">CQL0396:
versioning attributes may not be used on DDL inside a procedure</a></li>
<li><a
href="#cql0397-object-is-an-orphan-because-its-table-is-deleted.-remove-rather-than-delete-object_name"
id="toc-cql0397-object-is-an-orphan-because-its-table-is-deleted.-remove-rather-than-delete-object_name">CQL0397:
object is an orphan because its table is deleted. Remove rather than
<span class="citation" data-cites="delete">@delete</span>
‘object_name’</a></li>
<li><a
href="#cql0398-a-compound-select-cannot-be-ordered-by-the-result-of-an-expression"
id="toc-cql0398-a-compound-select-cannot-be-ordered-by-the-result-of-an-expression">CQL0398:
a compound select cannot be ordered by the result of an
expression</a></li>
<li><a
href="#cql0399-table-must-leave-recreate-management-with-createnn-or-later-table_name"
id="toc-cql0399-table-must-leave-recreate-management-with-createnn-or-later-table_name">CQL0399:
table must leave <span class="citation"
data-cites="recreate">@recreate</span> management with <span
class="citation" data-cites="create">@create</span>(nn) or later
‘table_name’</a></li>
<li><a href="#cql0400-encode-context-column-cant-be-sensitive"
id="toc-cql0400-encode-context-column-cant-be-sensitive">CQL0400: encode
context column can’t be sensitive</a></li>
<li><a
href="#cql0401-encode-context-column-must-be-specified-if-strict-encode-context-column-mode-is-enabled"
id="toc-cql0401-encode-context-column-must-be-specified-if-strict-encode-context-column-mode-is-enabled">CQL0401:
encode context column must be specified if strict encode context column
mode is enabled</a></li>
<li><a
href="#cql0402-encode-context-column-in-vault_sensitive-attribute-must-match-the-specified-type-in-strict-mode"
id="toc-cql0402-encode-context-column-in-vault_sensitive-attribute-must-match-the-specified-type-in-strict-mode">CQL0402:
encode context column in vault_sensitive attribute must match the
specified type in strict mode</a></li>
<li><a
href="#cql0403-operator-may-not-be-used-because-it-is-not-supported-on-old-versions-of-sqlite-operator"
id="toc-cql0403-operator-may-not-be-used-because-it-is-not-supported-on-old-versions-of-sqlite-operator">CQL0403:
operator may not be used because it is not supported on old versions of
SQLite, ‘operator’</a></li>
<li><a
href="#cql0404-procedure-cannot-be-both-a-normal-procedure-and-an-unchecked-procedure-procedure_name"
id="toc-cql0404-procedure-cannot-be-both-a-normal-procedure-and-an-unchecked-procedure-procedure_name">CQL0404:
procedure cannot be both a normal procedure and an unchecked procedure,
‘procedure_name’</a></li>
<li><a
href="#cql0405-procedure-of-an-unknown-type-used-in-an-expression-procedure_name"
id="toc-cql0405-procedure-of-an-unknown-type-used-in-an-expression-procedure_name">CQL0405:
procedure of an unknown type used in an expression
‘procedure_name’</a></li>
<li><a
href="#cql0406-substr-uses-1-based-indices-the-2nd-argument-of-substr-may-not-be-zero"
id="toc-cql0406-substr-uses-1-based-indices-the-2nd-argument-of-substr-may-not-be-zero">CQL0406:
substr uses 1 based indices, the 2nd argument of substr may not be
zero”</a></li>
<li><a href="#cql0408-encode-context-column-can-be-only-specified-once"
id="toc-cql0408-encode-context-column-can-be-only-specified-once">CQL0408:
encode context column can be only specified once</a></li>
<li><a
href="#cql0409-cannot-use-is-null-or-is-not-null-on-a-value-of-a-not-null-type-nonnull_expr"
id="toc-cql0409-cannot-use-is-null-or-is-not-null-on-a-value-of-a-not-null-type-nonnull_expr">CQL0409:
cannot use IS NULL or IS NOT NULL on a value of a NOT NULL type
‘nonnull_expr’</a></li>
<li><a href="#cql0411-duplicate-flag-in-substitution-flag"
id="toc-cql0411-duplicate-flag-in-substitution-flag">CQL0411: duplicate
flag in substitution ‘flag’</a></li>
<li><a href="#cql0412-cannot-combine-flag-with-space-flag"
id="toc-cql0412-cannot-combine-flag-with-space-flag">CQL0412: cannot
combine ‘+’ flag with space flag</a></li>
<li><a
href="#cql0413-width-required-when-using-flag-in-substitution-flag"
id="toc-cql0413-width-required-when-using-flag-in-substitution-flag">CQL0413:
width required when using flag in substitution ‘flag’</a></li>
<li><a
href="#cql0414-l-length-specifier-has-no-effect-consider-ll-instead"
id="toc-cql0414-l-length-specifier-has-no-effect-consider-ll-instead">CQL0414:
‘l’ length specifier has no effect; consider ‘ll’ instead</a></li>
<li><a href="#cql0415-length-specifier-cannot-be-combined-with-flag"
id="toc-cql0415-length-specifier-cannot-be-combined-with-flag">CQL0415:
length specifier cannot be combined with ‘!’ flag</a></li>
<li><a href="#cql0416-type-specifier-not-allowed-in-cql-type_specifier"
id="toc-cql0416-type-specifier-not-allowed-in-cql-type_specifier">CQL0416:
type specifier not allowed in CQL ‘type_specifier’</a></li>
<li><a href="#cql0417-unrecognized-type-specifier-type_specifier"
id="toc-cql0417-unrecognized-type-specifier-type_specifier">CQL0417:
unrecognized type specifier ‘type_specifier’</a></li>
<li><a
href="#cql0418-type-specifier-combined-with-inappropriate-flags-type_specifier"
id="toc-cql0418-type-specifier-combined-with-inappropriate-flags-type_specifier">CQL0418:
type specifier combined with inappropriate flags
‘type_specifier’</a></li>
<li><a
href="#cql0419-type-specifier-cannot-be-combined-with-length-specifier-type_specifier"
id="toc-cql0419-type-specifier-cannot-be-combined-with-length-specifier-type_specifier">CQL0419:
type specifier cannot be combined with length specifier
‘type_specifier’</a></li>
<li><a href="#cql0420-incomplete-substitution-in-format-string"
id="toc-cql0420-incomplete-substitution-in-format-string">CQL0420:
incomplete substitution in format string</a></li>
<li><a href="#cql0421-first-argument-must-be-a-string-literal-function"
id="toc-cql0421-first-argument-must-be-a-string-literal-function">CQL0421:
first argument must be a string literal ‘function’</a></li>
<li><a
href="#cql0422-more-arguments-provided-than-expected-by-format-string-function"
id="toc-cql0422-more-arguments-provided-than-expected-by-format-string-function">CQL0422:
more arguments provided than expected by format string
‘function’</a></li>
<li><a
href="#cql0423-fewer-arguments-provided-than-expected-by-format-string-function"
id="toc-cql0423-fewer-arguments-provided-than-expected-by-format-string-function">CQL0423:
fewer arguments provided than expected by format string
‘function’</a></li>
<li><a
href="#cql0424-procedure-with-inout-parameter-used-as-function-procedure_name"
id="toc-cql0424-procedure-with-inout-parameter-used-as-function-procedure_name">CQL0424:
procedure with INOUT parameter used as function
‘procedure_name’</a></li>
<li><a
href="#cql0425-procedure-with-non-trailing-out-parameter-used-as-function-procedure_name"
id="toc-cql0425-procedure-with-non-trailing-out-parameter-used-as-function-procedure_name">CQL0425:
procedure with non-trailing OUT parameter used as function
‘procedure_name’</a></li>
<li><a
href="#cql0426-out-or-inout-argument-cannot-be-used-again-in-same-call-variable"
id="toc-cql0426-out-or-inout-argument-cannot-be-used-again-in-same-call-variable">CQL0426:
OUT or INOUT argument cannot be used again in same call
‘variable’</a></li>
<li><a
href="#cql0427-like-cte-form-may-only-be-used-inside-a-shared-fragment-at-the-top-level-i.e.-attributecqlshared_fragment-procedure_name"
id="toc-cql0427-like-cte-form-may-only-be-used-inside-a-shared-fragment-at-the-top-level-i.e.-attributecqlshared_fragment-procedure_name">CQL0427:
LIKE CTE form may only be used inside a shared fragment at the top level
i.e. <span class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment)
‘procedure_name’</a></li>
<li><a
href="#cql0428-duplicate-binding-of-table-in-callusing-clause-table_name"
id="toc-cql0428-duplicate-binding-of-table-in-callusing-clause-table_name">CQL0428:
duplicate binding of table in CALL/USING clause ‘table_name’</a></li>
<li><a
href="#cql0429-called-procedure-has-no-table-arguments-but-a-using-clause-is-present-procedure_name"
id="toc-cql0429-called-procedure-has-no-table-arguments-but-a-using-clause-is-present-procedure_name">CQL0429:
called procedure has no table arguments but a USING clause is present
‘procedure_name’</a></li>
<li><a
href="#cql0430-no-actual-table-was-provided-for-the-table-parameter-table_name"
id="toc-cql0430-no-actual-table-was-provided-for-the-table-parameter-table_name">CQL0430:
no actual table was provided for the table parameter
‘table_name’</a></li>
<li><a
href="#cql0431-an-actual-table-was-provided-for-a-table-parameter-that-does-not-exist-table_name"
id="toc-cql0431-an-actual-table-was-provided-for-a-table-parameter-that-does-not-exist-table_name">CQL0431:
an actual table was provided for a table parameter that does not exist
‘table_name’</a></li>
<li><a
href="#cql0432-table-provided-must-have-the-same-number-of-columns-as-the-table-parameter-table_name"
id="toc-cql0432-table-provided-must-have-the-same-number-of-columns-as-the-table-parameter-table_name">CQL0432:
table provided must have the same number of columns as the table
parameter ‘table_name’</a></li>
<li><a
href="#cql0433-table-argument-formal_name-requires-column-column_name-but-it-is-missing-in-provided-table-actual_name"
id="toc-cql0433-table-argument-formal_name-requires-column-column_name-but-it-is-missing-in-provided-table-actual_name">CQL0433:
table argument ‘formal_name’ requires column ‘column_name’ but it is
missing in provided table ‘actual_name’</a></li>
<li><a
href="#cql0434-shared-fragments-may-not-be-called-outside-of-a-sql-statement-procedure_name"
id="toc-cql0434-shared-fragments-may-not-be-called-outside-of-a-sql-statement-procedure_name">CQL0434:
shared fragments may not be called outside of a SQL statement
‘procedure_name’</a></li>
<li><a
href="#cql0435-must-use-qualified-form-to-avoid-ambiguity-with-alias-column"
id="toc-cql0435-must-use-qualified-form-to-avoid-ambiguity-with-alias-column">CQL0435:
must use qualified form to avoid ambiguity with alias ‘column’</a></li>
<li><a
href="#cql0436-alias-referenced-from-where-group-by-having-or-window-clause"
id="toc-cql0436-alias-referenced-from-where-group-by-having-or-window-clause">CQL0436:
alias referenced from WHERE, GROUP BY, HAVING, or WINDOW clause</a></li>
<li><a
href="#cql0437-common-table-name-shadows-previously-declared-table-or-view-name"
id="toc-cql0437-common-table-name-shadows-previously-declared-table-or-view-name">CQL0437:
common table name shadows previously declared table or view
‘name’</a></li>
<li><a href="#cql0438-variable-possibly-used-before-initialization-name"
id="toc-cql0438-variable-possibly-used-before-initialization-name">CQL0438:
variable possibly used before initialization ‘name’</a></li>
<li><a
href="#cql0439-nonnull-reference-out-parameter-possibly-not-always-initialized-name"
id="toc-cql0439-nonnull-reference-out-parameter-possibly-not-always-initialized-name">CQL0439:
nonnull reference OUT parameter possibly not always initialized
‘name’</a></li>
<li><a
href="#cql0440-fragments-may-not-have-an-empty-body-procedure_name"
id="toc-cql0440-fragments-may-not-have-an-empty-body-procedure_name">CQL0440:
fragments may not have an empty body ‘procedure_name’</a></li>
<li><a
href="#cql0441-shared-fragments-may-only-have-if-select-or-withselect-at-the-top-level-procedure_name"
id="toc-cql0441-shared-fragments-may-only-have-if-select-or-withselect-at-the-top-level-procedure_name">CQL0441:
shared fragments may only have IF, SELECT, or WITH…SELECT at the top
level ‘procedure_name’</a></li>
<li><a
href="#cql0442-shared-fragments-with-conditionals-must-include-an-else-clause-procedure_name"
id="toc-cql0442-shared-fragments-with-conditionals-must-include-an-else-clause-procedure_name">CQL0442:
shared fragments with conditionals must include an else clause
‘procedure_name’</a></li>
<li><a
href="#cql0443-shared-fragments-with-conditionals-must-have-exactly-one-select-or-withselect-in-each-statement-list-procedure_name"
id="toc-cql0443-shared-fragments-with-conditionals-must-have-exactly-one-select-or-withselect-in-each-statement-list-procedure_name">CQL0443:
shared fragments with conditionals must have exactly one SELECT or
WITH…SELECT in each statement list ‘procedure_name’</a></li>
<li><a
href="#cql0444-this-use-of-the-named-shared-fragment-is-not-legal-because-of-name-conflict-procedure_name"
id="toc-cql0444-this-use-of-the-named-shared-fragment-is-not-legal-because-of-name-conflict-procedure_name">CQL0444:
this use of the named shared fragment is not legal because of name
conflict ‘procedure_name’</a></li>
<li><a href="#cql0445-attributecqltry_is_proc_body-accepts-no-values"
id="toc-cql0445-attributecqltry_is_proc_body-accepts-no-values">CQL0445:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:try_is_proc_body) accepts
no values</a></li>
<li><a
href="#cql0446-attributecqltry_is_proc_body-cannot-be-used-more-than-once-per-procedure"
id="toc-cql0446-attributecqltry_is_proc_body-cannot-be-used-more-than-once-per-procedure">CQL0446:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:try_is_proc_body) cannot be
used more than once per procedure</a></li>
<li><a
href="#cql0447-virtual-table-table-claims-to-be-eponymous-but-its-module-name-module-differs-from-its-table-name"
id="toc-cql0447-virtual-table-table-claims-to-be-eponymous-but-its-module-name-module-differs-from-its-table-name">CQL0447:
virtual table ‘table’ claims to be eponymous but its module name
‘module’ differs from its table name</a></li>
<li><a
href="#cql0448-table-was-marked-delete-but-it-needs-to-be-marked-recreate-delete-table"
id="toc-cql0448-table-was-marked-delete-but-it-needs-to-be-marked-recreate-delete-table">CQL0448:
table was marked <span class="citation"
data-cites="delete">@delete</span> but it needs to be marked <span
class="citation" data-cites="recreate">@recreate</span> <span
class="citation" data-cites="delete">@delete</span> ‘table’</a></li>
<li><a
href="#cql0449-unsubscribe-does-not-make-sense-on-non-physical-tables-table_name"
id="toc-cql0449-unsubscribe-does-not-make-sense-on-non-physical-tables-table_name">CQL0449:
unsubscribe does not make sense on non-physical tables
‘table_name’</a></li>
<li><a
href="#cql0450-a-shared-fragment-used-like-a-function-must-be-a-simple-select-with-no-from-clause"
id="toc-cql0450-a-shared-fragment-used-like-a-function-must-be-a-simple-select-with-no-from-clause">CQL0450:
a shared fragment used like a function must be a simple SELECT with no
FROM clause</a></li>
<li><a
href="#cql0451-procedure-as-function-call-is-not-compatible-with-distinct-or-filter-clauses"
id="toc-cql0451-procedure-as-function-call-is-not-compatible-with-distinct-or-filter-clauses">CQL0451:
procedure as function call is not compatible with DISTINCT or filter
clauses</a></li>
<li><a
href="#cql0452-function-may-not-be-used-in-sql-because-it-is-not-supported-on-old-versions-of-sqlite-function"
id="toc-cql0452-function-may-not-be-used-in-sql-because-it-is-not-supported-on-old-versions-of-sqlite-function">CQL0452:
function may not be used in SQL because it is not supported on old
versions of SQLite ‘function’</a></li>
<li><a href="#cql0453-blob-type-is-not-a-valid-table-table_name"
id="toc-cql0453-blob-type-is-not-a-valid-table-table_name">CQL0453: blob
type is not a valid table ‘table_name’</a></li>
<li><a href="#cql0454-cursor-was-not-declared-for-storage-cursor_name"
id="toc-cql0454-cursor-was-not-declared-for-storage-cursor_name">CQL0454:
cursor was not declared for storage ‘cursor_name’</a></li>
<li><a
href="#cql0455-blob-variable-must-have-a-type-kind-for-type-safety-blob_name"
id="toc-cql0455-blob-variable-must-have-a-type-kind-for-type-safety-blob_name">CQL0455:
blob variable must have a type kind for type safety,
‘blob_name’</a></li>
<li><a href="#cql0456-blob-type-is-a-view-not-a-table-view_name"
id="toc-cql0456-blob-type-is-a-view-not-a-table-view_name">CQL0456: blob
type is a view, not a table ‘view_name’</a></li>
<li><a
href="#cql0457-the-indicated-table-is-not-marked-with-attributecqlblob_storage-table_name"
id="toc-cql0457-the-indicated-table-is-not-marked-with-attributecqlblob_storage-table_name">CQL0457:
the indicated table is not marked with <span class="citation"
data-cites="attribute">@attribute</span>(cql:blob_storage)
‘table_name’</a></li>
<li><a
href="#cql0458-the-indicated-table-may-only-be-used-for-blob-storage-table_name"
id="toc-cql0458-the-indicated-table-may-only-be-used-for-blob-storage-table_name">CQL0458:
the indicated table may only be used for blob storage
‘table_name’</a></li>
<li><a
href="#cql0459-table-is-not-suitable-for-use-as-blob-storage-reason-table_name"
id="toc-cql0459-table-is-not-suitable-for-use-as-blob-storage-reason-table_name">CQL0459:
table is not suitable for use as blob storage: [reason]
‘table_name’</a></li>
<li><a
href="#cql0460-field-of-a-nonnull-reference-type-accessed-before-verifying-that-the-cursor-has-a-row-cursor.field"
id="toc-cql0460-field-of-a-nonnull-reference-type-accessed-before-verifying-that-the-cursor-has-a-row-cursor.field">CQL0460:
field of a nonnull reference type accessed before verifying that the
cursor has a row ‘cursor.field’</a></li>
<li><a href="#cql0461-fetch-from-blob-operand-is-not-a-blob"
id="toc-cql0461-fetch-from-blob-operand-is-not-a-blob">CQL0461: fetch
from blob operand is not a blob</a></li>
<li><a href="#cql0462-group-declared-variables-must-be-top-level-name"
id="toc-cql0462-group-declared-variables-must-be-top-level-name">CQL0462:
group declared variables must be top level ‘name’</a></li>
<li><a href="#cql0464-group-not-found-group_name"
id="toc-cql0464-group-not-found-group_name">CQL0464: group not found
‘group_name’</a></li>
<li><a href="#cql0465-avaiable-for-re-use"
id="toc-cql0465-avaiable-for-re-use">CQL0465 avaiable for
re-use</a></li>
<li><a
href="#cql0466-the-tableview-named-in-an-unsub-directive-does-not-exist-name"
id="toc-cql0466-the-tableview-named-in-an-unsub-directive-does-not-exist-name">CQL0466:
the table/view named in an <span class="citation"
data-cites="unsub">@unsub</span> directive does not exist
‘name’</a></li>
<li><a
href="#cql0467-a-shared-fragment-used-like-a-function-cannot-nest-fragments-that-use-arguments"
id="toc-cql0467-a-shared-fragment-used-like-a-function-cannot-nest-fragments-that-use-arguments">CQL0467:
a shared fragment used like a function cannot nest fragments that use
arguments</a></li>
<li><a
href="#cql0468-attributecqlshared_fragment-may-only-be-placed-on-a-create-proc-statement-proc_name"
id="toc-cql0468-attributecqlshared_fragment-may-only-be-placed-on-a-create-proc-statement-proc_name">CQL0468:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment) may only
be placed on a CREATE PROC statement ‘proc_name’</a></li>
<li><a href="#cql0469-tableview-is-already-deleted-name"
id="toc-cql0469-tableview-is-already-deleted-name">CQL0469: table/view
is already deleted ‘name’</a></li>
<li><a href="#cql0470-available-for-re-use"
id="toc-cql0470-available-for-re-use">CQL0470 available for
re-use</a></li>
<li><a href="#cql0471-available-for-re-use"
id="toc-cql0471-available-for-re-use">CQL0471 available for
re-use</a></li>
<li><a href="#cql0472-tableview-is-already-unsubscribed-name"
id="toc-cql0472-tableview-is-already-unsubscribed-name">CQL0472:
table/view is already unsubscribed ‘name’</a></li>
<li><a
href="#cql0473-unsub-is-invalid-because-the-tableview-is-still-used-by-name"
id="toc-cql0473-unsub-is-invalid-because-the-tableview-is-still-used-by-name">CQL0473:
<span class="citation" data-cites="unsub">@unsub</span> is invalid
because the table/view is still used by ‘name’</a></li>
<li><a href="#cql0474-available-for-re-use"
id="toc-cql0474-available-for-re-use">CQL0474 available for
re-use</a></li>
<li><a href="#cql0475-available-for-re-use"
id="toc-cql0475-available-for-re-use">CQL0475 available for
re-use</a></li>
<li><a href="#cql0476-available-for-re-use"
id="toc-cql0476-available-for-re-use">CQL0476 available for
re-use</a></li>
<li><a href="#cql0477-interface-name-conflicts-with-func-name-name"
id="toc-cql0477-interface-name-conflicts-with-func-name-name">CQL0477:
interface name conflicts with func name ‘name’</a></li>
<li><a href="#cql0478-interface-name-conflicts-with-procedure-name-name"
id="toc-cql0478-interface-name-conflicts-with-procedure-name-name">CQL0478:
interface name conflicts with procedure name ‘name’</a></li>
<li><a href="#cql0479-interface-declarations-do-not-match-name"
id="toc-cql0479-interface-declarations-do-not-match-name">CQL0479:
interface declarations do not match ‘name’</a></li>
<li><a href="#cql0480-declared-interface-must-be-top-level-name"
id="toc-cql0480-declared-interface-must-be-top-level-name">CQL0480:
declared interface must be top level ‘name’</a></li>
<li><a href="#cql0481-proc-name-conflicts-with-interface-name-name"
id="toc-cql0481-proc-name-conflicts-with-interface-name-name">CQL0481:
proc name conflicts with interface name ‘name’</a></li>
<li><a href="#cql0482-interface-not-found-name"
id="toc-cql0482-interface-not-found-name">CQL0482: interface not found
‘name’</a></li>
<li><a
href="#cql0483-table-is-not-suitable-for-use-as-backing-storage-reason-table_name"
id="toc-cql0483-table-is-not-suitable-for-use-as-backing-storage-reason-table_name">CQL0483:
table is not suitable for use as backing storage: [reason]
‘table_name’</a></li>
<li><a href="#cql0484-procedure-s-is-missing-column-s-of-interface-s"
id="toc-cql0484-procedure-s-is-missing-column-s-of-interface-s">CQL0484:
procedure ‘%s’ is missing column ‘%s’ of interface ‘%s’</a></li>
<li><a
href="#cql0485-column-types-returned-by-proc-need-to-be-the-same-as-defined-on-the-interface"
id="toc-cql0485-column-types-returned-by-proc-need-to-be-the-same-as-defined-on-the-interface">CQL0485:
column types returned by proc need to be the same as defined on the
interface</a></li>
<li><a
href="#cql0486-function-cannot-be-both-a-normal-function-and-an-unchecked-function-function_name"
id="toc-cql0486-function-cannot-be-both-a-normal-function-and-an-unchecked-function-function_name">CQL0486:
function cannot be both a normal function and an unchecked function,
‘function_name’</a></li>
<li><a
href="#cql0487-table-is-not-suitable-as-backed-storage-reason-table_name"
id="toc-cql0487-table-is-not-suitable-as-backed-storage-reason-table_name">CQL0487:
table is not suitable as backed storage: [reason] ‘table_name’</a></li>
<li><a
href="#cql0488-the-indicated-table-is-not-declared-for-backed-storage-table_name"
id="toc-cql0488-the-indicated-table-is-not-declared-for-backed-storage-table_name">CQL0488:
the indicated table is not declared for backed storage
‘table_name’</a></li>
<li><a
href="#cql0489-the-indicated-column-is-not-present-in-the-named-backed-storage-table_name.column_name"
id="toc-cql0489-the-indicated-column-is-not-present-in-the-named-backed-storage-table_name.column_name">CQL0489:
the indicated column is not present in the named backed storage
‘table_name.column_name’</a></li>
<li><a
href="#cql0490-argument-must-be-table.column-where-table-is-a-backed-table-function"
id="toc-cql0490-argument-must-be-table.column-where-table-is-a-backed-table-function">CQL0490:
argument must be table.column where table is a backed table
’function”</a></li>
<li><a
href="#cql0491-argument-1-must-be-a-table-name-that-is-a-backed-table-cql_blob_create"
id="toc-cql0491-argument-1-must-be-a-table-name-that-is-a-backed-table-cql_blob_create">CQL0491:
argument 1 must be a table name that is a backed table
‘cql_blob_create’</a></li>
<li><a href="#cql0492-available-for-use"
id="toc-cql0492-available-for-use">CQL0492 available for use</a></li>
<li><a
href="#cql0493-backed-storage-tables-may-not-be-used-in-indexestriggersdrop-table_name"
id="toc-cql0493-backed-storage-tables-may-not-be-used-in-indexestriggersdrop-table_name">CQL0493:
backed storage tables may not be used in indexes/triggers/drop
‘table_name’</a></li>
<li><a
href="#cql0494-mixing-adding-and-removing-columns-from-a-shape-name"
id="toc-cql0494-mixing-adding-and-removing-columns-from-a-shape-name">CQL0494:
mixing adding and removing columns from a shape ‘name’</a></li>
<li><a href="#cql0495-no-columns-were-selected-in-the-like-expression"
id="toc-cql0495-no-columns-were-selected-in-the-like-expression">CQL0495:
no columns were selected in the LIKE expression</a></li>
<li><a
href="#cql0496-select-nothing-may-only-appear-in-the-else-clause-of-a-shared-fragment"
id="toc-cql0496-select-nothing-may-only-appear-in-the-else-clause-of-a-shared-fragment">CQL0496:
SELECT NOTHING may only appear in the else clause of a shared
fragment</a></li>
<li><a
href="#cql0497-from-clause-not-supported-when-updating-backed-table-table_name"
id="toc-cql0497-from-clause-not-supported-when-updating-backed-table-table_name">CQL0497:
FROM clause not supported when updating backed table,
‘table_name’</a></li>
<li><a
href="#cql0498-strict-update-from-validation-requires-that-the-update-statement-not-include-a-from-clause"
id="toc-cql0498-strict-update-from-validation-requires-that-the-update-statement-not-include-a-from-clause">CQL0498:
strict UPDATE … FROM validation requires that the UPDATE statement not
include a FROM clause</a></li>
<li><a
href="#cql0499-alias_of-attribute-may-only-be-added-to-a-declare-function-statement"
id="toc-cql0499-alias_of-attribute-may-only-be-added-to-a-declare-function-statement">CQL0499:
alias_of attribute may only be added to a declare function
statement</a></li>
<li><a
href="#cql0500-alias_of-attribute-must-be-a-non-empty-string-argument"
id="toc-cql0500-alias_of-attribute-must-be-a-non-empty-string-argument">CQL0500:
alias_of attribute must be a non-empty string argument</a></li>
</ul></li>
<li><a href="#appendix-5-json-schema-grammar"
id="toc-appendix-5-json-schema-grammar">Appendix 5: JSON Schema
Grammar</a>
<ul>
<li><a href="#rules-1" id="toc-rules-1">Rules</a></li>
</ul></li>
<li><a href="#appendix-6-cql-in-20-minutes"
id="toc-appendix-6-cql-in-20-minutes">Appendix 6: CQL In 20
Minutes</a></li>
<li><a href="#appendix-7-cql-anti-patterns"
id="toc-appendix-7-cql-anti-patterns">Appendix 7: CQL Anti-patterns</a>
<ul>
<li><a href="#common-schema" id="toc-common-schema">Common
Schema</a></li>
<li><a href="#declarations" id="toc-declarations">Declarations</a></li>
<li><a href="#casts" id="toc-casts">Casts</a></li>
<li><a href="#boolean-expressions-and-casewhen"
id="toc-boolean-expressions-and-casewhen">Boolean expressions and
CASE/WHEN</a></li>
<li><a href="#case-and-cast-and-null"
id="toc-case-and-cast-and-null">CASE and CAST and NULL</a></li>
<li><a href="#filtering-out-nulls"
id="toc-filtering-out-nulls">Filtering out NULLs</a></li>
<li><a href="#not-null-boolean-expressions"
id="toc-not-null-boolean-expressions">Not null boolean
expressions</a></li>
<li><a href="#using-is-when-it-makes-sense-to-do-so"
id="toc-using-is-when-it-makes-sense-to-do-so">Using <code>IS</code>
when it makes sense to do so</a></li>
<li><a href="#left-joins-that-are-not-left-joins"
id="toc-left-joins-that-are-not-left-joins">Left joins that are not left
joins</a></li>
</ul></li>
<li><a href="#appendix-8-cql-best-practices"
id="toc-appendix-8-cql-best-practices">Appendix 8: CQL Best
Practices</a>
<ul>
<li><a href="#data-definition-language-ddl"
id="toc-data-definition-language-ddl">Data Definition Language
(DDL)</a></li>
<li><a href="#ad-hoc-migrations-1" id="toc-ad-hoc-migrations-1">Ad Hoc
Migrations</a></li>
<li><a href="#transactions" id="toc-transactions">Transactions</a></li>
<li><a href="#savepoints" id="toc-savepoints">Savepoints</a></li>
<li><a href="#compilation-options"
id="toc-compilation-options">Compilation options</a></li>
<li><a href="#previous-schema" id="toc-previous-schema">Previous
Schema</a></li>
<li><a href="#schema-regions-1" id="toc-schema-regions-1">Schema
Regions</a></li>
<li><a href="#schema-version" id="toc-schema-version">Schema
Version</a></li>
<li><a href="#c-text-echo" id="toc-c-text-echo">C Text Echo</a></li>
<li><a href="#enumerations" id="toc-enumerations">Enumerations</a></li>
<li><a href="#cursor-lifetime" id="toc-cursor-lifetime">Cursor
Lifetime</a></li>
<li><a href="#procedure-calls-and-exceptions"
id="toc-procedure-calls-and-exceptions">Procedure Calls and
Exceptions</a></li>
<li><a href="#control-flow-with-big-moves"
id="toc-control-flow-with-big-moves">Control Flow with “Big
Moves”</a></li>
<li><a href="#getting-access-to-external-code"
id="toc-getting-access-to-external-code">Getting access to external
code</a></li>
<li><a href="#regular-data-manipulation-language-dml"
id="toc-regular-data-manipulation-language-dml">Regular Data
Manipulation Language (DML)</a></li>
<li><a href="#variable-and-cursor-declarations"
id="toc-variable-and-cursor-declarations">Variable and Cursor
declarations</a></li>
<li><a href="#query-plans" id="toc-query-plans">Query Plans</a></li>
<li><a href="#fetching-data-from-a-cursor-or-from-loose-data"
id="toc-fetching-data-from-a-cursor-or-from-loose-data">Fetching Data
from a Cursor or from Loose Data</a></li>
<li><a href="#control-flow" id="toc-control-flow">Control Flow</a></li>
<li><a href="#manual-control-of-results"
id="toc-manual-control-of-results">Manual Control of Results</a></li>
<li><a href="#ctes-and-shared-fragments"
id="toc-ctes-and-shared-fragments">CTEs and Shared Fragments</a></li>
</ul></li>
<li><a href="#appendix-9-using-the-cql-amalgam"
id="toc-appendix-9-using-the-cql-amalgam">Appendix 9: Using the CQL
Amalgam</a>
<ul>
<li><a href="#building-the-amalgam"
id="toc-building-the-amalgam">Building the Amalgam</a></li>
<li><a href="#testing-the-amalgam" id="toc-testing-the-amalgam">Testing
the Amalgam</a></li>
<li><a href="#using-the-amalgam" id="toc-using-the-amalgam">Using the
Amalgam</a></li>
<li><a href="#cql-amalgam-options" id="toc-cql-amalgam-options">CQL
Amalgam Options</a></li>
<li><a href="#amalgam-lean-choices"
id="toc-amalgam-lean-choices">Amalgam LEAN choices</a></li>
<li><a href="#other-notes" id="toc-other-notes">Other Notes</a></li>
</ul></li>
<li><a href="#appendix-10-cql-working-example"
id="toc-appendix-10-cql-working-example">Appendix 10: CQL Working
Example</a>
<ul>
<li><a href="#build-steps" id="toc-build-steps">Build Steps</a></li>
<li><a href="#results" id="toc-results">Results</a></li>
</ul></li>
<li><a href="#appendix-11-production-considerations"
id="toc-appendix-11-production-considerations">Appendix 11: Production
Considerations</a>
<ul>
<li><a href="#production-considerations"
id="toc-production-considerations">Production Considerations</a></li>
</ul></li>
</ul>
</nav>
<!--- @generated -->
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-1-introduction">Chapter 1: Introduction</h2>
<p>CQL was designed as a precompiled addition to the SQLite runtime
system. SQLite lacks stored procedures, but has a rich C runtime
interface that allows you to create any kind of control flow mixed with
any SQL operations that you might need. However, SQLite’s programming
interface is both verbose and error-prone in that small changes in SQL
statements can require significant swizzling of the C code that calls
them. Additionally, many of the SQLite runtime functions have error
codes which must be strictly checked to ensure correct behavior. In
practice, it’s easy to get some or all of this wrong.</p>
<p>CQL simplifies this situation by providing a high level SQL language
not unlike the stored procedure forms that are available in
client/server SQL solutions and lowering that language to “The C you
could have written to do that job using the normal SQLite
interfaces.”</p>
<p>As a result, the C generated is generally very approachable but now
the source language does not suffer from brittleness due to query or
table changes and CQL always generates correct column indices,
nullability checks, error checks, and the other miscellany needed to use
SQLite correctly.</p>
<p>CQL is also strongly typed, whereas SQLite is very forgiving with
regard to what operations are allowed on which data. Strict type
checking is much more reasonable given CQL’s compiled programming
model.</p>
<blockquote>
<p>NOTE: CQL was created to help solve problems in the building of Meta
Platforms’s Messenger application, but this content is free from
references to Messenger. The CQL code generation here is done in the
simplest mode with the fewest runtime dependencies allowed for
illustration.</p>
</blockquote>
<h3 id="getting-started">Getting Started</h3>
<p>Before starting this tutorial, make sure you have built the
<code>cql</code> executable first in <a
href="../../docs/getting-started.md">Building CG/SQL</a></p>
<p>The “Hello World” program rendered in CQL looks like this:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- needed to allow vararg calls to C functions</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc hello()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;Hello, world\n&quot;</span>);</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This very nearly works exactly as written but we’ll need a little bit
of glue to wire it all up.</p>
<p>First, assuming you have <a
href="../../docs/getting-started#building">built</a> <code>cql</code>,
you should have the power to do this:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cql <span class="at">--in</span> hello.sql <span class="at">--cg</span> hello.h hello.c</span></code></pre></div>
<p>This will produce the C output files <code>hello.c</code> and
<code>hello.h</code> which can be readily compiled.</p>
<p>However, hello.c will not have a <code>main</code> – rather it will
have a function like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> hello<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>The declaration of this function can be found in
<code>hello.h</code>.</p>
<blockquote>
<p>NOTE: <code>hello.h</code> tries to include <code>cqlrt.h</code>. To
avoid configuring include paths for the compiler, you might keep
<code>cqlrt.h</code> in the same directory as the examples and avoid
that complication. Otherwise you must make arrangements for the compiler
to be able to find <code>cqlrt.h</code> either by adding it to an
<code>INCLUDE</code> path or by adding some <code>-I</code> options to
help the compiler find the source.</p>
</blockquote>
<p>That <code>hello</code> function is not quite adequate to get a
running program, which brings us to the next step in getting things
running. Typically you have some kind of client program that will
execute the procedures you create in CQL. Let’s create a simple one in a
file we’ll creatively name <code>main.c</code>.</p>
<p>A very simple CQL main might look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;hello.h&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>   hello<span class="op">();</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now we should be able to do the following:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cc <span class="at">-o</span> hello main.c hello.c</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./hello</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Hello,</span> world</span></code></pre></div>
<p>Congratulations, you’ve printed <code>"Hello, world"</code> with
CG/SQL!</p>
<h3 id="why-did-this-work">Why did this work?</h3>
<p>A number of things are going on even in this simple program that are
worth discussing:</p>
<ul>
<li>the procedure <code>hello</code> had no arguments, and did not use
the database
<ul>
<li>therefore its type signature when compiled will be simply
<code>void hello(void);</code> so we know how to call it</li>
<li>you can see the declaration for yourself by examining the
<code>hello.c</code> or <code>hello.h</code></li>
</ul></li>
<li>since nobody used a database we didn’t need to initialize one</li>
<li>since there are no actual uses of SQLite we didn’t need to provide
that library</li>
<li>for the same reason we didn’t need to include a reference to the CQL
runtime</li>
<li>the function <code>printf</code> was declared “no check”, so calling
it creates a regular C call using whatever arguments are provided, in
this case a string</li>
<li>the <code>printf</code> function is declared in <code>stdio.h</code>
which is pulled in by <code>cqlrt.h</code>, which appears in
<code>hello.c</code>, so it will be available to call in the generated C
code</li>
<li>CQL allows string literals with double quotes, and those literals
may have most C escape sequences in them, so the “” bit works
<ul>
<li>Normal SQL string literals (also supported) use single quotes and do
not allow, or need escape characters other than <code>''</code> to mean
one single quote</li>
</ul></li>
</ul>
<p>All of these facts put together mean that the normal, simple linkage
rules result in an executable that prints the string “Hello, world” and
then a newline.</p>
<h3 id="variables-and-arithmetic">Variables and Arithmetic</h3>
<p>Borrowing once again from examples in “The C Programming Language”,
it’s possible to do significant control flow in CQL without reference to
databases. The following program illustrates a variety of concepts:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- needed to allow vararg calls to C functions</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- print a conversion table  for temperatures from 0 to 300</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc conversions()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> fahr, celsius <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> <span class="fu">lower</span>, <span class="fu">upper</span>, step <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">lower</span> <span class="op">:=</span> <span class="dv">0</span>;   <span class="co">/* lower limit of range */</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">upper</span> <span class="op">:=</span> <span class="dv">300</span>; <span class="co">/* upper limit of range */</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> step <span class="op">:=</span> <span class="dv">20</span>;   <span class="co">/* step size */</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> fahr <span class="op">:=</span> <span class="fu">lower</span>;</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> fahr <span class="op">&lt;=</span> <span class="fu">upper</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> celsius <span class="op">:=</span> <span class="dv">5</span> <span class="op">*</span> (fahr <span class="op">-</span> <span class="dv">32</span>) <span class="op">/</span> <span class="dv">9</span>;</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> printf(<span class="ot">&quot;%d\t%d\n&quot;</span>, fahr, celsius);</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> fahr <span class="op">:=</span> fahr <span class="op">+</span> step;</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>You may notice that both the SQL style <code>--</code> line prefix
comments and the C style <code>/* */</code> forms are acceptable comment
forms. Indeed, it’s actually quite normal to pass CQL source through the
C pre-processor before giving it to the CQL compiler, thereby gaining
<code>#define</code> and <code>#include</code> as well as other
pre-processing options like token pasting in addition to the
aforementioned comment forms. More on this later.</p>
<p>Like C, in CQL all variables must be declared before they are used.
They remain in scope until the end of the procedure in which they are
declared, or they are global scoped if they are declared outside of any
procedure. The declarations announce the names and types of the local
variables. Importantly, variables stay in scope for the whole procedure
even if they are declared within a nested <code>begin</code> and
<code>end</code> block.</p>
<p>The most basic types are the scalar or “unitary” types (as they are
referred to in the compiler)</p>
<table>
<thead>
<tr class="header">
<th>type</th>
<th>aliases</th>
<th>notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>integer</code></td>
<td>int</td>
<td>a 32 bit integer</td>
</tr>
<tr class="even">
<td><code>long</code></td>
<td>long integer</td>
<td>a 64 bit integer</td>
</tr>
<tr class="odd">
<td><code>bool</code></td>
<td>boolean</td>
<td>an 8 bit integer, normalized to 0/1</td>
</tr>
<tr class="even">
<td><code>real</code></td>
<td>n/a</td>
<td>a C double</td>
</tr>
<tr class="odd">
<td><code>text</code></td>
<td>n/a</td>
<td>an immutable string reference</td>
</tr>
<tr class="even">
<td><code>blob</code></td>
<td>n/a</td>
<td>an immutable blob reference</td>
</tr>
<tr class="odd">
<td><code>object</code></td>
<td>n/a</td>
<td>an object reference</td>
</tr>
</tbody>
</table>
<blockquote>
<p>NOTE: SQLite makes no distinction between integer storage and long
integer storage, but the declarations tell CQL whether it should use the
SQLite methods for binding and reading 64-bit or 32-bit quantities when
using the variable or column so declared.</p>
</blockquote>
<p>There will be more notes on these types later, but importantly, all
keywords and names in CQL are case insensitive just like in the
underlying SQL language. Additionally all of the above may be combined
with <code>not null</code> to indicate that a <code>null</code> value
may not be stored in that variable (as in the example). When generating
the C code, the case used in the declaration becomes the canonical case
of the variable and all other cases are converted to that in the emitted
code. As a result the C remains case sensitively correct.</p>
<p>The size of the reference types is machine dependent, whatever the
local pointer size is. The non-reference types use machine independent
declarations like <code>int32_t</code> to get exactly the desired sizes
in a portable fashion.</p>
<p>All variables of a reference type are set to <code>NULL</code> when
they are declared, including those that are declared
<code>NOT NULL</code>. For this reason, all nonnull reference variables
must be initialized (i.e., assigned a value) before anything is allowed
to read from them. This is not the case for nonnull variables of a
non-reference type, however: They are automatically assigned an initial
value of 0, and thus may be read from at any point.</p>
<p>The programs execution begins with three assignments:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="fu">lower</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="fu">upper</span> <span class="op">:=</span> <span class="dv">300</span>;</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> step <span class="op">:=</span> <span class="dv">20</span>;</span></code></pre></div>
<p>This initializes the variables just like in the isomorphic C code.
Statements are seperated by semicolons, just like in C.</p>
<p>The table is then printed using a <code>while</code> loop</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> fahr <span class="op">&lt;=</span> <span class="fu">upper</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This has the usual meaning, with the statements in the
<code>begin/end</code> block being executed repeatedly until the
condition becomes false.</p>
<p>The body of a <code>begin/end</code> block such as the one in the
<code>while</code> statement can contain one or more statements.</p>
<p>The typical computation of Celsius temperature ensues with this
code:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> celsius <span class="op">:=</span> <span class="dv">5</span> <span class="op">*</span> (fahr <span class="op">-</span> <span class="dv">32</span>) <span class="op">/</span> <span class="dv">9</span>;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> printf(<span class="ot">&quot;%d\t%d\n&quot;</span>, fahr, celsius);</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> fahr <span class="op">:=</span> fahr <span class="op">+</span> step;</span></code></pre></div>
<p>This computes the celsuis and then prints it out, moving on to the
next entry in the table.</p>
<p>Importantly, the CQL compiler uses the normal SQLite order of
operations, which is NOT the C order of operations. As a result, the
compiler may need to add parentheses in the C output to get the correct
order; or it may remove some parentheses because they are not needed in
the C order even though they were in the SQL order.</p>
<p>The <code>printf</code> call operates as before, with the
<code>fahr</code> and <code>celsius</code> variables being passed on to
the C runtime library for formatting, unchanged.</p>
<blockquote>
<p>NOTE: when calling unknown foreign functions like <code>printf</code>
string literals are simply passed right through unchanged as C string
literals. No CQL string object is created.</p>
</blockquote>
<h3 id="basic-conversion-rules">Basic Conversion Rules</h3>
<p>As a rule, CQL does not perform its own conversions, leaving that
instead to the C compiler. An exception to this is that boolean
expressions are normalized to a 0 or 1 result before they are
stored.</p>
<p>However, even with no explicit conversions, there are compatibility
checks to ensure that letting the C compiler do the conversions will
result in something sensible. The following list summarizes the
essential facts/rules as they might be applied when performing a
<code>+</code> operation.</p>
<ul>
<li>the numeric types are bool, int, long, real</li>
<li>non-numeric types cannot be combined with numerics, e.g. 1 + ‘x’
always yields an error</li>
<li>any numeric type combined with itself yields the same type</li>
<li>bool combined with int yields int</li>
<li>bool or int combined with long yields long</li>
<li>bool, int, or long combined with real yields real</li>
</ul>
<h3 id="preprocessing-features">Preprocessing Features</h3>
<p>CQL does not include its own pre-processor but it is designed to
consume the output of the C pre-processor. To do this, you can either
write the output of the pre-processor to a temporary file and read it
into CQL as usual or you can set up a pipeline something like this:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cc <span class="at">-x</span> c <span class="at">-E</span> your_program.sql <span class="kw">|</span> <span class="ex">cql</span> <span class="at">--cg</span> your_program.h your_program.c</span></code></pre></div>
<p>The above causes the C compiler to invoke only the pre-processor
<code>-E</code> and to treat the input as though it were C code
<code>-x c</code> even though it is in a <code>.sql</code> file. Later
examples will assume that you have configured CQL to be used with the C
pre-processor as above.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-2-using-data">Chapter 2: Using Data</h2>
<p>The point of using CQL is to facilitate access to a SQLite database
so we’ll switch gears to a slightly more complicated setup. We’ll still
keep things fairly simple but let’s start to use some database
features.</p>
<blockquote>
<p>NOTE: it is not the intent of this tutorial to also be a primer for
the SQLite programming language which is so ably documented on
https://sqlite.org/. Please refer to that site for details on the
meaning of the SQL statements used here if you are new to SQL.</p>
</blockquote>
<h3 id="a-sample-program">A Sample Program</h3>
<p>Suppose we have the following program:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- needed to allow vararg calls to C functions</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> my_data(t text <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc hello()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data(t) <span class="kw">values</span>(<span class="ot">&quot;Hello, world\n&quot;</span>);</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> t text <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> t <span class="op">:=</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data);</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="st">&#39;%s&#39;</span>, t);</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>That looks like an interesting little baby program and it appears as
though it would once again print that most famous of salutations,
“Hello, world”.</p>
<p>Well, it doesn’t. At least, not yet. Let’s walk through the various
things that are going to go wrong as this will teach us everything we
need to know about activating CQL from some environment of your
choice.</p>
<h3 id="providing-a-suitable-database">Providing a Suitable
Database</h3>
<p>CQL is just a compiler, it doesn’t know how the code it creates will
be provisioned any more than say clang does. It creates functions with
predictable signatures so that they can be called from C just as easily
as the SQLite API itself, and using the same currency. Our new version
of <code>hello</code> now requires a database handle because it performs
database operations. Also there are now opportunities for the database
operations to fail, and so <code>hello</code> now provides a return
code.</p>
<p>A new minimal <code>main</code> program might look something like
this:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sqlite3.h&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;hello.h&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>db<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rc <span class="op">=</span> sqlite3_open<span class="op">(</span><span class="st">&quot;:memory:&quot;</span><span class="op">,</span> <span class="op">&amp;</span>db<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">/* not exactly world class error handling but that isn&#39;t the point */</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> hello<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  sqlite3_close<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If we re-run CQL and look in the <code>hello.h</code> output file
we’ll see that the declaration of the <code>hello</code> function is
now:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> CQL_WARN_UNUSED cql_code hello<span class="op">(</span>sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>This indicates that the database is used and a SQLite return code is
provided. We’re nearly there. If you attempt to build the program as
before there will be several link-time errors due to missing functions.
Typically these are resolved by providing the SQLite library to the
command line and also adding the CQL runtime. The new command line looks
something like this:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cc <span class="at">-o</span> hello main.c hello.c cqlrt.c <span class="at">-lsqlite3</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./hello</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Hello,</span> world</span></code></pre></div>
<p>The cql runtime can be anywhere you want it to be, and of course the
usual C separate compilation methods can be applied. More on that
later.</p>
<p>But actually, that program doesn’t quite work yet. If you run it,
you’ll get an error result code, not the message “Hello, world”.</p>
<p>Let’s talk about the final missing bit.</p>
<h3 id="declaring-schema">Declaring Schema</h3>
<p>In CQL a loose piece of Data Definition Language (henceforth DDL)
does not actually create or drop anything. In most CQL programs the
normal situation is that “something” has already created the database
and put some data in it. You need to tell the CQL compiler about the
schema so that it knows what the tables are and what to expect to find
in those tables. This is because typically you’re reconnecting to some
sort of existing database. So, in CQL, loose DDL simply
<em>declares</em> schema, it does not create it. To create schema you
have to put the DDL into a procedure you can run. If you do that, then
the DDL still serves a declaration, but also the schema will be created
when the procedure is executed.</p>
<p>We need to change our program a tiny bit.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- needed to allow vararg calls to C functions</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc hello()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">create</span> <span class="kw">table</span> my_data(t text <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data(t) <span class="kw">values</span>(<span class="ot">&quot;Hello, world\n&quot;</span>);</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> t text <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> t <span class="op">:=</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data);</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="st">&#39;%s&#39;</span>, t);</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">drop</span> <span class="kw">table</span> my_data;</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>If we rebuild the program, it will now behave as expected.</p>
<h3 id="explaining-the-new-hello-world">Explaining The New Hello
World</h3>
<p>Let’s go over every important line of the new program, starting from
main.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> rc <span class="op">=</span> sqlite3_open<span class="op">(</span><span class="st">&quot;:memory:&quot;</span><span class="op">,</span> <span class="op">&amp;</span>db<span class="op">);</span></span></code></pre></div>
<p>This statement gives us an empty, private, in-memory only database to
work with. This is the simplest case and it’s still very useful. The
<code>sqlite_open</code> and <code>sqlite_open_v2</code> functions can
be used to create a variety of databases per the SQLite
documentation.</p>
<p>We’ll need such a database to use our procedure, and we use it in the
call here:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>rc <span class="op">=</span> hello<span class="op">(</span>db<span class="op">);</span></span></code></pre></div>
<p>This provides a valid db handle to our procedure. Note that the
procedure doesn’t know what database it is supposed to operate on, it
expects to be handed a suitable database on a silver platter. In fact
any given proc could be used with various databases at various times.
Just like SQLite, CQL does not enforce any particular database setup; it
does what you tell it to.</p>
<p>When <code>hello</code> runs we begin with</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> my_data(t text <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>This will create the <code>my_data</code> table with a single column
<code>t</code>, of type <code>text not null</code>. That will work
because we know we’re going to call this with a fresh/empty database.
More typically you might do <code>create table if not exists ...</code>
or otherwise have a general attach/create phase or something to that
effect. We’ll dispense with that here.</p>
<p>Next we’ll run the insert statement:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> my_data(t) <span class="kw">values</span>(<span class="ot">&quot;Hello, world\n&quot;</span>);</span></code></pre></div>
<p>This will add a single row to the table. Note that we have again used
double quotes, meaning that this is a C string literal. This is highly
convenient given the escape sequences. Normally SQLite text has the
newlines directly embedded in it; that practice isn’t very compiler
friendly, hence the alternative.</p>
<p>Next we declare a local variable to hold our data:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> t text <span class="kw">not</span> <span class="kw">null</span>;</span></code></pre></div>
<p>Then, we can read back our data:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> t <span class="op">:=</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data);</span></code></pre></div>
<p>This form of database reading has very limited usability but it does
work for this case and it is illustrative. The presence of
<code>(select ...)</code> indicates to the CQL compiler that the
parenthesized expression should be given to SQLite for evaluation
according to the SQLite rules. The expression is statically checked at
compile time to ensure that it has exactly one result column. In this
case the <code>*</code> is just column <code>t</code>, and actually it
would have been clearer to use <code>t</code> directly here but then
there wouldn’t be a reason to talk about <code>*</code> and multiple
columns. At run time, the <code>select</code> query must return exactly
one row or an error code will be returned. It’s not uncommon to see
<code>(select ... limit 1)</code> to force the issue. But that still
leaves the possibility of zero rows, which would be an error. We’ll talk
about more flexible ways to read from the database later.</p>
<blockquote>
<p>You can declare a variable and assign it in one step with the
<code>LET</code> keyword, e.g.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>let t <span class="op">:=</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data);</span></code></pre></div>
<p>The code would normally be written in this way but for discussion
purposes, these examples continue to avoid <code>LET</code>.</p>
</blockquote>
<p>At this point it seems wise to bring up the unusual expression
evaluation properties of CQL. CQL is by necessity a two-headed beast. On
the one side there is a rich expression evaluation language for working
with local variables. Those expressions are compiled into C logic that
emulates the behavior of SQLite on the data. It provides complex
expression constructs such as <code>IN</code> and <code>CASE</code> but
it is ultimately evaluated by C execution. Alternately, anything that is
inside of a piece of SQL is necessarily evaluated by SQLite itself. To
make this clearer let’s change the example a little bit before we move
on.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> t <span class="op">:=</span> (<span class="kw">select</span> <span class="ot">&quot;__&quot;</span><span class="op">||</span>t<span class="op">||</span><span class="st">&#39; &#39;</span><span class="op">||</span><span class="fl">1.234</span> <span class="kw">from</span> my_data);</span></code></pre></div>
<p>This is a somewhat silly example but it illustrates some important
things:</p>
<ul>
<li>even though SQLite doesn’t support double quotes, that’s no problem
because CQL will convert the expression into single quotes with the
correct escape values as a matter of course during compilation</li>
<li>the <code>||</code> concatenation operator is evaluated by
SQLite</li>
<li>you can mix and match both kinds of string literals, they will all
be the single quote variety by the time SQLite sees them</li>
<li>the <code>||</code> operator has lots of complex formatting
conversions (such as converting real values to strings)</li>
<li>in fact the conversions are so subtle as to be impossible to emulate
in loose C code with any economy, so, like a few other operators,
<code>||</code> is only supported in the SQLite context</li>
</ul>
<p>Returning now to our code as written, we see something very
familiar:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> printf(<span class="st">&#39;%s&#39;</span>, t);</span></code></pre></div>
<p>Note that we’ve used the single quote syntax here for no good reason
other than illustration. There are no escape sequences here so either
form would do the job. Importantly, the string literal will not create a
string object as before but the text variable <code>t</code> is of
course a string reference. Before it can be used in a call to an
un-declared function it must be converted into a temporary C string.
This might require allocation in general, that allocation is
automatically managed.</p>
<p>Also, note that CQL assumes that calls to “no check” functions should
be emitted as written. In this way you can use <code>printf</code> even
though CQL knows nothing about it.</p>
<p>Lastly we have:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">table</span> my_data;</span></code></pre></div>
<p>This is not strictly necessary because the database is in memory
anyway and the program is about to exit but there it is for
illustration.</p>
<p>Now the Data Manipulation Language (i.e. insert and select here; and
henceforth DML) and the DDL might fail for various reasons. If that
happens the proc will <code>goto</code> a cleanup handler and return the
failed return code instead of running the rest of the code. Any
temporary memory allocations will be freed and any pending SQLite
statements will be finalized. More on that later when we discuss error
handling.</p>
<p>With that we have a much more complicated program that prints “Hello,
world”</p>
<h3 id="introducing-cursors">Introducing Cursors</h3>
<p>In order to read data with reasonable flexibility, we need a more
powerful construction. Let’s change our example again and start using
some database features.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc hello()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">create</span> <span class="kw">table</span> my_data(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    pos <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    txt text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">2</span>, <span class="st">&#39;World&#39;</span>);</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">0</span>, <span class="st">&#39;Hello&#39;</span>);</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">1</span>, <span class="st">&#39;There&#39;</span>);</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data <span class="kw">order</span> <span class="kw">by</span> pos;</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch C</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> printf(<span class="ot">&quot;%d: %s\n&quot;</span>, C.pos, C.txt);</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">close</span> C;</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">drop</span> <span class="kw">table</span> my_data;</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Reviewing the essential parts of the above.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> my_data(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  pos <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  txt text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The table now includes a position column to give us some ordering.
That is the primary key.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">2</span>, <span class="st">&#39;World&#39;</span>);</span></code></pre></div>
<p>The insert statements provide both columns, not in the printed order.
The insert form where the columns are not specified indicates that all
the columns will be present, in order; this is more economical to type.
CQL will generate errors at compile time if there are any missing
columns or if any of the values are not type compatible with the
indicated column.</p>
<p>The most important change is here:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data <span class="kw">order</span> <span class="kw">by</span> pos;</span></code></pre></div>
<p>We’ve created a non-scalar variable <code>C</code>, a cursor over the
indicated result set. The results will be ordered by
<code>pos</code>.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This loop will run until there are no results left (it might not run
at all if there are zero rows, that is not an error). The
<code>FETCH</code> construct allows you to specify target variables, but
if you do not do so, then a synthetic structure is automatically created
to capture the projection of the <code>select</code>. In this case the
columns are <code>pos</code> and <code>txt</code>. The automatically
created storage exactly matches the type of the columns in the select
list which could itself be tricky to calculate if the
<code>select</code> is complex. In this case the <code>select</code> is
quite simple and the columns of the result directly match the schema for
<code>my_data</code>. An integer and a string reference. Both not
null.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> printf(<span class="ot">&quot;%d: %s\n&quot;</span>, C.pos, C.txt);</span></code></pre></div>
<p>The storage for the cursor is given the same names as the columns of
the projection of the select, in this case the columns were not renamed
so <code>pos</code> and <code>txt</code> are the fields in the cursor.
Double quotes were used in the format string to get the newline in there
easily.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">close</span> C;</span></code></pre></div>
<p>The cursor is automatically released at the end of the procedure but
in this case we’d like to release it before the <code>drop table</code>
happens so there is an explicit <code>close</code>. This is frequently
elided in favor of the automatic cleanup. There is an <code>open</code>
cursor statement as well but it doesn’t do anything. It’s there because
many systems have that construct and it does balance the
<code>close</code>.</p>
<p>If you compile and run this program, you’ll get this output:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cc <span class="at">-x</span> c <span class="at">-E</span> hello.sql <span class="kw">|</span> <span class="ex">cql</span> <span class="at">--cg</span> hello.h hello.c</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cc <span class="at">-o</span> hello main.c hello.c cqlrt.c <span class="at">-lsqlite3</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./hello</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ex">0:</span> Hello</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">1:</span> There</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">2:</span> World</span></code></pre></div>
<p>So the data was inserted and then sorted.</p>
<h3 id="going-crazy">Going Crazy</h3>
<p>We’ve only scratched the surface of what SQLite can do and most DML
constructs are supported by CQL. This includes common table expressions,
and even recursive versions of the same. But remember, when it comes to
DML, the CQL compiler only has to validate the types and figure out what
the result shape will be – SQLite always does all the heavy lifting of
evaluation. All of this means with remarkably little additional code,
the example below from the SQLite documentation can be turned into a CQL
stored proc using the constructs we have defined above.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- needed to allow vararg calls to C functions</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc mandelbrot()</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- this is basically one giant select statement</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">with</span> recursive</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- x from -2.0 to +1.2</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>      xaxis(x) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">-</span><span class="fl">2.0</span> <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> x <span class="op">+</span> <span class="fl">0.05</span> <span class="kw">from</span> xaxis <span class="kw">where</span> x <span class="op">&lt;</span> <span class="fl">1.2</span>),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- y from -1.0 to +1.0</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>      yaxis(y) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">-</span><span class="fl">1.0</span> <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> y <span class="op">+</span> <span class="fl">0.1</span> <span class="kw">from</span> yaxis <span class="kw">where</span> y <span class="op">&lt;</span> <span class="fl">1.0</span>),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>      m(iter, cx, cy, x, y) <span class="kw">as</span> (</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- initial seed iteration count 0, at each of the points in the above grid</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">select</span> <span class="dv">0</span> iter, x cx, y cy, <span class="fl">0.0</span> x, <span class="fl">0.0</span> y <span class="kw">from</span> xaxis, yaxis</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">union</span> <span class="kw">all</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- the next point is always iter +1, same (x,y) and the next iteration of z^2 + c</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">select</span> iter<span class="op">+</span><span class="dv">1</span> iter, cx, cy, x<span class="op">*</span>x<span class="op">-</span>y<span class="op">*</span>y <span class="op">+</span> cx x, <span class="fl">2.0</span><span class="op">*</span>x<span class="op">*</span>y <span class="op">+</span> cy y <span class="kw">from</span> m</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- stop condition, the point has escaped OR iteration count &gt; 28</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span> (m.x<span class="op">*</span>m.x <span class="op">+</span> m.y<span class="op">*</span>m.y) <span class="op">&lt;</span> <span class="fl">4.0</span> <span class="kw">and</span> m.iter <span class="op">&lt;</span> <span class="dv">28</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>      m2(iter, cx, cy) <span class="kw">as</span> (</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>       <span class="co">-- find the last iteration for any given point to get that count</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>       <span class="kw">select</span> <span class="fu">max</span>(iter), cx, cy <span class="kw">from</span> m <span class="kw">group</span> <span class="kw">by</span> cx, cy</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>      a(t) <span class="kw">as</span> (</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- convert the iteration count to a printable character, grouping by line</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">select</span> group_concat(<span class="fu">substr</span>(<span class="ot">&quot; .+*#&quot;</span>, <span class="dv">1</span> <span class="op">+</span> <span class="fu">min</span>(iter<span class="op">/</span><span class="dv">7</span>,<span class="dv">4</span>), <span class="dv">1</span>), <span class="st">&#39;&#39;</span>)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">from</span> m2 <span class="kw">group</span> <span class="kw">by</span> cy</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- group all the lines together</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="fu">rtrim</span>(t) line <span class="kw">from</span> a;</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- slurp out the data</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch C</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> printf(<span class="ot">&quot;%s\n&quot;</span>, C.line);</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This code uses all kinds of SQLite features to produce this text:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="ex">....#</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="ex">..#*..</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="ex">..+####+.</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                            <span class="ex">.......+####....</span>   +</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                           <span class="ex">..##+*##########+.++++</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">.</span>+.##################+.</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>              <span class="ex">.............+###################+.+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>              <span class="ex">..++..#.....*#####################+.</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>             <span class="ex">...+#######++#######################.</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>          <span class="ex">....+*################################.</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a> <span class="co">#############################################...</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>          <span class="ex">....+*################################.</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>             <span class="ex">...+#######++#######################.</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>              <span class="ex">..++..#.....*#####################+.</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>              <span class="ex">.............+###################+.+</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">.</span>+.##################+.</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                           <span class="ex">..##+*##########+.++++</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                            <span class="ex">.......+####....</span>   +</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>                                 <span class="ex">..+####+.</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>                                   <span class="ex">..#*..</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="ex">....#</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="ex">+.</span></span></code></pre></div>
<p>Which probably doesn’t come up very often but it does illustrate
several things:</p>
<ul>
<li><code>WITH RECURSIVE</code> actually provides a full lambda calculus
so arbitrary computation is possible</li>
<li>You can use <code>WITH RECURSIVE</code> to create table expressions
that are sequences of numbers easily, with no reference to any real
data</li>
</ul>
<p>A working version of this code can be found in the
<code>sources/demo</code> directory of CG/SQL project. Additional demo
code is available in <a href="#appendix-10-cql-working-example">Appendix
10</a></p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-3-expressions-literals-nullability-sensitivity">Chapter
3: Expressions, Literals, Nullability, Sensitivity</h2>
<p>Until this point we’ve only discussed simple kinds of expressions as
well as variables and table columns marked with <code>NOT NULL</code>.
These are indeed the easiest types for CQL to work with as they tend to
correspond most directly to the types known to C. However, SQL provides
for many more types of expressions as well as nullable types and these
require handling in any language that purports to be like SQL.</p>
<h3 id="expression-examples">Expression Examples</h3>
<p>The usual arithmetic operators apply in CQL:</p>
<p>Example expressions (these are all true)</p>
<pre><code>(1 + 2) * 3 == 9
1 + 2 * 3 == 7
6 / 3 == 2
7 - 5 == 2
6 % 5 == 1
5 / 2.5 == 2
7 &amp; 3 == 2 | 1
1 &lt;&lt; 2 == 4</code></pre>
<p>However, before going any further it’s important to note that CQL is
inherently a two-headed beast. Expressions are either evaluated by
transpiling to C (like the predicate of an IF statement, or a variable
assignment) or by sending them to SQLIte for evaluation (like
expressions inside a <code>SELECT</code> statement or the
<code>WHERE</code> part of a <code>DELETE</code>).</p>
<p>CQL evaluation rules are designed to be as similar as possible but
some variance is inevitable because evaluation is done in two
fundamentally different ways.</p>
<h3 id="operator-precedence">Operator Precedence</h3>
<p>The operator precedence rules in CQL are as follows; the top-most
rule binds the most loosely and the bottom-most rule binds the most
tightly:</p>
<pre><code>ASSIGNMENT:     :=
LOGICAL_OR:     OR
LOGICAL_AND:    AND
LOGICAL_NOT:    NOT
EQUALITY:       = == != &lt;&gt;  IS [NOT], [NOT] IN, [NOT] LIKE,
                [NOT] MATCH, [NOT] GLOB, [NOT] BETWEEN
INEQUALITY:     &lt;  &lt;=  &gt;  &gt;=
BINARY:         &lt;&lt; &gt;&gt; &amp; |
ADDITION:       + -
MULTIPLICATION: * / %
CONCAT:         ||
COLLATE:        COLLATE
UNARY:          ~  -</code></pre>
<p>The above rules are <strong>not</strong> the same as C’s operator
precedence rules! Instead, CQL follows SQLite’s rules. Parentheses are
emitted in the C output as needed to force that order.</p>
<blockquote>
<p>NOTE: CQL emits minimal parentheses in all outputs. Different
parentheses are often needed for SQL output as opposed to C output.</p>
</blockquote>
<h3 id="order-of-evaluation">Order of Evaluation</h3>
<p>In contrast to C, CQL guarantees a left-to-right order of evaluation
for arguments. This applies both to arguments provided to the operators
mentioned in the previous section as well as arguments provided to
procedures.</p>
<h3 id="variables-columns-basic-types-and-nullability">Variables,
Columns, Basic Types and Nullability</h3>
<p>CQL needs type information for both variables in the code and columns
in the database. Like SQL, CQL allows variables to hold a NULL value and
just as in SQL the absence of <code>NOT NULL</code> implies that
<code>NULL</code> is a legal value. Consider these examples:</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- real code should use better names than this :)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> all_the_nullables(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  i1 <span class="dt">integer</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  b1 bool,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  l1 <span class="dt">long</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  r1 <span class="dt">real</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  t1 text,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  bl1 <span class="dt">blob</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> i2 <span class="dt">integer</span>;</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> b2 bool;</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> l2 <span class="dt">long</span>;</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> r2 <span class="dt">real</span>;</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> t2 text;</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> bl2 <span class="dt">blob</span>;</span></code></pre></div>
<p>ALL of <code>i1</code>, <code>i2</code>, <code>b1</code>,
<code>b2</code>, <code>l1</code>, <code>l2</code>, <code>r1</code>,
<code>r2</code>, <code>t1</code>, <code>t2</code>, and <code>bl1</code>,
<code>bl2</code> are nullable. In some sense variables and columns
declared nullable (by virtue of the missing <code>NOT NULL</code>) are
the root sources of nullability in the SQL language. That and the
<code>NULL</code> literal. Though there are other sources as we will
see.</p>
<p><code>NOT NULL</code> could be added to any of these, e.g.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- real code should use better names than this :)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> i_nn <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span></code></pre></div>
<p>In the context of computing the types of expressions, CQL is
statically typed and so it must make a decision about the type of any
expression based on the type information at hand at compile time. As a
result it handles the static type of an expression conservatively. If
the result might be null then the expression is of a nullable type and
the compiled code will include an affordance for the possibility of a
null value at runtime.</p>
<p>The generated code for nullable types is considerably less efficient
and so it should be avoided if that is reasonably possible.</p>
<h4 id="let-statement">LET Statement</h4>
<p>You can declare and initialize a variable in one step using the
<code>LET</code> form, e.g.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>LET x <span class="op">:=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>The named variable is declared to be the exact type of the expression
on the right. More on expressions in the coming sections. The right side
is often a constant in these cases but does not need to be.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>LET i <span class="op">:=</span> <span class="dv">1</span>;  <span class="co">-- integer not null</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>LET l <span class="op">:=</span> 1L;  <span class="co">-- long not null</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>LET t <span class="op">:=</span> <span class="ot">&quot;x&quot;</span>;  <span class="co">-- text not null</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>LET b <span class="op">:=</span> x <span class="kw">IS</span> y; <span class="co">-- bool not null</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>LET b <span class="op">:=</span> x <span class="op">=</span> y;  <span class="co">-- bool (maybe not null depending on x/y)</span></span></code></pre></div>
<p>The pseudo function “nullable” removes <code>not null</code> from the
type of its argument but otherwise does no computation. This can be
useful to initialize nullable types.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>LET n_i <span class="op">:=</span> nullable(<span class="dv">1</span>);  <span class="co">-- nullable integer variable initialized to 1</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>LET n_l <span class="op">:=</span> nullable(1L);  <span class="co">-- nullable long variable initialized to 1</span></span></code></pre></div>
<p>The pseudo function “sensitive” adds <code>@sensitive</code> to the
type of its argument but otherwise does no computation. This also can be
useful to initialize nullable types.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>LET s_i <span class="op">:=</span> sensitive(<span class="dv">1</span>);  <span class="co">-- sensitive nullable integer variable initialized to 1</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>LET s_l <span class="op">:=</span> sensitive(1L);  <span class="co">-- sensitive nullable long variable initialized to 1</span></span></code></pre></div>
<h4 id="the-rc-special-variable">The <code>@RC</code> special
variable</h4>
<p>CQL also has the special built-in variable <code>@RC</code> which
refers to the most recent error code returned by a SQLite operation,
e.g. 0 == <code>SQLITE_OK</code>, 1 == <code>SQLITE_ERROR</code>.
<code>@RC</code> is of type <code>integer not null</code>.
Specifically:</p>
<ul>
<li>each catch block captures the error code when it is entered into its
own local variable</li>
<li>this variable is created lazily, so it only exists if it is used
<ul>
<li>the variable is called <code>_rc_thrown_n</code> where n is the
catch block number in the procedure</li>
</ul></li>
<li>any reference to <code>@RC</code> refers to the above error variable
of the innermost catch block the <code>@RC</code> reference is in</li>
<li>if the <code>@RC</code> reference happens outside of any catch block
its value is <code>SQLITE_OK</code> (i.e. zero).</li>
</ul>
<h3 id="types-of-literals">Types of Literals</h3>
<p>There are a number of literal objects that may be expressed in CQL.
These are as follows:</p>
<h4 id="string-literals">String Literals</h4>
<ul>
<li>A double quoted string is a C style string literal
<ul>
<li>the usual simple C escape sequences are supported</li>
<li>the form for embedded hex characters is supported, however</li>
<li>the \0NNN octal form is not supported, and</li>
<li>embedded nulls in string literals (\0 or \0x00) are not supported
(you must use blobs in such cases)</li>
</ul></li>
<li>A single quoted string is a SQL style string literal
<ul>
<li>No escape sequences are supported other than <code>''</code> to
indicate a single quote character (this is just like normal SQLite)</li>
</ul></li>
<li>A sequence of single or double quoted strings separated by
whitespace such as “xx” ‘yy’ “zz” which are concatenated to make one
literal</li>
<li>The sequence <span class="citation"
data-cites="FILE">@FILE</span>(“some_string”) is a special string
literal
<ul>
<li>the value of this literal is the path of the current compiland
starting at the letters in <code>some_string</code>, or</li>
<li>the entire path of the current compiland if <code>some_string</code>
does not occur in the path</li>
<li>the purpose of the <code>@FILE</code> construct is to provide a
partial path to a file for diagnostics that is consistent even if the
file is built in various different root paths on different build
machines</li>
</ul></li>
</ul>
<h4 id="blob-literals">Blob Literals</h4>
<ul>
<li>SQLite Blob literals are supported in SQL contexts (i.e. where they
will be processed by SQLite), CQL produces an error if you attempt to
use a blob literal in a loose expression</li>
</ul>
<h4 id="numeric-literals">Numeric Literals</h4>
<ul>
<li>All numeric literals are considered to be positive; negative numbers
are actually a positive literal combined with unary minus (the negation
operator)</li>
<li>Base 10 and hexadecimal literals are supported</li>
<li>Literals with a decimal point are of type <code>REAL</code> and
stored as the C type <code>double</code></li>
<li>Literals that can fit in a signed integer without loss, and do not
end in the letter <code>L</code> are integer literals</li>
<li>Larger literals, or those ending with the letter <code>L</code> are
long integer literals.</li>
<li>Literals that begin with 0x are interpreted as hex</li>
</ul>
<p>Examples:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.3</span>            <span class="co">-- real</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  2L             <span class="co">-- long</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">123456789123</span>   <span class="co">-- long</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">123</span>            <span class="co">-- integer</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="bn">0x10</span>           <span class="co">-- hex integer</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  0x10L          <span class="co">-- hex long integer</span></span></code></pre></div>
<h4 id="the-null-literal">The NULL literal</h4>
<p>The use of <code>NULL</code> always gives a nullable result however
this literal is special in that it has no storage class.
<code>NULL</code> is neither numeric nor string itself but rather
mutates into whatever it is first combined with. For instance
<code>NULL + 1</code> results in a nullable integer. Because
<code>NULL</code> has no primitive type in some cases where type
knowledge is required you might have to use the CAST() function to cast
the NULL to a specific type such as <code>CAST(NULL as TEXT)</code>.
This construct guarantees type consistence in cases like
<code>SELECT</code> from different sources combined with
<code>UNION ALL</code></p>
<blockquote>
<p>NOTE: constructs like <code>CAST(NULL as TEXT)</code> are always
rewritten to just <code>NULL</code> before going to SQLite as the cast
is uninteresting except for the type information which SQLite doesn’t
need/use anyway.</p>
</blockquote>
<h4 id="other-considerations">Other Considerations</h4>
<p>There are no boolean literals other than the integers <code>0</code>
and <code>1</code>.</p>
<p>The C pre-processor is often combined with CQL in which case the
<code>_FILE_</code> and <code>_LINE_</code> directives may be used to
create literals; they will be preprocessed into normal literals.</p>
<p>The use of <code>_FILE_</code> can give surprising results in the
presence of build systems, hence the existence of
<code>@FILE(...)</code>.</p>
<h3 id="const-and-enumerations">Const and Enumerations</h3>
<p>It’s possible to use named constants in CQL with nothing more than
the C pre-processor features that have already appeared, however use of
#define in such a way is not entirely satisfactory. For one thing, CQL
will not know these constants exist in any way as they will be replaced
before it ever sees them. This means CQL can’t provide their values for
you in the JSON output for instance.</p>
<p>To help with this problem, CQL includes constants, note, this is not
the same as enumerated types as we’ll see later. You can now write
something like this:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> enum business_type <span class="dt">integer</span> (</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  restaurant,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  laundromat,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  corner_store <span class="op">=</span> <span class="dv">11</span><span class="op">+</span><span class="dv">3</span>  <span class="co">/* math added for demo purposes only */</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>After this enum is declared, this:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> business_type.corner_store;</span></code></pre></div>
<p>is the same as this:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="dv">14</span>;</span></code></pre></div>
<p>And that is exactly what SQLite will see, the literal
<code>14</code>.</p>
<p>You can also use the enum to define column types:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> businesses (</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>name  TEXT,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span>  business_type</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>CQL will then enforce that you use the correct enum to access those
columns. For example, this is valid:</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> businesses <span class="kw">WHERE</span> <span class="kw">type</span> <span class="op">=</span> business_type.laundromat;</span></code></pre></div>
<p>While this does not type check:</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> businesses <span class="kw">WHERE</span> <span class="kw">type</span> <span class="op">=</span> business_corp_state.delaware;</span></code></pre></div>
<p>Enumerations follow these rules:</p>
<ul>
<li>the enumeration can be any numeric type (bool, integer, long
integer, real)</li>
<li>the values of the enumeration start at 1 (i.e. if there is no
<code>= expression</code> the first item will be <code>1</code>, not
<code>0</code>)</li>
<li>if you don’t specify a value, the next value is the previous value
plus one</li>
<li>if you do specify a value it can be any constant expression and it
will be cast to the type of the enumeration (even if that is lossy)</li>
<li>the enumeration can refer to previous values in itself with no
qualification
<code>(big = 100.0, medium = big/2, small = medium/2)</code></li>
<li>the enumeration can refer to previously defined enumerations as
usual <code>(code = business_type.restaurant)</code></li>
<li>once the enumeration is defined you refer to its members in a fully
qualified fashion <code>enum_name.member_name</code> elsewhere</li>
</ul>
<p>With these forms you get some additional useful output: * the JSON
includes the enumerations and their values in their own section * you
can use the <code>@emit_enums</code> directive to put declarations like
this into the <code>.h</code> file that corresponds to the current
compiland</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> business_type <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  business_type__restaurant <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  business_type__laundromat <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  business_type__corner_store <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Note that C does not allow for floating point enumerations, so in
case of floating point values such as:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> enum floating <span class="dt">real</span> (</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  one <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  two <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  e <span class="op">=</span> <span class="fl">2.71828</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  pi <span class="op">=</span> <span class="fl">3.14159</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>you get:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">// enum floating (floating point values)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define floating__one </span><span class="fl">1.000000e+00</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define floating__two </span><span class="fl">2.000000e+00</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define floating__e </span><span class="fl">2.718280e+00</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define floating__pi </span><span class="fl">3.141590e+00</span></span></code></pre></div>
<p>In order to get useful expressions in enumeration values, constant
folding and general evaluation was added to the compiler; these
expressions work on any numeric type and the literal null. The supported
operations include:</p>
<p><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>,
<code>%</code>, <code>|</code>, <code>&amp;</code>,
<code>&lt;&lt;</code>, <code>&gt;&gt;</code>, <code>~</code>,
<code>and</code>, <code>or</code>, <code>not</code>, <code>==</code>,
<code>&lt;=</code>, <code>&gt;=</code>, <code>!=</code>,
<code>&lt;</code>, <code>&gt;</code>, the <code>cast</code> operator and
the <code>case</code> forms (including the <code>iif</code> function).
These are enough to make a lot of very interesting expressions, all of
which are evaluated at compile time.</p>
<p>Constant folding was added to allow for rich <code>enum</code>
expressions, but there is also the <code>const()</code> primitive in the
language which can appear anywhere a literal could appear. This allows
you do things like:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> something(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  x <span class="dt">integer</span> <span class="kw">default</span> const((<span class="dv">1</span><span class="op">&lt;&lt;</span><span class="dv">16</span>)|<span class="bn">0xf</span>) <span class="co">/* again the math is just for illustration */</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>const</code> form is also very useful in macros:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SOMETHING </span><span class="dt">const</span><span class="op">(</span><span class="dv">12</span><span class="op">+</span><span class="dv">3</span><span class="op">)</span></span></code></pre></div>
<p>This form ensures that the constant will be evaluated at compile
time. The <code>const</code> pseudo-function can also nest so you can
build these kinds of macros from other macros or you can build enum
values this way. Anywhere you might need literals, you can use
<code>const</code>.</p>
<h3 id="named-types">Named Types</h3>
<p>A common source of errors in stored procedures is incorrect typing in
arguments. For instance, a particular key for an entity might need to be
<code>LONG</code> or even always <code>LONG NOT NULL</code> or
<code>LONG NOT NULL @SENSITIVE</code> and the only way to do this in the
past was maybe with some <code>#define</code> thing. Otherwise you have
to diligently get the type right in all the places, and should it ever
change, again you have to visit all the places. To help with this
situation, and to make the code a little more self-describing we added
named types to the language. This is a lot like <code>typedef</code> in
the C language. They do not create different incompatible types but they
do let you name things well.</p>
<p>You can now write these sorts of forms:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> foo_id <span class="kw">type</span> <span class="dt">long</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> foo_id <span class="kw">primary</span> <span class="kw">key</span> autoincrement,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  name text</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc inserter(name_ text, <span class="kw">out</span> <span class="kw">id</span> foo_id)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>, name) <span class="kw">values</span>(<span class="kw">NULL</span>, name_);</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="kw">id</span> <span class="op">:=</span> last_insert_rowid();</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> func_return_foo_id() foo_id;</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> var foo_id;</span></code></pre></div>
<p>Additionally any enumerated type can be used as a type name. e.g.</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> enum thing <span class="dt">integer</span> (</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  thing1,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  thing2</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> thing_type <span class="kw">type</span> thing;</span></code></pre></div>
<p>Enumerations always get “not null” in addition to their base type.
Enumerations also have a unique “kind” associated, specifically the
above enum has type <code>integer&lt;thing&gt; not null</code>. The
rules for type kinds are described below.</p>
<h3 id="type-kinds">Type Kinds</h3>
<p>Any CQL type can be tagged with a “kind” for instance
<code>real</code> can become <code>real&lt;meters&gt;</code>,
<code>integer</code> can become <code>integer&lt;job_id&gt;</code>. The
idea here is that the additional tag, the “kind” can help prevent type
mistakes in arguments, in columns and in procedure calls. For
instance:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> things(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">size</span> <span class="dt">real</span><span class="op">&lt;</span>meters<span class="op">&gt;</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  duration <span class="dt">real</span><span class="op">&lt;</span>seconds<span class="op">&gt;</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc do_something(size_ <span class="dt">real</span><span class="op">&lt;</span>meters<span class="op">&gt;</span>, duration_ <span class="dt">real</span><span class="op">&lt;</span>seconds<span class="op">&gt;</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> things(<span class="kw">size</span>, duration) <span class="kw">values</span>(size_, duration_);</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In this situation you couldn’t accidentally switch the columns in
<code>do_something</code> even though both are <code>real</code>, and
indeed SQLite will only see the type <code>real</code> for both. If you
have your own variables typed <code>real&lt;size&gt;</code> and
<code>real&lt;duration&gt;</code> you can’t accidentally do:</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> do_something(duration, <span class="kw">size</span>);</span></code></pre></div>
<p>even though both are real. The type kind won’t match.</p>
<p>Importantly, an expression with no type kind is compatible with any
type kind (or none). Hence all of the below are legal.</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> generic <span class="dt">real</span>;</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> generic <span class="op">:=</span> <span class="kw">size</span>;        <span class="co">-- no kind may accept &lt;meters&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> generic <span class="op">:=</span> duration;    <span class="co">-- no kind may accept &lt;seconds&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> duration <span class="op">:=</span> generic;    <span class="co">-- no kind may be stored in &lt;seconds&gt;</span></span></code></pre></div>
<p>Only mixing types where both have a kind, and the kind is different
generates errors. This choice allows you to write procedures that (for
instance) log any <code>integer</code> or any <code>real</code>, or that
return an <code>integer</code> out of a collection.</p>
<p>These rules are applied to comparisons, assignments, column updates,
anywhere and everywhere types are checked for compatibility.</p>
<p>To get the most value out of these constructs, the authors recommend
that type kinds be used universally except when the extra compatibility
described above is needed (like low level helper functions.)</p>
<p>Importantly, type kind can be applied to object types as well,
allowing <code>object&lt;dict&gt;</code> to be distinct from
<code>object&lt;list&gt;</code>.</p>
<p>At run time the kind information is lost. But it does find it’s way
into the JSON output so external tools also get to see the kinds.</p>
<h3 id="nullability">Nullability</h3>
<h4 id="nullability-rules">Nullability Rules</h4>
<p>Nullability is tracked via CQL’s type system. To understand whether
or not an expression will be assigned a nullable type, you can follow
these rules; they will hopefully be intuitive if you are familiar with
SQL:</p>
<ul>
<li><p>The literal <code>NULL</code> is, of course, always assigned a
nullable type. All other literals are nonnull.</p></li>
<li><p>In general, the type of an expression involving an operator
(e.g., <code>+</code>, <code>==</code>, <code>!=</code>, <code>~</code>,
<code>LIKE</code>, et cetera) is nullable if any of its arguments are
nullable. For example, <code>1 + NULL</code> is assigned the type
<code>INTEGER</code>, implying nullability. <code>1 + 2</code>, however,
is assigned the type <code>INTEGER NOT NULL</code>.</p></li>
<li><p><code>IN</code> and <code>NOT IN</code> expressions are assigned
a nullable type if and only if their left argument is nullable: The
nullability of the right side is irrelevant. For example,
<code>"foo" IN (a, b)</code> will always have the type
<code>BOOL NOT   NULL</code>, whereas
<code>some_nullable IN (a, b)</code> will have the type
<code>BOOL</code>.</p></li>
</ul>
<blockquote>
<p>NOTE: In CQL, the <code>IN</code> operator behaves like a series of
equality tests (i.e., <code>==</code> tests, not <code>IS</code> tests),
and <code>NOT IN</code> behaves symmetrically. SQLite has slightly
different nullability rules for <code>IN</code> and <code>NOT IN</code>.
<em>This is the one place where CQL has different evaluation rules from
SQLite, by design.</em></p>
</blockquote>
<ul>
<li><p>The result of <code>IS</code> and <code>IS NOT</code> is always
of type <code>BOOL NOT NULL</code>, regardless of the nullability of
either argument.</p></li>
<li><p>For <code>CASE</code> expressions, the result is always of a
nullable type if no <code>ELSE</code> clause is given. If an
<code>ELSE</code> is given, the result is nullable if any of the
<code>THEN</code> or <code>ELSE</code> expressions are
nullable.</p></li>
</ul>
<blockquote>
<p>NOTE: The SQL <code>CASE</code> construct is quite powerful: Unlike
the C <code>switch</code> statement, it is actually an expression. In
this sense, it is rather more like a highly generalized ternary
<code>a ? b : c</code> operator than a C switch statement. There can be
arbitrarily many conditions specified, each with their own result, and
the conditions need not be constants; typically, they are not.</p>
</blockquote>
<ul>
<li><p><code>IFNULL</code> and <code>COALESCE</code> are assigned a
<code>NOT NULL</code> type if one or more of their arguments are of a
<code>NOT NULL</code> type.</p></li>
<li><p>In most join operations, the nullability of each column
participating in the join is preserved. However, in a
<code>LEFT OUTER</code> join, the columns on the right side of the join
are always considered nullable; in a <code>RIGHT OUTER</code> join, the
columns on the left side of the join are considered nullable.</p></li>
<li><p>As in most other languages, CQL does not perform evaluation of
value-level expressions during type checking. There is one exception to
this rule: An expression within a <code>const</code> is evaluated at
compilation time, and if its result is then known to be nonnull, it will
be given a <code>NOT NULL</code> type. For example,
<code>const(NULL or 1)</code> is given the type
<code>BOOL NOT NULL</code>, whereas merely <code>NULL or 1</code> has
the type <code>BOOL</code>.</p></li>
</ul>
<h4 id="nullability-improvements">Nullability Improvements</h4>
<p>CQL is able to “improve” the type of some expressions from a nullable
type to a <code>NOT NULL</code> type via occurrence typing, also known
as flow typing. There are three kinds of improvements that are
possible:</p>
<ul>
<li><p>Positive improvements, i.e., improvements resulting from the
knowledge that some condition containing one or more
<code>AND-</code>linked <code>IS NOT NULL</code> checks must have been
<em>true</em>:</p>
<ul>
<li><p><code>IF</code> statements:</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> c.x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span> <span class="cf">IF</span> b <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `b` is not null here</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p><code>CASE</code> expressions:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> c.x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> b <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `b` is not null here</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div></li>
<li><p><code>IIF</code> expressions:</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>IIF(a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> c.x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>., <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div></li>
<li><p><code>SELECT</code> expressions:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `t.x` and `t.y` are not null here</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> t</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> y <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span></code></pre></div></li>
</ul></li>
<li><p>Negative improvements, i.e., improvements resulting from the
knowledge that some condition containing one or more
<code>OR</code>-linked <code>IS NULL</code> checks must have been
<em>false</em>:</p>
<ul>
<li><p><code>IF</code> statements:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span> <span class="cf">IF</span> c.x <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is not null here</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p><code>IF</code> statements, guard pattern:</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">RETURN</span>;</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` is not null here</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> c.x <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  THROW;</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` and `c.x` are not null here</span></span></code></pre></div></li>
<li><p><code>CASE</code> expressions:</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> a <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> c.x <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `a` is not null here</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div></li>
<li><p><code>IIF</code> expressions:</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>IIF(a <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> c.x <span class="kw">IS</span> <span class="kw">NULL</span>,</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>. <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div></li>
</ul></li>
<li><p>Assignment improvements, i.e., improvements resulting from the
knowledge that the right side of a statement (or a portion therein)
cannot be <code>NULL</code>:</p>
<ul>
<li><p><code>SET</code> statements:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> a <span class="op">:=</span> <span class="dv">42</span>;</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` is not null here</span></span></code></pre></div></li>
</ul></li>
</ul>
<blockquote>
<p>NOTE: Assignment improvements from <code>FETCH</code> statements are
not currently supported. This may change in a future version of CQL.</p>
</blockquote>
<p>There are several ways in which improvements can cease to be in
effect:</p>
<ul>
<li><p>The scope of the improved variable or cursor field has ended:</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> c.x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` and `c.x` are not null here</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` and `c.x` are nullable here</span></span></code></pre></div></li>
<li><p>An improved variable was <code>SET</code> to a nullable
value:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is not null here</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> a <span class="op">:=</span> some_nullable;</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is nullable here</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>An improved variable was used as an <code>OUT</code> (or
<code>INOUT</code>) argument:</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is not null here</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> some_procedure_that_requires_an_out_argument(a);</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is nullable here</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>An improved variable was used as a target for a
<code>FETCH</code> statement:</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is not null here</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  FETCH c <span class="kw">INTO</span> a;</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is nullable here</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>An improved cursor field was re-fetched:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> c.x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `c.x` is not null here</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  FETCH c;</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `c.x` is nullable here</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>A procedure call was made (which removes improvements from
<em>all globals</em> because the procedure may have mutated any of them;
locals are unaffected):</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> some_global <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` and `some_global` are not null here</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> some_procedure();</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is still not null here</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `some_global` is nullable here</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
</ul>
<p>CQL is generally smart enough to understand the control flow of your
program and infer nullability appropriately; here are a handful of
examples:</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> some_condition <span class="cf">THEN</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> a <span class="op">:=</span> <span class="dv">42</span>;</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  THROW;</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` is not null here because it must have been set to 42</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- if we&#39;ve made it this far</span></span></code></pre></div>
<div class="sourceCode" id="cb77"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> some_condition <span class="cf">THEN</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> a <span class="op">:=</span> <span class="dv">42</span>;</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> a <span class="op">:=</span> <span class="dv">100</span>;</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- `a` is not null here because it was set to a value of a</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- `NOT NULL` type in all branches and the branches cover</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- all of the possible cases</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> some_condition <span class="cf">THEN</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> a <span class="op">:=</span> <span class="kw">NULL</span>;</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `a` is not null here despite the above `SET` because</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- CQL understands that, if we&#39;re here, the previous</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- branch must not have been taken</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHILE</span> some_condition</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `x` is nullable here despite `a IS NOT NULL` because</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- `a` was set to `NULL` later in the loop and thus `x`</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- will be `NULL` when the loop repeats</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    LET x <span class="op">:=</span> a;</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> a <span class="op">:=</span> <span class="kw">NULL</span>;</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<p>Here are some additional details to note regarding conditions:</p>
<ul>
<li><p>For positive improvements, the check must be exactly of the form
<code>IS NOT   NULL</code>; other checks that imply a variable or cursor
field must not be null when true have no effect:</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="op">&gt;</span> <span class="dv">42</span> <span class="cf">THEN</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is nullable here</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<blockquote>
<p>NOTE: This may change in a future version of CQL.</p>
</blockquote></li>
<li><p>For multiple positive improvements to be applied from a single
condition, they must be linked by <code>AND</code> expressions along the
outer spine of the condition; uses of <code>IS NOT NULL</code> checks
that occur as subexpressions within anything other than <code>AND</code>
have no effect:</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  (a <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> b <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OR</span> c <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="cf">THEN</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a`, `b`, and `c` are all nullable here</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>For negative improvements, the check must be exactly of the form
<code>IS NULL</code>; other checks that imply a variable or cursor field
must not be null when false have no effect:</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> equal_to_null <span class="dt">INT</span>;</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> a <span class="kw">IS</span> equal_to_null <span class="cf">THEN</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a` is nullable here</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
<li><p>For multiple negative improvements to be applied from a single
condition, they must be linked by <code>OR</code> expressions along the
outer spine of the condition; uses of <code>IS NULL</code> checks that
occur as subexpressions within anything other than <code>OR</code> have
no effect:</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  (a <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> b <span class="kw">IS</span> <span class="kw">NULL</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> c <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="cf">THEN</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- `a`, `b`, and `c` are all nullable here</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div></li>
</ul>
<h4 id="forcing-nonnull-types">Forcing Nonnull Types</h4>
<p>If possible, it is best to use the techniques described in
“Nullability Improvements” to verify that the value of a nullable type
is nonnull before using it as such.</p>
<p>Sometimes, however, you may know that a value with a nullable type
cannot be null and simply wish to use it as though it were nonnull. The
<code>ifnull_crash</code> and <code>ifnull_throw</code> “attesting”
functions convert the type of an expression to be nonnull and ensure
that the value is nonnull with a runtime check. They cannot be used in
SQLite contexts because the functions are not known to SQLite, but they
can be used in loose expressions. For example:</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC square_if_odd(a <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="kw">OUT</span> result <span class="dt">INT</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> a % <span class="dv">2</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> result <span class="op">:=</span> <span class="kw">NULL</span>;</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> result <span class="op">:=</span> a <span class="op">*</span> a;</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- `x` has type `INT`, but we know it can&#39;t be `NULL`</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>let x <span class="op">:=</span> <span class="kw">call</span> square_if_odd(<span class="dv">3</span>);</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- `y` has type `INT NOT NULL`</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>let y <span class="op">:=</span> ifnull_crash(x);</span></code></pre></div>
<p>Above, the <code>ifnull_crash</code> attesting function is used to
coerce the expression <code>x</code> to be of type
<code>INT NOT NULL</code>. If our assumptions were somehow wrong,
however—and <code>x</code> were, in fact, <code>NULL</code>—our program
would crash.</p>
<p>As an alternative to crashing, you can use <code>ifnull_throw</code>.
The following two pieces of code are equivalent:</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC y_is_not_null(x <span class="dt">INT</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  let y <span class="op">:=</span> ifnull_throw(x);</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb86"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC y_is_not_null(x <span class="dt">INT</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> y <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> x <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> y <span class="op">:=</span> x;</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    THROW;</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<h3 id="expression-types">Expression Types</h3>
<p>CQL supports a variety of expressions, nearly everything from the
SQLite world. The following are the various supported operators; they
are presented in order from the weakest binding strength to the
strongest. Note that the binding order is NOT the same as C, and in some
cases it is radically different (e.g. boolean math)</p>
<h4 id="union-and-union-all">UNION and UNION ALL</h4>
<p>These appear only in the context of <code>SELECT</code> statements.
The arms of a compound select may include <code>FROM</code>,
<code>WHERE</code>, <code>GROUP BY</code>, <code>HAVING</code>, and
<code>WINDOW</code>. If <code>ORDER BY</code> or
<code>LIMIT ... OFFSET</code> are present, these apply to the entire
UNION.</p>
<p>example:</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> A.x x <span class="kw">from</span> A <span class="kw">inner</span> <span class="kw">join</span> B <span class="kw">using</span>(z)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> <span class="kw">all</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> C.x x <span class="kw">from</span> C</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> x <span class="op">=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>The <code>WHERE</code> applies only to the second select in the
union. And each <code>SELECT</code> is evaluated before the the
<code>UNION ALL</code></p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> A.x x <span class="kw">from</span> A <span class="kw">inner</span> <span class="kw">join</span> B <span class="kw">using</span>(z)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> <span class="kw">all</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> C.x x <span class="kw">from</span> C</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> x;</span></code></pre></div>
<p>The <code>ORDER BY</code> applies to the result of the union, so any
results from the 2nd branch will sort before any results from the first
branch (because <code>x</code> is constrained in both).</p>
<h4 id="assignment">Assignment</h4>
<p>Assignment only occurs in the <code>UPDATE</code> statement or in the
<code>SET</code> statement. In both cases the left side is a simple
target and the right side is a general expression. The expression is
evaluated before the assignment.</p>
<p>example:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> x <span class="op">:=</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">3</span> <span class="kw">AND</span> <span class="dv">4</span>;  <span class="co">-- + before AND then :=</span></span></code></pre></div>
<h4 id="logical-or">Logical OR</h4>
<p>The logical <code>OR</code> operator does shortcut evaluation, much
like the C <code>||</code> operator (not to be confused with SQL’s
concatenation operator with the same lexeme).</p>
<p>The truth table for logical <code>OR</code> is as follows:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">A OR B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">NULL</td>
</tr>
<tr class="even">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
</tr>
</tbody>
</table>
<h4 id="logical-and">Logical AND</h4>
<p>The logical <code>AND</code> operator does shortcut evaluation, much
like the C <code>&amp;&amp;</code> operator, so if the left side is zero
the result is 0 and the right side is not evaluated.</p>
<p>The truth table for logical <code>AND</code> is as follows:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">A AND B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">NULL</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
<td style="text-align: center;">NULL</td>
</tr>
</tbody>
</table>
<h4 id="between-and-not-between">BETWEEN and NOT BETWEEN</h4>
<p>These are ternary operators. The general forms are:</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>  expr1 <span class="kw">BETWEEN</span> expr2 <span class="kw">AND</span> expr3</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  expr1 <span class="kw">NOT</span> <span class="kw">BETWEEN</span> expr2 <span class="kw">AND</span> expr3</span></code></pre></div>
<p>Note that there is an inherent ambiguity in the language because
<code>expr2</code> or <code>expr3</code> could be logical expressions
that include <code>AND</code>. CQL resolves this ambiguity by insisting
that <code>expr2</code> and <code>expr3</code> be “math expressions” in
the grammar. These expressions may not have ungrouped <code>AND</code>
or <code>OR</code> operators.</p>
<p>Examples::</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- oh hell no (syntax error)</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>a <span class="kw">between</span> <span class="dv">1</span> <span class="kw">and</span> <span class="dv">2</span> <span class="kw">and</span> <span class="dv">3</span>;</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- all ok</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>a <span class="kw">between</span> (<span class="dv">1</span> <span class="kw">and</span> <span class="dv">2</span>) <span class="kw">and</span> <span class="dv">3</span>;</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>a <span class="kw">between</span> <span class="dv">1</span> <span class="kw">and</span> (<span class="dv">2</span> <span class="kw">and</span> <span class="dv">3</span>);</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>a <span class="kw">between</span> <span class="dv">1</span> <span class="kw">and</span> b <span class="kw">between</span> c <span class="kw">and</span> d; <span class="co">-- binds left to right</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>a <span class="kw">between</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">2</span> <span class="kw">and</span> <span class="dv">12</span> <span class="op">/</span> <span class="dv">2</span>;</span></code></pre></div>
<h4 id="logical-not">Logical NOT</h4>
<p>The one operand of logical <code>NOT</code> must be a numeric.
<code>NOT 'x'</code> is illegal.</p>
<h4
id="non-ordering-tests-like-glob-match-regexp-in-is-is-not">Non-ordering
tests <code>!=</code>, <code>&lt;&gt;</code>, <code>=</code>,
<code>==</code>, <code>LIKE</code>, <code>GLOB</code>,
<code>MATCH</code>, <code>REGEXP</code>, <code>IN</code>,
<code>IS</code>, <code>IS NOT</code></h4>
<p>These operations do some non-ordered comparison of their two
operands.</p>
<ul>
<li><code>IS</code> and <code>IS NOT</code> never return
<code>NULL</code>, So for instance <code>X IS NOT NULL</code> gives the
natural answer. <code>x IS y</code> is true if and only if: 1. both
<code>x</code> and <code>y</code> are <code>NULL</code> or 2. if they
are equal.</li>
<li>The other operators return <code>NULL</code> if either operand is
<code>NULL</code> and otherwise perform their usual test to produce a
boolean</li>
<li><code>!=</code> and <code>&lt;&gt;</code> are equivalent as are
<code>=</code> and <code>==</code></li>
<li>strings and blobs compare equal based on their value, not their
identity (i.e. not the string/blob pointer)</li>
<li>objects compare equal based on their address, not their content
(i.e. reference equality)</li>
<li><code>MATCH</code>, <code>GLOB</code>, and <code>REGEXP</code> are
only valid in SQL contexts, <code>LIKE</code> can be used in any context
(a helper method to do <code>LIKE</code> in C is provided by SQLite, but
not the others)</li>
<li><code>MATCH</code>, <code>GLOB</code>, <code>REGEXP</code>,
<code>LIKE</code>, and <code>IN</code> may be prefixed with
<code>NOT</code> which reverses their value</li>
</ul>
<div class="sourceCode" id="cb92"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">NULL</span> <span class="kw">IS</span> <span class="kw">NULL</span>  <span class="co">-- this is true</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">NULL</span> <span class="op">==</span> <span class="kw">NULL</span>) <span class="kw">IS</span> <span class="kw">NULL</span>  <span class="co">-- this is also true because NULL == NULL is not 1, it&#39;s NULL.</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">NULL</span> <span class="op">!=</span> <span class="kw">NULL</span>) <span class="kw">IS</span> <span class="kw">NULL</span>  <span class="co">-- this is also true because NULL != NULL is not 0, it&#39;s also NULL.</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;xy&#39;</span> <span class="kw">NOT</span> <span class="kw">LIKE</span> <span class="st">&#39;z%&#39;</span>` <span class="co">-- this is true</span></span></code></pre></div>
<h4 id="ordering-comparisons">Ordering comparisons &lt;, &gt;, &lt;=,
&gt;=</h4>
<p>These operators do the usual order comparison of their two
operands.</p>
<ul>
<li>If either operand is <code>NULL</code> the result is
<code>NULL</code></li>
<li>Objects and Blobs may not be compared with these operands</li>
<li>Strings are compared based on their value (as with other
comparisons) not their address</li>
<li>Numerics are compared as usual with the usual promotion rules</li>
</ul>
<blockquote>
<p>NOTE: CQL uses <code>strcmp</code> for string comparison. In SQL
expressions the comparison happens in whatever way SQLite has been
configured. Typically general purpose string comparison should be done
with helper functions that deal with collation and other considerations.
This is a very complex topic and CQL is largely silent on it.</p>
</blockquote>
<h4 id="bitwise-operators">Bitwise operators &lt;&lt;, &gt;&gt;, &amp;,
|</h4>
<p>These are the bit-manipulation operations. Their binding strength is
VERY different than C so beware. And notably the <code>&amp;</code>
operator has the same binding strength as the <code>|</code> operator so
they bind left to right, which is utterly unlike most systems. Many
parentheses are likely to be needed to get the usual “or of ands”
patterns codified correctly. Likewise, the shift operators
<code>&lt;&lt;</code> and <code>&gt;&gt;</code> are the same strength as
<code>&amp;</code> and <code>|</code> which is very atypical.
Consider:</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>x &amp; <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">7</span>;    <span class="co">-- probably doesn&#39;t mean what you think (this is not ambiguous, it&#39;s well defined, but unlike C)</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>(x &amp; <span class="dv">1</span>) <span class="op">&lt;&lt;</span> <span class="dv">7</span>;   <span class="co">-- means the same as the above</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>x &amp; (<span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">7</span>)   <span class="co">-- probably what you intended</span></span></code></pre></div>
<p>Note that these operators only work on integer and long integer data.
If any operand is <code>NULL</code> the result is `NULL.</p>
<h4 id="addition-and-subtraction--">Addition and Subtraction +, -</h4>
<p>These operators do the typical math. Note that there are no unsigned
numerics so it’s always signed math that is happening here.</p>
<ul>
<li>operands are promoted to the “biggest” type involved as previously
described (bool -&gt; int -&gt; long -&gt; real)</li>
<li>only numeric operands are legal (no adding strings)</li>
<li>if any operand is <code>NULL</code> the result is
<code>NULL</code></li>
</ul>
<h4 id="multiplication-division-modulus">Multiplication, Division,
Modulus *, /, %</h4>
<p>These operators do the typical math. Note that there are no unsigned
numerics so it’s always signed math that is happening here.</p>
<ul>
<li>operands are promoted to the “biggest” type as previously described
(bool -&gt; int -&gt; long -&gt; real)</li>
<li>only numeric operands are legal (no multiplying strings)</li>
<li>if any operand is <code>NULL</code> the result is
<code>NULL</code></li>
</ul>
<p>EXCEPTION: the <code>%</code> operator doesn’t make sense on real
values, so real values produce an error.</p>
<h4 id="unary-operators--">Unary operators -, ~</h4>
<p>Unary negation (<code>-</code>) and bitwise invert (<code>~</code>)
are the strongest binding operators.</p>
<ul>
<li>The <code>~</code> operator only works on integer types (not text,
not real)</li>
<li>the usual promotion rules otherwise apply</li>
<li>if the operand is <code>NULL</code> the result is
<code>NULL</code></li>
</ul>
<h3 id="case-expressions">CASE Expressions</h3>
<p>The <code>case</code> expression has two major forms and provides a
great deal of flexibility in an expression. You can kind of think of it
as the C <code>?:</code> operator on steroids.</p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x <span class="op">:=</span> <span class="st">&#39;y&#39;</span>;</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="cf">case</span> x</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> <span class="st">&#39;y&#39;</span> <span class="cf">then</span> <span class="dv">1</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> <span class="st">&#39;z&#39;</span> <span class="cf">then</span> <span class="dv">2</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="dv">3</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In this form the <code>case</code> expression (<code>x</code> here)
is evaluated exactly once and then compared against each
<code>when</code> clause. Every <code>when</code> clause must be type
compatible with the <code>case</code> expression. The <code>then</code>
expression that corresponds to the matching <code>when</code> is
evaluated and becomes the result. If no <code>when</code> matches then
the <code>else</code> expression is used. If there is no
<code>else</code> and no matching <code>when</code> then the result is
<code>null</code>.</p>
<p>If that’s not general enough, there is an alternate form:</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> y <span class="op">:=</span> <span class="st">&#39;yy&#39;</span>;</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> z <span class="op">:=</span> <span class="st">&#39;z&#39;</span>;</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="cf">case</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> y <span class="op">=</span> <span class="st">&#39;y&#39;</span> <span class="cf">then</span> <span class="dv">1</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> z <span class="op">=</span> <span class="st">&#39;z&#39;</span> <span class="cf">then</span> <span class="dv">2</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="dv">3</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The second form, where there is no value before the first
<code>when</code> keyword, each <code>when</code> expression is a
separate independent boolean expression. The first one that evaluates to
true causes the corresponding <code>then</code> to be evaluated and that
becomes the result. As before, if there is no matching <code>when</code>
clause then the result is the <code>else</code> expression if present,
or <code>null</code> if there is no <code>else</code>.</p>
<p>The result types must be compatible and the best type to hold the
answer is selected with the usual promotion rules.</p>
<h4 id="select-expressions">SELECT expressions</h4>
<p>Single values can be extracted from SQLite using an inline
<code>select</code> expression. For instance:</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x_ <span class="op">:=</span> (<span class="kw">select</span> x <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>);</span></code></pre></div>
<p>The select statement in question must extract exactly one column and
the type of the expression becomes the type of the column. This form can
appear anywhere an expression can appear, though it is most commonly
used in assignments. Something like this would also be valid:</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="kw">select</span> x <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>) <span class="op">==</span> <span class="dv">3</span> <span class="cf">then</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>The select statement can of course be arbitrarily complex.</p>
<p>Note, if the select statement returns no rows this will result in the
normal error flow. In that case, the error code will be SQLITE_DONE,
which is treated like an error because in this context SQLITE_ROW is
expected as a result of the select. This is not a typical error code and
can be quite surprising to callers. If you’re seeing this failure mode
it usually means the code had no affordance for the case where there
were no rows and probably that situation should have been handled. This
is an easy mistake to make, so to avoid it, CQL also supports these more
tolerant forms:</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x_ <span class="op">:=</span> (<span class="kw">select</span> x <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> <span class="kw">nothing</span> <span class="op">-</span><span class="dv">1</span>);</span></code></pre></div>
<p>And even more generally if the schema allows for null values and
those are not desired:</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x_ <span class="op">:=</span> (<span class="kw">select</span> x <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> <span class="kw">nothing</span> <span class="kw">or</span> <span class="kw">null</span> <span class="op">-</span><span class="dv">1</span>);</span></code></pre></div>
<p>Both of these are much safer to use as only genuine errors (e.g. the
table was dropped and no longer exists) will result in the error control
flow.</p>
<p>Again note that:</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x_ <span class="op">:=</span> (<span class="kw">select</span> ifnull(x,<span class="op">-</span><span class="dv">1</span>) <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>);</span></code></pre></div>
<p>Would not avoid the SQLITE_DONE error code, because no rows returned
is not at all the same as a null value returned.</p>
<p>The <code>if nothing or null</code> form above is equivalent to the
following, but it is more economical, and probably clearer:</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x_ <span class="op">:=</span> (<span class="kw">select</span> ifnull(x,<span class="op">-</span><span class="dv">1</span>) <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> <span class="kw">nothing</span> <span class="op">-</span><span class="dv">1</span>);</span></code></pre></div>
<p>To compute the type of the overall expression, the rules are almost
the same as normal binary operators. In particular: * if the default
expression is present it must be type compatible with the select result
* the result type is the smallest type that holds both the select value
and the default expression (see normal promotion rules above) * object
types are not allowed (SQLite cannot return an object) * in
<code>(select ...)</code> the result type is not null if and only if the
select result type is not null (see select statement, many cases) * in
<code>(select ... if nothing)</code> the result type is not null if and
only if both the select result and the default expression types are not
null (normal binary rules) * in
<code>(select ... if nothing or null)</code> the result type is not null
if and only if the default expression type is not null</p>
<p>Finally, the form <code>(select ... if nothing throw)</code> is
allowed; this form is exactly the same as normal
<code>(select ...)</code> but makes the explicit that the error control
flow will happen if there is no row. Consequently this form is allowed
even if <code>@enforce_strict select if nothing</code> is in force.</p>
<h3 id="marking-data-as-sensitive">Marking Data as Sensitive</h3>
<p>CQL supports the notion of ‘sensitive’ data in a first class way. You
can think of it as very much like nullability; It largely begins by
tagging data columns with <code>@sensitive</code></p>
<p>Rather than go through the whole calculus, it’s easier to understand
by a series of examples. So let’s start with a table with some sensitive
data.</p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_sensitive(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">integer</span>,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a> name text @sensitive,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a> sens <span class="dt">integer</span> @sensitive</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The most obvious thing you might do at this point is create a stored
proc that would read data out of that table. Maybe something like
this:</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_sensitive()</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">id</span> <span class="kw">as</span> not_sensitive_1,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>        sens <span class="op">+</span> <span class="dv">1</span> sensitive_1,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        name <span class="kw">as</span> sensitive_2,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;x&#39;</span> <span class="kw">as</span> not_sensitive_2,</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>sens <span class="kw">as</span> sensitive_3,</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        sens <span class="kw">between</span> <span class="dv">1</span> <span class="kw">and</span> <span class="dv">3</span> <span class="kw">as</span> sensitive_4</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> with_sensitive;</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>So looking at that procedure we can see that it’s reading sensitive
data, so the result will have some sensitive columns in it.</p>
<ul>
<li>the “id” is not sensitive (at least not in this example)</li>
<li>sens + 1 is sensitive, math on a sensitive field leaves it
sensitive</li>
<li>name is sensitive, it began that way and is unchanged</li>
<li>‘x’ is just a string literal, it’s not sensitive</li>
<li>-sens is sensitive, that’s more math</li>
<li>and the between expression is also sensitive</li>
</ul>
<p>Generally sensitivity is “radioactive” - anything it touches becomes
sensitive. This is very important because even a simple looking
expression like <code>sens IS NOT NULL</code> must lead to a sensitive
result or the whole process would be largely useless. It has to be
basically impossible to wash away sensitivity.</p>
<p>These rules apply to normal expressions as well as expressions in the
context of SQL. Accordingly:</p>
<p>Sensitive variables can be declared:</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> sens <span class="dt">integer</span> @sensitive;</span></code></pre></div>
<p>Simple operations on the variables are sensitive</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is sensitive (and the same would be true for any other math)</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>sens <span class="op">+</span> <span class="dv">1</span>;</span></code></pre></div>
<p>The <code>IN</code> expression gives you sensitive results if
anything about it is sensitive</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- all of these are sensitive</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>sens <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>);</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">in</span> (<span class="dv">1</span>, sens);</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">select</span> <span class="kw">id</span> <span class="kw">in</span> (<span class="kw">select</span> sens <span class="kw">from</span> with_sensitive));</span></code></pre></div>
<p>Similarly sensitive constructs in <code>CASE</code> expressions
result in a sensitive output</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- not sensitive</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="dv">0</span> <span class="cf">when</span> <span class="dv">1</span> <span class="cf">then</span> <span class="dv">2</span> <span class="cf">else</span> <span class="dv">3</span> <span class="cf">end</span>;</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- all of these are sensitive</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> sens <span class="cf">when</span> <span class="dv">1</span> <span class="cf">then</span> <span class="dv">2</span> <span class="cf">else</span> <span class="dv">3</span> <span class="cf">end</span>;</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="dv">0</span> <span class="cf">when</span> sens <span class="cf">then</span> <span class="dv">2</span> <span class="cf">else</span> <span class="dv">3</span> <span class="cf">end</span>;</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="dv">0</span> <span class="cf">when</span> <span class="dv">1</span> <span class="cf">then</span> sens <span class="cf">else</span> <span class="dv">3</span> <span class="cf">end</span>;</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="dv">0</span> <span class="cf">when</span> <span class="dv">1</span> <span class="cf">then</span> <span class="dv">2</span> <span class="cf">else</span> sens <span class="cf">end</span>;</span></code></pre></div>
<p>Cast operations preserve sensitivity</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- sensitive result</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">cast</span>(sens <span class="kw">as</span> <span class="dt">INT</span>);</span></code></pre></div>
<p>Aggregate functions likewise preserve sensitivity</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- all of these are sensitive</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">AVG</span>(T1.sens) <span class="kw">from</span> with_sensitive T1;</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">MIN</span>(T1.sens) <span class="kw">from</span> with_sensitive T1;</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">MAX</span>(T1.sens) <span class="kw">from</span> with_sensitive T1;</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">SUM</span>(T1.sens) <span class="kw">from</span> with_sensitive T1;</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">COUNT</span>(T1.sens) <span class="kw">from</span> with_sensitive T1;</span></code></pre></div>
<p>There are many operators that get similar treatment such as
<code>COALESCE</code>, <code>IFNULL</code>, <code>IS</code> and
<code>IS NOT</code>.</p>
<p>Things get more interesting when we come to the <code>EXISTS</code>
operator:</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- sensitive if and only if any selected column is sensitive</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">exists</span>(<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> with_sensitive)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- sensitive because &quot;info&quot; is sensitive</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="kw">exists</span>(<span class="kw">select</span> info <span class="kw">from</span> with_sensitive)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- not sensitive because &quot;id&quot; is not sensitive</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="kw">exists</span>(<span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> with_sensitive)</span></code></pre></div>
<p>If this is making you nervous, it probably should, we need a little
more protection because of the way EXISTS is typically used. The
predicates matter, consider the following:</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- id is now sensitive because the predicate of the where clause was sensitive</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> with_sensitive <span class="kw">where</span> sens <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- this expression is now sensitive because id is sensitive in this context</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="kw">exists</span>(<span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> with_sensitive <span class="kw">where</span> sens <span class="op">=</span> <span class="dv">1</span>)</span></code></pre></div>
<p>In general: if the predicate of a <code>WHERE</code> or
<code>HAVING</code> clause is sensitive then all columns in the result
become sensitive.</p>
<p>Similarly when performing joins, if the column specified in the
<code>USING</code> clause is sensitive or the predicate of the
<code>ON</code> clause is sensitive then the result of the join is
considered to be all sensitive columns (even if the columns were not
sensitive in the schema).</p>
<p>Likewise a sensitive expression in <code>LIMIT</code> or
<code>OFFSET</code> will result in 100% sensitive columns as these can
be used in a <code>WHERE</code>-ish way. There is no reasonable defense
against using <code>LIMIT</code> and testing for the presence or absence
of a row as a way to wash away sensitivity so that is a weakness, but
the rules that are present are likely to be very helpful.</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- join with ON</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> T1.<span class="kw">id</span> <span class="kw">from</span> with_sensitive T1 <span class="kw">inner</span> <span class="kw">join</span> with_sensitive T2 <span class="kw">on</span> T1.sens <span class="op">=</span> T2.sens</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- join with USING</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> T1.<span class="kw">id</span> <span class="kw">from</span> with_sensitive T1 <span class="kw">inner</span> <span class="kw">join</span> with_sensitive T2 <span class="kw">using</span>(sens);</span></code></pre></div>
<p>All of these expression and join propagations are designed to make it
impossible to simply wash-away sensitivity with a little bit of
math.</p>
<p>Now we come to enforcement, which boils down to what assignments or
“assignment-like” operations we allow.</p>
<p>If we have these:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> sens <span class="dt">integer</span> @sensitive;</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> not_sens <span class="dt">integer</span>;</span></code></pre></div>
<p>We can use those as stand-ins for lots of expressions, but the
essential calculus goes like this:</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- assigning a sensitive to a sensitive is ok</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> sens <span class="op">:=</span> sens <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- assigning not sensitive data to a sensitive is ok</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is needed so you can (e.g.) initialize to zero</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> sens <span class="op">:=</span> not_sens;</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- not ok</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> not_sens <span class="op">:=</span> sens;</span></code></pre></div>
<p>Now these “assignments” can happen in a variety of ways:</p>
<ul>
<li>you can set an out parameter of your procedure</li>
<li>when calling a function or procedure, we require:
<ul>
<li>any IN parameters of the target be “assignable” from the value of
the argument expression</li>
<li>any OUT parameters of the target be “assignable” from the procedures
type to the argument variable</li>
<li>any IN/OUT parameters require both the above</li>
</ul></li>
</ul>
<p>Now it’s possible to write a procedure that accepts sensitive things
and returns non-sensitive things. This is fundamentally necessary
because the proc must be able return (e.g.) a success code, or encrypted
data, that is not sensitive. However, if you write the procedure in CQL
it, too, will have to follow the assignment rules and so cheating will
be quite hard. The idea here is to make it easy to handle sensitive data
well and make typical mistakes trigger errors.</p>
<p>With these rules it’s possible to compute the the type of procedure
result sets and also to enforce IN/OUT parameters. Since the signature
of procedures is conveniently generated with –generate_exports good
practices are fairly easy to follow and sensitivity checks flow well
into your programs.</p>
<p>This is a brief summary of CQL semantics for reference types – those
types that are ref counted by the runtime.</p>
<p>The three reference types are:</p>
<ul>
<li>TEXT</li>
<li>OBJECT</li>
<li>BLOB</li>
</ul>
<p>Each of these has their own macro for <code>retain</code> and
<code>release</code> though all three actually turn into the exact same
code in all the current CQL runtime implementations. In all cases the
object is expected to be promptly freed when the reference count falls
to zero.</p>
<h3 id="reference-semantics">Reference Semantics</h3>
<h4 id="stored-procedure-arguments">Stored Procedure Arguments</h4>
<ul>
<li><code>in</code> and <code>inout</code> arguments are not retained on
entry to a stored proc</li>
<li><code>out</code> arguments are assumed to contain garbage and are
nulled without retaining on entry</li>
<li>if your <code>out</code> argument doesn’t have garbage in it, then
it is up to you do <code>release</code> it before you make a call</li>
<li>When calling a proc with an <code>out</code> argument CQL will
<code>release</code> the argument variable before the call site, obeying
its own contract</li>
</ul>
<h4 id="local-variables">Local Variables</h4>
<ul>
<li>assigning to a local variable <code>retains</code> the object, and
then does a <code>release</code> on the previous object</li>
<li>this order is important; all assignments are done in this way in
case of aliasing (<code>release</code> first might accidentally free too
soon)</li>
<li>CQL calls <code>release</code> on all local variable when the method
exits</li>
</ul>
<h4 id="assigning-to-an-out-parameter-or-a-global-variable">Assigning to
an <code>out</code> parameter or a global variable</h4>
<ul>
<li><code>out</code>, <code>inout</code> parameters, and global
variables work just like local variables except that CQL does not call
<code>release</code> at the end of the procedure</li>
</ul>
<h3 id="function-return-values">Function Return Values</h3>
<p>Stored procedures do not return values, they only have
<code>out</code> arguments and those are well defined as above.
Functions however are also supported and they can have either
<code>get</code> or <code>create</code> semantics</p>
<h4 id="get-semantics">Get Semantics</h4>
<p>If you declare a function like so:</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> Getter() <span class="dt">object</span>;</span></code></pre></div>
<p>Then CQL assumes that the returned object should follow the normal
rules above, retain/release will balance by the end of the procedure for
locals and globals or <code>out</code> arguments could retain the
object</p>
<h4 id="create-semantics">Create Semantics</h4>
<p>If you declare a function like so:</p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> Getter() <span class="kw">create</span> text;</span></code></pre></div>
<p>then CQL assumes that the function created a new result which it is
now responsible for releasing. In short, the returned object is assumed
to arrive with a retain count of 1 already on it. When CQL stores this
return value it will:</p>
<ul>
<li>release the object that was present at the storage location (if
any)</li>
<li>copy the returned pointer without further retaining it this one
time</li>
</ul>
<p>As a result if you store the returned value in a local variable it
will be released when the procedure exits (as usual) or if you instead
store the result in a global or an out parameter the result will survive
to be used later.</p>
<h3 id="comparison">Comparison</h3>
<p>CQL tries to adhere to normal SQL comparison rules but with a C
twist.</p>
<h3 id="object"><code>OBJECT</code></h3>
<p>The object type has no value based comparison, so there is no
<code>&lt;</code>, <code>&gt;</code> and so forth.</p>
<p>The following table is useful. Let’s suppose there are exactly two
distinct objects ‘X’ and ‘Y’</p>
<p>true expressions: <code>X = X</code> <code>X &lt;&gt; Y</code>
<code>Y = Y</code> <code>Y &lt;&gt; X</code> <code>X IN (X, Y)</code>
<code>X NOT IN (Y)</code></p>
<p>false expressions: <code>X = Y</code> <code>X &lt;&gt; X</code>
<code>Y = X</code> <code>Y &lt;&gt; Y</code>
<code>X NOT IN (X, Y)</code></p>
<p>null expressions: <code>null = null</code>
<code>X &lt;&gt; null</code> <code>x = null</code>
<code>null &lt;&gt; null</code> <code>Y &lt;&gt; null</code>
<code>y = null</code></p>
<p><code>null = null</code> resulting in <code>null</code> is particular
surprising but consistent with the usual SQL rules. And again, as in
SQL, the <code>IS</code> operator returns true for <code>X IS Y</code>
even if both are <code>null</code>.</p>
<h3 id="text"><code>TEXT</code></h3>
<p>Text has value comparison semantics but normal string comparison is
done only with <code>strcmp</code> which is of limited value. Typically
you’ll want to either delegate the comparison to Sqlite (with
<code>(select x &lt; y)</code>) or else use a helper function with a
suitable comparison mechanism.</p>
<p>For text comparisons including equality:</p>
<p>true: if and only if both operands are not null and the comparison
matches (using strcmp) false: if and only if both operands are not null
and the comparison does not match (using strcmp) null: if and only if at
least one operand is null</p>
<p>EXAMPLE: <code>'x' &lt; 'y'</code> is true because
<code>strcmp("x", "y") &lt; 0</code></p>
<p>The <code>IS</code> and <code>IS NOT</code> operators behave
similarly to equality and inequality, but never return
<code>null</code>. If <code>X</code> is some value that doesn’t happen
to be <code>null</code> then we have the following:</p>
<p>true: <code>null is null</code> <code>X is X</code>
<code>X is not null</code> <code>null is not X</code> false:
<code>null is not null</code> <code>X is not X</code>
<code>X is null</code> <code>null  is X</code></p>
<p>The <code>IN</code> and <code>NOT IN</code> operators also work for
text using the same value comparisons as above. Additionally there are
special text comparison operators such as <code>LIKE</code>,
<code>MATCH</code> and <code>GLOB</code>. These comparisons are defined
by SQLite.</p>
<h3 id="blob"><code>BLOB</code></h3>
<p>Blobs are compared by value (equivalent to <code>memcmp</code>) but
have no well-defined ordering. The <code>memcmp</code> order is deemed
not helpful as blobs usually have internal structure hence the valid
comparisons are only equality and inequality. You can use user defined
functions to do better comparisons of your particular blobs if
needed.</p>
<p>The net comparison behavior is otherwise just like strings.</p>
<h3 id="sample-code">Sample Code</h3>
<h4 id="out-argument-semantics">Out Argument Semantics</h4>
<div class="sourceCode" id="cb117"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> foo() <span class="dt">OBJECT</span>;</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC foo_user (<span class="kw">OUT</span> baz <span class="dt">OBJECT</span>)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> baz <span class="op">:=</span> foo();</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb118"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo_user<span class="op">(</span>cql_object_ref _Nullable <span class="op">*</span>_Nonnull baz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(</span><span class="dt">void</span> <span class="op">**)</span>baz <span class="op">=</span> NULL<span class="op">;</span> <span class="co">// set out arg to non-garbage</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  cql_set_object_ref<span class="op">(</span>baz<span class="op">,</span> foo<span class="op">());</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="function-with-create-semantics">Function with Create
Semantics</h4>
<div class="sourceCode" id="cb119"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> foo() <span class="kw">CREATE</span> <span class="dt">OBJECT</span>;</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> foo_user (INOUT baz <span class="dt">OBJECT</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> x <span class="dt">OBJECT</span>;</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> x <span class="op">:=</span> foo();</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> baz <span class="op">:=</span> foo();</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb120"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo_user<span class="op">(</span>cql_object_ref _Nullable <span class="op">*</span>_Nonnull baz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  cql_object_ref x <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  cql_object_release<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> foo<span class="op">();</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  cql_object_release<span class="op">(*</span>baz<span class="op">);</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>baz <span class="op">=</span> foo<span class="op">();</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>cql_cleanup<span class="op">:</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  cql_object_release<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="function-with-get-semantics">Function with Get Semantics</h4>
<div class="sourceCode" id="cb121"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> foo() <span class="dt">OBJECT</span>;</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> foo_user (INOUT baz <span class="dt">OBJECT</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> x <span class="dt">OBJECT</span>;</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> x <span class="op">:=</span> foo();</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> baz <span class="op">:=</span> foo();</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb122"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo_user<span class="op">(</span>cql_object_ref _Nullable <span class="op">*</span>_Nonnull baz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  cql_object_ref x <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  cql_set_object_ref<span class="op">(&amp;</span>x<span class="op">,</span> foo<span class="op">());</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  cql_set_object_ref<span class="op">(</span>baz<span class="op">,</span> foo<span class="op">());</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>cql_cleanup<span class="op">:</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  cql_object_release<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-4-procedures-functions-and-control-flow">Chapter 4:
Procedures, Functions, and Control Flow</h2>
<p>All kinds of control flow happens in the context of some procedure.
Though we’ve already introduced examples of procedures let’s now go over
some of the additional aspects we have not yet illustrated.</p>
<h3 id="out-parameters">Out Parameters</h3>
<p>Consider this procedure:</p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> echo_integer(<span class="kw">in</span> arg1 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">out</span> arg2 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> arg2 <span class="op">:=</span> arg1;</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p><code>arg1</code> has been declared <code>in</code>. This is the
default: <code>in arg1 integer not null</code> and
<code>arg1 integer not null</code> mean the exact same thing.</p>
<p><code>arg2</code>, however, has been declared <code>out</code>. When
a parameter is declared using <code>out</code>, arguments for it are
passed by reference. This is similar to by-reference arguments in other
languages; indeed, they compile into a simple pointer reference in the
generated C code.</p>
<p>Given that <code>arg2</code> is passed by reference, the statement
<code>set arg2 := arg1;</code> actually updates a variable in the
caller. For example:</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> x <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> echo_integer(<span class="dv">42</span>, x);</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- `x` is now 42</span></span></code></pre></div>
<p>It is important to note that values cannot be passed <em>into</em> a
procedure via an <code>out</code> parameter. In fact, <code>out</code>
parameters are immediately assigned a new value as soon as the procedure
is called:</p>
<ul>
<li><p>All nullable <code>out</code> parameters are set to
<code>null</code>.</p></li>
<li><p>Nonnull <code>out</code> parameters of a non-reference type
(e.g., <code>integer</code>, <code>long</code>, <code>bool</code>, et
cetera) are set to their default values (<code>0</code>,
<code>0.0</code>, <code>false</code>, et cetera).</p></li>
<li><p>Nonnull <code>out</code> parameters of a reference type (e.g.,
<code>blob</code>, <code>object</code>, and <code>text</code>) are set
to <code>null</code> as there are no default values for reference types.
They must, therefore, be assigned a value within the procedure so that
they will not be <code>null</code> when the procedure returns. CQL
enforces this.</p></li>
</ul>
<p>In addition to <code>in</code> and <code>out</code> parameters, there
are also <code>inout</code> parameters. <code>inout</code> parameters
are, as one might expect, a combination of <code>in</code> and
<code>out</code> parameters: The caller passes in a value as with
<code>in</code> parameters, but the value is passed by reference as with
<code>out</code> parameters.</p>
<p><code>inout</code> parameters allow for code such as the
following:</p>
<div class="sourceCode" id="cb125"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> times_two(inout arg <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- note that a variable in the caller is both</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- read from and written to</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> arg <span class="op">:=</span> arg <span class="op">+</span> arg;</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>let x <span class="op">:=</span> <span class="dv">2</span>;</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> times_two(x);</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- `x` is now 4</span></span></code></pre></div>
<h3 id="procedure-calls">Procedure Calls</h3>
<p>The usual <code>call</code> syntax is used to invoke a procedure. It
returns no value but it can have any number of <code>out</code>
arguments.</p>
<pre><code>  declare scratch integer not null;
  call echo_integer(12, scratch);
  scratch == 12; -- true</code></pre>
<p>Let’s go over the most essential bits of control flow.</p>
<h3 id="the-if-statement">The IF statement</h3>
<p>The CQL <code>IF</code> statement has no syntatic ambiguities at the
expense of being somewhat more verbose than many other languages. In CQL
the <code>ELSE IF</code> portion is baked into the <code>IF</code>
statement, so what you see below is logically a single statement.</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc checker(foo <span class="dt">integer</span>, <span class="kw">out</span> result <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> foo <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> result <span class="op">:=</span> <span class="dv">1</span>;</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> foo <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> result <span class="op">:=</span> <span class="dv">3</span>;</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> result <span class="op">:=</span> <span class="dv">5</span>;</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<h3 id="the-while-statement">The WHILE statement</h3>
<p>What follows is a simple procedure that counts down its input
argument.</p>
<div class="sourceCode" id="cb128"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc looper(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> x <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">call</span> printf(<span class="st">&#39;%d</span><span class="ch">\n</span><span class="st">&#39;</span>, x);</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> x <span class="op">:=</span> x <span class="op">-</span> <span class="dv">1</span>;</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The <code>WHILE</code> loop has additional keywords that can be used
within it to better control the loop. A more general loop might look
like this:</p>
<div class="sourceCode" id="cb129"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc looper(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="dv">1</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> x <span class="op">:=</span> x <span class="op">-</span> <span class="dv">1</span>;</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> x <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>     leave;</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> <span class="cf">if</span> x % <span class="dv">100</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>     <span class="kw">continue</span>;</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> <span class="cf">if</span> x % <span class="dv">10</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>     <span class="kw">call</span> printf(<span class="st">&#39;%d</span><span class="ch">\n</span><span class="st">&#39;</span>, x);</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Let’s go over this peculiar loop:</p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="dv">1</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span></code></pre></div>
<p>This is an immediate sign that there will be an unusual exit
condition. The loop will never end without one because <code>1</code>
will never be false.</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> x <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>     leave;</span></code></pre></div>
<p>Now here we’ve encoded our exit condition a bit strangely: we might
have done the equivalent job with a normal condition in the predicate
part of the <code>while</code> statement but for illustration anyway,
when x becomes negative <code>leave</code> will cause us to exit the
loop. This is like <code>break</code> in C.</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> <span class="cf">if</span> x % <span class="dv">100</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>     <span class="kw">continue</span>;</span></code></pre></div>
<p>This bit says that on every 100th iteration we go back to the start
of the loop. So the next bit will not run, which is the printing.</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> <span class="cf">if</span> x % <span class="dv">10</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>     <span class="kw">call</span> printf(<span class="st">&#39;%d</span><span class="ch">\n</span><span class="st">&#39;</span>, x);</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>Finishing up the control flow, on every 10th iteration we print the
value of the loop variable.</p>
<h3 id="the-switch-statement">The SWITCH Statement</h3>
<p>The CQL <code>SWITCH</code> is designed to map to the C
<code>switch</code> statement for better codegen and also to give us the
opportunity to do better error checking. <code>SWITCH</code> is a
<em>statement</em> like <code>IF</code> not an <em>expression</em> like
<code>CASE..WHEN..END</code> so it combines with other statements. The
general form looks like this:</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SWITCH</span> <span class="kw">switch</span><span class="op">-</span>expression [optional <span class="kw">ALL</span> <span class="kw">VALUES</span>]</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="cf">WHEN</span> expr1, expr2, <span class="op">..</span>. <span class="cf">THEN</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  [statement_list]</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="cf">WHEN</span> expr3, <span class="op">..</span>. <span class="cf">THEN</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  [statement_list]</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="cf">WHEN</span> expr4 <span class="cf">THEN</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">NOTHING</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>  [statement_list]</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<ul>
<li>the switch-expression must be a not-null integral type
(<code>integer not null</code> or
<code>long integer not null</code>)</li>
<li>the <code>WHEN</code> expressions [expr1, expr2, etc.] are made from
constant integer expressions (e.g. <code>5</code>, <code>1+7</code>,
<code>1&lt;&lt;2</code>, or <code>my_enum.thing</code>)</li>
<li>the <code>WHEN</code> expressions must be compatible with the switch
expression (long constants cannot be used if the switch expression is an
integer)</li>
<li>the values in the <code>WHEN</code> clauses must be unique (after
evaluation)</li>
<li>within one of the interior statement lists the <code>LEAVE</code>
keyword exits the <code>SWITCH</code> prematurely, just like
<code>break</code> in C
<ul>
<li>a <code>LEAVE</code> is not required before the next
<code>WHEN</code></li>
<li>there are no fall-through semantics as you can find in
<code>C</code>, if fall-through ever comes to <code>SWITCH</code> it
will be explicit</li>
</ul></li>
<li>if the keyword <code>NOTHING</code> is used after <code>THEN</code>
it means there is no code for that case, which is useful with
<code>ALL VALUES</code> (see below)</li>
<li>the <code>ELSE</code> clause is optional and works just like
<code>default</code> in <code>C</code>, covering any cases not otherwise
explicitly listed</li>
<li>if you add <code>ALL VALUES</code> then:
<ul>
<li>the expression must be an from an enum type</li>
<li>the <code>WHEN</code> values must cover every value of the enum
<ul>
<li>enum members that start with a leading <code>_</code> are by
convention considered pseudo values and do not need to be covered</li>
</ul></li>
<li>there can be no extra <code>WHEN</code> values not in the enum</li>
<li>there can be no <code>ELSE</code> clause (it would defeat the point
of listing <code>ALL VALUES</code> which is to get an error if new
values come along)</li>
</ul></li>
</ul>
<p>Some more complete examples:</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>let x <span class="op">:=</span> get_something();</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">switch</span> x</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> <span class="dv">1</span>,<span class="dv">1</span><span class="op">+</span><span class="dv">1</span> <span class="cf">then</span> <span class="co">-- constant expressions ok</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> y <span class="op">:=</span> <span class="st">&#39;small&#39;</span>;</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- other stuff</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> <span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span> <span class="cf">then</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> y <span class="op">:=</span> <span class="st">&#39;medium&#39;</span>;</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- other stuff</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> <span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span> <span class="cf">then</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> y <span class="op">:=</span> <span class="st">&#39;large&#39;</span>;</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- other stuff</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> y <span class="op">:=</span> <span class="st">&#39;zomg enormous&#39;</span>;</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> enum item <span class="dt">integer</span> (</span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>  pen <span class="op">=</span> <span class="dv">0</span>, pencil, brush,</span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>  paper, canvas,</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>  _count</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>let x <span class="op">:=</span> get_item(); <span class="co">-- returns one of the above</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a><span class="kw">switch</span> x <span class="kw">all</span> <span class="kw">values</span></span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> item.pen, item.pencil <span class="cf">then</span></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>     <span class="kw">call</span> write_something();</span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> item.brush <span class="cf">then</span> <span class="kw">nothing</span></span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- itemize brush but it needs no code</span></span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">when</span> item.paper, item.canvas <span class="cf">then</span></span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> setup_writing();</span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Using <code>THEN NOTHING</code> allows the compiler to avoid emitting
a useless <code>break</code> in the C code. Hence that choice is
better/clearer than <code>when brush then leave;</code></p>
<p>Note that the presence of <code>_count</code> in the enum will not
cause an error in the above because it starts with <code>_</code>.</p>
<p>The <code>C</code> output for this statement will be a direct mapping
to a <code>C</code> switch statement.</p>
<h3 id="the-try-catch-and-throw-statements">The TRY, CATCH, and THROW
Statements</h3>
<p>This example illustrates catching an error from some DML, and
recovering rather than letting the error cascade up. This is the common
“upsert” pattern (insert or update)</p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> printf <span class="kw">no</span> <span class="kw">check</span>;</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> upsert_foo(id_ <span class="dt">integer</span>, t_ text)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> try</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>, t) <span class="kw">values</span>(id_, t_)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> try;</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> catch</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">begin</span> try</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">update</span> foo <span class="kw">set</span> t <span class="op">=</span> t_ <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> try;</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">begin</span> catch</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">call</span> printf(<span class="ot">&quot;Error code %d!\n&quot;</span>, @rc);</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>      throw;</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> catch;</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> catch;</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Once again, let’s go over this section by section:</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> try</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>, t) <span class="kw">values</span>(id_, t_)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> try;</span></code></pre></div>
<p>Normally if the <code>insert</code> statement fails, the procedure
will exit with a failure result code. Here, instead, we prepare to catch
that error.</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> catch</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">begin</span> try</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">update</span> foo <span class="kw">set</span> t <span class="op">=</span> t_ <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> try;</span></code></pre></div>
<p>Now, having failed to insert, presumably because a row with the
provided <code>id</code> already exists, we try to update that row
instead. However that might also fail, so we wrap it in another try. If
the update fails, then there is a final catch block:</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">begin</span> catch</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">call</span> printf(<span class="ot">&quot;Error code %d!\n&quot;</span>, @rc);</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>      throw;</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> catch;</span></code></pre></div>
<p>Here we see a usage of the <code>@rc</code> variable to observe the
failed error code. In this case we simply print a diagnostic message and
then use the <code>throw</code> keyword to rethrow the previous failure
(exactly what is stored in <code>@rc</code>). In general,
<code>throw</code> will create a failure in the current block using the
most recent failed result code from SQLite (<code>@rc</code>) if it is
an error, or else the general <code>SQLITE_ERROR</code> result code if
there is no such error. In this case the failure code for the
<code>update</code> statement will become the result code of the current
procedure.</p>
<p>This leaves only the closing markers:</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> catch;</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>If control flow reaches the normal end of the procedure it will
return <code>SQLITE_OK</code>.</p>
<h3 id="procedures-as-functions-motivation-and-example">Procedures as
Functions: Motivation and Example</h3>
<p>The calling convention for CQL stored procedures often (usually)
requires that the procedure returns a result code from SQLite. This
makes it impossible to write a procedure that returns a result like a
function, as the result position is already used for the error code. You
can get around this problem by using <code>out</code> arguments as your
return codes. So for instance, this version of the Fibonacci function is
possible.</p>
<div class="sourceCode" id="cb141"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this works, but it is awkward</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> fib (<span class="kw">in</span> arg <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">out</span> result <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (arg <span class="op">&lt;=</span> <span class="dv">2</span>) <span class="cf">then</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> result <span class="op">:=</span> <span class="dv">1</span>;</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">declare</span> t <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> fib(arg <span class="op">-</span> <span class="dv">1</span>, result);</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> fib(arg <span class="op">-</span> <span class="dv">2</span>, t);</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> result <span class="op">:=</span> t <span class="op">+</span> result;</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above works, but the notation is very awkward.</p>
<p>CQL has a “procedures as functions” feature that tries to make this
more pleasant by making it possible to use function call notation on a
procedure whose last argument is an <code>out</code> variable. You
simply call the procedure like it was a function and omit the last
argument in the call. A temporary variable is automatically created to
hold the result and that temporary becomes the logical return of the
function. For semantic analysis, the result type of the function becomes
the type of the <code>out</code> argument.</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- rewritten with function call syntax</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> fib (<span class="kw">in</span> arg <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">out</span> result <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (arg <span class="op">&lt;=</span> <span class="dv">2</span>) <span class="cf">then</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> result <span class="op">:=</span> <span class="dv">1</span>;</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> result <span class="op">:=</span> fib(arg <span class="op">-</span> <span class="dv">1</span>) <span class="op">+</span> fib(arg <span class="op">-</span> <span class="dv">2</span>);</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This form is allowed when:</p>
<ul>
<li>all but the last argument of the procedure was specified</li>
<li>the formal parameter for that last argument was marked with
<code>out</code> (neither <code>in</code> nor <code>inout</code> are
acceptable)</li>
<li>the procedure does not return a result set using a
<code>select</code> statement or <code>out</code> statement (more on
these later)</li>
</ul>
<p>If the procedure in question uses SQLite, or calls something that
uses SQLite, then it might fail. If that happens the result code will
propagate just like it would have with the usual <code>call</code> form.
Any failures can be caught with <code>try/catch</code> as usual. This
feature is really only syntatic sugar for the “awkward” form above, but
it does allow for slightly better generated C code.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2
id="chapter-5-types-of-cursors-shapes-out-and-out-union-and-fetch">Chapter
5: Types of Cursors, Shapes, OUT and OUT UNION, and FETCH</h2>
<p>In the previous chapters we have used cursor variables without fully
discussing them. Most of the uses are fairly self-evident but a more
exhaustive discussion is also useful.</p>
<p>First there are three types of cursors, as we will see below.</p>
<h3 id="statement-cursors">Statement Cursors</h3>
<p>A statement cursor is based on a SQL <code>SELECT</code> statement. A
full example might look like this:</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- elsewhere</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> xy_table(x <span class="dt">integer</span>, y <span class="dt">integer</span>);</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> x, y <span class="kw">from</span> xy_table;</span></code></pre></div>
<p>When compiled, this will result in creating a SQLite statement object
(type <code>sqlite_stmt *</code>) and storing it in a variable called
<code>C_stmt</code>. This statement can then be used later in various
ways.</p>
<p>Here’s perhaps the simplest way to use the cursor above:</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> x, y <span class="dt">integer</span>;</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">into</span> x, y;</span></code></pre></div>
<p>This will have the effect of reading one row from the results of the
query into the local variables <code>x</code> and <code>y</code>.</p>
<p>These variables might then be used to create some output such as:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* note use of double quotes so that \n is legal */</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> printf(<span class="ot">&quot;x:%d y:%d\n&quot;</span>, ifnull(x, <span class="dv">0</span>), ifnull(y,<span class="dv">0</span>));</span></code></pre></div>
<p>More generally, there the cursor may or may not be holding fetched
values. The cursor variable <code>C</code> can be used by itself as a
boolean indicating the presence of a row. So a more complete example
might be</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> C <span class="cf">then</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;x:%d y:%d\n&quot;</span>, ifnull(x, <span class="dv">0</span>), ifnull(y,<span class="dv">0</span>));</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;nada\n&quot;</span>);</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span></span></code></pre></div>
<p>And even more generally</p>
<div class="sourceCode" id="cb147"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C <span class="kw">into</span> x, y</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;x:%d y:%d\n&quot;</span>, ifnull(x, <span class="dv">0</span>), ifnull(y,<span class="dv">0</span>));</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The last example above reads all the rows and prints them.</p>
<p>Now if the table <code>xy_table</code> had instead had dozens of
columns, those declarations would be very verbose and error prone, and
frankly annoying, especially if the table definition was changing over
time.</p>
<p>To make this a little easier, there are so-called ‘automatic’
cursors. These happen implicitly and include all the necessary storage
to exactly match the rows in their statement. Using the automatic syntax
for the above looks like so:</p>
<div class="sourceCode" id="cb148"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> xy_table;</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>fetch C;</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> C <span class="cf">then</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;x:%d y:%d\n&quot;</span>, ifnull(C.x, <span class="dv">0</span>), ifnull(C.y,<span class="dv">0</span>));</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>or the equivalent loop form:</p>
<div class="sourceCode" id="cb149"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> xy_table;</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;x:%d y:%d\n&quot;</span>, ifnull(C.x, <span class="dv">0</span>), ifnull(C.y,<span class="dv">0</span>));</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>All the necessary local state is automatically created, hence
“automatic” cursor. This pattern is generally preferred, but the loose
variables pattern is in some sense more general.</p>
<p>In all the cases if the number or type of variables do not match the
select statement, semantic errors are produced.</p>
<h3 id="value-cursors">Value Cursors</h3>
<p>The purpose of value cursors is to make it possible for a stored
procedure to work with structures as a unit rather than only field by
field. SQL doesn’t have the notion of structure types, but structures
actually appear pretty directly in many places. Generally we call these
things “Shapes” and there are a variety of source for shapes
including:</p>
<ul>
<li>the columns of a table</li>
<li>the projection of a <code>SELECT</code> statement</li>
<li>the columns of a cursor</li>
<li>the result type of a procedure that returns a select</li>
<li>the arguments of a procedure</li>
<li>other things derived from the above</li>
</ul>
<p>Let’s first start with how you declare a value cursor. It is
providing one of the shape sources above.</p>
<p>So:</p>
<div class="sourceCode" id="cb150"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> xy_table;</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> <span class="kw">select</span> <span class="dv">1</span> a, <span class="st">&#39;x&#39;</span> b;</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> (a <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, b text <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_view;</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_other_cursor;</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_previously_declared_stored_proc;</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_previously_declared_stored_proc arguments;</span></code></pre></div>
<p>Any of those forms define a valid set of columns – a shape. Note that
the <code>select</code> example in no way causes the query provided to
run. Instead, the select statement is analyzed and the column names and
types are computed. The cursor gets the same field names and types.
Nothing happens at run time.</p>
<p>The last two examples assume that there is a stored procedure defined
somewhere earlier in the same translation unit and that the procedure
returns a result set or has arguments, respectively.</p>
<p>In all cases the cursor declaration makes a cursor that could hold
the indicated result. That result can then be loaded with
<code>FETCH</code> or emitted with <code>OUT</code> or
<code>OUT UNION</code> which will be discussed below.</p>
<p>Once we have declared a value cursor we can load it with values using
<code>FETCH</code> in its value form. Here are some examples:</p>
<p>Fetch from compatible values:</p>
<div class="sourceCode" id="cb151"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">values</span>(<span class="dv">1</span>,<span class="dv">2</span>);</span></code></pre></div>
<p>Fetch from a call to a procedure that returns a single row:</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">call</span> my_previously_declared_stored_proc();</span></code></pre></div>
<p>Fetch from another cursor:</p>
<div class="sourceCode" id="cb153"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> D;</span></code></pre></div>
<p>In this last case if D is a statement cursor it must also be
“automatic” (i.e. it has the storage). This form lets you copy a row and
save it for later. For instance, in a loop you could copy the current
max-value row into a value cursor and use it after the loop, like
so:</p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> somewhere;</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> D <span class="kw">cursor</span> <span class="kw">like</span> C;</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">not</span> D <span class="kw">or</span> D.something <span class="op">&lt;</span> C.something) <span class="cf">then</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>    fetch D <span class="kw">from</span> C;</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>After the loop, D either empty because there were no rows (thus
<code>if D</code> would fail) or else it has the row with the maximum
value of <code>something</code>, whatever that is.</p>
<p>Value cursors are always have their own storage, so you could say all
value cursors are “automatic”.</p>
<p>And as we saw above, value cursors may or may not be holding a
row.</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> xy_table;</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> C <span class="cf">then</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;this will always print because C starts empty\n&quot;</span>);</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>When you call a procedure you may or may not get a row as we’ll see
below.</p>
<p>The third type of cursor is a “result set” cursor but that won’t make
any sense until we’ve discussed result sets a little which requires
<code>OUT</code> and/or <code>OUT UNION</code> and so we’ll go on to
those statements next. As it happens, we are recapitulating the history
of cursor features in the CQL language by exploring the system in this
way.</p>
<h4 id="benefits-of-using-named-typed-to-declare-a-cursor">Benefits of
using named typed to declare a cursor</h4>
<p>This form allows any kind of declaration, for instance:</p>
<pre><code>declare C cursor like ( id integer not null, val real, flag boolean );</code></pre>
<p>This wouldn’t really give us much more than the other forms, however
typed name lists can include LIKE in them again, as part of the list.
Which means you can do this kind of thing:</p>
<pre><code>declare C cursor like (like D, extra1 real, extra2 bool)</code></pre>
<p>You could then load that cursor like so:</p>
<pre><code>fetch C from values (from D, 2.5, false);</code></pre>
<p>and now you have D plus 2 more fields which maybe you want to
output.</p>
<p>Importantly this way of doing it means that C always includes D, even
if D changes over time. As long as the <code>extra1</code> and
<code>extra2</code> fields don’t conflict names it will always work.</p>
<h3 id="out-statement">OUT Statement</h3>
<p>Value cursors were initially designed to create a convenient way for
a procedure to return a single row from a complex query without having a
crazy number of <code>OUT</code> parameters. It’s easiest to illustrate
this with an example.</p>
<p>Suppose you want to return several variables, the “classic” way to do
so would be a procedure like this:</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_a_row(</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  id_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> got_row bool <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> w <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> x <span class="dt">integer</span>,</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> y text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> z <span class="dt">real</span>)</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> w, x, y, z <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>  fetch C <span class="kw">into</span> w, x, y, z;</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> got_row <span class="op">:=</span> C;</span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This is already verbose, but you can imagine the situation gets very
annoying if <code>get_a_row</code> has to produce a couple dozen column
values. And of course you have to get the types exactly right. And they
might evolve over time. Joy.</p>
<p>On the receiving side you get to do something just as annoying:</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> w <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> x <span class="dt">integer</span>;</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> y text;</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> z <span class="dt">real</span>;</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> got_row bool <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> get_a_row(<span class="kw">id</span>, got_row, w, x, y, z);</span></code></pre></div>
<p>Using the <code>out</code> statement we get the equivalent
functionality with a much simplified pattern. It looks like this:</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_a_row(id_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> w, x, y, z <span class="kw">from</span> somewhere <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  fetch C;</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> C;</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>To use the new procedure you simply do this:</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> get_a_row;</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">call</span> get_a_row(<span class="kw">id</span>);</span></code></pre></div>
<p>In fact, originally you did the two steps above in one statement and
that was the only way to load a value cursor. Later, the calculus was
generalized. The original form still works:</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> fetch <span class="kw">from</span> <span class="kw">call</span> get_a_row(<span class="kw">id</span>);</span></code></pre></div>
<p>The <code>OUT</code> statement lets you return a single row
economically and lets you then test if there actually was a row and if
so, read the columns. It infers all the various column names and types
so it is resilient to schema change and generally a lot less error prone
than having a large number of <code>out</code> arguments to your
procedure.</p>
<p>Once you have the result in a value cursor you can do the usual
cursor operations to move it around or otherwise work with it.</p>
<p>The use of the <code>LIKE</code> keyword to refer to groups of
columns spread to other places in CQL as a very useful construct, but it
began here with the need to describe a cursor shape economically, by
reference.</p>
<h3 id="out-union-statement">OUT UNION Statement</h3>
<p>The semantics of the <code>OUT</code> statement are that it always
produces one row of output (a procedure can produce no row if an
<code>out</code> never actually rans but the procedure does use
<code>OUT</code>).</p>
<p>If an <code>OUT</code> statement runs more than once, the most recent
row becomes the result. So the <code>OUT</code> statement really does
mirror having one <code>out</code> variable for each output column. This
was its intent and procedures that return at most, or exactly, one row
are very common so it works well enough.</p>
<p>However, in general, one row results do not suffice; you might want
to produce a result set from various sources, possibly with some
computation as part of the row creation process. To make general
results, you need to be able to emit multiple rows from a computed
source. This is exactly what <code>OUT UNION</code> provides.</p>
<p>Here’s a (somewhat contrived) example of the kind of thing you can do
with this form:</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo(n <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> <span class="kw">select</span> <span class="dv">1</span> <span class="fu">value</span>;</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  let i <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="op">&lt;</span> n</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- emit one row for every integer</span></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>     fetch C <span class="kw">from</span> <span class="kw">values</span>(i);</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>     <span class="kw">out</span> <span class="kw">union</span> C;</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>     <span class="kw">set</span> i <span class="op">:=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In <code>foo</code> above, we make an entire result set out of thin
air. It isn’t a very interesting result, but of course any computation
would have been possible.</p>
<p>This pattern is very flexible as we see below in <code>bar</code>
where we merge two different data streams.</p>
<div class="sourceCode" id="cb165"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(<span class="kw">id</span> <span class="dt">integer</span>, stuff text, [other things too]);</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(<span class="kw">id</span> <span class="dt">integer</span>, stuff text, [other things too]);</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc bar()</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t1 <span class="kw">order</span> <span class="kw">by</span> <span class="kw">id</span>;</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> D <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t2 <span class="kw">order</span> <span class="kw">by</span> <span class="kw">id</span>;</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>  fetch C;</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>  fetch D;</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we&#39;re going to merge these two queries</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> C <span class="kw">or</span> D</span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- if both have a row pick the smaller id</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> C <span class="kw">and</span> D <span class="cf">then</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> C.<span class="kw">id</span> <span class="op">&lt;</span> D.<span class="kw">id</span> <span class="cf">then</span></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>         <span class="kw">out</span> <span class="kw">union</span> C;</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>         fetch C;</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>       <span class="cf">else</span></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>         <span class="kw">out</span> <span class="kw">union</span> D;</span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a>         fetch D;</span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a>       <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> C <span class="cf">then</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- only C has a row, emit that</span></span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">out</span> <span class="kw">union</span> C;</span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a>      fetch C;</span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- only D has a row, emit that</span></span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">out</span> <span class="kw">union</span> D;</span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>      fetch D;</span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Just like <code>foo</code>, in <code>bar</code>, each time
<code>OUT UNION</code> runs a new row is accumulated.</p>
<p>Now, if you build a procedure that ends with a <code>SELECT</code>
statement CQL automatically creates a fetcher function that does
something like an <code>OUT UNION</code> loop – it loops over the SQLite
statement for the <code>SELECT</code> and fetches each row,
materializing a result.</p>
<p>With <code>OUT UNION</code> you take manual control of this process,
allowing you to build arbitrary result sets. Note that either of
<code>C</code> or <code>D</code> above could have been modified,
replaced, skipped, normalized, etc. with any kind of computation. Even
entirely synthetic rows can be computed and inserted into the output as
we saw in <code>foo</code>.</p>
<h3 id="result-set-cursors">Result Set Cursors</h3>
<p>Now that we have <code>OUT UNION</code> it makes sense to talk about
the final type of cursor.</p>
<p><code>OUT UNION</code> makes it possible to create arbitrary result
sets using a mix of sources and filtering. Unfortunately this result
type is not a simple row, nor is it a SQLite statement. This meant that
neither of the existing types of cursors could hold the result of a
procedure that used <code>OUT UNION</code>. – CQL could not itself
consume its own results.</p>
<p>To address this hole, we need an additional cursor type. The syntax
is exactly the same as the statement cursor cases described above but,
instead of holding a SQLite statement, the cursor holds a result set
pointer and the current and maximum row numbers. Stepping through the
cursor simply increments the row number and fetches the next row out of
the rowset instead of from SQLite.</p>
<p>Example:</p>
<div class="sourceCode" id="cb166"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- reading the above</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc reader()</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">call</span> bar();</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch C</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> printf(<span class="ot">&quot;%d %s\n&quot;</span>, C.<span class="kw">id</span>, C.stuff);  <span class="co">-- or whatever fields you need</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>If <code>bar</code> had been created with a <code>SELECT</code>,
<code>UNION ALL</code>, and <code>ORDER BY</code> to merge the results,
the above would have worked with <code>C</code> being a standard
statement cursor, iterating over the union. Since <code>foo</code>
produces a result set, CQL transparently produces a suitable cursor
implementation behind the scenes, but otherwise the usage is the
same.</p>
<p>Note this is a lousy way to simply iterate over rows; you have to
materialize the entire result set so that you can just step over it.
Re-consuming like this is not recommended at all for production code,
but it is ideal for testing result sets that were made with
<code>OUT UNION</code> which otherwise would require C/C++ to test.
Testing CQL with CQL is generally a lot easier.</p>
<h3 id="reshaping-data-cursor-like-forms">Reshaping Data, Cursor
<code>LIKE</code> forms</h3>
<p>There are lots of cases where you have big rows with many columns,
and there are various manipulations you might need to do.</p>
<p>What follows is a set of useful syntactic sugar constructs that
simplify handling complex rows. The idea is that pretty much anywhere
you can specify a list of columns you can instead use the
<code>LIKE x</code> construct to get the columns as they appear in the
shape <code>x</code> – which is usually a table or a cursor.</p>
<p>It’s a lot easier to illustrate with examples, even though these are,
again, a bit contrived.</p>
<p>First we need some table with lots of columns – usually the column
names are much bigger which makes it all the more important to not have
to type them over and over, but in the interest of some brevity, here’s
a big table:</p>
<div class="sourceCode" id="cb167"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> big (</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  id2 <span class="dt">integer</span> <span class="kw">unique</span>,</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  a <span class="dt">integer</span>,</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  b <span class="dt">integer</span>,</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  c <span class="dt">integer</span>,</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  d <span class="dt">integer</span>,</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>  e <span class="dt">integer</span>,</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  f <span class="dt">integer</span>);</span></code></pre></div>
<p>This example showcases several of the cursor and shape slicing
features by emitting two related rows:</p>
<div class="sourceCode" id="cb168"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo(id_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- this is the shape of the result we want -- it&#39;s some of the columns of &quot;big&quot;</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- note this query doesn&#39;t run, we just use its shape to create a cursor</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- with those columns.</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> result <span class="kw">cursor</span> <span class="kw">like</span> <span class="kw">select</span> <span class="kw">id</span>, b, c, d <span class="kw">from</span> big;</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- fetch the main row, specified by id_</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- main row has all the fields, including id2</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> main_row <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> big <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>  fetch main_row;</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- now fetch the result columns out of the main row</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- &#39;like result&#39; means &quot;the column names found in &#39;result&#39;&quot;</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>  fetch result <span class="kw">from</span> <span class="kw">cursor</span> main_row(<span class="kw">like</span> result);</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- this is our first result row</span></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> <span class="kw">union</span> result;</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- now we want the related row, but we only need two columns</span></span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- from the related row, &#39;b&#39; and &#39;c&#39;</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> alt_row <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> b, c <span class="kw">from</span> big <span class="kw">where</span> big.id2 <span class="op">=</span> main_row.id2;</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>  fetch alt_row;</span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- update some of the fields &#39;result&#39; from the the new cursor</span></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">update</span> <span class="kw">cursor</span> result(<span class="kw">like</span> alt_row) <span class="kw">from</span> <span class="kw">cursor</span> alt_row;</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- and emit the 2nd row</span></span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> <span class="kw">union</span> result;</span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Now let’s briefly discuss what is above. The two essential parts
are:</p>
<p><code>fetch result from cursor main_row(like result);</code></p>
<p>and</p>
<p><code>update cursor result(like alt_row) from cursor alt_row;</code></p>
<p>In the first case what we’re saying is that we want to load the
columns of <code>result</code> from <code>main_row</code> but we only
want to take the columns that are actually present in
<code>result</code>. So this is a narrowing of a wide row into a smaller
row. In this case, the smaller row, <code>result</code>, is what we want
to emit. We needed the other columns to compute
<code>alt_row</code>.</p>
<p>The second case, what we’re saying is that we want to update
<code>result</code> by replacing the columns found in
<code>alt_row</code> with the values in <code>alt_row</code>. So in this
case we’re writing a smaller cursor into part of a wider cursor. Note
that we used the <code>update cursor</code> form here because it
preserves all other columns. If we used <code>fetch</code> we would be
rewriting the entire row contents, using <code>NULL</code> if necessary,
and that is not desired here.</p>
<p>Here is the rewritten version of the above procedure; this is what
ultimately gets compiled into C.</p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC foo (id_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> result <span class="kw">CURSOR</span> <span class="kw">LIKE</span> <span class="kw">SELECT</span> <span class="kw">id</span>, b, c, d <span class="kw">FROM</span> big;</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> main_row <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> big <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  FETCH main_row;</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  FETCH result(<span class="kw">id</span>, b, c, d)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> <span class="kw">VALUES</span>(main_row.<span class="kw">id</span>, main_row.b, main_row.c, main_row.d);</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> <span class="kw">UNION</span> result;</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> alt_row <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">SELECT</span> b, c <span class="kw">FROM</span> big <span class="kw">WHERE</span> big.id2 <span class="op">=</span> main_row.id2;</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>  FETCH alt_row;</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UPDATE</span> <span class="kw">CURSOR</span> result(b, c) <span class="kw">FROM</span> <span class="kw">VALUES</span>(alt_row.b, alt_row.c);</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> <span class="kw">UNION</span> result;</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Of course you could have typed the above directly but if there are 50
odd columns it gets old fast and is very error prone. The sugar form is
going to be 100% correct and will require much less typing and
maintenance.</p>
<p>Finally, while I’ve shown both <code>LIKE</code> forms separately,
they can also be used together. For instance:</p>
<div class="sourceCode" id="cb170"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">update</span> <span class="kw">cursor</span> C(<span class="kw">like</span> X) <span class="kw">from</span> <span class="kw">cursor</span> D(<span class="kw">like</span> X);</span></code></pre></div>
<p>The above would mean, “move the columns that are found in
<code>X</code> from cursor <code>D</code> to cursor <code>C</code>”,
presuming <code>X</code> has columns common to both.</p>
<h3 id="fetch-statement-specifics">Fetch Statement Specifics</h3>
<p>Many of the examples used the <code>FETCH</code> statement in a sort
of demonstrative way that is hopefully self-evident but the statement
has many forms and so it’s worth going over them specifically. Below
we’ll use the letters <code>C</code> and <code>D</code> for the names of
cursors. Usually <code>C</code>;</p>
<h4 id="fetch-with-statement-or-result-set-cursors">Fetch with Statement
or Result Set Cursors</h4>
<p>A cursor declared in one of these forms:</p>
<ul>
<li><code>declare C cursor for select * from foo;</code></li>
<li><code>declare C cursor for call foo();</code> (foo might end with a
<code>select</code> or use <code>out union</code>)</li>
</ul>
<p>is either a statement cursor or a result set cursor. In either case
the cursor moves through the results. You load the next row with:</p>
<ul>
<li><code>FETCH C</code>, or</li>
<li><code>FETCH C into x, y, z;</code></li>
</ul>
<p>In the first form <code>C</code> is said to be <em>automatic</em> in
that it automatically declares the storage needed to hold all its
columns. As mentioned above, automatic cursors have storage for their
row.</p>
<p>Having done this fetch you can use C as a scalar variable to see if
it holds a row, e.g.</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">limit</span> <span class="dv">1</span>;</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>fetch C;</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> C <span class="cf">then</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- bingo we have a row</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;%s\n&quot;</span>, C.whatever);</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span></span></code></pre></div>
<p>You can easily iterate, e.g.</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo;</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- one time for every row</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;%s\n&quot;</span>, C.whatever);</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Automatic cursors are so much easier to use than explicit storage
that explicit storage is rarely seen. Storing to <code>out</code>
parameters is one case where explicit storage actually is the right
choice, as the <code>out</code> parameters have to be declared
anyway.</p>
<h4 id="fetch-with-value-cursors">Fetch with Value Cursors</h4>
<p>A value cursor is declared in one of these ways:</p>
<ul>
<li><code>declare C cursor fetch from call foo(args)</code>
<ul>
<li><code>foo</code> must be a procedure that returns one row with
<code>OUT</code></li>
</ul></li>
<li><code>declare C cursor like select 1 id, "x" name;</code></li>
<li><code>declare C cursor like X;</code>
<ul>
<li>where X is the name of a table, a view, another cursor, or a
procedure that returns a structured result</li>
</ul></li>
</ul>
<p>A value cursor is <em>always</em> automatic; it’s purpose is to hold
a row. It doesn’t iterate over anything but it can be re-loaded in a
loop.</p>
<ul>
<li><code>fetch C</code> or <code>fetch C into ...</code> is not valid
on such a cursor, because it doesn’t have a source to step through.</li>
</ul>
<p>The canonical way to load such a cursor is:</p>
<ul>
<li><code>fetch C from call foo(args);</code>
<ul>
<li><code>foo</code> must be a procedure that returns one row with
<code>OUT</code></li>
</ul></li>
<li><code>fetch C(a,b,c...) from values(x, y, z);</code></li>
</ul>
<p>The first form is in some sense the origin of the value cursor. Value
cursors were added to the language initially to provide a way to capture
the single row <code>OUT</code> statement results, much like result set
cursors were added to capture procedure results from
<code>OUT UNION</code>. In the first form, the cursor storage (a C
struct) is provided by reference as a hidden out parameter to the
procedure and the procedure fills it in. The procedure may or may not
use the <code>OUT</code> statement in its control flow, as the cursor
might not hold a row. You can use <code>if C then ...</code> as before
to test for a row.</p>
<p>The second form is more interesting as it allows the cursor to be
loaded from arbitrary expressions subject to some rules: * you should
think of the cursor as a logical row: it’s either fully loaded or it’s
not, therefore you must specify enough columns in the column list to
ensure that all <code>NOT NULL</code> columns will get a value * if not
mentioned in the list, NULL will be loaded where possible * if
insufficient columns are named, an error is generated * if the value
types specified are not compatible with the column types mentioned, an
error is generated * later in this chapter, we’ll show that columns can
also be filled with dummy data using a seed value</p>
<p>With this form, any possible valid cursor values could be set, but
many forms of updates that are common would be awkward. So there are
various forms of syntactic sugar that are automatically rewritten into
the canonical form. See the examples below:</p>
<ul>
<li><code>fetch C from values(x, y, z)</code>
<ul>
<li>if no columns are specified this is the same as naming all the
columns, in declared order</li>
</ul></li>
<li><code>fetch C from arguments</code>
<ul>
<li>the arguments to the procedure in which this statement appears are
used as the values, in order</li>
<li>in this case <code>C</code> was also rewritten into
<code>C(a,b,c,..)</code> etc.</li>
</ul></li>
<li><code>fetch C from arguments like C</code>
<ul>
<li>the arguments to the procedure in which this statement appears are
used, by name, as the values, using the names of of the indicated
shape</li>
<li>the order in which the arguments appeared no longer matters, the
names that match the columns of C are used if present</li>
<li>the formal parameter name may have a single trailing underscore
(this is what <code>like C</code> would generate)</li>
<li>e.g. if <code>C</code> has columns <code>a</code> and <code>b</code>
then there must exist formals named <code>a</code> or <code>a_</code>
and <code>b</code> or <code>b_</code>, in any position</li>
</ul></li>
<li><code>fetch C(a,b) from cursor D(a,b)</code>
<ul>
<li>the named columns of D are used as the values</li>
<li>in this case the statement becomes:
<code>fetch C(a,b) from values(D.a, D.b);</code></li>
</ul></li>
</ul>
<p>That most recent form doesn’t seem like it saves much, but recall the
first rewrite:</p>
<ul>
<li><code>fetch C from cursor D</code>
<ul>
<li>both cursors are expanded into all their columns, creating a copy
from one to the other</li>
<li><code>fetch C from D</code> can be used if the cursors have the
exact same column names and types; it also generates slightly better
code and is a common case</li>
</ul></li>
</ul>
<p>It is very normal to want to use only some of the columns of a
cursor; these <code>like</code> forms do that job. We saw some of these
forms in an earlier example.</p>
<ul>
<li><code>fetch C from cursor D(like C)</code>
<ul>
<li>here <code>D</code> is presumed to be “bigger” than <code>C</code>,
in that it has all of the <code>C</code> columns and maybe more. The
<code>like C</code> expands into the names of the <code>C</code> columns
so <code>C</code> is loaded from the <code>C</code> part of
<code>D</code></li>
<li>the expansion might be
<code>fetch C(a, b, g) from values (D.a, D.b, D.g)</code></li>
<li><code>D</code> might have had fields <code>c, d, e, f</code> which
were not used because they are not in <code>C</code>.</li>
</ul></li>
</ul>
<p>The symmetric operation, loading some of the columns of a wider
cursor can be expressed neatly:</p>
<ul>
<li><code>fetch C(like D) from cursor D</code>
<ul>
<li>the <code>like D</code> expands into the columns of <code>D</code>
causing the cursor to be loaded with what’s in <code>D</code> and
<code>NULL</code> (if needed)</li>
<li>when expanded, this might look like
<code>fetch C(x, y) from values(D.x, D.y)</code></li>
</ul></li>
</ul>
<p><code>LIKE</code> can be used in both places, for instance suppose
<code>E</code> is a shape that has a subset of the rows of both
<code>C</code> and <code>D</code>. You can write a form like this:</p>
<ul>
<li><code>fetch C(like E) from cursor D(like E)</code>
<ul>
<li>this means take the column names found in <code>E</code> and copy
them from D to C.</li>
<li>the usual type checking is done</li>
</ul></li>
</ul>
<p>As is mentioned above, the <code>fetch</code> form means “load an
entire row into the cursor”. This is important because “half loaded”
cursors would be semantically problematic. However there are many cases
where you might like to amend the values of an already loaded cursor.
You can do this with the <code>update</code> form.</p>
<ul>
<li><code>update cursor C(a,b,..) from values(1,2,..);</code>
<ul>
<li>the update form is a no-op if the cursor is not already loaded with
values (!!)</li>
<li>the columns and values are type checked so a valid row is ensured
(or no row)</li>
<li>all the re-writes above are legal so
<code>update cursor C(like D) from D</code> is possible; it is in fact
the use-case for which this was designed.</li>
</ul></li>
</ul>
<h3 id="calling-procedures-with-argument-bundles">Calling Procedures
with Argument Bundles</h3>
<p>It’s often desirable to treat bundles of arguments as a unit, or
cursors as a unit, especially when calling other procedures. The shape
patterns above are very helpful for moving data between cursors, and the
database. These can be rounded out with similar constructs for procedure
definitions and procedure calls as follows.</p>
<p>First we’ll define some shapes to use in the examples. Note that we
made <code>U</code> using <code>T</code>.</p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> T(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, y <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,  z <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> U(<span class="kw">like</span> T, a <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>We haven’t mentioned this before but the implication of the above is
that you can use the <code>LIKE</code> construct inside a table
definition to add columns from a shape.</p>
<p>We can also use the <code>LIKE</code> construct to create procedure
arguments. To avoid conflicts with column names, when used this way the
procedure arguments all get a trailing underscore appended to them. The
arguments will be <code>x_</code>, <code>y_</code>, and <code>z_</code>
as we can see if the following:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p1(<span class="kw">like</span> T)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;%d %d %d\n&quot;</span>, x_, y_, z_);</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Shapes can also be used in a procedure call, as showed below. This
next example is obviously contrived, but of course it generalizes. It is
exactly equivalent to the above.</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p2(<span class="kw">like</span> T)</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> printf(<span class="ot">&quot;%d %d %d\n&quot;</span>, <span class="kw">from</span> arguments);</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Now we might want to chain these things together. This next example
uses a cursor to call <code>p1</code>.</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc q1()</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> T;</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">loop</span> fetch C</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a> <span class="cf">begin</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* this is the same as call p(C.x, C.y, C.z) */</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">call</span> p1(<span class="kw">from</span> C);</span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">end</span>;</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The <code>like</code> construct allows you to select some of the
arguments, or some of a cursor to use as arguments. This next procedure
has more arguments than just <code>T</code>. The arguments will be
<code>x_</code>, <code>y_</code>, <code>z_</code>, <code>a_</code>,
<code>b_</code>. But the call will still have the <code>T</code>
arguments <code>x_</code>, <code>y_</code>, and <code>z_</code>.</p>
<div class="sourceCode" id="cb177"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc q2(<span class="kw">like</span> U)</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* just the args that match T: so this is still call p(x_, y_, z_) */</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> p1(<span class="kw">from</span> arguments <span class="kw">like</span> T);</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Or similarly, using a cursor.</p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc q3(<span class="kw">like</span> U)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> U;</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">loop</span> fetch C</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a> <span class="cf">begin</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* just the columns that match T so this is still call p(C.x, C.y, C.z) */</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> p1(<span class="kw">from</span> C <span class="kw">like</span> T);</span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">end</span>;</span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Note that the <code>from</code> argument forms do not have to be all
the arguments. For instance you can get columns from two cursors like
so:</p>
<div class="sourceCode" id="cb179"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> something(<span class="kw">from</span> C, <span class="kw">from</span> D)</span></code></pre></div>
<p>All the varieties can be combined but of course the procedure
signature must match. And all these forms work in function expressions
as well as procedure calls.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> x <span class="op">:=</span> a_function(<span class="kw">from</span> C);</span></code></pre></div>
<p>Since these forms are simply syntatic sugar, they can also appear
inside of function calls that are in SQL statements. The variables
mentioned will be expanded and become bound variables just like any
other variable that appears in a SQL statement.</p>
<p>Note the form <code>x IN (from arguments)</code> is not supported at
this time, though this would be a relatively easy addition.</p>
<h3 id="using-named-argument-bundles">Using Named Argument Bundles</h3>
<p>There are many cases where stored procedures require complex
arguments using data shapes that come from the schema, or from other
procedures. As we have seen the <code>LIKE</code> construct for
arguments can help with this, but it has some limitations. Let’s
consider a specific example to study:</p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> text <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  name text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  address text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>  birthday <span class="dt">real</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>To manage this table we might need something like this:</p>
<div class="sourceCode" id="cb182"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_person(<span class="kw">like</span> Person)</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person <span class="kw">from</span> arguments;</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>As we have seen, the above expands into:</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_person(</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>  id_ text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  name_ text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>  address_ text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>  birthday_ <span class="dt">real</span>)</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person(<span class="kw">id</span>, name, address, birthday)</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">values</span>(id_, name_, address_, birthday_);</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>It’s clear that the sugared version is a lot easier to reason about
than the fully expanded version, and much less prone to errors as
well.</p>
<p>This much is already helpful, but just those forms aren’t general
enough to handle the usual mix of situations. For instance, what if we
need a procedure that works with two people? A hypothetical
<code>insert_two_people</code> procedure cannot be written with the
forms we have so far.</p>
<p>To generalize this the language adds the notion of named argument
bundles. The idea here is to name the bundles which provides a useful
scoping. Example:</p>
<div class="sourceCode" id="cb184"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_two_people(p1 <span class="kw">like</span> Person, p2 <span class="kw">like</span> Person)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- using a procedure that takes a Person args</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> insert_person(<span class="kw">from</span> p1);</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> insert_person(<span class="kw">from</span> p2);</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>or alternatively</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_two_people(p1 <span class="kw">like</span> Person, p2 <span class="kw">like</span> Person)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- inserting a Person directly</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person <span class="kw">from</span> p1;</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person <span class="kw">from</span> p2;</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above expands into:</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_two_people(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  p1_id text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  p1_name text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  p1_address text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  p1_birthday <span class="dt">real</span>,</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  p2_id text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>  p2_name text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>  p2_address text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>  p2_birthday <span class="dt">real</span>)</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person(<span class="kw">id</span>, name, address, birthday)</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">values</span>(p1_id, p1_name, p1_address, p1_birthday);</span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person(<span class="kw">id</span>, name, address, birthday)</span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">values</span>(p2_id, p2_name, p2_address, p2_birthday);</span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Or course different named bundles can have different types – you can
create and name shapes of your choice. The language allows you to use an
argument bundle name in all the places that a cursor was previously a
valid source. That includes <code>insert</code>, <code>fetch</code>,
<code>update cursor</code>, and procedure calls. You can refer to the
arguments by their expanded name such as <code>p1_address</code> or
alternatively <code>p1.address</code> – they mean the same thing.</p>
<p>Here’s another example showing a silly but illustrative thing you
could do:</p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc insert_lotsa_people(P <span class="kw">like</span> Person)</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- make a cursor to hold the arguments</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> P;</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- convert arguments to a cursor</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>  fetch C <span class="kw">from</span> P;</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- set up to patch the cursor and use it 20 times</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  let i <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="op">&lt;</span> <span class="dv">20</span></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">update</span> <span class="kw">cursor</span> C(<span class="kw">id</span>) <span class="kw">from</span> <span class="kw">values</span>(printf(<span class="ot">&quot;id_%d&quot;</span>, i));</span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">insert</span> <span class="kw">into</span> Person <span class="kw">from</span> C;</span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> i <span class="op">:=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above shows that you can use a bundle as the source of a shape,
and you can use a bundle as a source of data to load a cursor. After
which you can do all the usual value cursor things. Of course in this
case the value cursor was redundant, we could just as easily have done
something like this:</p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> P_id <span class="op">:=</span> printf(<span class="ot">&quot;id_%d&quot;</span>, i);</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> Person <span class="kw">from</span> P;</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> i <span class="op">:=</span> i <span class="op">+</span> <span class="dv">1</span>;</span></code></pre></div>
<blockquote>
<p>NOTE: the CQL JSON output includes extra information about procedure
arguments if they originated as part of a shape bundle do identify the
shape source for tools that might need that information.</p>
</blockquote>
<h3 id="the-columnslike-construct-in-the-select-statement">The
COLUMNS/LIKE construct in the SELECT statement</h3>
<p>The select list of a <code>SELECT</code> statement already has
complex syntax and functionality, but it is a very interesting place to
use shapes. To make it possible to use shape notations and not confuse
them with standard SQL the <code>COLUMNS</code> construct was added to
the language. This allows for a sugared syntax for extracting columns in
bulk.</p>
<p>The <code>COLUMNS</code> clause is like of a generalization of the
<code>select T.*</code> with shape slicing and type-checking. The forms
are discussed below:</p>
<h4 id="columns-from-a-join-table-or-tables">Columns from a join table
or tables</h4>
<p>This is the simplest form, it’s just like <code>T.*</code>:</p>
<pre><code>-- same as A.*
select columns(A) from ...;

-- same as A.*, B.*
select columns(A, B) from ...;</code></pre>
<h4
id="columns-from-a-particular-joined-table-that-match-a-shape">Columns
from a particular joined table that match a shape</h4>
<p>This allows you to choose some of the columns of one table of the
FROM clause.</p>
<pre><code>-- the columns of A that match the shape Foo
select columns(A like Foo) from ...;

-- get the Foo shape from A and the Bar shape from B
select columns(A like Foo, B like Bar) from ...;</code></pre>
<h4
id="columns-from-any-that-match-a-shape-from-anywhere-in-the-from">Columns
from any that match a shape, from anywhere in the FROM</h4>
<p>Here we do not specify a particular table that contains the columns,
the could come from any of the tables in the FROM clause.</p>
<pre><code>--- get the Foo shape from anywhere in the join
select columns(like Foo) from ...;

-- get the Foo and Bar shapes, from anywhere in the join
select columns(like Foo, like Bar) from ...;</code></pre>
<h4 id="specific-columns">Specific columns</h4>
<p>This form allows you to slice out a few columns without defining a
shape, you simply list the exact columns you want.</p>
<pre><code>-- T1.x and T2.y plus the Foo shape
select columns(T1.x, T2.y, like Foo) from ...;</code></pre>
<h4 id="distinct-columns">Distinct columns</h4>
<p>Its often the case that there are duplicate column names in the
<code>FROM</code> clause. For instance, you could join <code>A</code> to
<code>B</code> with both having a column <code>pk</code>. The final
result set can only have one column named <code>pk</code>, the distinct
clause helps you to get distinct column names. In this context
<code>distinct</code> is about column names, not values.</p>
<pre><code>-- removes duplicate column names
-- e.g. there will be one copy of &#39;pk&#39;
select columns(distinct A, B) from A join B using(pk);

-- if both Foo and Bar have an (e.g.) &#39;id&#39; field you only get one copy
select columns(distinct like Foo, like Bar) from ...;</code></pre>
<p>If a specific column is mentioned it is always included, but later
expressions that are not a specific column will avoid that column
name.</p>
<pre><code>-- if F or B has an x it won&#39;t appear again, just T.x
select columns(distinct T.x, F like Foo, B like Bar) from F, B ..;</code></pre>
<p>Of course this is all just sugar, so it all compiles to a column list
with table qualifications – but the syntax is very powerful. You can
easily narrowin a wide table, or fusing joins that share common
keys.</p>
<pre><code>-- just the Foo columns
select columns(like Foo) from Superset_Of_Foo_From_Many_Joins_Even;

-- only one copy of &#39;pk&#39;
select columns(distinct A,B,C) from
  A join B using (pk) join C using (pk);</code></pre>
<p>And of course you can define shapes however you like and then use
them to slice off column chucks of your choice. There are many ways to
build up shapes from other shapes. For instance, you can declare
procedures that return the shape you want and never actually create the
procedure – a pattern is very much like a shape “typedef”. E.g.</p>
<pre><code>declare proc shape1() (x integer, y real, z text);
declare proc shape2() (like shape1, u bool, v bool);</code></pre>
<p>With this combination you can easily define common column shapes and
slice them out of complex queries without having to type the columns
names over and over.</p>
<h3 id="missing-data-columns-nulls-and-dummy-data">Missing Data Columns,
Nulls and Dummy Data</h3>
<p>What follows are the rules for columns that are missing in an
<code>INSERT</code>, or <code>FETCH</code> statement. As with many of
the other things discussed here, the forms result in automatic rewriting
of the code to include the specified dummy data. So SQLite will never
see these forms.</p>
<p>Two things to note: First, the dummy data options described below are
really only interesting in test code, it’s hard to imagine them being
useful in production code. Second, none of what follows applies to the
<code>update cursor</code> statement because its purpose is to do
partial updates on exactly the specified columns and we’re about to talk
about what happens with the columns that were not specified.</p>
<p>When fetching a row all the columns must come from somewhere; if the
column is mentioned or mentioned by rewrite then it must have a value
mentioned, or a value mentioned by rewrite. For columns that are not
mentioned, a NULL value is used if it is legal to do so. For example,
<code>fetch C(a) from values(1)</code> might turn into
<code>fetch C(a,b,c,d) from values (1, NULL, NULL, NULL)</code></p>
<p>In addition to the automatic NULL you may add the annotation
<code>@dummy_seed([long integer expression])</code>. If this annotion is
present then: * the expression is evaluated and stored in the hidden
variable <em>seed</em> * all integers, and long integers get
<em>seed</em> as their value (possibly truncated) * booleans get 1 if
and only if <em>seed</em> is non-zero * strings get the name of the
string column an underscore and the value as text (e.g. “myText_7” if
<em>seed</em> is 7) * blobs are not currently supported for dummy data
(CQL is missing blob conversions which are needed first)</p>
<p>This construct is hugely powerful in a loop to create many complete
rows with very little effort, even if the schema change over time.</p>
<div class="sourceCode" id="cb197"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> i <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">like</span> my_table;</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> i <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (i <span class="op">&lt;</span> <span class="dv">20</span>)</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>   fetch C(<span class="kw">id</span>) <span class="kw">from</span> <span class="kw">values</span>(i<span class="op">+</span><span class="dv">10000</span>) @dummy_seed(i);</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">insert</span> <span class="kw">into</span> my_table <span class="kw">from</span> <span class="kw">cursor</span> C;</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Now in this example we don’t need to know anything about
<code>my_table</code> other than that it has a column named
<code>id</code>. This example shows several things: * we got the shape
of the cursor from the table we were inserting into * you can do your
own computation for some of the columns (those named) and leave the
unnamed values to be defaulted * the rewrites mentioned above work for
the <code>insert</code> statement as well as <code>fetch</code> * in
fact
<code>insert into my_table(id) values(i+10000) @dummy_seed(i)</code>
would have worked too with no cursor at all * bonus, dummy blob data
does work in insert statements because SQLite can do the string
conversion easily * the dummy value for a blob is a blob that holds the
text of the column name and the text of the seed just like a string
column</p>
<p>The <code>@dummy_seed</code> form can be modified with
<code>@dummy_nullables</code>, this indicates that rather than using
NULL for any nullable value that is missing, CQL should use the seed
value. This overrides the default behavior of using NULL where columns
are needed. Note the NULL filling works a little differently on insert
statements. Since SQLite will provide a NULL if one is legal the column
doesn’t have to be added to the list with a NULL value during rewriting,
it can simply be omitted, making the statement smaller.</p>
<p>Finally for <code>insert</code> statement only, SQLite will normally
use the default value of a column if it has one, so there is no need to
add missing columns with default values to the insert statement. However
if you specify <code>@dummy_defaults</code> then columns with a default
value will instead be rewritten and they will get <code>_seed_</code> as
their value.</p>
<p>Some examples. Suppose columns a, b, c are not null; m, n are
nullable; and x, y have defaults.</p>
<pre><code>-- as written
insert into my_table(a) values(7) @dummy_seed(1000)
-- rewrites to
insert into my_table(a, b, c) values(7, 1000, 1000);</code></pre>
<pre><code>-- as written
insert into my_table(a) values(7) @dummy_seed(1000) @dummy_nullables
-- rewrites to
insert into my_table(a, b, c, m, n) values(7, 1000, 1000, 1000, 1000);</code></pre>
<pre><code>-- as written
insert into my_table(a) values(7) @dummy_seed(1000) @dummy_nullables @dummy_defaults
-- rewrites to
insert into my_table(a, b, c, m, n, x, y) values(7, 1000, 1000, 1000, 1000, 1000, 1000);</code></pre>
<p>The sugar features on <code>fetch</code>, <code>insert</code>, and
<code>update cursor</code> are as symmetric as possible, but again,
dummy data is generally only interesting in test code. Dummy data will
continue to give you valid test rows even if columns are added or
removed from the tables in question.</p>
<h3 id="generalized-cursor-lifetimes-aka-cursor-boxing">Generalized
Cursor Lifetimes aka Cursor “Boxing”</h3>
<p>Generalized Cursor Lifetime refers to capturing a Statement Cursor in
an object so that it can used more flexibly. Wrapping something in an
object is often called “boxing”. Since Generalized Cursor Lifetime is a
mouthful we’ll refer to it as “boxing” from here forward. The symmetric
operation “unboxing” refers to converting the boxed object back into a
cursor.</p>
<p>The normal cursor usage pattern is by far the most common, a cursor
is created directly with something like these forms:</p>
<div class="sourceCode" id="cb201"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> shape_source;</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> D <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">call</span> proc_that_returns_a_shape();</span></code></pre></div>
<p>At this point the cursor can be used normally as follows:</p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="cf">loop</span> fetch C</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- do stuff with C</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Those are the usual patterns and they allow statement cursors to be
consumed sort of “up” the call chain from where the cursor was created.
But what if you want some worker procedures that consume a cursor? There
is no way to pass your cursor down again with these normal patterns
alone.</p>
<p>To generalize the patterns, allowing, for instance, a cursor to be
returned as an out parameter or accepted as an in parameter you first
need to declare an object variable that can hold the cursor and has a
type indicating the shape of the cursor.</p>
<p>To make an object that can hold a cursor:</p>
<div class="sourceCode" id="cb203"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> obj <span class="dt">object</span><span class="op">&lt;</span>T <span class="kw">cursor</span><span class="op">&gt;</span>;</span></code></pre></div>
<p>Where <code>T</code> is the name of a shape. It can be a table name,
or a view name, or it can be the name of the canonical procedure that
returns the result. T should be some kind of global name, something that
could be accessed with <code>#include</code> in various places.
Referring to the examples above, choices for <code>T</code> might be
<code>shape_source</code> the table or
<code>proc_that_returns_a_shape</code> the procedure.</p>
<blockquote>
<p>NOTE: it’s always possible make a fake procedure that returns a
result to sort of “typedef” a shape name. e.g.</p>
</blockquote>
<div class="sourceCode" id="cb204"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc my_shape() (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, name text);</span></code></pre></div>
<p>The procedure here <code>my_shape</code> doesn’t have to actually
ever be created, in fact it’s better if it isn’t. It won’t ever be
called; its hypothetical result is just being as a shape. This can be
useful if you have several procedures like
<code>proc_that_returns_a_shape</code> that all return results with the
columns of <code>my_shape</code>.</p>
<p>To create the boxed cursor, first declare the object variable that
will hold it and then set object from the cursor. Note that in the
following example the cursor <code>C</code> must have the shape defined
by <code>my_shape</code> or an error is produced. The type of the object
is crucial because, as we’ll see, during unboxing that type defines the
shape of the unboxed cursor.</p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- recap: declare the box that holds the cursor (T changed to my_shape for this example)</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> box_obj <span class="dt">object</span><span class="op">&lt;</span>my_shape <span class="kw">cursor</span><span class="op">&gt;</span>;</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- box the cursor into the object (the cursor shape must match the box shape)</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> box_obj <span class="kw">from</span> <span class="kw">cursor</span> C;</span></code></pre></div>
<p>The variable <code>box_obj</code> can now be passed around as usual.
It could be stored in a suitable <code>out</code> variable or it could
be passed to a procedure as an <code>in</code> parameter. Then, later,
you can “unbox” <code>box_obj</code> to get a cursor back. Like so</p>
<div class="sourceCode" id="cb206"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- unboxing a cursor from an object, the type of box_obj defines the type of the created cursor</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> D <span class="kw">cursor</span> <span class="cf">for</span> box_obj;</span></code></pre></div>
<p>These primitives will allow cursors to be passed around with general
purpose lifetime.</p>
<p>Example:</p>
<div class="sourceCode" id="cb207"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- consumes a cursor</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc cursor_user(box_obj <span class="dt">object</span><span class="op">&lt;</span>my_shape <span class="kw">cursor</span><span class="op">&gt;</span>)</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> box_obj;  <span class="co">-- the cursors shape will be my_shape matching box</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>   <span class="cf">loop</span> fetch C</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>   <span class="cf">begin</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- do something with C</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span>;</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- captures a cursor and passes it on</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc cursor_boxer()</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>   <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> something_like_my_shape;</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">declare</span> box_obj <span class="dt">object</span><span class="op">&lt;</span>my_shape <span class="kw">cursor</span><span class="op">&gt;</span></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> box <span class="kw">from</span> <span class="kw">cursor</span> C; <span class="co">-- produces error if shape doesn&#39;t match</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>   <span class="kw">call</span> cursor_user(box_obj);</span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Importantly, once you box a cursor the underlying SQLite statement’s
lifetime is managed by the box object with normal retain/release
semantics. The box and underlying statement can be released simply by
setting all references to it to null as usual.</p>
<p>With this pattern it’s possible to, for instance, create a cursor,
box it, consume some of the rows in one procedure, do some other stuff,
and then consume the rest of the rows in another different
procedure.</p>
<p>Important Notes:</p>
<ul>
<li>the underlying SQLite statement is shared by all references to it.
Unboxing does not reset the cursor’s position. It is possible, even
desirable, to have different procedures advancing the same cursor</li>
<li>there is no operation for “peeking” at a cursor without advancing
it; if your code requires that you inspect the row and then delegate it,
you can do this simply by passing the cursor data as a value rather than
the cursor statement. Boxing and unboxing are for cases where you need
to stream data out of the cursor in helper procedures</li>
<li>durably storing a boxed cursor (e.g. in a global) could lead to all
manner of problems – it is <em>exactly</em> like holding on to a
<code>sqlite3_stmt *</code> for a long time with all the same problems
because that is exactly is happening</li>
</ul>
<p>Summarizing, the main reason for using the boxing patterns is to
allow for standard helper procedures that can get a cursor from a
variety of places and process it. Boxing isn’t the usual pattern at all
and returning cursors in a box, while possible, should be avoided in
favor of the simpler patterns, if only because then then lifetime
management is very simple in all those cases.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-6-calling-procedures-defined-elsewhere">Chapter 6:
Calling Procedures Defined Elsewhere</h2>
<p>CQL generally doesn’t see the whole world in one compilation. In this
way it’s a lot more like, say, the C compiler than it is like, say, Java
or C# or something like that. This means several things:</p>
<ul>
<li>You don’t have to tell CQL about all your schema in all your files,
so particular stored procs can be more encapsulated</li>
<li>You can have different databases mounted in different places and CQL
won’t care; you provide the database connection to the stored procedures
when you call them, and that database is assumed to have the tables
declared in this translation unit</li>
<li>Several different schema can be maintained by CQL, even in the same
database, and they won’t know about each other</li>
</ul>
<p>To make this possible there are a few interesting features</p>
<h3 id="declaring-procedures-defined-elsewhere">Declaring Procedures
Defined Elsewhere</h3>
<p>Stored procedures defined in another file can be declared to CQL in
various ways for each major type of stored procedure. These are covered
in the sections below.</p>
<h3 id="simple-procedures-database-free">Simple Procedures (database
free):</h3>
<div class="sourceCode" id="cb208"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> foo(<span class="kw">id</span> <span class="dt">integer</span>, <span class="kw">out</span> name text <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>This introduces the symbol name without providing the body. This has
important variations.</p>
<h3 id="procedures-that-use-the-database">Procedures that use the
database</h3>
<div class="sourceCode" id="cb209"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> foo(<span class="kw">id</span> <span class="dt">integer</span>, <span class="kw">out</span> name text <span class="kw">not</span> <span class="kw">null</span>) <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span></code></pre></div>
<p>Most procedures you write will use SQLite in some fashion, maybe a
<code>select</code> or something. The <code>USING TRANSACTION</code>
annotation indicates that the proc in question uses the database and
therefore the generated code will need a database connection in-argument
and it will return a SQLite error code.</p>
<h3 id="procedures-that-create-a-result-set">Procedures that create a
result set</h3>
<p>If the procedure in question is going to use <code>select</code> or
<code>call</code> to create a result set, the type of that result set
has to be declared. An example might look like this:</p>
<div class="sourceCode" id="cb210"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC with_result_set () (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>                                 name TEXT,</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>                                 rate <span class="dt">LONG</span> <span class="dt">INTEGER</span>,</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">type</span> <span class="dt">INTEGER</span>,</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">size</span> <span class="dt">REAL</span>);</span></code></pre></div>
<p>This says that the procedure takes no arguments (other than the
implicit database connection) and it has an implicit out-argument that
can be read to get a result set with the indicated columns: id, name,
rate, type, and size. This form implies
<code>USING TRANSACTION</code>.</p>
<h3
id="procedures-that-return-a-single-row-with-a-value-cursor">Procedures
that return a single row with a value cursor</h3>
<p>If the procedure emits a cursor with the <code>OUT</code> statement
to produce a single row then it can be declared as follows:</p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC with_result_set () <span class="kw">OUT</span> (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>                                     name TEXT,</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>                                     rate <span class="dt">LONG</span> <span class="dt">INTEGER</span>,</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="kw">type</span> <span class="dt">INTEGER</span>,</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="kw">size</span> <span class="dt">REAL</span>);</span></code></pre></div>
<p>This form can have <code>USING TRANSACTION</code> or not, since it is
possible to emit a row with a value cursor and never use the database.
See the previous chapter for details on the <code>OUT</code>
statement.</p>
<h3 id="procedures-that-return-a-full-result-set">Procedures that return
a full result set</h3>
<p>If the procedure emits many rows with the <code>OUT UNION</code>
statement to produce a full result set then it can be declared as
follows:</p>
<div class="sourceCode" id="cb212"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC with_result_set () <span class="kw">OUT</span> <span class="kw">UNION</span> (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>                                     name TEXT,</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>                                     rate <span class="dt">LONG</span> <span class="dt">INTEGER</span>,</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="kw">type</span> <span class="dt">INTEGER</span>,</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="kw">size</span> <span class="dt">REAL</span>);</span></code></pre></div>
<p>This form can have <code>USING TRANSACTION</code> or not, since it is
possible to emit a rows with a value cursor and never use the database.
See the previous chapter for details on the <code>OUT UNION</code>
statement.</p>
<h3 id="exporting-declared-symbols-automatically">Exporting Declared
Symbols Automatically</h3>
<p>To avoid errors, the declarations for any given file can be
automatically created by adding something like
<code>--generate_exports</code> to the command line. This will require
an additonal file name to be passed in the <code>--cg</code> portion to
capture the exports.</p>
<p>That file can then be used with <code>#include</code> when you
combine the C pre-processor with CQL as is normally done.</p>
<p>Nomenclature is perhaps a bit weird here. You use
<code>--generate_exports</code> to export the stored procedure
declarations from the translation units. Of course those exported
symbols are what you then import in some other module. Sometimes this
output file is called <code>foo_imports.sql</code> because those exports
are of course exactly what you need to import <code>foo</code>. You can
use whatever convention you like of course, CQL doesn’t care. The full
command line might look something like this:</p>
<pre><code>cql --in foo.sql --cg foo.h foo.c foo_imports.sql --generate_exports</code></pre>
<p>Using the pre-processor you can get declarations from elsewhere with
a directive like this:</p>
<pre><code>#include &quot;foo_imports.sql&quot;</code></pre>
<h3 id="declaration-examples">Declaration Examples</h3>
<p>Here are some more examples directly from the CQL test cases; these
are all auto-generated with <code>--generate_exports</code>.</p>
<div class="sourceCode" id="cb215"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC test (i <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>);</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC out_test (<span class="kw">OUT</span> i <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="kw">OUT</span> ii <span class="dt">INTEGER</span>);</span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC outparm_test (<span class="kw">OUT</span> foo <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>) <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC select_from_view () (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="kw">type</span> <span class="dt">INTEGER</span>);</span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC make_view () <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC copy_int (a <span class="dt">INTEGER</span>, <span class="kw">OUT</span> b <span class="dt">INTEGER</span>);</span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC complex_return ()</span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>  (_bool BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>   _integer <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a>   _longint <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a>   _real <span class="dt">REAL</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>   _text TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>   _nullable_bool BOOL);</span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-21"><a href="#cb215-21" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC outint_nullable (</span>
<span id="cb215-22"><a href="#cb215-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> output <span class="dt">INTEGER</span>,</span>
<span id="cb215-23"><a href="#cb215-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> result BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb215-24"><a href="#cb215-24" aria-hidden="true" tabindex="-1"></a><span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb215-25"><a href="#cb215-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-26"><a href="#cb215-26" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC outint_notnull (</span>
<span id="cb215-27"><a href="#cb215-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> output <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-28"><a href="#cb215-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> result BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb215-29"><a href="#cb215-29" aria-hidden="true" tabindex="-1"></a><span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb215-30"><a href="#cb215-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-31"><a href="#cb215-31" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC obj_proc (<span class="kw">OUT</span> an_object <span class="dt">OBJECT</span>);</span>
<span id="cb215-32"><a href="#cb215-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-33"><a href="#cb215-33" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC insert_values (</span>
<span id="cb215-34"><a href="#cb215-34" aria-hidden="true" tabindex="-1"></a>  id_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb215-35"><a href="#cb215-35" aria-hidden="true" tabindex="-1"></a>  type_ <span class="dt">INTEGER</span>)</span>
<span id="cb215-36"><a href="#cb215-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span></code></pre></div>
<p>So far we’ve avoided discussing the generated C code in any details
but here it seems helpful to show exactly what these declarations
correspond to in the generated C to demystify all this. There is a very
straightforward conversion.</p>
<div class="sourceCode" id="cb216"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test<span class="op">(</span>cql_int32 i<span class="op">);</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> out_test<span class="op">(</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>  cql_int32 <span class="op">*</span>_Nonnull i<span class="op">,</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>  cql_nullable_int32 <span class="op">*</span>_Nonnull ii<span class="op">);</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>cql_code outparm_test<span class="op">(</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>  cql_int32 <span class="op">*</span>_Nonnull foo<span class="op">);</span></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>cql_code select_from_view_fetch_results<span class="op">(</span></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>  select_from_view_result_set_ref _Nullable <span class="op">*</span>_Nonnull result_set<span class="op">);</span></span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>cql_code make_view<span class="op">(</span>sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">);</span></span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> copy_int<span class="op">(</span>cql_nullable_int32 a<span class="op">,</span> cql_nullable_int32 <span class="op">*</span>_Nonnull b<span class="op">);</span></span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a>cql_code complex_return_fetch_results<span class="op">(</span></span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a>  complex_return_result_set_ref _Nullable <span class="op">*</span>_Nonnull result_set<span class="op">);</span></span>
<span id="cb216-22"><a href="#cb216-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-23"><a href="#cb216-23" aria-hidden="true" tabindex="-1"></a>cql_code outint_nullable<span class="op">(</span></span>
<span id="cb216-24"><a href="#cb216-24" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-25"><a href="#cb216-25" aria-hidden="true" tabindex="-1"></a>  cql_nullable_int32 <span class="op">*</span>_Nonnull output<span class="op">,</span></span>
<span id="cb216-26"><a href="#cb216-26" aria-hidden="true" tabindex="-1"></a>  cql_bool <span class="op">*</span>_Nonnull result<span class="op">);</span></span>
<span id="cb216-27"><a href="#cb216-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-28"><a href="#cb216-28" aria-hidden="true" tabindex="-1"></a>cql_code outint_notnull<span class="op">(</span></span>
<span id="cb216-29"><a href="#cb216-29" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-30"><a href="#cb216-30" aria-hidden="true" tabindex="-1"></a>  cql_int32 <span class="op">*</span>_Nonnull output<span class="op">,</span></span>
<span id="cb216-31"><a href="#cb216-31" aria-hidden="true" tabindex="-1"></a>  cql_bool <span class="op">*</span>_Nonnull result<span class="op">);</span></span>
<span id="cb216-32"><a href="#cb216-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-33"><a href="#cb216-33" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> obj_proc<span class="op">(</span></span>
<span id="cb216-34"><a href="#cb216-34" aria-hidden="true" tabindex="-1"></a>  cql_object_ref _Nullable <span class="op">*</span>_Nonnull an_object<span class="op">);</span></span>
<span id="cb216-35"><a href="#cb216-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-36"><a href="#cb216-36" aria-hidden="true" tabindex="-1"></a>cql_code insert_values<span class="op">(</span></span>
<span id="cb216-37"><a href="#cb216-37" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb216-38"><a href="#cb216-38" aria-hidden="true" tabindex="-1"></a>  cql_int32 id_<span class="op">,</span></span>
<span id="cb216-39"><a href="#cb216-39" aria-hidden="true" tabindex="-1"></a>  cql_nullable_int32 type_<span class="op">);</span></span></code></pre></div>
<p>As you can see, these declarations use exactly the normal SQLite
types and so it is very easy to declare a procedure in CQL and then
implement it yourself in straight C, simply by conforming to the
contract.</p>
<p>Importantly, SQLite does not know anything about CQL stored
procedures, or anything at all about CQL really so CQL stored procedure
names cannot be used in any way in SQL statements. CQL control flow like
the <code>call</code> statement can be used to invoke other procedures
and results can be captured by combing the <code>OUT</code> statement
and a <code>DECLARE CURSOR</code> construct but SQLite is not involved
in those things. This is another place where the inherent two-headed
nature of CQL leaks out.</p>
<p>Finally, this is a good place to reinforce that procedures with any
of the structured result types (<code>select</code>, <code>out</code>,
<code>out union</code>) can be used with a suitable cursor.</p>
<div class="sourceCode" id="cb217"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> get_stuff()</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> stuff;</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Can be used in two interesting ways:</p>
<div class="sourceCode" id="cb218"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> meta_stuff(meta bool)</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> meta <span class="cf">then</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> get_stuff();</span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> get_other_stuff();</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Assuming that <code>get_stuff</code> and <code>get_other_stuff</code>
have the same shape, then this procedure simply passes on one or the
other’s result set unmodified as its own return value.</p>
<p>But you could do more than simply pass on the result.</p>
<div class="sourceCode" id="cb219"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> meta_stuff(meta bool)</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">call</span> get_stuff();  <span class="co">-- or get_meta_stuff(...)</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch C</span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- do stuff with C</span></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- may be out union some of the rows after adjustment even</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Here we can see that we used the procedure to get the results and
then process them directly somehow.</p>
<p>And of course the result of an <code>OUT</code> can similarly be
processed using a value cursor, as previously seen.</p>
<p>These combinations allow for pretty general composition of stored
procedures so long as they are not recombined with SQLite
statements.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-7-cql-result-sets">Chapter 7: CQL Result Sets</h2>
<p>Most of this tutorial is about the CQL language itself but here we
must diverge a bit. The purpose of the result set feature of CQL is to
create a C interface to SQLite data. Because of this there are a lot of
essential details that require looking carefully at the generated C
code. Appendix 2 covers this code in even more detail but here it makes
sense to at least talk about the interface.</p>
<p>Let’s say we have this simple stored procedure:</p>
<div class="sourceCode" id="cb220"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, b bool, t text);</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc read_foo(id_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>We’ve created a simple data reader: this CQL code will cause the
compiler to generate helper functions to read the data and materialize a
result set.</p>
<p>Let’s look at the public interface of that result set now considering
the most essential pieces.</p>
<div class="sourceCode" id="cb221"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* this is almost everything in the generated header file */</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define read_foo_data_types_count </span><span class="dv">3</span></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>cql_result_set_type_decl<span class="op">(</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set<span class="op">,</span> \</span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set_ref<span class="op">);</span></span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_int32 read_foo_get_id<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_bool read_foo_get_b_is_null<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_bool read_foo_get_b_value<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_string_ref _Nullable read_foo_get_t<span class="op">(</span></span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a>   read_foo_result_set_ref  _Nonnull result_set<span class="op">,</span></span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>   cql_int32 row<span class="op">);</span></span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_int32 read_foo_result_count<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">);</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_code read_foo_fetch_results<span class="op">(</span>sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set_ref _Nullable <span class="op">*</span>_Nonnull result_set<span class="op">,</span></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a>  cql_int32 id_<span class="op">);</span></span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#define read_foo_row_hash</span><span class="op">(</span><span class="pp">result_set</span><span class="op">,</span><span class="pp"> row</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a><span class="pp">  cql_result_set_get_meta</span><span class="op">((</span><span class="pp">cql_result_set_ref</span><span class="op">)(</span><span class="pp">result_set</span><span class="op">))-&gt;\</span></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a><span class="pp">  rowHash</span><span class="op">((</span><span class="pp">cql_result_set_ref</span><span class="op">)(</span><span class="pp">result_set</span><span class="op">),</span><span class="pp"> row</span><span class="op">)</span></span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#define read_foo_row_equal</span><span class="op">(</span><span class="pp">rs1</span><span class="op">,</span><span class="pp"> row1</span><span class="op">,</span><span class="pp"> rs2</span><span class="op">,</span><span class="pp"> row2</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a><span class="pp">cql_result_set_get_meta</span><span class="op">((</span><span class="pp">cql_result_set_ref</span><span class="op">)(</span><span class="pp">rs1</span><span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a><span class="pp"> </span><span class="op">-&gt;</span><span class="pp">rowsEqual</span><span class="op">(</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a><span class="pp">   </span><span class="op">(</span><span class="pp">cql_result_set_ref</span><span class="op">)(</span><span class="pp">rs1</span><span class="op">),</span><span class="pp">  row1</span><span class="op">,</span><span class="pp">  </span><span class="op">\</span></span>
<span id="cb221-28"><a href="#cb221-28" aria-hidden="true" tabindex="-1"></a><span class="pp">   </span><span class="op">(</span><span class="pp">cql_result_set_ref</span><span class="op">)(</span><span class="pp">rs2</span><span class="op">),</span><span class="pp">  row2</span><span class="op">)</span></span></code></pre></div>
<p>Let’s consider some of these individually now</p>
<div class="sourceCode" id="cb222"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>cql_result_set_type_decl<span class="op">(</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set<span class="op">,</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set_ref<span class="op">);</span></span></code></pre></div>
<p>This declares the data type for <code>read_foo_result_set</code> and
the associated object reference <code>read_foo_result_set_ref</code>. As
it turns out, the underlying data type for all result sets is the same,
and only the shape of the data varies.</p>
<div class="sourceCode" id="cb223"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_code read_foo_fetch_results<span class="op">(</span>sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">,</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>  read_foo_result_set_ref _Nullable <span class="op">*</span>_Nonnull result_set<span class="op">,</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>  cql_int32 id_<span class="op">);</span></span></code></pre></div>
<p>The result set fetcher method gives you a
<code>read_foo_result_set_ref</code> if it succeeds. It accepts the
<code>id_</code> argument which it will internally pass along to
<code>read_foo(...)</code>. The latter function provides a
<code>sqlite3_stmt*</code> which can then be iterated in the fetcher.
This method is the main public entry point for result sets.</p>
<p>Once you have a result set, you can read values out of it.</p>
<div class="sourceCode" id="cb224"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_int32 read_foo_result_count<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">);</span></span></code></pre></div>
<p>That function tells you how many rows are in the result set.</p>
<p>For each row you can use any of the row readers:</p>
<div class="sourceCode" id="cb225"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_int32 read_foo_get_id<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_bool read_foo_get_b_is_null<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_bool read_foo_get_b_value<span class="op">(</span>read_foo_result_set_ref</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>  _Nonnull result_set<span class="op">,</span> cql_int32 row<span class="op">);</span></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> cql_string_ref _Nullable read_foo_get_t<span class="op">(</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>   read_foo_result_set_ref  _Nonnull result_set<span class="op">,</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>   cql_int32 row<span class="op">);</span></span></code></pre></div>
<p>These let you read the <code>id</code> of a particular row, and get a
<code>cql_int32</code> or you can read the nullable boolean, using the
<code>read_foo_get_b_is_null</code> function first to see if the boolean
is null and then <code>read_foo_get_b_value</code> to get the value.
Finally the string can be accessed with <code>read_foo_get_t</code>. As
you can see, there is a simple naming convention for each of the field
readers.</p>
<blockquote>
<p>NOTE: The compiler has runtime arrays that control naming conventions
as well as using CamelCasing. Additional customizations may be created
by adding new runtime arrays into the CQL compiler.</p>
</blockquote>
<p>Finally, also part of the public interface, are these macros:</p>
<div class="sourceCode" id="cb226"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define read_foo_row_hash</span><span class="op">(</span><span class="pp">result_set</span><span class="op">,</span><span class="pp"> row</span><span class="op">)</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define read_foo_row_equal</span><span class="op">(</span><span class="pp">rs1</span><span class="op">,</span><span class="pp"> row1</span><span class="op">,</span><span class="pp"> rs2</span><span class="op">,</span><span class="pp"> row2</span><span class="op">)</span></span></code></pre></div>
<p>These use the CQL runtime to hash a row or compare two rows from
identical result set types. Metadata included in the result set allows
general purpose code to work for every result set. Based on
configuration, result set copying methods can also be generated. When
you’re done with a result set you can use the
<code>cql_release(...)</code> method to free the memory.</p>
<p>Importantly, all of the rows from the query in the stored procedure
are materialized immediately and become part of the result set.
Potentially large amounts of memory can be used if a lot of rows are
generated.</p>
<p>The code that actually creates the result set starting from the
prepared statement is always the same. The essential parts are:</p>
<p>First, a constant array that holds the data types for each
column.</p>
<div class="sourceCode" id="cb227"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> read_foo_data_types<span class="op">[</span>read_foo_data_types_count<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32 <span class="op">|</span> CQL_DATA_TYPE_NOT_NULL<span class="op">,</span> <span class="co">// id</span></span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_BOOL<span class="op">,</span> <span class="co">// b</span></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// t</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>All references are stored together at the end of the row, so we only
need the count of references and the offset of the first one to do
operations like <code>cql_retain</code> or <code>cql_release</code> on
the row.</p>
<pre><code>#define read_foo_refs_offset cql_offsetof(read_foo_row, t) // count = 1</code></pre>
<p>Lastly we need metadata to tell us count of columns and the offset of
each column within the row.</p>
<div class="sourceCode" id="cb229"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> cql_uint16 read_foo_col_offsets<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>  cql_offsetof<span class="op">(</span>read_foo_row<span class="op">,</span> id<span class="op">),</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>  cql_offsetof<span class="op">(</span>read_foo_row<span class="op">,</span> b<span class="op">),</span></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>  cql_offsetof<span class="op">(</span>read_foo_row<span class="op">,</span> t<span class="op">)</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Using the above we can now write this fetcher</p>
<pre><code>CQL_WARN_UNUSED cql_code
read_foo_fetch_results(
  sqlite3 *_Nonnull _db_,
  read_foo_result_set_ref _Nullable *_Nonnull result_set,
  cql_int32 id_)
{
  sqlite3_stmt *stmt = NULL;
  cql_profile_start(CRC_read_foo, &amp;read_foo_perf_index);

  // we call the original procedure, it gives us a prepared statement
  cql_code rc = read_foo(_db_, &amp;stmt, id_);

  // this is everything you need to know to fetch the result
  cql_fetch_info info = {
    .rc = rc,
    .db = _db_,
    .stmt = stmt,
    .data_types = read_foo_data_types,
    .col_offsets = read_foo_col_offsets,
    .refs_count = 1,
    .refs_offset = read_foo_refs_offset,
    .rowsize = sizeof(read_foo_row),
    .crc = CRC_read_foo,
    .perf_index = &amp;read_foo_perf_index,
  };

  // this function does all the work, it cleans up if .rc is an error code.
  return cql_fetch_all_results(&amp;info, (cql_result_set_ref *)result_set);
}</code></pre>
<h3 id="results-sets-from-out-union">Results Sets From
<code>OUT UNION</code></h3>
<p>The <code>out</code> keyword was added for writing procedures that
produce a single row result set. With that, it became possible to make
any single row result you wanted, assembling it from whatever sources
you needed. That is an important case as single row results happen
frequently and they are comparatively easy to create and pass around
using C structures for the backing store. However, it’s not everything;
there are also cases where full flexibility is needed while producing a
standard many-row result set. For this we have <code>out union</code>
which was discussed fully in Chapter 5. Here we’ll discuss the code
generation behind that.</p>
<p>Here’s an example from the CQL tests:</p>
<div class="sourceCode" id="cb231"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc some_integers(<span class="kw">start</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">stop</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> <span class="kw">select</span> <span class="dv">1</span> v, <span class="dv">2</span> v_squared, <span class="ot">&quot;xx&quot;</span> some_text;</span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> i <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> i <span class="op">:=</span> <span class="kw">start</span>;</span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (i <span class="op">&lt;</span> <span class="kw">stop</span>)</span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>   fetch C(v, v_squared, junk) <span class="kw">from</span> <span class="kw">values</span> (i, i<span class="op">*</span>i, printf(<span class="ot">&quot;%d&quot;</span>, i));</span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">out</span> <span class="kw">union</span> C;</span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> i <span class="op">:=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a> <span class="cf">end</span>;</span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In this example the entire result set is made up out of thin air. Of
course any combination of this computation or data-access is possible,
so you can ultimately make any rows you want in any order using SQLite
to help you as much or as little as you need.</p>
<p>Virtually all the code pieces to do this already exist for normal
result sets. The important parts of the output code look like this in
your generated C.</p>
<p>We need a buffer to hold the rows we are going to accumulate; We use
<code>cql_bytebuf</code> just like the normal fetcher above.</p>
<div class="sourceCode" id="cb232"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This bit creates a growable buffer to hold the rows</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="co">// This is how we do all the other result sets, too</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>cql_bytebuf _rows_<span class="op">;</span></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>cql_bytebuf_open<span class="op">(&amp;</span>_rows_<span class="op">);</span></span></code></pre></div>
<p>We need to be able to copy the cursor into the buffer and retain any
internal references</p>
<pre><code>// This bit is what you get when you &quot;out union&quot; a cursor &quot;C&quot;
// first we +1 any references in the cursor then we copy its bits
cql_retain_row(C_);   // a no-op if there is no row in the cursor
if (C_._has_row_) cql_bytebuf_append(&amp;_rows_, (const void *)&amp;C_, sizeof(C_));</code></pre>
<p>Finally, we make the rowset when the procedure exits. If the
procedure is returning with no errors the result set is created,
otherwise the buffer is released. The global
<code>some_integers_info</code> has constants that describe the shape
produced by this procedure just like the other cases that produce a
result set.</p>
<pre><code>cql_results_from_data(_rc_,
                      &amp;_rows_,
                      &amp;some_integers_info,
                      (cql_result_set_ref *)_result_set_);</code></pre>
<p>The operations here are basically the same ones that will happen
inside of the standard helper <code>cql_fetch_all_results</code>, the
difference, of course, is that you write the loop manually and therefore
have full control of the rows as they go in to the result set.</p>
<p>In short, the overhead is pretty low. What you’re left with is pretty
much the base cost of your algorithm. The cost here is very similar to
what it would be for any other thing that make rows.</p>
<p>Of course, if you make a million rows, well, that would burn a lot of
memory.</p>
<h3 id="a-working-example">A Working Example</h3>
<p>Here’s a fairly simple example illustrating some of these concepts
including the reading of rowsets.</p>
<div class="sourceCode" id="cb235"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- hello.sql:</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc hello()</span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">create</span> <span class="kw">table</span> my_data(</span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>    pos <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>    txt text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-11"><a href="#cb235-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">2</span>, <span class="st">&#39;World&#39;</span>);</span>
<span id="cb235-12"><a href="#cb235-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">0</span>, <span class="st">&#39;Hello&#39;</span>);</span>
<span id="cb235-13"><a href="#cb235-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> my_data <span class="kw">values</span>(<span class="dv">1</span>, <span class="st">&#39;There&#39;</span>);</span>
<span id="cb235-14"><a href="#cb235-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-15"><a href="#cb235-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_data <span class="kw">order</span> <span class="kw">by</span> pos;</span>
<span id="cb235-16"><a href="#cb235-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>And this main code to open the database and access the procedure:</p>
<div class="sourceCode" id="cb236"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co">// main.c</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sqlite3.h&gt;</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;hello.h&quot;</span></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>db<span class="op">;</span></span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rc <span class="op">=</span> sqlite3_open<span class="op">(</span><span class="st">&quot;:memory:&quot;</span><span class="op">,</span> <span class="op">&amp;</span>db<span class="op">);</span></span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">/* not exactly world class error handling but that isn&#39;t the point */</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>  hello_result_set_ref result_set<span class="op">;</span></span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> hello_fetch_results<span class="op">(</span>db<span class="op">,</span> <span class="op">&amp;</span>result_set<span class="op">);</span></span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;error: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> rc<span class="op">);</span></span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>  cql_int32 result_count <span class="op">=</span> hello_result_count<span class="op">(</span>result_set<span class="op">);</span></span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span>cql_int32 row <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> row <span class="op">&lt;</span> result_count<span class="op">;</span> row<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>    cql_string_ref text <span class="op">=</span> hello_get_txt<span class="op">(</span>result_set<span class="op">,</span> row<span class="op">);</span></span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>    cql_alloc_cstr<span class="op">(</span>ctext<span class="op">,</span> text<span class="op">);</span></span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> row<span class="op">,</span> ctext<span class="op">);</span></span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>    cql_free_cstr<span class="op">(</span>ctext<span class="op">,</span> text<span class="op">);</span></span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>  cql_result_set_release<span class="op">(</span>result_set<span class="op">);</span></span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>  sqlite3_close<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>From these pieces you can make a working example like so:</p>
<div class="sourceCode" id="cb237"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ${cgsql} refers to the root directory of the CG-SQL sources</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="ex">cql</span> <span class="at">--in</span> hello.sql <span class="at">--cg</span> hello.h hello.c</span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cc</span> <span class="at">-o</span> hello <span class="at">-I</span> <span class="va">${cgsql}</span>/sources main.c hello.c <span class="va">${cgsql}</span>/sources/cqlrt.c <span class="at">-lsqlite3</span></span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./hello</span></span></code></pre></div>
<p>Additional demo code is available in <a
href="#appendix-10-cql-working-example">Appendix 10</a></p>
<h3 id="nested-result-sets-parentchild">Nested Result Sets
(Parent/Child)</h3>
<p>There are many cases where you might want to nest one result set
inside of another one. In order to do this ecomomically you must be able
to run a parent query and a child query and then link the child rows to
the parent rows. One way to do this is of course to run one query for
each “child” but then you end up with <code>O(n)</code> child queries
and if there are sub-children it would be <code>O(n*m)</code> and so
forth. What you really want to do here is something more like a join,
only without the cross-product part of the join. Many systems have such
features, sometimes they are called “chaptered rowsets” but in any case
there is a general need for such a thing.</p>
<p>To reasonably support nested results sets the CQL language has to be
extended a variety of ways, as discussed below.</p>
<p>Here are some things that happened along the way that are
interesting.</p>
<h4 id="cursor-types-and-result-types">Cursor Types and Result
Types</h4>
<p>One of the first problems we run into thinking about how a CQL
program might express pieces of a rowset and turn them into child
results is that a program must be able to hash a row, append row data,
and extract a result set from a key. These are the essential operations
required. In order to do anything at all with a child rowset, a program
must be able to describe its type. Result sets must appear in the type
system as well as in the runtime.</p>
<p>To address this we use an object type with a special “kind”, similar
to how boxed statements are handled. A result set has a type that looks
like this: <code>object &lt;proc_name set&gt;</code>. Here
<code>proc_name</code> must the the name of a procedure that returns a
result set and the object will represent a result set with the
corresponding columns in it.</p>
<h4 id="creating-new-cursor-types-from-existing-cursor-types">Creating
New Cursor Types From Existing Cursor Types</h4>
<p>In addition to creating result set types, the language must be able
to express cursors that capture the necessary parent/child column. These
are rows with all of the parent columns plus additional columns for the
child rows (note that you can have more than one child result set per
parent). So for instance you might have a list of people, and one child
result might be the details of the schools they attended and another
could be the details of the jobs they worked.</p>
<p>To accomplish this kind of shape, the language must be able to
describe a new output row is that is the same as the parent but includes
columns for the the child results, too. This is done using a cursor
declaration that comes from a typed name list. An example might be:</p>
<div class="sourceCode" id="cb238"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> (<span class="kw">id</span> <span class="dt">integer</span>, name text);</span></code></pre></div>
<p>Importantly, such constructs include the ability to reference
existing shapes by name. So we might create a cursor we need like
so:</p>
<div class="sourceCode" id="cb239"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> result <span class="kw">cursor</span> <span class="kw">like</span> (<span class="kw">like</span> parent_proc, child_result <span class="dt">object</span><span class="op">&lt;</span>child_proc <span class="kw">set</span><span class="op">&gt;</span>);</span></code></pre></div>
<p>Where the above indicates all the parent columns plus a child result
set. Or more than one child result set if needed.</p>
<p>In addition, the language needs a way to conveniently declare a
cursor that is only some of the columns of an existing cursor. In
particular, nested result sets require us to extract the columns that
link the parent and child result sets. The columns we will “join” on. To
accomplish this the language extends the familiar notion:</p>
<div class="sourceCode" id="cb240"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> D <span class="kw">cursor</span> <span class="kw">like</span> C;</span></code></pre></div>
<p>To the more general form:</p>
<div class="sourceCode" id="cb241"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> pks <span class="kw">cursor</span> <span class="kw">like</span> C(pk1, pk2);</span></code></pre></div>
<p>Which chooses just the named fields from <code>C</code> and makes a
cursor with only those. In this case this primary key fields,
<code>pk1</code> and <code>pk2</code>. Additionally, for completeness,
we add this form:</p>
<div class="sourceCode" id="cb242"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> vals <span class="kw">cursor</span> <span class="kw">like</span> C(<span class="op">-</span>pk1, <span class="op">-</span>pk2);</span></code></pre></div>
<p>To mean the cursor vals should have all the columns of <code>C</code>
except <code>pk1</code> and <code>pk2</code> i.e. all the “values”.</p>
<p>Using any number of intermediate construction steps, and maybe some
<code>declare X type ...</code> statements, any type can be formed from
existing shapes by adding and removing columns.</p>
<p>Having done the above we can load a cursor that has just the primary
keys with the usual form</p>
<div class="sourceCode" id="cb243"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>fetch pks <span class="kw">from</span> C(<span class="kw">like</span> pks);</span></code></pre></div>
<p>Which says we want to load <code>pks</code> from the fields of
<code>C</code>, but using only the columns of <code>pks</code>. That
operation is of course going to be an exact type match by
construction.</p>
<h4 id="cursor-arguments">Cursor Arguments</h4>
<p>In order to express the requisite parent/child join, the language
must be able to express operations like “hash a cursor” (any cursor) or
“store this row into the appropriate partition”. The language provides
no way to write functions that can take any cursor and dynamically do
things to it based on type information, but:</p>
<ul>
<li>we don’t need very many of them,</li>
<li>it’s pretty easy to do that job in C (or lua if lua codegen is being
used)</li>
</ul>
<p>The minimum requirement is that the language must be able to declare
a functions that takes a generic cursor argument and to call such
functions a generic cursor construct that has the necessary shape info.
This form does the job:</p>
<div class="sourceCode" id="cb244"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> cursor_hash(C <span class="kw">cursor</span>) <span class="dt">long</span> <span class="kw">not</span> <span class="kw">null</span>;</span></code></pre></div>
<p>And it can be used like so:</p>
<div class="sourceCode" id="cb245"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>let <span class="kw">hash</span> <span class="op">:=</span> cursor_hash(C); <span class="co">-- C is any cursor</span></span></code></pre></div>
<p>When such a call is made the C function <code>cursor_hash</code> is
passed a so-called “dynamic cursor” pointer which includes:</p>
<ul>
<li>a pointer to the data for the cursor</li>
<li>the count of fields</li>
<li>the names of the fields</li>
<li>the type/offset of every field in the cursor</li>
</ul>
<p>With this information you can (e.g.) generically do the hash by
applying a hash to each field and then combining all of those hashes.
This kind of function works on any cursor and all the extra data about
the shape that’s needed to make the call is static, so really the cost
of the call stays modest. Details of the dynamic cursor type are in
<code>cqlrt_common.h</code> and there are many example functions now in
the <code>cqlrt_common.c</code> file.</p>
<h4 id="the-specific-parentchild-functions">The Specific Parent/Child
Functions</h4>
<p>Three helper functions are used to do the parent/child join, they
are:</p>
<div class="sourceCode" id="cb246"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> FUNC cql_partition_create ()</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">CREATE</span> <span class="dt">OBJECT</span><span class="op">&lt;</span>partitioning<span class="op">&gt;</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> FUNC cql_partition_cursor (</span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>  part <span class="dt">OBJECT</span><span class="op">&lt;</span>partitioning<span class="op">&gt;</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">key</span> <span class="kw">CURSOR</span>,</span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">value</span> <span class="kw">CURSOR</span>)</span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>    BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> FUNC cql_extract_partition (</span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>  part <span class="dt">OBJECT</span><span class="op">&lt;</span>partitioning<span class="op">&gt;</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">key</span> <span class="kw">CURSOR</span>)</span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CREATE</span> <span class="dt">OBJECT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span></code></pre></div>
<p>The first function makes a new partitioning.</p>
<p>The second function hashes the key columns of a cursor (specified by
the key argument) and appends the values provided in the second argument
into a bucket for that key. By making a pass over the child rows a
procedure can easily create a partitioning with each unique key combo
having a buffer of all the matching rows.</p>
<p>The third function is used once the partitioning is done. Given a key
again, this time from the parent rows, a procedure can get the buffer it
had accumulated and then make a result set out of it and return
that.</p>
<p>Note that the third function returns a vanilla object type because it
could be returning a result set of any shape so a cast is required for
correctness.</p>
<h4 id="result-set-sugar">Result Set Sugar</h4>
<p>Using the features mentioned above a developer could now join
together any kind of complex parent and child combo as needed, but the
result would be a lot of error-prone code, To avoid this CQL adds
language sugar to do such partitionings automatically and type-safely,
like so:</p>
<div class="sourceCode" id="cb247"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- parent and child defined elsewhere</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc <span class="kw">parent</span>(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>) (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, a <span class="dt">integer</span>, b <span class="dt">integer</span>);</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc <span class="kw">child</span>(y <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>) (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, u text, v text);</span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- join together parent and child using &#39;id&#39;</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- example x_, y_ arguments for illustration only</span></span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc parent_child(x_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, y_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> <span class="kw">union</span> <span class="kw">call</span> <span class="kw">parent</span>(x_) <span class="kw">join</span> <span class="kw">call</span> <span class="kw">child</span>(y_) <span class="kw">using</span> (<span class="kw">id</span>);</span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The generated code is simple enough, even though there’s a good bit
of it. But it’s a useful exercise to look at it once. Comments added for
clarity.</p>
<div class="sourceCode" id="cb248"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC parent_child (x_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, y_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> __result__0 BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we need a cursor to hold just the key of the child row</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> __key__0 <span class="kw">CURSOR</span> <span class="kw">LIKE</span> <span class="kw">child</span>(<span class="kw">id</span>);</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we need our partitioning object (there could be more than one per function</span></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- so it gets a number, likewise everything else gets a number</span></span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>  LET __partition__0 <span class="op">:=</span> cql_partition_create();</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we invoke the child and then iterate its rows</span></span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> __child_cursor__0 <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">CALL</span> <span class="kw">child</span>(y_);</span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH __child_cursor__0</span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- we extract just the key fields (id in this case)</span></span>
<span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a>    FETCH __key__0(<span class="kw">id</span>) <span class="kw">FROM</span> <span class="kw">VALUES</span>(__child_cursor__0.<span class="kw">id</span>);</span>
<span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- we add this child to the partition using its key</span></span>
<span id="cb248-20"><a href="#cb248-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> __result__0 <span class="op">:=</span> cql_partition_cursor(__partition__0, __key__0, __child_cursor__0);</span>
<span id="cb248-21"><a href="#cb248-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb248-22"><a href="#cb248-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-23"><a href="#cb248-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we need a shape for our result, it is the columns of the parent plus the child rowset</span></span>
<span id="cb248-24"><a href="#cb248-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> __out_cursor__0 <span class="kw">CURSOR</span> <span class="kw">LIKE</span> (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, a <span class="dt">INTEGER</span>, b <span class="dt">INTEGER</span>,</span>
<span id="cb248-25"><a href="#cb248-25" aria-hidden="true" tabindex="-1"></a>                                       child1 <span class="dt">OBJECT</span><span class="op">&lt;</span><span class="kw">child</span> <span class="kw">SET</span><span class="op">&gt;</span> <span class="kw">NOT</span> <span class="kw">NULL</span>);</span>
<span id="cb248-26"><a href="#cb248-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-27"><a href="#cb248-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- now we call the parent and iterate it</span></span>
<span id="cb248-28"><a href="#cb248-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> __parent__0 <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">CALL</span> <span class="kw">parent</span>(x_);</span>
<span id="cb248-29"><a href="#cb248-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH __parent__0</span>
<span id="cb248-30"><a href="#cb248-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb248-31"><a href="#cb248-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- we load the key values out of the parent this time, same key fields</span></span>
<span id="cb248-32"><a href="#cb248-32" aria-hidden="true" tabindex="-1"></a>    FETCH __key__0(<span class="kw">id</span>) <span class="kw">FROM</span> <span class="kw">VALUES</span>(__parent__0.<span class="kw">id</span>);</span>
<span id="cb248-33"><a href="#cb248-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-34"><a href="#cb248-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- now we create a result row using the parent columns and the child result set</span></span>
<span id="cb248-35"><a href="#cb248-35" aria-hidden="true" tabindex="-1"></a>    FETCH __out_cursor__0(<span class="kw">id</span>, a, b, child1) <span class="kw">FROM</span> <span class="kw">VALUES</span>(__parent__0.<span class="kw">id</span>, __parent__0.a, __parent__0.b, cql_extract_partition(__partition__0, __key__0));</span>
<span id="cb248-36"><a href="#cb248-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-37"><a href="#cb248-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- and then we emit that row</span></span>
<span id="cb248-38"><a href="#cb248-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">OUT</span> <span class="kw">UNION</span> __out_cursor__0;</span>
<span id="cb248-39"><a href="#cb248-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb248-40"><a href="#cb248-40" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>This code iterates the child once and the parent once and only has
two database calls, one for the child and one for the parent. And this
is enough to create parent/child result sets for the most common
examples.</p>
<h4 id="result-set-values">Result Set Values</h4>
<p>While the above is probably the most common case, a developer might
also want to make a procedure call for each parent row to compute the
child. And, more generally, to work with result sets from procedure
calls other than iterating them with a cursor.</p>
<p>The iteration pattern:</p>
<div class="sourceCode" id="cb249"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">call</span> foo(args);</span></code></pre></div>
<p>is very good if the data is coming from (e.g.) a select statement and
we don’t want to materialize all of the results if we can stream
instead. However, when working with result sets the whole point is to
create materialized results for use elsewhere.</p>
<p>Since we can express a result set type with
<code>object&lt;proc_name set&gt;</code> the language also includes the
ability to call a procedure that returns a result set and capture that
result. This yields these forms:</p>
<div class="sourceCode" id="cb250"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> child_result <span class="dt">object</span><span class="op">&lt;</span><span class="kw">child</span> <span class="kw">set</span><span class="op">&gt;</span>;</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> child_result <span class="op">:=</span> <span class="kw">child</span>(args);</span></code></pre></div>
<p>or better still:</p>
<div class="sourceCode" id="cb251"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>let child_result <span class="op">:=</span> <span class="kw">child</span>(args);</span></code></pre></div>
<p>And more generally, this examples shows a manual iteration:</p>
<div class="sourceCode" id="cb252"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc <span class="kw">parent</span>(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>) (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, a <span class="dt">integer</span>, b <span class="dt">integer</span>);</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc <span class="kw">child</span>(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>) (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, u text, v text);</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc parent_child(x_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, y_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- the result is like the parent with an extra column for the child</span></span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> result <span class="kw">cursor</span> <span class="kw">like</span> (<span class="kw">like</span> <span class="kw">parent</span>, <span class="kw">child</span> <span class="dt">object</span><span class="op">&lt;</span><span class="kw">child</span> <span class="kw">set</span><span class="op">&gt;</span>);</span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- call the parent and loop over the results</span></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> P <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">call</span> <span class="kw">parent</span>(x_);</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch P</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>     <span class="co">-- compute the child for each P and then emit it</span></span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a>     fetch result <span class="kw">from</span> <span class="kw">values</span>(<span class="kw">from</span> P, <span class="kw">child</span>(P.<span class="kw">id</span>));</span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>     <span class="kw">out</span> <span class="kw">union</span> result;</span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>After the sugar is applied to expand the types out, the net program
is the following:</p>
<div class="sourceCode" id="cb253"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC <span class="kw">parent</span> (x <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>) (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, a <span class="dt">INTEGER</span>, b <span class="dt">INTEGER</span>);</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC <span class="kw">child</span> (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>) (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, u TEXT, v TEXT);</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC parent_child (x_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, y_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> result <span class="kw">CURSOR</span> <span class="kw">LIKE</span> (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, a <span class="dt">INTEGER</span>, b <span class="dt">INTEGER</span>,</span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">child</span> <span class="dt">OBJECT</span><span class="op">&lt;</span><span class="kw">child</span> <span class="kw">SET</span><span class="op">&gt;</span>);</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> P <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">CALL</span> <span class="kw">parent</span>(x_);</span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH P</span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>    FETCH result(<span class="kw">id</span>, a, b, <span class="kw">child</span>) <span class="kw">FROM</span> <span class="kw">VALUES</span>(P.<span class="kw">id</span>, P.a, P.b, <span class="kw">child</span>(P.<span class="kw">id</span>));</span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">OUT</span> <span class="kw">UNION</span> result;</span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Note the <code>LIKE</code> and <code>FROM</code> forms are make it a
lot easier to express this notion of just adding one more column to the
result. The code for emitting the <code>parent_child</code> result
doesn’t need to specify the columns of the parent or the columns of the
child, only that the parent has at least the <code>id</code> column.
Even that could have been removed.</p>
<p>This call could have been used instead:</p>
<div class="sourceCode" id="cb254"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>fetch result <span class="kw">from</span> <span class="kw">values</span>(<span class="kw">from</span> P, <span class="kw">child</span>(<span class="kw">from</span> P <span class="kw">like</span> <span class="kw">child</span> arguments));</span></code></pre></div>
<p>That syntax would result in using the columns of P that match the
arguments of <code>child</code> – just <code>P.id</code> in this case.
But if there were many such columns the sugar would be easier to
understand and much less error prone.</p>
<h4 id="generated-code-details">Generated Code Details</h4>
<p>Normally all result sets that have an object type in them use a
generic object <code>cql_object_ref</code> as their C data type. This
isn’t wrong exactly but it would mean that a cast would be required in
every use case on the native side, and it’s easy to get the cast wrong.
So the result type of column getters is adjusted to be a
<code>child_result_set_ref</code> instead of just
<code>cql_object_ref</code> where <code>child</code> is the name of the
child procedure.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-8-functions">Chapter 8: Functions</h2>
<p>CQL stored procs have a very simple contract so it is easy to declare
procedures and then implement them in regular C; the C functions just
have to conform to the contract. However, CQL procedures have their own
calling conventions and this makes it very inconvenient to use external
code that is not doing database things and wants to return values. Even
a random number generator or something would be difficult to use because
it could not be called in the context of an expression. To allow for
this CQL adds declared functions</p>
<p>In another example of the two-headed nature of CQL, there are two
ways to declare functions. As we have already seen you can make
function-like procedures and call them like functions simply by making a
procedure with an <code>out</code> parameter. However, there are also
cases where it is reasonable to make function calls to external
functions of other kinds. There are three major types of functions you
might wish to call.</p>
<h3 id="function-types">Function Types</h3>
<h4 id="ordinary-scalar-functions">Ordinary Scalar Functions</h4>
<p>These functions are written in regular C and provide for the ability
to do operations on in-memory objects. For instance, you could create
functions that allow you to read and write from a dictionary. You can
declare these functions like so:</p>
<div class="sourceCode" id="cb255"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> dict_get_value(dict <span class="dt">object</span>, key_ text <span class="kw">not</span> <span class="kw">null</span>) text;</span></code></pre></div>
<p>Such a function is not known to SQLite and therefore cannot appear in
SQL statements. CQL will enforce this.</p>
<p>The above function returns a text reference, and, importantly, this
is a borrowed reference. The dictionary is presumably holding on to the
reference and as long as it is not mutated the reference is valid. CQL
will retain this reference as soon as it is stored and release it
automatically when it is out of scope. So, in this case, the dictionary
continues to own the object.</p>
<p>It is also possible to declare functions that create objects. Such as
this example:</p>
<div class="sourceCode" id="cb256"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> dict_create() <span class="kw">create</span> <span class="dt">object</span>;</span></code></pre></div>
<p>This declaration tells CQL that the function will create a new object
for our use. CQL does not retain the provided object, rather assuming
ownership of the presumably one reference count the object already has.
When the object goes out of scope it is released as usual.</p>
<p>If we also declare this procedure:</p>
<div class="sourceCode" id="cb257"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">procedure</span> dict_add(</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>    dict <span class="dt">object</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    key_ text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">value</span> text <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>then with this family of declarations we could write something like
this:</p>
<div class="sourceCode" id="cb258"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc create_and_init(<span class="kw">out</span> dict <span class="dt">object</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> dict <span class="op">:=</span> dict_create();</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> dict_add(dict, <span class="ot">&quot;k1&quot;</span>, <span class="ot">&quot;v1&quot;</span>);</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> dict_add(dict, <span class="ot">&quot;k2&quot;</span>, <span class="ot">&quot;v2&quot;</span>);</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (dict_get_value(dict, <span class="ot">&quot;k1&quot;</span>) <span class="op">==</span> dict__get_value(dict, <span class="ot">&quot;k2&quot;</span>)) <span class="cf">then</span></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> printf(<span class="ot">&quot;insanity has ensued\n&quot;</span>);</span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<blockquote>
<p>NOTE: Ordinary scalar functions may not use the database in any way.
When they are invoked they will not be provided with the database
pointer and so they will be unable to do any database operations. To do
database operations, use regular procedures. You can create a
function-like-procedure using the <code>out</code> convention discussed
previously.</p>
</blockquote>
<h4 id="sql-scalar-functions">SQL Scalar Functions</h4>
<p>SQLite includes the ability to add new functions to its expressions
using <code>sqlite3_create_function</code>. In order to use this
function in CQL, you must also provide its prototype definition to the
compiler. You can do so following this example:</p>
<div class="sourceCode" id="cb259"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> strencode(t text <span class="kw">not</span> <span class="kw">null</span>) text <span class="kw">not</span> <span class="kw">null</span>;</span></code></pre></div>
<p>This introduces the function <code>strencode</code> to the compiler
for use in SQL constructs. With this done you could write a procedure
something like this:</p>
<div class="sourceCode" id="cb260"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(<span class="kw">id</span> <span class="dt">integer</span>, t text);</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> bar(id_ <span class="dt">integer</span>)</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">select</span> strencode(T1.t) <span class="kw">from</span> foo T1 <span class="kw">where</span> T1.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This presumably returns the “encoded” text, whatever that might be.
Note that if <code>sqlite3_create_function</code> is not called before
this code runs, a run-time error will ensue. Just as CQL must assume
that declared tables really are created, it also assumes that declared
function really are created. This is another case of telling the
compiler in advance what the situation will be at runtime.</p>
<p>SQLite allows for many flexible kinds of user defined functions. CQL
doesn’t concern itself with the details of the implementation of the
function, it only needs the signature so that it can validate calls.</p>
<p>Note that SQL Scalar Functions cannot contain <code>object</code>
parameters. To pass an <code>object</code>, you should instead pass the
memory address of this object using a <code>LONG INT</code> parameter.
To access the address of an <code>object</code> at runtime, you should
use the <code>ptr()</code> function. See <a
href="#notes-on-builtin-functions">the notes section below</a> for more
information.</p>
<p>See also: <a
href="https://www.sqlite.org/c3ref/create_function.html">Create Or
Redefine SQL Functions</a>.</p>
<h4 id="sql-table-valued-functions">SQL Table Valued Functions</h4>
<p>More recent versions of SQLite also include the ability to add
table-valued functions to statements in place of actual tables. These
functions can use their arguments to create a “virtual table” value for
use in place of a table. For this to work, again SQLite must be told of
the existence of the table. There are a series of steps to make this
happen beginning with <code>sqlite3_create_module</code> which are
described in the SQLite documents under “The Virtual Table Mechanism Of
SQLite.”</p>
<p>Once that has been done, a table-valued function can be defined for
most object types. For instance it is possible to create a table-valued
function like so:</p>
<div class="sourceCode" id="cb261"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> dict_contents(dict <span class="dt">object</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>   (k text <span class="kw">not</span> <span class="kw">null</span>, v text <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>This is just like the previous type of select function but the return
type is a table shape. Once the above has been done you can legally
write something like this:</p>
<div class="sourceCode" id="cb262"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc read_dict(dict <span class="dt">object</span> <span class="kw">not</span> <span class="kw">null</span>, pattern text)</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> pattern <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span> <span class="cf">then</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> k, v <span class="kw">from</span> dict_contents(dict) T1 <span class="kw">where</span> T1.k <span class="kw">LIKE</span> pattern;</span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> k, v <span class="kw">from</span> dict_contents(dict);</span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This construct is very general indeed but the runtime set up for it
is much more complicated than scalar functions and only more modern
versions of SQLite even support it.</p>
<h3 id="sql-functions-with-unchecked-parameter-types">SQL Functions with
Unchecked Parameter Types</h3>
<p>Certain SQL functions like <a
href="https://www.sqlite.org/json1.html#jex"><code>json_extract</code></a>
are variadic (they accept variable number of arguments). To use such
functions within CQL, you can declare a SQL function to have untyped
parameters by including the <code>NO CHECK</code> clause instead of
parameter types.</p>
<p>For example:</p>
<div class="sourceCode" id="cb263"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> json_extract <span class="kw">no</span> <span class="kw">check</span> text;</span></code></pre></div>
<p>This is also supported for SQL table-valued functions:</p>
<div class="sourceCode" id="cb264"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> table_valued_function <span class="kw">no</span> <span class="kw">check</span> (t text, i <span class="dt">int</span>);</span></code></pre></div>
<blockquote>
<p>NOTE: currently the <code>NO CHECK</code> clause is not supported for
non SQL <a href="#Ordinary-Scalar-Functions">Ordinary Scalar
Functions</a>.</p>
</blockquote>
<h3 id="notes-on-builtin-functions">Notes on Builtin Functions</h3>
<p>Some of the SQLite builtin functions are hard-coded; these are the
functions that have semantics that are not readily captured with a
simple prototype. Other SQLite functions can be declared with
<code>declare select function ...</code> and then used.</p>
<p>CQL’s hard-coded builtin list includes:</p>
<p><em>Aggregate Functions</em></p>
<ul>
<li>count</li>
<li>max</li>
<li>min</li>
<li>sum</li>
<li>total</li>
<li>avg</li>
<li>group_concat</li>
</ul>
<p><em>Scalar Functions</em></p>
<ul>
<li>ifnull</li>
<li>nullif</li>
<li>upper</li>
<li>char</li>
<li>abs</li>
<li>instr</li>
<li>coalesce</li>
<li>last_insert_rowid</li>
<li>printf</li>
<li>strftime</li>
<li>date</li>
<li>time</li>
<li>datetime</li>
<li>julianday</li>
<li>substr</li>
<li>replace</li>
<li>round</li>
<li>trim</li>
<li>ltrim</li>
<li>rtrim</li>
</ul>
<p><em>Window Functions</em></p>
<ul>
<li>row_number</li>
<li>rank</li>
<li>dense_rank</li>
<li>percent_rank</li>
<li>cume_dist</li>
<li>ntile</li>
<li>lag</li>
<li>lead</li>
<li>first_value</li>
<li>last_value</li>
<li>nth_value</li>
</ul>
<p>Special Functions * nullable * sensitive * ptr</p>
<p><code>Nullable</code> casts an operand to the nullable version of its
type and otherwise does nothing. This cast might be useful if you need
an exact type match in a situation. It is stripped from any generated
SQL and generated C so it has no runtime effect at all other than the
indirect consequences of changing the storage class of its operand.</p>
<p><code>Sensitive</code> casts an operand to the sensitive version of
its type and otherwise does nothing. This cast might be useful if you
need an exact type match in a situation. It is stripped from any
generated SQL and generated C so it has no runtime effect at all other
than the indirect consequences of changing the storage class of its
operand.</p>
<p><code>Ptr</code> is used to cause a reference type variable to be
bound as a long integer to SQLite. This is a way of giving object
pointers to SQLite UDFs. Not all versions of Sqlite support binding
object variables, so passing memory addresses is the best we can do on
all versions.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-9-statements-summary-and-error-checking">Chapter 9:
Statements Summary and Error Checking</h2>
<p>The following is a brief discussion of the major statement types and
the semantic rules that CQL enforces for each of the statements. A
detailed discussion of SQL statements (the bulk of these) is beyond the
scope of this document and you should refer to the SQLite documentation
for most details. However, in many cases CQL does provide additional
enforcement and it is helpful to describe the basic checking that
happens for each fragment of CQL. A much more authoritative list of the
things CQL checks for can be inferred from the error documentation.
“Tricky” errors have examples and suggested remediation.</p>
<h3 id="the-primary-sql-statements">The Primary SQL Statements</h3>
<p>These are, roughly, the statements that involve the database.</p>
<h4 id="the-select-statement">The <code>SELECT</code> Statement</h4>
<p>Top level statement list processing for select. This is easily the
hardest statement to process. Each clause has its own set of complex
rules and the result of previous clauses constrains the next in a
complex fashion. Among the things that are verified: * the mentioned
tables exist and have the mentioned columns * the columns are type
compatible in their context * any variables in the expressions are
compatible * aggregate functions are used only in places where
aggregation makes sense * column and table names are unambiguous,
especially when self-joins are involved * compound selects (e.g. with
UNION) are type-consistent in all the fragments * the projection of a
select has unique column labels if they are used</p>
<h4 id="the-select-statement-1">The <code>SELECT *</code> Statement</h4>
<p><code>SELECT *</code> is special in that it creates its own struct
type by assembling all the columns of all the tables in the select’s
join result. CQL rewrites these column names into a new
<code>SELECT</code> with the specific columns explicitly listed. While
this makes the program slightly bigger it means that logically deleted
columns are never present in results because <code>SELECT *</code> won’t
select them and attempting to use a logically deleted column results in
an error.</p>
<h4 id="the-create-table-statement">The <code>CREATE TABLE</code>
Statement</h4>
<p>Unlike the other parts of DDL we actually deeply care about the
tables. We have to grab all the columns and column types out of it and
create the appropriate structure type for the table. Along the way we
validate a bunch of stuff like: * verify unique table name * no
duplicate column names * recursive correctness of constraints (see
constraints discussion below)</p>
<h5 id="the-unique-key-clause">The <code>UNIQUE KEY</code> Clause</h5>
<p>Similar to other constraints, we don’t actually do anything with this
other than offer some validation. Again, we use the usual helpers for
name lookup within the context of the table that contains the
constraint.</p>
<h5 id="the-foreign-key-clause">The <code>FOREIGN KEY</code> Clause</h5>
<p>Similar to other constraints, we don’t actually do anything with this
other than offer some validation. Again, we use the usual helpers for
name lookup within the context of the table with the foreign key. Note
that the foreign key has to be validated against two tables to fully
validate it.</p>
<h5 id="the-primary-key-clause">The <code>PRIMARY KEY</code> Clause</h5>
<p>Similar to other constraints, we don’t actually do anything with this
other than offer some validation. Again, we use the usual helpers for
name lookup within the context of the table with the primary key.</p>
<h5 id="the-check-clause">The <code>CHECK</code> Clause</h5>
<p>Similar to other constraints, we don’t actually do anything with this
other than offer some validation. The <code>CHECK</code> clause is
validated after the entire table has been processed so that even if it
appears early in the table, the clause can use any columns defined later
in the table.</p>
<h4 id="the-create-index-statement">The <code>CREATE INDEX</code>
Statement</h4>
<p>CQL doesn’t really do anything with indices but we do validate that
they make sense (so we lookup all the names of all the columns and so
forth.)</p>
<h4 id="the-create-view-statement">The <code>CREATE VIEW</code>
Statement</h4>
<p>Create view analysis is very simple because the <code>select</code>
analysis does the heavy lifting. All we have to do is validate that the
view is unique, then validate the select statement.</p>
<p>Additionally, views must not be allowed to have any NULL type
columns; all nulls must be converted to some type with a CAST.
e.g. <code>create view foo as select NULL n</code> is not valid. NULL is
not a real storage type.</p>
<h4 id="the-create-trigger-statement">The <code>CREATE TRIGGER</code>
Statement</h4>
<p>The create trigger statement is quite a beast, and validations
include: * The trigger name must be unique * For <code>insert</code> the
“new.<em>” table is available in expressions/statement </em> For
<code>delete</code> the”old.<em>” table is available in
expressions/statements </em> For <code>update</code> both are available
* If optional columns present in the <code>update</code>, they must be
unique/valid * The <code>when</code> expression must evaluate to a
numeric * The statement list must be error free with the usual rules
plus new/old * The <code>raise</code> function may be used inside a
trigger (NYI) * The table name must be a table (not a view) UNLESS the
trigger type is <code>INSTEAD OF</code> * Select statements inside the
statement block do not count as returns for the procedure and that
includes the create trigger</p>
<h4 id="the-drop-table-statement">The <code>DROP TABLE</code>
Statement</h4>
<p>This is the basic checking for the drop table statement: * the table
must exist in some version * it has to be a table and not a view</p>
<h4 id="the-drop-view-statement">The <code>DROP VIEW</code>
Statement</h4>
<p>This is the basic checking for the drop view statement: * the view
must exist in some version * it has to be a view and not a table</p>
<h4 id="the-drop-index-statement">The <code>DROP INDEX</code>
Statement</h4>
<p>This is the basic checking for the drop index statement: * the index
must exist in some version * it could be deleted now, that’s ok, but the
name has to be valid</p>
<h4 id="the-drop-trigger-statement">The <code>DROP TRIGGER</code>
Statement</h4>
<p>This is the basic checking for the drop trigger statement * the
trigger must exist in some version * it could be deleted now, that’s ok,
but the name has to be valid</p>
<h4 id="the-raise-statement">The <code>RAISE</code> Statement</h4>
<p>CQL validates that <code>RAISE</code> is being used in the context of
a trigger and that it has the correct arguments</p>
<h4 id="the-alter-table-add-column-statement">The
<code>ALTER TABLE ADD COLUMN</code> Statement</h4>
<p>To validate <code>alter table add column</code> we check the
following: * the table must exist and not be a view (in any version) *
the column definition of the new column must be self-consistent * no
auto-increment columns may be added * added columns must be either
nullable or have a default value</p>
<blockquote>
<p>NOTE: Alter statements are typically used in the context of
migration, so it’s possible the table that is mentioned is condemned in
a future version. We still have to run the intervening upgrade steps so
basically DDL gets to ignore the current deadness of the table as in
context it might be “not dead yet”. This will be more obvious in the
context of the schema maintenance features. (q.v.)</p>
</blockquote>
<h4 id="the-delete-statement">The <code>DELETE</code> Statement</h4>
<p>The delete analyzer sets up a scope for the table being deleted and
then validates the WHERE clause, if present, against that scope.
Additionally, we verify that the table actually was defined and is not a
view.</p>
<h4 id="the-update-statement">The <code>UPDATE</code> Statement</h4>
<p>The update analyzer sets up the scope for the table(s) being updated.
If there are optional clauses (e.g. <code>LIMIT</code>), they are
evaluated just like in a select statement with those same helper
methods. Expression fragments are evaluated similarly as in a select
statement.</p>
<h4 id="the-insert-statement">The <code>INSERT</code> Statement</h4>
<p>We check that the table exists and then we walk the columns and the
value list to make sure they are valid for the table. Also, we cannot
insert into a view.</p>
<p>Details: * The column list specifies the columns we will provide;
they must exist and be unique. * The columns specified must suffice to
insert a row (all not nulls and not default present.) * The insert list
specifies the values that are to be inserted. * The type of each value
must match the type of the column. * Auto-increment columns may be
specified as NULL. * If there are too many or too few columns, that is
considered an error. * If no columns are specified, that is the same as
if all columns had been specified, in table order.</p>
<h4 id="the-throw-statement">The <code>THROW</code> Statement</h4>
<p>Throw can literally go anywhere, so it’s always ok.</p>
<h4 id="the-begin-transaction-statement">The
<code>BEGIN TRANSACTION</code> Statement</h4>
<p>Begin transaction can go anywhere, so it’s always ok.</p>
<p>The sqlite documentation can be helpful here (CQL syntax is a
subset). See: https://www.sqlite.org/lang_transaction.html</p>
<h4 id="the-commit-transaction-statement">The
<code>COMMIT TRANSACTION</code> Statement</h4>
<p>Commit transaction can go anywhere, so it’s always ok.</p>
<p>The sqlite documentation can be helpful here (CQL syntax is a
subset). See: https://www.sqlite.org/lang_transaction.html</p>
<h4 id="the-rollback-transaction-statement">The
<code>ROLLBACK TRANSACTION</code> Statement</h4>
<p>Rollback transaction can go anywhere but if you’re using the format
where you rollback to a particular save point, then we must have seen
that name in a <code>savepoint</code> statement previously. Otherwise,
it’s an error.</p>
<p>The sqlite documentation can be helpful here again (CQL syntax is a
subset). See: https://www.sqlite.org/lang_transaction.html</p>
<h4 id="the-savepoint-statement">The <code>SAVEPOINT</code>
Statement</h4>
<p>The <code>savepoint</code> statement can go anywhere but we do record
this savepoint name as having been seen, so that we can verify it in
rollback. So this is sort of a weak declaration of the savepoint
name.</p>
<p>The sqlite documentation can be helpful here (CQL syntax is a
subset). https://www.sqlite.org/lang_savepoint.html</p>
<h4 id="the-release-savepoint-statement">The
<code>RELEASE SAVEPOINT</code> Statement</h4>
<p>Release savepoint can go anywhere but we must have seen that name in
a previous <code>savepoint</code> statement, otherwise it’s an
error.</p>
<p>The sqlite documentation can be helpful here (CQL syntax is a
subset). https://www.sqlite.org/lang_savepoint.html</p>
<h4 id="the-procedure-savepoint-statement">The
<code>PROCEDURE SAVEPOINT</code> Statement</h4>
<p>A common pattern is to have a savepoint associated with a particular
procedure. The savepoint’s scope is the same as the procedure’s scope.
More precisely</p>
<div class="sourceCode" id="cb265"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> foo()</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>  proc <span class="kw">savepoint</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- your code</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>becomes:</p>
<div class="sourceCode" id="cb266"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> foo()</span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">savepoint</span> @proc;  <span class="co">-- @proc is always the name of the current procedure</span></span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> try</span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- your code</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>    release <span class="kw">savepoint</span> @proc;</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> try;</span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span> catch</span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rollback</span> <span class="kw">transaction</span> <span class="kw">to</span> <span class="kw">savepoint</span> @proc;</span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>    release <span class="kw">savepoint</span> @proc;</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>    throw;</span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> catch;</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This form is not quite syntactic sugar because there are some
interesting rules:</p>
<ul>
<li>the <code>proc savepoint</code> form must be used at the top level
of the procedure, hence no <code>leave</code> or <code>continue</code>
may escape it</li>
<li>within <code>begin</code>/<code>end</code> the <code>return</code>
form may not be used; you must use <code>rollback return</code> or
<code>commit return</code> (see below)</li>
<li><code>throw</code> may be used to return an error as usual</li>
<li><code>proc savepoint</code> may be used again, at the top level, in
the same procedure, if there are, for instance, several sequential
stages</li>
<li>a procedure using <code>proc savepoint</code> could call another
such procedure, or a procedure that manipulates savepoints in some other
way</li>
</ul>
<h4 id="the-rollback-return-statement">The <code>ROLLBACK RETURN</code>
Statement</h4>
<p>This form may be used only inside of a <code>proc savepoint</code>
block. It indicates that the savepoint should be rolled back and then
the procedure should return. It is exactly equivalent to:</p>
<div class="sourceCode" id="cb267"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">rollback</span> <span class="kw">transaction</span> <span class="kw">to</span> <span class="kw">savepoint</span> @proc;</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  release <span class="kw">savepoint</span> @proc;</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span>; <span class="co">-- wouldn&#39;t actually be allowed inside of proc savepoint; see note below</span></span></code></pre></div>
<blockquote>
<p>NOTE: to avoid errors, the loose <code>return</code> above is not
actually allowed inside of <code>proc savepoint</code> – you must use
<code>rollback return</code> or <code>commit return</code>.</p>
</blockquote>
<h4 id="the-commit-return-statement">The <code>COMMIT RETURN</code>
Statement</h4>
<p>This form may be used only inside of a <code>proc savepoint</code>
block. It indicates that the savepoint should be released and then the
procedure should return. It is exactly equivalent to:</p>
<div class="sourceCode" id="cb268"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>  release <span class="kw">savepoint</span> @proc;</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span>; <span class="co">-- wouldn&#39;t actually be allowed inside of proc savepoint; see note below</span></span></code></pre></div>
<p>Of course this isn’t exactly a commit, in that there might be an
outer savepoint or outer transaction that might still be rolled back,
but it is commited at its level of nesting, if you will. Or,
equivalently, you can think of it as merging the savepoint into the
transaction in flight.</p>
<blockquote>
<p>NOTE: to avoid errors, the loose <code>return</code> above is not
actually allowed inside of <code>proc savepoint</code> and you must use
<code>rollback return</code> or <code>commit return</code>.</p>
</blockquote>
<h4 id="the-create-virtual-table-statement">The
<code>CREATE VIRTUAL TABLE</code> Statement</h4>
<p>The SQLite <code>CREATE VIRTUAL TABLE</code> form
(https://sqlite.org/lang_createvtab.html) is problematic from CQL
because:</p>
<ul>
<li>it is not parseable, because the module arguments can be literally
anything (or nothing), even a letter to your grandma</li>
<li>the arguments do not necessarily say anything about the table’s
schema at all</li>
</ul>
<p>So the CQL form departs from the standard syntax to this form:</p>
<div class="sourceCode" id="cb269"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> virtual <span class="kw">table</span> virt_table <span class="kw">using</span> my_module [(module arguments)]  <span class="kw">as</span> (</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  name text</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The part after the <code>AS</code> is used by CQL as a table
declaration for the virtual table. The grammar for that is exactly the
same as a normal <code>CREATE TABLE</code> statement. However, that part
is not transmitted to SQLite; when the table is created, SQLite sees
only the part it cares about, which is the part before the
<code>AS</code>.</p>
<p>In order to have strict parsing rules, the module arguments follow
one of these forms:</p>
<ol type="1">
<li>no arguments at all</li>
<li>a list of identifiers, constants, and parenthesized sublists, just
like in the <code>@attribute</code> form</li>
<li>the words <code>arguments following</code></li>
</ol>
<h5 id="case-1-example">Case 1 Example</h5>
<div class="sourceCode" id="cb270"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> virtual <span class="kw">table</span> virt_table <span class="kw">using</span> my_module <span class="kw">as</span> (</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>  name text</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>becomes (to SQLite)</p>
<div class="sourceCode" id="cb271"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> VIRTUAL <span class="kw">TABLE</span> virt_table <span class="kw">USING</span> my_module;</span></code></pre></div>
<blockquote>
<p>NOTE: empty arguments <code>USING my_module()</code> are not allowed
in the SQLite docs but do seem to work in SQLite. We take the position
that no args should be formatted with no parentheses, at least for
now.</p>
</blockquote>
<h5 id="case-2-example">Case 2 Example</h5>
<pre><code>create virtual table virt_table using my_module(foo, &#39;goo&#39;, (1.5, (bar, baz))) as (
  id integer not null,
  name text
);</code></pre>
<pre><code>CREATE VIRTUAL TABLE virt_table USING my_module(foo, &quot;goo&quot;, (1.5, (bar, baz)));</code></pre>
<p>This form allows for very flexible arguments but not totally
arbitrary arguments, so it can still be parsed and validated.</p>
<h5 id="case-3-example">Case 3 Example</h5>
<p>This case recognizes the popular choice that the arguments are often
the actual schema declaration for the table in question. So:</p>
<pre><code>create virtual table virt_table using my_module(arguments following) as (
  id integer not null,
  name text
);</code></pre>
<p>becomes</p>
<pre><code>CREATE VIRTUAL TABLE virt_table USING my_module(
  id INTEGER NOT NULL,
  name TEXT
);</code></pre>
<p>The normalized text (keywords capitalized, whitespace normalized) of
the table declaration in the <code>as</code> clause is used as the
arguments.</p>
<h5 id="other-details">Other details</h5>
<p>Virtual tables go into their own section in the JSON and they include
the <code>module</code> and <code>moduleArgs</code> entries; they are
additionally marked <code>isVirtual</code> in case you want to use the
same processing code for virtual tables as normal tables. The JSON
format is otherwise the same, although some things can’t happen in
virtual tables (e.g. there is no <code>TEMP</code> option so
<code>"isTemp"</code> must be false in the JSON.)</p>
<p>For purposes of schema processing, virtual tables are on the
<code>@recreate</code> plan, just like indices, triggers, etc. This is
the only option since the <code>alter table</code> form is not allowed
on a virtual table.</p>
<p>Semantic validation enforces “no alter statements on virtual tables”
as well as other things like no indices, and no triggers, since SQLite
does not support any of those things.</p>
<p>CQL supports the notion of <a
href="https://www.sqlite.org/vtab.html#epovtab">eponymous virtual
tables</a>. If you intend to register the virtual table’s module in this
fashion, you can use <code>create virtual table @eponymous ...</code> to
declare this to CQL. The only effect this has is to ensure that CQL will
not try to drop this table during schema maintenance as dropping such a
table is an invalid operation. In all other ways, the fact that the
table is eponymous makes no difference.</p>
<p>Finally, because virtual tables are on the <code>@recreate</code>
plan, you may not have foreign keys that reference virtual tables. Such
keys seem like a bad idea in any case.</p>
<h3 id="the-primary-procedure-statements">The Primary Procedure
Statements</h3>
<p>These are the statements which form the language of procedures, and
do not involve the database.</p>
<h4 id="the-create-procedure-statement">The
<code>CREATE PROCEDURE</code> Statement</h4>
<p>Semantic analysis of stored procedures is fairly easy at the core: *
check for duplicate names * validate the parameters are well formed *
set the current proc in flight (this not allowed to nest) * recurse on
the statement list and prop errors * record the name of the procedure
for callers In addition, while processing the statement: * we determine
if it uses the database; this will change the emitted signature of the
proc to include a <code>sqlite3 *db</code> input argument and it will
return a sqlite error code (e.g. <code>SQLITE_OK</code>) * select
statements that are loose in the proc represent the “return” of that
select; this changes the signature to include a
<code>sqlite3_stmt **pstmt</code> parameter corresponding to the
returned statement</p>
<h4 id="the-if-statement-1">The <code>IF</code> Statement</h4>
<p>The top level if node links the initial condition with a possible
series of else_if nodes and then the else node. Each condition is
checked for validity. The conditions must be valid expressions that can
each be converted to a boolean.</p>
<h4 id="the-set-statement">The <code>SET</code> Statement</h4>
<p>The set statement is for variable assignment. We just validate that
the target exists and is compatible with the source. Cursor variables
cannot be set with simple assignment and CQL generates errors if you
attempt to do so.</p>
<h4 id="the-let-statement">The <code>LET</code> Statement</h4>
<p>Let combines a <code>DECLARE</code> and a <code>SET</code>. The
variable is declared to be the exact type of the right hand side. All
the validations for <code>DECLARE</code> and <code>SET</code> are
applicable, but there is no chance that the variable will not be
compatible with the expression. The expression could still be erroneous
in the first place. The variable could be a duplicate.</p>
<h4 id="the-switch-statement-1">The <code>SWITCH</code> Statement</h4>
<p>The <code>SWITCH</code> form requires a number of conditions to
successfully map down to a <code>C</code> <code>switch</code> statement.
These are:</p>
<ul>
<li>the switch-expression must be a not-null integral type
(<code>integer not null</code> or <code>long integer not null</code>)
<ul>
<li>the <code>WHEN</code> expressions must be losslessly promotable to
the type of the switch-expression</li>
</ul></li>
<li>the values in the <code>WHEN</code> clauses must be unique</li>
<li>If <code>ALL VALUES</code> is present then:
<ul>
<li>the switch-expression must be of an enum type</li>
<li>the <code>WHEN</code> values must cover every value of the enum
except those beginning with ’_’</li>
<li>there can be no extra <code>WHEN</code> values not in the enum</li>
<li>there can be no <code>ELSE</code> clause</li>
</ul></li>
</ul>
<h4 id="the-declare-procedure-statement">The
<code>DECLARE PROCEDURE</code> Statement</h4>
<p>There are three forms of this declaration: * a regular procedure with
no DML * e.g. <code>declare proc X(id integer);</code> * a regular
procedure that uses DML (it will need a db parameter and returns a
result code) *
e.g. <code>declare proc X(id integer) using transaction;</code> * a
procedure that returns a result set, and you provide the result columns
*
e.g. <code>declare proc X(id integer) : (A bool not null, B text);</code>
The main validations here are that there are no duplicate parameter
names, or return value columns.</p>
<h4 id="the-declare-function-statement">The
<code>DECLARE FUNCTION</code> Statement</h4>
<p>Function declarations are similar to procedures; there must be a
return type (use proc if there is none). The
<code>DECLARE SELECT FUNCTION</code> form indicates a function visible
to SQLite; other functions are usable in the <code>call</code>
statement.</p>
<h4 id="the-declare-variable-statement">The <code>DECLARE</code>
Variable Statement</h4>
<p>This declares a new local or global variable that is not a cursor.
The type is computed with the same helper that is used for analyzing
column definitions. Once we have the type we walk the list of variable
names, check them for duplicates and such (see above) and assign their
type. The canonical name of the variable is defined here. If it is later
used with a different casing the output will always be as declared.
e.g. <code>declare Foo integer;  set foo = 1;</code> is legal but the
output will always contain the variable written as <code>Foo</code>.</p>
<h4 id="the-declare-cursor-statement">The <code>DECLARE</code> Cursor
Statement</h4>
<p>There are two forms of the declare cursor, both of which allow CQL to
infer the exact type of the cursor. *
<code>declare foo cursor for select etc.</code> * the type of the cursor
is the net struct type of the select list *
<code>declare foo cursor for call proc();</code> * proc must be
statement that produces a result set via select (see above) * the type
of the cursor is the struct of the select returned by the proc * note if
there is more than one loose select in the proc they must match exactly
* cursor names have the same rules regarding duplicates as other
variables With this in mind, both cases simply recurse on either the
select or the call and then pull out the structure type of that thing
and use it for the cursor’s shape. If the <code>call</code> is not
semantically valid according to the rules for calls or the
<code>select</code> is not semantically valid, then of course this
declaration will generate errors.</p>
<h4 id="the-declare-value-cursor-statement">The <code>DECLARE</code>
Value Cursor Statement</h4>
<p>This statement declares a cursor that will be based on the return
type of a procedure. When using this form the cursor is also fetched,
hence the name. The fetch result of the stored proc will be used for the
value. At this point, we use its type only. * the call must be
semantically valid * the procedure must return an OUT parameter (not a
result set) * the cursor name must be unique</p>
<h4 id="the-while-statement-1">The <code>WHILE</code> Statement</h4>
<p>While semantic analysis is super simple. * the condition must be
numeric * the statement list must be error-free * loop_depth is
increased allowing the use of interior leave/continue</p>
<h4 id="the-loop-statement">The <code>LOOP</code> Statement</h4>
<p>Loop analysis is just as simple as “while” – because the loop_stmt
literally has an embedded fetch, you simply use the fetch helper to
validate that the fetch is good and then visit the statement list. Loop
depth is increased as it is with while.</p>
<h4 id="the-call-statement">The <code>CALL</code> Statement</h4>
<p>There are three ways that a call can happen: * signatures of
procedures that we know in full: * call foo(); * declare cursor for call
foo(); * some external call to some outside function we don’t know *
e.g. call printf(‘hello, world’);</p>
<p>The cursor form can be used if and only if the procedure has a loose
select or a call to a procedure with a loose select. In that case, the
procedure will have a structure type, rather than just “ok” (the normal
signature for a proc). If the user is attempting to do the second case,
cursor_name will be set and the appropriate verification happens
here.</p>
<blockquote>
<p>NOTE: Recursively calling fetch cursor is not really doable in
general because at the point in the call we might not yet know that the
method does in fact return a select. You could make it work if you put
the select before the recursive call.</p>
</blockquote>
<p>Semantic rules: * for all cases each argument must be error-free (no
internal type conflicts) * for known procs * the call has to have the
correct number of arguments * if the formal is an out parameter the
argument must be a variable * the type of the variable must be an exact
type match for the formal * non-out parameters must be type-compatible,
but exact match is not required</p>
<h4 id="the-declare-out-call-statement">The
<code>DECLARE OUT CALL</code> Statement</h4>
<p>This form is syntactic sugar and corresponds to declaring any
<code>OUT</code> parameters of the <code>CALL</code> portion that are
not already declared as the exact type of the <code>OUT</code>
parameter. This is intended to save you from declaring a lot of
variables just so that you can use them as <code>OUT</code>
arguments.</p>
<p>Since any variables that already exist are not re-declared, there are
no additional semantic rules beyond the normal call except that it is an
error to use this form if no <code>OUT</code> variables needed to be
declared.</p>
<h4 id="the-fetch-statement">The <code>FETCH</code> Statement</h4>
<p>The fetch statement has two forms: * fetch C into var1, var2, var3
etc. * fetch C; The second form is called the auto_cursor. In the first
form the variables of the cursor must be assignment compatible with
declared structure type of the cursor and the count must be correct. In
the second form, the codegen will implicitly create local variables that
are exactly the correct type, but we’ll cover that later. Since no
semantic error is possible in that case, we simply record that this is
an auto_cursor and then later we will allow the use of C.field during
analysis. Of course “C” must be a valid cursor.</p>
<h4 id="the-continue-statement">The <code>CONTINUE</code> Statement</h4>
<p>We just need to ensure that <code>continue</code> is inside a
<code>loop</code> or <code>while</code>.</p>
<h4 id="the-leave-statement">The <code>LEAVE</code> Statement</h4>
<p>We only need to ensure that <code>leave</code> is inside a
<code>loop</code>, <code>while</code> or <code>switch</code>.</p>
<h4 id="the-trycatch-statements">The <code>TRY/CATCH</code>
Statements</h4>
<p>No analysis needed here other than that the two statement lists are
ok.</p>
<h4 id="the-close-cursor-statement">The <code>CLOSE</code> CURSOR
Statement</h4>
<p>For close [cursor], we just validate that the name is in fact a
cursor and it is not a boxed cursor. Boxed cursor lifetime is managed by
the box object so manually closing it is not allowed. Instead, the usual
reference-counting semantics apply; the boxed cursor variable typically
falls out of scope and is released, or is perhaps set to NULL to release
its reference early.</p>
<h4 id="the-out-cursor-statement">The <code>OUT</code> CURSOR
Statement</h4>
<p>For out [cursor], we first validate that the name is a cursor then we
set the output type of the procedure we’re in accordingly.</p>
<h3 id="the-meta-statements">The “Meta” Statements</h3>
<p>The program’s control/ the overall meaning of the program / or may
give the compiler specific directives as to how the program should be
compiled.</p>
<h4 id="the-attribute-notation">the <code>@ATTRIBUTE</code>
Notation</h4>
<p>Zero or more miscellaneous attributes can be added to any statement,
or any column definition. See the <code>misc_attrs</code> node in the
grammar for the exact placement. Each attribute notation has the general
form:</p>
<ul>
<li><code>@attribute</code>(<em>namespace</em> : <em>attribute-name</em>
) or</li>
<li><code>@attribute</code>(<em>namespace</em> : <em>attribute-name</em>
= <em>attribute-value</em>)</li>
</ul>
<p>The <em>namespace</em> portion is optional and attributes with
special meaning to the compiler are all in the <code>cql:</code>
namespace. e.g. <span class="citation"
data-cites="attribute">@attribute</span>(cql:private). This form is so
common that the special abbreviation
<code>[[foo]]`` can be used instead of</code><span class="citation"
data-cites="attribute">@attribute</span>(cql:foo)`.</p>
<ul>
<li>The <em>attribute-name</em> can be any valid name</li>
<li>Each <em>attribute-value</em> can be:
<ul>
<li>any literal</li>
<li>an array of <em>attribute-values</em></li>
</ul></li>
</ul>
<p>Since the <em>attribute-values</em> can nest it’s possible to
represent arbitrarily complex data types in an attribute. You can even
represent a LISP program.</p>
<p>By convention, CQL lets you define “global” attributes by applying
them to a global variable of type <code>object</code> ending with the
suffix “database”.</p>
<p>The main usage of global attributes is as a way to propagate
configurations into the JSON output (q.v.).</p>
<p>Examples:</p>
<div class="sourceCode" id="cb276"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- &quot;global&quot; attributes</span></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(attribute_1 = &quot;value_1&quot;)</span></span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(attribute_2 = &quot;value_2&quot;)</span></span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">database</span> <span class="dt">object</span>;</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- cql:private marking on a method to make it private, using simplified syntax</span></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a>[[<span class="kw">private</span>]]</span>
<span id="cb276-8"><a href="#cb276-8" aria-hidden="true" tabindex="-1"></a>proc foo()</span>
<span id="cb276-9"><a href="#cb276-9" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb276-10"><a href="#cb276-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<h4 id="the-echo-statement">The <code>@ECHO</code> Statement</h4>
<p>Echo is valid in any top level contexts.</p>
<h4 id="the-previous-schema-statement">The <code>@PREVIOUS SCHEMA</code>
Statement</h4>
<p>Begins the region where previous schema will be compared against what
has been declared before this directive for alterations that could not
be upgraded.</p>
<h4 id="the-schema_upgrade_script-statement">The
<code>@SCHEMA_UPGRADE_SCRIPT</code> Statement</h4>
<p>When upgrading the DDL, it’s necessary to emit create table
statements for the original version of the schema. These create
statements may conflict with the current version of the schema. This
attribute tells CQL to 1) ignore DDL in stored procedures for
declaration purposes; only DDL outside of a proc counts 2) do not make
any columns “hidden” thereby allowing all annotations to be present so
they can be used to validate other aspects of the migration script.</p>
<h4 id="the-schema_upgrade_version-statement">The
<code>@SCHEMA_UPGRADE_VERSION</code> Statement</h4>
<p>For sql stored procedures that are supposed to update previous schema
versions you can use this attribute to put CQL into that mindset. This
will make the columns hidden for the version in question rather than the
current version. This is important because older schema migration
procedures might still refer to old columns. Those columns truly exist
at that schema version.</p>
<h4 id="the-enforce_strict-statement">The <code>@ENFORCE_STRICT</code>
Statement</h4>
<p>Switch to strict mode for the indicated item. The choices and their
meanings are:</p>
<ul>
<li>“FOREIGN KEY ON DELETE” indicates there must be some
<code>ON DELETE</code> action in every FK</li>
<li>“FOREIGN KEY ON UPDATE” indicates there must be some
<code>ON UPDATE</code> action in every FK</li>
<li>“INSERT SELECT” indicates that insert with <code>SELECT</code> for
values may not include top level joins (avoiding a SQLite bug)</li>
<li>“IS TRUE” indicates that <code>IS TRUE</code> <code>IS FALSE</code>
<code>IS NOT TRUE</code> <code>IS NOT FALSE</code> may not be used
(*)</li>
<li>“JOIN” indicates only ANSI style joins may be used, and “from A,B”
is rejected</li>
<li>“PROCEDURE” indicates no calls to undeclared procedures (like loose
printf calls)</li>
<li>“SELECT IF NOTHING” indicates <code>(select ...)</code> expressions
must include an <code>IF NOTHING</code> clause if they have a
<code>FROM</code> part</li>
<li>“TABLE FUNCTIONS” indicates table valued functions cannot be used on
left/right joins (avoiding a SQLite bug)</li>
<li>“TRANSACTION” indicates no transactions may be started, committed,
or aborted</li>
<li>“UPSERT” indicates no upsert statement may be used (*)</li>
<li>“WINDOW FUNCTION” indicates no window functions may be used (*)</li>
<li>“WITHOUT ROWID” indicates <code>WITHOUT ROWID</code> may not be
used</li>
</ul>
<p>The items marked with * are present so that features can be disabled
to target downlevel versions of SQLite that may not have those
features.</p>
<p>See the grammar details for exact syntax.</p>
<h4 id="the-enforce_normal-statement">The <code>@ENFORCE_NORMAL</code>
Statement</h4>
<p>Turn off strict enforcement for the indicated item.</p>
<h4 id="the-enforce_push-statement">The <code>@ENFORCE_PUSH</code>
Statement</h4>
<p>Push the current strict settings onto the enforcement stack. This
does not change the current settings.</p>
<h4 id="the-enforce_pop-statement">The <code>@ENFORCE_POP</code>
Statement</h4>
<p>Pop the previous current strict settings from the enforcement
stack.</p>
<h4 id="the-enforce_reset-statement">The <code>@ENFORCE_RESET</code>
Statement</h4>
<p>Turns off all the strict modes. Best used immediately after
<code>@ENFORCE_PUSH</code>.</p>
<h4 id="the-declare_schema_region-statement">The
<code>@DECLARE_SCHEMA_REGION</code> Statement</h4>
<p>A schema region is a partitioning of the schema such that it only
uses objects in the same partition or one of its declared dependencies.
One schema region may be upgraded independently from any others
(assuming they happen such that dependents are done first.) Here we
validate: * the region name is unique * the dependencies (if any) are
unique and exist * the directive is not inside a procedure</p>
<h4 id="the-begin_schema_region-statement">The
<code>@BEGIN_SCHEMA_REGION</code> Statement</h4>
<p>Entering a schema region makes all the objects that follow part of
that region. It also means that all the contained objects must refer to
only pieces of schema that are in the same region or a dependent region.
Here we validate that region we are entering is in fact a valid region
and that there isn’t already a schema region.</p>
<h4 id="the-end_schema_region-statement">The
<code>@END_SCHEMA_REGION</code> Statement</h4>
<p>Leaving a schema region puts you back in the default region. Here we
check that we are in a schema region.</p>
<h4 id="the-emit_enums-statement">The <code>@EMIT_ENUMS</code>
Statement</h4>
<p>Declared enumarations can be voluminous and it is undesirable for
every emitted <code>.h</code> file to contain every enumeration. To
avoid this problem you can emit enumeration values of your choice using
<code>@emit_enums x, y, z</code> which places the named enumerations
into the <code>.h</code> file associated with the current translation
unit. If no enumerations are listed, all enums are emitted.</p>
<blockquote>
<p>NOTE: generated enum definitions are protected by
<code>#ifndef X ... #endif</code> so multiple definitions are harmless
and hence you can afford to use <code>@emit_enums</code> for the same
enum in several translations units, if desired.</p>
</blockquote>
<blockquote>
<p>NOTE: Enumeration values also appear in the JSON output in their own
section.</p>
</blockquote>
<h4 id="the-emit_constants-statement">The <code>@EMIT_CONSTANTS</code>
Statement</h4>
<p>This statement is entirely analogous to the the
<code>@EMIT_ENUMS</code> except that the parameters are one or more
constant groups. In fact constants are put into groups precisely so that
they can be emitted in logical bundles (and to encourage keeping related
constants together). Placing <code>@EMIT_CONSTANTS</code> causes the C
version of the named groups to go into the current <code>.h</code>
file.</p>
<blockquote>
<p>NOTE: Global constants also appear in the JSON output in their own
section.</p>
</blockquote>
<h3 id="important-program-fragments">Important Program Fragments</h3>
<p>These items appear in a variety of places and are worthy of
discussion. They are generally handled uniformly.</p>
<h4 id="argument-lists">Argument Lists</h4>
<p>In each case we walk the entire list and do the type inference on
each argument. Note that this happens in the context of a function call,
and depending on what the function is, there may be additional rules for
compatibility of the arguments with the function. The generic code
doesn’t do those checks, there is per-function code that handles that
sort of thing.</p>
<p>At this stage the compiler computes the type of each argument and
makes sure that, independently, they are not bogus.</p>
<h4 id="procedures-that-return-a-result-set">Procedures that return a
Result Set</h4>
<p>If a procedure is returning a select statement then we need to attach
a result type to the procedure’s semantic info. We have to do some extra
validation at this point, especially if the procedure already has some
other select that might be returned. The compiler ensures that all the
possible select results are are 100% compatible.</p>
<h4 id="general-name-lookups">General Name Lookups</h4>
<p>Every name is checked in a series of locations. If the name is known
to be a table, view, cursor, or some other specific type of object then
only those name are considered. If the name is more general a wider
search is used.</p>
<p>Among the places that are considered: * columns in the current join
if any (this must not conflict with #2) * local or global variables *
fields in an open cursor * fields in enumerations and global
constants</p>
<h4 id="data-types-with-a-discriminator">Data Types with a
Discriminator</h4>
<p>Discriminators can appear on any type, <code>int</code>,
<code>real</code>, <code>object</code>, etc.</p>
<p>Where there is a discriminator the compiler checks that (e.g.)
<code>object&lt;Foo&gt;</code> only combines with
<code>object&lt;Foo&gt;</code> or <code>object</code>.
<code>real&lt;meters&gt;</code> only combines with
<code>real&lt;meters&gt;</code> or <code>real</code>. In this way its
not possible to accidentally add <code>meters</code> to
<code>kilograms</code> or to store an <code>int&lt;task_id&gt;</code>
where an <code>int&lt;person_id&gt;</code> is required.</p>
<h4 id="the-case-expression">The <code>CASE</code> Expression</h4>
<p>There are two parts to this: the “when” expression and the “then”
expression. We compute the aggregate type of the “when” expressions as
we go, promoting it up to a larger type if needed (e.g. if one “when” is
an int and the other is a real, then the result is a real). Likewise,
nullability is computed as the aggregate. Note that if nothing matches,
the result is null, so we always get a nullable resultm unless there is
an “else” expression. If we started with case expression, then each
“when” expression must be comparable to the case expression. If we
started with case when xx then yy; then each case expression must be
numeric (typically boolean).</p>
<h4 id="the-between-expressions">The <code>BETWEEN</code>
EXPRESSIONS</h4>
<p>Between requires type compatibility between all three of its
arguments. Nullability follows the usual rules: if any might be null
then the result type might be null. In any case, the result’s core type
is BOOL.</p>
<h4 id="the-cast-expression">The <code>CAST</code> Expression</h4>
<p>For cast expressions we use the provided semantic type; the only
trick is that we preserve the extra properties of the input argument.
e.g. CAST does not remove <code>NOT NULL</code>.</p>
<h4 id="the-coalesce-function">The <code>COALESCE</code> Function</h4>
<p>Coalesce requires type compatibility between all of its arguments.
The result is a not null type if we find a not null item in the list.
There should be nothing after that item. Note that ifnull and coalesce
are really the same thing except ifnull must have exactly two
arguments.</p>
<h4 id="the-in-and-not-in-expressions">The <code>IN</code> AND
<code>NOT IN</code> Expressions</h4>
<p>The in predicate is like many of the other multi-argument operators.
All the items must be type compatible. Note that in this case the
nullablity of the items does not matter, only the nullability of the
item being tested. Note that null in (null) is null, not true.</p>
<h4 id="aggregate-functions">Aggregate Functions</h4>
<p>Aggregate functions can only be used in certain places. For instance
they may not appear in a <code>WHERE</code> clause.</p>
<h4 id="user-defined-functions">User Defined Functions</h4>
<p>User defined function - this is an external function. There are a few
things to check: * If this is declared without the select keyword then *
we can’t use these in SQL, so this has to be a loose expression * If
this is declared with the select keyword then * we can ONLY use these in
SQL, not in a loose expression * args have to be compatible with
formals</p>
<h4 id="calling-a-procedure-as-a-function">Calling a procedure as a
function</h4>
<p>There are a few things to check: * we can’t use these in SQL, so this
has to be a loose expression * args have to be compatible with formals,
except * the last formal must be an OUT arg and it must be a scalar type
* that out arg will be treated as the return value of the “function” *
in code-gen we will create a temporary for it; semantic analysis doesn’t
care</p>
<h4 id="root-expressions">Root Expressions</h4>
<p>A top level expression defines the context for that evaluation.
Different expressions can have constraints. e.g. aggregate functions may
not appear in the <code>WHERE</code> clause of a statement. There are
cases where expression nesting can happen. This nesting changes the
evaluation context accordingly, e.g. you can put a nested select in a
where clause and that nested select could legally have aggregates. Root
expressions keep a stack of nested contexts to facilitate the
changes.</p>
<h4 id="table-factors">Table Factors</h4>
<p>A table factor is one of three things: * a table name (a string)
select * from X * a select subquery (select X,Y from..) as T2 * a list
of table references select * from (X, Y, Z) Here we dispatch to the
appropriate helper for each case.</p>
<h4 id="joining-with-the-using-clause">Joining with the
<code>USING</code> Clause</h4>
<p>When specifying joins, one of the alternatives is to give the shared
columns in the join e.g. select * from X inner join Y using (a,b). This
method validates that all the columns are present on both sides of the
join, that they are unique, and they are comparable. The return code
tells us if any columns had SENSITIVE data. See Special Note on
JOIN…USING below</p>
<h4 id="join-with-the-on-clause">JOIN WITH THE <code>ON</code>
Clause</h4>
<p>The most explicit join condition is a full expression in an ON clause
this is like <code>select a,b from X inner join Y on X.id = Y.id;</code>
The on expression should be something that can be used as a bool, so any
numeric will do. The return code tells us if the ON condition used
SENSITIVE data.</p>
<h4 id="table-valued-functions">TABLE VALUED FUNCTIONS</h4>
<p>Table valued functions can appear anywhere a table is allowed. The
validation rules are: * must be a valid function * must return a struct
type (i.e. a table-valued-function) * must have valid arg expressions *
arg expressions must match formal parameters The name of the resulting
table is the name of the function * but it can be aliased later with
“AS”</p>
<p>### Special Note on the <code>select *</code> and
<code>select T.*</code> forms</p>
<p>The <code>select *</code> construct is very popular in many codebases
but it can be unsafe to use in production code because, if the schema
changes, the code might get columns it does not expect. Note the extra
columns could have appeared anywhere in the result set because the
<code>*</code> applies to the entire result of the <code>FROM</code>
clause, joins and all, so extra columns are not necessarily at the end
and column ordinals are not preserved. CQL mitigates this situation
somewhat with some useful constraints/features:</p>
<ul>
<li>in a <code>select *</code>, and indeed in any query, the column
names of the select must be unique, this is because:
<ul>
<li>they could form the field names of an automatically generated cursor
(see the section on cursors)</li>
<li>they could form the field names in a CQL result set (see section on
result sets)</li>
<li>it’s weird/confusing to not have unique names generally</li>
</ul></li>
<li>when issuing a <code>select *</code> or a <code>select T.*</code>
CQL will automatically expand the <code>*</code> into the actual logical
columns that exist in the schema at the time the code was compiled
<ul>
<li>this is important because if a column had been logically deleted
from a table it would be unexpected in the result set even though it is
still present in the database and would throw everything off</li>
<li>likewise if the schema were to change without updating the code, the
code will still get the columns it was compiled with, not new
columns</li>
</ul></li>
</ul>
<p>Expanding the <code>*</code> at compile time means Sqlite cannot see
anything that might tempt it to include different columns in the
result.</p>
<p>With this done we just have to look at the places a
<code>select *</code> might appear so we can see if it is safe (or at
least reasonably safe) to use <code>*</code> and, by extension of the
same argument, <code>T.*</code>.</p>
<p><em>In an <code>EXISTS</code> or <code>NOT EXISTS</code> clause like
<code>where not exists (select * from x)</code></em></p>
<ul>
<li>this is perfectly safe; the particular columns do not matter;
<code>select *</code> is not even expanded in this case.</li>
</ul>
<p><em>In a statement that produces a result set like
<code>select * from table_or_view</code></em></p>
<ul>
<li>binding to a CQL result set is done by column name and we know those
names are unique</li>
<li>we won’t include any columns that are logically deleted, so if you
try to use a deleted column you’ll get a compile time error</li>
</ul>
<p>In a cursor statement like
<code>declare C cursor for select * from table_or_view</code> there are
two cases here:</p>
<p><em>Automatic Fetch <code>fetch C;</code></em></p>
<ul>
<li>in this case you don’t specify the column names yourself;2 they are
inferred</li>
<li>you are therefore binding to the columns by name, so new columns in
the cursor would be unused (until you choose to start using them)</li>
<li>if you try to access a deleted column you get a compile-time
error</li>
</ul>
<p><em>Manual Fetch: <code>fetch C into a, b, c;</code></em></p>
<ul>
<li>In this case the number and type of the columns must match exactly
with the specified variables</li>
<li>If new columns are added, deleted, or changed, the above code will
not compile</li>
</ul>
<p>So considering the cases above we can conclude that auto expanding
the <code>*</code> into the exact columns present in the compile-time
schema version ensures that any incompatible changes result in compile
time errors. Adding columns to tables does not cause problems even if
the code is not recompiled. This makes the <code>*</code> construct much
safer, if not perfect, but no semantic would be safe from arbitrary
schema changes without recompilation. At the very least here we can
expect a meaningful runtime error rather than silently fetching the
wrong columns.</p>
<h3 id="special-note-on-the-joinusing-form">Special Note on the
JOIN…USING form</h3>
<p>CQL varies slightly from SQLite in terms of the expected results for
joins if the USING syntax is employed. This is not the most common
syntax (typically an ON clause is used) but Sqlite has special rules for
this kind of join.</p>
<p>Let’s take a quick look. First some sample data:</p>
<pre><code>create table A( id integer, a text, b text);
create table B( id integer, c text, d text);

insert into A values(1, &#39;a1&#39;, &#39;b1&#39;);
insert into B values(1, &#39;c1&#39;, &#39;d1&#39;);
insert into A values(2, &#39;a2&#39;, &#39;b2&#39;);
insert into B values(2, &#39;c2&#39;, &#39;d2&#39;);</code></pre>
<p>Now let’s look at the normal join; this is our reference:</p>
<pre><code>select * from A T1 inner join B T2 on T1.id = T2.id;

result:

1|a1|b1|1|c1|d1
2|a2|b2|2|c2|d2</code></pre>
<p>As expected, you get all the columns of A, and all the columns of B.
The ‘id’ column appears twice.</p>
<p>However, with the <code>USING</code> syntax:</p>
<pre><code>select * T1 inner join B T2 using (id);

result:

1|a1|b1|c1|d1
2|a2|b2|c2|d2</code></pre>
<p>The <code>id</code> column is now appearing exactly once. However,
the situation is not so simple as that. It seems that what hapened was
that the <code>*</code> expansion has not included two copies of the
<code>id</code>. The following cases show that both copies of
<code>id</code> are still logically in the join.</p>
<pre><code>select T1.*, &#39;xxx&#39;, T2.* from A T1 inner join B T2 using (id);

result:

1|a1|b1|xxx|1|c1|d1
2|a2|b2|xxx|2|c2|d2</code></pre>
<p>The <code>T2.id</code> column is part of the join, it just wasn’t
part of the <code>*</code></p>
<p>In fact, looking further:</p>
<pre><code>select T1.id, T1.a, T1.b, &#39;xxx&#39;, T2.id, T2.c, T2.d from A T1 inner join B T2 using (id);

result:

1|a1|b1|xxx|1|c1|d1
2|a2|b2|xxx|2|c2|d2</code></pre>
<p>There is no doubt, <code>T2.id</code> is a valid column and can be
used in expressions freely. That means the column cannot be removed from
the type calculus.</p>
<p>Now in CQL, the <code>*</code> and <code>T.*</code> forms are
automatically expanded; SQLite doesn’t see the <code>*</code>. This is
done so that if any columns have been logically deleted they can be
elided from the result set. Given that this happens, the <code>*</code>
operator will expand to ALL the columns. Just the same as if you did
<code>T1.*</code> and <code>T2.*</code>.</p>
<p><em>As a result, in CQL, there is no difference between the
<code>USING</code> form of a join and the <code>ON</code> form of a
join.</em></p>
<p>In fact, only the <code>select *</code> form could possibly be
different, so in most cases this ends up being moot anyway. Typically,
you don’t need to use <code>*</code> in the presence of joins because of
name duplication and ambiguity of the column names of the result set.
CQL’s automatic expansion means you have a much better idea exactly what
columns you will get - those that were present in the schema you
declared.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-10-schema-management-features">Chapter 10: Schema
Management Features</h2>
<p>CQL has a lot of schema knowledge already and so it’s well positioned
to think about schema upgrades and versioning.</p>
<p>It seemed essential to be able to record changes to the schema over
time so CQL got an understanding of versioning. This lets you do things
like:</p>
<ul>
<li>ensure columns are only added where they should be</li>
<li>generate compiler errors if you try to access columns that are
deprecated</li>
<li>move from one version to another tracking schema facets that have to
be added</li>
</ul>
<p>To use cql in this fashion, the sequence will be something like the
below. See Appendix 1 for command line details.</p>
<pre><code>cql --in input.sql --rt schema_upgrade --cg schema_upgrader.sql \
                   --global_proc desired_upgrade_proc_name</code></pre>
<h3 id="annotations">Annotations</h3>
<p>There are three basic flavors of annotation</p>
<ul>
<li><code>@create(version [, migration proc])</code></li>
<li><code>@delete(version [, migration proc])</code></li>
<li><code>@recreate</code></li>
</ul>
<p>They have various constraints:</p>
<ul>
<li><code>@create</code> and <code>@delete</code> can only be applied to
tables and columns</li>
<li><code>@recreate</code> can only be applied to tables (nothing else
needs it anyway)</li>
<li><code>@recreate</code> cannot mix with <code>@create</code> or
<code>@delete</code></li>
<li><code>@recreate</code> can include a group name as in
<code>@recreate(musketeers)</code>; if a group name is specified then
all the tables in that group are recreated if any of them change</li>
</ul>
<p>Indices, Views, and Triggers are always “recreated” (just like tables
can be) and so neither the <code>@recreate</code> nor the
<code>@create</code> annotations are needed (or allowed). However when
an Index, View, or Trigger is retired it must be marked with
<code>@delete</code> so that it isn’t totally forgotten but can be
deleted anywhere it might still exist. Note that when one of these items
is deleted, the definition is not used as it will only be dropped
anyway. The simplest creation of the object with the correct name will
do the job as a tombstone.</p>
<p>e.g. <code>create view used_to_be_fabulous as select 1 x @delete(12);</code>
suffices to drop the <code>used_to_be_fabulous</code> view in version 12
no matter how complicated it used to be. Its <code>CREATE VIEW</code>
will not be emitted into the upgrade procedure in any case. Similarly,
trivial indices and triggers of the correct name can be used for the
tombstone.</p>
<p>In addition, if there is some data migration that needs to happen at
a particular schema version that isn’t associated with any particular
change in schema, you can run an <em>ad hoc</em> migrator at any time.
The syntax for that is
<code>@schema_ad_hoc_migration(version, migration proc);</code>. Ad hoc
migrations are the last to run in any given schema version; they happen
after table drop migrations.</p>
<h3 id="semantics">Semantics</h3>
<p><code>@create</code> declares that the annotated object first
appeared in the indicated version, and at that time the migration proc
needs to be executed to fill in default values, denormalize values, or
whatever the case may be.</p>
<p><code>@delete</code> declares that the annotated object disappeared
in the indicated version, and at that time the migration proc needs to
be executed to clean up the contents, or potentially move them
elsewhere.</p>
<p><code>@recreate</code> declares that the annotated object can be
dropped and recreated when it changes because there is no need to
preserve its contents during an upgrade. Such objects may be changed
arbitrarily from version to version.</p>
<ul>
<li>no columns in a <code>@recreate</code> table may have
<code>@create</code> or <code>@delete</code> (these aren’t needed
anyway)
<ul>
<li>therefore tables with <code>@recreate</code> never have deprecated
columns (since <code>@delete</code> isn’t allowed on their columns)</li>
</ul></li>
</ul>
<blockquote>
<p>NOTE: all annotations are suppressed from generated SQL. SQLite never
sees them.</p>
</blockquote>
<blockquote>
<p>NOTE: looking at the annotations it is possible to compute the
logical schema at any version, especially the original schema – it’s
what you get if you disregard all <code>@delete</code> entirely (don’t
delete) and then remove anything marked with <code>@create</code>
directives.</p>
</blockquote>
<h3 id="allowable-changes">Allowable changes</h3>
<p>Not all migrations are possible in a sensible fashion, therefore CQL
enforces certain limitations:</p>
<ul>
<li>the “original” schema has no annotations or just delete
annotations</li>
<li>new tables may be added (with <code>@create</code>)</li>
<li>tables may be deleted (with <code>@delete</code>)</li>
<li>columns may be added to a table, but only at the end of the
table</li>
<li>added columns must be nullable or have a default value (otherwise
all existing insert statements would break for sure)</li>
<li>columns may not be renamed</li>
<li>columns may be deleted but this is only a logical delete, SQLite has
no primitive to remove columns; once deleted you may no longer refer to
that column in queries</li>
<li>deleted columns must be nullable or have a default value (otherwise
all existing and future insert statements would break for sure, the
column isn’t really gone)</li>
<li>views, indices, and triggers may be added (no annotation required)
and removed (with <code>@delete</code>) like tables</li>
<li>views, indices, and triggers may be altered completely from version
to version</li>
<li>no normal code is allowed to refer to deleted columns, tables, etc.
This includes views, indices, and triggers</li>
<li>schema migration stored procs see the schema as it existed in their
annotation (so an older version). They are also forbidden from using
views (see below)</li>
<li>recreated objects (tables marked with <span class="citation"
data-cites="recreate">@recreate</span>, views, tables, and indices) have
no change restrictions</li>
</ul>
<h3 id="prosecution">Prosecution</h3>
<p>Moving from one schema version to another is done in an orderly
fashion with the migration proc taking these essential steps in this
order:</p>
<ul>
<li><p>the <code>cql_schema_facets</code> table is created if needed –
this records the current state of the schema</p></li>
<li><p>the last known schema hash is read from the
<code>cql_schema_facets</code> tables (it is zero by default)</p></li>
<li><p>if the overall schema hash code matches what is stored,
processing stops; otherwise an upgrade ensues</p></li>
<li><p>all known views are dropped (hence migration procs won’t see
them!)</p></li>
<li><p>any index that needs to change is dropped (this includes items
marked <code>@delete</code> or indices that are different than
before)</p>
<ul>
<li>change is detected by hash (crc64) of the previous index definition
vs. the current</li>
</ul></li>
<li><p>all known triggers are dropped (hence they will not fire during
migration!)</p></li>
<li><p>the current schema version is extracted from
<code>cql_schema_facets</code> (it is zero by default)</p></li>
<li><p>if the current schema version is zero, then the original versions
of all the tables are created</p></li>
<li><p>if the current schema version is &lt;= 1 then</p>
<ul>
<li>any tables that need to be created at schema version 1 are created
as they exist at schema version 1</li>
<li>any columns that need to be created at schema version 1 are created
as they exist at schema version 1</li>
<li>migration procedures schema version 1 are run in this order:
<ul>
<li>create table migration</li>
<li>create column migration</li>
<li>delete trigger migration (these are super rare and supported for
uniformity)</li>
<li>delete index migration (these are super rare and supported for
uniformity)</li>
<li>delete view migration (these are super rare and supported for
uniformity)</li>
<li>delete column migration</li>
<li>delete table migration</li>
<li>ad hoc migration</li>
<li>each proc is run exactly one time</li>
</ul></li>
<li>any tables that need to be dropped at schema version 1 are
dropped</li>
<li>the schema version is marked as 1 in
<code>cql_schema_facets</code></li>
<li>each sub-step in the above is recorded in
<code>cql_schema_facets</code> as it happens so it is not repeated
<ul>
<li>all that checking not shown for brevity</li>
</ul></li>
</ul></li>
<li><p>the above process is repeated for all schema versions up to the
current version</p></li>
<li><p>all tables that are marked with <code>@recreate</code> are
re-created if necessary</p>
<ul>
<li>i.e. if the checksum of the table definition has changed for any
table (or group) then <code>drop</code> it and create the new
version.</li>
</ul></li>
<li><p>all indices that changed and were not marked with
<code>@delete</code> are re-created</p></li>
<li><p>all views not marked with <code>@delete</code> are
re-created</p></li>
<li><p>all triggers not marked with <code>@delete</code> are
re-installed</p></li>
<li><p>the current schema hash is written to the
<code>cql_schema_facets</code> table</p></li>
</ul>
<h3 id="example-migration">Example Migration</h3>
<p>Here’s an example of a schema directly from the test cases:</p>
<pre><code>-- crazy amount of versioning here
create table foo(
  id integer not null,
  rate long integer @delete(5),
  rate_2 long integer @delete(4, DeleteRate2Proc),
  id2 integer default 12345 @create(4, CreateId2Proc),
  name text @create(5),
  name_2 text @create(6)
);

-- much simpler table, lots of stuff added in v2.
-- note v1 is the first new version and v0 is base version
create table table2(
  id integer not null,
  name1 text @create(2, CreateName1Proc),
  name2 text @create(2, CreateName2Proc),
  name3 text @create(2), -- no proc
  name4 text @create(2) -- no proc
);

create table added_table(
  id integer not null,
  name1 text,
  name2 text @create(4)
) @create(3) @delete(5);

-- this view is present in the output
create view live_view as select * from foo;

-- this view is also present in the output
create view another_live_view as select * from foo;

-- this view is not present in the output
create view dead_view as select * from foo @delete(2);

-- this index is present
create index index_still_present on table2(name1, name2);

-- this index is going away
create index index_going_away on table2(name3) @delete(3);

-- this is a simple trigger, and it&#39;s a bit silly but that doesn&#39;t matter
create trigger trigger_one
  after insert on foo
begin
  delete from table2 where table2.id = new.id;
end;</code></pre>
<p>This schema has a LOT of versioning… you can see tables and columns
appearing in versions 2 through 6. There is a lot of error checking
happening.</p>
<ul>
<li>things with no create annotation were present in the base
schema</li>
<li>only things with no delete annotation are visible to normal
code</li>
<li>created columns have to be at the end of their table (required by
SQLite)</li>
<li>they have to be in ascending schema version order (but you can add
several columns in one version)</li>
<li>there may or may not be a proc to run to populate data in that
column when it’s added or to remove data when it’s deleted
<ul>
<li>proc names must be unique</li>
</ul></li>
<li>you can’t delete a table or column in a version before it was
created</li>
<li>you can’t delete a column in a table in a version before the table
was created</li>
<li>you can’t create a column in a table in a version after the table
was deleted</li>
<li>there may be additional checks not listed here</li>
</ul>
<h3 id="sample-upgrade-script">Sample Upgrade Script</h3>
<p>With just those annotations you can automatically create the
following upgrade script which is itself CQL (and hence has to be
compiled). Notice that this code is totally readable!</p>
<p>The script has been split into logical pieces to make it easier to
explain what’s going on.</p>
<h4 id="preamble">Preamble</h4>
<div class="sourceCode" id="cb284"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- ...copyright notice... possibly generated source tag... elided to avoid confusion</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- no columns will be considered hidden in this script</span></span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- DDL in procs will not count as declarations</span></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a><span class="ot">@SCHEMA_UPGRADE_SCRIPT;</span></span></code></pre></div>
<p>Schema upgrade scripts need to see all the columns even the ones that
would be logically deleted in normal mode. This is so that things like
<code>alter table add column</code> can refer to real columns and
<code>drop table</code> can refer to a table that shouldn’t even be
visible. Remember in CQL the declarations tell you the logical state of
the universe and DLL mutations are expected to create that condition, so
you should be dropping tables that are marked with <code>@delete</code>
CQL stores the current state of the universe in this table.</p>
<div class="sourceCode" id="cb285"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- schema crc -7714030317354747478</span></span></code></pre></div>
<p>The schema crc is computed by hashing all the schema declarations in
canonical form. That’s everything in this next section.</p>
<h4 id="facet-helpers">Facet Helpers</h4>
<p>CQL uses a set of four functions to manage a dictionary. The
implementation is in <code>cqlrt_common.c</code> but it’s really just a
simple hash table that maps from a string key to a number. This
functionality was added because over time the facets table can get
pretty big and running a SQL query every time to read a single integer
is not economical.</p>
<div class="sourceCode" id="cb286"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- declare facet helpers--</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> facet_data <span class="kw">TYPE</span> <span class="dt">LONG</span><span class="op">&lt;</span>facet_data<span class="op">&gt;</span> <span class="kw">not</span> <span class="kw">null</span>;</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> test_facets facet_data;</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> cql_facets_new() facet_data;</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> cql_facets_delete(facets facet_data);</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> cql_facet_add(facets facet_data, facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>, crc <span class="dt">LONG</span> <span class="kw">NOT</span> <span class="kw">NULL</span>) BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> cql_facet_find(facets facet_data, facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>) <span class="dt">LONG</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span></code></pre></div>
<h4 id="declaration-section">Declaration Section</h4>
<p>Wherein all the necessary objects are declared…</p>
<div class="sourceCode" id="cb287"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- declare sqlite_master --</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> sqlite_master (</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>  name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>  tbl_name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>  rootpage <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a>  sql TEXT <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>sqlite_master</code> table is built-in but it has to be
introduced to CQL so that we can query it. Like all the other loose DDL
declarations here there is no code generated for this. We are simply
declaring tables. To create code you have to put the DDL in a proc.
Normally DDL in procs also declares the table but since we may need the
original version of a table created and the final version declared we
have <code>@schema_upgrade_script</code> to help avoid name
conflicts.</p>
<div class="sourceCode" id="cb288"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- declare full schema of tables and views to be upgraded --</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> foo(</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>  rate <span class="dt">LONG</span> <span class="dt">INT</span> @DELETE(<span class="dv">5</span>),</span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>  rate_2 <span class="dt">LONG</span> <span class="dt">INT</span> @DELETE(<span class="dv">4</span>, DeleteRate2Proc),</span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>  id2 <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">12345</span> @CREATE(<span class="dv">4</span>, CreateId2Proc),</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a>  name TEXT @CREATE(<span class="dv">5</span>),</span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a>  name_2 TEXT @CREATE(<span class="dv">6</span>)</span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> table2(</span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>  name1 TEXT @CREATE(<span class="dv">2</span>, CreateName1Proc),</span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a>  name2 TEXT @CREATE(<span class="dv">2</span>, CreateName2Proc),</span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a>  name3 TEXT @CREATE(<span class="dv">2</span>),</span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a>  name4 TEXT @CREATE(<span class="dv">2</span>)</span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb288-18"><a href="#cb288-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-19"><a href="#cb288-19" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> added_table(</span>
<span id="cb288-20"><a href="#cb288-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb288-21"><a href="#cb288-21" aria-hidden="true" tabindex="-1"></a>  name1 TEXT,</span>
<span id="cb288-22"><a href="#cb288-22" aria-hidden="true" tabindex="-1"></a>  name2 TEXT @CREATE(<span class="dv">4</span>)</span>
<span id="cb288-23"><a href="#cb288-23" aria-hidden="true" tabindex="-1"></a>) @CREATE(<span class="dv">3</span>) @DELETE(<span class="dv">5</span>);</span></code></pre></div>
<blockquote>
<p>NOTE: all the tables are emitted including all the annotations. This
lets us do the maximum validation when we compile this script.</p>
</blockquote>
<div class="sourceCode" id="cb289"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> live_view <span class="kw">AS</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo;</span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> another_live_view <span class="kw">AS</span></span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo;</span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> dead_view <span class="kw">AS</span></span>
<span id="cb289-10"><a href="#cb289-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb289-11"><a href="#cb289-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo @DELETE(<span class="dv">2</span>);</span></code></pre></div>
<p>These view declarations do very little. We only need the view names
so we can legally drop the views. We create the views elsewhere.</p>
<div class="sourceCode" id="cb290"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_still_present <span class="kw">ON</span> table2 (name1, name2);</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_going_away <span class="kw">ON</span> table2 (name3) @DELETE(<span class="dv">3</span>);</span></code></pre></div>
<p>Just like views, these declarations introduce the index names and
nothing else.</p>
<div class="sourceCode" id="cb291"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> trigger_one</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">ON</span> foo</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> table2 <span class="kw">WHERE</span> table2.<span class="kw">id</span> <span class="op">=</span> <span class="kw">new</span>.<span class="kw">id</span>;</span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>We have only the one trigger; we declare it here.</p>
<div class="sourceCode" id="cb292"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- facets table declaration --</span></span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> test_cql_schema_facets(</span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>  facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>  version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>This is where we will store everything we know about the current
state of the schema. Below we define a few helper procs for reading and
writing that table and reading <code>sqlite_master</code></p>
<div class="sourceCode" id="cb293"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- saved facets table declaration --</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> test_cql_schema_facets_saved(</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>  facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>  version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>We will snapshot the facets table at the start of the run so that we
can produce a summary of the changes at the end of the run. This table
will hold that snapshot.</p>
<blockquote>
<p>NOTE: the prefix “test” was specified when this file was built so all
the methods and tables begin with <code>test_</code>.</p>
</blockquote>
<h4 id="helper-procedures">Helper Procedures</h4>
<div class="sourceCode" id="cb294"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for testing for the presence of a column/type</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_check_column_exists(table_name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>                                          decl TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">OUT</span> <span class="kw">present</span> BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> <span class="kw">present</span> <span class="op">:=</span> (<span class="kw">SELECT</span> <span class="kw">EXISTS</span>(<span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> sqlite_master</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">WHERE</span> tbl_name <span class="op">=</span> table_name <span class="kw">AND</span> sql GLOB decl));</span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p><code>check_column_exists</code> inspects <code>sqlite_master</code>
and returns true if a column matching <code>decl</code> exists.</p>
<div class="sourceCode" id="cb295"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for creating the schema version table</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_create_cql_schema_facets_if_needed()</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> test_cql_schema_facets(</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>    facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>    version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Here we actually create the <code>cql_schema_facets</code> table with
DDL inside a proc. In a non-schema-upgrade script the above would give a
name conflict.</p>
<div class="sourceCode" id="cb296"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for saving the schema version table</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_save_cql_schema_facets()</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> test_cql_schema_facets_saved;</span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> test_cql_schema_facets_saved(</span>
<span id="cb296-6"><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a>    facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb296-7"><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a>    version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb296-8"><a href="#cb296-8" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb296-9"><a href="#cb296-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> test_cql_schema_facets_saved</span>
<span id="cb296-10"><a href="#cb296-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test_cql_schema_facets;</span>
<span id="cb296-11"><a href="#cb296-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>The <code>save_sql_schema_facets</code> procedure simply makes a
snapshot of the current facets table. Later we use this snapshot to
report the differences by joining these tables.</p>
<div class="sourceCode" id="cb297"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for setting the schema version of a facet</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_set_facet_version(_facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>                                            _version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">INTO</span> test_cql_schema_facets (facet, version)</span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>       <span class="kw">VALUES</span>(_facet, _version);</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for getting the schema version of a facet</span></span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_get_facet_version(_facet TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb297-11"><a href="#cb297-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="kw">out</span> _version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb297-12"><a href="#cb297-12" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb297-13"><a href="#cb297-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span> TRY</span>
<span id="cb297-14"><a href="#cb297-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> _version <span class="op">:=</span> (<span class="kw">SELECT</span> version <span class="kw">FROM</span> test_cql_schema_facets</span>
<span id="cb297-15"><a href="#cb297-15" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">WHERE</span> facet <span class="op">=</span> _facet <span class="kw">LIMIT</span> <span class="dv">1</span> <span class="cf">IF</span> <span class="kw">NOTHING</span> <span class="op">-</span><span class="dv">1</span>);</span>
<span id="cb297-16"><a href="#cb297-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> TRY;</span>
<span id="cb297-17"><a href="#cb297-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span> CATCH</span>
<span id="cb297-18"><a href="#cb297-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> _version <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb297-19"><a href="#cb297-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> CATCH;</span>
<span id="cb297-20"><a href="#cb297-20" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>The two procedures <code>cql_get_facet_version</code> and
<code>cql_set_facet_version</code> do just what you would expect. Note
the use of <code>try</code> and <code>catch</code> to return a default
value if the select fails.</p>
<p>There are two additional helper procedures that do essentially the
same thing using a schema version index. These two methods exist only to
avoid unnecessary repeated string literals in the output file which
cause bloat.</p>
<div class="sourceCode" id="cb298"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for getting the schema version CRC for a version index</span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_get_version_crc(_v <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="kw">out</span> _crc <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> _crc <span class="op">:=</span> cql_facet_find(test_facets, printf(<span class="st">&#39;cql_schema_v%d&#39;</span>, _v));</span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for setting the schema version CRC for a version index</span></span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_set_version_crc(_v <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a>                                          _crc <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</span>
<span id="cb298-10"><a href="#cb298-10" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb298-11"><a href="#cb298-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">INTO</span> test_cql_schema_facets (facet, version)</span>
<span id="cb298-12"><a href="#cb298-12" aria-hidden="true" tabindex="-1"></a>       <span class="kw">VALUES</span>(<span class="st">&#39;cql_schema_v&#39;</span><span class="op">||</span>_v, _crc);</span>
<span id="cb298-13"><a href="#cb298-13" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>As you can see, these procedures are effectively specializations of
<code>cql_get_facet_version</code> and
<code>cql_set_facet_version</code> where the facet name is computed from
the integer.</p>
<p>Triggers require some special processing. There are so-called
“legacy” triggers that crept into the system. These begin with
<code>tr__</code> and they do not have proper tombstones. In fact some
are from early versions of CQL before they were properly tracked. To fix
any old databases that have these in them, we delete all triggers that
start with <code>tr__</code>. Note we have to use the <code>GLOB</code>
operator to do this, because <code>_</code> is the <code>LIKE</code>
wildcard.</p>
<div class="sourceCode" id="cb299"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc to reset any triggers that are on the old plan --</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> cql_exec_internal(sql TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>) <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_drop_legacy_triggers()</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">SELECT</span> name <span class="kw">from</span> sqlite_master</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>     <span class="kw">WHERE</span> <span class="kw">type</span> <span class="op">=</span> <span class="st">&#39;trigger&#39;</span> <span class="kw">AND</span> name GLOB <span class="st">&#39;tr__*&#39;</span>;</span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH C</span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">call</span> cql_exec_internal(printf(<span class="st">&#39;DROP TRIGGER %s;&#39;</span>, C.name));</span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<h4 id="baseline-schema">Baseline Schema</h4>
<p>The ‘baseline’ or ‘v0’ schema is unannotated (no <code>@create</code>
or <code>@recreate</code>). The first real schema management procedures
are for creating and dropping these tables.</p>
<div class="sourceCode" id="cb300"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_install_baseline_schema()</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TABLE</span> foo(</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>    rate LONG_INT,</span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>    rate_2 LONG_INT</span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb300-8"><a href="#cb300-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-9"><a href="#cb300-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TABLE</span> table2(</span>
<span id="cb300-10"><a href="#cb300-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb300-11"><a href="#cb300-11" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb300-12"><a href="#cb300-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-13"><a href="#cb300-13" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb301"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper proc for dropping baseline tables before installing the baseline schema</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_drop_baseline_tables()</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> foo;</span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> table2;</span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<h4 id="migration-procedures">Migration Procedures</h4>
<p>The next section declares the migration procedures that were in the
schema. These are expected to be defined elsewhere.</p>
<div class="sourceCode" id="cb302"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- declared upgrade procedures if any</span></span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> proc CreateName1Proc() <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> proc CreateName2Proc() <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> proc CreateId2Proc() <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> proc DeleteRate2Proc() <span class="kw">USING</span> <span class="kw">TRANSACTION</span>;</span></code></pre></div>
<p>The code below will refer to these migration procedures. We emit a
declaration so that we can use the names in context.</p>
<blockquote>
<p>NOTE: <code>USING TRANSACTION</code> when applied to a proc
declaration simply means the proc will access the database so it needs
to be provided with a <code>sqlite3 *db</code> parameter.</p>
</blockquote>
<h4 id="views">Views</h4>
<div class="sourceCode" id="cb303"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- drop all the views we know</span></span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_drop_all_views()</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">VIEW</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> live_view;</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">VIEW</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> another_live_view;</span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">VIEW</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> dead_view;</span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- create all the views we know</span></span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_create_all_views()</span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb303-12"><a href="#cb303-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">VIEW</span> live_view <span class="kw">AS</span></span>
<span id="cb303-13"><a href="#cb303-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb303-14"><a href="#cb303-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> foo;</span>
<span id="cb303-15"><a href="#cb303-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">VIEW</span> another_live_view <span class="kw">AS</span></span>
<span id="cb303-16"><a href="#cb303-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb303-17"><a href="#cb303-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> foo;</span>
<span id="cb303-18"><a href="#cb303-18" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>View migration is done by dropping all views and putting all views
back.</p>
<blockquote>
<p>NOTE: <code>dead_view</code> was not created, but we did try to drop
it if it existed.</p>
</blockquote>
<h4 id="indices">Indices</h4>
<div class="sourceCode" id="cb304"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- drop all the indices that are deleted or changing</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_drop_all_indices()</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;index_still_present_index_crc&#39;</span>) <span class="op">!=</span> <span class="op">-</span><span class="dv">6823087563145941851</span> <span class="cf">THEN</span></span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DROP</span> <span class="kw">INDEX</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> index_still_present;</span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">INDEX</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> index_going_away;</span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- create all the indices we need</span></span>
<span id="cb304-11"><a href="#cb304-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_create_indices()</span>
<span id="cb304-12"><a href="#cb304-12" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb304-13"><a href="#cb304-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;index_still_present_index_crc&#39;</span>) <span class="op">!=</span> <span class="op">-</span><span class="dv">6823087563145941851</span> <span class="cf">THEN</span></span>
<span id="cb304-14"><a href="#cb304-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CREATE</span> <span class="kw">INDEX</span> index_still_present <span class="kw">ON</span> table2 (name1, name2);</span>
<span id="cb304-15"><a href="#cb304-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;index_still_present_index_crc&#39;</span>, <span class="op">-</span><span class="dv">6823087563145941851</span>);</span>
<span id="cb304-16"><a href="#cb304-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb304-17"><a href="#cb304-17" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Indices are processed similarly to views, however we do not want to
drop indices that are not changing. Therefore we compute the CRC of the
index definition. At the start of the script any indices that are
condemned (e.g. <code>index_going_away</code>) are dropped as well as
any that have a new CRC. At the end of migration, changed or new indices
are (re)created using <code>cql_create_indices</code>.</p>
<h4 id="triggers">Triggers</h4>
<div class="sourceCode" id="cb305"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="kw">drop</span> <span class="kw">all</span> <span class="kw">the</span> <span class="kw">triggers</span> we know</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_drop_all_triggers()</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> test_cql_drop_legacy_triggers();</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TRIGGER</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> trigger_one;</span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- create all the triggers we know</span></span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_create_all_triggers()</span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb305-11"><a href="#cb305-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TRIGGER</span> trigger_one</span>
<span id="cb305-12"><a href="#cb305-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">ON</span> foo</span>
<span id="cb305-13"><a href="#cb305-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb305-14"><a href="#cb305-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DELETE</span> <span class="kw">FROM</span> table2 <span class="kw">WHERE</span> table2.<span class="kw">id</span> <span class="op">=</span> <span class="kw">new</span>.<span class="kw">id</span>;</span>
<span id="cb305-15"><a href="#cb305-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb305-16"><a href="#cb305-16" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Triggers are always dropped before migration begins and are
re-instated quite late in the processing as we will see below.</p>
<h4 id="caching-the-state-of-the-facets">Caching the state of the
facets</h4>
<p>To avoid selecting single rows out of the facets table repeatedly we
introduce this procedure whose job is to harvest the facets table and
store it in a dictionary. The helpers that do this were declared above.
You’ve already seen usage of the facets in the code above.</p>
<div class="sourceCode" id="cb306"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_setup_facets()</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span> TRY</span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> test_facets <span class="op">:=</span> cql_facets_new();</span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> test_cql_schema_facets;</span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">LOOP</span> FETCH C</span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">BEGIN</span></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a>      LET added <span class="op">:=</span> cql_facet_add(test_facets, C.facet, C.version);</span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span>;</span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> TRY;</span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span> CATCH</span>
<span id="cb306-12"><a href="#cb306-12" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- if table doesn&#39;t exist we just have empty facets, that&#39;s ok</span></span>
<span id="cb306-13"><a href="#cb306-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> CATCH;</span>
<span id="cb306-14"><a href="#cb306-14" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<h4 id="main-migration-script">Main Migration Script</h4>
<p>The main script orchestrates everything. There are inline comments
for all of it. The general order of events is:</p>
<ul>
<li>create schema facets table if needed</li>
<li>check main schema crc; if it matches we’re done here, otherwise
continue…</li>
</ul>
<p>These operations are done in
<code>test_perform_needed_upgrades</code> * drop all views * drop
condemned indices * fetch the current schema version * if version 0 then
install the baseline schema (see below) * for each schema version with
changes do the following: * create any tables that need to be created in
this version * add any columns that need to be added in this version *
run migration procs in this order: * create table * create column *
delete trigger * delete view * delete index * delete column * delete
table * drop any tables that need to be dropped in this version * mark
schema upgraded to the current version so far, and proceed to the next
version * each partial step is also marked as completed so that it can
be skipped if the script is run again * create all the views *
(re)create any indices that changed and are not dead * set the schema
CRC to the current CRC</p>
<p>That’s it… the details are below.</p>
<div class="sourceCode" id="cb307"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_perform_upgrade_steps()</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> column_exists BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> schema_version <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- dropping all views --</span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_drop_all_views();</span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- dropping condemned or changing indices --</span></span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_drop_all_indices();</span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- dropping condemned or changing triggers --</span></span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_drop_all_triggers();</span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- install baseline schema if needed ----</span></span>
<span id="cb307-15"><a href="#cb307-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-16"><a href="#cb307-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">0</span>, schema_version);</span>
<span id="cb307-17"><a href="#cb307-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="op">-</span><span class="dv">9177754326374570163</span> <span class="cf">THEN</span></span>
<span id="cb307-18"><a href="#cb307-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_install_baseline_schema();</span>
<span id="cb307-19"><a href="#cb307-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">0</span>, <span class="op">-</span><span class="dv">9177754326374570163</span>);</span>
<span id="cb307-20"><a href="#cb307-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-21"><a href="#cb307-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-22"><a href="#cb307-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- upgrade to schema version 2 ----</span></span>
<span id="cb307-23"><a href="#cb307-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-24"><a href="#cb307-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">2</span>, schema_version);</span>
<span id="cb307-25"><a href="#cb307-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="op">-</span><span class="dv">6840158498294659234</span> <span class="cf">THEN</span></span>
<span id="cb307-26"><a href="#cb307-26" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table table2 to add column name1 TEXT;</span></span>
<span id="cb307-27"><a href="#cb307-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-28"><a href="#cb307-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;table2&#39;</span>, <span class="st">&#39;*[( ]name1 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-29"><a href="#cb307-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-30"><a href="#cb307-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> table2 <span class="kw">ADD</span> <span class="kw">COLUMN</span> name1 TEXT;</span>
<span id="cb307-31"><a href="#cb307-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-32"><a href="#cb307-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-33"><a href="#cb307-33" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table table2 to add column name2 TEXT;</span></span>
<span id="cb307-34"><a href="#cb307-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-35"><a href="#cb307-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;table2&#39;</span>, <span class="st">&#39;*[( ]name2 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-36"><a href="#cb307-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-37"><a href="#cb307-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> table2 <span class="kw">ADD</span> <span class="kw">COLUMN</span> name2 TEXT;</span>
<span id="cb307-38"><a href="#cb307-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-39"><a href="#cb307-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-40"><a href="#cb307-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table table2 to add column name3 TEXT;</span></span>
<span id="cb307-41"><a href="#cb307-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-42"><a href="#cb307-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;table2&#39;</span>, <span class="st">&#39;*[( ]name3 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-43"><a href="#cb307-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-44"><a href="#cb307-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> table2 <span class="kw">ADD</span> <span class="kw">COLUMN</span> name3 TEXT;</span>
<span id="cb307-45"><a href="#cb307-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-46"><a href="#cb307-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-47"><a href="#cb307-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table table2 to add column name4 TEXT;</span></span>
<span id="cb307-48"><a href="#cb307-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-49"><a href="#cb307-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;table2&#39;</span>, <span class="st">&#39;*[( ]name4 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-50"><a href="#cb307-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-51"><a href="#cb307-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> table2 <span class="kw">ADD</span> <span class="kw">COLUMN</span> name4 TEXT;</span>
<span id="cb307-52"><a href="#cb307-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-53"><a href="#cb307-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-54"><a href="#cb307-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- data migration procedures</span></span>
<span id="cb307-55"><a href="#cb307-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;CreateName1Proc&#39;</span>) <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb307-56"><a href="#cb307-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> CreateName1Proc();</span>
<span id="cb307-57"><a href="#cb307-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;CreateName1Proc&#39;</span>, <span class="dv">2</span>);</span>
<span id="cb307-58"><a href="#cb307-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-59"><a href="#cb307-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;CreateName2Proc&#39;</span>) <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb307-60"><a href="#cb307-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> CreateName2Proc();</span>
<span id="cb307-61"><a href="#cb307-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;CreateName2Proc&#39;</span>, <span class="dv">2</span>);</span>
<span id="cb307-62"><a href="#cb307-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-63"><a href="#cb307-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-64"><a href="#cb307-64" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">2</span>, <span class="op">-</span><span class="dv">6840158498294659234</span>);</span>
<span id="cb307-65"><a href="#cb307-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-66"><a href="#cb307-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-67"><a href="#cb307-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- upgrade to schema version 3 ----</span></span>
<span id="cb307-68"><a href="#cb307-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-69"><a href="#cb307-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">3</span>, schema_version);</span>
<span id="cb307-70"><a href="#cb307-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="op">-</span><span class="dv">4851321700834943637</span> <span class="cf">THEN</span></span>
<span id="cb307-71"><a href="#cb307-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- creating table added_table</span></span>
<span id="cb307-72"><a href="#cb307-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-73"><a href="#cb307-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> added_table(</span>
<span id="cb307-74"><a href="#cb307-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb307-75"><a href="#cb307-75" aria-hidden="true" tabindex="-1"></a>        name1 TEXT</span>
<span id="cb307-76"><a href="#cb307-76" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb307-77"><a href="#cb307-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-78"><a href="#cb307-78" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">3</span>, <span class="op">-</span><span class="dv">4851321700834943637</span>);</span>
<span id="cb307-79"><a href="#cb307-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-80"><a href="#cb307-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-81"><a href="#cb307-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- upgrade to schema version 4 ----</span></span>
<span id="cb307-82"><a href="#cb307-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-83"><a href="#cb307-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">4</span>, schema_version);</span>
<span id="cb307-84"><a href="#cb307-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="op">-</span><span class="dv">6096284368832554520</span> <span class="cf">THEN</span></span>
<span id="cb307-85"><a href="#cb307-85" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table added_table to add column name2 TEXT;</span></span>
<span id="cb307-86"><a href="#cb307-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-87"><a href="#cb307-87" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;added_table&#39;</span>, <span class="st">&#39;*[( ]name2 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-88"><a href="#cb307-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-89"><a href="#cb307-89" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> added_table <span class="kw">ADD</span> <span class="kw">COLUMN</span> name2 TEXT;</span>
<span id="cb307-90"><a href="#cb307-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-91"><a href="#cb307-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-92"><a href="#cb307-92" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table foo to add column id2 INTEGER;</span></span>
<span id="cb307-93"><a href="#cb307-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-94"><a href="#cb307-94" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;foo&#39;</span>, <span class="st">&#39;*[( ]id2 INTEGER*&#39;</span>, column_exists);</span>
<span id="cb307-95"><a href="#cb307-95" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-96"><a href="#cb307-96" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">ADD</span> <span class="kw">COLUMN</span> id2 <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">12345</span>;</span>
<span id="cb307-97"><a href="#cb307-97" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-98"><a href="#cb307-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-99"><a href="#cb307-99" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- logical delete of column rate_2 from foo; -- no ddl</span></span>
<span id="cb307-100"><a href="#cb307-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-101"><a href="#cb307-101" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- data migration procedures</span></span>
<span id="cb307-102"><a href="#cb307-102" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;CreateId2Proc&#39;</span>) <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb307-103"><a href="#cb307-103" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> CreateId2Proc();</span>
<span id="cb307-104"><a href="#cb307-104" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;CreateId2Proc&#39;</span>, <span class="dv">4</span>);</span>
<span id="cb307-105"><a href="#cb307-105" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-106"><a href="#cb307-106" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;DeleteRate2Proc&#39;</span>) <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb307-107"><a href="#cb307-107" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> DeleteRate2Proc();</span>
<span id="cb307-108"><a href="#cb307-108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;DeleteRate2Proc&#39;</span>, <span class="dv">4</span>);</span>
<span id="cb307-109"><a href="#cb307-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-110"><a href="#cb307-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-111"><a href="#cb307-111" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">4</span>, <span class="op">-</span><span class="dv">6096284368832554520</span>);</span>
<span id="cb307-112"><a href="#cb307-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-113"><a href="#cb307-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-114"><a href="#cb307-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- upgrade to schema version 5 ----</span></span>
<span id="cb307-115"><a href="#cb307-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-116"><a href="#cb307-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">5</span>, schema_version);</span>
<span id="cb307-117"><a href="#cb307-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="dv">5720357430811880771</span> <span class="cf">THEN</span></span>
<span id="cb307-118"><a href="#cb307-118" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table foo to add column name TEXT;</span></span>
<span id="cb307-119"><a href="#cb307-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-120"><a href="#cb307-120" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;foo&#39;</span>, <span class="st">&#39;*[( ]name TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-121"><a href="#cb307-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-122"><a href="#cb307-122" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">ADD</span> <span class="kw">COLUMN</span> name TEXT;</span>
<span id="cb307-123"><a href="#cb307-123" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-124"><a href="#cb307-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-125"><a href="#cb307-125" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- logical delete of column rate from foo; -- no ddl</span></span>
<span id="cb307-126"><a href="#cb307-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-127"><a href="#cb307-127" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- dropping table added_table</span></span>
<span id="cb307-128"><a href="#cb307-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-129"><a href="#cb307-129" aria-hidden="true" tabindex="-1"></a>      <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> added_table;</span>
<span id="cb307-130"><a href="#cb307-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-131"><a href="#cb307-131" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">5</span>, <span class="dv">5720357430811880771</span>);</span>
<span id="cb307-132"><a href="#cb307-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-133"><a href="#cb307-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-134"><a href="#cb307-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">---- upgrade to schema version 6 ----</span></span>
<span id="cb307-135"><a href="#cb307-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-136"><a href="#cb307-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_get_version_crc(<span class="dv">6</span>, schema_version);</span>
<span id="cb307-137"><a href="#cb307-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> schema_version <span class="op">!=</span> <span class="dv">3572608284749506390</span> <span class="cf">THEN</span></span>
<span id="cb307-138"><a href="#cb307-138" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- altering table foo to add column name_2 TEXT;</span></span>
<span id="cb307-139"><a href="#cb307-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-140"><a href="#cb307-140" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_check_column_exists(<span class="st">&#39;foo&#39;</span>, <span class="st">&#39;*[( ]name_2 TEXT*&#39;</span>, column_exists);</span>
<span id="cb307-141"><a href="#cb307-141" aria-hidden="true" tabindex="-1"></a>      <span class="cf">IF</span> <span class="kw">NOT</span> column_exists <span class="cf">THEN</span></span>
<span id="cb307-142"><a href="#cb307-142" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">ADD</span> <span class="kw">COLUMN</span> name_2 TEXT;</span>
<span id="cb307-143"><a href="#cb307-143" aria-hidden="true" tabindex="-1"></a>      <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-144"><a href="#cb307-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-145"><a href="#cb307-145" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_cql_set_version_crc(<span class="dv">6</span>, <span class="dv">3572608284749506390</span>);</span>
<span id="cb307-146"><a href="#cb307-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb307-147"><a href="#cb307-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-148"><a href="#cb307-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_create_all_views();</span>
<span id="cb307-149"><a href="#cb307-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_create_all_indices();</span>
<span id="cb307-150"><a href="#cb307-150" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_create_all_triggers();</span>
<span id="cb307-151"><a href="#cb307-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;cql_schema_version&#39;</span>, <span class="dv">6</span>);</span>
<span id="cb307-152"><a href="#cb307-152" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_cql_set_facet_version(<span class="st">&#39;cql_schema_crc&#39;</span>, <span class="op">-</span><span class="dv">7714030317354747478</span>);</span>
<span id="cb307-153"><a href="#cb307-153" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>We have one more helper that will look for evidence that we’re trying
to move backwards to a previous schema version. This is not supported.
This procedure also arranges for the original facet versions to be saved
and it proceduces a difference in facets after the upgrade is done.</p>
<div class="sourceCode" id="cb308"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_perform_needed_upgrades()</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- check for downgrade --</span></span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> cql_facet_find(test_facets, <span class="st">&#39;cql_schema_version&#39;</span>) <span class="op">&gt;</span> <span class="dv">6</span> <span class="cf">THEN</span></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="st">&#39;downgrade detected&#39;</span> facet;</span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- save the current facets so we can diff them later --</span></span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_save_cql_schema_facets();</span>
<span id="cb308-9"><a href="#cb308-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> test_perform_upgrade_steps();</span>
<span id="cb308-10"><a href="#cb308-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-11"><a href="#cb308-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- finally produce the list of differences</span></span>
<span id="cb308-12"><a href="#cb308-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> T1.facet <span class="kw">FROM</span></span>
<span id="cb308-13"><a href="#cb308-13" aria-hidden="true" tabindex="-1"></a>      test_cql_schema_facets T1</span>
<span id="cb308-14"><a href="#cb308-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> test_cql_schema_facets_saved T2</span>
<span id="cb308-15"><a href="#cb308-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ON</span> T1.facet <span class="op">=</span> T2.facet</span>
<span id="cb308-16"><a href="#cb308-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">WHERE</span> T1.version <span class="kw">is</span> <span class="kw">not</span> T2.version;</span>
<span id="cb308-17"><a href="#cb308-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb308-18"><a href="#cb308-18" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>This is the main function for upgrades, it checks only the master
schema version. This function is separate so that the normal startup
path doesn’t have to have the code for the full upgrade case in it. This
lets linker order files do a superior job (since full upgrade is the
rare case).</p>
<div class="sourceCode" id="cb309"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test()</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> schema_crc <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- create schema facets information table --</span></span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> test_create_cql_schema_facets_if_needed();</span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- fetch the last known schema crc, if it&#39;s different do the upgrade --</span></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> test_cql_get_facet_version(<span class="st">&#39;cql_schema_crc&#39;</span>, schema_crc);</span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> schema_crc <span class="op">&lt;&gt;</span> <span class="op">-</span><span class="dv">7714030317354747478</span> <span class="cf">THEN</span></span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">BEGIN</span> TRY</span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_setup_facets();</span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> test_perform_needed_upgrades();</span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> TRY;</span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">BEGIN</span> CATCH</span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">CALL</span> cql_facets_delete(test_facets);</span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SET</span> test_facets <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb309-19"><a href="#cb309-19" aria-hidden="true" tabindex="-1"></a>      THROW;</span>
<span id="cb309-20"><a href="#cb309-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> CATCH;</span>
<span id="cb309-21"><a href="#cb309-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CALL</span> cql_facets_delete(test_facets);</span>
<span id="cb309-22"><a href="#cb309-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> test_facets <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb309-23"><a href="#cb309-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb309-24"><a href="#cb309-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- some canonical result for no differences --</span></span>
<span id="cb309-25"><a href="#cb309-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="st">&#39;no differences&#39;</span> facet;</span>
<span id="cb309-26"><a href="#cb309-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb309-27"><a href="#cb309-27" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<h4 id="temp-tables">Temp Tables</h4>
<p>We had no temporary tables in this schema, but if there were some
they get added to the schema after the upgrade check.</p>
<p>A procedure like this one is generated:</p>
<div class="sourceCode" id="cb310"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_cql_install_temp_schema()</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> tempy(</span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span></span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>This entry point can be used any time you need the temp tables. But
normally it is automatically invoked.</p>
<div class="sourceCode" id="cb311"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">---- install temp schema after upgrade is complete ----</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CALL</span> test_cql_install_temp_schema();</span></code></pre></div>
<p>That logic is emitted at the end of the test procedure.</p>
<h3 id="schema-regions">Schema Regions</h3>
<p>Schema Regions are designed to let you declare your schema in logical
regions whose dependencies are specified. It enforces the dependencies
you specify creating errors if you attempt to break the declared rules.
Schema regions allow you to generate upgrade scripts for parts of your
schema that can compose and be guaranteed to remain self-consistent.</p>
<h4 id="details">Details</h4>
<p>In many cases schema can be factored into logical and independent
islands. This is desireable for a number of reasons:</p>
<ul>
<li>so that the schema can go into different databases</li>
<li>so that the schema can be upgraded on a different schedule</li>
<li>so that “not relevant” schema can be omitted from distributions</li>
<li>so that parts of your schema that have no business knowing about
each other can be prevented from taking dependencies on each other</li>
</ul>
<p>These all have very real applications:</p>
<h5
id="e.g.-your-application-has-an-on-disk-and-an-in-memory-database">E.g.
Your Application has an on-disk and an in-memory database</h5>
<p>This creates basically three schema regions:</p>
<ol type="1">
<li>on disk: which cannot refer to the in-memory at all</li>
<li>in-memory: which cannot refer to the on-disk schema at all</li>
<li>cross-db: which refers to both, also in memory (optional)</li>
</ol>
<h5 id="your-application-needs-to-upgrade-each-of-the-above">Your
Application Needs To Upgrade Each of the Above</h5>
<p>There must be a separate upgrade script for both the island databases
and yet a different one for the “cross-db” database</p>
<h5 id="your-customer-doesnt-want-the-kitchen-sink-of-schema">Your
Customer Doesn’t Want The Kitchen Sink of Schema</h5>
<p>If you’re making a library with database support, your customers
likely want to be able to create databases that have only features they
want; you will want logical parts within your schema that can be
separated for cleanliness and distribution.</p>
<h4 id="declaring-regions-and-dependencies">Declaring Regions and
Dependencies</h4>
<p>Schema Regions let you create logical groupings, you simply declare
the regions you want and then start putting things into those regions.
The regions form a directed acyclic graph – just like C++ base classes.
You create regions like this:</p>
<div class="sourceCode" id="cb312"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region root;</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region extra using root;</span></span></code></pre></div>
<p>The above simply declares the regions – it doesn’t put anything into
them. In this case we now have a <code>root</code> region and an
<code>extra</code> region. The <code>root</code> schema items will not
be allowed to refer to anything in <code>extra</code>.</p>
<p>Without regions, you could also ensure that the above is true by
putting all the <code>extra</code> items afer the <code>root</code> in
the input file but things can get more complicated than that in general,
and the schema might also be in several files, complicating ordering as
the option. Also, relying on order could be problematic as it is quite
easy to put things in the wrong place (e.g. add a new <code>root</code>
item after the <code>extra</code> items). Making this a bit more
complicated, we could have:</p>
<div class="sourceCode" id="cb313"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region feature1 using extra;</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region feature2 using extra;</span></span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region everything using feature1, feature2;</span></span></code></pre></div>
<p>And now there are many paths to <code>root</code> from the
<code>everything</code> region; that’s ok but certainly it will be
tricky to do all that with ordering.</p>
<h4 id="using-regions">Using Regions</h4>
<p>An illustrative example, using the regions defined above:</p>
<div class="sourceCode" id="cb314"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region root;</span></span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> main(</span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span>,</span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a>  name text</span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-8"><a href="#cb314-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> names <span class="kw">as</span> <span class="kw">select</span> name <span class="kw">from</span> main <span class="kw">order</span> <span class="kw">by</span> name;</span>
<span id="cb314-9"><a href="#cb314-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-10"><a href="#cb314-10" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span>
<span id="cb314-11"><a href="#cb314-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-12"><a href="#cb314-12" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region extra;</span></span>
<span id="cb314-13"><a href="#cb314-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-14"><a href="#cb314-14" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> details(</span>
<span id="cb314-15"><a href="#cb314-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">references</span> main(<span class="kw">id</span>),</span>
<span id="cb314-16"><a href="#cb314-16" aria-hidden="true" tabindex="-1"></a>   details text</span>
<span id="cb314-17"><a href="#cb314-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb314-18"><a href="#cb314-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-19"><a href="#cb314-19" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_detail(id_ <span class="dt">integer</span>)</span>
<span id="cb314-20"><a href="#cb314-20" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb314-21"><a href="#cb314-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> T1.<span class="kw">id</span>, T1.details, T2.name <span class="kw">from</span> details T1</span>
<span id="cb314-22"><a href="#cb314-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inner</span> <span class="kw">join</span> main T2 <span class="kw">on</span> T1.<span class="kw">id</span> <span class="op">=</span> T2.<span class="kw">id</span></span>
<span id="cb314-23"><a href="#cb314-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> T1.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb314-24"><a href="#cb314-24" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb314-25"><a href="#cb314-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-26"><a href="#cb314-26" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span>
<span id="cb314-27"><a href="#cb314-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-28"><a href="#cb314-28" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region feature1;</span></span>
<span id="cb314-29"><a href="#cb314-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-30"><a href="#cb314-30" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> f1(</span>
<span id="cb314-31"><a href="#cb314-31" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">references</span> details(<span class="kw">id</span>),</span>
<span id="cb314-32"><a href="#cb314-32" aria-hidden="true" tabindex="-1"></a>   f1_info text</span>
<span id="cb314-33"><a href="#cb314-33" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb314-34"><a href="#cb314-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-35"><a href="#cb314-35" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_detail(id_ <span class="dt">integer</span>)</span>
<span id="cb314-36"><a href="#cb314-36" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb314-37"><a href="#cb314-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> T1.<span class="kw">id</span>, T1.details, T2.name, f1_info <span class="kw">from</span> details T1</span>
<span id="cb314-38"><a href="#cb314-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inner</span> <span class="kw">join</span> f T2 <span class="kw">on</span> T1.<span class="kw">id</span> <span class="op">=</span> T2.<span class="kw">id</span></span>
<span id="cb314-39"><a href="#cb314-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inner</span> <span class="kw">join</span> f1 <span class="kw">on</span> f1.<span class="kw">id</span> <span class="op">=</span> T1.<span class="kw">id</span></span>
<span id="cb314-40"><a href="#cb314-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> T1.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb314-41"><a href="#cb314-41" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb314-42"><a href="#cb314-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-43"><a href="#cb314-43" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span>
<span id="cb314-44"><a href="#cb314-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-45"><a href="#cb314-45" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region feature2;</span></span>
<span id="cb314-46"><a href="#cb314-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- you can use details, and main but not f1</span></span>
<span id="cb314-47"><a href="#cb314-47" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span></code></pre></div>
<p>With the structure above specified, even if a new contribution to the
<code>root</code> schema appears later, the rules enforce that this
region cannot refer to anything other than things in <code>root</code>.
This can be very important if schema is being included via
<code>#include</code> and might get pulled into the compilation in
various orders. A feature area might also have a named public region
that others things can depend on (e.g. some views) and private regions
(e.g. some tables, or whatever).</p>
<h4 id="region-visibility">Region Visibility</h4>
<p>Schema regions do not provide additional name spaces – the names of
objects should be unique across all regions. In other words, regions do
not hide or scope entity names; rather they create errors if
inappropriate names are used.</p>
<p>Case 1: The second line will fail semantic validation because table
<code>A</code> already exists</p>
<div class="sourceCode" id="cb315"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- obvious standard name conflict</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>, name text);</span></code></pre></div>
<p>Case 2: This fails for the same reason as case #1. Table
<code>A</code> already exists</p>
<div class="sourceCode" id="cb316"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_region root;</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- table A is in no region</span></span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_region root:</span></span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- this table A is in the root region, still an error</span></span>
<span id="cb316-6"><a href="#cb316-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>, name text);</span>
<span id="cb316-7"><a href="#cb316-7" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_region;</span></span></code></pre></div>
<p>Case 3: Again fails for the same reason as case #1. Table
<code>A</code> already exist in region <code>extra</code>, and you
cannot define another table with the same name in another region.</p>
<div class="sourceCode" id="cb317"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_region root;</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_region extra;</span></span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_region extra;</span></span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- so far so good</span></span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_region;</span></span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_region root;</span></span>
<span id="cb317-10"><a href="#cb317-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- no joy, this A conflicts with the previous A</span></span>
<span id="cb317-11"><a href="#cb317-11" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="kw">id</span> <span class="dt">integer</span>, name text);</span>
<span id="cb317-12"><a href="#cb317-12" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_region;</span></span></code></pre></div>
<p>Really the visibility rules couldn’t be anything other than the
above, as SQLite has no knowledge of regions at all and so any exotic
name resolution would just doom SQLite statements to fail when they
finally run.</p>
<h5 id="exception-for-...-like-table-statement">Exception for
<code>"... LIKE &lt;table&gt;"</code> statement</h5>
<p>The rules above are enforced for all constructs except for where the
syntactic sugar <code>... LIKE &lt;table&gt;</code> forms, which can
happen in a variety of statements. This form doesn’t create a dependence
on the table (but does create a dependence on its shape). When CQL
generates output, the <code>LIKE</code> construct is replaced with the
actual names of the columns it refers to. But these are independent
columns, so this is simply a keystroke saver. The table (or view,
cursor, etc.) reference will be gone.</p>
<p>These cases below will succeed.</p>
<div class="sourceCode" id="cb318"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_region root;</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A (<span class="op">..</span>.);</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> B (<span class="op">....</span>);</span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> C {<span class="op">..</span>.}</span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_region root;</span></span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> AA(<span class="kw">LIKE</span> A);</span>
<span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> BB(<span class="kw">LIKE</span> B);</span>
<span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> CC(<span class="kw">LIKE</span> C);</span>
<span id="cb318-10"><a href="#cb318-10" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_region;</span></span></code></pre></div>
<blockquote>
<p>NOTE: this exception may end up causing maintenance problems and so
it might be revisited in the future.</p>
</blockquote>
<h4 id="maintaining-schema-in-pieces">Maintaining Schema in Pieces</h4>
<p>When creating upgrade scripts, using the
<code>--rt schema_upgrade</code> flags you can add region options
<code>--include_regions a b c</code> and
<code>--exclude_regions d e f</code> per the following:</p>
<p>Included regions: * must be valid region names – the base types are
walked to compute all the regions that are “in” * declarations are
emitted in the upgrade for all of the “in” objects – “exclude” does not
affect the declarations</p>
<p>Excluded regions: * must be valid region names and indicate parts of
schema that are upgraded elsewhere, perhaps with a seperate CQL run, a
different automatic upgrade, or even a manual mechanism * upgrade code
will be generated for all the included schema, but not for the excluded
regions and their contents</p>
<p>Example: Referring to the regions above you might do something like
this</p>
<div class="sourceCode" id="cb319"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a><span class="co"># All of these also need a --global_proc param for the entry point but that&#39;s not relevant here</span></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a><span class="ex">cql</span> <span class="at">--in</span> schema.sql <span class="at">--cg</span> shared.sql <span class="at">--rt</span> schema_upgrade  <span class="at">--include_regions</span> extra</span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a><span class="ex">cql</span> <span class="at">--in</span> schema.sql <span class="at">--cg</span> f1.cql <span class="at">--rt</span> schema_upgrade <span class="at">--include_regions</span> feature1 <span class="at">--exclude_regions</span> extra</span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cql</span> <span class="at">--in</span> schema.sql <span class="at">--cg</span> f2.cql <span class="at">--rt</span> schema_upgrade <span class="at">--include_regions</span> feature2 <span class="at">--exclude_regions</span> extra</span></code></pre></div>
<p>The first command generates all the shared schema for regions
<code>root</code> and <code>extra</code> because <code>extra</code>
contains <code>root</code></p>
<p>The second command declares all of <code>root</code> and
<code>extra</code> so that the <code>feature1</code> things can refer to
them, however the upgrade code for these shared regions is not emitted.
Only the upgrade for schema in <code>feature1</code> is emitted.
<code>feature2</code> is completely absent. This will be ok because we
know <code>feature1</code> cannot depend on <code>feature2</code> and
<code>extra</code> is assumed to be upgraded elsewhere (such as in the
previous line).</p>
<p>The third command declares all of <code>root</code> and
<code>extra</code> so that the <code>feature2</code> things can refer to
them, however the upgrade code for these shared regions is not emitted.
Only the upgrade for schema in <code>feature2</code> is emitted.
<code>feature1</code> is completely absent.</p>
<p>Note that in the above examples, CQL is generating more CQL to be
compiled again (a common pattern). The CQL upgrade scripts need to be
compiled as usual to produce executable code. Thus the output of this
form includes the schema declarations and executable DDL.</p>
<h5 id="schema-not-in-any-region">Schema Not In Any Region</h5>
<p>For schema that is not in any region you might imagine that it is a
special region <code>&lt;none&gt;</code> that depends on everything. So
basically you can put anything there. Schema that is in any region
cannot ever refer to schema that is in <code>&lt;none&gt;</code>.</p>
<p>When upgrading, if any include regions are specified then
<code>&lt;none&gt;</code> will not be emitted at all. If you want an
upgrader for just <code>&lt;none&gt;</code> this is possible with an
assortment of exclusions. You can always create arbitrary grouping
regions to make this easier. A region named <code>any</code> that uses
all other regions would make this simple.</p>
<p>In general, best practice is that there is no schema in
<code>&lt;none&gt;</code>, but since most SQL code has no regions some
sensible meaning has to be given to DDL before it gets region
encodings.</p>
<h4 id="deployable-regions">Deployable Regions</h4>
<p>Given the above we note that some schema regions correspond to the
way that we will deploy the schema. We want those bundles to be safe to
deploy but to in order to be so we need a new notion – a deployable
region. To make this possible CQL includes the following:</p>
<ul>
<li>You can declare a region as deployable using
<code>@declare_deployable_region</code></li>
<li>CQL computes the covering of a deployable region: its transitive
closure up to but not including any deployable regions it
references</li>
<li>No region is allowed to depend on a region that is within the
interior of a different deployable region, but you can depend on the
deployable region itself</li>
</ul>
<p>Because of the above, each deployable region is in fact a well
defined root for the regions it contains. The deployable region becomes
the canonical way in which a bundle of regions (and their content) is
deployed and any given schema item can be in only one deployable
region.</p>
<h5 id="motivation-and-examples">Motivation and Examples</h5>
<p>As we saw above, regions are logical groupings of tables/views/etc
such that if an entity is in some region <code>R</code> then it is
allowed to only refer to the things that <code>R</code> declared as
dependencies <code>D1</code>, <code>D2</code>, etc. and their transitive
closures. You can make as many logical regions as you like and you can
make them as razor thin as you like; they have no physical reality but
they let you make as many logical groups of things as you might
want.</p>
<p>Additionally, when we’re deploying schema you generally need to do it
in several pieces. E.g. if we have tables that go in an in-memory
database then defining a region that holds all the in-memory tables
makes it easy to, say, put all those in-memory tables into a particular
deployment script.</p>
<p>Now we come to the reason for deployable regions. From CQL’s
perspective, all regions are simply logical groups; some grouping is
then meaningful to programmers but has no physical reality. This means
you’re free to reorganize tables etc. as you see fit into new or
different regions when things should move. Only, that’s not quite true.
The fact that we deploy our schema in certain ways means while most
logical moves are totally fine, if you were to move a table from, say,
the main database region to the in-memory region you would be causing a
major problem. Some installations may already have the table in the main
area and there would be nothing left in the schema to tell CQL to drop
the table from the main database – the best you can hope for is the new
location gets a copy of the table the old location keeps it and now
there are name conflicts forever.</p>
<p>So, the crux of the problem is this: We want to let you move schema
freely between logical regions in whatever way makes sense to you, but
once you pick the region you are going to deploy in, you cannot change
that.</p>
<p>To accomplish this, CQL needs to know that some of the regions are
deployable regions and there have to be rules to make it all makes
sense. Importantly, every region has to be contained in at most one
deployable region.</p>
<p>Since the regions form a DAG we must create an error if any region
could ever roll up to two different deployable regions. The easiest way
to describe this rule is “no peeking” – the contents of a deployable
region are “private” they can refer to each other in any DAG shape but
outside of the deployable region you can only refer to its root. So you
can still compose them but each deployable region owns a well-defined
covering. Note that you can make as many fine-grained deployable regions
as you want; you don’t actually have to deploy them separately, but you
get stronger rules about the sharing when you do.</p>
<p>Here’s an example:</p>
<pre><code>Master Deployment 1
  Feature 1 (Deployable)
    logical regions for feature 1
    Core (Deployable)
      logical regions for core
  Feature 2 (Deployable)
    logical regions for feature 2
    Core
      ...

Master Deployment 2
  Feature 1 (Deployable)
    ...

  Feature 3 (Deployable)
    logical regions for feature 3</code></pre>
<p>In the above: * none of the logical regions for feature 1, 2, 3 are
allowed to refer to logical regions in any other feature, though any of
them could refer to Core (but not directly to what is inside Core) *
within those regions you can make any set of groupings that makes sense
and you can change them over time as you see fit, with some restrictions
* any such regions are not allowed to move to a different Feature group
(because those are deployment regions) * the Master Deployment regions
just group features in ways we’d like to deploy them; in this case there
are two deployments: one that includes Feature 1 &amp; 2 and another
that includes Feature 1 &amp; 3 * the deployable region boundaries are
preventing Feature 1 regions from using Feature 2 regions in an ad hoc
way (i.e. you can’t cheat by taking a direct dependency on something
inside a different feature), but both Features can use Core * Feature 3
doesn’t use Core but Core will still be in Master Deployment 2 due to
Feature 1</p>
<p>Note that the deployable regions for Feature 1, 2, and 3 aren’t
actually deployed alone, but they are adding enforcement that makes the
features cleaner</p>
<p>Because of how upgrades work, “Core” could have its own upgrader.
Then when you create the upgrader for Master Deployment 1 and 2, you can
specify “exclude Core” in which case those tables are assumed to be
updated independently. You could create as many or as few independently
upgrade-able things with this pattern. Because regions are not allowed
to “peek” inside of a deployable region, you can reorganize your logical
regions without breaking other parts of the schema.</p>
<h4 id="private-regions">Private Regions</h4>
<p>The above constructs create a good basis for creating and composing
regions, but a key missing aspect is the ability to hide internal
details in the logical groups. This becomes increasingly important as
your desire to modularize schema grows; you will want to have certain
parts that can change without worrying about breaking others and without
fear that there are foreign keys and so forth referring to them.</p>
<p>To accomplish this, CQL provides the ability to compose schema
regions with the optional <code>private</code> keyword. In the following
example there will be three regions creatively named <code>r1</code>,
<code>r2</code>, and <code>r3</code>. Region <code>r2</code> consumes
<code>r1</code> privately and therefore <code>r3</code> is not allowed
to use things in <code>r1</code> even though it consumes
<code>r2</code>. When creating an upgrade script for <code>r3</code> you
will still need (and will get) all of <code>r2</code> and
<code>r1</code>, but from a visibility perspective <code>r3</code> can
only directly depend on <code>r2</code>.</p>
<div class="sourceCode" id="cb321"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region r1;</span></span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region r2 using r1 private;</span></span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a><span class="ot">@declare_schema_region r3 using r2;</span></span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region r1;</span></span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> r1_table(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>);</span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span>
<span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region r2;</span></span>
<span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> r2_table(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> <span class="kw">references</span> r1_table(<span class="kw">id</span>));</span>
<span id="cb321-11"><a href="#cb321-11" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span>
<span id="cb321-12"><a href="#cb321-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-13"><a href="#cb321-13" aria-hidden="true" tabindex="-1"></a><span class="ot">@begin_schema_region r3;</span></span>
<span id="cb321-14"><a href="#cb321-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-15"><a href="#cb321-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is OK</span></span>
<span id="cb321-16"><a href="#cb321-16" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> r3_table_2(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> <span class="kw">references</span> r2_table(<span class="kw">id</span>));</span>
<span id="cb321-17"><a href="#cb321-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-18"><a href="#cb321-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is an error, no peeking into r1</span></span>
<span id="cb321-19"><a href="#cb321-19" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> r3_table_1(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> <span class="kw">references</span> r1_table(<span class="kw">id</span>));</span>
<span id="cb321-20"><a href="#cb321-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-21"><a href="#cb321-21" aria-hidden="true" tabindex="-1"></a><span class="ot">@end_schema_region;</span></span></code></pre></div>
<p>As expected <code>r2</code> is still allowed to use <code>r1</code>
because your private regions are not private from yourself. So you may
think it’s easy to work around this privacy by simply declaring a direct
dependency on r1 wherever you need it.</p>
<pre><code>@declare_schema_region my_sneaky_region using r1, other_stuff_I_need;</code></pre>
<p>That would seem to make it all moot. However, this is where
deployable regions come in. Once you bundle your logical regions in a
deployable region there’s no more peeking inside the the deployable
region. So we could strengthen the above to:</p>
<pre><code>@declare_deployable_region r2 using r1 private;</code></pre>
<p>Once this is done it becomes an error to try to make new regions that
peek into <code>r2</code>; you have to take all of <code>r2</code> or
none of it – and you can’t see the private parts. Of course you can do
region wrapping at any level so you can have as many subgroups as you
like, whatever is useful. You can even add additional deployable regions
that aren’t actually deployed to get the “hardened” grouping at no
cost.</p>
<p>So, in summary, to get true privacy, first make whatever logical
regions you like that are helpful. Put privacy where you need/want it.
Import logical regions as much as you want in your own bundle of
regions. Then wrap that bundle up in a deployable region (they nest) and
then your private regions are safe from unwanted usage.</p>
<h3 id="unsubscription-and-resubscription-features">Unsubscription and
Resubscription Features</h3>
<p>Any significant library that is centered around a database is likely
to accrue significant amounts of schema to support its features. Often
users of the library don’t want all its features and therefore don’t
want all of its schema. CQL’s primary strategy is to allow the library
author to divide the schema into regions and then the consumer of the
library may generate a suitable schema deployer that deploys only the
desired regions. You simply subscribe to the regions you want.</p>
<p>The <code>@unsub</code> construct deals with the unfortunate
situation of over-subscription. In the event that a customer has
subscribed to regions that it turns out they don’t need, or if indeed
the regions are not fine-grained enough, they may wish to (possibly much
later) unsubscribe from particular tables or entire regions that they
previously had included.</p>
<p>Unfortunately it’s not so trivial as to simply remove the regions
after the fact. The problem is that there might be billions of devices
that already have the undesired tables and are paying the initialization
costs for them. Affirmatively removing the tables is highly desirable
and that means a forward-looking annotation is necessary to tell the
upgrader to generate <code>DROP</code> statements at some point.
Furthermore, a customer might decide at some point later that now is the
time they need the schema in question, so resubcription also has to be
possible.</p>
<h4 id="unsubscription-and-resubscription">Unsubscription and
Resubscription</h4>
<p>To accomplish this we add the following construct:</p>
<div class="sourceCode" id="cb324"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@unsub(table_name);</span></span></code></pre></div>
<p>The effects of a valid <code>@unsub</code> are as follows:</p>
<ul>
<li>The table is no longer accessible by statements</li>
<li>If the table is marked <code>@create</code>, then “DROP IF EXISTS
table_name” is emitted into the upgrade steps for
<em>version_number</em></li>
<li>If the table is <code>@recreate</code> the table is unconditionally
dropped as though it had been deleted</li>
<li>The JSON includes the unsub details in a new subscriptions
section</li>
</ul>
<p>The compiler ensures that the directives are valid and stay
valid.</p>
<h4 id="validations-for-unsubtable">Validations for <span
class="citation" data-cites="unsub">@unsub</span>(<em>table</em>):</h4>
<ul>
<li><em>table</em> must be a valid table name</li>
<li><em>table</em> must not be already unsubscribed</li>
<li>If <em>table</em> must not be marked with <code>@delete</code>
<ul>
<li>unsubscribing from a table after it’s been outright deleted is
clearly a mistake</li>
</ul></li>
<li>For every child table – those that mention this table using
<code>REFERENCES</code>
<ul>
<li>The child must be already deleted or unsubscribed</li>
<li>The deletion or unsubscription must have happened at a version &lt;=
<em>version</em></li>
</ul></li>
<li><em>table</em> is marked unsubscribed for purposes of further
analysis</li>
</ul>
<blockquote>
<p>CAUTION: The legacy form <code>@unsub</code>(<em>version</em>,
<em>table</em>) is supported but deprecated, and will soon be an error.
The <em>version</em> is ignored. The legacy <code>@resub</code>
directive is now an error; Resubscription is accomplished by simply
removing the relevant <code>@unsub</code> directive(s).</p>
</blockquote>
<h4 id="previous-schema-validations-for-unsub">Previous Schema
validations for <span class="citation"
data-cites="unsub">@unsub</span></h4>
<p>Unsubscriptions may be removed when they are no longer desired in
order to resubscribe as long as this results in a valid chain of foreign
keys.</p>
<p>These validations are sufficient to guarantee a constistent logical
history for unsubscriptions.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-11-previous-schema-validation">Chapter 11: Previous
Schema Validation</h2>
<p>As we saw in the previous chapter, CQL includes powerful schema
management tools for creating automatic upgrade scripts for your
databases. However, not all schema alterations are possible
after-the-fact and so CQL also includes schema comparison tools to help
you avoid problems as you version your schema over time.</p>
<p>You can compare the previous version of a schema with the current
version to do additional checks such as:</p>
<ul>
<li>the data type of a column may not change</li>
<li>the attributes of a column (e.g. nullable, default value) may not
change</li>
<li>columns can’t be renamed</li>
<li>columns can’t be removed, only marked delete</li>
<li>new columns must be at the end of the table and marked with
create</li>
<li>created columns have to be created in a schema version &gt;= any
that previously existed (no creating columns in the past)</li>
<li>nothing other than new columns at the end may be added to a table
(e.g. new PK/UK is right out)</li>
<li>new tables must be marked create, deleted tables must be marked
delete</li>
<li>new views must be marked create, deleted views must be marked
delete</li>
<li>new indices must be marked create, deleted indices must be marked
delete</li>
<li>an item that was previously a table/view cannot turn into the other
one</li>
<li>version numbers in the annotations may not ever change</li>
<li>if any annotation has a migration proc associated with it, it cannot
change to a different proc later</li>
<li>created tables, views, indices have to be created in a schema
version &gt;= any that previously existed (no creating tables in the
past)</li>
<li>there may be other checks not mentioned here</li>
</ul>
<p>When checking <code>@recreate</code> tables against the previous
schema version for errors, these checks are done:</p>
<ul>
<li>suppress checking of any table facet changes in previous schema on
recreate tables; you can do anything you want</li>
<li>allow new <code>@recreate</code> tables to appear with no
<code>@create</code> needed</li>
<li>allow a table to go from “original schema” (no annotation) to
<code>@recreate</code> but not back</li>
<li>allow a table to go from <code>@recreate</code> to
<code>@create</code> at the current schema version</li>
<li>allow a table to go from recreate directly to <code>@delete</code>
at the current schema version</li>
<li>do not allow a table to go from <code>@create</code> or
<code>@delete</code> state to <code>@recreate</code></li>
</ul>
<p>All of these are statically checked.</p>
<p>To use these tools, you must run CQL in a mode where it has both the
proposed and existing schema in its input stream, then it can provide
suitable errors if any unsupported change is about to happen.</p>
<h3 id="basic-usage">Basic Usage</h3>
<p>The normal way that you do previous schema validation is to create an
input file that provides both schema.</p>
<p>This file may look something like this:</p>
<div class="sourceCode" id="cb325"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- prev_check.sql</span></span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span>,</span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>  new_field text @create(<span class="dv">1</span>)</span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a><span class="ot">@previous_schema;</span></span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-9"><a href="#cb325-9" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb325-10"><a href="#cb325-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span></span>
<span id="cb325-11"><a href="#cb325-11" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>So, here the old version of <code>foo</code> will be validated
against the new version and all is well. A new nullable text field was
added at the end.</p>
<p>In practice these comparisons are likely to be done in a somewhat
more maintainable way, like so:</p>
<div class="sourceCode" id="cb326"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- prev_check.sql</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>#include <span class="ot">&quot;table1.sql&quot;</span></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>#include <span class="ot">&quot;table2.sql&quot;</span></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>#include <span class="ot">&quot;table3.sql&quot;</span></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@previous_schema;</span></span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>#include <span class="ot">&quot;previous.sql&quot;</span></span></code></pre></div>
<p>Now importantly, in this configuration, everything that follows the
<code>@previous_schema</code> directive does not actually contribute to
the declared schema. This means the <code>--rt schema</code> result type
will not see it. Because of this, you can do your checking operation
like so:</p>
<div class="sourceCode" id="cb327"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cc</span> <span class="at">-E</span> <span class="at">-x</span> c prev_check.sql <span class="kw">|</span> <span class="ex">cql</span> <span class="at">--cg</span> new_previous_schema.sql <span class="at">--rt</span> schema</span></code></pre></div>
<p>The above command will generate the schema in new_previous_schema
and, if this command succeeds, it’s safe to replace the existing
<code>previous.sql</code> with <code>new_previous_schema</code>.</p>
<blockquote>
<p>NOTE: you can bootstrap the above by leaving off the
<code>@previous_schema</code> and what follows to get your first
previous schema from the command above.</p>
</blockquote>
<p>Now, as you can imagine, comparing against the previous schema allows
many more kinds of errors to be discovered. What follows is a large
chunk of the CQL tests for this area taken from the test files
themselves. For easy visibility I have brought each fragment of current
and previous schema close to each other and I show the errors that are
reported. We start with a valid fragment and go from there.</p>
<h4 id="case-1-no-problemo">Case 1 : No problemo</h4>
<div class="sourceCode" id="cb328"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>  rate <span class="dt">long</span> <span class="dt">int</span> @delete(<span class="dv">5</span>, deletor),</span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>  rate_2 <span class="dt">long</span> <span class="dt">int</span> @delete(<span class="dv">4</span>),</span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a>  id2 <span class="dt">integer</span> @create(<span class="dv">4</span>),</span>
<span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a>  name text @create(<span class="dv">5</span>),</span>
<span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a>  name_2 text @create(<span class="dv">6</span>)</span>
<span id="cb328-8"><a href="#cb328-8" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb328-9"><a href="#cb328-9" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb328-10"><a href="#cb328-10" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb328-11"><a href="#cb328-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb328-12"><a href="#cb328-12" aria-hidden="true" tabindex="-1"></a>  rate <span class="dt">long</span> <span class="dt">int</span> @delete(<span class="dv">5</span>, deletor),</span>
<span id="cb328-13"><a href="#cb328-13" aria-hidden="true" tabindex="-1"></a>  rate_2 <span class="dt">long</span> <span class="dt">int</span> @delete(<span class="dv">4</span>),</span>
<span id="cb328-14"><a href="#cb328-14" aria-hidden="true" tabindex="-1"></a>  id2 <span class="dt">integer</span> @create(<span class="dv">4</span>),</span>
<span id="cb328-15"><a href="#cb328-15" aria-hidden="true" tabindex="-1"></a>  name text @create(<span class="dv">5</span>),</span>
<span id="cb328-16"><a href="#cb328-16" aria-hidden="true" tabindex="-1"></a>  name_2 text @create(<span class="dv">6</span>)</span>
<span id="cb328-17"><a href="#cb328-17" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The table <code>foo</code> is the same! It doesn’t get any easier
than that.</p>
<h4 id="case-2-table-create-version-changed">Case 2 : table create
version changed</h4>
<div class="sourceCode" id="cb329"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_create_version_changed(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>);</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_create_version_changed(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">2</span>);</span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-5"><a href="#cb329-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:15</span> : <span class="kw">in</span> str : <span class="kw">current</span> <span class="kw">create</span> version <span class="kw">not</span> equal <span class="kw">to</span></span>
<span id="cb329-6"><a href="#cb329-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">create</span> version <span class="cf">for</span> <span class="st">&#39;t_create_version_changed&#39;</span></span></code></pre></div>
<p>You can’t change the version a table was created in. Here the new
schema says it appeared in version 1. The old schema says 2.</p>
<h4 id="case-3-table-delete-version-changed">Case 3 : table delete
version changed</h4>
<div class="sourceCode" id="cb330"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_delete_version_changed(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>);</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_delete_version_changed(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">2</span>);</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:18</span> : <span class="kw">in</span> str : <span class="kw">current</span> <span class="kw">delete</span> version <span class="kw">not</span> equal <span class="kw">to</span></span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">delete</span> version <span class="cf">for</span> <span class="st">&#39;t_delete_version_changed&#39;</span></span></code></pre></div>
<p>You can’t change the version a table was deleted in. Here the new
schema says it was gone in version 1. The old schema says 2.</p>
<h4 id="case-4-table-not-present-in-new-schema">Case 4 : table not
present in new schema</h4>
<div class="sourceCode" id="cb331"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- t_not_present_in_new_schema is gone</span></span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_not_present_in_new_schema(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:176</span> : <span class="kw">in</span> create_table_stmt : <span class="kw">table</span> was <span class="kw">present</span> but now it</span>
<span id="cb331-6"><a href="#cb331-6" aria-hidden="true" tabindex="-1"></a>does <span class="kw">not</span> exist (<span class="kw">use</span> @delete <span class="kw">instead</span>) <span class="st">&#39;t_not_present_in_new_schema&#39;</span></span></code></pre></div>
<p>So here <code>t_not_present_in_new_schema</code> was removed, it
should have been marked with <code>@delete</code>. You don’t remove
tables.</p>
<h4 id="case-5-table-is-now-a-view">Case 5 : table is now a view</h4>
<div class="sourceCode" id="cb332"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> t_became_a_view <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> <span class="kw">id</span> @create(<span class="dv">6</span>);</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_became_a_view(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:24</span> : <span class="kw">in</span> create_view_stmt : <span class="dt">object</span> was a <span class="kw">table</span> but <span class="kw">is</span> now a</span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a><span class="kw">view</span> <span class="st">&#39;t_became_a_view&#39;</span></span></code></pre></div>
<p>Tables can’t become views…</p>
<h4 id="case-6-table-was-in-base-schema-now-created">Case 6 : table was
in base schema, now created</h4>
<div class="sourceCode" id="cb333"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_created_in_wrong_version(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>);</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_created_in_wrong_version(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:27</span> : <span class="kw">in</span> str : <span class="kw">current</span> <span class="kw">create</span> version <span class="kw">not</span> equal <span class="kw">to</span> <span class="kw">previous</span></span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> version <span class="cf">for</span> <span class="st">&#39;t_created_in_wrong_version&#39;</span></span></code></pre></div>
<p>Here a version annotation is added after the fact. This item was
already in the base schema.</p>
<h4 id="case-7-table-was-in-base-schema-now-deleted-ok">Case 7: table
was in base schema, now deleted (ok)</h4>
<div class="sourceCode" id="cb334"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_was_correctly_deleted(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>);</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_was_correctly_deleted(<span class="kw">id</span> <span class="dt">integer</span>);</span></code></pre></div>
<p>No errors here, just a regular delete.</p>
<h4 id="case-8-column-name-changed">Case 8: column name changed</h4>
<div class="sourceCode" id="cb335"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_name_changed(id_ <span class="dt">integer</span>);</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_name_changed(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:33</span> : <span class="kw">in</span> str : <span class="kw">column</span> name <span class="kw">is</span> different <span class="kw">between</span> <span class="kw">previous</span> <span class="kw">and</span></span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a><span class="kw">current</span> <span class="kw">schema</span> <span class="st">&#39;id_&#39;</span></span></code></pre></div>
<p>You can’t rename columns. We could support this but it’s a bit of a
maintenance nightmare and logical renames are possible easily without
doing physical renames.</p>
<h4 id="case-9-column-type-changed">Case 9 : column type changed</h4>
<div class="sourceCode" id="cb336"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_type_changed(<span class="kw">id</span> <span class="dt">real</span>);</span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_type_changed(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:36</span> : <span class="kw">in</span> str : <span class="kw">column</span> <span class="kw">type</span> <span class="kw">is</span> different <span class="kw">between</span> <span class="kw">previous</span></span>
<span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a><span class="kw">and</span> <span class="kw">current</span> <span class="kw">schema</span> <span class="st">&#39;id&#39;</span></span></code></pre></div>
<p>You can’t change the type of a column.</p>
<h4 id="case-10-column-attribute-changed">Case 10 : column attribute
changed</h4>
<div class="sourceCode" id="cb337"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_attribute_changed(<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_attribute_changed(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:39</span> : <span class="kw">in</span> str : <span class="kw">column</span> <span class="kw">type</span> <span class="kw">is</span> different <span class="kw">between</span> <span class="kw">previous</span></span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a><span class="kw">and</span> <span class="kw">current</span> <span class="kw">schema</span> <span class="st">&#39;id&#39;</span></span></code></pre></div>
<p>Change of column attributes counts as a change of type.</p>
<h4 id="case-11-column-version-changed-for-delete">Case 11: column
version changed for delete</h4>
<div class="sourceCode" id="cb338"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_delete_version_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> @delete(<span class="dv">1</span>));</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_delete_version_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> @delete(<span class="dv">2</span>));</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:42</span> : <span class="kw">in</span> str : <span class="kw">column</span> <span class="kw">current</span> <span class="kw">delete</span> version <span class="kw">not</span> equal <span class="kw">to</span></span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">delete</span> version <span class="st">&#39;id2&#39;</span></span></code></pre></div>
<p>You can’t change the delete version after it has been set.</p>
<h4 id="case-12-column-version-changed-for-create">Case 12 : column
version changed for create</h4>
<div class="sourceCode" id="cb339"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_create_version_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> @create(<span class="dv">1</span>));</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_create_version_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> @create(<span class="dv">2</span>));</span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:45</span> : <span class="kw">in</span> str : <span class="kw">column</span> <span class="kw">current</span> <span class="kw">create</span> version <span class="kw">not</span> equal <span class="kw">to</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">create</span> version <span class="st">&#39;id2&#39;</span></span></code></pre></div>
<p>You can’t change the create version after it has been set.</p>
<h4 id="case-13-column-default-value-changed">Case 13 : column default
value changed</h4>
<div class="sourceCode" id="cb340"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_default_value_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">default</span> <span class="dv">2</span>);</span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_default_value_changed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">default</span> <span class="dv">1</span>);</span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:48</span> : <span class="kw">in</span> str : <span class="kw">column</span> <span class="kw">current</span> <span class="kw">default</span> <span class="fu">value</span> <span class="kw">not</span> equal <span class="kw">to</span></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">default</span> <span class="fu">value</span> <span class="st">&#39;id2&#39;</span></span></code></pre></div>
<p>You can’t change the default value after the fact. There’s no alter
statement that would allow this even though it does make some logical
sense.</p>
<h4 id="case-14-column-default-value-did-not-change-ok">Case 14 : column
default value did not change (ok)</h4>
<div class="sourceCode" id="cb341"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_default_value_ok(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">default</span> <span class="dv">1</span>);</span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_column_default_value_ok(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">default</span> <span class="dv">1</span>);</span></code></pre></div>
<p>No change. No error here.</p>
<h4
id="case-15-create-table-with-additional-attribute-present-and-matching-ok">Case
15 : create table with additional attribute present and matching
(ok)</h4>
<div class="sourceCode" id="cb342"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_attribute_present(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>, <span class="kw">primary</span> <span class="kw">key</span> (a,b));</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_attribute_present(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>, <span class="kw">primary</span> <span class="kw">key</span> (a,b));</span></code></pre></div>
<p>No change. No error here.</p>
<h4
id="case-16-create-table-with-additional-attribute-doesnt-match">Case 16
: create table with additional attribute (doesn’t match)</h4>
<div class="sourceCode" id="cb343"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_attribute_mismatch(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">primary</span> <span class="kw">key</span> (a));</span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_attribute_mismatch(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>, <span class="kw">primary</span> <span class="kw">key</span> (a,b));</span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:57</span> : <span class="kw">in</span> pk_def : a <span class="kw">table</span> facet <span class="kw">is</span> different <span class="kw">in</span> <span class="kw">the</span> <span class="kw">previous</span></span>
<span id="cb343-6"><a href="#cb343-6" aria-hidden="true" tabindex="-1"></a><span class="kw">and</span> <span class="kw">current</span> <span class="kw">schema</span></span></code></pre></div>
<p>This is an error because the additional attribute does not match the
previous schema.</p>
<h4 id="case-17-column-removed">Case 17 : column removed</h4>
<div class="sourceCode" id="cb344"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_columns_removed(<span class="kw">id</span> <span class="dt">integer</span>);</span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_columns_removed(<span class="kw">id</span> <span class="dt">integer</span>, id2 <span class="dt">integer</span>);</span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:255</span> : <span class="kw">in</span> col_def : items have been removed <span class="kw">from</span> <span class="kw">the</span> <span class="kw">table</span></span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a>rather <span class="kw">than</span> marked <span class="kw">with</span> @delete <span class="st">&#39;t_columns_removed&#39;</span></span></code></pre></div>
<p>You can’t remove columns from tables. You have to mark them with
<code>@delete</code> instead.</p>
<h4
id="case-18-create-table-with-added-facet-not-present-in-the-previous">Case
18 : create table with added facet not present in the previous</h4>
<div class="sourceCode" id="cb345"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_attribute_added(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">primary</span> <span class="kw">key</span> (a));</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_attribute_added(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:63</span> : <span class="kw">in</span> pk_def : <span class="kw">table</span> has a facet that <span class="kw">is</span> different <span class="kw">in</span> <span class="kw">the</span></span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a><span class="kw">previous</span> <span class="kw">and</span> <span class="kw">current</span> <span class="kw">schema</span> <span class="st">&#39;t_attribute_added&#39;</span></span></code></pre></div>
<p>Table facets like primary keys cannot be added after the fact. There
is no way to do this in sqlite.</p>
<h4 id="case-19-create-table-with-additional-column-and-no-create">Case
19 : create table with additional column and no
<code>@create</code></h4>
<div class="sourceCode" id="cb346"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_column(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>);</span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_column(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:66</span> : <span class="kw">in</span> col_def : <span class="kw">table</span> has <span class="kw">columns</span> added <span class="kw">without</span> marking</span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>them @create <span class="st">&#39;t_additional_column&#39;</span></span></code></pre></div>
<p>If you add a new column like <code>b</code> above you have to mark it
with <code>@create</code> in a suitable version.</p>
<h4 id="case-20-create-table-with-additional-column-and-create-ok">Case
20 : create table with additional column and `<code>@create</code>
(ok)</h4>
<div class="sourceCode" id="cb347"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_column_ok(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span> @create(<span class="dv">2</span>), c <span class="dt">int</span> @create(<span class="dv">6</span>));</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_additional_column_ok(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span> @create(<span class="dv">2</span>));</span></code></pre></div>
<p>Column properly created. No errors here.</p>
<h4 id="case-21-create-table-with-different-flags-like-temp">Case 21 :
create table with different flags (like TEMP)</h4>
<div class="sourceCode" id="cb348"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> TEMP <span class="kw">table</span> t_becomes_temp_table(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>);</span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_becomes_temp_table(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>);</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:72</span> : <span class="kw">in</span> create_table_stmt : <span class="kw">table</span> <span class="kw">create</span> statement <span class="kw">attributes</span></span>
<span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>different <span class="kw">than</span> <span class="kw">previous</span> version <span class="st">&#39;t_becomes_temp_table&#39;</span></span></code></pre></div>
<p>Table became a TEMP table, there is no way to generate an alter
statement for that. Not allowed.</p>
<h4 id="case-22-create-table-and-apply-annotation-ok">Case 22 : create
table and apply annotation (ok)</h4>
<div class="sourceCode" id="cb349"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_table_ok(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>) @create(<span class="dv">6</span>);</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- no previous version</span></span></code></pre></div>
<p>No errors here; this is a properly created new table.</p>
<h4 id="case-23-create-new-table-without-annotation-error">Case 23 :
create new table without annotation (error)</h4>
<div class="sourceCode" id="cb350"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_table_no_annotation(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>);</span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- no previous version</span></span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:85</span> : <span class="kw">in</span> create_table_stmt : <span class="kw">new</span> <span class="kw">table</span> must be added <span class="kw">with</span></span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@create(6) or later &#39;t_new_table_no_annotation&#39;</span></span></code></pre></div>
<p>This table was added with no annotation. It has to have an <span
class="citation" data-cites="create">@create</span> and be at least
version 6, the current largest.</p>
<h4 id="case-24-create-new-table-stale-annotation-error">Case 24 :
create new table stale annotation (error)</h4>
<div class="sourceCode" id="cb351"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_table_stale_annotation(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span>) @create(<span class="dv">2</span>);</span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- no previous version</span></span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:91</span> : <span class="kw">in</span> create_table_stmt : <span class="kw">new</span> <span class="kw">table</span> must be added <span class="kw">with</span></span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@create(6) or later &#39;t_new_table_stale_annotation&#39;</span></span></code></pre></div>
<p>The schema is already up to version 6. You can’t then add a table in
the past at version 2.</p>
<h4 id="case-25-add-columns-to-table-marked-create-and-delete">Case 25 :
add columns to table, marked <code>@create</code> and
<code>@delete</code></h4>
<div class="sourceCode" id="cb352"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_table_create_and_delete(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span> @create(<span class="dv">6</span>) @delete(<span class="dv">7</span>));</span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_table_create_and_delete(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:96</span> : <span class="kw">in</span> col_def : <span class="kw">table</span> has newly added <span class="kw">columns</span> that are</span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>marked <span class="kw">both</span> @create <span class="kw">and</span> @delete <span class="st">&#39;t_new_table_create_and_delete&#39;</span></span></code></pre></div>
<p>Adding a column in the new version and marking it both create and
delete is … weird… don’t do that. Technically you can do it (sigh) but
it must be done one step at a time.</p>
<h4 id="case-26-add-columns-to-table-marked-create-correctly">Case 26 :
add columns to table, marked <code>@create</code> correctly</h4>
<div class="sourceCode" id="cb353"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_legit_column(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>, b <span class="dt">int</span> @create(<span class="dv">6</span>));</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t_new_legit_column(a <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>No errors here; new column added in legit version.</p>
<h4
id="case-27-create-table-with-a-create-migration-proc-where-there-was-none">Case
27 : create table with a create migration proc where there was none</h4>
<div class="sourceCode" id="cb354"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_create_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>, ACreateMigrator);</span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_create_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>);</span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:104</span> : <span class="kw">in</span> str : @create <span class="kw">procedure</span> changed <span class="kw">in</span> <span class="dt">object</span></span>
<span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;with_create_migrator&#39;</span></span></code></pre></div>
<p>You can’t add a create migration proc after the fact.</p>
<h4
id="case-28-create-table-with-a-different-create-migration-proc">Case 28
: create table with a different create migration proc</h4>
<div class="sourceCode" id="cb355"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_create_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>, ACreateMigrator);</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_create_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @create(<span class="dv">1</span>, ADifferentCreateMigrator);</span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-5"><a href="#cb355-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:104</span> : <span class="kw">in</span> str : @create <span class="kw">procedure</span> changed <span class="kw">in</span> <span class="dt">object</span></span>
<span id="cb355-6"><a href="#cb355-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;with_create_migrator&#39;</span></span></code></pre></div>
<p>You can’t change a create migration proc after the fact.</p>
<h4
id="case-29-create-table-with-a-delete-migration-proc-where-there-was-none">Case
29 : create table with a delete migration proc where there was none</h4>
<div class="sourceCode" id="cb356"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_delete_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>, ADeleteMigrator);</span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_delete_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>);</span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:107</span> : <span class="kw">in</span> str : @delete <span class="kw">procedure</span> changed <span class="kw">in</span> <span class="dt">object</span></span>
<span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;with_delete_migrator&#39;</span></span></code></pre></div>
<p>You can’t add a delete migration proc after the fact.</p>
<h4
id="case-30-create-table-with-a-different-delete-migration-proc">Case 30
: create table with a different delete migration proc</h4>
<div class="sourceCode" id="cb357"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_delete_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>, ADeleteMigrator);</span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> with_delete_migrator(<span class="kw">id</span> <span class="dt">integer</span>) @delete(<span class="dv">1</span>, ADifferentDeleteMigrator);</span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:107</span> : <span class="kw">in</span> str : @delete <span class="kw">procedure</span> changed <span class="kw">in</span> <span class="dt">object</span></span>
<span id="cb357-6"><a href="#cb357-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;with_delete_migrator&#39;</span></span></code></pre></div>
<p>You can’t change a delete migration proc after the fact.</p>
<h4
id="case-31-create-a-table-which-was-a-view-in-the-previous-schema">Case
31 : create a table which was a view in the previous schema</h4>
<div class="sourceCode" id="cb358"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> view_becomes_a_table(<span class="kw">id</span> <span class="dt">int</span>);</span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_becomes_a_table <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X;</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:110</span> : <span class="kw">in</span> create_table_stmt : <span class="dt">object</span> was a <span class="kw">view</span> but <span class="kw">is</span> now a</span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a><span class="kw">table</span> <span class="st">&#39;view_becomes_a_table&#39;</span></span></code></pre></div>
<p>Converting views to tables is not allowed.</p>
<h4 id="case-32-delete-a-view-without-marking-it-deleted">Case 32 :
delete a view without marking it deleted</h4>
<div class="sourceCode" id="cb359"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="co">--- no matching view in current schema</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_was_zomg_deleted <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X;</span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:333</span> : <span class="kw">in</span> create_view_stmt : <span class="kw">view</span> was <span class="kw">present</span> but now it does</span>
<span id="cb359-6"><a href="#cb359-6" aria-hidden="true" tabindex="-1"></a><span class="kw">not</span> exist (<span class="kw">use</span> @delete <span class="kw">instead</span>) <span class="st">&#39;view_was_zomg_deleted&#39;</span></span></code></pre></div>
<p>Here the view was deleted rather than marking it with
<code>@delete</code>, resulting in an error.</p>
<h4 id="case-33-create-a-new-version-of-this-view-that-is-not-temp">Case
33 : create a new version of this view that is not temp</h4>
<div class="sourceCode" id="cb360"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_was_temp_but_now_it_is_not <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X;</span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> temp <span class="kw">view</span> view_was_temp_but_now_it_is_not <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X;</span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:339</span> : <span class="kw">in</span> create_view_stmt : TEMP property changed <span class="kw">in</span> <span class="kw">new</span></span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a><span class="kw">schema</span> <span class="cf">for</span> <span class="kw">view</span> <span class="st">&#39;view_was_temp_but_now_it_is_not&#39;</span></span></code></pre></div>
<p>A temp view became a view. This flag is not allowed to change. Side
note: temp views are weird.</p>
<h4
id="case-34-create-a-new-version-of-this-view-that-was-created-in-a-different-version">Case
34 : create a new version of this view that was created in a different
version</h4>
<div class="sourceCode" id="cb361"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_with_different_create_version <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X @create(<span class="dv">3</span>);</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb361-3"><a href="#cb361-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_with_different_create_version <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X @create(<span class="dv">2</span>);</span>
<span id="cb361-4"><a href="#cb361-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-5"><a href="#cb361-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:116</span> : <span class="kw">in</span> str : <span class="kw">current</span> <span class="kw">create</span> version <span class="kw">not</span> equal <span class="kw">to</span> <span class="kw">previous</span></span>
<span id="cb361-6"><a href="#cb361-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> version <span class="cf">for</span> <span class="st">&#39;view_with_different_create_version&#39;</span></span></code></pre></div>
<p>You can’t change the create version of a view after the fact.</p>
<h4
id="case-35-create-an-index-that-is-now-totally-gone-in-the-new-schema">Case
35 : create an index that is now totally gone in the new schema</h4>
<div class="sourceCode" id="cb362"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="co">--- no matching index in current schema</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">index</span> this_index_was_deleted_with_no_annotation <span class="kw">on</span> foo(<span class="kw">id</span>);</span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:349</span> : <span class="kw">in</span> create_index_stmt : <span class="kw">index</span> was <span class="kw">present</span> but now it</span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a>does <span class="kw">not</span> exist (<span class="kw">use</span> @delete <span class="kw">instead</span>) <span class="st">&#39;this_index_was_deleted_with_no_annotation&#39;</span></span></code></pre></div>
<p>You have to use <code>@delete</code> on indices to remove them
correctly.</p>
<h4
id="case-36-create-a-view-with-no-annotation-that-is-not-in-the-previous-schema">Case
36 : create a view with no annotation that is not in the previous
schema</h4>
<div class="sourceCode" id="cb363"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">view</span> view_created_with_no_annotation <span class="kw">as</span> <span class="kw">select</span> <span class="dv">1</span> X;</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="co">--- there is no previous version</span></span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:122</span> : <span class="kw">in</span> create_view_stmt : <span class="kw">new</span> <span class="kw">view</span> must be added <span class="kw">with</span></span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@create(6) or later &#39;view_created_with_no_annotation&#39;</span></span></code></pre></div>
<p>You have to use <code>@create</code> on views to create them
correctly.</p>
<h4 id="case-37-index-created-in-different-version">Case 37 : index
created in different version</h4>
<div class="sourceCode" id="cb364"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">index</span> this_index_has_a_changed_attribute <span class="kw">on</span> foo(<span class="kw">id</span>) @create(<span class="dv">2</span>);</span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">index</span> this_index_has_a_changed_attribute <span class="kw">on</span> foo(<span class="kw">id</span>) @create(<span class="dv">1</span>);</span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:125</span> : <span class="kw">in</span> str : <span class="kw">current</span> <span class="kw">create</span> version <span class="kw">not</span> equal <span class="kw">to</span> <span class="kw">previous</span></span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> version <span class="cf">for</span> <span class="st">&#39;this_index_has_a_changed_attribute&#39;</span></span></code></pre></div>
<p>You can’t change the <code>@create</code> version of an index.</p>
<h4 id="case-38-create-a-new-index-but-with-no-create-annotation">Case
38 : create a new index but with no <code>@create</code> annotation</h4>
<div class="sourceCode" id="cb365"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">index</span> this_index_was_created_with_no_annotation <span class="kw">on</span> foo(<span class="kw">id</span>);</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a><span class="co">--- there is no previous version</span></span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:130</span> : <span class="kw">in</span> create_index_stmt : <span class="kw">new</span> <span class="kw">index</span> must be added <span class="kw">with</span></span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a><span class="ot">@create(6) or later &#39;this_index_was_created_with_no_annotation&#39;</span></span></code></pre></div>
<p>You have to use <code>@create</code> on indices to make new ones.</p>
<h4
id="case-39-create-a-table-with-a-column-def-that-has-a-different-create-migrator-proc">Case
39 : create a table with a column def that has a different create
migrator proc</h4>
<div class="sourceCode" id="cb366"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> create_column_migrate_test(</span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a> id2 <span class="dt">int</span> @create(<span class="dv">2</span>, ChangedColumnCreateMigrator)</span>
<span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb366-5"><a href="#cb366-5" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb366-6"><a href="#cb366-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> create_column_migrate_test(</span>
<span id="cb366-7"><a href="#cb366-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb366-8"><a href="#cb366-8" aria-hidden="true" tabindex="-1"></a> id2 <span class="dt">int</span> @create(<span class="dv">2</span>, PreviousColumnCreateMigrator)</span>
<span id="cb366-9"><a href="#cb366-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb366-10"><a href="#cb366-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-11"><a href="#cb366-11" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:136</span> : <span class="kw">in</span> str : <span class="kw">column</span> @create <span class="kw">procedure</span> changed <span class="st">&#39;id2&#39;</span></span></code></pre></div>
<p>You can’t change the <code>@create</code> migration stored proc on
columns.</p>
<h4
id="case-40-create-a-table-with-a-column-def-that-has-a-different-delete-migrator-proc">Case
40 : create a table with a column def that has a different delete
migrator proc</h4>
<div class="sourceCode" id="cb367"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> delete_column_migrate_test(</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a> id2 <span class="dt">int</span> @delete(<span class="dv">2</span>, ChangedColumnDeleteMigrator)</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a><span class="co">-------</span></span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> delete_column_migrate_test(</span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a> id2 <span class="dt">int</span> @delete(<span class="dv">2</span>, PreviousColumnDeleteMigrator)</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb367-10"><a href="#cb367-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-11"><a href="#cb367-11" aria-hidden="true" tabindex="-1"></a>Error <span class="kw">at</span> sem_test_prev.sql<span class="ch">:142</span> : <span class="kw">in</span> str : <span class="kw">column</span> @delete <span class="kw">procedure</span> changed <span class="st">&#39;id2&#39;</span></span></code></pre></div>
<p>You can’t change the <code>@delete</code> migration stored proc on
columns.</p>
<blockquote>
<p>NOTE: in addition to these errors, there are many more that do not
require the previous schema which are also checked (not shown here).
These comprise things like making sure the delete version is greater
than the create version on any item. There is a lot of sensibility
checking that can happen without reference to the previous schema.</p>
</blockquote>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-12-testability-features">Chapter 12: Testability
Features</h2>
<p>CQL includes a number of features to make it easier to create what
you might call “Test” procedures. These primarily are concerned with
loading up the database with dummy data, and/or validating the result of
normal procedures that query the database. There are several interesting
language features in these dimensions.</p>
<h3 id="dummy-data">Dummy Data</h3>
<p>Test code can be needlessly brittle, especially when creating dummy
data; any column changes typically cause all sorts of data insertion
code to need to be repaired. In many cases the actual data values are
completely uninteresting to the test – any values would do. There are
several strategies you can use to get good dummy data into your database
in a more maintainable way.</p>
<h4 id="simple-inserts-with-dummy-data">Simple Inserts With Dummy
Data</h4>
<p>The simplest form uses a variant of the insert statement that fills
in any missing columns with a seed value. An example might be something
like the below:</p>
<div class="sourceCode" id="cb368"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc dummy_user()</span>
<span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> users () <span class="kw">values</span> () @dummy_seed(<span class="dv">123</span>)</span>
<span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a>     @dummy_nullables @dummy_defaults;</span>
<span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This statement causes all values including columns that are nullable
or have a default value to get the value <code>123</code> for any
numeric type and <code>'column_name_123'</code> for any text.</p>
<p>If you omit the <code>@dummy_nullables</code> then any nullable
fields will be null as usual. And likewise if you omit
<code>@dummy_defaults</code> then any fields with a default value will
use that value as usual. You might want any combination of these for
your tests (null values are handy in your tests and default behavior is
also handy.)</p>
<p>The <code>@dummy_seed</code> expression provided can be anything that
resolves to a non-null integer value, so it can be pretty flexible. You
might use a <code>while</code> loop to insert a bunch of rows with the
seed value being computed from the <code>while</code> loop variable.</p>
<p>The form above is sort of like <code>insert * into table</code> in
that it is giving dummy values for all columns but you can also specify
some of the columns while using the seed value for others. Importantly,
you can specify values you particularly want to control either for
purposes of creating a more tailored test or because you need them to
match existing or created rows in a table referenced by a foreign
key.</p>
<p>As an example:</p>
<div class="sourceCode" id="cb369"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> users (<span class="kw">id</span>) <span class="kw">values</span> (<span class="dv">1234</span>) @dummy_seed(<span class="dv">123</span>)</span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>   @dummy_nullables @dummy_defaults;</span></code></pre></div>
<p>will provide dummy values for everything but the <code>id</code>
column.</p>
<h4 id="using-with-recursive">Using <code>WITH RECURSIVE</code></h4>
<p>Sometimes what you want to do is create a dummy result set without
necessarily populating the database at all. If you have code that
consumes a result set of a particular shape, it’s easy enough to create
a fake result set with a pattern something like this:</p>
<div class="sourceCode" id="cb370"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">procedure</span> dummy_stuff(lim <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span> RECURSIVE</span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>  dummy(x) <span class="kw">AS</span> (</span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>     <span class="kw">SELECT</span> <span class="dv">1</span></span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a>     <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>     <span class="kw">SELECT</span> x<span class="op">+</span><span class="dv">1</span> <span class="kw">FROM</span> dummy <span class="kw">WHERE</span> x <span class="op">&lt;</span> lim)</span>
<span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a>    x <span class="kw">id</span>,</span>
<span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a>    printf(<span class="ot">&quot;name_%d&quot;</span>, x) name,</span>
<span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cast</span>(x % <span class="dv">2</span> <span class="kw">as</span> bool) is_cool,</span>
<span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">*</span> <span class="fl">1.3</span> <span class="kw">as</span> rate,</span>
<span id="cb370-13"><a href="#cb370-13" aria-hidden="true" tabindex="-1"></a>    x etc1,</span>
<span id="cb370-14"><a href="#cb370-14" aria-hidden="true" tabindex="-1"></a>    x etc2</span>
<span id="cb370-15"><a href="#cb370-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> dummy;</span>
<span id="cb370-16"><a href="#cb370-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The first part of the above creates a series of numbers from 1 to
<code>lim</code>. The second uses those values to create dummy columns.
Any result shape can be generated in this fashion.</p>
<p>You get data like this from the above:</p>
<pre class="text"><code>1|name_1|1|1.3|1|1
2|name_2|0|2.6|2|2
3|name_3|1|3.9|3|3
4|name_4|0|5.2|4|4
5|name_5|1|6.5|5|5
6|name_6|0|7.8|6|6
7|name_7|1|9.1|7|7
8|name_8|0|10.4|8|8
9|name_9|1|11.7|9|9
10|name_10|0|13.0|10|10</code></pre>
<p>The result of the select statement is itself quite flexible and if
more dummy data is what you wanted, this form can be combined with
<code>INSERT ... FROM SELECT...</code> to create dummy data in real
tables. And of course once you have a core query you could use it in a
variety of ways, combined with cursors or any other strategy to
<code>select</code> out pieces and <code>insert</code> them into various
tables.</p>
<h4 id="using-temporary-tables">Using Temporary Tables</h4>
<p>If you need an API to create very flexible dummy data with values of
your choice you can use temporary tables and a series of helper
procedures.</p>
<p>First, create a table to hold the results. You can of course make
this table however you need to but the <code>like</code> construct in
the table creation is especially helpful; it creates columns in the
table that match the name and type of the named object. For instance
<code>like my_proc</code> is shorthand for the column names ands of the
shape that <code>my_proc</code> returns. This is perfect for emulating
the results of <code>my_proc</code>.</p>
<div class="sourceCode" id="cb372"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc begin_dummy()</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">drop</span> <span class="kw">table</span> <span class="cf">if</span> <span class="kw">exists</span> my_dummy_data;</span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-5"><a href="#cb372-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- the shape of my_dummy_data matches the columns</span></span>
<span id="cb372-6"><a href="#cb372-6" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- returned by proc_I_want_to_emulate</span></span>
<span id="cb372-7"><a href="#cb372-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">create</span> temp <span class="kw">table</span> my_dummy_data(</span>
<span id="cb372-8"><a href="#cb372-8" aria-hidden="true" tabindex="-1"></a>     <span class="kw">like</span> proc_I_want_to_emulate;</span>
<span id="cb372-9"><a href="#cb372-9" aria-hidden="true" tabindex="-1"></a>   );</span>
<span id="cb372-10"><a href="#cb372-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Next, you will need a procedure that accepts and writes a single row
to your temp table. You can of course write this all explicitly but the
testing support features provide more support to make things easier; In
this example, arguments of the procedure will exactly match the output
of the procedure we emulating, one argument for each column the proc
returns. The <code>insert</code> statement gets its values from the
arguments.</p>
<div class="sourceCode" id="cb373"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc add_dummy(<span class="kw">like</span> proc_I_want_to_emulate)</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">insert</span> <span class="kw">into</span> my_dummy_data <span class="kw">from</span> arguments;</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This allows you to create the necessary helper methods automatically
even if the procedure changes over time.</p>
<p>Next we need a procedure to get our result set.</p>
<div class="sourceCode" id="cb374"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_dummy()</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_dummy_data;</span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>And finally, some cleanup.</p>
<div class="sourceCode" id="cb375"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc cleanup_dummy()</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">drop</span> <span class="kw">table</span> <span class="cf">if</span> <span class="kw">exists</span> my_dummy_data;</span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Again the temp table could be combined with
<code>INSERT INTO ...FROM SELECT...</code> to create dummy data in real
tables.</p>
<h4 id="other-considerations-1">Other Considerations</h4>
<p>Wrapping your <code>insert</code> statements in
<code>try/catch</code> can be very useful if there may be dummy data
conflicts. In test code searching for a new suitable seed is pretty
easy. Alternatively</p>
<div class="sourceCode" id="cb376"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> seed <span class="op">:=</span> <span class="dv">1</span> <span class="op">+</span> (<span class="kw">select</span> <span class="fu">max</span>(<span class="kw">id</span>) <span class="kw">from</span> foo);</span></code></pre></div>
<p>could be very useful. Many alternatives are also possible.</p>
<p>The dummy data features are not suitable for use in production code,
only tests. But the LIKE features are generally useful for creating
contract-like behavior in procs and there are reasonable uses for them
in production code.</p>
<h4 id="complex-result-set-example">Complex Result Set Example</h4>
<p>Here’s a more complicated example that can be easily rewritten using
the sugar features. This method is designed to return a single-row
result set that can be used to mock a method. I’ve replaced the real
fields with ‘f1, ’f2’ etc.</p>
<div class="sourceCode" id="cb377"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_my_subject(</span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>  f1_ <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>  f2_ TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>  f3_ <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>  f4_ <span class="dt">LONG</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>  f5_ TEXT,</span>
<span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a>  f6_ TEXT,</span>
<span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a>  f7_ TEXT,</span>
<span id="cb377-9"><a href="#cb377-9" aria-hidden="true" tabindex="-1"></a>  f8_ BOOL <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb377-10"><a href="#cb377-10" aria-hidden="true" tabindex="-1"></a>  f9_ TEXT,</span>
<span id="cb377-11"><a href="#cb377-11" aria-hidden="true" tabindex="-1"></a>  f10_ TEXT</span>
<span id="cb377-12"><a href="#cb377-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb377-13"><a href="#cb377-13" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb377-14"><a href="#cb377-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> data_cursor <span class="kw">CURSOR</span> <span class="kw">LIKE</span> my_subject;</span>
<span id="cb377-15"><a href="#cb377-15" aria-hidden="true" tabindex="-1"></a>  FETCH data_cursor()</span>
<span id="cb377-16"><a href="#cb377-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> <span class="kw">VALUES</span> (f1_, f2_, f3_, f4_, f5_, f6_, f7_, f8_, f9_, f10);</span>
<span id="cb377-17"><a href="#cb377-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> data_cursor;</span>
<span id="cb377-18"><a href="#cb377-18" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>This can be written much more maintainably as:</p>
<div class="sourceCode" id="cb378"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> test_my_subject(<span class="kw">like</span> my_subject)</span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="kw">LIKE</span> my_subject;</span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a>  FETCH C <span class="kw">FROM</span> ARGUMENTS;</span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> C;</span>
<span id="cb378-6"><a href="#cb378-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Naturally, real columns have much longer names and there are often
many more than 10.</p>
<h3 id="autotest-attributes">Autotest Attributes</h3>
<p>Some of the patterns described above are so common that CQL offers a
mechanism to automatically generate those test procedures.</p>
<h4 id="temporary-table-pattern">Temporary Table Pattern</h4>
<p>The attributes dummy_table, dummy_insert, and dummy_select can be
used together to create and populate temp tables.</p>
<p>Example:</p>
<p>To create a dummy row set for <code>sample_proc</code>, add the
<code>[[autotest]]</code> attribute with dummy_table, dummy_insert, and
dummy_select values.</p>
<div class="sourceCode" id="cb379"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> foo(</span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>  name text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-6"><a href="#cb379-6" aria-hidden="true" tabindex="-1"></a>[[autotest<span class="op">=</span>(dummy_table, dummy_insert, dummy_select)]]</span>
<span id="cb379-7"><a href="#cb379-7" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc sample_proc(foo <span class="dt">int</span>)</span>
<span id="cb379-8"><a href="#cb379-8" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb379-9"><a href="#cb379-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> Foo;</span>
<span id="cb379-10"><a href="#cb379-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p><code>dummy_table</code> generates procedures for creating and
dropping a temp table with the same shape as
<code>sample_proc</code>.</p>
<div class="sourceCode" id="cb380"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC open_sample_proc()</span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> test_sample_proc(<span class="kw">LIKE</span> sample_proc);</span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC close_sample_proc()</span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> test_sample_proc;</span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>The <code>dummy_insert</code> attribute generates a procedure for
inserting into the temp table.</p>
<div class="sourceCode" id="cb381"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC insert_sample_proc(<span class="kw">LIKE</span> sample_proc)</span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> test_sample_proc <span class="kw">FROM</span> ARGUMENTS;</span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>The <code>dummy_select</code> attribute generates procedures for
selecting from the temp table.</p>
<div class="sourceCode" id="cb382"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC select_sample_proc()</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test_sample_proc;</span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>It’s interesting to note that the generated test code does not ever
need to mention the exact columns it is emulating because it can always
use <code>like</code>, <code>*</code>, and <code>from arguments</code>
in a generic way.</p>
<p>When compiled, the above will create C methods that can create, drop,
insert, and select from the temp table. They will have the following
signatures:</p>
<pre><code>CQL_WARN_UNUSED cql_code open_sample_proc(
  sqlite3 *_Nonnull _db_);

CQL_WARN_UNUSED cql_code close_sample_proc(
  sqlite3 *_Nonnull _db_);

CQL_WARN_UNUSED cql_code insert_sample_proc(
  sqlite3 *_Nonnull _db_,
  cql_int32 id_,
  cql_string_ref _Nonnull name_);

CQL_WARN_UNUSED cql_code select_sample_proc_fetch_results(
  sqlite3 *_Nonnull _db_,
  select_sample_proc_result_set_ref _Nullable *_Nonnull result_set);</code></pre>
<h4 id="single-row-resultset">Single Row ResultSet</h4>
<p>In some cases, using four APIs to generate fake data can be verbose.
In the case that only a single row of data needs to be faked, the
dummy_result_set attribute can be more convenient.</p>
<p>Example:</p>
<div class="sourceCode" id="cb384"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a>[[autotest<span class="op">=</span>(dummy_result_set]])</span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc sample_proc()</span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> Foo;</span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Will generate the following procedure</p>
<div class="sourceCode" id="cb385"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC generate_sample_proc_row(<span class="kw">LIKE</span> sample_proc)</span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> curs <span class="kw">CURSOR</span> <span class="kw">LIKE</span> sample_proc;</span>
<span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>  FETCH curs <span class="kw">FROM</span> ARGUMENTS;</span>
<span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> curs;</span>
<span id="cb385-6"><a href="#cb385-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Which generates this C API:</p>
<div class="sourceCode" id="cb386"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generate_sample_proc_row_fetch_results<span class="op">(</span></span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a>    generate_sample_proc_row_rowset_ref _Nullable <span class="op">*</span>_Nonnull result_set<span class="op">,</span></span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a>    string_ref _Nonnull foo_<span class="op">,</span></span>
<span id="cb386-4"><a href="#cb386-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> bar_<span class="op">);</span></span></code></pre></div>
<p>These few test helpers are useful in a variety of scenarios and can
save you a lot of typing and maintenance. They evolve automatically as
the code changes, always matching the signature of the attributed
procedure.</p>
<h4 id="generalized-dummy-test-pattern">Generalized Dummy Test
Pattern</h4>
<p>The most flexible test helper is the <code>dummy_test</code> form.
This is far more advanced than the simple helpers above. While the
choices above were designed to help you create fake result sets pretty
easily, <code>dummy_test</code> goes much further letting you set up
arbitrary schema and data so that you can run your procedure on actual
data. The <code>dummy_test</code> code generator uses the features above
to do its job and like the other autotest options, it works by
automatically generating CQL code from your procedure definition.
However, you get a lot more code in this mode. It’s easiest to study an
example so let’s begin there.</p>
<p>To understand <code>dummy_test</code> we’ll need a more complete
example, so we start with this simple two-table schema with a trigger
and some indices. To this we add a very small procedure that we might
want to test.</p>
<pre><code>create table foo(
 id integer not null primary key,
 name text
);

create table bar(
 id integer not null primary key references foo(id),
 data text
);

create index foo_index on foo(name);

create index bar_index on bar(data);

create temp trigger if not exists trigger1
  before delete on foo
begin
  delete from foo where name = &#39;this is so bogus&#39;;
end;

[[autotest=(
  dummy_table,
  dummy_insert,
  dummy_select,
  dummy_result_set,
  (dummy_test, (bar, (data), (&#39;plugh&#39;))))
]]
create proc the_subject()
begin
  select * from bar;
end;</code></pre>
<p>As you can see, we have two tables, <code>foo</code> and
<code>bar</code>; the <code>foo</code> table has a trigger; both
<code>foo</code> and <code>bar</code> have indices. This schema is very
simple, but of course it could be a lot more complicated, and real cases
typically are.</p>
<p>The procedure we want to test is creatively called
<code>the_subject</code>. It has lots of test attributes on it. We’ve
already discussed <code>dummy_table</code>, <code>dummy_insert</code>,
<code>dummy_select</code>, and <code>dummy_result_set</code> above but
as you can see they can be mixed in with <code>dummy_test</code>. Now
let’s talk about <code>dummy_test</code>. First you’ll notice that
annotation has additional sub-attributes; the attribute grammar is
sufficiently flexible such that, in principle, you could represent an
arbitrary LISP program, so the instructions can be very detailed. In
this case, the attribute provides table and column names, as well as
sample data. We’ll discuss that when we get to the population code.</p>
<p>First let’s dispense with the attributes we already discussed – since
we had all the attributes, the output will include those helpers, too.
Here they are again:</p>
<div class="sourceCode" id="cb388"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- note that the code does not actually call the test subject</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- this declaration is used so that CQL will know the shape of the result</span></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> PROC the_subject () (<span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="kw">data</span> TEXT);</span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC open_the_subject()</span>
<span id="cb388-6"><a href="#cb388-6" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb388-7"><a href="#cb388-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> test_the_subject(<span class="kw">LIKE</span> the_subject);</span>
<span id="cb388-8"><a href="#cb388-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb388-9"><a href="#cb388-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-10"><a href="#cb388-10" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC close_the_subject()</span>
<span id="cb388-11"><a href="#cb388-11" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb388-12"><a href="#cb388-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> test_the_subject;</span>
<span id="cb388-13"><a href="#cb388-13" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb388-14"><a href="#cb388-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-15"><a href="#cb388-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC insert_the_subject(<span class="kw">LIKE</span> the_subject)</span>
<span id="cb388-16"><a href="#cb388-16" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb388-17"><a href="#cb388-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> test_the_subject <span class="kw">FROM</span> ARGUMENTS;</span>
<span id="cb388-18"><a href="#cb388-18" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb388-19"><a href="#cb388-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-20"><a href="#cb388-20" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC select_the_subject()</span>
<span id="cb388-21"><a href="#cb388-21" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb388-22"><a href="#cb388-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test_the_subject;</span>
<span id="cb388-23"><a href="#cb388-23" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb388-24"><a href="#cb388-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-25"><a href="#cb388-25" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC generate_the_subject_row(<span class="kw">LIKE</span> the_subject)</span>
<span id="cb388-26"><a href="#cb388-26" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb388-27"><a href="#cb388-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> curs <span class="kw">CURSOR</span> <span class="kw">LIKE</span> the_subject;</span>
<span id="cb388-28"><a href="#cb388-28" aria-hidden="true" tabindex="-1"></a>  FETCH curs <span class="kw">FROM</span> ARGUMENTS;</span>
<span id="cb388-29"><a href="#cb388-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OUT</span> curs;</span>
<span id="cb388-30"><a href="#cb388-30" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>That covers what we had before, so, what’s new? Actually, quite a
bit. We’ll begin with the easiest:</p>
<div class="sourceCode" id="cb389"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_create_tables()</span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> foo(</span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb389-5"><a href="#cb389-5" aria-hidden="true" tabindex="-1"></a>    name TEXT</span>
<span id="cb389-6"><a href="#cb389-6" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb389-7"><a href="#cb389-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> bar(</span>
<span id="cb389-8"><a href="#cb389-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">REFERENCES</span> foo (<span class="kw">id</span>),</span>
<span id="cb389-9"><a href="#cb389-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> TEXT</span>
<span id="cb389-10"><a href="#cb389-10" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb389-11"><a href="#cb389-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Probably the most important of all the helpers,
<code>test_the_subject_create_tables</code> will create all the tables
you need to run the procedure. Note that in this case, even though the
subject code only references <code>bar</code>, CQL determined that
<code>foo</code> is also needed because of the foreign key.</p>
<p>The symmetric drop procedure is also generated:</p>
<div class="sourceCode" id="cb390"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_drop_tables()</span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> bar;</span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> foo;</span>
<span id="cb390-5"><a href="#cb390-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Additionally, in this case there were triggers and indices. This
caused the creation of helpers for those aspects.</p>
<div class="sourceCode" id="cb391"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_create_indexes()</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">INDEX</span> bar_index <span class="kw">ON</span> bar (<span class="kw">data</span>);</span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> <span class="kw">INDEX</span> foo_index <span class="kw">ON</span> foo (name);</span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_create_triggers()</span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CREATE</span> TEMP <span class="kw">TRIGGER</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> trigger1</span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">BEFORE</span> <span class="kw">DELETE</span> <span class="kw">ON</span> foo</span>
<span id="cb391-11"><a href="#cb391-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb391-12"><a href="#cb391-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DELETE</span> <span class="kw">FROM</span> foo <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;this is so bogus&#39;</span>;</span>
<span id="cb391-13"><a href="#cb391-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb391-14"><a href="#cb391-14" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb391-15"><a href="#cb391-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-16"><a href="#cb391-16" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_drop_indexes()</span>
<span id="cb391-17"><a href="#cb391-17" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb391-18"><a href="#cb391-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">INDEX</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> bar_index;</span>
<span id="cb391-19"><a href="#cb391-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">INDEX</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> foo_index;</span>
<span id="cb391-20"><a href="#cb391-20" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb391-21"><a href="#cb391-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-22"><a href="#cb391-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_drop_triggers()</span>
<span id="cb391-23"><a href="#cb391-23" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb391-24"><a href="#cb391-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DROP</span> <span class="kw">TRIGGER</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> trigger1;</span>
<span id="cb391-25"><a href="#cb391-25" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>If there are no triggers or indices, the corresponding create/drop
methods will not be generated.</p>
<p>With these helpers available, when writing test code you can then
choose if you want to create just the tables, or the tables and indices,
or tables and indices and triggers by invoking the appropriate
combination of helper methods. Since all the implicated triggers and
indices are automatically included, even if they change over time,
maintenance is greatly simplified.</p>
<p>Note that in this case the code simply reads from one of the tables,
but in general the procedure under test might make modifications as
well. Test code frequently has to read back the contents of the tables
to verify that they were modified correctly. So these additional helper
methods are also included:</p>
<div class="sourceCode" id="cb392"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_read_foo()</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> foo;</span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_read_bar()</span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> bar;</span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>These procedures will allow you to easily create result sets with
data from the relevant tables which can then be verified for
correctness. Of course if more tables were implicated, those would have
been included as well.</p>
<p>As you can see, the naming always follows the convention
<code>test_[YOUR_PROCEDURE]_[helper_type]</code></p>
<p>Finally, the most complicated helper is the one that used that large
annotation. Recall that we provided the fragment
<code>(dummy_test, (bar, (data), ('plugh'))))</code> to the compiler.
This fragment helped to produce this last helper function:</p>
<div class="sourceCode" id="cb393"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC test_the_subject_populate_tables()</span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">OR</span> IGNORE <span class="kw">INTO</span> foo(<span class="kw">id</span>) <span class="kw">VALUES</span>(<span class="dv">1</span>) @dummy_seed(<span class="dv">123</span>);</span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">OR</span> IGNORE <span class="kw">INTO</span> foo(<span class="kw">id</span>) <span class="kw">VALUES</span>(<span class="dv">2</span>) @dummy_seed(<span class="dv">124</span>)</span>
<span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a>      @dummy_nullables @dummy_defaults;</span>
<span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">OR</span> IGNORE <span class="kw">INTO</span> bar(<span class="kw">data</span>, <span class="kw">id</span>) <span class="kw">VALUES</span>(<span class="st">&#39;plugh&#39;</span>, <span class="dv">1</span>) @dummy_seed(<span class="dv">125</span>);</span>
<span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-10"><a href="#cb393-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">OR</span> IGNORE <span class="kw">INTO</span> bar(<span class="kw">id</span>) <span class="kw">VALUES</span>(<span class="dv">2</span>) @dummy_seed(<span class="dv">126</span>)</span>
<span id="cb393-11"><a href="#cb393-11" aria-hidden="true" tabindex="-1"></a>     @dummy_nullables @dummy_defaults;</span>
<span id="cb393-12"><a href="#cb393-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>In general the <code>populate_tables</code> helper will fill all
implicated tables with at least two rows of data. It uses the dummy data
features discussed earlier to generate the items using a seed. Recall
that if <code>@dummy_seed</code> is present in an <code>insert</code>
statement then any missing columns are generated using that value,
either as a string, or as an integer (or true/false for a boolean). Note
that the second of the two rows that is generated also specifies
<code>@dummy_nullables</code> and <code>@dummy_defaults</code>. This
means that even nullable columns, and columns with a default value will
get the non-null seed instead. So you get a mix of null/default/explicit
values loaded into your tables.</p>
<p>Of course blindly inserting data doesn’t quite work. As you can see,
the insert code used the foreign key references in the schema to figure
out the necessary insert order and the primary key values for
<code>foo</code> were automatically specified so that they could then be
used again in <code>bar</code>.</p>
<p>Lastly, the autotest attribute included explicit test values for the
table <code>bar</code>, and in particular the <code>data</code> column
has the value <code>'plugh'</code>. So the first row of data for table
<code>bar</code> did not use dummy data for the <code>data</code> column
but rather used <code>'plugh'</code>.</p>
<p>In general, the <code>dummy_test</code> annotation can include any
number of tables, and for each table you can specify any of the columns
and you can have any number of tuples of values for those columns.</p>
<blockquote>
<p>NOTE: if you include primary key and/or foreign key columns among the
explicit values, it’s up to you to ensure that they are valid
combinations. SQLite will complain as usual if they are not, but the CQL
compiler will simply emit the data you asked for.</p>
</blockquote>
<p>Generalizing the example a little bit, we could use the
following:</p>
<pre><code>(dummy_test, (foo, (name), (&#39;fred&#39;), (&#39;barney&#39;), (&#39;wilma&#39;), (&#39;betty&#39;)),
                        (bar, (id, data), (1, &#39;dino&#39;), (2, &#39;hopparoo&#39;))))</code></pre>
<p>to generate this population:</p>
<pre><code>CREATE PROC test_the_subject_populate_tables()
BEGIN
  INSERT OR IGNORE INTO foo(name, id) VALUES(&#39;fred&#39;, 1) @dummy_seed(123);

  INSERT OR IGNORE INTO foo(name, id) VALUES(&#39;barney&#39;, 2) @dummy_seed(124)
    @dummy_nullables @dummy_defaults;

  INSERT OR IGNORE INTO foo(name, id) VALUES(&#39;wilma&#39;, 3) @dummy_seed(125);

  INSERT OR IGNORE INTO foo(name, id) VALUES(&#39;betty&#39;, 4) @dummy_seed(126)
    @dummy_nullables @dummy_defaults;

  INSERT OR IGNORE INTO bar(id, data) VALUES(1, &#39;dino&#39;) @dummy_seed(127);

  INSERT OR IGNORE INTO bar(id, data) VALUES(2, &#39;hopparoo&#39;) @dummy_seed(128)
    @dummy_nullables @dummy_defaults;
END;</code></pre>
<p>And of course if the annotation is not flexible enough, you can write
your own data population.</p>
<p>The CQL above results in the usual C signatures. For instance:</p>
<div class="sourceCode" id="cb396"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>CQL_WARN_UNUSED cql_code test_the_subject_populate_tables<span class="op">(</span>sqlite3 <span class="op">*</span>_Nonnull _db_<span class="op">);</span></span></code></pre></div>
<p>So, it’s fairly easy to call from C/C++ test code or from CQL test
code.</p>
<h4 id="cross-procedure-limitations">Cross Procedure Limitations</h4>
<p>Generally it’s not possible to compute table usages that come from
called procedures. This is because to do so you need to see the body of
the called procedure and typically that body is in a different
translation – and is therefore not available. A common workaround for
this particular problem is to create a dummy procedure that explicitly
uses all of the desired tables. This is significantly easier than
creating all the schema manually and still gets you triggers and indices
automatically. Something like this:</p>
<div class="sourceCode" id="cb397"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a>[[autotest<span class="op">=</span>(dummy_test]])</span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc use_my_stuff()</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>  let x <span class="op">:=</span> <span class="kw">select</span> <span class="dv">1</span> <span class="kw">from</span> t1, t2, t3, t4, t5, t6, etc<span class="op">..</span>;</span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above can be be done as a macro if desired. But in any case
<code>use_my_stuff</code> simply and directly lists the desired tables.
Using this approach you can have one set of test helpers for an entire
unit rather than one per procedure. This is often desirable and the
maintenance is not too bad. You just use the <code>use_my_stuff</code>
test helpers everywhere.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-13-json-output">Chapter 13: JSON Output</h2>
<p>To help facilitate additional tools that might want to depend on CQL
input files further down the toolchain, CQL includes a JSON output
format for SQL DDL as well as stored procedure information, including
special information for a single-statement DML. “Single-statement DML”
refers to those stored procedures that consist of a single
<code>insert</code>, <code>select</code>, <code>update</code>, or
<code>delete</code>. Even though such procedures comprise just one
statement, good argument binding can create very powerful DML fragments
that are re-usable. Many CQL stored procedures are of this form (in
practice maybe 95% are just one statement.)</p>
<p>To use CQL in this fashion, the sequence will be something like the
below. See <a href="#appendix-1-command-line-options">Appendix 1</a> for
command line details.</p>
<div class="sourceCode" id="cb398"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cql</span> <span class="at">--in</span> input.sql <span class="at">--rt</span> json_schema <span class="at">--cg</span> out.json</span></code></pre></div>
<p>The output contains many different sections for the various types of
entities that CQL can process. There is a full description of the
possible outputs available in <a
href="https://ricomariani.github.io/CG-SQL-author/diagrams/json_output_railroad_diagram.html">diagram
form</a></p>
<p>In the balance of this chapter we’ll deal with the contents of the
sections and their meaning rather than the specifics of the format,
which are better described with the grammar above.</p>
<h3 id="tables">Tables</h3>
<p>The “tables” section has zero or more tables, each table is comprised
of these fields:</p>
<ul>
<li><strong>name</strong> : the table name</li>
<li><strong>crc</strong> : the schema CRC for the entire table
definition, including columns and constraints</li>
<li><strong>isTemp</strong> : true if this is a temporary table</li>
<li><strong>ifNotExists</strong> : true if the table was created with
“if not exists”</li>
<li><strong>withoutRowid</strong> : true if the table was created using
“without rowid”</li>
<li><strong>isAdded</strong> : true if the table has an <span
class="citation" data-cites="create">@create</span> directive
<ul>
<li><strong>addedVersion</strong> : optional, the schema version number
in the <span class="citation" data-cites="create">@create</span>
directive</li>
</ul></li>
<li><strong>isDeleted</strong> : true if the table was marked with <span
class="citation" data-cites="delete">@delete</span> or is currently
<em>unsubscribed</em>
<ul>
<li><strong>deletedVersion</strong> : optional, the schema version
number in the <span class="citation" data-cites="delete">@delete</span>
directive</li>
</ul></li>
<li><strong>isRecreated</strong> : true if the table is marked with
<span class="citation" data-cites="recreate">@recreate</span>
<ul>
<li><strong>recreateGroupName</strong> : optional, if the <span
class="citation" data-cites="recreate">@recreate</span> attribute
specifies a group name, it is present here</li>
</ul></li>
<li><strong>unsubscribedVersion</strong> : optional, if the table was
last unsubscribed, the version number when this happened</li>
<li><strong>resubscribedVersion</strong> : optional, if the table was
last resubscribed, the version number when this happened</li>
<li><strong><em>region information</em></strong> : optional, see the
section on Region Info</li>
<li><strong>indices</strong> : optional, a list of the names of the
indices on this table, see the <a href="#indices">indices
section</a></li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong><em>columns</em></strong> : an array of column definitions,
see the section on columns</li>
<li><strong>primaryKey</strong> : a list of column names, possibly empty
if no primary key</li>
<li><strong>primaryKeySortOrders</strong> : a list of corresponding sort
orders, possibly empty, for each column of the primary key if
specified</li>
<li><strong>primaryKeyName</strong> : optional, the name of the primary
key, if it has one</li>
<li><strong><em>foreignKeys</em></strong> : a list of foreign keys for
this table, possibly empty, see the <a href="#foreign-keys">foreign keys
section</a></li>
<li><strong><em>uniqueKeys</em></strong> : a list of unique keys for
this table, possibly empty, see the <a href="#unique-keys">unique keys
section</a></li>
<li><strong><em>checkExpressions</em></strong> : a list of check
expressions for this table, possibly empty, see the <a
href="#check-expressions">check expression section</a></li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb399"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(an_attribute=(1,(&#39;foo&#39;, &#39;bar&#39;)))</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> foo(</span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span>,</span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a>  name TEXT</span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>generates:</p>
<div class="sourceCode" id="cb400"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CRC&quot;</span> <span class="fu">:</span> <span class="st">&quot;-1869326768060696459&quot;</span><span class="fu">,</span></span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isTemp&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ifNotExists&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-6"><a href="#cb400-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;withoutRowid&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-7"><a href="#cb400-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isAdded&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-8"><a href="#cb400-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isDeleted&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-9"><a href="#cb400-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isRecreated&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-10"><a href="#cb400-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;indices&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo_name&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-11"><a href="#cb400-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;attributes&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb400-12"><a href="#cb400-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb400-13"><a href="#cb400-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;an_attribute&quot;</span><span class="fu">,</span></span>
<span id="cb400-14"><a href="#cb400-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="ot">[</span><span class="dv">1</span><span class="ot">,</span> <span class="ot">[</span><span class="st">&quot;foo&quot;</span><span class="ot">,</span> <span class="st">&quot;bar&quot;</span><span class="ot">]]</span></span>
<span id="cb400-15"><a href="#cb400-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb400-16"><a href="#cb400-16" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-17"><a href="#cb400-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;columns&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb400-18"><a href="#cb400-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb400-19"><a href="#cb400-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id&quot;</span><span class="fu">,</span></span>
<span id="cb400-20"><a href="#cb400-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb400-21"><a href="#cb400-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-22"><a href="#cb400-22" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isAdded&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-23"><a href="#cb400-23" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isDeleted&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-24"><a href="#cb400-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isPrimaryKey&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-25"><a href="#cb400-25" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isUniqueKey&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-26"><a href="#cb400-26" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isAutoIncrement&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb400-27"><a href="#cb400-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb400-28"><a href="#cb400-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb400-29"><a href="#cb400-29" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name&quot;</span><span class="fu">,</span></span>
<span id="cb400-30"><a href="#cb400-30" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb400-31"><a href="#cb400-31" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-32"><a href="#cb400-32" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isAdded&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-33"><a href="#cb400-33" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isDeleted&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-34"><a href="#cb400-34" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isPrimaryKey&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-35"><a href="#cb400-35" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isUniqueKey&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb400-36"><a href="#cb400-36" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isAutoIncrement&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb400-37"><a href="#cb400-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb400-38"><a href="#cb400-38" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-39"><a href="#cb400-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;primaryKey&quot;</span> <span class="fu">:</span> <span class="ot">[</span>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-40"><a href="#cb400-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;primaryKeySortOrders&quot;</span> <span class="fu">:</span> <span class="ot">[</span>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-41"><a href="#cb400-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;foreignKeys&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb400-42"><a href="#cb400-42" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-43"><a href="#cb400-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;uniqueKeys&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb400-44"><a href="#cb400-44" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb400-45"><a href="#cb400-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;checkExpressions&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb400-46"><a href="#cb400-46" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb400-47"><a href="#cb400-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="region-information">Region Information</h3>
<p>Region Information can appear on many entities, it consists of two
optional elements:</p>
<ul>
<li><strong>region</strong> : optional, the name of the region in which
the entity was defined</li>
<li><strong>deployedInRegion</strong> : optional, the deployment region
in which that region is located</li>
</ul>
<h3 id="attributes">Attributes</h3>
<p>Miscellaneous attributes can be present on virtual every kind of
entity. They are optional. The root node introduces the attributes:</p>
<ul>
<li><strong>attributes</strong> : a list at least one attribute</li>
</ul>
<p>Each attribute is a name and value pair:</p>
<ul>
<li><strong>name</strong> : any string
<ul>
<li>attribute names are often compound like “cql:shared_fragment”</li>
<li>they are otherwise simple identifiers</li>
<li>if the <code>[[attribute]]</code> form is used, it is expanded into
the normal <code>cql:attribute</code> form in the output</li>
</ul></li>
<li><strong>value</strong> : any <em>attribute value</em></li>
</ul>
<p>Each <em>attribute value</em> can be:</p>
<ul>
<li>any literal</li>
<li>an array of <em>attribute values</em></li>
</ul>
<p>Since the <em>attribute values</em> can nest it’s possible to
represent arbitrarily complex data types in an attribute.</p>
<h3 id="global-attributes">Global attributes</h3>
<p>While the most common use case for attributes is to be attached to
other entities (e.g., tables, columns), CQL also lets you define
“global” attributes, which are included in the top level
<code>attributes</code> section of the JSON output. To specify global
attributes you declare a variable of type <code>object</code> ending
with the suffix <code>database</code> and attach attributes to it. CQL
will merge together all the attributes from all the variables ending
with <code>database</code> and place them in the <code>attributes</code>
section of the JSON output.</p>
<p>Global attributes give you a way to add global configuration
information into the CQL JSON output. You can, for instance, include
these attributes in some root file that you <code>#include</code> in the
rest of your CQL code, and by doing this, these attributes will be
visible in any generated JSON for those files.</p>
<p>Example:</p>
<div class="sourceCode" id="cb401"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(attribute_1 = &quot;value_1&quot;)</span></span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(attribute_2 = &quot;value_2&quot;)</span></span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">database</span> <span class="dt">object</span>;</span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-5"><a href="#cb401-5" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(attribute_3 = &quot;value_3&quot;)</span></span>
<span id="cb401-6"><a href="#cb401-6" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> some_other_database <span class="dt">object</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb402"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;attributes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;attribute_1&quot;</span><span class="fu">,</span></span>
<span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;value_1&quot;</span></span>
<span id="cb402-6"><a href="#cb402-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb402-7"><a href="#cb402-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb402-8"><a href="#cb402-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;attribute_2&quot;</span><span class="fu">,</span></span>
<span id="cb402-9"><a href="#cb402-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;value_2&quot;</span></span>
<span id="cb402-10"><a href="#cb402-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb402-11"><a href="#cb402-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb402-12"><a href="#cb402-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;attribute_3&quot;</span><span class="fu">,</span></span>
<span id="cb402-13"><a href="#cb402-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;value_3&quot;</span></span>
<span id="cb402-14"><a href="#cb402-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb402-15"><a href="#cb402-15" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb402-16"><a href="#cb402-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="foreign-keys">Foreign Keys</h3>
<p>Foreign keys appear only in tables, the list of keys contains zero or
more entries of this form:</p>
<ul>
<li><strong>name</strong> : optional, the name of the foreign key if
specified</li>
<li><strong>columns</strong> : the names of the constrained columns in
the current table (the “child” table)</li>
<li><strong>referenceTable</strong> : the name of the table that came
after REFERENCES in the foreign key</li>
<li><strong>referenceColumns</strong> : the constraining columns in the
referenced table</li>
<li><strong>onUpdate</strong> : the ON UPDATE action (e.g. “CASCADE”,
“NO ACTION”, etc.)</li>
<li><strong>onDelete</strong> : the ON DELETE action (e.g. “CASCADE”,
“NO ACTION”, etc.)</li>
<li><strong>isDeferred</strong> : boolean, indicating the deferred or
not deferred setting for this foreign key</li>
</ul>
<h3 id="unique-keys">Unique Keys</h3>
<p>Unique keys appear only in tables, the list of keys contains zero or
more entries of this form:</p>
<ul>
<li><strong>name</strong>: optional, the name of the unique key if
specified</li>
<li><strong>columns</strong>: a list of 1 or more constrained column
names</li>
<li><strong>sortOrders</strong>: a list of corresponding sort orders for
the columns</li>
</ul>
<h3 id="check-expressions">Check Expressions</h3>
<p>Check Expressions appear only in tables, the list of keys contains
zero or more entries of this form:</p>
<ul>
<li><strong>name</strong> : optional, the name of the unique key if
specified</li>
<li><strong>checkExpr</strong> : the check expression in plain text</li>
<li><strong>checkExprArgs</strong>: an array of zero or more local
variables that should be bound to the <code>?</code> items in the check
expression</li>
</ul>
<p>The checkExprArgs will almost certainly be the empty list
<code>[]</code>. In the exceedingly rare situation that the table in
question was defined in a procedure and some of parts of the check
expression were arguments to that procedure then the check expression is
not fully known until that procedure runs and some of its literals will
be decided at run time. This is an extraordinary choice but technically
possible.</p>
<h3 id="columns">Columns</h3>
<p>Columns are themselves rather complex, there are 1 or more of them in
each table. The table will have a list of records of this form:</p>
<ul>
<li><strong>name</strong> : the name of the columns</li>
<li><strong><em>attributes</em></strong> : optional, see the <a
href="#attributes">section on attributes</a>, they appear in many
places</li>
<li><strong>type</strong> : the column type (e.g. bool, real, text,
etc.)</li>
<li><strong>kind</strong> : optional, if the type is qualified by a
discriminator such as int<task_id> it appears here</li>
<li><strong>isSensitive</strong> : optional, indicates a column that
holds sensitive information such as PII</li>
<li><strong>isNotNull</strong> : true if the column is not null</li>
<li><strong>isAdded</strong> : true if the column has an <span
class="citation" data-cites="create">@create</span> directive
<ul>
<li><strong>addedVersion</strong> : optional, the schema version number
in the <span class="citation" data-cites="create">@create</span>
directive</li>
</ul></li>
<li><strong>isDeleted</strong> : true if the column was marked with
<span class="citation" data-cites="delete">@delete</span>
<ul>
<li><strong>deletedVersion</strong> : optional, the schema version
number in the <span class="citation" data-cites="delete">@delete</span>
directive</li>
</ul></li>
<li><strong>defaultValue</strong> : optional, can be any literal, the
default value of the column</li>
<li><strong>collate</strong> : optional, the collation string
(e.g. nocase)</li>
<li><strong>checkExpr</strong> : optional, the <em>check expression</em>
for this column (see the related section)</li>
<li><strong>isPrimaryKey</strong> : true if the column was marked with
PRIMARY KEY</li>
<li><strong>isUniqueKey</strong> : true if the column was marked with
UNIQUE</li>
<li><strong>isAutoIncrement</strong> : true if the column was marked
with AUTOINCREMENT</li>
</ul>
<h3 id="virtual-tables">Virtual Tables</h3>
<p>The “virtualTables” section is very similar to the “tables” section
with zero or more virtual table entries. Virtual table entries are the
same as table entries with the following additions:</p>
<ul>
<li><strong>module</strong> : the name of the module that manages this
virtual table</li>
<li><strong>isEponymous</strong> : true if the virtual table was
declared eponymous</li>
<li><strong>isVirtual</strong> : always true for virtual tables</li>
</ul>
<p>The JSON schema for these items was designed to be as similar as
possible so that typically the same code can handle both with possibly a
few extra tests of the isVirtual field.</p>
<h3 id="views-1">Views</h3>
<p>The views section contains the list of all views in the schema, it is
zero or more view entires of this form.</p>
<ul>
<li><strong>name</strong> : the view name</li>
<li><strong>crc</strong> : the schema CRC for the entire view
definition</li>
<li><strong>isTemp</strong> : true if this is a temporary view</li>
<li><strong>isDeleted</strong> : true if the view was marked with <span
class="citation" data-cites="delete">@delete</span>
<ul>
<li><strong>deletedVersion</strong> : optional, the schema version
number in the <span class="citation" data-cites="delete">@delete</span>
directive</li>
</ul></li>
<li><strong><em>region information</em></strong> : optional, see the
section on Region Info</li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong><em>projection</em></strong> : an array of projected columns
from the view, the view result if you will, see the section on
projections</li>
<li><strong>select</strong> : the text of the select statement that
defined the view</li>
<li><strong>selectArgs</strong> : the names of arguments any unbound
expressions (“?”) in the view</li>
<li><strong><em>dependencies</em></strong> : several lists of tables and
how they are used in the view, see the <a href="#dependencies">section
on dependencies</a></li>
</ul>
<p>Note that the use of unbound expressions in a view truly
extraordinary so selectArgs is essentially always going to be an empty
list.</p>
<p>Example:</p>
<div class="sourceCode" id="cb403"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> MyView <span class="kw">AS</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb404"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;MyView&quot;</span><span class="fu">,</span></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CRC&quot;</span> <span class="fu">:</span> <span class="st">&quot;5545408966671198580&quot;</span><span class="fu">,</span></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isTemp&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isDeleted&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;projection&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id&quot;</span><span class="fu">,</span></span>
<span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb404-11"><a href="#cb404-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb404-12"><a href="#cb404-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb404-13"><a href="#cb404-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name&quot;</span><span class="fu">,</span></span>
<span id="cb404-14"><a href="#cb404-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb404-15"><a href="#cb404-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb404-16"><a href="#cb404-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb404-17"><a href="#cb404-17" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb404-18"><a href="#cb404-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;select&quot;</span> <span class="fu">:</span> <span class="st">&quot;SELECT id, name FROM foo&quot;</span><span class="fu">,</span></span>
<span id="cb404-19"><a href="#cb404-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;selectArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb404-20"><a href="#cb404-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fromTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb404-21"><a href="#cb404-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span></span>
<span id="cb404-22"><a href="#cb404-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="projections">Projections</h3>
<p>A projection defines the output shape of something that can return a
table-like value such as a view or a procedure.</p>
<p>The projection consists of a list of one or more <em>projected
columns</em>, each of which is:</p>
<ul>
<li><strong>name</strong> : the name of the result column (e.g. in
select 2 as foo) the name is “foo”</li>
<li><strong>type</strong> : the type of the column (e.g. text, real,
etc.)</li>
<li><strong>kind</strong> : optional, the discriminator of the type if
it has one (e.g. if the result is an <code>int&lt;job_id&gt;</code> the
kind is “job_id”)</li>
<li><strong>isSensitive</strong> : optional, true if the result is
sensitive (e.g. PII or something like that)</li>
<li><strong>isNotNull</strong> : true if the result is known to be not
null</li>
</ul>
<h3 id="dependencies">Dependencies</h3>
<p>The dependencies section appears in many entities, it indicates
things that were used by the object and how they were used. Most of the
fields are optional, some fields are impossible in some contexts
(e.g. inserts can happen inside of views).</p>
<ul>
<li><strong>insertTables</strong> : optional, a list of tables into
which values were inserted</li>
<li><strong>updateTables</strong> : optional, a list of tables whose
values were updated</li>
<li><strong>deleteTables</strong> : optional, a list of tables which had
rows deleted</li>
<li><strong>fromTables</strong> : optional, a list of tables that
appeared in a FROM clause (maybe indirectly inside a VIEW or CTE)</li>
<li><strong>usesProcedures</strong> : optional, a list of procedures
that were accessed via CALL (not shared fragments, those are
inlined)</li>
<li><strong>usesViews</strong> : optional, a list of views which were
accessed (these are recursively visited to get to tables)</li>
<li><strong>usesTables</strong> : the list of tables that were used in
any way at all by the current entity (i.e. the union of the previous
table sections)</li>
</ul>
<h3 id="indices-1">Indices</h3>
<p>The indices section contains the list of all indices in the schema,
it is zero or more view entires of this form:</p>
<ul>
<li><strong>name</strong> : the index name</li>
<li><strong>crc</strong> : the schema CRC for the entire index
definition</li>
<li><strong>table</strong> : the name of the table with this index</li>
<li><strong>isUnique</strong> : true if this is a unique index</li>
<li><strong>ifNotExists</strong> : true if this index was created with
IF NOT EXISTS</li>
<li><strong>isDeleted</strong> : true if the view was marked with <span
class="citation" data-cites="delete">@delete</span>
<ul>
<li><strong>deletedVersion</strong> : optional, the schema version
number in the <span class="citation" data-cites="delete">@delete</span>
directive</li>
</ul></li>
<li><strong><em>region information</em></strong> : optional, see the
section on Region Info</li>
<li><strong>where</strong> : optional, if this is partial index then
this has the partial index where expression</li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong>columns</strong> : the list of column names in the
index</li>
<li><strong>sortOrders</strong> : the list of corresponding sort
orders</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb405"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">index</span> foo_name <span class="kw">on</span> foo(name);</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb406"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo_name&quot;</span><span class="fu">,</span></span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;CRC&quot;</span> <span class="fu">:</span> <span class="st">&quot;6055860615770061843&quot;</span><span class="fu">,</span></span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isUnique&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ifNotExists&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isDeleted&quot;</span> <span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;columns&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;name&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;sortOrders&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;&quot;</span> <span class="ot">]</span></span>
<span id="cb406-10"><a href="#cb406-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="procedures">Procedures</h3>
<p>The next several sections:</p>
<ul>
<li>Queries</li>
<li>Inserts</li>
<li>General Inserts</li>
<li>Updates</li>
<li>Deletes</li>
<li>General</li>
</ul>
<p>All provide information about various types of procedures. Some
“simple” procedures that consist only of the type of statement
correspond to their section (and some other rules) present additional
information about their contents. This can sometimes be useful. All the
sections define certain common things about procedures so that basic
information is available about all procedures. This is is basically the
contents of the “general” section which deals with procedures that have
a complex body of which little can be said.</p>
<h4 id="queries">Queries</h4>
<p>The queries section corresponds to the stored procedures that are a
single SELECT statement with no fragments.</p>
<p>The fields of a query record are:</p>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>definedInFile</strong> : the file that contains the
procedure (the path is as it was specified to CQL so it might be
relative or absolute)</li>
<li><strong>definedOnLine</strong> : the line number of the file where
the procedure is declared</li>
<li><strong>args</strong> : <em>procedure arguments</em> see the
relevant section</li>
<li><strong><em>dependencies</em></strong> : several lists of tables and
how they are used in the view, see the section on dependencies</li>
<li><strong><em>region information</em></strong> : optional, see the
section on Region Info</li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong><em>projection</em></strong> : an array of projected columns
from the procedure, the view if you will, see <a href="#projections">the
section on projections</a></li>
<li><strong>statement</strong> : the text of the select statement that
is the body of the procedure</li>
<li><strong>statementArgs</strong> : a list of procedure arguments
(possibly empty) that should be used to replace the corresponding “?”
parameters in the statement</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb407"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p(name_ text)</span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb407-3"><a href="#cb407-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">where</span> name <span class="op">=</span> name_;</span>
<span id="cb407-4"><a href="#cb407-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb408"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;p&quot;</span><span class="fu">,</span></span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb408-6"><a href="#cb408-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb408-7"><a href="#cb408-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb408-8"><a href="#cb408-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb408-9"><a href="#cb408-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb408-10"><a href="#cb408-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb408-11"><a href="#cb408-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb408-12"><a href="#cb408-12" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb408-13"><a href="#cb408-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fromTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb408-14"><a href="#cb408-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb408-15"><a href="#cb408-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;projection&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb408-16"><a href="#cb408-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb408-17"><a href="#cb408-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id&quot;</span><span class="fu">,</span></span>
<span id="cb408-18"><a href="#cb408-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb408-19"><a href="#cb408-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb408-20"><a href="#cb408-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb408-21"><a href="#cb408-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb408-22"><a href="#cb408-22" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name&quot;</span><span class="fu">,</span></span>
<span id="cb408-23"><a href="#cb408-23" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb408-24"><a href="#cb408-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb408-25"><a href="#cb408-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb408-26"><a href="#cb408-26" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb408-27"><a href="#cb408-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;SELECT id, name FROM foo WHERE name = ?&quot;</span><span class="fu">,</span></span>
<span id="cb408-28"><a href="#cb408-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;name_&quot;</span> <span class="ot">]</span></span>
<span id="cb408-29"><a href="#cb408-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="procedure-arguments">Procedure Arguments</h4>
<p>Procedure arguments have several generalities that don’t come up very
often but are important to describe. The argument list of a procedure is
0 or more arguments of the form:</p>
<ul>
<li><strong>name</strong> : the argument name, any valid identifier</li>
<li><strong>argOrigin</strong> : either the name repeated if it’s just a
name or a 3 part string if it came from a bundle, see below</li>
<li><strong>type</strong> : the type of the argument (e.g. text, real,
etc.)</li>
<li><strong>kind</strong> : optional, the discriminated type if any
e.g. in <code>int&lt;job_id&gt;</code> it’s “job_id”</li>
<li><strong>isSensitive</strong> : optional, true if the argument is
marked with <span class="citation"
data-cites="sensitive">@sensitive</span> (e.g. it has PII etc.)</li>
<li><strong>isNotNull</strong> : true if the argument is declared not
null</li>
</ul>
<p>An example of a simple argument was shown above, if we change the
example a little bit to use the argument bundle syntax (even though it’s
overkill) we can see the general form of argOrigin.</p>
<p>Example:</p>
<div class="sourceCode" id="cb409"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p(a_foo <span class="kw">like</span> foo)</span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">where</span> name <span class="op">=</span> a_foo.name <span class="kw">or</span> <span class="kw">id</span> <span class="op">=</span> a_foo.<span class="kw">id</span>;</span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb410"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;p&quot;</span><span class="fu">,</span></span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb410-5"><a href="#cb410-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb410-6"><a href="#cb410-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb410-7"><a href="#cb410-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;a_foo_id&quot;</span><span class="fu">,</span></span>
<span id="cb410-8"><a href="#cb410-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;a_foo foo id&quot;</span><span class="fu">,</span></span>
<span id="cb410-9"><a href="#cb410-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb410-10"><a href="#cb410-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb410-11"><a href="#cb410-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb410-12"><a href="#cb410-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb410-13"><a href="#cb410-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;a_foo_name&quot;</span><span class="fu">,</span></span>
<span id="cb410-14"><a href="#cb410-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;a_foo foo name&quot;</span><span class="fu">,</span></span>
<span id="cb410-15"><a href="#cb410-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb410-16"><a href="#cb410-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb410-17"><a href="#cb410-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb410-18"><a href="#cb410-18" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb410-19"><a href="#cb410-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fromTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb410-20"><a href="#cb410-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb410-21"><a href="#cb410-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;projection&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb410-22"><a href="#cb410-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb410-23"><a href="#cb410-23" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id&quot;</span><span class="fu">,</span></span>
<span id="cb410-24"><a href="#cb410-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb410-25"><a href="#cb410-25" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb410-26"><a href="#cb410-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb410-27"><a href="#cb410-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb410-28"><a href="#cb410-28" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name&quot;</span><span class="fu">,</span></span>
<span id="cb410-29"><a href="#cb410-29" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb410-30"><a href="#cb410-30" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb410-31"><a href="#cb410-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb410-32"><a href="#cb410-32" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb410-33"><a href="#cb410-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;SELECT id, name FROM foo WHERE name = ? OR id = ?&quot;</span><span class="fu">,</span></span>
<span id="cb410-34"><a href="#cb410-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;a_foo_name&quot;</span><span class="ot">,</span> <span class="st">&quot;a_foo_id&quot;</span> <span class="ot">]</span></span>
<span id="cb410-35"><a href="#cb410-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<p>Note the synthetic names <code>a_foo_id</code> and
<code>a_foo_name</code> the argOrigin indicates that the bundle name is
<code>a_foo</code> which could have been anything, the shape was
<code>foo</code> and the column in <code>foo</code> was <code>id</code>
or <code>name</code> as appropriate.</p>
<p>The JSON is often used to generate glue code to call procedures from
different languages. The argOrigin can be useful if you want to codegen
something other normal arguments in your code.</p>
<h4 id="general-inserts">General Inserts</h4>
<p>The general insert section corresponds to the stored procedures that
are a single INSERT statement with no fragments. The fields of a general
insert record are:</p>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>definedInFile</strong> : the file that contains the
procedure (the path is as it was specified to CQL so it might be
relative or absolute)</li>
<li><strong>definedOnLine</strong> : the line number of the file where
the procedure is declared</li>
<li><strong>args</strong> : <em>procedure arguments</em> see <a
href="#procedure-arguments">the relevant section</a></li>
<li><strong><em>dependencies</em></strong> : several lists of tables and
how they are used in the view, see the <a href="#dependencies">section
on dependencies</a></li>
<li><strong><em>region information</em></strong> : optional, see the <a
href="#region-information">section on Region Info</a></li>
<li><strong><em>attributes</em></strong> : optional, see the <a
href="#attributes">section on attributes</a>, they appear in many
places</li>
<li><strong>table</strong> : the name of the table the procedure inserts
into</li>
<li><strong>statement</strong> : the text of the select statement that
is the body of the procedure</li>
<li><strong>statementArgs</strong> : a list of procedure arguments
(possibly empty) that should be used to replace the corresponding “?”
parameters in the statement</li>
<li><strong>statementType</strong> : there are several insert forms such
as “INSERT”, “INSERT OR REPLACE”, “REPLACE”, etc. the type is encoded
here</li>
</ul>
<p>General inserts does not include the inserted values because they are
not directly extractable in general. This form is used if one of these
is true:</p>
<ul>
<li>insert from multiple value rows</li>
<li>insert from a select statement</li>
<li>insert using a <code>WITH</code> clause</li>
<li>insert using the upsert clause</li>
</ul>
<p>If fragments are in use then even “generalInsert” cannot capture
everything and “general” must be used (see below).</p>
<p>Example:</p>
<div class="sourceCode" id="cb411"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p()</span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> foo <span class="kw">values</span> (<span class="dv">1</span>, <span class="ot">&quot;foo&quot;</span>), (<span class="dv">2</span>, <span class="ot">&quot;bar&quot;</span>);</span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb412"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;p&quot;</span><span class="fu">,</span></span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;insertTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb412-7"><a href="#cb412-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb412-8"><a href="#cb412-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb412-9"><a href="#cb412-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;INSERT INTO foo(id, name) VALUES(1, &#39;foo&#39;), (2, &#39;bar&#39;)&quot;</span><span class="fu">,</span></span>
<span id="cb412-10"><a href="#cb412-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb412-11"><a href="#cb412-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementType&quot;</span> <span class="fu">:</span> <span class="st">&quot;INSERT&quot;</span><span class="fu">,</span></span>
<span id="cb412-12"><a href="#cb412-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;columns&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;id&quot;</span><span class="ot">,</span> <span class="st">&quot;name&quot;</span> <span class="ot">]</span></span>
<span id="cb412-13"><a href="#cb412-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="simple-inserts">Simple Inserts</h4>
<p>The vanilla inserts section can be used for procedures that just
insert a single row. This is a very common case and if the JSON is being
used to drive custom code generation it is useful to provide the extra
information. The data in this section is exactly the same as the General
Inserts section except that includes the inserted values. The “values”
property has this extra information.</p>
<p>Each value in the values list corresponds 1:1 with a column and has
this form:</p>
<ul>
<li><strong>value</strong> : the expression for this value</li>
<li><strong>valueArgs</strong>: the array of procedure arguments that
should replace the “?” entries in the value</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb413"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p(<span class="kw">like</span> foo)</span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> foo <span class="kw">from</span> arguments;</span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb414"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;p&quot;</span><span class="fu">,</span></span>
<span id="cb414-3"><a href="#cb414-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb414-4"><a href="#cb414-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb414-5"><a href="#cb414-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb414-6"><a href="#cb414-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb414-7"><a href="#cb414-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb414-8"><a href="#cb414-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo name&quot;</span><span class="fu">,</span></span>
<span id="cb414-9"><a href="#cb414-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb414-10"><a href="#cb414-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb414-11"><a href="#cb414-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb414-12"><a href="#cb414-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb414-13"><a href="#cb414-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id_&quot;</span><span class="fu">,</span></span>
<span id="cb414-14"><a href="#cb414-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo id&quot;</span><span class="fu">,</span></span>
<span id="cb414-15"><a href="#cb414-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb414-16"><a href="#cb414-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb414-17"><a href="#cb414-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb414-18"><a href="#cb414-18" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb414-19"><a href="#cb414-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;insertTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb414-20"><a href="#cb414-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb414-21"><a href="#cb414-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb414-22"><a href="#cb414-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;INSERT INTO foo(id, name) VALUES(?, ?)&quot;</span><span class="fu">,</span></span>
<span id="cb414-23"><a href="#cb414-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;id_&quot;</span><span class="ot">,</span> <span class="st">&quot;name_&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb414-24"><a href="#cb414-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementType&quot;</span> <span class="fu">:</span> <span class="st">&quot;INSERT&quot;</span><span class="fu">,</span></span>
<span id="cb414-25"><a href="#cb414-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;columns&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;id&quot;</span><span class="ot">,</span> <span class="st">&quot;name&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb414-26"><a href="#cb414-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;values&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb414-27"><a href="#cb414-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb414-28"><a href="#cb414-28" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="st">&quot;?&quot;</span><span class="fu">,</span></span>
<span id="cb414-29"><a href="#cb414-29" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;valueArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;id_&quot;</span> <span class="ot">]</span></span>
<span id="cb414-30"><a href="#cb414-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb414-31"><a href="#cb414-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb414-32"><a href="#cb414-32" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="st">&quot;?&quot;</span><span class="fu">,</span></span>
<span id="cb414-33"><a href="#cb414-33" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;valueArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;name_&quot;</span> <span class="ot">]</span></span>
<span id="cb414-34"><a href="#cb414-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb414-35"><a href="#cb414-35" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb414-36"><a href="#cb414-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="updates">Updates</h4>
<p>The updates section corresponds to the stored procedures that are a
single UPDATE statement with no fragments. The fields of an update
record are:</p>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>definedInFile</strong> : the file that contains the
procedure (the path is as it was specified to CQL so it might be
relative or absolute)</li>
<li><strong>definedOnLine</strong> : the line number of the file where
the procedure is declared</li>
<li><strong>args</strong> : <em>procedure arguments</em> see <a
href="#procedure-arguments">the relevant section</a></li>
<li><strong><em>dependencies</em></strong> : several lists of tables and
how they are used in the view, see the section on dependencies</li>
<li><strong><em>region information</em></strong> : optional, see <a
href="#region-information">the section on Region Info</a></li>
<li><strong><em>attributes</em></strong> : optional, see <a
href="#attributes">the section on attributes</a>, they appear in many
places</li>
<li><strong>table</strong> : the name of the table the procedure inserts
into</li>
<li><strong>statement</strong> : the text of the update statement that
is the body of the procedure</li>
<li><strong>statementArgs</strong> : a list of procedure arguments
(possibly empty) that should be used to replace the corresponding “?”
parameters in the statement</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb415"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc p(<span class="kw">like</span> foo)</span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">update</span> foo <span class="kw">set</span> name <span class="op">=</span> name_ <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb416"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;p&quot;</span><span class="fu">,</span></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb416-5"><a href="#cb416-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb416-6"><a href="#cb416-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb416-7"><a href="#cb416-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb416-8"><a href="#cb416-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo name&quot;</span><span class="fu">,</span></span>
<span id="cb416-9"><a href="#cb416-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb416-10"><a href="#cb416-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb416-11"><a href="#cb416-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb416-12"><a href="#cb416-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb416-13"><a href="#cb416-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id_&quot;</span><span class="fu">,</span></span>
<span id="cb416-14"><a href="#cb416-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo id&quot;</span><span class="fu">,</span></span>
<span id="cb416-15"><a href="#cb416-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb416-16"><a href="#cb416-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb416-17"><a href="#cb416-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb416-18"><a href="#cb416-18" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb416-19"><a href="#cb416-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;updateTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb416-20"><a href="#cb416-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb416-21"><a href="#cb416-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb416-22"><a href="#cb416-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;UPDATE foo SET name = ? WHERE id = ?&quot;</span><span class="fu">,</span></span>
<span id="cb416-23"><a href="#cb416-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;name_&quot;</span><span class="ot">,</span> <span class="st">&quot;id_&quot;</span> <span class="ot">]</span></span>
<span id="cb416-24"><a href="#cb416-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="deletes">Deletes</h4>
<p>The deletes section corresponds to the stored procedures that are a
single DELETE statement with no fragments. The fields of a delete record
are exactly the same as those of update. Those are the basic fields
needed to bind any statement.</p>
<p>Example:</p>
<div class="sourceCode" id="cb417"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc delete_proc (name_ text)</span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span> <span class="kw">from</span> foo <span class="kw">where</span> name <span class="kw">like</span> name_;</span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb418"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;delete_proc&quot;</span><span class="fu">,</span></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;name_&quot;</span><span class="fu">,</span></span>
<span id="cb418-9"><a href="#cb418-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb418-10"><a href="#cb418-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb418-11"><a href="#cb418-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb418-12"><a href="#cb418-12" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb418-13"><a href="#cb418-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;deleteTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb418-14"><a href="#cb418-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;foo&quot;</span> <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb418-15"><a href="#cb418-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb418-16"><a href="#cb418-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statement&quot;</span> <span class="fu">:</span> <span class="st">&quot;DELETE FROM foo WHERE name LIKE ?&quot;</span><span class="fu">,</span></span>
<span id="cb418-17"><a href="#cb418-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;statementArgs&quot;</span> <span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;name_&quot;</span> <span class="ot">]</span></span>
<span id="cb418-18"><a href="#cb418-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="general">General</h4>
<p>And finally the section for procedures that were encountered that are
not one of the simple prepared statement forms. The principle reasons
for being in this category are: * the procedure has out arguments * the
procedure uses something other than a single DML statement * the
procedure has no projection (no result of any type) * the procedure uses
shared fragments and hence has complex argument binding</p>
<p>The fields of a general procedure are something like a union of
update and delete and query but with no statement info. The are as
follows:</p>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>definedInFile</strong> : the file that contains the
procedure (the path is as it was specified to CQL so it might be
relative or absolute)</li>
<li><strong>definedOnLine</strong> : the line number of the file where
the procedure is declared</li>
<li><strong>args</strong> : <em>complex procedure arguments</em> see the
relevant section</li>
<li><strong><em>dependencies</em></strong> : several lists of tables and
how they are used in the view, see the section on dependencies</li>
<li><strong><em>region information</em></strong> : optional, see the
section on Region Info</li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong><em>projection</em></strong> : optional, an array of
projected columns from the procedure, the view if you will, see the
section on projections</li>
<li><strong><em>result_contract</em></strong> : optional,</li>
<li><strong>table</strong> : the name of the table the procedure inserts
into</li>
<li><strong>statement</strong> : the text of the update statement that
is the body of the procedure</li>
<li><strong>statementArgs</strong> : a list of procedure arguments
(possibly empty) that should be used to replace the corresponding “?”
parameters in the statement</li>
<li><strong>usesDatabase</strong> : true if the procedure requires you
to pass in a sqlite connection to call it</li>
</ul>
<p>The result contract is at most one of these:</p>
<ul>
<li><strong>hasSelectResult</strong> : true if the procedure generates
its projection using SELECT</li>
<li><strong>hasOutResult</strong>: true if the procedure generates its
projection using OUT</li>
<li><strong>hasOutUnionResult</strong>: true if the procedure generates
its projection using OUT UNION</li>
</ul>
<p>A procedure that does not produce a result set in any way will set
none of these and have no projection entry.</p>
<p>Example:</p>
<div class="sourceCode" id="cb419"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc with_complex_args (inout arg <span class="dt">real</span>)</span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> arg <span class="op">:=</span> (<span class="kw">select</span> arg<span class="op">+</span><span class="dv">1</span> <span class="kw">as</span> a);</span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="ot">&quot;foo&quot;</span> bar;</span>
<span id="cb419-5"><a href="#cb419-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb420"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;with_complex_args&quot;</span><span class="fu">,</span></span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;args&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;binding&quot;</span> <span class="fu">:</span> <span class="st">&quot;inout&quot;</span><span class="fu">,</span></span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;arg&quot;</span><span class="fu">,</span></span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;argOrigin&quot;</span> <span class="fu">:</span> <span class="st">&quot;arg&quot;</span><span class="fu">,</span></span>
<span id="cb420-10"><a href="#cb420-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;real&quot;</span><span class="fu">,</span></span>
<span id="cb420-11"><a href="#cb420-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb420-12"><a href="#cb420-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb420-13"><a href="#cb420-13" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb420-14"><a href="#cb420-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesTables&quot;</span> <span class="fu">:</span> <span class="ot">[</span>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb420-15"><a href="#cb420-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;projection&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb420-16"><a href="#cb420-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb420-17"><a href="#cb420-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;bar&quot;</span><span class="fu">,</span></span>
<span id="cb420-18"><a href="#cb420-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb420-19"><a href="#cb420-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb420-20"><a href="#cb420-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb420-21"><a href="#cb420-21" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb420-22"><a href="#cb420-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;hasSelectResult&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb420-23"><a href="#cb420-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;usesDatabase&quot;</span> <span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb420-24"><a href="#cb420-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h4 id="complex-procedure-arguments">Complex Procedure Arguments</h4>
<p>The complex form of the arguments allows for an optional
“binding”</p>
<ul>
<li><strong>binding</strong> : optional, if present it can take the
value “out” or “inout”
<ul>
<li>if absent then binding is the usual “in”</li>
</ul></li>
</ul>
<p>Note that atypical binding forces procedures into the “general”
section.</p>
<h3 id="interfaces">Interfaces</h3>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>definedInFile</strong> : the file that contains the
procedure (the path is as it was specified to CQL so it might be
relative or absolute)</li>
<li><strong>definedOnLine</strong> : the line number of the file where
the procedure is declared</li>
<li><strong>attributes</strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong>projection</strong>: An array of projections. See <a
href="#projections">the section on projections</a></li>
</ul>
<p>Example</p>
<div class="sourceCode" id="cb421"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> interface interface1 (<span class="kw">id</span> <span class="dt">integer</span>);</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb422"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;interface1&quot;</span><span class="fu">,</span></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedInFile&quot;</span> <span class="fu">:</span> <span class="st">&quot;x.sql&quot;</span><span class="fu">,</span></span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;definedOnLine&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;projection&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;id&quot;</span><span class="fu">,</span></span>
<span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb422-9"><a href="#cb422-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb422-10"><a href="#cb422-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb422-11"><a href="#cb422-11" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb422-12"><a href="#cb422-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="procecdure-declarations">Procecdure Declarations</h3>
<p>The <code>declareProcs</code> section contains a list of procedure
declaractions. Each declaration is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the procedure</li>
<li><strong>args</strong> : <em>procedure arguments</em> see the
relevant section</li>
<li><strong>attributes</strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong>projection</strong> : An array of projections. See <a
href="#projections">the section on projections</a></li>
<li><strong>usesDatabase</strong> : true if the procedure requires you
to pass in a sqlite connection to call it</li>
</ul>
<h3 id="function-declarations">Function Declarations</h3>
<p>The <code>declareFuncs</code> section contains a list of function
declarations, Each declaration is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the function</li>
<li><strong>args</strong> : see <a href="#procedure-arguments">the
relevant section</a></li>
<li><strong>attributes</strong> : optional, see the section on
attributes, they appear in many places</li>
<li><strong>returnType</strong> : see the relevant section below.</li>
<li><strong>createsObject</strong> : true if the function will create a
new object
(e.g. <code>declare function dict_create() create object;</code>)</li>
</ul>
<h3 id="return-type">Return Type</h3>
<ul>
<li><strong>type</strong> : base type of the return value (e.g. INT,
LONG)</li>
<li><strong>kind</strong> : optional, if the type is qualified by a
discriminator such as int<task_id> it appears here</li>
<li><strong>isSensitive</strong> : optional, true if the result is
sensitive (e.g. PII)</li>
<li><strong>isNotNull</strong> : true if the result is known to be not
null</li>
</ul>
<h3 id="regions">Regions</h3>
<p>The regions section contains a list of all the region definitions.
Each region is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the region</li>
<li><strong>isDeployableRoot</strong> : is this region itself a
deployment region (declared with <span class="citation"
data-cites="declare_deployable_region">@declare_deployable_region</span>)</li>
<li><strong>deployedInRegion</strong> : name, the deployment region that
contains this region or “(orphan)” if none
<ul>
<li>note that deploymentRegions form a forest</li>
</ul></li>
<li><strong>using</strong> : a list of zero or more parent regions</li>
<li><strong>usingPrivately</strong>: a list of zero more more booleans,
one corresponding to each region
<ul>
<li>the boolean is true if the inheritance is private, meaning that
sub-regions cannot see the contents of the inherited region</li>
</ul></li>
</ul>
<p>There are more details on regions and the meaning of these terms in
Chapter 10.</p>
<h3 id="ad-hoc-migrations">Ad Hoc Migrations</h3>
<p>This section lists all of the declared ad hoc migrations. Each entry
is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the procedure to be called for
the migration step</li>
<li><strong>crc</strong> : the CRC of this migration step, a hash of the
call</li>
<li><strong><em>attributes</em></strong> : optional, see the section on
attributes, they appear in many places</li>
</ul>
<p>Exactly one of:</p>
<ul>
<li><strong>version</strong>: optional, any positive integer, the
version at which the migration runs, OR</li>
<li><strong>onRecreateOf</strong>: optional, if present indicates that
the migration runs when the indicated group is recreated</li>
</ul>
<p>There are more details on ad hoc migrations in Chapter 10.</p>
<h3 id="enums">Enums</h3>
<p>This section list all the enumeration types and values. Each entry is
of the form:</p>
<ul>
<li><strong>name</strong> : the name of the enumeration</li>
<li><strong>type</strong> : the base type of the enumeration (e.g. INT,
LONG)</li>
<li><strong>isNotNull</strong>: always true, all enum values are not
null (here for symmetry with other uses of “type”)</li>
<li><strong>values</strong>: a list of legal enumeration values</li>
</ul>
<p>Each enumeration value is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the value</li>
<li><strong>value</strong> : a numeric literal</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb423"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> enum an_enumeration <span class="dt">integer</span> ( x <span class="op">=</span> <span class="dv">5</span>, y <span class="op">=</span> <span class="dv">12</span> );</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb424"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;an_enumeration&quot;</span><span class="fu">,</span></span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;values&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="dv">5</span></span>
<span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb424-10"><a href="#cb424-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb424-11"><a href="#cb424-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;y&quot;</span><span class="fu">,</span></span>
<span id="cb424-12"><a href="#cb424-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="dv">12</span></span>
<span id="cb424-13"><a href="#cb424-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb424-14"><a href="#cb424-14" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb424-15"><a href="#cb424-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="constant-groups">Constant Groups</h3>
<p>This section list all the constant groups and values. Each entry is
of the form:</p>
<ul>
<li><strong>name</strong> : the name of the constant group</li>
<li><strong>values</strong>: a list of declared constant values, this
can be of mixed type</li>
</ul>
<p>Each constant value is of the form:</p>
<ul>
<li><strong>name</strong> : the name of the constant</li>
<li><strong>type</strong> : the base type of the constant (e.g. LONG,
REAL, etc.)</li>
<li><strong>kind</strong> : optional, the type kind of the constant
(this can be set with a CAST on a literal, e.g. CAST(1 as
int<job_id>))</li>
<li><strong>isNotNull</strong> : true if the constant type is not null
(which is anything but the NULL literal)</li>
<li><strong>value</strong> : the numeric or string literal value of the
constant</li>
</ul>
<p>Example:</p>
<div class="sourceCode" id="cb425"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> const <span class="kw">group</span> some_constants (</span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> <span class="fu">cast</span>(<span class="dv">5</span> <span class="kw">as</span> <span class="dt">integer</span><span class="op">&lt;</span>job_id<span class="op">&gt;</span>),</span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> <span class="fl">12.0</span>,</span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>  z <span class="op">=</span> <span class="st">&#39;foo&#39;</span></span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb426"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;some_constants&quot;</span><span class="fu">,</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;values&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;x&quot;</span><span class="fu">,</span></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;integer&quot;</span><span class="fu">,</span></span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;kind&quot;</span> <span class="fu">:</span> <span class="st">&quot;job_id&quot;</span><span class="fu">,</span></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="dv">5</span></span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;y&quot;</span><span class="fu">,</span></span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;real&quot;</span><span class="fu">,</span></span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb426-15"><a href="#cb426-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="fl">1.200000e+01</span></span>
<span id="cb426-16"><a href="#cb426-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb426-17"><a href="#cb426-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb426-18"><a href="#cb426-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;name&quot;</span> <span class="fu">:</span> <span class="st">&quot;z&quot;</span><span class="fu">,</span></span>
<span id="cb426-19"><a href="#cb426-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;text&quot;</span><span class="fu">,</span></span>
<span id="cb426-20"><a href="#cb426-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;isNotNull&quot;</span> <span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb426-21"><a href="#cb426-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span></span>
<span id="cb426-22"><a href="#cb426-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb426-23"><a href="#cb426-23" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb426-24"><a href="#cb426-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="subscriptions">Subscriptions</h3>
<p>This section list all the schema subscriptions in order of
appearance. Each entry is of the form:</p>
<ul>
<li><strong>type</strong> : always “unsub” at this time</li>
<li><strong>table</strong> : the target of the subscription
directive</li>
<li><strong>version</strong> : the version at which this operation is to
happen (always 1 at this time)</li>
</ul>
<p>This section is a little more complicated than it needs to be becasue
of the legacy/deprecated <code>@resub</code> directive. At this point
only the table name is relevant. The version is always 1 and the type is
always “unsub”.</p>
<p>Example:</p>
<div class="sourceCode" id="cb427"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@unsub(foo);</span></span></code></pre></div>
<p>Generates:</p>
<div class="sourceCode" id="cb428"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span> <span class="fu">:</span> <span class="st">&quot;unsub&quot;</span><span class="fu">,</span></span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;table&quot;</span> <span class="fu">:</span> <span class="st">&quot;foo&quot;</span><span class="fu">,</span></span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;version&quot;</span> <span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span></code></pre></div>
<h3 id="summary">Summary</h3>
<p>These sections general provide all the information about everything
that was declared in a translation unit. Typically not the full body of
what was declared but its interface. The schema information provide the
core type and context while the procedure information illuminates the
code that was generated and how you might call it.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-14-cql-shared-fragments">Chapter 14: CQL Shared
Fragments</h2>
<p>Shared fragments allows you to reuse and compose SQL queires in a
safe (type checked) and efficient manner. They are based on <a
href="https://www.sqlite.org/lang_with.html">Common Table Expressions
(CTEs)</a>, so some basic knowledge of that is recommended before using
Shared Fragments.</p>
<p>You can think of shared fragments as being somewhat like a
parameterized view, but the parameters are both value parameters and
type parameters. In Java or C#, a shared fragments might have had an
invocation that looked something like this:
<code>my_fragment(1,2)&lt;table1, table2&gt;</code>.</p>
<p>It’s helpful to consider a real example:</p>
<div class="sourceCode" id="cb429"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a>split_text(tok) <span class="kw">AS</span> (</span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span> RECURSIVE</span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a>    splitter(tok,rest) <span class="kw">AS</span> (</span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span></span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span> tok,</span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a>        IFNULL( some_variable_ <span class="op">||</span> <span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>) rest</span>
<span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span></span>
<span id="cb429-9"><a href="#cb429-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">substr</span>(rest, <span class="dv">1</span>, <span class="fu">instr</span>(rest, <span class="st">&#39;,&#39;</span>) <span class="op">-</span> <span class="dv">1</span>) tok,</span>
<span id="cb429-10"><a href="#cb429-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">substr</span>(rest, <span class="fu">instr</span>(rest, <span class="st">&#39;,&#39;</span>) <span class="op">+</span> <span class="dv">1</span>) rest</span>
<span id="cb429-11"><a href="#cb429-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> splitter</span>
<span id="cb429-12"><a href="#cb429-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> rest <span class="op">!=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb429-13"><a href="#cb429-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb429-14"><a href="#cb429-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> tok <span class="kw">from</span> splitter <span class="kw">where</span> tok <span class="op">!=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb429-15"><a href="#cb429-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This text might appear in dozens of places where a comma separated
list needs to be split into pieces and there is no good way to share the
code between these locations. CQL is frequently used in conjunction with
the C-pre-processor so you could come up with something using the
#define construct but this is problematic for several reasons:</p>
<ul>
<li>the compiler does not then know that the origin of the text really
is the same
<ul>
<li>thus it has no clue that sharing the text of the string might be a
good idea</li>
</ul></li>
<li>any error messages happen in the context of the use of the macro not
the definition</li>
<li>bonus: a multi-line macro like the above gets folded into one line
so any error messages are impenetrable</li>
<li>if you try to compose such macros it only gets worse; it’s more code
duplication and harder error cases</li>
<li>any IDE support for syntax coloring and so forth will be confused by
the macro as it’s not part of the language</li>
</ul>
<p>None of this is any good but the desire to create helpers like this
is real both for correctness and for performance.</p>
<p>To make these things possible, we introduce the notion of shared
fragments. We need to give them parameters and the natural way to create
a select statement that is bindable in CQL is the procedure. So the
shape we choose looks like this:</p>
<div class="sourceCode" id="cb430"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a>PROC split_text(<span class="fu">value</span> TEXT)</span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span> RECURSIVE</span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>    splitter(tok,rest) <span class="kw">AS</span> (</span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span> tok,</span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a>        IFNULL( <span class="fu">value</span> <span class="op">||</span> <span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>) rest</span>
<span id="cb430-9"><a href="#cb430-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb430-10"><a href="#cb430-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span></span>
<span id="cb430-11"><a href="#cb430-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">substr</span>(rest, <span class="dv">1</span>, <span class="fu">instr</span>(rest, <span class="st">&#39;,&#39;</span>) <span class="op">-</span> <span class="dv">1</span>) tok,</span>
<span id="cb430-12"><a href="#cb430-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">substr</span>(rest, <span class="fu">instr</span>(rest, <span class="st">&#39;,&#39;</span>) <span class="op">+</span> <span class="dv">1</span>) rest</span>
<span id="cb430-13"><a href="#cb430-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> tokens</span>
<span id="cb430-14"><a href="#cb430-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> rest <span class="op">!=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb430-15"><a href="#cb430-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb430-16"><a href="#cb430-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> tok <span class="kw">from</span> splitter <span class="kw">where</span> tok <span class="op">!=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb430-17"><a href="#cb430-17" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>The introductory attribute <code>[[shared_fragment]]</code> indicates
that the procedure is to produce no code, but rather will be inlined as
a CTE in other locations. To use it, we introduce the ability to call a
procedure as part of a CTE declaration. Like so:</p>
<div class="sourceCode" id="cb431"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a>  result(v) <span class="kw">as</span> (<span class="kw">call</span> split_text(<span class="st">&#39;x,y,z&#39;</span>))</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> result;</span></code></pre></div>
<p>Once the fragment has been defined, the statement above could appear
anywhere, and of course the text <code>'x,y,z'</code> need not be
constant. For instance:</p>
<div class="sourceCode" id="cb432"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>PROC print_parts(<span class="fu">value</span> TEXT)</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span></span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>      result(v) <span class="kw">as</span> (<span class="kw">CALL</span> split_text(<span class="st">&#39;x,y,z&#39;</span>))</span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> result;</span>
<span id="cb432-7"><a href="#cb432-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-8"><a href="#cb432-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH C</span>
<span id="cb432-9"><a href="#cb432-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb432-10"><a href="#cb432-10" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CALL</span> printf(<span class="ot">&quot;%s\n&quot;</span>, C.v);</span>
<span id="cb432-11"><a href="#cb432-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb432-12"><a href="#cb432-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Fragments are also composable, so for instance, we might also want
some shared code that extracts comma separated numbers. We could do
this:</p>
<div class="sourceCode" id="cb433"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a>PROC ids_from_string(<span class="fu">value</span> TEXT)</span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a>    result(v) <span class="kw">as</span> (<span class="kw">CALL</span> split_text(<span class="fu">value</span>))</span>
<span id="cb433-6"><a href="#cb433-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="fu">CAST</span>(v <span class="kw">as</span> <span class="dt">LONG</span>) <span class="kw">as</span> <span class="kw">id</span> <span class="kw">from</span> result;</span>
<span id="cb433-7"><a href="#cb433-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Now we could write:</p>
<div class="sourceCode" id="cb434"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a>PROC print_ids(<span class="fu">value</span> TEXT)</span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span></span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span></span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a>      result(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string(<span class="st">&#39;1,2,3&#39;</span>))</span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> result;</span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH C</span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CALL</span> printf(<span class="ot">&quot;%ld\n&quot;</span>, C.<span class="kw">id</span>);</span>
<span id="cb434-11"><a href="#cb434-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb434-12"><a href="#cb434-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Of course these are very simple examples but in principle you can use
the generated tables in whatever way is necessary. For instance, here’s
a silly but illustrative example:</p>
<div class="sourceCode" id="cb435"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* This is a bit silly */</span></span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>PROC print_common_ids(<span class="fu">value</span> TEXT)</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span></span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>      v1(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string(<span class="st">&#39;1,2,3&#39;</span>)),</span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>      v2(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string(<span class="st">&#39;2,4,6&#39;</span>))</span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> v1</span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">INTERSECT</span></span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> v2;</span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH C</span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CALL</span> printf(<span class="ot">&quot;%ld\n&quot;</span>, C.<span class="kw">id</span>);</span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>With a small amount of dynamism in the generation of the SQL for the
above, it’s possible to share the body of v1 and v2. SQL will of course
see the full expansion but your program only needs one copy no matter
how many times you use the fragment anywhere in the code.</p>
<p>So far we have illustrated the “parameter” part of the flexibility.
Now let’s look at the “generics” part; even though it’s overkill for
this example, it should still be illustrative. You could imagine that
the procedure we wrote above <code>ids_from_string</code> might do
something more complicated, maybe filtering out negative ids, ids that
are too big, or that don’t match some pattern, whatever the case might
be. You might want these features in a variety of contexts, maybe not
just starting from a string to split.</p>
<p>We can rewrite the fragment in a “generic” way like so:</p>
<div class="sourceCode" id="cb436"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a>PROC ids_from_string_table()</span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span></span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">source</span>(v) <span class="kw">LIKE</span> (<span class="kw">select</span> <span class="ot">&quot;x&quot;</span> v)</span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="fu">CAST</span>(v <span class="kw">as</span> <span class="dt">LONG</span>) <span class="kw">as</span> <span class="kw">id</span> <span class="kw">from</span> <span class="kw">source</span>;</span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Note the new construct for a CTE definition: inside a fragment we can
use “LIKE” to define a plug-able CTE. In this case we used a
<code>select</code> statement to describe the shape the fragment
requires. We could also have used a name
<code>source(*) LIKE shape_name</code> just like we use shape names when
describing cursors. The name can be any existing view, table, a
procedure with a result, etc. Any name that describes a shape.</p>
<p>Now when the fragment is invoked, you provide the actual data source
(some table, view, or CTE) and that parameter takes the role of
“values”. Here’s a full example:</p>
<div class="sourceCode" id="cb437"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a>PROC print_ids(<span class="fu">value</span> TEXT)</span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span></span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span></span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a>      my_data(<span class="op">*</span>) <span class="kw">as</span> (<span class="kw">CALL</span> split_text(<span class="fu">value</span>)),</span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>      my_numbers(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string_table() <span class="kw">USING</span> my_data <span class="kw">AS</span> <span class="kw">source</span>)</span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">from</span> my_numbers;</span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">LOOP</span> FETCH C</span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">BEGIN</span></span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a>     <span class="kw">CALL</span> printf(<span class="ot">&quot;%ld\n&quot;</span>, C.<span class="kw">id</span>);</span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb437-13"><a href="#cb437-13" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>We could actually rewrite the previous simple id fragment as
follows:</p>
<div class="sourceCode" id="cb438"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>PROC ids_from_string(<span class="fu">value</span> TEXT)</span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span></span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a>    tokens(v) <span class="kw">as</span> (<span class="kw">CALL</span> split_text(<span class="fu">value</span>))</span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>    ids(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string_table() <span class="kw">USING</span> tokens <span class="kw">as</span> <span class="kw">source</span>)</span>
<span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> ids;</span>
<span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>And actually we have a convenient name we could use for the shape we
need so we could have used the shape syntax to define
<code>ids_from_string_table</code>.</p>
<div class="sourceCode" id="cb439"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a>PROC ids_from_string_table()</span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WITH</span></span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">source</span>(<span class="op">*</span>) <span class="kw">LIKE</span> split_text</span>
<span id="cb439-6"><a href="#cb439-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="fu">CAST</span>(tok <span class="kw">as</span> <span class="dt">LONG</span>) <span class="kw">as</span> <span class="kw">id</span> <span class="kw">from</span> <span class="kw">source</span>;</span>
<span id="cb439-7"><a href="#cb439-7" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>These examples have made very little use of the database but of
course normal data is readily available, so shared fragments can make a
great way to provide access to complex data with shareable, correct
code. For instance, you could write a fragment that provides the ids of
all open businesses matching a name from a combination of tables. This
is similar to what you could do with a <code>VIEW</code> plus a
<code>WHERE</code> clause but:</p>
<ul>
<li>such a system can give you well controlled combinations known to
work well</li>
<li>there is no schema required, so your database load time can still be
fast</li>
<li>parameterization is not limited to filtering VIEWs after the
fact</li>
<li>“generic” patterns are available, allowing arbitrary data sources to
be filtered, validated, augmented</li>
<li>each fragment can be tested separately with its own suite rather
than only in the context of some larger thing</li>
<li>code generation can be more economical because the compiler is aware
of what is being shared</li>
</ul>
<p>In short, shared fragments can help with the composition of any
complicated kinds of queries. If you’re producing an SDK to access a
data set, they are indispensible.</p>
<h4 id="creating-and-using-valid-shared-fragments">Creating and Using
Valid Shared Fragments</h4>
<p>When creating a fragment the following rules are enforced:</p>
<ul>
<li>the fragment many not have any out arguments</li>
<li>it must consist of exactly one valid select statement (but see
future forms below)</li>
<li>it may use the LIKE construct in CTE definitions to create
placeholder shapes
<ul>
<li>this form is illegal outside of shared fragments (otherwise how
would you bind it)</li>
</ul></li>
<li>the LIKE form may only appear in top level CTE expressions in the
fragment</li>
<li>the fragment is free to use other fragments, but it may not call
itself
<ul>
<li>calling itself would result in infinite inlining</li>
</ul></li>
</ul>
<p>Usage of a fragment is always introduced by a “call” to the fragment
name in a CTE body. When using a fragment the following rules are
enforced.</p>
<ul>
<li>the provided parameters must create a valid procedure call just like
normal procedure calls
<ul>
<li>i.e. the correct number and type of arguments</li>
</ul></li>
<li>the provided parameters may not use nested <code>(SELECT ...)</code>
expressions
<ul>
<li>this could easily create fragment building within fragment building
which seems not worth the complexity</li>
<li>if database access is required in the parameters simply wrap it in a
helper procedure</li>
</ul></li>
<li>the optional USING clause must specify each required table parameter
exactly once and no other tables
<ul>
<li>a fragment that requires table parameters be invoked without a USING
clause</li>
</ul></li>
<li>every actual table provided must match the column names of the
corresponding table parameter
<ul>
<li>i.e. in <code>USING my_data AS values</code> the actual columns in
<code>my_data</code> must be the same as in the <code>values</code>
parameter</li>
<li>the columns need not be in the same order</li>
</ul></li>
<li>each column in any actual table must be “assignment compatible” with
its corresponding column in the parameters
<ul>
<li>i.e. the actual type could be converted to the formal type using the
same rules as the := operator</li>
<li>these are the same rules used for procedure calls, for instance,
where the call is kind of like assigning the actual parameter values to
the formal parameter variables</li>
</ul></li>
<li>the provided table values must not conflict with top level CTEs in
the shared fragment
<ul>
<li>exception: the top level CTEs that were parameters do not create
conflicts</li>
<li>e.g. it’s common to do
<code>values(*) as (CALL something() using source as source)</code> -
here the caller’s “source” takes the value of the fragment’s “source”,
which is not a true conflict</li>
<li>however, the caller’s source might itself have been a parameter in
which case the value provided could create an inner conflict
<ul>
<li>all these problems are easily avoided with a simple naming
convention for parameters so that real arguments never look like
parameter names and parameter forwarding is apparent</li>
<li>e.g. <code>USING _source AS _source</code> makes it clear that a
parameter is being forwarded and <code>_source</code> is not likely to
conflict with real table or view names</li>
</ul></li>
</ul></li>
</ul>
<p>Note that when shared fragments are used, the generated SQL has the
text split into parts, with each fragment and its surroundings
separated, therefore the text of shared fragments is shared(!) between
usages if normal linker optimizations for text folding are enabled
(common in production code.)</p>
<h3 id="shared-fragments-with-conditionals">Shared Fragments with
Conditionals</h3>
<p>Shared fragments use dynamic assembly of the text to do the sharing
but it is also possible to create alternative texts. There are many
instances where it is desirable to not just replace parameters but use,
for instance, an entirely different join sequence. Without shared
fragments, the only way to accomplish this is to fork the desired query
at the topmost level (because SQLite has no internal possibility of “IF”
conditions.) This is expensive in terms of code size and also cognitive
load because the entire alternative sequences have to be kept carefully
in sync. Macros can help with this but then you get the usual macro
maintenance problems, including poor diagnostics. And of course there is
no possibility to share the common parts of the text of the code if it
is forked.</p>
<p>However, conditional shared fragments allow forms like this:</p>
<div class="sourceCode" id="cb440"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a>PROC ids_from_string(val TEXT)</span>
<span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> val <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> val <span class="kw">IS</span> <span class="st">&#39;&#39;</span> <span class="cf">THEN</span></span>
<span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">id</span> <span class="kw">WHERE</span> <span class="dv">0</span>; <span class="co">-- empty result</span></span>
<span id="cb440-6"><a href="#cb440-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb440-7"><a href="#cb440-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span></span>
<span id="cb440-8"><a href="#cb440-8" aria-hidden="true" tabindex="-1"></a>      tokens(v) <span class="kw">as</span> (<span class="kw">CALL</span> split_text(val))</span>
<span id="cb440-9"><a href="#cb440-9" aria-hidden="true" tabindex="-1"></a>      ids(<span class="kw">id</span>) <span class="kw">as</span> (<span class="kw">CALL</span> ids_from_string_table() <span class="kw">USING</span> tokens <span class="kw">as</span> <span class="kw">source</span>)</span>
<span id="cb440-10"><a href="#cb440-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">from</span> ids;</span>
<span id="cb440-11"><a href="#cb440-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb440-12"><a href="#cb440-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<blockquote>
<p>NOTE: This appendix uses the more modern form <code>[[foo]]</code>
instead of the equivalent <code>@attribute(cql:foo)</code></p>
</blockquote>
<p>Now we can do something like:</p>
<div class="sourceCode" id="cb441"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a>  ids(<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> ids_from_string(str))</span></code></pre></div>
<p>In this case, if the string <code>val</code> is empty then SQLite
will not see the complex comma splitting code, and instead will see the
trivial case <code>select 0 id where 0</code>. The code in a conditional
fragment might be entirely different between the branches removing
unnecessary code, or swapping in a new experimental cache in your test
environment, or anything like that.</p>
<p>The generalization is simply this:</p>
<ul>
<li>instead of just one select statement there is one top level “IF”
statement</li>
<li>each statement list of the IF must be exactly one select
statement</li>
<li>there must be an ELSE clause</li>
<li>the select statements must be type compatible, just like in a normal
procedure</li>
<li>any table parameters with the same name in different branches must
have the same type
<ul>
<li>otherwise it would be impossible to provide a single actual table
for those table parameters</li>
</ul></li>
</ul>
<p>With this additional flexibility a wide variety of SQL statements can
be constructed economically and maintainability. Importantly, consumers
of the fragments need not deal with all these various alternate
possibilities but they can readily create their own useful combinations
out of building blocks.</p>
<p>Ultimately, from SQLite’s perspective, all of these shared fragment
forms result in nothing more complicated than a chain of CTE
expressions.</p>
<p>See Appendix 8 for an extensive section on best practices around
fragments and common table expressions in general.</p>
<blockquote>
<p>TIP: If you use CQL’s query planner on shared fragments with
conditionals, the query planner will only analyze the first branch by
default. You need to use <code>[[query_plan_branch={an_integer}]]</code>
to modify the behavior. Read <a
href="#chapter-15-query-plan-generation">Query Plan Generation</a> for
details.</p>
</blockquote>
<h3 id="shared-fragments-as-expressions">Shared Fragments as
Expressions</h3>
<p>The shared fragment system also has the ability to create re-usable
expression-style fragments giving you something like SQL inline
functions. These do come with some performance cost so they should be
used for larger fragments. In many systems a simple shared fragment
would not compete well with an equivalent <code>#define</code>.
Expression fragments shine when:</p>
<ul>
<li>the fragment is quite large</li>
<li>its used frequently (hence providing significant space savings)</li>
<li>the arguments are complex, potentially used many times in the
expression</li>
</ul>
<p>From a raw performance perspective, the best you can hope for with
any of the fragment approaches is a “tie” on speed compared do directly
inlining equivalent SQL or using a macro to do the same. However, from a
correctness and space perspective it is very possible to come out ahead.
It’s fair to say that expression fragments have the greatest overhead
compared to the other types and so they are best used in cases where the
size benefits are going to be important.</p>
<h4 id="syntax">Syntax</h4>
<p>An expression fragment is basically a normal shared fragment with no
top-level <code>FROM</code> clause that generates a single column. A
typical one might look like this:</p>
<div class="sourceCode" id="cb442"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this isn&#39;t very exciting because regular max would do the job</span></span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a>proc max_func(x <span class="dt">integer</span>, y <span class="dt">integer</span>)</span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="cf">case</span> <span class="cf">when</span> x <span class="op">&gt;=</span> y <span class="cf">then</span> x <span class="cf">else</span> y <span class="cf">end</span>;</span>
<span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above can be used in the context of a SQL statement like so:</p>
<div class="sourceCode" id="cb443"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> max_func(T1.column1, T1.column2) the_max <span class="kw">from</span> foo T1;</span></code></pre></div>
<h4 id="discussion">Discussion</h4>
<p>The consequence of the above is that the body of
<code>max_func</code> is inlined into the generated SQL. However, like
the other shared fragments, this is done in such a way that the text can
be shared between instances so you only pay for the cost of the text of
the SQL in your program one time, no matter how many time you use
it.</p>
<p>In particular, for the above, the compiler will generate the
following SQL:</p>
<div class="sourceCode" id="cb444"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> (</span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="cf">case</span> <span class="cf">when</span> x <span class="op">&gt;=</span> y <span class="cf">then</span> x <span class="cf">else</span> y <span class="cf">end</span></span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">from</span> (<span class="kw">select</span> T1.column1 x, column2 y))</span></code></pre></div>
<p>But each line will be its own string literal, so, more accurately, it
will concatenate the following three strings:</p>
<div class="sourceCode" id="cb445"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;select (&quot;</span><span class="op">,</span>                                      <span class="co">// string1</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot; select case when x &gt;= y then x else y end&quot;</span><span class="op">,</span>    <span class="co">// string2</span></span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot; from (select T1.column1 x, column2 y))&quot;</span>        <span class="co">// string3</span></span></code></pre></div>
<p>Importantly, <code>string2</code> is fixed for any given fragment.
The only thing that changes is <code>string3</code>, i.e., the
arguments. In any modern C compilation system, the linker will unify the
<code>string2</code> literal across all translation units so you only
pay for the cost of that text one time. It also means that the text of
the arguments appears exactly one time, no matter how complex they are.
For these benefits, we pay the cost of the select wrapper on the
arguments. If the arguments are complex that “cost” is negative.
Consider the following:</p>
<div class="sourceCode" id="cb446"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> max_func((<span class="kw">select</span> <span class="fu">max</span>(T.m) <span class="kw">from</span> T), (<span class="kw">select</span> <span class="fu">max</span>(U.m) <span class="kw">from</span> U))</span></code></pre></div>
<p>A direct expansion of the above would result in something like
this:</p>
<div class="sourceCode" id="cb447"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="cf">when</span> (<span class="kw">select</span> <span class="fu">max</span>(T.m) <span class="kw">from</span> T) <span class="op">&gt;=</span> (<span class="kw">select</span> <span class="fu">max</span>(U.m) <span class="kw">from</span> U)</span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a>   <span class="cf">then</span> (<span class="kw">select</span> <span class="fu">max</span>(T.m) <span class="kw">from</span> T)</span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a>   <span class="cf">else</span> (<span class="kw">select</span> <span class="fu">max</span>(U.m) <span class="kw">from</span> U)</span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above could be accomplished with a simple <code>#define</code>
style macro. However, the expression fragment generates the following
code:</p>
<div class="sourceCode" id="cb448"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> (</span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="cf">case</span> <span class="cf">when</span> x <span class="op">&gt;=</span> y <span class="cf">then</span> x <span class="cf">else</span> y <span class="cf">end</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">from</span> <span class="kw">select</span> (<span class="kw">select</span> <span class="fu">max</span>(T.m) <span class="kw">from</span> T) x, (<span class="kw">select</span> <span class="fu">max</span>(U.m) <span class="kw">from</span> U) y))</span></code></pre></div>
<p>Expression fragments can nest, so you could write:</p>
<div class="sourceCode" id="cb449"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>proc max3_func(x <span class="dt">integer</span>, y <span class="dt">integer</span>, z <span class="dt">integer</span>)</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> max_func(x, max_func(y, z));</span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Again, this particular example is a waste because regular
<code>max</code> would already do the job better.</p>
<p>To give another example, common mappings from one kind of code to
another using case/when can be written and shared this way:</p>
<div class="sourceCode" id="cb450"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this sort of thing happens all the time</span></span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>proc remap(x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">select</span> <span class="cf">case</span> x</span>
<span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a>     <span class="cf">when</span> <span class="dv">1</span> <span class="cf">then</span> <span class="dv">1001</span></span>
<span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a>     <span class="cf">when</span> <span class="dv">2</span> <span class="cf">then</span> <span class="dv">1057</span></span>
<span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a>     <span class="cf">when</span> <span class="dv">3</span> <span class="cf">then</span> <span class="dv">2010</span></span>
<span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a>     <span class="cf">when</span> <span class="dv">4</span> <span class="cf">then</span> <span class="dv">2011</span></span>
<span id="cb450-10"><a href="#cb450-10" aria-hidden="true" tabindex="-1"></a>     <span class="cf">else</span> <span class="dv">9999</span></span>
<span id="cb450-11"><a href="#cb450-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">end</span>;</span>
<span id="cb450-12"><a href="#cb450-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In the following:</p>
<div class="sourceCode" id="cb451"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> remap(T1.c), remap(T2.d), remap(T3.e) <span class="kw">from</span> T1, T2, T3<span class="op">..</span>. etc.</span></code></pre></div>
<p>The text for <code>remap</code> will appear three times in the
generated SQL query but only one time in your binary.</p>
<h4 id="restrictions">Restrictions</h4>
<ul>
<li>the fragment must consist of exactly one simple select statement
<ul>
<li>no <code>FROM</code>, <code>WHERE</code>, <code>HAVING</code>, etc.
– the result is an expression</li>
</ul></li>
<li>the select list must have exactly one value
<ul>
<li>Note the expression can be a nested <code>SELECT</code> which could
then have all the usual <code>SELECT</code> elements</li>
</ul></li>
<li>the usual shared fragment rules apply, e.g. no out-parameters,
exactly one statement, etc.</li>
</ul>
<h4 id="additional-notes">Additional Notes</h4>
<p>A simpler syntax might have been possible but expression fragments
are only interesting in SQL contexts where (among other things) normal
procedure and function calls are not available. So the
<code>select</code> keyword makes it clear to the coder and the compiler
that the expression will be evaluated by SQLite and the rules for what
is allowed to go in the expression are the SQLite rules.</p>
<p>The fragment has no <code>FROM</code> clause because we’re trying to
produce an expression, not a table-value with one column. If you want a
table-value with one column, the original shared fragments solution
already do exactly that. Expression fragments give you a solution for
sharing code in, say, the <code>WHERE</code> clause of a larger select
statement.</p>
<p>Commpared to something like</p>
<div class="sourceCode" id="cb452"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a>#define max_func(x,y) <span class="cf">case</span> <span class="cf">when</span> (x) <span class="op">&gt;=</span> (y) <span class="cf">then</span> x <span class="cf">else</span> y <span class="cf">end</span>;</span></code></pre></div>
<p>The macro does give you a ton of flexibility, but it has many
problems: * if the macro has an error, you see the error in the call
site with really bad diagnostic info * the compiler doesn’t know that
the sharing is going on so it won’t be able to share text between call
sites * the arguments can be evaluated many times each which could be
expensive, bloaty, or wrong * there is no type-checking of arguments to
the macro so you may or may not get compilation errors after expansion *
you have to deal with all the usual pre-processor hazards</p>
<p>In general, macros <em>can</em> be used (as in C and C++) as an
alternative to expression fragments, especially for small fragments.
But, this gets to be a worse idea as such macros grow. For larger cases,
C and C++ provide inline functions – CQL provides expression
fragments.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-15-query-plan-generation">Chapter 15: Query Plan
Generation</h2>
<p>CQL offers a way to run SQLite’s <a
href="https://www.sqlite.org/eqp.html"><code>EXPLAIN QUERY PLAN</code>
command</a> for all the SQL statements used in a CQL file using a set of
special compilation steps.</p>
<p>Generating query plans is inherently complicated. Any given stored
procedure might include many SQL statements, each of which has a plan.
To get the plans, those statements must be executed in the appropriate
mode. In order for them to execute, whatever tables, views, and
user-defined functions they use must exist. The statements can have any
number of parameters, those have to be swapped out because they might
come from anywhere. When run in <code>--rt query_plan</code> mode, the
compiler accomplishes all of this by analyzing the original code and
creating entirely new code. Running this new code creates the schema
and, with the appropriate transforms, runs all the SQL statements in the
original to give us the query plans. The process requires many steps as
we’ll see below.</p>
<h3 id="query-plan-generation-compilation-steps">Query Plan Generation
Compilation Steps</h3>
<blockquote>
<p>TIP: The following steps are used in
<code>./repl/go_query_plan.sh</code>, you can <a
href="../../docs/playground#query-plan-playground">run it to get a quick
demonstration of this feature in action</a>. The rest of the section
explains how query plan generation works and some of its quirks.</p>
</blockquote>
<p>To execute query plans for a given CQL file, the following commands
need to be run:</p>
<div class="sourceCode" id="cb453"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="va">CQL_FILE</span><span class="op">=</span> <span class="co"># The CQL file to compile</span></span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a><span class="va">CQL_ROOT_DIR</span><span class="op">=</span> <span class="co"># Path to cql directory</span></span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a><span class="va">CQL</span><span class="op">=</span><span class="va">$CQL_ROOT_DIR</span>/out/cql</span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Query Plan Script</span></span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a><span class="va">$CQL</span> <span class="at">--in</span> <span class="va">$CQL_FILE</span> <span class="at">--rt</span> query_plan <span class="at">--cg</span> go-qp.sql</span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile and link CQL artifacts, with a main C file query_plan_test.c</span></span>
<span id="cb453-9"><a href="#cb453-9" aria-hidden="true" tabindex="-1"></a><span class="va">$CQL</span> <span class="at">--in</span> go-qp.sql <span class="at">--cg</span> go-qp.h go-qp.c <span class="at">--dev</span></span>
<span id="cb453-10"><a href="#cb453-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cc</span> <span class="at">-I</span><span class="va">$CQL_ROOT_DIR</span> <span class="at">-I.</span> <span class="at">-c</span> <span class="va">$CQL_ROOT_DIR</span>/query_plan_test.c go-qp.c</span>
<span id="cb453-11"><a href="#cb453-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cc</span> <span class="at">-I</span><span class="va">$CQL_ROOT_DIR</span> <span class="at">-I.</span> <span class="at">-O</span> <span class="at">-o</span> go_query_plan go-qp.o query_plan_test.o <span class="va">$CQL_ROOT_DIR</span>/cqlrt.c <span class="at">-lsqlite3</span></span>
<span id="cb453-12"><a href="#cb453-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-13"><a href="#cb453-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Run and generate query plans</span></span>
<span id="cb453-14"><a href="#cb453-14" aria-hidden="true" tabindex="-1"></a><span class="ex">./go_query_plan</span></span></code></pre></div>
<p>In order to flexibily create query plans, CQL uses
<code>--rt query_plan</code> to generate a second CQL script that
returns query plans for each SQL statement used in a given file.</p>
<p>The CQL repository provides the file <a
href="../../sources/query_plan_test.c"><code>query_plan_test.c</code></a>
that can be used as the “main” function, otherwise you can make your
own.</p>
<blockquote>
<p>NOTE: When compiling the CQL file generated by
<code>--rt query_plan</code>, the <code>--dev</code> flag is
required.</p>
</blockquote>
<h3
id="special-handling-of-cql-features-in-query-plan-generation">Special
Handling of CQL features in Query Plan Generation</h3>
<p>CQL’s query planner generator modifies the usage of the following
features to allow SQLite run <code>EXPLAIN QUERY PLAN</code>
successfully:</p>
<ul>
<li>Variables</li>
<li>User Defined Functions</li>
<li>Conditionals in Shared Fragments</li>
<li><a href="https://sqlite.org/vtab.html">Virtual Tables</a></li>
<li><a href="https://sqlite.org/vtab.html#tabfunc2">Table-Valued
Funcxtions</a></li>
</ul>
<blockquote>
<p>CAUTION: Generating query plans for CQL files that use table valued
functions, or virtual tables results in the creation of similarly named
“normal” tables which will be using in the query instead of the virtual
table or table -valued function. This means that the query plan output
won’t be quite right, especially if these items had complex interiors
with nested SQLite queries, but it also means the code that generates
the query plans does not need to have all of your native bindings for
the relevant modules and functions which make it possible to actually
run the queries out of context in a standalone build.</p>
</blockquote>
<h4 id="variables">Variables</h4>
<p>Variables used in SQL statements are stubbed into constants. The
exact value varies depending on the type of the variable, but it is
always equivalent to some form of <code>"1"</code>.</p>
<div class="sourceCode" id="cb454"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb454-3"><a href="#cb454-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_table</span>
<span id="cb454-4"><a href="#cb454-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> x;</span>
<span id="cb454-5"><a href="#cb454-5" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code></pre></div>
<div class="sourceCode" id="cb455"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_table</span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> my_table.<span class="kw">id</span> <span class="op">=</span> nullable(<span class="dv">1</span>);</span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code></pre></div>
<h4 id="user-defined-functions-1">User Defined Functions</h4>
<p><em>Read <a href="#chapter-8-functions">Functions</a> on details
about Function Types.</em></p>
<p>Since the implementation of UDFs in a CQL file do not affect SQLite
query plans, CQL’s query plan script automatically creates no-op stubs
to be used instead.</p>
<h4 id="conditionals-in-shared-fragments">Conditionals in Shared
Fragments</h4>
<p><em>Read <a href="#chapter-14-cql-shared-fragments">CQL Query
Fragments</a> on details about shared fragments</em></p>
<p>Only one branch of a conditional is chosen for query plan analysis.
By default this will be the first branch, which is the initial
<code>SELECT</code> statement following the <code>IF</code> conditional.
The branch to analyze can be configured with the
<code>cql:query_plan_branch</code> <a
href="#appendix-3-control-directives"><span class="citation"
data-cites="attribute">@attribute</span></a></p>
<p>Here’s an example of <code>cql:query_plan_branch</code> being
used:</p>
<div class="sourceCode" id="cb456"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a>[[query_plan_branch<span class="op">=</span><span class="dv">1</span>]]</span>
<span id="cb456-3"><a href="#cb456-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC frag2(y <span class="dt">int</span>)</span>
<span id="cb456-4"><a href="#cb456-4" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb456-5"><a href="#cb456-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span> y <span class="op">==</span> <span class="dv">2</span> <span class="cf">THEN</span></span>
<span id="cb456-6"><a href="#cb456-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">10</span> b;</span>
<span id="cb456-7"><a href="#cb456-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span> <span class="cf">IF</span> y <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb456-8"><a href="#cb456-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">20</span> b;</span>
<span id="cb456-9"><a href="#cb456-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span></span>
<span id="cb456-10"><a href="#cb456-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">30</span> b;</span>
<span id="cb456-11"><a href="#cb456-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb456-12"><a href="#cb456-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<div class="sourceCode" id="cb457"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">20</span> b;</span></code></pre></div>
<p>Setting <code>cql:query_plan_branch=1</code> selects the second
branch. Providing <code>cql:query_plan_branch=2</code> instead would
yield the <code>ELSE</code> clause <code>SELECT 30 b</code>.
<code>cql:query_plan_branch=0</code> would yield
<code>SELECT 10 b</code>, which is the same as the default
behaviour.</p>
<!---
-- Copyright (c) sample Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-16-advanced-blob-features">Chapter 16: Advanced Blob
Features</h2>
<p>There are two large features that involve complex uses of blobs that
are supported in the default runtime. These are Blob Storage and Backed
Tables, the latter of which uses key and value blobs for generic
schema.</p>
<h3 id="blob-storage">Blob Storage</h3>
<p>The general idea here is that you might want to take arbitrary data
that is in a cursor, which is to say any database shape at all, and
convert it into a single blob. You could use this blob to store
composite data in a single column in the database or to send your data
over some kind of wire transport in a generic fashion. The idea of blob
storage is to provide a reslient way to do this that is platform neutral
(i.e. you can store the blob on one system and recover it on another
system with different endian order). Blob storage allows limited
extension of the blob shape over time, allowing you to add new nullable
columns at the end of your shape and still recover your data from older
blobs.</p>
<h4 id="defining-a-shape-for-blob-storage">Defining a shape for Blob
Storage</h4>
<p>In SQL/CQL, the main way you define structures, especially those that
you want to maintain, is with tables. Hence we introduce notation like
this:</p>
<div class="sourceCode" id="cb458"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:blob_storage)</span></span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> news_info(</span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a>  who text,</span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a>  what text,</span>
<span id="cb458-5"><a href="#cb458-5" aria-hidden="true" tabindex="-1"></a>  when_ <span class="dt">long</span> <span class="co">-- timestamp of some kind</span></span>
<span id="cb458-6"><a href="#cb458-6" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>blob_storage attribute</code> indicates that the table
we’re about to define here is not really going to be a materialized
table. As a result, you will not be able to (e.g.) <code>DROP</code> the
table or <code>SELECT</code> from it, and there will be no schema
upgrade for it should you request one. However, the usual schema
maintenance rules still apply (See <a
href="#chapter-10-schema-management-features">Chapter 10</a> and <a
href="#chapter-11-previous-schema-validation">Chapter 11</a>) which help
you to create compatible versions of this structure. For instance, new
columns can be added only at the end, and only if they are nullable.
Here we add <code>source</code> to the schema in a hypothetical “version
6”.</p>
<div class="sourceCode" id="cb459"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:blob_storage)</span></span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> news_info(</span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>  who text,</span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>  what text,</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>  when_ <span class="dt">long</span> <span class="co">-- timestamp of some kind</span></span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">source</span> text @create(<span class="dv">6</span>)</span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<blockquote>
<p>Note: schema versions move forward globally in the schema, not
locally in one table; this implies there are versions 1-5 elsewhere, not
shown.</p>
</blockquote>
<p>Additionally, since the storage is not backed by SQLite and therefore
lacks its constraint system, default values and constraints are not
allowed in a table marked with <code>cql:blob_storage</code>; it’s just
data. Similarly, triggers, views, and indices may not use the table
marked as blob storage. It isn’t really a table.</p>
<h4 id="declaring-blob-storage">Declaring Blob Storage</h4>
<p>Blob storage goes in a blob field, but recall CQL has discriminated
types so we can use a form like this:</p>
<div class="sourceCode" id="cb460"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> info(</span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">long</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>  news_info <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span></span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>From a SQL perspective <code>news_info</code> is just a blob, you can
only apply blob operations to it in the context of a query. This means
<code>WHERE</code> clauses that partially constraint the blob contents
are not generally possible (though you could do it if you write suitable
UDFs and <a href="#backed-tables">Backed Tables</a> actually generalize
this if generic schema support is what is desired). Blob storage is
really about moving the whole blob around so it’s apprpropriate when you
want to crack the blob in code, and not so much in database
operations.</p>
<h4 id="creating-blobs-with-blob-storage">Creating Blobs with Blob
Storage</h4>
<p>You can use the <code>SET</code> statement on a variable of type
<code>blob&lt;news_info&gt;</code> starting from any cursor that has
shape <code>news_info</code> like so:</p>
<div class="sourceCode" id="cb461"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc make_blob(<span class="kw">like</span> news_info, <span class="kw">out</span> result <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span>)</span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- declare the cursor</span></span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="kw">like</span> news_info;</span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- load it from loose arguments</span></span>
<span id="cb461-6"><a href="#cb461-6" aria-hidden="true" tabindex="-1"></a>  fetch c <span class="kw">from</span> arguments;</span>
<span id="cb461-7"><a href="#cb461-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- set the blob variable</span></span>
<span id="cb461-8"><a href="#cb461-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> result <span class="kw">from</span> <span class="kw">cursor</span> c;</span>
<span id="cb461-9"><a href="#cb461-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>This declares a cursor, loads it from argument values, and converts
it to a blob.<br />
Of course any of the usual cursor building forms can be used to power
your blob creation, you just do one serialization at the end. The above
is assembling a blob from arguments but you could equally make the blob
from data.</p>
<div class="sourceCode" id="cb462"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc get_news_info(id_ <span class="dt">long</span> <span class="kw">not</span> <span class="kw">null</span>, <span class="kw">out</span> result <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span>)</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- use our columns sugar syntax for getting just news_info columns from</span></span>
<span id="cb462-4"><a href="#cb462-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- a table with potentially lots of stuff (or an error if it&#39;s missing columns)</span></span>
<span id="cb462-5"><a href="#cb462-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span></span>
<span id="cb462-6"><a href="#cb462-6" aria-hidden="true" tabindex="-1"></a>     <span class="kw">select</span> <span class="kw">columns</span>(<span class="kw">like</span> news_info) <span class="kw">from</span> some_source_of_info <span class="kw">where</span> info.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb462-7"><a href="#cb462-7" aria-hidden="true" tabindex="-1"></a>   fetch c;</span>
<span id="cb462-8"><a href="#cb462-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> result <span class="kw">from</span> <span class="kw">cursor</span> c;</span>
<span id="cb462-9"><a href="#cb462-9" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>There are <em>many</em> cursor fetch forms, including dummy data
forms and other interesting bits of sugar.<br />
You can fetch a cursor from arguments, from other cursors, and even
combinations. Because cursors are the source of new blobs, any of these
data acquistion forms are viable and convenient sources of data.</p>
<h4 id="unpacking-blob-storage">Unpacking Blob Storage</h4>
<p>Again, the normal way that you work with records in CQL is by
creating suitable cursors. Such cursors can be economically accessed on
a field-by-field basis. What we need is a way to easily recreate a
cursor from a blob so we can read the data values. To do this use this
form:</p>
<div class="sourceCode" id="cb463"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- get the blob from somewhere (b will be of type blob&lt;news_info&gt;)</span></span>
<span id="cb463-2"><a href="#cb463-2" aria-hidden="true" tabindex="-1"></a>let b <span class="op">:=</span> (<span class="kw">select</span> news_info <span class="kw">from</span> info <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> id_ <span class="cf">if</span> <span class="kw">nothing</span> <span class="kw">null</span>);</span>
<span id="cb463-3"><a href="#cb463-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-4"><a href="#cb463-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- create a suitable cursor with the same shape</span></span>
<span id="cb463-5"><a href="#cb463-5" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> c <span class="kw">cursor</span> <span class="kw">like</span> b;</span>
<span id="cb463-6"><a href="#cb463-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb463-7"><a href="#cb463-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- load the cursor (note that this can throw an exception if the blob is corrupt)</span></span>
<span id="cb463-8"><a href="#cb463-8" aria-hidden="true" tabindex="-1"></a>fetch c <span class="kw">from</span> b;</span>
<span id="cb463-9"><a href="#cb463-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- now use c.who, c.what, etc.</span></span></code></pre></div>
<p>On the data is loaded in a cursor is very economical to access on a
field-by-field basis, and, since the deserialization of the blob
happened all at once, that is also economical. &gt;NOTE: The runtime
cannot assume that the blob is well formed, it could be coming from
anywhere. For secure-code reasons it must assume the is “hostile”. Hence
the decoding validates the shape, internal lengths, and so forth.
Therefore there are many ways it might fail.</p>
<p>Once you have the cursor you can do any of the usual data operations;
you could even make new blobs with different combinations by slicing the
cursor fields using the <code>LIKE</code> operator. You can return the
cursor with <code>OUT</code>, or <code>OUT UNION</code>, or pass the
blob fields as arguments to functions using the <code>FROM</code> forms.
The cracked blob is fully usable for all the usual CQL things you might
need to do.</p>
<h4 id="blob-storage-representation">Blob Storage Representation</h4>
<p>The blob data must be able to evolve over time, so each blob has to
be self-describing. We must also be able to throw an exception if an
incorrect or invalid blob is used when loading a cursor, so the blob has
to contain the following:</p>
<ul>
<li>the number of columns in the blob data type when it was created</li>
<li>the type of each field (this is encoded as a single plain-text
character)
<ul>
<li>the types are bool, int, long, (double) real, (string) text,
blob;</li>
<li>we use ‘f’ (flag) for bools, hence the codes are “fildsb”</li>
<li>these are encoded with one letter each, upper case meaning ‘not
null’ so the storage might be “LFss”</li>
<li>the blob begins with a null terminated string that serves for both
the count and the types</li>
</ul></li>
<li>Each nullable field may be present or null; 1 bit is used to store
this fact. The bits are in an array of bytes that comes immediately
after the type info (the type info implicitly tells us the size of this
array)</li>
<li>Boolean values are likewise encoded as bits within the same array,
so the total number of bits stored is nullables plus booleans (nullable
booleans use 2 bits)</li>
<li>When reading a newer version of a record from an older piece of data
that is missing a column then the column is assumed to be NULL</li>
<li>Any columns added after the initial version (using <span
class="citation" data-cites="create">@create</span>) must be nullable;
this is normal for adding columns to existing schema</li>
<li>Integers and longs are stored in a <a
href="https://en.wikipedia.org/wiki/Variable-length_quantity"><code>varint</code>/<code>VLQ</code></a>
format after <code>zigzag</code> encoding (same article)</li>
<li>Text is stored inline in null terminated strings (embedded nulls are
not allowed in CQL text)</li>
<li>Nested blobs are stored inline, with a length prefix encoded like
any other int</li>
<li>Floating point is stored in IEEE 754 format which is already highly
portable</li>
</ul>
<h4 id="blob-storage-customization">Blob Storage Customization</h4>
<p>As with many other features, it’s possible to replace the
(de)serialization with code of your choice by supplying your own runtime
methods.</p>
<p>Storage types that are going to be persisted in the database or go
over a wire-protocol should be managed like schema with the usual
validation rules. On the other hand, formats that will be used only
transiently in memory can be changed at whim from version to version. As
mentioned above, the design specifically considers cases where a new
client discovers an old-format blob (with fewer columns) and, the
reverse, cases where an old client recieves a datagram from a new client
with too many columns. Any customizations should consider these same
cases.</p>
<h4 id="blob-storage-example">Blob Storage Example</h4>
<p>The code samples below illustrate some of the more common blob
operations that are likely to come up.</p>
<div class="sourceCode" id="cb464"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:blob_storage)</span></span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> news_info(</span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a>  who text,</span>
<span id="cb464-4"><a href="#cb464-4" aria-hidden="true" tabindex="-1"></a>  what text,</span>
<span id="cb464-5"><a href="#cb464-5" aria-hidden="true" tabindex="-1"></a>  when_ <span class="dt">long</span> <span class="co">-- timestamp of some kind</span></span>
<span id="cb464-6"><a href="#cb464-6" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb464-7"><a href="#cb464-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-8"><a href="#cb464-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- a place where the blob appears in storage</span></span>
<span id="cb464-9"><a href="#cb464-9" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> some_table(</span>
<span id="cb464-10"><a href="#cb464-10" aria-hidden="true" tabindex="-1"></a>  x <span class="dt">integer</span>,</span>
<span id="cb464-11"><a href="#cb464-11" aria-hidden="true" tabindex="-1"></a>  y <span class="dt">integer</span>,</span>
<span id="cb464-12"><a href="#cb464-12" aria-hidden="true" tabindex="-1"></a>  news_blob <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span></span>
<span id="cb464-13"><a href="#cb464-13" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb464-14"><a href="#cb464-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-15"><a href="#cb464-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- a procedure that creates a news_info blob from loose args</span></span>
<span id="cb464-16"><a href="#cb464-16" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc make_blob(<span class="kw">like</span> news_info, <span class="kw">out</span> result <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span>)</span>
<span id="cb464-17"><a href="#cb464-17" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb464-18"><a href="#cb464-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="kw">like</span> news_info;</span>
<span id="cb464-19"><a href="#cb464-19" aria-hidden="true" tabindex="-1"></a>  fetch c <span class="kw">from</span> arguments;</span>
<span id="cb464-20"><a href="#cb464-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> result <span class="kw">from</span> <span class="kw">cursor</span> c;</span>
<span id="cb464-21"><a href="#cb464-21" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb464-22"><a href="#cb464-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-23"><a href="#cb464-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- a procedure that cracks the blob, creating a cursor</span></span>
<span id="cb464-24"><a href="#cb464-24" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc crack_blob(<span class="kw">data</span> <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span>)</span>
<span id="cb464-25"><a href="#cb464-25" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb464-26"><a href="#cb464-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="kw">like</span> news_info;</span>
<span id="cb464-27"><a href="#cb464-27" aria-hidden="true" tabindex="-1"></a>  fetch c <span class="kw">from</span> <span class="kw">data</span>;</span>
<span id="cb464-28"><a href="#cb464-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> c;</span>
<span id="cb464-29"><a href="#cb464-29" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb464-30"><a href="#cb464-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-31"><a href="#cb464-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- A procedure that cracks the blob into loose args if needed</span></span>
<span id="cb464-32"><a href="#cb464-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- the OUT statement was created specifically to allow you to</span></span>
<span id="cb464-33"><a href="#cb464-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- avoid this sort mass OUT awfulness consider that the blob</span></span>
<span id="cb464-34"><a href="#cb464-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- might have dozens of columns, this quickly gets unweildy.</span></span>
<span id="cb464-35"><a href="#cb464-35" aria-hidden="true" tabindex="-1"></a><span class="co">-- But, as an illustration, here is explicit extraction.</span></span>
<span id="cb464-36"><a href="#cb464-36" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc crack_blob_to_vars(</span>
<span id="cb464-37"><a href="#cb464-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">data</span> <span class="dt">blob</span><span class="op">&lt;</span>news_info<span class="op">&gt;</span>,</span>
<span id="cb464-38"><a href="#cb464-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> who text,</span>
<span id="cb464-39"><a href="#cb464-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> what text,</span>
<span id="cb464-40"><a href="#cb464-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">out</span> when_ <span class="dt">long</span>)</span>
<span id="cb464-41"><a href="#cb464-41" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb464-42"><a href="#cb464-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="kw">like</span> news_info;</span>
<span id="cb464-43"><a href="#cb464-43" aria-hidden="true" tabindex="-1"></a>  fetch c <span class="kw">from</span> <span class="kw">data</span>;</span>
<span id="cb464-44"><a href="#cb464-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> who <span class="op">:=</span> c.who;</span>
<span id="cb464-45"><a href="#cb464-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> what <span class="op">:=</span> c.what;</span>
<span id="cb464-46"><a href="#cb464-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> when_ <span class="op">:=</span> c.when_;</span>
<span id="cb464-47"><a href="#cb464-47" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb464-48"><a href="#cb464-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-49"><a href="#cb464-49" aria-hidden="true" tabindex="-1"></a><span class="co">-- we&#39;re going to have a result with x/y columns in it</span></span>
<span id="cb464-50"><a href="#cb464-50" aria-hidden="true" tabindex="-1"></a><span class="co">-- this shape lets us select those out easily using LIKE</span></span>
<span id="cb464-51"><a href="#cb464-51" aria-hidden="true" tabindex="-1"></a>interface my_basic_columns (</span>
<span id="cb464-52"><a href="#cb464-52" aria-hidden="true" tabindex="-1"></a>  x <span class="dt">int</span>,</span>
<span id="cb464-53"><a href="#cb464-53" aria-hidden="true" tabindex="-1"></a>  y <span class="dt">int</span></span>
<span id="cb464-54"><a href="#cb464-54" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb464-55"><a href="#cb464-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-56"><a href="#cb464-56" aria-hidden="true" tabindex="-1"></a><span class="co">-- this defines a shape for the result we want</span></span>
<span id="cb464-57"><a href="#cb464-57" aria-hidden="true" tabindex="-1"></a><span class="co">-- we&#39;re never actually defining this procedure</span></span>
<span id="cb464-58"><a href="#cb464-58" aria-hidden="true" tabindex="-1"></a>interface my_result_shape (</span>
<span id="cb464-59"><a href="#cb464-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">like</span> my_basic_columns,</span>
<span id="cb464-60"><a href="#cb464-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">like</span> news_info</span>
<span id="cb464-61"><a href="#cb464-61" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb464-62"><a href="#cb464-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-63"><a href="#cb464-63" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc select_and_crack(whatever bool <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb464-64"><a href="#cb464-64" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb464-65"><a href="#cb464-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> some_table <span class="kw">where</span> whatever;</span>
<span id="cb464-66"><a href="#cb464-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">loop</span> fetch c</span>
<span id="cb464-67"><a href="#cb464-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">begin</span></span>
<span id="cb464-68"><a href="#cb464-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- crack the blob in c into a new cursor &#39;news&#39;</span></span>
<span id="cb464-69"><a href="#cb464-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">declare</span> news <span class="kw">cursor</span> <span class="kw">like</span> news_info;</span>
<span id="cb464-70"><a href="#cb464-70" aria-hidden="true" tabindex="-1"></a>    fetch news <span class="kw">from</span> <span class="dt">blob</span> c.news_blob;</span>
<span id="cb464-71"><a href="#cb464-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-72"><a href="#cb464-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- assemble the result we want from the parts we have</span></span>
<span id="cb464-73"><a href="#cb464-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">declare</span> result <span class="kw">cursor</span> <span class="kw">like</span> my_result_shape;</span>
<span id="cb464-74"><a href="#cb464-74" aria-hidden="true" tabindex="-1"></a>    fetch result <span class="kw">from</span> <span class="kw">values</span> (<span class="kw">from</span> c <span class="kw">like</span> my_basic_columns, <span class="kw">from</span> news);</span>
<span id="cb464-75"><a href="#cb464-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-76"><a href="#cb464-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- emit one row, some came from the original data some cracked</span></span>
<span id="cb464-77"><a href="#cb464-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- callers will never know that some data was encoded in a blob</span></span>
<span id="cb464-78"><a href="#cb464-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">out</span> <span class="kw">union</span> result;</span>
<span id="cb464-79"><a href="#cb464-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span>;</span>
<span id="cb464-80"><a href="#cb464-80" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<h3 id="backed-tables">Backed Tables</h3>
<p>Most production databases include some tables that are fairly
generic, they use maybe a simple key-value combination to store some
simple settings or something like that. In the course of feature
development this kind of thing comes up pretty often and in large client
applications there are many small features that need a little bit of
state.</p>
<p>It’s easy enough to model whatever state you need with a table or two
but this soon results in an explosion of tiny tables. In some cases
there are only a few rows of configuration data and indeed the situation
can be so bad that the text of the schema for the little state table is
larger than the sum of all the data you will ever store there. This
situation is a bit tragic because SQLite has initialization cost
associated with each table. So these “baby tables” are really not paying
for themselves at all.</p>
<p>What we’d like to do is use some kind of generic table as the backing
store for many of these small tables while preserving type safety. The
cost of access might be a bit higher but since data volumes are expected
to be low anyway this would be a good trade-off. And we can have as many
as we like. In some cases the state doesn’t even need to be persisted,
so we’re talking about tables in an in-memory database. Here low cost of
initialization is especially important. And lastly, if your project has
dozens or even hundreds of small features like this, the likelihood that
all of them are even used in any one session is quite low and so again,
having a low fixed cost for the schema is a good thing. No need to
create a few hundred in-memory tables on the off chance that they are
needed.</p>
<h4 id="defining-backed-tables">Defining Backed Tables</h4>
<p>First you need a place to store the data. We using “backing” tables
to store the data for “backed” tables. And we define a backing table in
the usual way. A simple backing table is just a key/value store and
looks like this:</p>
<div class="sourceCode" id="cb465"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@ATTRIBUTE(cql:backing_table)</span></span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> backing(</span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a>  k <span class="dt">BLOB</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb465-4"><a href="#cb465-4" aria-hidden="true" tabindex="-1"></a>  v <span class="dt">BLOB</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb465-5"><a href="#cb465-5" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>backing_table</code> attribute indicates that the table
we’re about to define is to be used for backing storage.<br />
At present it is signficantly restricted. It has to have exactly two
columns, both of which are blobs, one is the key and one is the value.
It should be either “baseline” schema (no <span class="citation"
data-cites="create">@create</span> annotation) or annotated with
<code>@create</code> as it is expected to be precious data.
<code>@recreate</code> is an error. If it’s an in-memory table then
versioning is somewhat moot but really the backing store schema is not
supposed to change over time, that’s the point.</p>
<p>In future versions we expect to allow some number of additional
physical columns which can be used by the backed tables (discussed
below) but for now only the simple key/value pattern is allowed. The
columns can have any names but as they will be frequently used short
names like “k” and “v” are recommended.</p>
<p>Backed tables look like this:</p>
<div class="sourceCode" id="cb466"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@ATTRIBUTE(cql:backed_by=backing)</span></span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> backed(</span>
<span id="cb466-3"><a href="#cb466-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb466-4"><a href="#cb466-4" aria-hidden="true" tabindex="-1"></a>  name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb466-5"><a href="#cb466-5" aria-hidden="true" tabindex="-1"></a>  bias <span class="dt">REAL</span></span>
<span id="cb466-6"><a href="#cb466-6" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb466-7"><a href="#cb466-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-8"><a href="#cb466-8" aria-hidden="true" tabindex="-1"></a><span class="ot">@ATTRIBUTE(cql:backed_by=backing)</span></span>
<span id="cb466-9"><a href="#cb466-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> backed2(</span>
<span id="cb466-10"><a href="#cb466-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb466-11"><a href="#cb466-11" aria-hidden="true" tabindex="-1"></a>  name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb466-12"><a href="#cb466-12" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>backed_by</code> attribute indicates that the table we’re
about to define is not really going to be its own table.<br />
As a result, you will not be able to (e.g.) <code>DROP</code> the table
or <code>CREATE INDEX</code> or <code>CREATE TRIGGER</code> on it, and
there will be no schema upgrade for it should you request one with
<code>--rt schema_upgrade</code>. The table may not contain constraints
as there would be no way to enforce them, but they may have default
values. As compensation for these restrictions, backed tables can be
changed freely and have no associated physical schema cost. &gt;NOTE:
Adding new not null columns creatives effectively a new backed table,
any previous data will seem “lost”. See below.</p>
<h4 id="reading-data-from-backed-tables">Reading Data From Backed
Tables</h4>
<p>To understand how reading works, imagine that we had a VIEW for each
backed table which simply reads the blobs out of the backing store and
then extracts the backed columns using some blob extraction functions.
This would work, but then we’d be trading view schema for table schema
so the schema savings we’re trying to achieve would be lost.</p>
<p>We can’t use an actual VIEW but CQL already has something very “view
like” – the shared fragment structure. So what we do instead of views is
to automatically create a shared fragment just like the view we could
have made. The shared fragment looks like this:</p>
<div class="sourceCode" id="cb467"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@ATTRIBUTE(cql:shared_fragment)</span></span>
<span id="cb467-2"><a href="#cb467-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC _backed ()</span>
<span id="cb467-3"><a href="#cb467-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb467-4"><a href="#cb467-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb467-5"><a href="#cb467-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">rowid</span>,</span>
<span id="cb467-6"><a href="#cb467-6" aria-hidden="true" tabindex="-1"></a>   cql_blob_get(T.k, backed.<span class="kw">id</span>) <span class="kw">AS</span> <span class="kw">id</span>,</span>
<span id="cb467-7"><a href="#cb467-7" aria-hidden="true" tabindex="-1"></a>   cql_blob_get(T.v, backed.name) <span class="kw">AS</span> name,</span>
<span id="cb467-8"><a href="#cb467-8" aria-hidden="true" tabindex="-1"></a>   cql_blob_get(T.v, backed.bias) <span class="kw">AS</span> bias</span>
<span id="cb467-9"><a href="#cb467-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backing <span class="kw">AS</span> T</span>
<span id="cb467-10"><a href="#cb467-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> cql_blob_get_type(T.k) <span class="op">=</span> 2105552408096159860L;</span>
<span id="cb467-11"><a href="#cb467-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>Two things to note:</p>
<p>First, this fragment has the right shape, but the shared fragment
doesn’t directly call blob extraction UDFs. Rather it uses indirect
functions like <code>cql_blob_get</code>. The point of these helpers is
to make the actual blob functions configurable. The default runtime
includes an implementation of extration functions with the default
names, but you can create whatever blob format you want. You could even
use <a href="#blob-storage">blob storage</a> as your backing store
(though it isn’t well suited for field-at-a-time extraction). You can
even have different encodings in different backed tables.</p>
<p>Second, there is a type code embedded in the procedure. The type code
is a hash of the <em>type name</em> and the <em>names</em> and
<em>types</em> of all the <em>not-null</em> fields in the backed table.
The hash is arbitrary but repeatable, any system can compute the same
hash and find the records they want without having to share headers. The
actual hash function is included in the open source but it’s just a
SHA256 reduced to 64 bits with some name canonicalization. The <a
href="#chapter-13-json-output">JSON output</a> also includes the
relevant hashes so you can easily consume them without even having to
know the hash function.</p>
<p>As a second example, the expanded code for <code>backed2</code> is
shown below:</p>
<div class="sourceCode" id="cb468"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@ATTRIBUTE(cql:shared_fragment)</span></span>
<span id="cb468-2"><a href="#cb468-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC _backed2 ()</span>
<span id="cb468-3"><a href="#cb468-3" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb468-4"><a href="#cb468-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb468-5"><a href="#cb468-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rowid</span>,</span>
<span id="cb468-6"><a href="#cb468-6" aria-hidden="true" tabindex="-1"></a>    cql_blob_get(T.k, backed2.<span class="kw">id</span>) <span class="kw">AS</span> <span class="kw">id</span>,</span>
<span id="cb468-7"><a href="#cb468-7" aria-hidden="true" tabindex="-1"></a>    cql_blob_get(T.v, backed2.name) <span class="kw">AS</span> name</span>
<span id="cb468-8"><a href="#cb468-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backing <span class="kw">AS</span> T</span>
<span id="cb468-9"><a href="#cb468-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> cql_blob_get_type(T.k) <span class="op">=</span> <span class="op">-</span>1844763880292276559L;</span>
<span id="cb468-10"><a href="#cb468-10" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code></pre></div>
<p>As you can see it’s very similar – the type hash is different and of
course it has different columns but the pattern should be clear.</p>
<h4 id="computation-of-the-type-hash">Computation of the Type Hash</h4>
<p>The type hash, which is also sometimes called the record type, is
designed to stay fixed over time even if you add new optional fields.
Contrariwise, if you change the name of the type or if you add new not
null fields the type identity is considered to be changed and any data
you have in the backing table will basically be ignored because the type
hash will not match. This is lossy but safe. More complicated migrations
from one type shape to another or possibly by introducing a new backed
type and moving data.</p>
<h4 id="cql_blob_get-and-cql_blob_get_type"><code>cql_blob_get</code>
and <code>cql_blob_get_type</code></h4>
<p>By default cql_blob_get turns into either <code>bgetkey</code> or
<code>bgetval</code> depending on if you are reading from the key blob
or the value blob. The directives for configuring this function are:</p>
<div class="sourceCode" id="cb469"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_get_key bgetkey offset;</span></span>
<span id="cb469-2"><a href="#cb469-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_get_val bgetval;</span></span></code></pre></div>
<p>You can configure the system to ask for the column by offset (this is
normal for the primary key because it has a fixed number of columns for
any given key type and they are all mandatory), or by hash code (this is
normal for the value type because it might be missing some columns and
so offset is probably not appropriate). However both are configurable so
you want to do key by hashcode simply omit the “offset” part of the
directive. Likewise if your values are offset addressable you can add
“offset” to the value directive. Here the offset means the zero based
ordinal of the column in the key or the value.</p>
<blockquote>
<p>NOTE: The blob format for keys must be canonical in the sense that
the same values always produce the same blob so if you use a field id
based blob it will be important to always store the fields in the same
order. Contrariwise use of offsets for the value blob indicates that
your particular value blob will have fixed storage that is addressable
by offset. This may be suitable for your needs, for instance maybe you
only ever need to store 0-3 integers in the value.</p>
</blockquote>
<p>The type access functions are similarly configurable (these functions
get no argument).</p>
<div class="sourceCode" id="cb470"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_get_key_type bgetkey_type;</span></span>
<span id="cb470-2"><a href="#cb470-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_get_val_type bgetval_type;</span></span></code></pre></div>
<h4 id="selecting-from-a-backed-table">Selecting from a Backed
Table</h4>
<p>Armed with these basic transforms we can already do a simple
transform to make select statement work. Suppose CQL sees:</p>
<div class="sourceCode" id="cb471"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> backed;</span></code></pre></div>
<p>The compiler can make this select statement work with a simple
transform:</p>
<div class="sourceCode" id="cb472"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">WITH</span></span>
<span id="cb472-2"><a href="#cb472-2" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed())</span>
<span id="cb472-3"><a href="#cb472-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb472-4"><a href="#cb472-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed;</span></code></pre></div>
<p>Now remember <code>_backed</code> was the automatically created
shared fragment. Basically, when the compiler encounters a select
statement that mentions any backed table it adds a call to the
corresponding shared fragment in the <code>WITH</code> clause, creating
a `WITH`` clause if needed. This effectively creates necessary “view”.
And, because we’re using the shared fragment form, all users of this
fragment will share the text of the view. So there is no schema and the
“view” text of the backed table appears only once in the binary. More
precisely we get this after full expansion:</p>
<div class="sourceCode" id="cb473"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb473-2"><a href="#cb473-2" aria-hidden="true" tabindex="-1"></a>backed (<span class="dt">rowid</span>, <span class="kw">id</span>, name, bias) <span class="kw">AS</span> (</span>
<span id="cb473-3"><a href="#cb473-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb473-4"><a href="#cb473-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rowid</span>,</span>
<span id="cb473-5"><a href="#cb473-5" aria-hidden="true" tabindex="-1"></a>    bgetkey(T.k, <span class="dv">0</span>),                      <span class="co">-- 0 is offset of backed.id in key blob</span></span>
<span id="cb473-6"><a href="#cb473-6" aria-hidden="true" tabindex="-1"></a>    bgetval(T.v, <span class="op">-</span>6639502068221071091L),  <span class="co">-- note hash of backed.name</span></span>
<span id="cb473-7"><a href="#cb473-7" aria-hidden="true" tabindex="-1"></a>    bgetval(T.v, <span class="op">-</span>3826945563932272602L)   <span class="co">-- note hash of backed.bias</span></span>
<span id="cb473-8"><a href="#cb473-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> backing <span class="kw">AS</span> T</span>
<span id="cb473-9"><a href="#cb473-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bgetkey_type(T.k) <span class="op">=</span> 2105552408096159860L)</span>
<span id="cb473-10"><a href="#cb473-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">rowid</span>, <span class="kw">id</span>, name, bias</span>
<span id="cb473-11"><a href="#cb473-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> backed;</span></code></pre></div>
<p>Now with this in mind we can see that it would be very beneficial to
also add this:</p>
<div class="sourceCode" id="cb474"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bgetkey_type(b <span class="dt">blob</span>) <span class="dt">long</span>;</span>
<span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> backing_index <span class="kw">ON</span> backing(bgetkey_type(k));</span></code></pre></div>
<p>or more cleanly:</p>
<div class="sourceCode" id="cb475"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> backing_index <span class="kw">ON</span> backing(cql_blob_get_type(k));</span></code></pre></div>
<p>Either of these results in a computed index on the row type stored in
the blob.<br />
Other physical indices might be helpful too and these can potentially be
shared by many backed tables, or used in partial indicies.</p>
<blockquote>
<p>NOTE: Your type function can be named something other than the
default <code>bgetkey_type</code>.</p>
</blockquote>
<p>Now consider a slightly more complex example:</p>
<pre><code>select T1.* from backed T1 join backed2 T2 where T1.id = T2.id;</code></pre>
<p>This becomes:</p>
<pre><code>WITH
  backed (rowid, id, name, bias) AS (CALL _backed()),
  backed2 (rowid, id, name) AS (CALL _backed2())
  SELECT T1.*
    FROM backed AS T1
    INNER JOIN backed2 AS T2
    WHERE T1.id = T2.id;</code></pre>
<p>Now even though two different backed tables will be using the backing
store, the original select “just works” once the CTE’s have been added.
All the compiler had to do was add both backed table fragments. Even if
<code>backed</code> was joined against itself, that would also just
work.</p>
<h4 id="inserting-into-a-backed-table">Inserting Into a Backed
Table</h4>
<p>It will be useful to consider a simple example such as:</p>
<div class="sourceCode" id="cb478"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb478-1"><a href="#cb478-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> backed <span class="kw">values</span> (<span class="dv">1</span>, <span class="ot">&quot;n001&quot;</span>, <span class="fl">1.2</span>), (<span class="dv">2</span>, <span class="ot">&quot;n002&quot;</span>, <span class="fl">3.7</span>);</span></code></pre></div>
<p>This statement has to insert into the backing storage, converting the
various values into key and value blobs. The compiler uses a simple
transform to do this job as well. The above becomes:</p>
<div class="sourceCode" id="cb479"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">WITH</span></span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a>  _vals (<span class="kw">id</span>, name, bias) <span class="kw">AS</span> (</span>
<span id="cb479-3"><a href="#cb479-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">VALUES</span>(<span class="dv">1</span>, <span class="ot">&quot;n001&quot;</span>, <span class="fl">1.2</span>), (<span class="dv">2</span>, <span class="ot">&quot;n002&quot;</span>, <span class="fl">3.7</span>)</span>
<span id="cb479-4"><a href="#cb479-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb479-5"><a href="#cb479-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> backing(k, v) <span class="kw">SELECT</span></span>
<span id="cb479-6"><a href="#cb479-6" aria-hidden="true" tabindex="-1"></a>    cql_blob_create(backed, V.<span class="kw">id</span>, backed.<span class="kw">id</span>),</span>
<span id="cb479-7"><a href="#cb479-7" aria-hidden="true" tabindex="-1"></a>    cql_blob_create(backed,</span>
<span id="cb479-8"><a href="#cb479-8" aria-hidden="true" tabindex="-1"></a>      V.name, backed.name,</span>
<span id="cb479-9"><a href="#cb479-9" aria-hidden="true" tabindex="-1"></a>      V.bias, backed.bias)</span>
<span id="cb479-10"><a href="#cb479-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> _vals <span class="kw">AS</span> V;</span></code></pre></div>
<p>Again the compiler is opting for a transform that is universal and
here the issue is that the data to be inserted can be arbitrarily
complicated. It might include nested select expressions, value
computations, or any similar thing. In this particular case the data is
literal values but in general the values could be anything.</p>
<p>To accompodate this possiblity the compiler’s transform takes the
original values and puts them in its own CTE <code>_vals</code>. It then
generates a new insert statement targetting the backing store by
converting _vals into two blobs – one for the key and one for the value.
There is only the one place it needs to do this for any given
<code>insert</code> statement no matter now many items are inserted or
how complex the insertion computation might be.</p>
<p>The compiler uses <code>cql_blob_create</code> as a wrapper to that
can expand to a user configured function with optional hash codes and
mandatory field types. The default configuration that corresponds to
this:</p>
<div class="sourceCode" id="cb480"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb480-1"><a href="#cb480-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_create_key bcreatekey offset;</span></span>
<span id="cb480-2"><a href="#cb480-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_create_val bcreateval;</span></span></code></pre></div>
<p>The final SQL for an insert operation looks like this:</p>
<div class="sourceCode" id="cb481"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb481-2"><a href="#cb481-2" aria-hidden="true" tabindex="-1"></a>_vals (<span class="kw">id</span>, name, bias) <span class="kw">AS</span> (</span>
<span id="cb481-3"><a href="#cb481-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">VALUES</span>(<span class="dv">1</span>, <span class="ot">&quot;n001&quot;</span>, <span class="fl">1.2</span>), (<span class="dv">2</span>, <span class="ot">&quot;n002&quot;</span>, <span class="fl">3.7</span>)</span>
<span id="cb481-4"><a href="#cb481-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb481-5"><a href="#cb481-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> backing(k, v) <span class="kw">SELECT</span></span>
<span id="cb481-6"><a href="#cb481-6" aria-hidden="true" tabindex="-1"></a>  bcreatekey(<span class="dv">2105552408096159860</span>, V.<span class="kw">id</span>, <span class="dv">1</span>), <span class="co">-- type 1 is integer, offset implied</span></span>
<span id="cb481-7"><a href="#cb481-7" aria-hidden="true" tabindex="-1"></a>  bcreateval(<span class="dv">2105552408096159860</span>,</span>
<span id="cb481-8"><a href="#cb481-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="dv">6639502068221071091</span>, V.name, <span class="dv">4</span>,  <span class="co">-- hash as before, type 4 is text,</span></span>
<span id="cb481-9"><a href="#cb481-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="dv">3826945563932272602</span>, V.bias, <span class="dv">3</span>)  <span class="co">-- hash as before, type 3 is real,</span></span>
<span id="cb481-10"><a href="#cb481-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> _vals <span class="kw">AS</span> V</span></code></pre></div>
<p>As can be seen, both blobs have the same overall type code
(2105552408096159860) as in the select case. The key blob is configured
for to use offsets and the argument positions give the implied offset.
In contrast the value blob is using hash codes (<code>offset</code> was
not specified). This configuration is typical.</p>
<p>A more complex insert works just as well:</p>
<div class="sourceCode" id="cb482"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> backed</span>
<span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">id</span><span class="op">+</span><span class="dv">10</span>, name<span class="op">||</span><span class="st">&#39;x&#39;</span>, bias<span class="op">+</span><span class="dv">3</span> <span class="kw">from</span> backed <span class="kw">where</span> <span class="kw">id</span> <span class="op">&lt;</span> <span class="dv">3</span>;</span></code></pre></div>
<p>The above insert statement is a bit of a mess. It’s taking some of
the backed data and using that data to create new backed data. But the
simple transform above works just as before. We add the needed
<code>backed</code> CTE for the select and create <code>_vals</code>
like before.</p>
<div class="sourceCode" id="cb483"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb483-2"><a href="#cb483-2" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed()),</span>
<span id="cb483-3"><a href="#cb483-3" aria-hidden="true" tabindex="-1"></a>  _vals (<span class="kw">id</span>, name, bias) <span class="kw">AS</span> (</span>
<span id="cb483-4"><a href="#cb483-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span> <span class="op">+</span> <span class="dv">10</span>, name <span class="op">||</span> <span class="st">&#39;x&#39;</span>, bias <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb483-5"><a href="#cb483-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed</span>
<span id="cb483-6"><a href="#cb483-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb483-7"><a href="#cb483-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb483-8"><a href="#cb483-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> backing(k, v)</span>
<span id="cb483-9"><a href="#cb483-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT</span></span>
<span id="cb483-10"><a href="#cb483-10" aria-hidden="true" tabindex="-1"></a>     cql_blob_create(backed, V.<span class="kw">id</span>, backed.<span class="kw">id</span>),</span>
<span id="cb483-11"><a href="#cb483-11" aria-hidden="true" tabindex="-1"></a>     cql_blob_create(backed, V.name, backed.name, V.bias, backed.bias)</span>
<span id="cb483-12"><a href="#cb483-12" aria-hidden="true" tabindex="-1"></a>   <span class="kw">FROM</span> _vals <span class="kw">AS</span> V;</span></code></pre></div>
<p>Looking closely at the above we see a few things: -
<code>cql_blob_create</code> will expand as before (not shown) - we
added <code>backed(*)</code> as usual - <code>_vals</code> once again
just has the exact unchanged insert clause - the
<code>insert into backing(k, v)</code> part is identical, the same
recipe always works</p>
<h4 id="deleting-from-a-backed-table">Deleting From a Backed Table</h4>
<p>Again, we begin with a simple example:</p>
<div class="sourceCode" id="cb484"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> <span class="kw">from</span> backed <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">7</span>;</span></code></pre></div>
<p>The compiler requires a transformation that is quite general and
while this case is simple the where condition could be very complicated.
Fortunately there is such a simple transform:</p>
<div class="sourceCode" id="cb485"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed())</span>
<span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> backing</span>
<span id="cb485-4"><a href="#cb485-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (</span>
<span id="cb485-5"><a href="#cb485-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb485-6"><a href="#cb485-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed</span>
<span id="cb485-7"><a href="#cb485-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb485-8"><a href="#cb485-8" aria-hidden="true" tabindex="-1"></a>  );</span></code></pre></div>
<p>All the compiler has to do here is: * add the usual
<code>_backed</code> CTE * move the original <code>WHERE</code> clause
into a subordinate <code>SELECT</code> that gives us the rowids to
delete.</p>
<p>With the backed table in scope, any <code>WHERE</code> clause works.
If other backed tables are mentioned, the compiler simply adds those as
usual.</p>
<p>Below is a more complicated delete, it’s a bit crazy but
illustrative:</p>
<div class="sourceCode" id="cb486"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> <span class="kw">from</span> backed <span class="kw">where</span></span>
<span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="kw">in</span> (<span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> backed2 <span class="kw">where</span> name <span class="kw">like</span> <span class="st">&#39;%x%&#39;</span>);</span></code></pre></div>
<p>So this is using rows in <code>backed2</code> to decide which rows to
deleted in <code>backed</code>. The same simple transform works
directly.</p>
<div class="sourceCode" id="cb487"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb487-2"><a href="#cb487-2" aria-hidden="true" tabindex="-1"></a>  backed2 (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed2()),</span>
<span id="cb487-3"><a href="#cb487-3" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed())</span>
<span id="cb487-4"><a href="#cb487-4" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> backing</span>
<span id="cb487-5"><a href="#cb487-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (</span>
<span id="cb487-6"><a href="#cb487-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb487-7"><a href="#cb487-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed</span>
<span id="cb487-8"><a href="#cb487-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">IN</span> (</span>
<span id="cb487-9"><a href="#cb487-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> backed2 <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;%x%&#39;</span></span>
<span id="cb487-10"><a href="#cb487-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb487-11"><a href="#cb487-11" aria-hidden="true" tabindex="-1"></a>  );</span></code></pre></div>
<p>What happened: * the <code>WHERE</code> clause went directly into the
body of the rowid select * <code>backed</code> was used as before but
now we also need <code>backed2</code></p>
<p>The delete pattern does not need any additional cql helpers beyond
what we’ve already seen.</p>
<h4 id="updating-backed-tables">Updating Backed Tables</h4>
<p>The <code>update</code> statement is the most complicated of all the
DML forms, it requires all the transforms from the previous statements
plus one additional transform.</p>
<p>First, the compiler requires two more blob helpers that are
configurable. By default they look like this:</p>
<div class="sourceCode" id="cb488"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_update_key bupdatekey offset;</span></span>
<span id="cb488-2"><a href="#cb488-2" aria-hidden="true" tabindex="-1"></a><span class="ot">@blob_update_val bupdateval;</span></span></code></pre></div>
<p>These are used to replace particular columns in a stored blob. Now
let’s start with a very simple update to see now it all works:</p>
<div class="sourceCode" id="cb489"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a><span class="kw">update</span> backed <span class="kw">set</span> name <span class="op">=</span> <span class="st">&#39;foo&#39;</span> <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span></code></pre></div>
<p>Fundamentally we need to do these things: * the target of the update
has to end up being the backing table * we need the backed table CTE so
we can do the filtering * we want to use the rowid trick to figure out
which rows to update which handles our <code>where</code> clause * we
need to modify the existing key and/or value blobs rather than create
them from scratch</p>
<p>Applying all of the above, we get a transform like the following:</p>
<div class="sourceCode" id="cb490"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb490-2"><a href="#cb490-2" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed())</span>
<span id="cb490-3"><a href="#cb490-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> backing</span>
<span id="cb490-4"><a href="#cb490-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> v <span class="op">=</span> cql_blob_update(v, <span class="st">&#39;foo&#39;</span>, backed.name)</span>
<span id="cb490-5"><a href="#cb490-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb490-6"><a href="#cb490-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed</span>
<span id="cb490-7"><a href="#cb490-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>);</span></code></pre></div>
<p>Looking into the details: * we needed the normal CTE so that we can
use <code>backed</code> rows * the <code>WHERE</code> clause moved into
a <code>WHERE rowid</code> sub-select just like in the
<code>DELETE</code> case * they compiler changed the SET targets to be
<code>k</code> and <code>v</code> very much like the <code>INSERT</code>
case, except we used an update helper that takes the current blob and
creates a new blob to store * the helper is varargs so as we’ll see it
can mutate many columns in one call</p>
<p>The above gives a update statement that is almost working. The
remaining problem is that it is possible to use the existing column
values in the update expressions and there is no way to use our
<code>backed</code> CTE to get those values in that context since the
final update has to be all relative to the backing table.</p>
<p>Let’s look at another example to illustrate this last wrinkle:</p>
<div class="sourceCode" id="cb491"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a><span class="kw">update</span> backed <span class="kw">set</span> name <span class="op">=</span> name <span class="op">||</span> <span class="st">&#39;y&#39;</span> <span class="kw">where</span> bias <span class="op">&lt;</span> <span class="dv">5</span>;</span></code></pre></div>
<p>This update basically adds the letter ‘y’ to the name of some rows.
This is a silly example but this kind of thing happens in many contexts
that are definitely not silly. To make these cases work the reference to
<code>name</code> inside of the set expression has to change. We end up
with something like this:</p>
<div class="sourceCode" id="cb492"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb492-2"><a href="#cb492-2" aria-hidden="true" tabindex="-1"></a>  backed (<span class="op">*</span>) <span class="kw">AS</span> (<span class="kw">CALL</span> _backed())</span>
<span id="cb492-3"><a href="#cb492-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> backing</span>
<span id="cb492-4"><a href="#cb492-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> v <span class="op">=</span> cql_blob_update(v,</span>
<span id="cb492-5"><a href="#cb492-5" aria-hidden="true" tabindex="-1"></a>    cql_blob_get(v, backed.name) <span class="op">||</span> <span class="st">&#39;y&#39;</span>,</span>
<span id="cb492-6"><a href="#cb492-6" aria-hidden="true" tabindex="-1"></a>    backed.name)</span>
<span id="cb492-7"><a href="#cb492-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb492-8"><a href="#cb492-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> backed</span>
<span id="cb492-9"><a href="#cb492-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> bias <span class="op">&lt;</span> <span class="dv">5</span>);</span></code></pre></div>
<p>Importantly the reference to <code>name</code> in the set expression
was changed to <code>cql_blob_get(v, backed.name)</code> – extracting
the name from the value blob. After which it is appended with ‘y’ as
usual.</p>
<p>The rest of the pattern is just as it was after the first attempt
above, in fact literally everything else is unchanged. It’s easy to see
that the <code>WHERE</code> clause could be arbitrarily complex with no
difficulty.</p>
<blockquote>
<p>NOTE: Since the <code>UPDATE</code> statement has no
<code>FROM</code> clause only the fields in the target table might need
to be rewritten, so in this case <code>name</code>, <code>id</code>, and
<code>bias</code> were possible but only <code>name</code> was
mentioned.</p>
</blockquote>
<p>After the <code>cql_blob_get</code> and <code>cql_blob_update</code>
are expanded the result looks like this:</p>
<div class="sourceCode" id="cb493"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb493-2"><a href="#cb493-2" aria-hidden="true" tabindex="-1"></a>backed (<span class="dt">rowid</span>, <span class="kw">id</span>, name, bias) <span class="kw">AS</span> (</span>
<span id="cb493-3"><a href="#cb493-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb493-4"><a href="#cb493-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rowid</span>,</span>
<span id="cb493-5"><a href="#cb493-5" aria-hidden="true" tabindex="-1"></a>    bgetkey(T.k, <span class="dv">0</span>),</span>
<span id="cb493-6"><a href="#cb493-6" aria-hidden="true" tabindex="-1"></a>    bgetval(T.v, <span class="op">-</span>6639502068221071091L),</span>
<span id="cb493-7"><a href="#cb493-7" aria-hidden="true" tabindex="-1"></a>    bgetval(T.v, <span class="op">-</span>3826945563932272602L)</span>
<span id="cb493-8"><a href="#cb493-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> backing <span class="kw">AS</span> T</span>
<span id="cb493-9"><a href="#cb493-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bgetkey_type(T.k) <span class="op">=</span> 2105552408096159860L</span>
<span id="cb493-10"><a href="#cb493-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb493-11"><a href="#cb493-11" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> backing</span>
<span id="cb493-12"><a href="#cb493-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> v <span class="op">=</span></span>
<span id="cb493-13"><a href="#cb493-13" aria-hidden="true" tabindex="-1"></a>  bupdateval(</span>
<span id="cb493-14"><a href="#cb493-14" aria-hidden="true" tabindex="-1"></a>    v,</span>
<span id="cb493-15"><a href="#cb493-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>6639502068221071091L, bgetval(v, <span class="op">-</span>6639502068221071091L) <span class="op">||</span> <span class="st">&#39;y&#39;</span>, <span class="dv">4</span></span>
<span id="cb493-16"><a href="#cb493-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb493-17"><a href="#cb493-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb493-18"><a href="#cb493-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> backed</span>
<span id="cb493-19"><a href="#cb493-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bias <span class="op">&lt;</span> <span class="dv">5</span>);</span></code></pre></div>
<blockquote>
<p>NOTE: The blob update function for the value blob requires the
original blob, the hash or offset to update, the new value, and the type
of the new value. The blob update function for the key blob is the
nearly same (blob, hash/offset, value) but the type is not required
since the key blob necessarily has all the fields present because they
are necessarily not null. Therefore the type codes are already all
present and so the type of every column is known. The value blob might
be missing nullable values hence their type might not be
stored/known.</p>
</blockquote>
<p>Normally backed tables are used without having to know the details of
the transforms and the particulars of how each of the helper UDFs is
invoked but for illustration purposes we can make another small example
that shows a few more variations that might be created. In this examples
keys and values need to be mutated.</p>
<div class="sourceCode" id="cb494"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:backed_by=backing)</span></span>
<span id="cb494-2"><a href="#cb494-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> <span class="kw">sample</span>(</span>
<span id="cb494-3"><a href="#cb494-3" aria-hidden="true" tabindex="-1"></a> name text,</span>
<span id="cb494-4"><a href="#cb494-4" aria-hidden="true" tabindex="-1"></a> state <span class="dt">long</span>,</span>
<span id="cb494-5"><a href="#cb494-5" aria-hidden="true" tabindex="-1"></a> prev_state <span class="dt">long</span>,</span>
<span id="cb494-6"><a href="#cb494-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">primary</span> <span class="kw">key</span>(name, state)</span>
<span id="cb494-7"><a href="#cb494-7" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>This update mixes all kinds of values around…</p>
<div class="sourceCode" id="cb495"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a><span class="kw">update</span> <span class="kw">sample</span></span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">set</span> state <span class="op">=</span> state <span class="op">+</span> <span class="dv">1</span>, prev_state <span class="op">=</span> state</span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">where</span> name <span class="op">=</span> <span class="st">&#39;foo&#39;</span>;</span></code></pre></div>
<p>And the final output will be:</p>
<div class="sourceCode" id="cb496"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb496-1"><a href="#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb496-2"><a href="#cb496-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sample</span> (<span class="dt">rowid</span>, name, state, prev_state) <span class="kw">AS</span> (</span>
<span id="cb496-3"><a href="#cb496-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb496-4"><a href="#cb496-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rowid</span>,</span>
<span id="cb496-5"><a href="#cb496-5" aria-hidden="true" tabindex="-1"></a>    bgetkey(T.k, <span class="dv">0</span>),</span>
<span id="cb496-6"><a href="#cb496-6" aria-hidden="true" tabindex="-1"></a>    bgetkey(T.k, <span class="dv">1</span>),</span>
<span id="cb496-7"><a href="#cb496-7" aria-hidden="true" tabindex="-1"></a>    bgetval(T.v, <span class="op">-</span><span class="dv">4464241499905806900</span>)</span>
<span id="cb496-8"><a href="#cb496-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> backing <span class="kw">AS</span> T</span>
<span id="cb496-9"><a href="#cb496-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bgetkey_type(T.k) <span class="op">=</span> <span class="dv">3397981749045545394</span></span>
<span id="cb496-10"><a href="#cb496-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb496-11"><a href="#cb496-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb496-12"><a href="#cb496-12" aria-hidden="true" tabindex="-1"></a>  k <span class="op">=</span> bupdatekey(k, bgetkey(k, <span class="dv">1</span>) <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb496-13"><a href="#cb496-13" aria-hidden="true" tabindex="-1"></a>  v <span class="op">=</span> bupdateval(v, <span class="op">-</span><span class="dv">4464241499905806900</span>, bgetkey(k, <span class="dv">1</span>),  <span class="dv">2</span>)</span>
<span id="cb496-14"><a href="#cb496-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">rowid</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="dt">rowid</span></span>
<span id="cb496-15"><a href="#cb496-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> <span class="kw">sample</span></span>
<span id="cb496-16"><a href="#cb496-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;foo&#39;</span>);</span></code></pre></div>
<p>As expected the <code>bupdatekey</code> call gets the column offset
(1) but not the type code (2). <code>bupdateval</code> gets a hash code
and a type.</p>
<h4 id="normal-helper-declarations">Normal Helper Declarations</h4>
<p>If you want to refer to your blob functions in your own code, such as
for indices you’ll also need to do something like this:</p>
<div class="sourceCode" id="cb497"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bgetkey_type(b <span class="dt">blob</span>) <span class="dt">long</span>;</span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bgetval_type(b <span class="dt">blob</span>) <span class="dt">long</span>;</span>
<span id="cb497-3"><a href="#cb497-3" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bgetkey(b <span class="dt">blob</span>, iarg <span class="dt">integer</span>) <span class="dt">long</span>; <span class="co">-- polymorphic</span></span>
<span id="cb497-4"><a href="#cb497-4" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bgetval(b <span class="dt">blob</span>, iarg <span class="dt">integer</span>) <span class="dt">long</span>; <span class="co">-- polymorphic</span></span>
<span id="cb497-5"><a href="#cb497-5" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bcreateval <span class="kw">no</span> <span class="kw">check</span> <span class="dt">blob</span>;</span>
<span id="cb497-6"><a href="#cb497-6" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bcreatekey <span class="kw">no</span> <span class="kw">check</span> <span class="dt">blob</span>;</span>
<span id="cb497-7"><a href="#cb497-7" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bupdateval <span class="kw">no</span> <span class="kw">check</span> <span class="dt">blob</span>;</span>
<span id="cb497-8"><a href="#cb497-8" aria-hidden="true" tabindex="-1"></a>[[deterministic]] <span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> bupdatekey <span class="kw">no</span> <span class="kw">check</span> <span class="dt">blob</span>;</span></code></pre></div>
<p><code>bgetval</code> and <code>bgetkey</code> are not readily
declarable generally because their result is polymorphic so it’s
preferable to use <code>cql_blob_get</code> like the compiler does (see
examples above) which then does the rewrite for you. But it is helpful
to have a UDF declaration for each of the above, especially if you want
the <code>--rt query_plan</code> output to work seamlessly. Typically
<code>bgetval</code> or <code>bgetval</code> would only be needed in the
context of a <code>create index</code> statement and
<code>cql_blob_get</code> can be used instead in that case.</p>
<!---
-- Copyright (c) sample Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="chapter-17-vault-sensitive-encoding-for-privacy">Chapter 17:
Vault Sensitive – Encoding for Privacy</h2>
<h3 id="introduction">Introduction</h3>
<p>The general idea of “vaulted” values is that some fields in your
database might contain sensitive data and you might not want to make
this data visible to all the code in your whole project. The data could
be sensitive for a number of reasons, maybe it’s PII, or maybe it’s
confidential for some other reason. The idea here is that you can’t very
well limit access to this data in a lower layer like CQL can provide
because it’s likely that the functions accessing the data at this layer
are in the business of processing this data. For instance in Meta’s
Messenger application, the body of messages, the “text” if you will, is
<em>highly</em> sensitive, it might contain extremely valuable
information like phone numbers, medical information, literally anything.
And yet the Messenger application is <em>in the business</em> of
displaying this data; this is literally <em>what it does</em>. However,
sensitive data is supposed to be handled in certain very specific ways
in certain very specific places. It shouldn’t be appearing just willy
nilly. For instance sensitive data should never appear in debug
logs.</p>
<p>In fact, in any given application, there there is typically a lot of
code that simply passes the data along and never looks at it. This is in
some sense what we want, most places just flow data to where it needs to
go and only when it is actually needed, for instance to draw some pixels
on the screen, do we crack the data. We can search our codebase
carefully for these “cracking” operations and indeed we can limit them
with compilation tools to certain places. All of this is in the name of
avoiding mistakes.</p>
<p>It’s not perfect, but it adds a level of resistance and
discoverability that is useful for highly sensitive data.</p>
<h3 id="basics-of-operation">Basics of Operation</h3>
<p>The normal situation is that the presentation layer of your
application uses various stored procedures to create result sets full of
the data that it needs to get the job done. It passes these around to
its various layers. It may extract some fields and pass those around,
maybe row by row. The idea is that some of the values in the result set,
the sensitive ones, are not the real values, they are proxies. The
reason the attribute that drives all this is called “vault_sensitive” is
because it imagines the (optional) existence of a “vault” that stores
the real value of sensitive items and instead offers a proxy value that
is useless. For instance the vaulted value of a text message might be
the next available vaulted message number, “12”. It’s still a string. It
flows like a string. All the places that thing text is a string get a
string but the actual string is useless.</p>
<p>If you were to accidentally log this string in a debug file you would
see a useless number. The vault storage is typically set up so that the
key “12” is weakly held and when it vanishes the storage associated with
it also vanishes. This is particularly easy to do in some runtimes (like
iOS). In other runtimes (Java) it’s actually quite hard. In that case
you could opt to instead do some locally reversible encryption of the
message text. Like maybe there is a local key that is globally known but
is not durable, it’s persisted nowhere. Messages can be decoded locally
with ease but any message that actually left the device would be
encrypted forever with no hope of recovery.</p>
<p>The CQL position on this is that the encoding is entirely up to the
`cqlrt`` runtime which is replaceable. So it’s entirely up to the
customer to decide whether encoding is even useful and if so what
encoding is suitable in their context. The primitives simply make this
possible.</p>
<p>To light up encoding you apply one of three attribute forms to any
given procedure to “vault” its sensitive columns.</p>
<p>Let’s consider these examples:</p>
<div class="sourceCode" id="cb498"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> test</span>
<span id="cb498-2"><a href="#cb498-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb498-3"><a href="#cb498-3" aria-hidden="true" tabindex="-1"></a>  a <span class="dt">integer</span>,</span>
<span id="cb498-4"><a href="#cb498-4" aria-hidden="true" tabindex="-1"></a>  b text,</span>
<span id="cb498-5"><a href="#cb498-5" aria-hidden="true" tabindex="-1"></a>  x <span class="dt">integer</span> @sensitive,</span>
<span id="cb498-6"><a href="#cb498-6" aria-hidden="true" tabindex="-1"></a>  y text @sensitive</span>
<span id="cb498-7"><a href="#cb498-7" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb498-8"><a href="#cb498-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-9"><a href="#cb498-9" aria-hidden="true" tabindex="-1"></a>proc foo1()</span>
<span id="cb498-10"><a href="#cb498-10" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb498-11"><a href="#cb498-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test;</span>
<span id="cb498-12"><a href="#cb498-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb498-13"><a href="#cb498-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-14"><a href="#cb498-14" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:vault_sensitive)</span></span>
<span id="cb498-15"><a href="#cb498-15" aria-hidden="true" tabindex="-1"></a>proc foo2()</span>
<span id="cb498-16"><a href="#cb498-16" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb498-17"><a href="#cb498-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test;</span>
<span id="cb498-18"><a href="#cb498-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb498-19"><a href="#cb498-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-20"><a href="#cb498-20" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:vault_sensitive=(x))</span></span>
<span id="cb498-21"><a href="#cb498-21" aria-hidden="true" tabindex="-1"></a>proc foo3()</span>
<span id="cb498-22"><a href="#cb498-22" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb498-23"><a href="#cb498-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test;</span>
<span id="cb498-24"><a href="#cb498-24" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb498-25"><a href="#cb498-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-26"><a href="#cb498-26" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:vault_sensitive=(a,(x)))</span></span>
<span id="cb498-27"><a href="#cb498-27" aria-hidden="true" tabindex="-1"></a>proc foo4()</span>
<span id="cb498-28"><a href="#cb498-28" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb498-29"><a href="#cb498-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test;</span>
<span id="cb498-30"><a href="#cb498-30" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Looking at each of these in turn.</p>
<ul>
<li><code>foo1</code>: did not opt-in to vaulting, the storage is
normal</li>
<li><code>foo2</code>: opted all sensitive columns in to vaulting,
<code>x</code> and <code>y</code> will be encoded</li>
<li><code>foo3</code>: specified the sensitive columsn to vault, so just
<code>x</code></li>
<li><code>foo4</code>: specified that <code>x</code> is to be encoded
but the value of column <code>a</code> is “context” for the encoding
<ul>
<li>in this case effectively every row is encoded differently depending
on the value of <code>a</code> so to decode you’ll need to use the
decoder function and provide <code>a</code></li>
<li>this provides even more “mistake resistence”</li>
</ul></li>
</ul>
<p>Importantly, the CQL runtime calls the encoding functions (below)
automatically but it never decodes anything. How and when to decode is a
function of what the encoding was and so it’s usually necessary to
provide your upper layers with a convenient way to reverse whatever
encoding you selected.</p>
<h3 id="vaulting-mechanics">Vaulting Mechanics</h3>
<p>The difference in code generation is very trivial. To the extent that
there is any heavy lifting, the runtime is doing it.</p>
<p>The metadata block generated for <code>foo1</code> looks like
this:</p>
<div class="sourceCode" id="cb499"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> foo1_data_types<span class="op">[</span>foo1_data_types_count<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32<span class="op">,</span> <span class="co">// a</span></span>
<span id="cb499-3"><a href="#cb499-3" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// b</span></span>
<span id="cb499-4"><a href="#cb499-4" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32<span class="op">,</span> <span class="co">// x</span></span>
<span id="cb499-5"><a href="#cb499-5" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// y</span></span>
<span id="cb499-6"><a href="#cb499-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>And <code>foo2</code> looks like this:</p>
<div class="sourceCode" id="cb500"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> foo2_data_types<span class="op">[</span>foo2_data_types_count<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb500-2"><a href="#cb500-2" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32<span class="op">,</span> <span class="co">// a</span></span>
<span id="cb500-3"><a href="#cb500-3" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// b</span></span>
<span id="cb500-4"><a href="#cb500-4" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32 <span class="op">|</span> CQL_DATA_TYPE_ENCODED<span class="op">,</span> <span class="co">// x</span></span>
<span id="cb500-5"><a href="#cb500-5" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING <span class="op">|</span> CQL_DATA_TYPE_ENCODED<span class="op">,</span> <span class="co">// y</span></span>
<span id="cb500-6"><a href="#cb500-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The <em>only</em> difference between these procedures is the presence
of <code>CQL_DATA_TYPE_ENCODED</code> (twice) in the metadata for the
result set. &gt;Note: Lua codegen doesn’t support vaulting at this time
but if it did, it would do it an analogous way. Lua uses a metadata
string like “isis” (int string int string) to describe the columns, it
could use a different characters like “j” and “t” to get “isjt” for
encoded types. The C runtime stores the types in a byte.</p>
<p>Unsurprisingly the next variant has metadata that looks like
this:</p>
<div class="sourceCode" id="cb501"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> foo3_data_types<span class="op">[</span>foo3_data_types_count<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32<span class="op">,</span> <span class="co">// a</span></span>
<span id="cb501-3"><a href="#cb501-3" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// b</span></span>
<span id="cb501-4"><a href="#cb501-4" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_INT32 <span class="op">|</span> CQL_DATA_TYPE_ENCODED<span class="op">,</span> <span class="co">// x</span></span>
<span id="cb501-5"><a href="#cb501-5" aria-hidden="true" tabindex="-1"></a>  CQL_DATA_TYPE_STRING<span class="op">,</span> <span class="co">// y</span></span>
<span id="cb501-6"><a href="#cb501-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The final case, with context, is a little different. It has the same
metadata as case 3 but the rowset fetching function gets a little extra
information:</p>
<div class="sourceCode" id="cb502"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a>  cql_fetch_info info <span class="op">=</span> <span class="op">{</span></span>
<span id="cb502-2"><a href="#cb502-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>rc <span class="op">=</span> rc<span class="op">,</span></span>
<span id="cb502-3"><a href="#cb502-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>db <span class="op">=</span> _db_<span class="op">,</span></span>
<span id="cb502-4"><a href="#cb502-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>stmt <span class="op">=</span> stmt<span class="op">,</span></span>
<span id="cb502-5"><a href="#cb502-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>data_types <span class="op">=</span> foo4_data_types<span class="op">,</span></span>
<span id="cb502-6"><a href="#cb502-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>col_offsets <span class="op">=</span> foo4_col_offsets<span class="op">,</span></span>
<span id="cb502-7"><a href="#cb502-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>refs_count <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb502-8"><a href="#cb502-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>refs_offset <span class="op">=</span> foo4_refs_offset<span class="op">,</span></span>
<span id="cb502-9"><a href="#cb502-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>encode_context_index <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb502-10"><a href="#cb502-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>rowsize <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>foo4_row<span class="op">),</span></span>
<span id="cb502-11"><a href="#cb502-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>crc <span class="op">=</span> CRC_foo4<span class="op">,</span></span>
<span id="cb502-12"><a href="#cb502-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>perf_index <span class="op">=</span> <span class="op">&amp;</span>foo4_perf_index<span class="op">,</span></span>
<span id="cb502-13"><a href="#cb502-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p>The index of the context field was initialized to <code>0</code>
which is the index of <code>a</code>. In the other cases the
<code>cql_fetch_info</code> was <code>-1</code> indicating no
context.</p>
<p>The result of these bits being set is that the encoders will be
called on those columns after the data has been fetched from the
database but before the result set is visible to consumers.</p>
<p>For instance, to encode a string this sequence happens:</p>
<div class="sourceCode" id="cb503"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a><span class="co">// prototype</span></span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a>cql_object_ref cql_copy_encoder<span class="op">(</span>sqlite3<span class="op">*</span> db<span class="op">);</span></span>
<span id="cb503-3"><a href="#cb503-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-4"><a href="#cb503-4" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> cql_copy_encoder<span class="op">(</span>db<span class="op">);</span></span></code></pre></div>
<p>First the runtime copy an encoder reference. It’s called
<em>copy</em> because the normal situation is that there is only one
shared encoder per database connection and all the runtime has to is add
a reference and return the same encoder again. By default there is no
encoder object so the default <code>cqlrt</code> just returns
<code>NULL</code>. However, if there was a “vault” then you wouldn’t
want to have to find it again on every encoded column of every row so
this gives you a place to load it up.</p>
<p>Then, for each encoded string a call like this is made:</p>
<div class="sourceCode" id="cb504"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a>cql_string_ref new_str_ref <span class="op">=</span> cql_encode_string_ref_new<span class="op">(</span>encoder<span class="op">,</span> <span class="op">*</span>str_ref<span class="op">,</span> encode_context_type<span class="op">,</span> encode_context_field<span class="op">);</span></span></code></pre></div>
<ul>
<li><code>encoder</code> is the previously fetched encoder object, it
could be anything</li>
<li><code>str_ref</code> will be a string reference</li>
<li><code>encode_context_type</code> will be either <code>-1</code> or
else one of data type constants seen above such as
<code>CQL_DATA_TYPE_STRING | CQL_DATA_TYPE_NOTNULL</code></li>
<li><code>encode_context_field</code> will be a byte pointer to the
context value (it has been fetched for sure)
<ul>
<li>if the context is itself encoded then the sequence becomes
not-deterministic so this is strongly discouraged</li>
<li>if your runtime only supports certain kinds of context (e.g. long
integer) the type of the context column may be constrained with
<code>@enforce_strict encode context type long;</code> and similar
variants for other types.</li>
</ul></li>
</ul>
<p>There are similar functions in the runtime like
<code>cql_encode_double</code> with a similar signature.</p>
<p>The default encodings are very lame and only useful for testing. Like
many things in <code>cqlrt.c</code> you should <a
href="./internal.html#part-5-cql-runtime">replace them</a> with
something appropriate for your environment. See the section on <a
href="./internal.html#encoding-of-sensitive-columns">encoding sensitive
columns</a>.</p>
<p>Even very simple encoders can help avoid mistakes because they force
the use of the decoder and that usage gives you a “code smell” to look
for. Some sections of code, maybe even most sections, have no business
decoding anything. And even the super-lame “just add ‘#’” strategy in
the defeault implementation gives you something you can look for in
tests. If you ever saw ‘#’ anywhere in debug output that likely is a
data leak and should fail the test. And it’s pretty clear we can do
better than “just add ‘#’”.</p>
<h3 id="adopting-vault-sensitive">Adopting Vault Sensitive</h3>
<p>Importantly, vaulting never happens by default. The presence of the
vault sensitive attribute will let you adopt sensitive vaulting
gradually. If you have a codebase that already works with normal data
types you can “break” it gradually adding the needed decoders a little
at a time. There are even helpers that will let you dynamically turn off
encoding. For instance in the <code>foo2</code> example above, this
function was generated:</p>
<div class="sourceCode" id="cb505"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo2_set_encoding<span class="op">(</span>cql_int32 col<span class="op">,</span> cql_bool encode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cql_set_encoding<span class="op">(</span>foo2_data_types<span class="op">,</span> foo2_data_types_count<span class="op">,</span> col<span class="op">,</span> encode<span class="op">);</span></span>
<span id="cb505-3"><a href="#cb505-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This lets you disable or enable encoding of a column dyamically, so
you can roll out encoding to say 1% of your users in a trial.</p>
<p>And finally, the abbreviated syntax for <code>cql:</code> attributes
works here as always so <code>[[vault_sensitive]]</code> or
<code>[[vault_sensitive=(x,y)]]</code> are less verbose options to
<code>@attribute(cql:vault_sensitive=(x,y))</code> and they are totally
equivalent.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-1-command-line-options">Appendix 1: Command Line
Options</h2>
<p>CQL has a variety of command line (CLI) options but many of them are
only interesting for cql development. Nonetheless this is a
comprehensive list:</p>
<blockquote>
<p>NOTE: CQL is often used after the c pre-processor is run so this kind
of invocation is typical:</p>
</blockquote>
<pre><code>cc -E -x c foo.sql | cql [args]</code></pre>
<h3 id="with-no-options">With No Options</h3>
<ul>
<li>emits a usage message</li>
</ul>
<h3 id="in-file">–in file</h3>
<ul>
<li>reads the given file for the input instead of stdin</li>
<li>the input should probably have already been run through the C
pre-processor as above</li>
<li>returns non-zero if the file fails to parse</li>
</ul>
<p>Example:</p>
<pre><code>cql --in test.sql</code></pre>
<h3 id="sem">–sem</h3>
<ul>
<li>performs semantic analysis on the input file ONLY</li>
<li>the return code is zero if there are no errors</li>
</ul>
<p>Example:</p>
<pre><code>cql --in sem_test.sql --sem</code></pre>
<h3 id="ast">–ast</h3>
<ul>
<li>walks the AST and prints it to stdout in human readable text
form</li>
<li>may be combined with –sem (semantic info will be included)
Example</li>
</ul>
<pre><code>cql --in sem_test.sql --sem --ast &gt;sem_ast.out</code></pre>
<h3 id="echo">–echo</h3>
<ul>
<li>walks the AST and emits the text of a program that would create
it</li>
<li>this has the effect of “beautifying” badly formatted input or
“canonicalizing” it
<ul>
<li>some sensible indenting is added but it might not be the original
indenting</li>
<li>extraneous whitespace, parens, etc. are removed</li>
</ul></li>
<li>may be combined with –sem (in which case you see the source after
any rewrites for sugar)</li>
<li>this also validates that the input can be parsed</li>
</ul>
<p>Example</p>
<pre><code>cql --in test.sql --echo &gt;test.out  # test.out is &quot;equivalent&quot; to test.sql</code></pre>
<h3 id="dot">–dot</h3>
<ul>
<li>prints the internal AST to stdout in DOT format for graph
visualization</li>
<li>this is really only interesting for small graphs for discussion as
it rapidly gets insane</li>
</ul>
<p>Example:</p>
<pre><code>cql --dot --in dottest.sql</code></pre>
<h3 id="cg-output1-output2">–cg output1 output2 …</h3>
<ul>
<li>any number of output files may be needed for a particular result
type, two is common</li>
<li>the return code is zero if there are no errors</li>
<li>any –cg option implies –sem</li>
</ul>
<p>Example:</p>
<pre><code>cql --in foo.sql --cg foo.h foo.c</code></pre>
<h3 id="nolines">–nolines</h3>
<ul>
<li>Suppress the # directives for lines. Useful if you need to debug the
C code.</li>
</ul>
<p>Example:</p>
<pre><code>cql --in test.sql --nolines --cg foo.h foo.c</code></pre>
<h3 id="global_proc-name">–global_proc name</h3>
<ul>
<li>any loose SQL statements not in a stored proc are gathered and put
into a procedure of the given name</li>
<li>when generating a schema migrate script the global proc name is used
as a prefix on all of the artifacts so that there can be several
independent migrations linked into a single executable</li>
</ul>
<h3 id="compress">–compress</h3>
<ul>
<li>for use with the C result type, (or any similar types added to the
runtime array in your compiler)</li>
<li>string literals for the SQL are broken into “fragments” the DML is
then represented by an array of fragments</li>
<li>since DML is often very similar there is a lot of token sharing
possible</li>
<li>the original string is recreated at runtime from the fragments and
then executed</li>
<li>comments show the original string inline for easier debugging and
searching</li>
</ul>
<blockquote>
<p>NOTE: different result types require a different number of output
files with different meanings</p>
</blockquote>
<h3 id="test">–test</h3>
<ul>
<li>some of the output types can include extra diagnostics if
<code>--test</code> is included</li>
<li>the test output often makes the outputs badly formed so this is
generally good for humans only</li>
</ul>
<h3 id="dev">–dev</h3>
<ul>
<li>some codegen features only make sense during development, this
enables dev mode to turn those one ** example: <a
href="#chapter-15-query-plan-generation">explain query plan</a></li>
</ul>
<h3 id="c_include_namespace">–c_include_namespace</h3>
<ul>
<li>for the C codegen runtimes, it determines the header namespace (as
in #include “namespace/file.h”) that goes into the output C file</li>
<li>if this option is used, it is prefixed to the first argment to –cg
to form the include path in the C file</li>
<li>if absent there is no “namespace/” prefix</li>
</ul>
<h3 id="c_include_path">–c_include_path</h3>
<ul>
<li>for the C codegen runtimes, it determines the full header path (as
in #include “your_arg”) that goes into the output C file</li>
<li>if this option is used, the first argment to –cg controls only the
output path and does not appear in include path at all</li>
<li>this form overrides –c_include_namespace if both are specified</li>
</ul>
<h3 id="objc_c_include_path">–objc_c_include_path</h3>
<ul>
<li>for ObjC codegen runtimes that need to refer to the generated C
code, this represents the header of the C generated code that will be
used during inclusion from the ObjC file</li>
</ul>
<h3 id="result-types-rt">Result Types (–rt *)</h3>
<p>These are the various outputs the compiler can produce.</p>
<h4 id="rt-c">–rt c</h4>
<ul>
<li>requires two output files (foo.h and foo.c)</li>
<li>this is the standard C compilation of the sql file</li>
</ul>
<h5 id="cqlrt-foo.h">–cqlrt foo.h</h5>
<ul>
<li>emits <code>#include "foo.h"</code> into the C output instead of
<code>#include "cqlrt.h"</code></li>
</ul>
<h5 id="generate_type_getters">–generate_type_getters</h5>
<ul>
<li>changes C output for CQL result sets so that the field readers used
shared functions to get fields of a certain type</li>
<li>this style of codegen makes result-sets more interoperable with each
other if they have similar shape so it can be useful</li>
</ul>
<h5 id="generate_exports">–generate_exports</h5>
<ul>
<li>adds an additional output file</li>
<li>example: `–in foo.sql –generate_exports –rt c –cg foo.h foo.c
foo_exports.sql</li>
<li>the output file <code>foo_exports.sql</code> includes procedure
declarations for the contents of <code>foo.sql</code></li>
<li>basically automatically generates the CQL header file you need to
access the procedures in the input from some other file</li>
<li>if it were C it would be like auto-generating <code>foo.h</code>
from <code>foo.c</code></li>
</ul>
<h4 id="rt-objc">–rt objc</h4>
<ul>
<li>objective C wrappers for result sets produced by the stored
procedures in the input</li>
<li>these depend on the output of a standard codegen run so this is
additive</li>
<li>requires one output file (foo.h)</li>
</ul>
<h4 id="rt-schema">–rt schema</h4>
<ul>
<li>produces the canonical schema for the given input files</li>
<li>stored procedures etc. are removed</li>
<li>whitespace etc. is removed</li>
<li>suitable for use to create the next or first “previous” schema for
schema validation</li>
<li>requires one output file</li>
</ul>
<h4 id="rt-schema_upgrade">–rt schema_upgrade</h4>
<ul>
<li>produces a CQL schema upgrade script which can then be compiled with
CQL itself</li>
<li>see the chapter on schema upgrade/migration: <a
href="#chapter-10-schema-management-features">Chapter 10</a></li>
<li>requires one output file (foo.sql)</li>
</ul>
<h5 id="include_regions-a-b-c">–include_regions a b c</h5>
<ul>
<li>the indicated regions will be declared</li>
<li>used with <code>--rt schema_upgrade</code> or
<code>--rt schema</code></li>
<li>in the upgrade case excluded regions will not be themselves
upgraded, but may be referred, to by things that are being upgraded</li>
</ul>
<h5 id="exclude_regions-x-y-z">–exclude_regions x y z</h5>
<ul>
<li>the indicated regions will still be declared but the upgrade code
will be suppressed, the presumption being that a different script
already upgrades x y z</li>
<li>used with <code>--rt schema_upgrade</code></li>
</ul>
<h5 id="min_schema_version-n">–min_schema_version n</h5>
<ul>
<li>the schema upgrade script will not include upgrade steps for schema
older than the version specified</li>
</ul>
<h5 id="schema_exclusive">–schema_exclusive</h5>
<ul>
<li>the schema upgrade script assumes it owns all the schema in the
database, it aggressively removes other things</li>
</ul>
<h4 id="rt-json_schema">–rt json_schema</h4>
<ul>
<li>produces JSON output suitable for consumption by downstream
codegen</li>
<li>the JSON includes a definition of the various entities in the
input</li>
<li>see the section on JSON output for details</li>
</ul>
<h4 id="rt-query_plan">–rt query_plan</h4>
<ul>
<li>produces CQL output which can be re-compiled by CQL as normal
input</li>
<li>the output consists of a set of procedures that will emit all query
plans for the DML that was in the input</li>
<li>see <a href="#chapter-15-query-plan-generation">Chapter 15</a></li>
</ul>
<h4 id="rt-stats">–rt stats</h4>
<ul>
<li>produces a simple .csv file with node count information for AST
nodes per procedure in the input</li>
<li>requires one output file (foo.csv)</li>
</ul>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-2-cql-grammar">Appendix 2: CQL Grammar</h2>
<p>What follows is taken from a grammar snapshot with the tree building
rules removed. It should give a fair sense of the syntax of CQL (but not
semantic validation).</p>
<p>Snapshot as of Sat Aug 26 16:04:57 PDT 2023</p>
<h3 id="operators-and-literals">Operators and Literals</h3>
<p>These are in order of priority lowest to highest</p>
<pre><code>&quot;UNION ALL&quot; &quot;UNION&quot; &quot;INTERSECT&quot; &quot;EXCEPT&quot;
&quot;:=&quot;
&quot;OR&quot;
&quot;AND&quot;
&quot;NOT&quot;
&quot;BETWEEN&quot; &quot;NOT BETWEEN&quot; &quot;&lt;&gt;&quot; &quot;!=&quot; &#39;=&#39; &quot;==&quot; &quot;LIKE&quot; &quot;NOT LIKE&quot; &quot;GLOB&quot; &quot;NOT GLOB&quot; &quot;MATCH&quot; &quot;NOT MATCH&quot; &quot;REGEXP&quot; &quot;NOT REGEXP&quot; &quot;IN&quot; &quot;NOT IN&quot; &quot;IS NOT&quot; &quot;IS&quot; &quot;IS TRUE&quot; &quot;IS FALSE&quot; &quot;IS NOT TRUE&quot; &quot;IS NOT FALSE&quot;
&quot;ISNULL&quot; &quot;NOTNULL&quot;
&#39;&lt;&#39; &#39;&gt;&#39; &quot;&gt;=&quot; &quot;&lt;=&quot;
&quot;&lt;&lt;&quot; &quot;&gt;&gt;&quot; &#39;&amp;&#39; &#39;|&#39;
&#39;+&#39; &#39;-&#39;
&#39;*&#39; &#39;/&#39; &#39;%&#39;
&quot;||&quot;
&quot;COLLATE&quot;
&quot;UMINUS&quot; &#39;~&#39;</code></pre>
<p>NOTE: The above varies considerably from the C binding order!!!</p>
<p>Literals:</p>
<pre><code>ID  /* a name */
STRLIT /* a string literal in SQL format e.g. &#39;it&#39;&#39;s sql&#39; */
CSTRLIT /* a string literal in C format e.g. &quot;hello, world\n&quot; */
BLOBLIT /* a blob literal in SQL format e.g. x&#39;12ab&#39; */
INTLIT /* integer literal */
LONGLIT /* long integer literal */
REALLIT /* floating point literal */</code></pre>
<h3 id="statementtype-keywords">Statement/Type Keywords</h3>
<pre><code>&quot;@ATTRIBUTE&quot; &quot;@BEGIN_SCHEMA_REGION&quot; &quot;@BLOB_CREATE_KEY&quot;
&quot;@BLOB_CREATE_VAL&quot; &quot;@BLOB_GET_KEY&quot; &quot;@BLOB_GET_KEY_TYPE&quot;
&quot;@BLOB_GET_VAL&quot; &quot;@BLOB_GET_VAL_TYPE&quot; &quot;@BLOB_UPDATE_KEY&quot;
&quot;@BLOB_UPDATE_VAL&quot; &quot;@CREATE&quot; &quot;@DECLARE_DEPLOYABLE_REGION&quot;
&quot;@DECLARE_SCHEMA_REGION&quot; &quot;@DELETE&quot; &quot;@DUMMY_SEED&quot; &quot;@ECHO&quot;
&quot;@EMIT_CONSTANTS&quot; &quot;@EMIT_ENUMS&quot; &quot;@EMIT_GROUP&quot;
&quot;@END_SCHEMA_REGION&quot; &quot;@ENFORCE_NORMAL&quot; &quot;@ENFORCE_POP&quot;
&quot;@ENFORCE_PUSH&quot; &quot;@ENFORCE_RESET&quot; &quot;@ENFORCE_STRICT&quot;
&quot;@EPONYMOUS&quot; &quot;@FILE&quot; &quot;@PREVIOUS_SCHEMA&quot; &quot;@PROC&quot; &quot;@RC&quot;
&quot;@RECREATE&quot; &quot;@SCHEMA_AD_HOC_MIGRATION&quot;
&quot;@SCHEMA_UPGRADE_SCRIPT&quot; &quot;@SCHEMA_UPGRADE_VERSION&quot;
&quot;@SENSITIVE&quot; &quot;@UNSUB&quot; &quot;ABORT&quot; &quot;ACTION&quot; &quot;ADD&quot; &quot;AFTER&quot; &quot;ALL&quot;
&quot;ALTER&quot; &quot;ARGUMENTS&quot; &quot;AS&quot; &quot;ASC&quot; &quot;AUTOINCREMENT&quot; &quot;BEFORE&quot;
&quot;BEGIN&quot; &quot;BLOB&quot; &quot;BY&quot; &quot;CALL&quot; &quot;CASCADE&quot; &quot;CASE&quot; &quot;CAST&quot; &quot;CATCH&quot;
&quot;CHECK&quot; &quot;CLOSE&quot; &quot;COLUMN&quot; &quot;COLUMNS&quot; &quot;COMMIT&quot; &quot;CONST&quot;
&quot;CONSTRAINT&quot; &quot;CONTEXT COLUMN&quot; &quot;CONTEXT TYPE&quot; &quot;CONTINUE&quot;
&quot;CREATE&quot; &quot;CROSS&quot; &quot;CURRENT ROW&quot; &quot;CURSOR HAS ROW&quot; &quot;CURSOR&quot;
&quot;DECLARE&quot; &quot;DEFAULT&quot; &quot;DEFERRABLE&quot; &quot;DEFERRED&quot; &quot;DELETE&quot; &quot;DESC&quot;
&quot;DISTINCT&quot; &quot;DISTINCTROW&quot; &quot;DO&quot; &quot;DROP&quot; &quot;ELSE IF&quot; &quot;ELSE&quot;
&quot;ENCODE&quot; &quot;END&quot; &quot;ENUM&quot; &quot;EXCLUDE CURRENT ROW&quot; &quot;EXCLUDE GROUP&quot;
&quot;EXCLUDE NO OTHERS&quot; &quot;EXCLUDE TIES&quot; &quot;EXCLUSIVE&quot; &quot;EXISTS&quot;
&quot;EXPLAIN&quot; &quot;FAIL&quot; &quot;FETCH&quot; &quot;FILTER&quot; &quot;FIRST&quot; &quot;FOLLOWING&quot; &quot;FOR
EACH ROW&quot; &quot;FOR&quot; &quot;FOREIGN&quot; &quot;FROM BLOB&quot; &quot;FROM&quot; &quot;FUNC&quot;
&quot;FUNCTION&quot; &quot;GROUP&quot; &quot;GROUPS&quot; &quot;HAVING&quot; &quot;HIDDEN&quot; &quot;IF&quot; &quot;IGNORE&quot;
&quot;IMMEDIATE&quot; &quot;INDEX&quot; &quot;INITIALLY&quot; &quot;INNER&quot; &quot;INOUT&quot; &quot;INSERT&quot;
&quot;INSTEAD&quot; &quot;INT&quot; &quot;INTEGER&quot; &quot;INTERFACE&quot; &quot;INTO&quot; &quot;JOIN&quot; &quot;KEY&quot;
&quot;LAST&quot; &quot;LEAVE&quot; &quot;LEFT&quot; &quot;LET&quot; &quot;LIMIT&quot; &quot;LONG&quot; &quot;LONG_INT&quot;
&quot;LONG_INTEGER&quot; &quot;LOOP&quot; &quot;NO&quot; &quot;NOT DEFERRABLE&quot; &quot;NOTHING&quot;
&quot;NULL&quot; &quot;NULLS&quot; &quot;OBJECT&quot; &quot;OF&quot; &quot;OFFSET&quot; &quot;ON CONFLICT&quot; &quot;ON&quot;
&quot;OPEN&quot; &quot;ORDER&quot; &quot;OUT&quot; &quot;OUTER&quot; &quot;OVER&quot; &quot;PARTITION&quot; &quot;PRECEDING&quot;
&quot;PRIMARY&quot; &quot;PRIVATE&quot; &quot;PROC&quot; &quot;PROCEDURE&quot; &quot;QUERY PLAN&quot; &quot;RAISE&quot;
&quot;RANGE&quot; &quot;REAL&quot; &quot;RECURSIVE&quot; &quot;REFERENCES&quot; &quot;RELEASE&quot; &quot;RENAME&quot;
&quot;REPLACE&quot; &quot;RESTRICT&quot; &quot;RETURN&quot; &quot;RIGHT&quot; &quot;ROLLBACK&quot; &quot;ROWID&quot;
&quot;ROWS&quot; &quot;SAVEPOINT&quot; &quot;SELECT&quot; &quot;SET&quot; &quot;SIGN FUNCTION&quot;
&quot;STATEMENT&quot; &quot;SWITCH&quot; &quot;TABLE&quot; &quot;TEMP&quot; &quot;TEXT&quot; &quot;THEN&quot; &quot;THROW&quot;
&quot;TO&quot; &quot;TRANSACTION&quot; &quot;TRIGGER&quot; &quot;TRY&quot; &quot;TYPE&quot; &quot;TYPE_CHECK&quot;
&quot;UNBOUNDED&quot; &quot;UNIQUE&quot; &quot;UPDATE&quot; &quot;UPSERT&quot; &quot;USING&quot; &quot;VALUES&quot;
&quot;VAR&quot; &quot;VIEW&quot; &quot;VIRTUAL&quot; &quot;WHEN&quot; &quot;WHERE&quot; &quot;WHILE&quot; &quot;WINDOW&quot;
&quot;WITH&quot; &quot;WITHOUT&quot;</code></pre>
<h3 id="rules">Rules</h3>
<p>Note that in many cases the grammar is more generous than the overall
language and errors have to be checked on top of this, often this is
done on purpose because even when it’s possible it might be very
inconvenient to do checks with syntax. For example the grammar cannot
enforce non-duplicate ids in id lists, but it could enforce
non-duplicate attributes in attribute lists. It chooses to do neither as
they are easily done with semantic validation. Thus the grammar is not
the final authority on what constitutes a valid program but it’s a good
start.</p>
<pre><code>

program:
  opt_stmt_list
  ;

opt_stmt_list:
  /*nil*/
  | stmt_list
  ;

stmt_list:
  stmt
  | stmt_list stmt
  ;

stmt:
  misc_attrs any_stmt &#39;;&#39;
  ;

any_stmt:
    alter_table_add_column_stmt
  | begin_schema_region_stmt
  | begin_trans_stmt
  | blob_get_key_type_stmt
  | blob_get_val_type_stmt
  | blob_get_key_stmt
  | blob_get_val_stmt
  | blob_create_key_stmt
  | blob_create_val_stmt
  | blob_update_key_stmt
  | blob_update_val_stmt
  | call_stmt
  | close_stmt
  | commit_return_stmt
  | commit_trans_stmt
  | continue_stmt
  | create_index_stmt
  | create_proc_stmt
  | create_table_stmt
  | create_trigger_stmt
  | create_view_stmt
  | create_virtual_table_stmt
  | declare_deployable_region_stmt
  | declare_enum_stmt
  | declare_const_stmt
  | declare_group_stmt
  | declare_select_func_no_check_stmt
  | declare_func_stmt
  | declare_out_call_stmt
  | declare_proc_no_check_stmt
  | declare_proc_stmt
  | declare_interface_stmt
  | declare_schema_region_stmt
  | declare_vars_stmt
  | declare_forward_read_cursor_stmt
  | declare_fetched_value_cursor_stmt
  | declare_type_stmt
  | delete_stmt
  | drop_index_stmt
  | drop_table_stmt
  | drop_trigger_stmt
  | drop_view_stmt
  | echo_stmt
  | emit_enums_stmt
  | emit_group_stmt
  | emit_constants_stmt
  | end_schema_region_stmt
  | enforce_normal_stmt
  | enforce_pop_stmt
  | enforce_push_stmt
  | enforce_reset_stmt
  | enforce_strict_stmt
  | explain_stmt
  | select_nothing_stmt
  | fetch_call_stmt
  | fetch_stmt
  | fetch_values_stmt
  | fetch_cursor_from_blob_stmt
  | guard_stmt
  | if_stmt
  | insert_stmt
  | leave_stmt
  | let_stmt
  | loop_stmt
  | out_stmt
  | out_union_stmt
  | out_union_parent_child_stmt
  | previous_schema_stmt
  | proc_savepoint_stmt
  | release_savepoint_stmt
  | return_stmt
  | rollback_return_stmt
  | rollback_trans_stmt
  | savepoint_stmt
  | select_stmt
  | schema_ad_hoc_migration_stmt
  | schema_unsub_stmt
  | schema_upgrade_script_stmt
  | schema_upgrade_version_stmt
  | set_stmt
  | switch_stmt
  | throw_stmt
  | trycatch_stmt
  | update_cursor_stmt
  | update_stmt
  | upsert_stmt
  | while_stmt
  | with_delete_stmt
  | with_insert_stmt
  | with_update_stmt
  | with_upsert_stmt
  ;

explain_stmt:
  &quot;EXPLAIN&quot; opt_query_plan explain_target
  ;

opt_query_plan:
  /* nil */
  | &quot;QUERY PLAN&quot;
  ;

explain_target: select_stmt
  | update_stmt
  | delete_stmt
  | with_delete_stmt
  | with_insert_stmt
  | with_update_stmt
  | with_upsert_stmt
  | insert_stmt
  | upsert_stmt
  | drop_table_stmt
  | drop_view_stmt
  | drop_index_stmt
  | drop_trigger_stmt
  | begin_trans_stmt
  | commit_trans_stmt
  ;

previous_schema_stmt:
  &quot;@PREVIOUS_SCHEMA&quot;
  ;

schema_upgrade_script_stmt:
  &quot;@SCHEMA_UPGRADE_SCRIPT&quot;
  ;

schema_upgrade_version_stmt:
  &quot;@SCHEMA_UPGRADE_VERSION&quot; &#39;(&#39; &quot;integer-literal&quot; &#39;)&#39;
  ;

set_stmt:
  &quot;SET&quot; name &quot;:=&quot; expr
  | &quot;SET&quot; name &quot;FROM&quot; &quot;CURSOR&quot; name
  ;

let_stmt:
  &quot;LET&quot; name &quot;:=&quot; expr
  ;

version_attrs_opt_recreate:
  /* nil */
  | &quot;@RECREATE&quot;  opt_delete_plain_attr
  | &quot;@RECREATE&quot; &#39;(&#39; name &#39;)&#39;  opt_delete_plain_attr
  | version_attrs
  ;

opt_delete_plain_attr:
  /* nil */
  | &quot;@DELETE&quot;
  ;

opt_version_attrs:
  /* nil */
  | version_attrs
  ;

version_attrs:
  &quot;@CREATE&quot; version_annotation opt_version_attrs
  | &quot;@DELETE&quot; version_annotation opt_version_attrs
  ;

opt_delete_version_attr:
  /* nil */
  | &quot;@DELETE&quot; version_annotation
  ;

drop_table_stmt:
  &quot;DROP&quot; &quot;TABLE&quot; &quot;IF&quot; &quot;EXISTS&quot; name
  | &quot;DROP&quot; &quot;TABLE&quot; name
  ;

drop_view_stmt:
  &quot;DROP&quot; &quot;VIEW&quot; &quot;IF&quot; &quot;EXISTS&quot; name
  | &quot;DROP&quot; &quot;VIEW&quot; name
  ;

drop_index_stmt:
  &quot;DROP&quot; &quot;INDEX&quot; &quot;IF&quot; &quot;EXISTS&quot; name
  | &quot;DROP&quot; &quot;INDEX&quot; name
  ;

drop_trigger_stmt:
  &quot;DROP&quot; &quot;TRIGGER&quot; &quot;IF&quot; &quot;EXISTS&quot; name
  | &quot;DROP&quot; &quot;TRIGGER&quot; name
  ;

create_virtual_table_stmt: &quot;CREATE&quot; &quot;VIRTUAL&quot; &quot;TABLE&quot; opt_vtab_flags name
                           &quot;USING&quot; name opt_module_args
                           &quot;AS&quot; &#39;(&#39; col_key_list &#39;)&#39; opt_delete_version_attr ;

opt_module_args: /* nil */
  | &#39;(&#39; misc_attr_value_list &#39;)&#39;
  | &#39;(&#39; &quot;ARGUMENTS&quot; &quot;FOLLOWING&quot; &#39;)&#39;
  ;

create_table_prefix_opt_temp:
  &quot;CREATE&quot; opt_temp &quot;TABLE&quot; ;

create_table_stmt:
  create_table_prefix_opt_temp opt_if_not_exists name &#39;(&#39; col_key_list &#39;)&#39; opt_no_rowid version_attrs_opt_recreate
  ;

opt_temp:
  /* nil */
  | &quot;TEMP&quot;
  ;

opt_if_not_exists:
  /* nil */
  | &quot;IF&quot; &quot;NOT&quot; &quot;EXISTS&quot;
  ;

opt_no_rowid:
  /* nil */
  | &quot;WITHOUT&quot; &quot;ROWID&quot;
  ;

opt_vtab_flags:
  /* nil */
  | &quot;IF&quot; &quot;NOT&quot; &quot;EXISTS&quot;
  | &quot;@EPONYMOUS&quot;
  | &quot;@EPONYMOUS&quot; &quot;IF&quot; &quot;NOT&quot; &quot;EXISTS&quot;
  | &quot;IF&quot; &quot;NOT&quot; &quot;EXISTS&quot; &quot;@EPONYMOUS&quot;
  ;

col_key_list:
  col_key_def
  | col_key_def &#39;,&#39; col_key_list
  ;

col_key_def:
  col_def
  | pk_def
  | fk_def
  | unq_def
  | check_def
  | shape_def
  ;

check_def:
  &quot;CONSTRAINT&quot; name &quot;CHECK&quot; &#39;(&#39; expr &#39;)&#39;
  | &quot;CHECK&quot; &#39;(&#39; expr &#39;)&#39;
  ;

shape_exprs :
  shape_expr &#39;,&#39; shape_exprs
  | shape_expr
  ;

shape_expr:
  name
  | &#39;-&#39; name
  ;

shape_def:
    shape_def_base
  | shape_def_base &#39;(&#39; shape_exprs &#39;)&#39;
  ;

shape_def_base:
    &quot;LIKE&quot; name
  | &quot;LIKE&quot; name &quot;ARGUMENTS&quot;
  ;

col_name:
  name
  ;

misc_attr_key:
  name
  | name &#39;:&#39; name
  ;

cql_attr_key:
  name
  | name &#39;:&#39; name
  ;

misc_attr_value_list:
  misc_attr_value
  | misc_attr_value &#39;,&#39; misc_attr_value_list
  ;

misc_attr_value:
  name
  | any_literal
  | const_expr
  | &#39;(&#39; misc_attr_value_list &#39;)&#39;
  | &#39;-&#39; num_literal
  | &#39;+&#39; num_literal
  ;

misc_attr:
  &quot;@ATTRIBUTE&quot; &#39;(&#39; misc_attr_key &#39;)&#39;
  | &quot;@ATTRIBUTE&quot; &#39;(&#39; misc_attr_key &#39;=&#39; misc_attr_value &#39;)&#39;
  | &#39;[&#39; &#39;[&#39; cql_attr_key &#39;]&#39; &#39;]&#39;
  | &#39;[&#39; &#39;[&#39; cql_attr_key  &#39;=&#39; misc_attr_value &#39;]&#39; &#39;]&#39;
  ;

misc_attrs:
  /* nil */
  | misc_attr misc_attrs
  ;

col_def:
  misc_attrs col_name data_type_any col_attrs
  ;

pk_def:
  &quot;CONSTRAINT&quot; name &quot;PRIMARY&quot; &quot;KEY&quot; &#39;(&#39; indexed_columns &#39;)&#39; opt_conflict_clause
  | &quot;PRIMARY&quot; &quot;KEY&quot; &#39;(&#39; indexed_columns &#39;)&#39; opt_conflict_clause
  ;

opt_conflict_clause:
  /* nil */
  | conflict_clause
  ;

conflict_clause:
  &quot;ON CONFLICT&quot; &quot;ROLLBACK&quot;
  | &quot;ON CONFLICT&quot; &quot;ABORT&quot;
  | &quot;ON CONFLICT&quot; &quot;FAIL&quot;
  | &quot;ON CONFLICT&quot; &quot;IGNORE&quot;
  | &quot;ON CONFLICT&quot; &quot;REPLACE&quot;
  ;

opt_fk_options:
  /* nil */
  | fk_options
  ;

fk_options:
  fk_on_options
  | fk_deferred_options
  | fk_on_options fk_deferred_options
  ;

fk_on_options:
  &quot;ON&quot; &quot;DELETE&quot; fk_action
  | &quot;ON&quot; &quot;UPDATE&quot; fk_action
  | &quot;ON&quot; &quot;UPDATE&quot; fk_action &quot;ON&quot; &quot;DELETE&quot; fk_action
  | &quot;ON&quot; &quot;DELETE&quot; fk_action &quot;ON&quot; &quot;UPDATE&quot; fk_action
  ;

fk_action:
  &quot;SET&quot; &quot;NULL&quot;
  | &quot;SET&quot; &quot;DEFAULT&quot;
  | &quot;CASCADE&quot;
  | &quot;RESTRICT&quot;
  | &quot;NO&quot; &quot;ACTION&quot;
  ;

fk_deferred_options:
  &quot;DEFERRABLE&quot; fk_initial_state
  | &quot;NOT DEFERRABLE&quot; fk_initial_state
  ;

fk_initial_state:
  /* nil */
  | &quot;INITIALLY&quot; &quot;DEFERRED&quot;
  | &quot;INITIALLY&quot; &quot;IMMEDIATE&quot;
  ;

fk_def:
  &quot;CONSTRAINT&quot; name &quot;FOREIGN&quot; &quot;KEY&quot; &#39;(&#39; name_list &#39;)&#39; fk_target_options
  | &quot;FOREIGN&quot; &quot;KEY&quot; &#39;(&#39; name_list &#39;)&#39; fk_target_options
  ;

fk_target_options:
  &quot;REFERENCES&quot; name &#39;(&#39; name_list &#39;)&#39; opt_fk_options
  ;

unq_def:
  &quot;CONSTRAINT&quot; name &quot;UNIQUE&quot; &#39;(&#39; indexed_columns &#39;)&#39; opt_conflict_clause
  | &quot;UNIQUE&quot; &#39;(&#39; indexed_columns &#39;)&#39; opt_conflict_clause
  ;

opt_unique:
  /* nil */
  | &quot;UNIQUE&quot;
  ;

indexed_column:
  expr opt_asc_desc
  ;

indexed_columns:
  indexed_column
  | indexed_column &#39;,&#39; indexed_columns
  ;

create_index_stmt:
  &quot;CREATE&quot; opt_unique &quot;INDEX&quot; opt_if_not_exists name &quot;ON&quot; name &#39;(&#39; indexed_columns &#39;)&#39; opt_where opt_delete_version_attr
  ;

name:
  &quot;ID&quot;
  | &quot;TEXT&quot;
  | &quot;TRIGGER&quot;
  | &quot;ROWID&quot;
  | &quot;REPLACE&quot;
  | &quot;KEY&quot;
  | &quot;VIRTUAL&quot;
  | &quot;TYPE&quot;
  | &quot;HIDDEN&quot;
  | &quot;PRIVATE&quot;
  | &quot;FIRST&quot;
  | &quot;LAST&quot;
  ;

opt_name:
  /* nil */
  | name
  ;

name_list:
  name
  |  name &#39;,&#39; name_list
  ;

opt_name_list:
  /* nil */
  | name_list
  ;

cte_binding_list:
  cte_binding
  | cte_binding &#39;,&#39; cte_binding_list
  ;

cte_binding: name name
  | name &quot;AS&quot; name
  ;

col_attrs:
  /* nil */
  | &quot;NOT&quot; &quot;NULL&quot; opt_conflict_clause col_attrs
  | &quot;PRIMARY&quot; &quot;KEY&quot; opt_conflict_clause col_attrs
  | &quot;PRIMARY&quot; &quot;KEY&quot; opt_conflict_clause &quot;AUTOINCREMENT&quot; col_attrs
  | &quot;DEFAULT&quot; &#39;-&#39; num_literal col_attrs
  | &quot;DEFAULT&quot; &#39;+&#39; num_literal col_attrs
  | &quot;DEFAULT&quot; num_literal col_attrs
  | &quot;DEFAULT&quot; const_expr col_attrs
  | &quot;DEFAULT&quot; str_literal col_attrs
  | &quot;COLLATE&quot; name col_attrs
  | &quot;CHECK&quot; &#39;(&#39; expr &#39;)&#39; col_attrs
  | &quot;UNIQUE&quot; opt_conflict_clause col_attrs
  | &quot;HIDDEN&quot; col_attrs
  | &quot;@SENSITIVE&quot; col_attrs
  | &quot;@CREATE&quot; version_annotation col_attrs
  | &quot;@DELETE&quot; version_annotation col_attrs
  | fk_target_options col_attrs
  ;

version_annotation:
  &#39;(&#39; &quot;integer-literal&quot; &#39;,&#39; name &#39;)&#39;
  | &#39;(&#39; &quot;integer-literal&quot; &#39;,&#39; name &#39;:&#39; name &#39;)&#39;
  | &#39;(&#39; &quot;integer-literal&quot; &#39;)&#39;
  ;

opt_kind:
  /* nil */
  | &#39;&lt;&#39; name &#39;&gt;&#39;
  ;

data_type_numeric:
  &quot;INT&quot; opt_kind
  | &quot;INTEGER&quot; opt_kind
  | &quot;REAL&quot; opt_kind
  | &quot;LONG&quot; opt_kind
  | &quot;BOOL&quot; opt_kind
  | &quot;LONG&quot; &quot;INTEGER&quot; opt_kind
  | &quot;LONG&quot; &quot;INT&quot; opt_kind
  | &quot;LONG_INT&quot; opt_kind
  | &quot;LONG_INTEGER&quot; opt_kind
  ;

data_type_any:
  data_type_numeric
  | &quot;TEXT&quot;  opt_kind
  | &quot;BLOB&quot;  opt_kind
  | &quot;OBJECT&quot; opt_kind
  | &quot;OBJECT&quot; &#39;&lt;&#39; name &quot;CURSOR&quot; &#39;&gt;&#39;
  | &quot;OBJECT&quot; &#39;&lt;&#39; name &quot;SET&quot; &#39;&gt;&#39;
  | &quot;ID&quot;
  ;

data_type_with_options:
  data_type_any
  | data_type_any &quot;NOT&quot; &quot;NULL&quot;
  | data_type_any &quot;@SENSITIVE&quot;
  | data_type_any &quot;@SENSITIVE&quot; &quot;NOT&quot; &quot;NULL&quot;
  | data_type_any &quot;NOT&quot; &quot;NULL&quot; &quot;@SENSITIVE&quot;
  ;

str_literal:
  str_chain
  ;

str_chain:
  str_leaf
  | str_leaf str_chain
  ;

str_leaf:
  &quot;sql-string-literal&quot;
  | &quot;c-string-literal&quot;
  ;

num_literal:
  &quot;integer-literal&quot;
  | &quot;long-literal&quot;
  | &quot;real-literal&quot;
  | &quot;TRUE&quot;
  | &quot;FALSE&quot;
  ;

const_expr:
  &quot;CONST&quot; &#39;(&#39; expr &#39;)&#39;
  ;

any_literal:
  str_literal
  | num_literal
  | &quot;NULL&quot;
  | &quot;@FILE&quot; &#39;(&#39; str_literal &#39;)&#39;
  | &quot;@PROC&quot;
  | &quot;sql-blob-literal&quot;
  ;

raise_expr:
  &quot;RAISE&quot; &#39;(&#39; &quot;IGNORE&quot; &#39;)&#39;
  | &quot;RAISE&quot; &#39;(&#39; &quot;ROLLBACK&quot; &#39;,&#39;  expr &#39;)&#39;
  | &quot;RAISE&quot; &#39;(&#39; &quot;ABORT&quot; &#39;,&#39;  expr &#39;)&#39;
  | &quot;RAISE&quot; &#39;(&#39; &quot;FAIL&quot; &#39;,&#39;  expr &#39;)&#39;
  ;

call:
  name &#39;(&#39; arg_list &#39;)&#39; opt_filter_clause
  | name &#39;(&#39; &quot;DISTINCT&quot; arg_list &#39;)&#39; opt_filter_clause
  | basic_expr &#39;:&#39; name &#39;(&#39; arg_list &#39;)&#39;
  ;

basic_expr:
  name
  | &quot;@RC&quot;
  | name &#39;.&#39; name
  | any_literal
  | const_expr
  | &#39;(&#39; expr &#39;)&#39;
  | call
  | window_func_inv
  | raise_expr
  | &#39;(&#39; select_stmt &#39;)&#39;
  | &#39;(&#39; select_stmt &quot;IF&quot; &quot;NOTHING&quot; expr &#39;)&#39;
  | &#39;(&#39; select_stmt &quot;IF&quot; &quot;NOTHING&quot; &quot;OR&quot; &quot;NULL&quot; expr &#39;)&#39;
  | &#39;(&#39; select_stmt &quot;IF&quot; &quot;NOTHING&quot; &quot;THROW&quot;&#39;)&#39;
  | &quot;EXISTS&quot; &#39;(&#39; select_stmt &#39;)&#39;
  | &quot;CASE&quot; expr case_list &quot;END&quot;
  | &quot;CASE&quot; expr case_list &quot;ELSE&quot; expr &quot;END&quot;
  | &quot;CASE&quot; case_list &quot;END&quot;
  | &quot;CASE&quot; case_list &quot;ELSE&quot; expr &quot;END&quot;
  | &quot;CAST&quot; &#39;(&#39; expr &quot;AS&quot; data_type_any &#39;)&#39;
  | &quot;TYPE_CHECK&quot; &#39;(&#39; expr &quot;AS&quot; data_type_with_options &#39;)&#39;

math_expr:
  basic_expr
  | math_expr &#39;&amp;&#39; math_expr
  | math_expr &#39;|&#39; math_expr
  | math_expr &quot;&lt;&lt;&quot; math_expr
  | math_expr &quot;&gt;&gt;&quot;  math_expr
  | math_expr &#39;+&#39; math_expr
  | math_expr &#39;-&#39; math_expr
  | math_expr &#39;*&#39; math_expr
  | math_expr &#39;/&#39; math_expr
  | math_expr &#39;%&#39; math_expr
  | math_expr &quot;IS NOT TRUE&quot;
  | math_expr &quot;IS NOT FALSE&quot;
  | math_expr &quot;ISNULL&quot;
  | math_expr &quot;NOTNULL&quot;
  | math_expr &quot;IS TRUE&quot;
  | math_expr &quot;IS FALSE&quot;
  | &#39;-&#39; math_expr
  | &#39;+&#39; math_expr
  | &#39;~&#39; math_expr
  | &quot;NOT&quot; math_expr
  | math_expr &#39;=&#39; math_expr
  | math_expr &quot;==&quot; math_expr
  | math_expr &#39;&lt;&#39; math_expr
  | math_expr &#39;&gt;&#39; math_expr
  | math_expr &quot;&lt;&gt;&quot; math_expr
  | math_expr &quot;!=&quot; math_expr
  | math_expr &quot;&gt;=&quot; math_expr
  | math_expr &quot;&lt;=&quot; math_expr
  | math_expr &quot;NOT IN&quot; &#39;(&#39; expr_list &#39;)&#39;
  | math_expr &quot;NOT IN&quot; &#39;(&#39; select_stmt &#39;)&#39;
  | math_expr &quot;IN&quot; &#39;(&#39; expr_list &#39;)&#39;
  | math_expr &quot;IN&quot; &#39;(&#39; select_stmt &#39;)&#39;
  | math_expr &quot;LIKE&quot; math_expr
  | math_expr &quot;NOT LIKE&quot; math_expr
  | math_expr &quot;MATCH&quot; math_expr
  | math_expr &quot;NOT MATCH&quot; math_expr
  | math_expr &quot;REGEXP&quot; math_expr
  | math_expr &quot;NOT REGEXP&quot; math_expr
  | math_expr &quot;GLOB&quot; math_expr
  | math_expr &quot;NOT GLOB&quot; math_expr
  | math_expr &quot;BETWEEN&quot; math_expr &quot;AND&quot; math_expr
  | math_expr &quot;NOT BETWEEN&quot; math_expr &quot;AND&quot; math_expr
  | math_expr &quot;IS NOT&quot; math_expr
  | math_expr &quot;IS&quot; math_expr
  | math_expr &quot;||&quot; math_expr
  | math_expr &quot;COLLATE&quot; name
  ;

expr:
  math_expr
  | expr &quot;AND&quot; expr
  | expr &quot;OR&quot; expr
  ;

case_list:
  &quot;WHEN&quot; expr &quot;THEN&quot; expr
  | &quot;WHEN&quot; expr &quot;THEN&quot; expr case_list
  ;

arg_expr: &#39;*&#39;
  | expr
  | shape_arguments
  ;

arg_list:
  /* nil */
  | arg_expr
  | arg_expr &#39;,&#39; arg_list
  ;

expr_list:
  expr
  | expr &#39;,&#39; expr_list
  ;

shape_arguments:
  &quot;FROM&quot; name
  | &quot;FROM&quot; name shape_def
  | &quot;FROM&quot; &quot;ARGUMENTS&quot;
  | &quot;FROM&quot; &quot;ARGUMENTS&quot; shape_def
  ;

column_calculation:
  &quot;COLUMNS&quot; &#39;(&#39; col_calcs &#39;)&#39;
  | &quot;COLUMNS&quot; &#39;(&#39; &quot;DISTINCT&quot; col_calcs &#39;)&#39;
  ;

col_calcs:
  col_calc
  | col_calc &#39;,&#39; col_calcs
  ;

col_calc:
  name
  | shape_def
  | name shape_def
  | name &#39;.&#39; name
  ;

call_expr:
  expr
  | shape_arguments
  ;

call_expr_list:
  call_expr
  | call_expr &#39;,&#39; call_expr_list
  ;

cte_tables:
  cte_table
  | cte_table &#39;,&#39; cte_tables
  ;

cte_decl:
  name &#39;(&#39; name_list &#39;)&#39;
  | name &#39;(&#39; &#39;*&#39; &#39;)&#39;
  ;

shared_cte:
  call_stmt
  | call_stmt &quot;USING&quot; cte_binding_list
  ;

cte_table:
  cte_decl &quot;AS&quot; &#39;(&#39; select_stmt &#39;)&#39;
  | cte_decl &quot;AS&quot; &#39;(&#39; shared_cte&#39;)&#39;
  | &#39;(&#39; call_stmt &#39;)&#39;
  | &#39;(&#39; call_stmt &quot;USING&quot; cte_binding_list &#39;)&#39;
  | cte_decl &quot;LIKE&quot; &#39;(&#39; select_stmt &#39;)&#39;
  | cte_decl &quot;LIKE&quot; name
  ;

with_prefix:
  &quot;WITH&quot; cte_tables
  | &quot;WITH&quot; &quot;RECURSIVE&quot; cte_tables
  ;

with_select_stmt:
  with_prefix select_stmt_no_with
  ;

select_nothing_stmt:
  &quot;SELECT&quot; &quot;NOTHING&quot;
  ;

select_stmt:
  with_select_stmt
  | select_stmt_no_with
  ;

select_stmt_no_with:
  select_core_list opt_orderby opt_limit opt_offset
  ;

select_core_list:
  select_core
  | select_core compound_operator select_core_list
  ;

values:
  &#39;(&#39; insert_list &#39;)&#39;
  | &#39;(&#39; insert_list &#39;)&#39; &#39;,&#39; values
  ;

select_core:
  &quot;SELECT&quot; select_opts select_expr_list opt_from_query_parts opt_where opt_groupby opt_having opt_select_window
  | &quot;VALUES&quot; values
  ;

compound_operator:
  &quot;UNION&quot;
  | &quot;UNION ALL&quot;
  | &quot;INTERSECT&quot;
  | &quot;EXCEPT&quot;
  ;

window_func_inv:
  name &#39;(&#39; arg_list &#39;)&#39; opt_filter_clause &quot;OVER&quot; window_name_or_defn
  ;

opt_filter_clause:
  /* nil */
  | &quot;FILTER&quot; &#39;(&#39; opt_where &#39;)&#39;
  ;

window_name_or_defn: window_defn
  | name
  ;

window_defn:
  &#39;(&#39; opt_partition_by opt_orderby opt_frame_spec &#39;)&#39;
  ;

opt_frame_spec:
  /* nil */
  | frame_type frame_boundary_opts frame_exclude
  ;

frame_type:
  &quot;RANGE&quot;
  | &quot;ROWS&quot;
  | &quot;GROUPS&quot;
  ;

frame_exclude:
  /* nil */
  | &quot;EXCLUDE NO OTHERS&quot;
  | &quot;EXCLUDE CURRENT ROW&quot;
  | &quot;EXCLUDE GROUP&quot;
  | &quot;EXCLUDE TIES&quot;
  ;

frame_boundary_opts:
  frame_boundary
  | &quot;BETWEEN&quot; frame_boundary_start &quot;AND&quot; frame_boundary_end
  ;

frame_boundary_start:
  &quot;UNBOUNDED&quot; &quot;PRECEDING&quot;
  | expr &quot;PRECEDING&quot;
  | &quot;CURRENT ROW&quot;
  | expr &quot;FOLLOWING&quot;
  ;

frame_boundary_end:
  expr &quot;PRECEDING&quot;
  | &quot;CURRENT ROW&quot;
  | expr &quot;FOLLOWING&quot;
  | &quot;UNBOUNDED&quot; &quot;FOLLOWING&quot;
  ;

frame_boundary:
  &quot;UNBOUNDED&quot; &quot;PRECEDING&quot;
  | expr &quot;PRECEDING&quot;
  | &quot;CURRENT ROW&quot;
  ;

opt_partition_by:
  /* nil */
  | &quot;PARTITION&quot; &quot;BY&quot; expr_list
  ;

opt_select_window:
  /* nil */
  | window_clause
  ;

window_clause:
  &quot;WINDOW&quot; window_name_defn_list
  ;

window_name_defn_list:
  window_name_defn
  | window_name_defn &#39;,&#39; window_name_defn_list
  ;

window_name_defn:
  name &quot;AS&quot; window_defn
  ;

region_spec:
    name
  | name &quot;PRIVATE&quot;
  ;

region_list:
  region_spec &#39;,&#39; region_list
  | region_spec
  ;

declare_schema_region_stmt:
  &quot;@DECLARE_SCHEMA_REGION&quot; name
  | &quot;@DECLARE_SCHEMA_REGION&quot; name &quot;USING&quot; region_list
  ;

declare_deployable_region_stmt:
  &quot;@DECLARE_DEPLOYABLE_REGION&quot;  name
  | &quot;@DECLARE_DEPLOYABLE_REGION&quot; name &quot;USING&quot; region_list
  ;

begin_schema_region_stmt:
  &quot;@BEGIN_SCHEMA_REGION&quot; name
  ;

end_schema_region_stmt:
  &quot;@END_SCHEMA_REGION&quot;
  ;

schema_unsub_stmt:
  &quot;@UNSUB&quot;  &#39;(&#39; name &#39;)&#39;
  ;

schema_ad_hoc_migration_stmt:
  &quot;@SCHEMA_AD_HOC_MIGRATION&quot; version_annotation
  | &quot;@SCHEMA_AD_HOC_MIGRATION&quot; &quot;FOR&quot; &quot;@RECREATE&quot; &#39;(&#39; name &#39;,&#39; name &#39;)&#39;
  ;

emit_enums_stmt:
  &quot;@EMIT_ENUMS&quot; opt_name_list
  ;

emit_group_stmt:
  &quot;@EMIT_GROUP&quot; opt_name_list
  ;

emit_constants_stmt:
  &quot;@EMIT_CONSTANTS&quot; name_list
  ;

opt_from_query_parts:
  /* nil */
  | &quot;FROM&quot; query_parts
  ;

opt_where:
  /* nil */
  | &quot;WHERE&quot; expr
  ;

opt_groupby:
  /* nil */
  | &quot;GROUP&quot; &quot;BY&quot; groupby_list
  ;

groupby_list:
  groupby_item
  | groupby_item &#39;,&#39; groupby_list
  ;

groupby_item:
  expr
  ;

opt_asc_desc:
  /* nil */
  | &quot;ASC&quot;  opt_nullsfirst_nullslast
  | &quot;DESC&quot;  opt_nullsfirst_nullslast
  ;

opt_nullsfirst_nullslast:
  /* nil */
  | &quot;NULLS&quot; &quot;FIRST&quot;
  | &quot;NULLS&quot; &quot;LAST&quot;
  ;

opt_having:
  /* nil */
  | &quot;HAVING&quot; expr
  ;

opt_orderby:
  /* nil */
  | &quot;ORDER&quot; &quot;BY&quot; orderby_list
  ;

orderby_list:
  orderby_item
  | orderby_item &#39;,&#39; orderby_list
  ;

orderby_item:
  expr opt_asc_desc
  ;

opt_limit:
  /* nil */
  | &quot;LIMIT&quot; expr
  ;

opt_offset:
  /* nil */
  | &quot;OFFSET&quot; expr
  ;

select_opts:
  /* nil */
  | &quot;ALL&quot;
  | &quot;DISTINCT&quot;
  | &quot;DISTINCTROW&quot;
  ;

select_expr_list:
  select_expr
  | select_expr &#39;,&#39; select_expr_list
  | &#39;*&#39;
  ;

select_expr:
  expr opt_as_alias
  | name &#39;.&#39; &#39;*&#39;
  | column_calculation
  ;

opt_as_alias:
  /* nil */
  | as_alias
  ;

as_alias:
  &quot;AS&quot; name
  | name
  ;

query_parts:
  table_or_subquery_list
  | join_clause
  ;

table_or_subquery_list:
  table_or_subquery
  | table_or_subquery &#39;,&#39; table_or_subquery_list
  ;

join_clause:
  table_or_subquery join_target_list
  ;

join_target_list:
  join_target
  | join_target join_target_list
  ;

table_or_subquery:
  name opt_as_alias
  | &#39;(&#39; select_stmt &#39;)&#39; opt_as_alias
  | &#39;(&#39; shared_cte &#39;)&#39; opt_as_alias
  | table_function opt_as_alias
  | &#39;(&#39; query_parts &#39;)&#39;
  ;

join_type:
  /*nil */
  | &quot;LEFT&quot;
  | &quot;RIGHT&quot;
  | &quot;LEFT&quot; &quot;OUTER&quot;
  | &quot;RIGHT&quot; &quot;OUTER&quot;
  | &quot;INNER&quot;
  | &quot;CROSS&quot;
  ;

join_target: join_type &quot;JOIN&quot; table_or_subquery opt_join_cond
  ;

opt_join_cond:
  /* nil */
  | join_cond
  ;

join_cond:
  &quot;ON&quot; expr
  | &quot;USING&quot; &#39;(&#39; name_list &#39;)&#39;
  ;

table_function:
  name &#39;(&#39; arg_list &#39;)&#39;
  ;

create_view_stmt:
  &quot;CREATE&quot; opt_temp &quot;VIEW&quot; opt_if_not_exists name &quot;AS&quot; select_stmt opt_delete_version_attr
  ;

with_delete_stmt:
  with_prefix delete_stmt
  ;

delete_stmt:
  &quot;DELETE&quot; &quot;FROM&quot; name opt_where
  ;

opt_insert_dummy_spec:
  /*nil*/
  | &quot;@DUMMY_SEED&quot; &#39;(&#39; expr &#39;)&#39; dummy_modifier
  ;

dummy_modifier:
  /* nil */
  | &quot;@DUMMY_NULLABLES&quot;
  | &quot;@DUMMY_DEFAULTS&quot;
  | &quot;@DUMMY_NULLABLES&quot; &quot;@DUMMY_DEFAULTS&quot;
  | &quot;@DUMMY_DEFAULTS&quot; &quot;@DUMMY_NULLABLES&quot;
  ;

insert_stmt_type:
  &quot;INSERT&quot; &quot;INTO&quot;
  | &quot;INSERT&quot; &quot;OR&quot; &quot;REPLACE&quot; &quot;INTO&quot;
  | &quot;INSERT&quot; &quot;OR&quot; &quot;IGNORE&quot; &quot;INTO&quot;
  | &quot;INSERT&quot; &quot;OR&quot; &quot;ROLLBACK&quot; &quot;INTO&quot;
  | &quot;INSERT&quot; &quot;OR&quot; &quot;ABORT&quot; &quot;INTO&quot;
  | &quot;INSERT&quot; &quot;OR&quot; &quot;FAIL&quot; &quot;INTO&quot;
  | &quot;REPLACE&quot; &quot;INTO&quot;
  ;

with_insert_stmt:
  with_prefix insert_stmt
  ;

opt_column_spec:
  /* nil */
  | &#39;(&#39; opt_name_list &#39;)&#39;
  | &#39;(&#39; shape_def &#39;)&#39;
  ;

from_shape:
  &quot;FROM&quot; &quot;CURSOR&quot; name opt_column_spec
  | &quot;FROM&quot; name opt_column_spec
  | &quot;FROM&quot; &quot;ARGUMENTS&quot; opt_column_spec
  ;

insert_stmt:
  insert_stmt_type name opt_column_spec select_stmt opt_insert_dummy_spec
  | insert_stmt_type name opt_column_spec from_shape opt_insert_dummy_spec
  | insert_stmt_type name &quot;DEFAULT&quot; &quot;VALUES&quot;
  | insert_stmt_type name &quot;USING&quot; select_stmt
  | insert_stmt_type name &quot;USING&quot; expr_names opt_insert_dummy_spec
  ;

insert_list_item:
  expr
  | shape_arguments
  ;

insert_list:
  /* nil */
  | insert_list_item
  | insert_list_item &#39;,&#39; insert_list
  ;

basic_update_stmt:
  &quot;UPDATE&quot; opt_name &quot;SET&quot; update_list opt_from_query_parts opt_where
  ;

with_update_stmt:
  with_prefix update_stmt
  ;

update_stmt:
  &quot;UPDATE&quot; name &quot;SET&quot; update_list opt_from_query_parts opt_where opt_orderby opt_limit
  ;

update_entry:
  name &#39;=&#39; expr
  ;

update_list:
  update_entry
  | update_entry &#39;,&#39; update_list
  ;

with_upsert_stmt:
  with_prefix upsert_stmt
  ;

upsert_stmt:
  insert_stmt &quot;ON CONFLICT&quot; conflict_target &quot;DO&quot; &quot;NOTHING&quot;
  | insert_stmt &quot;ON CONFLICT&quot; conflict_target &quot;DO&quot; basic_update_stmt
  ;

update_cursor_stmt:
  &quot;UPDATE&quot; &quot;CURSOR&quot; name opt_column_spec &quot;FROM&quot; &quot;VALUES&quot; &#39;(&#39; insert_list &#39;)&#39;
  | &quot;UPDATE&quot; &quot;CURSOR&quot; name opt_column_spec from_shape
  | &quot;UPDATE&quot; &quot;CURSOR&quot; name &quot;USING&quot; expr_names
  ;

conflict_target:
  /* nil */
  | &#39;(&#39; indexed_columns &#39;)&#39; opt_where
  ;

function: &quot;FUNC&quot; | &quot;FUNCTION&quot;
  ;

declare_out_call_stmt:
  &quot;DECLARE&quot; &quot;OUT&quot; call_stmt
  ;

declare_enum_stmt:
  &quot;DECLARE&quot; &quot;ENUM&quot; name data_type_numeric &#39;(&#39; enum_values &#39;)&#39;
  ;

enum_values:
    enum_value
  | enum_value &#39;,&#39; enum_values
  ;

enum_value:
    name
  | name &#39;=&#39; expr
  ;

declare_const_stmt:
  &quot;DECLARE&quot; &quot;CONST&quot; &quot;GROUP&quot; name &#39;(&#39; const_values &#39;)&#39;
  ;

declare_group_stmt:
  &quot;DECLARE&quot; &quot;GROUP&quot; name &quot;BEGIN&quot; simple_variable_decls &quot;END&quot;
  ;

simple_variable_decls:
  declare_vars_stmt &#39;;&#39;
  | declare_vars_stmt &#39;;&#39; simple_variable_decls
  ;

const_values:
   const_value
  | const_value &#39;,&#39; const_values
  ;

const_value:  name &#39;=&#39; expr
  ;

declare_select_func_no_check_stmt:
  &quot;DECLARE&quot; &quot;SELECT&quot; function name &quot;NO&quot; &quot;CHECK&quot; data_type_with_options
  | &quot;DECLARE&quot; &quot;SELECT&quot; function name &quot;NO&quot; &quot;CHECK&quot; &#39;(&#39; typed_names &#39;)&#39;
  ;

declare_func_stmt:
  &quot;DECLARE&quot; function name &#39;(&#39; func_params &#39;)&#39; data_type_with_options
  | &quot;DECLARE&quot; &quot;SELECT&quot; function name &#39;(&#39; params &#39;)&#39; data_type_with_options
  | &quot;DECLARE&quot; function name &#39;(&#39; func_params &#39;)&#39; &quot;CREATE&quot; data_type_with_options
  | &quot;DECLARE&quot; &quot;SELECT&quot; function name &#39;(&#39; params &#39;)&#39; &#39;(&#39; typed_names &#39;)&#39;
  ;

procedure: &quot;PROC&quot; | &quot;PROCEDURE&quot;
  ;

declare_proc_no_check_stmt:
  &quot;DECLARE&quot; procedure name &quot;NO&quot; &quot;CHECK&quot;
  ;

declare_proc_stmt:
  &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &#39;(&#39; typed_names &#39;)&#39;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;USING&quot; &quot;TRANSACTION&quot;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;OUT&quot; &#39;(&#39; typed_names &#39;)&#39;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;OUT&quot; &#39;(&#39; typed_names &#39;)&#39; &quot;USING&quot; &quot;TRANSACTION&quot;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;OUT&quot; &quot;UNION&quot; &#39;(&#39; typed_names &#39;)&#39;
  | &quot;DECLARE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;OUT&quot; &quot;UNION&quot; &#39;(&#39; typed_names &#39;)&#39; &quot;USING&quot; &quot;TRANSACTION&quot;
  ;

declare_interface_stmt:
  &quot;DECLARE&quot; &quot;INTERFACE&quot; name &#39;(&#39; typed_names &#39;)&#39;
  | &quot;INTERFACE&quot; name &#39;(&#39; typed_names &#39;)&#39;
  ;

create_proc_stmt:
  &quot;CREATE&quot; procedure name &#39;(&#39; params &#39;)&#39; &quot;BEGIN&quot; opt_stmt_list &quot;END&quot;
  | procedure name &#39;(&#39; params &#39;)&#39; &quot;BEGIN&quot; opt_stmt_list &quot;END&quot;
  ;

inout:
  &quot;IN&quot;
  | &quot;OUT&quot;
  | &quot;INOUT&quot;
  ;

typed_name:
  name data_type_with_options
  | shape_def
  | name shape_def
  ;

typed_names:
  typed_name
  | typed_name &#39;,&#39; typed_names
  ;

func_param:
  param
  | name &quot;CURSOR&quot;
  ;

func_params:
  /* nil */
  | func_param
  |  func_param &#39;,&#39; func_params
  ;

param:
  name data_type_with_options
  | inout name data_type_with_options
  | shape_def
  | name shape_def
  ;

params:
  /* nil */
  | param
  |  param &#39;,&#39; params
  ;

declare_value_cursor:
  &quot;DECLARE&quot; name &quot;CURSOR&quot; shape_def
  | &quot;CURSOR&quot; name shape_def
  | &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;LIKE&quot; select_stmt
  | &quot;CURSOR&quot; name &quot;LIKE&quot; select_stmt
  | &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;LIKE&quot; &#39;(&#39; typed_names &#39;)&#39;
  | &quot;CURSOR&quot; name &quot;LIKE&quot; &#39;(&#39; typed_names &#39;)&#39;
  ;

declare_forward_read_cursor_stmt:
  &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;FOR&quot; select_stmt
  | &quot;CURSOR&quot; name &quot;FOR&quot; select_stmt
  | &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;FOR&quot; explain_stmt
  | &quot;CURSOR&quot; name &quot;FOR&quot; explain_stmt
  | &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;FOR&quot; call_stmt
  | &quot;CURSOR&quot; name &quot;FOR&quot; call_stmt
  | &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;FOR&quot; expr
  | &quot;CURSOR&quot; name &quot;FOR&quot; expr
  ;

declare_fetched_value_cursor_stmt:
  &quot;DECLARE&quot; name &quot;CURSOR&quot; &quot;FETCH&quot; &quot;FROM&quot; call_stmt
  | &quot;CURSOR&quot; name &quot;FETCH&quot; &quot;FROM&quot; call_stmt
  ;

declare_type_stmt:
  &quot;DECLARE&quot; name &quot;TYPE&quot; data_type_with_options
  | &quot;TYPE&quot; name data_type_with_options
  ;

declare_vars_stmt:
  &quot;DECLARE&quot; name_list data_type_with_options
  | &quot;VAR&quot; name_list data_type_with_options
  | declare_value_cursor
  ;

call_stmt:
  &quot;CALL&quot; name &#39;(&#39; &#39;)&#39;
  | &quot;CALL&quot; name &#39;(&#39; call_expr_list &#39;)&#39;
  | &quot;CALL&quot; name &#39;(&#39; &#39;*&#39; &#39;)&#39;
  ;

while_stmt:
  &quot;WHILE&quot; expr &quot;BEGIN&quot; opt_stmt_list &quot;END&quot;
  ;

switch_stmt:
  &quot;SWITCH&quot; expr switch_case switch_cases
  | &quot;SWITCH&quot; expr &quot;ALL&quot; &quot;VALUES&quot; switch_case switch_cases
  ;

switch_case:
  &quot;WHEN&quot; expr_list &quot;THEN&quot; stmt_list
  | &quot;WHEN&quot; expr_list &quot;THEN&quot; &quot;NOTHING&quot;
  ;

switch_cases:
  switch_case switch_cases
  | &quot;ELSE&quot; stmt_list &quot;END&quot;
  | &quot;END&quot;
  ;

loop_stmt:
  &quot;LOOP&quot; fetch_stmt &quot;BEGIN&quot; opt_stmt_list &quot;END&quot;
  ;

leave_stmt:
  &quot;LEAVE&quot;
  ;

return_stmt:
  &quot;RETURN&quot;
  ;

rollback_return_stmt:
  &quot;ROLLBACK&quot; &quot;RETURN&quot;
  ;

commit_return_stmt:
  &quot;COMMIT&quot; &quot;RETURN&quot;
  ;

throw_stmt:
  &quot;THROW&quot;
  ;

trycatch_stmt:
  &quot;BEGIN&quot; &quot;TRY&quot; opt_stmt_list &quot;END&quot; &quot;TRY&quot; &#39;;&#39; &quot;BEGIN&quot; &quot;CATCH&quot; opt_stmt_list &quot;END&quot; &quot;CATCH&quot;
  ;

continue_stmt:
  &quot;CONTINUE&quot;
  ;

fetch_stmt:
  &quot;FETCH&quot; name &quot;INTO&quot; name_list
  | &quot;FETCH&quot; name
  ;

fetch_cursor_from_blob_stmt:
  &quot;FETCH&quot; name &quot;FROM BLOB&quot; expr
  ;

fetch_values_stmt:
  &quot;FETCH&quot; name opt_column_spec &quot;FROM&quot; &quot;VALUES&quot; &#39;(&#39; insert_list &#39;)&#39; opt_insert_dummy_spec
  | &quot;FETCH&quot; name opt_column_spec from_shape opt_insert_dummy_spec
  | &quot;FETCH&quot; name &quot;USING&quot; expr_names opt_insert_dummy_spec
  ;

expr_names:
  expr_name
  |  expr_name &#39;,&#39; expr_names
  ;

expr_name: expr as_alias
  ;

fetch_call_stmt:
  &quot;FETCH&quot; name opt_column_spec &quot;FROM&quot; call_stmt
  ;

close_stmt:
  &quot;CLOSE&quot; name
  ;

out_stmt:
  &quot;OUT&quot; name
  ;

out_union_stmt:
  &quot;OUT&quot; &quot;UNION&quot; name
  ;

out_union_parent_child_stmt:
  &quot;OUT&quot; &quot;UNION&quot; call_stmt &quot;JOIN&quot; child_results
  ;

child_results:
   child_result
   | child_result &quot;AND&quot; child_results
   ;

child_result:
  call_stmt &quot;USING&quot; &#39;(&#39; name_list &#39;)&#39;
  | call_stmt &quot;USING&quot; &#39;(&#39; name_list &#39;)&#39; &quot;AS&quot; name
  ;

if_stmt:
  &quot;IF&quot; expr &quot;THEN&quot; opt_stmt_list opt_elseif_list opt_else &quot;END&quot; &quot;IF&quot;
  ;

opt_else:
  /* nil */
  | &quot;ELSE&quot; opt_stmt_list
  ;

elseif_item:
  &quot;ELSE IF&quot; expr &quot;THEN&quot; opt_stmt_list
  ;

elseif_list:
  elseif_item
  | elseif_item elseif_list
  ;

opt_elseif_list:
  /* nil */
  | elseif_list
  ;

control_stmt:
  commit_return_stmt
  | continue_stmt
  | leave_stmt
  | return_stmt
  | rollback_return_stmt
  | throw_stmt

guard_stmt:
  &quot;IF&quot; expr control_stmt
  ;

transaction_mode:
  /* nil */
  | &quot;DEFERRED&quot;
  | &quot;IMMEDIATE&quot;
  | &quot;EXCLUSIVE&quot;
  ;

begin_trans_stmt:
  &quot;BEGIN&quot; transaction_mode &quot;TRANSACTION&quot;
  | &quot;BEGIN&quot; transaction_mode
  ;

rollback_trans_stmt:
  &quot;ROLLBACK&quot;
  | &quot;ROLLBACK&quot; &quot;TRANSACTION&quot;
  | &quot;ROLLBACK&quot; &quot;TO&quot; savepoint_name
  | &quot;ROLLBACK&quot; &quot;TRANSACTION&quot; &quot;TO&quot; savepoint_name
  | &quot;ROLLBACK&quot; &quot;TO&quot; &quot;SAVEPOINT&quot; savepoint_name
  | &quot;ROLLBACK&quot; &quot;TRANSACTION&quot; &quot;TO&quot; &quot;SAVEPOINT&quot; savepoint_name
  ;

commit_trans_stmt:
  &quot;COMMIT&quot; &quot;TRANSACTION&quot;
  | &quot;COMMIT&quot;
  ;

proc_savepoint_stmt:  procedure &quot;SAVEPOINT&quot; &quot;BEGIN&quot; opt_stmt_list &quot;END&quot;
  ;

savepoint_name:
  &quot;@PROC&quot;
  | name
  ;

savepoint_stmt:
  &quot;SAVEPOINT&quot; savepoint_name
  ;

release_savepoint_stmt:
  &quot;RELEASE&quot; savepoint_name
  | &quot;RELEASE&quot; &quot;SAVEPOINT&quot; savepoint_name
  ;

echo_stmt:
  &quot;@ECHO&quot; name &#39;,&#39; str_literal
  ;

alter_table_add_column_stmt:
  &quot;ALTER&quot; &quot;TABLE&quot; name &quot;ADD&quot; &quot;COLUMN&quot; col_def
  ;

create_trigger_stmt:
  &quot;CREATE&quot; opt_temp &quot;TRIGGER&quot; opt_if_not_exists trigger_def opt_delete_version_attr
  ;

trigger_def:
  name trigger_condition trigger_operation &quot;ON&quot; name trigger_action
  ;

trigger_condition:
  /* nil */
  | &quot;BEFORE&quot;
  | &quot;AFTER&quot;
  | &quot;INSTEAD&quot; &quot;OF&quot;
 ;

trigger_operation:
  &quot;DELETE&quot;
  | &quot;INSERT&quot;
  | &quot;UPDATE&quot; opt_of
  ;

opt_of:
  /* nil */
  | &quot;OF&quot; name_list
  ;

trigger_action:
  opt_foreachrow opt_when_expr &quot;BEGIN&quot; trigger_stmts &quot;END&quot;
  ;

opt_foreachrow:
  /* nil */
  | &quot;FOR EACH ROW&quot;
  ;

opt_when_expr:
  /* nil */
  | &quot;WHEN&quot; expr
  ;

trigger_stmts:
  trigger_stmt
  | trigger_stmt  trigger_stmts
  ;

trigger_stmt:
  trigger_update_stmt &#39;;&#39;
  | trigger_insert_stmt &#39;;&#39;
  | trigger_delete_stmt &#39;;&#39;
  | trigger_select_stmt &#39;;&#39;
  ;

trigger_select_stmt:
  select_stmt_no_with
  ;

trigger_insert_stmt:
  insert_stmt
  ;

trigger_delete_stmt:
  delete_stmt
  ;

trigger_update_stmt:
  basic_update_stmt
  ;

enforcement_options:
  &quot;FOREIGN&quot; &quot;KEY&quot; &quot;ON&quot; &quot;UPDATE&quot;
  | &quot;FOREIGN&quot; &quot;KEY&quot; &quot;ON&quot; &quot;DELETE&quot;
  | &quot;JOIN&quot;
  | &quot;UPSERT&quot; &quot;STATEMENT&quot;
  | &quot;WINDOW&quot; function
  | &quot;WITHOUT&quot; &quot;ROWID&quot;
  | &quot;TRANSACTION&quot;
  | &quot;SELECT&quot; &quot;IF&quot; &quot;NOTHING&quot;
  | &quot;INSERT&quot; &quot;SELECT&quot;
  | &quot;TABLE&quot; &quot;FUNCTION&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT COLUMN&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;INTEGER&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;LONG_INTEGER&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;REAL&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;BOOL&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;TEXT&quot;
  | &quot;ENCODE&quot; &quot;CONTEXT TYPE&quot; &quot;BLOB&quot;
  | &quot;IS TRUE&quot;
  | &quot;CAST&quot;
  | &quot;SIGN FUNCTION&quot;
  | &quot;CURSOR HAS ROW&quot;
  | &quot;UPDATE&quot; &quot;FROM&quot;
  ;

enforce_strict_stmt:
  &quot;@ENFORCE_STRICT&quot; enforcement_options
  ;

enforce_normal_stmt:
  &quot;@ENFORCE_NORMAL&quot; enforcement_options
  ;

enforce_reset_stmt:
  &quot;@ENFORCE_RESET&quot;
  ;

enforce_push_stmt:
  &quot;@ENFORCE_PUSH&quot;
  ;

enforce_pop_stmt:
  &quot;@ENFORCE_POP&quot;
  ;

opt_use_offset:
  /* nil */
  | &quot;OFFSET&quot;
  ;

blob_get_key_type_stmt:
  &quot;@BLOB_GET_KEY_TYPE&quot; name
  ;

blob_get_val_type_stmt:
  &quot;@BLOB_GET_VAL_TYPE&quot; name
  ;

blob_get_key_stmt:
  &quot;@BLOB_GET_KEY&quot; name opt_use_offset
  ;

blob_get_val_stmt:
  &quot;@BLOB_GET_VAL&quot; name opt_use_offset
  ;

blob_create_key_stmt:
  &quot;@BLOB_CREATE_KEY&quot; name opt_use_offset
  ;

blob_create_val_stmt:
  &quot;@BLOB_CREATE_VAL&quot; name opt_use_offset
  ;

blob_update_key_stmt:
  &quot;@BLOB_UPDATE_KEY&quot; name opt_use_offset
  ;

blob_update_val_stmt:
  &quot;@BLOB_UPDATE_VAL&quot; name opt_use_offset
  ;
</code></pre>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-3-control-directives">Appendix 3: Control
Directives</h2>
<p>The control directives are those statements that begin with
<code>@</code> and they are distinguished from other statements because
they influence the compiler rather than the program logic. Some of these
are of great importance and discussed elsewhere.</p>
<p>The complete list (as of this writing) is:</p>
<p><code>@ENFORCE_STRICT</code> <code>@ENFORCE_NORMAL</code></p>
<ul>
<li>These enable or disable more strict semanic checking the sub options
are
<ul>
<li><code>FOREIGN KEY ON UPDATE</code>: all FK’s must choose some
<code>ON UPDATE</code> strategy</li>
<li><code>FOREIGN KEY ON DELETE</code>: all FK’s must choose some
<code>ON DELETE</code> strategy</li>
<li><code>PROCEDURE</code>: all procedures must be declared before they
are called (eliminating the vanilla <code>C</code> call option)</li>
<li><code>JOIN</code>: all joins must be ANSI style, the form
<code>FROM A,B</code> is not allowed (replace with
<code>A INNER JOIN B</code></li>
<li><code>WINDOW FUNC</code>: window functions are disallowed (useful if
targeting old versions of SQLite)</li>
<li><code>UPSERT STATEMENT</code>: the upsert form is disallowed (useful
if targeting old versions of SQLite)</li>
</ul></li>
</ul>
<p><code>@SENSITIVE</code> * marks a column or variable as ‘sensitive’
for privacy purposes, this behaves somewhat like nullability (See
Chapter 3) in that it is radioactive, contaminating anything it touches
* the intent of this annotation is to make it clear where sensitive data
is being returned or consumed in your procedures * this information
appears in the JSON output for further codegen or for analysis (See
Chapter 13)</p>
<p><code>@DECLARE_SCHEMA_REGION</code>
<code>@DECLARE_DEPLOYABLE_REGION</code>
<code>@BEGIN_SCHEMA_REGION</code> <code>@END_SCHEMA_REGION</code></p>
<ul>
<li>These directives control the declaration of schema regions and allow
you to place things into those regions – see <a
href="#chapter-10-schema-management-features">Chapter 10</a></li>
</ul>
<p><code>@SCHEMA_AD_HOC_MIGRATION</code> * Allows for the creation of a
ad hoc migration step at a given schema version, (See Chapter 10)</p>
<p><code>@ECHO</code> * Emits text into the C output stream, useful for
emiting things like function prototypes or preprocessor directives *
e.g. `echo C, ‘#define foo bar’</p>
<p><code>@RECREATE</code> <code>@CREATE</code> <code>@DELETE</code> *
used to mark the schema version where an object is created or deleted,
or alternatively indicate the the object is always dropped and recreated
when it changes (See Chapter 10)</p>
<p><code>@SCHEMA_UPGRADE_VERSION</code> * used to indicate that the code
that follows is part of a migration script for the indicated schema
version * this has the effect of making the schema appear to be how it
existed at the indicated version * the idea here is that migration
procedures operate on previous versions of the schema where (e.g.) some
columns/tables hadn’t been deleted yet</p>
<p><code>@PREVIOUS_SCHEMA</code> * indicates the start of the previous
version of the schema for comparison (See Chapter 11)</p>
<p><code>@SCHEMA_UPGRADE_SCRIPT</code> * CQL emits a schema upgrade
script as part of its upgrade features, this script declares tables in
their final form but also creates the same tables as they existed when
they were first created * this directive instructs CQL to ignore the
incompatible creations, the first declaration controls * the idea here
is that the upgrade script is in the business of getting you to the
finish line in an orderly fashion and some of the interim steps are just
not all the way there yet * note that the upgrade script recapitulates
the version history, it does not take you directly to the finish line,
this is so that all instances get to the same place the same way (and
this fleshes out any bugs in migration)</p>
<p><code>@DUMMY_NULLABLES</code> <code>@DUMMY_DEFAULTS</code>
<code>@DUMMY_SEED</code> * these control the creation of dummy data for
<code>insert</code> and <code>fetch</code> statements (See Chapters 5
and 12)</p>
<p><code>@FILE</code> * a string literal that corresponds to the current
file name with a prefix stripped (to remove build lab junk in the
path)</p>
<p><code>@ATTRIBUTE</code> * the main purpose of <code>@attribute</code>
is to appear in the JSON output so that it can control later codegen
stages in whatever way you deem appropriate * the nested nature of
attribute values is sufficiently flexible than you could encode an
arbitrary LISP program in an attribute, so really anything you might
need to express is possible * there are a number of attributes known to
the compiler which are listed below (complete as of this writing)</p>
<ul>
<li><code>cql:autodrop=(table1, table2, ...)</code> when present the
indicated tables, which must be temp tables, are dropped when the
results of the procedure have been fetched into a rowset</li>
<li><code>cql:identity=(column1, column2, ...)</code> the indicated
columns are used to create a row comparator for the rowset corresponding
to the procedure, this appears in a C macro of the form
<code>procedure_name_row_same(rowset1, row1, rowset2, row2)</code></li>
<li><code>cql:suppress_getters</code> the annotated procedure should not
emit its related column getter functions.
<ul>
<li>Useful if you only indend to call the procedure from CQL.</li>
<li>Saves code generation and removes the possibility of C code using
the getters.</li>
</ul></li>
<li><code>cql:emit_setters</code> the annotated procedure should emit
setter functions so that result set columns can be mutated, this can be
quite useful for business logic but it is more costly</li>
<li><code>cql:suppress_result_set</code> the annotated procedure should
not emit its related “fetch results” function.
<ul>
<li>Useful if you only indend to call the procedure from CQL.</li>
<li>Saves code generation and removes the possibility of C code using
the result set or getters.</li>
<li>Implies <code>cql:suppress_getters</code>; since there is no result
set, getters would be redundant.</li>
<li>an <code>OUT UNION</code> procedure cannot have a suppressed result
set since all such a procedure does is produce a result set. This
attribute is ignored for out union procedures.</li>
</ul></li>
<li><code>cql:private</code> the annotated procedure will be static in
the generated C
<ul>
<li>Because the generated function is <code>static</code> it cannot be
called from other modules and therefore will not go in any CQL exports
file (that would be moot since you couldn’t call it).</li>
<li>This attribute also implies <code>cql:suppress_result_set</code>
since only CQL code in the same translation unit could possibly call it
and hence the result set procedure is useless to other C code.</li>
</ul></li>
<li><code>cql:generate_copy</code> the code generation for the annotated
procedure will produce a <code>[procedure_name]_copy</code> function
that can make complete or partial copies of its result set.</li>
<li><code>cql:shared_fragment</code> is used to create shared fragments
(See <a href="#chapter-14-cql-shared-fragments">Chapter 14</a>)</li>
<li><code>cql:no_table_scan</code> for query plan processing, indicates
that attributed table should never be table scanned in any plan (for
better diagnostics)</li>
<li><code>cql:ok_table_scan=([t1], [t2], ...)</code> indicates that the
attributed procedure scans the indicated tables and that’s not a
problem. This helps to suppress errors in expensive search functions
that are known to scan big tables.</li>
<li><code>cql:autotest=([many forms])</code> declares various autotest
features (See <a href="#chapter-12-testability-features">Chapter
12</a>)</li>
<li><code>cql:query_plan_branch=[integer]</code> is used by the query
plan generator to determine which conditional branch to use in query
plan analysis when a shared fragment that contains an <code>IF</code>
statement is used. (See <a
href="#chapter-15-query-plan-generation">Chapter 15</a>)</li>
<li><code>cql:alias_of=[c_function_name]</code> are used on <a
href="#ordinary-scalar-functions">function declarations</a> to declare a
function or procedure in CQL that calls a function of a different name.
This is intended to used for aliasing native (C) functions. Both the
aliased function name and the original function name may be declared in
CQL at the same time. Note that the compiler does not enforce any
consistency in typing between the original and aliased functions.</li>
<li><code>cql:backing_table</code> used to define a key value store
table (docs need, there is only a brief wiki article)</li>
<li><code>cql:backed_by=[a_backing_table]</code> specifies that the
attributed table should have its data stored in the specified backing
table, (docs needed, there is only a brief wiki article)</li>
<li><code>cql:blob_storage</code> the attributed table isn’t really a
physical table, it specifies the layout of a serializable blob, see this
<a
href="https://github.com/ricomariani/CG-SQL-author/wiki/CG-SQL-Blog-Archive#introducing-blob-storage-20220317">introductory
article</a></li>
<li><code>cql:deterministic</code> when applied to a `declare select
function`` indicates that the function is determinisitic and hence ok to
use in indices.</li>
<li><code>cql:implements=[interface]</code> interfaces may be declared
with <code>declare interface</code> and are basically a normal CQL
shape. This annotation specifies that the annotated procedure has all
the needed columns to encode the indicated shape. It may be used more
than once to indicate several shapes are supported. The requirements are
validated by the compiler but they do not affect code generation at all
other than the JSON file (see <a href="#chapter-13-json-output">Chapter
13</a>). The intent here is to allow downstream code generators like you
might have for Java and Objective C to incorporate the interface into
the signature of result sets and define the interface as needed. The C
and Lua output do not have any such notions. The present Objective C
output (<code>--rt objc</code>) doesn’t support interfaces and is likely
to be replace by a python equivalent based on the JSON output that does.
Generally, <code>--rt objc</code> was a mistake as was `–rt java``, but
the latter has been removed. Interfaces are highly useful even without
codegen just for declarative purposes.</li>
<li><code>cql:java_package=[a name]</code> this is not used by the
compiler but it can be handy to apply to various items to give java code
generators a hint where the code should go or where it comes from. Any
support for this needs to be in the your java code generator. A sample
is in the <code>java_demo</code> directory.</li>
<li><code>cql:try_is_proc_body</code> (See <a
href="https://github.com/ricomariani/CG-SQL-author/blob/main/CQL_Guide/generated/internal.md#initialization-improvements">Initialization
Improvements</a>), this indicates that the annotated try block should be
considered the entire body of the procedure for intialization purposes.
In particular, it ensures that all parameters of the current procedure
have been initialized by the end of the `TRY`` and prevents this check
from happening again at the end of the procedure. This is needed is that
for various reasons sometimes we need to wrap certain stored procedures
in a try/catch such that custom error handling or logging can be
implemented. In doing so, however, they can break our normal assumptions
about things like initialization of OUT parameters in the errant case
and that must be ok.</li>
<li><code>cql:vault_sensitive</code> or
<code>cql:vault_sensitive([columns]...)</code>
<code>cql:vault_sensitive(context, [columns]...)</code> these forms
indicate that <code>@sensitive</code> columns should get additional
encoding. These columns are marked with
<code>CQL_DATA_TYPE_ENCODED</code> in the result set metadata. This
causes <code>cql_copy_encoder</code> to be called to make an abstract
encoder from a database instance and then functions like
<code>cql_encode_text</code> to be called to encode each column. To make
sure of these attributes you will need a custom <code>cqlrt.c</code>
with suitable encodings for your application.</li>
<li><code>cql:from_recreate</code> is used to mark tables that
transitioned from <code>@recreate</code> to <code>@create</code></li>
<li><code>cql:module_must_not_be_deleted_see_docs_for_CQL0392</code>
must be added to an <code>@delete</code> attribute on a virtual table to
remind the developer that the module for the virtual table must never be
deleted elsewise database upgrades will fail. See <a
href="#cql0392-when-deleting-a-virtual-table-you-must-specify-deletenn-cqlmodule_must_not_be_deleted_see_docs_for_cql0392-as-a-reminder-not-to-delete-the-module-for-this-virtual-table"><code>CQL0392</code></a></li>
</ul>
<h3 id="deprecated-attributes">Deprecated attributes</h3>
<ul>
<li><code>cql:alt_prefix=prefix</code> this may be applied to a
procedure definition or declaration to override the prefix found in
<code>rt_common.c</code>, this is really only interesting if there is a
prefix in the first place so the default configuration of
<code>rt_common.c</code> doesn’t make this very interesting. However it
is possible to change <code>.symbol_prefix</code> (Meta does) and having
done so you might want to change it to something else.</li>
<li><code>cql:custom_type_for_encoded_column</code> the objective C
output has the option of using different type for strings that have been
encoded because they are sensitive. This attribute is placed on a
procedure and it causes all strings in result sets to be declared with
<code>cql_string_ref_encode</code> from the objc result type. The type
is ocnfigured with <code>RT_STRING_ENCODE</code> which is
<code>cql_string_ref_encode</code> by default. This is deprecated
because the entire <code>--rt objc</code> feature is slated for
destruction to be replaced with python that processes the JSON like the
Java case.</li>
</ul>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-4-cql-error-codes">Appendix 4: CQL Error Codes</h2>
<h3 id="cql0001-operands-must-be-an-integer-type-not-real">CQL0001:
operands must be an integer type, not real</h3>
<p>integer math operators like &lt;&lt; &gt;&gt; &amp; and | are not
compatible with real-valued arguments</p>
<hr />
<h3 id="cql0002-left-operand-cannot-be-an-object-in-operator">CQL0002:
left operand cannot be an object in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on objects.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0003-left-operand-cannot-be-an-object-in-operator">CQL0003:
left operand cannot be an object in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on objects.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0004-left-operand-cannot-be-a-blob-in-operator">CQL0004: left
operand cannot be a blob in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on blobs.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0005-right-operand-cannot-be-a-blob-in-operator">CQL0005:
right operand cannot be a blob in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on blobs.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0007-left-operand-cannot-be-a-string-in-operator">CQL0007:
left operand cannot be a string in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on strings.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0008-right-operand-cannot-be-a-string-in-operator">CQL0008:
right operand cannot be a string in ‘operator’</h3>
<p>Most arithmetic operators (e.g. +, -, *) do not work on strings.
Basically comparison is all you can do.</p>
<hr />
<h3 id="cql0009-incompatible-types-in-expression-subject">CQL0009:
incompatible types in expression ‘subject’</h3>
<p>The expression type indicated by subject required a TEXT as the next
item and found something else. This could be a binary operator, part of
a CASE expression, the parts of an IN expression or any other place
where several expressions might need to be compatible with each
other.</p>
<hr />
<h3 id="cql0010-incompatible-types-in-expression-subject">CQL0010:
incompatible types in expression ‘subject’</h3>
<p>The expression type indicated by subject required an OBJECT as the
next item and found something else. This could be a binary operator,
part of a CASE expression, the parts of an IN expression or any other
place where several expressions might need to be compatible with each
other.</p>
<hr />
<h3 id="cql0011-incompatible-types-in-expression-subject">CQL0011:
incompatible types in expression ‘subject’</h3>
<p>The expression type indicated by subject required a BLOB as the next
item and found something else. This could be a binary operator, part of
a CASE expression, the parts of an IN expression or any other place
where several expressions might need to be compatible with each
other.</p>
<hr />
<h3 id="cql0012-incompatible-types-in-expression-subject">CQL0012:
incompatible types in expression ‘subject’</h3>
<p>The expression type indicated by subject required a numeric as the
next item and found something else. This could be a binary operator,
part of a CASE expression, the parts of an IN expression or any other
place where several expressions might need to be compatible with each
other.</p>
<hr />
<h3
id="cql0013-cannot-assigncopy-possibly-null-expression-to-not-null-target-target">CQL0013:
cannot assign/copy possibly null expression to not null target
‘target’</h3>
<p>Here assign/copy can be the simplest case of assigning to a local
variable or an OUT parameter but this error also appears when calling
functions. You should think of the IN arguments as requiring that the
actual argument be assignable to the formal variable and OUT arguments
requiring that the formal be assignable to the actual argument
variable.</p>
<hr />
<h3
id="cql0014-cannot-assigncopy-sensitive-expression-to-not-null-target-target">CQL0014:
cannot assign/copy sensitive expression to not null target ‘target’</h3>
<p>Here assign/copy can be the simplest case of assigning to a local
variable or an OUT parameter but this error also appears when calling
functions. You should think of the IN arguments as requiring that the
actual argument be assignable to the formal variable and OUT arguments
requiring that the formal be assignable to the actual argument
variable.</p>
<hr />
<h3 id="cql0015-expected-numeric-expression-context">CQL0015: expected
numeric expression ‘context’</h3>
<p>Many SQL clauses require a numeric expression such as
WHERE/HAVING/LIMIT/OFFSET. This expression indicates the expression in
the given context is not a numeric.</p>
<hr />
<h3 id="cql0016-duplicate-table-name-in-join-table">CQL0016: duplicate
table name in join ‘table’</h3>
<p>When this error is produced it means the result of the join would
have the same table twice with no disambiguation between the two places.
The conflicting name is provided. To fix this, make an alias both
tables. e.g.</p>
<div class="sourceCode" id="cb518"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb518-1"><a href="#cb518-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> T1.<span class="kw">id</span> <span class="kw">AS</span> parent_id, T2.<span class="kw">id</span> <span class="kw">AS</span> child_id</span>
<span id="cb518-2"><a href="#cb518-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo <span class="kw">AS</span> T1</span>
<span id="cb518-3"><a href="#cb518-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> foo <span class="kw">AS</span> T2 <span class="kw">ON</span> T1.<span class="kw">id</span> <span class="op">=</span> T2.parent_id;</span></code></pre></div>
<hr />
<h3
id="cql0017-index-was-present-but-now-it-does-not-exist-use-delete-instead-index">CQL0017:
index was present but now it does not exist (use <code>@delete</code>
instead) ‘index’</h3>
<p>The named index is in the previous schema bit it is not in the
current schema. All entities need some kind of tombstone in the schema
so that they can be correctly deleted if they are still present.</p>
<hr />
<h3 id="cql0018-duplicate-index-name-index">CQL0018: duplicate index
name ‘index’</h3>
<p>An index with the indicated name already exists.</p>
<hr />
<h3 id="cql0019-create-index-table-name-not-found-table_name">CQL0019:
create index table name not found ‘table_name’</h3>
<p>The table part of a CREATE INDEX statement was not a valid table
name.</p>
<hr />
<h3
id="cql0020-duplicate-constraint-name-in-table-constraint_name">CQL0020:
duplicate constraint name in table ‘constraint_name’</h3>
<p>A table contains two constraints with the same name.</p>
<hr />
<h3
id="cql0021-foreign-key-refers-to-non-existent-table-table_name">CQL0021:
foreign key refers to non-existent table ‘table_name’</h3>
<p>The table in a foreign key REFERENCES clause is not a valid
table.</p>
<hr />
<h3
id="cql0022-exact-type-of-both-sides-of-a-foreign-key-must-match-expected-expected_type-found-actual_type-key_name">CQL0022:
exact type of both sides of a foreign key must match (expected
expected_type; found actual_type) ‘key_name’</h3>
<p>The indicated foreign key has at least one column with a different
type than corresponding column in the table it references. This usually
means that you have picked the wrong table or column in the foreign key
declaration.</p>
<hr />
<h3
id="cql0023-number-of-columns-on-both-sides-of-a-foreign-key-must-match">CQL0023:
number of columns on both sides of a foreign key must match</h3>
<p>The number of column in the foreign key must be the same as the
number of columns specified in the foreign table. This usually means a
column is missing in the REFERENCES part of the declaration.</p>
<hr />
<p>CQL0024: no longer in use</p>
<hr />
<h3 id="cql0025-version-number-in-annotation-must-be-positive">CQL0025:
version number in annotation must be positive</h3>
<p>In an <code>@create</code> or <code>@delete</code> annotation, the
version number must be &gt; 0. This error usually means there is a typo
in the version number.</p>
<hr />
<h3 id="cql0026-duplicate-version-annotation">CQL0026: duplicate version
annotation</h3>
<p>There can only be one <code>@create</code>, <code>@delete</code>, or
<code>@recreate</code> annotation for any given table/column. More than
one <code>@create</code> is redundant. This error usually means the
<code>@create</code> was cut/paste to make an <code>@delete</code> and
then not edited or something like that.</p>
<hr />
<h3
id="cql0027-a-procedure-can-appear-in-only-one-annotation-procedure_name">CQL0027:
a procedure can appear in only one annotation ‘procedure_name’</h3>
<p>The indicated migration procedure e.g. the foo in
<code>@create(5, foo)</code> appears in another annotation. Migration
steps should happen exactly once. This probably means the annotation was
cut/paste and the migration proc was not removed.</p>
<hr />
<h3
id="cql0028-fk-reference-must-be-exactly-one-column-with-the-correct-type-column_name">CQL0028:
FK reference must be exactly one column with the correct type
‘column_name’</h3>
<p>When a foreign key is specified in the column definition it is the
entire foreign key. That means the references part of the declaration
can only be for that one column. If you need more columns, you have to
declare the foreign key independently.</p>
<hr />
<h3
id="cql0029-autoincrement-column-must-be-long_integer-primary-key-column-name">CQL0029:
autoincrement column must be [LONG_]INTEGER PRIMARY KEY ‘column
name’</h3>
<p>SQLite is very fussy about autoincrement columns. The column in
question must be either a LONG INTEGER or an INTEGER and it must be
PRIMARY KEY. In fact, CQL will rewrite LONG INTEGER into INTEGER because
only that exact form is supported, but SQLite INTEGERs can hold LONG
values so that’s ok. Any other autoincrement form results in this
error.</p>
<hr />
<h3
id="cql0030-a-column-attribute-was-specified-twice-on-the-same-column-column_name">CQL0030:
a column attribute was specified twice on the same column
‘column_name’</h3>
<p>This error indicates a pattern like “id text not null not null” was
found. The same attribute shouldn’t appear twice.</p>
<hr />
<h3
id="cql0031-column-cant-be-primary-key-and-also-unique-key-column">CQL0031:
column can’t be primary key and also unique key ‘column’</h3>
<p>In a column definition, the column can only be marked with at most
one of PRIMARY KEY or UNIQUE</p>
<hr />
<h3
id="cql0032-created-columns-must-be-at-the-end-and-must-be-in-version-order-column">CQL0032:
created columns must be at the end and must be in version order”,
‘column’</h3>
<p>The SQLite ALTER TABLE ADD COLUMN statement is used to add new
columns to the schema. This statement puts the columns at the end of the
table. In order to make the CQL schema align as closely as possible to
the actual sqlite schema you will get you are required to add columns
where SQLite will put them. This will help a lot if you ever connect to
such a database and start doing
<code>select * from &lt;somewhere with creates&gt;</code></p>
<hr />
<h3
id="cql0033-columns-in-a-table-marked-recreate-cannot-have-create-or-delete-column">CQL0033:
columns in a table marked <span class="citation"
data-cites="recreate">@recreate</span> cannot have <span
class="citation" data-cites="create">@create</span> or
<code>@delete</code>, ‘column’</h3>
<p>If the table is using the <code>@recreate</code> plan then you can
add and remove columns (and other things freely) you don’t need to mark
columns with <code>@create</code> or <code>@delete</code> just
add/remove them. This error prevents the build up of useless
annotations.</p>
<hr />
<h3
id="cql0034-createdelete-version-numbers-can-only-be-applied-to-columns-that-are-nullable-or-have-a-default-value-column">CQL0034:
create/delete version numbers can only be applied to columns that are
nullable or have a default value ‘column’</h3>
<p>Any new column added to a schema must have a default value or be
nullable so that its initial state is clear and so that all existing
insert statements do not have to be updated to include it. Either make
the column nullable or give it a default value.</p>
<p>Similarly, any column being deleted must be nullable or have a
default value. The column can’t actually be deleted (not all versions of
SQLite support this) so it will only be “deprecated”. But if the column
is not null and has no default then it would be impossible to write a
correct insert statement for the table with the deleted column.</p>
<p>As a consequence you can neither add nor remove columns that are not
null and have no default.</p>
<hr />
<h3
id="cql0035-column-delete-version-cant-be-column-create-version-column">CQL0035:
column delete version can’t be &lt;= column create version”,
‘column’</h3>
<p>You can’t <code>@delete</code> a column in a version before it was
even created. Probably there is a typo in one or both of the
versions.</p>
<hr />
<h3
id="cql0036-column-delete-version-cant-be-the-table-create-version-column">CQL0036:
column delete version can’t be &lt;= the table create version
‘column’</h3>
<p>The indicated column is being deleted in a version that is before the
table it is found in was even created. Probably there is a typo in the
delete version.</p>
<hr />
<h3
id="cql0037-column-delete-version-cant-be-the-table-delete-version">CQL0037:
column delete version can’t be &gt;= the table delete version</h3>
<p>The indicated column is being deleted in a version that is after the
table has already been deleted. This would be redundant. Probably one or
both have a typo in their delete version.</p>
<hr />
<h3
id="cql0038-column-create-version-cant-be-the-table-create-version-column">CQL0038:
column create version can’t be <code>&lt;=</code> the table create
version ‘column’</h3>
<p>The indicated column is being created in a version that is before the
table it is found in was even created. Probably there is a typo in the
delete version.</p>
<hr />
<h3
id="cql0039-column-create-version-cant-be-the-table-delete-version-column">CQL0039:
column create version can’t be <code>&gt;=</code> the table delete
version ‘column’</h3>
<p>The indicated column is being created in a version that that is after
it has already been supposedly deleted. Probably there is a typo in one
or both of the version numbers.</p>
<hr />
<h3 id="cql0040-table-can-only-have-one-autoinc-column-column">CQL0040:
table can only have one autoinc column ‘column’</h3>
<p>The indicated column is the second column to be marked with
AUTOINCREMENT in its table. There can only be one such column.</p>
<hr />
<h3 id="cql0041-tables-cannot-have-object-columns-column">CQL0041:
tables cannot have object columns ‘column’</h3>
<p>The OBJECT data type is only for use in parameters and local
variables. SQLite has no storage for object references. The valid data
types include <code>INTEGER</code>, <code>LONG INTEGER</code>,
<code>REAL</code>, <code>BOOL</code>, <code>TEXT</code>,
<code>BLOB</code></p>
<hr />
<h3 id="cql0042-left-operand-must-be-a-string-in-likematchglob">CQL0042:
left operand must be a string in ‘LIKE/MATCH/GLOB’</h3>
<p>The indicated operator can only be used to compare two strings.</p>
<hr />
<h3
id="cql0043-right-operand-must-be-a-string-in-likematchglob">CQL0043:
right operand must be a string in ‘LIKE/MATCH/GLOB’</h3>
<p>The indicated operator can only be used to compare two strings.</p>
<hr />
<h3
id="cql0044-operator-may-only-appear-in-the-context-of-a-sql-statement-match">CQL0044:
operator may only appear in the context of a SQL statement ‘MATCH’</h3>
<p>The MATCH operator is a complex sqlite primitive. It can only appear
within SQL expressions. See the CQL documentation about it being a
two-headed-beast when it comes to expression evaluation.</p>
<hr />
<h3 id="cql0045-blob-operand-not-allowed-in-operator">CQL0045: blob
operand not allowed in ‘operator’</h3>
<p>None of the unary math operators e.g. ‘-’ and ‘~’ allow blobs as an
operand.</p>
<hr />
<h3 id="cql0046-object-operand-not-allowed-in-operator">CQL0046: object
operand not allowed in ‘operator’</h3>
<p>None of the unary math operators e.g. ‘-’ and ‘~’ allow objects as an
operand.</p>
<hr />
<h3 id="cql0047-string-operand-not-allowed-in-operator">CQL0047: string
operand not allowed in ‘operator’</h3>
<p>None of the unary math operators e.g. ‘-’ and ‘~’ allow strings as an
operand.</p>
<hr />
<h3 id="cql0051-argument-can-only-be-used-in-count">CQL0051: argument
can only be used in count(<em>) ’</em>’</h3>
<p>The ’*’ special operator can only appear in the COUNT function.
e.g. <code>select count(*) from some_table</code> It is not a valid
function argument in any other context.</p>
<hr />
<h3 id="cql0052-select-cannot-be-used-with-no-from-clause">CQL0052:
select * cannot be used with no FROM clause</h3>
<p>Select statements of the form <code>select 1, 'foo';</code> are
<code>valid but select '*';</code> is not. The <code>*</code> shortcut
for columns only makes sense if there is something to select from.
e.g. <code>select * from some_table;</code> is valid.</p>
<hr />
<h3
id="cql0053-select-table.-cannot-be-used-with-no-from-clause">CQL0053:
select [table].* cannot be used with no FROM clause</h3>
<p>Select statements of the form <code>select 1, 'foo';</code> are
<code>valid but select 'T.*';</code> is not. The <code>T.*</code>
shortcut for all the columns from table T only makes sense if there is
something to select form.
e.g. <code>select T.* from some_table T;</code> is valid.</p>
<hr />
<h3 id="cql0054-table-not-found-table">CQL0054: table not found
‘table’</h3>
<p>The indicated table was used in a select statement like
<code>select T.* from ...</code> but no such table was present in the
<code>FROM</code> clause.</p>
<hr />
<h3 id="cql0055-all-columns-in-the-select-must-have-a-name">CQL0055: all
columns in the select must have a name</h3>
<p>Referring to the select statement on the failing line, that select
statement was used in a context where all the columns must have a name.
Examples include defining a view, a cursor, or creating a result set
from a procedure. The failing code might look something like this.
<code>select 1, 2 B;</code> it needs to look like this
<code>select 1 A, 2 B</code>;</p>
<hr />
<h3
id="cql0056-null-expression-has-no-type-to-imply-a-needed-type-variable">CQL0056:
NULL expression has no type to imply a needed type ‘variable’</h3>
<p>In some contexts the type of a constant is used to imply the type of
the expression. The NULL literal cannot be used in such contexts because
it has no specific type.</p>
<p>In a SELECT statement the NULL literal has no type. If the type of
the column cannot be inferred then it must be declared specifically.</p>
<p>In a LET statement, the same situation arises
<code>LET x := NULL;</code> doesn’t specify what type ‘x’ is to be.</p>
<p>You can fix this error by changing the <code>NULL</code> to something
like <code>CAST(NULL as TEXT)</code>.</p>
<p>A common place this problem happens is in defining a view or
returning a result set from a stored procedure. In those cases all the
columns must have a name and a type.</p>
<hr />
<h3
id="cql0057-if-multiple-selects-all-must-have-the-same-column-count">CQL0057:
if multiple selects, all must have the same column count</h3>
<p>If a stored procedure might return one of several result sets, each
of the select statements it might return must have the same number of
columns. Likewise, if several select results are being combined with
<code>UNION</code> or <code>UNION ALL</code> they must all have the same
number of columns.</p>
<hr />
<h3
id="cql0058-if-multiple-selects-all-column-names-must-be-identical-so-they-have-unambiguous-names-error-in-column-n-x-vs.-y">CQL0058:
if multiple selects, all column names must be identical so they have
unambiguous names; error in column N: ‘X’ vs. ‘Y’</h3>
<p>If a stored procedure might return one of several result sets, each
of the select statements must have the same column names for its result.
Likewise, if several select results are being combined with
<code>UNION</code> or <code>UNION ALL</code> they must all have the same
column names.</p>
<p>This is important so that there can be one unambiguous column name
for every column for group of select statements.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb519"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb519-1"><a href="#cb519-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="dv">1</span> A, <span class="dv">2</span> B</span>
<span id="cb519-2"><a href="#cb519-2" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span></span>
<span id="cb519-3"><a href="#cb519-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="dv">3</span> A, <span class="dv">4</span> C;</span></code></pre></div>
<p>Would provoke this error. In this case the error would report that
the problem was in column 2 and that error was ‘B’ vs. ‘C’</p>
<hr />
<h3
id="cql0059-a-variable-name-might-be-ambiguous-with-a-column-name-this-is-an-anti-pattern-name">CQL0059:
a variable name might be ambiguous with a column name, this is an
anti-pattern ‘name’</h3>
<p>The referenced name is the name of a local or a global in the same
scope as the name of a column. This can lead to surprising results as it
is not clear which name takes priority (previously the variable did
rather than the column, now it’s an error).</p>
<p>example:</p>
<div class="sourceCode" id="cb520"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb520-1"><a href="#cb520-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo(<span class="kw">id</span> <span class="dt">integer</span>)</span>
<span id="cb520-2"><a href="#cb520-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb520-3"><a href="#cb520-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- this is now an error, in all cases the argument would have been selected</span></span>
<span id="cb520-4"><a href="#cb520-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> bar T1 <span class="kw">where</span> T1.<span class="kw">id</span> <span class="op">!=</span> <span class="kw">id</span>;</span>
<span id="cb520-5"><a href="#cb520-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>To correct this, rename the local/global. Or else pick a more
distinctive column name, but usually the local is the problem.</p>
<hr />
<h3
id="cql0060-referenced-table-can-be-independently-recreated-so-it-cannot-be-used-in-a-foreign-key-referenced_table">CQL0060:
referenced table can be independently recreated so it cannot be used in
a foreign key, ‘referenced_table’</h3>
<p>The referenced table is marked recreate so it must be in the same
recreate group as the current table or in a recreate group that does not
introduce a cyclic foreign key dependency among recreate groups.
Otherwise, the referenced table might be recreated away leaving all the
foreign key references in current table as orphans.</p>
<p>So we check the following: If the referenced table is marked recreate
then any of the following result in CQL0060</p>
<ul>
<li>the containing table is not recreate at all (non-recreate table
can’t reference recreate tables at all), OR</li>
<li>the new foreign key dependency between the referenced table and the
current table introduces a cycle</li>
</ul>
<p>The referenced table is a recreate table and one of the 4 above
conditions was not met. Either don’t reference it or else put the
current table and the referenced table into the same recreate group.</p>
<hr />
<h3
id="cql0061-if-multiple-selects-all-columns-must-be-an-exact-type-match-expected-expected_type-found-actual_type-column">CQL0061:
if multiple selects, all columns must be an exact type match (expected
expected_type; found actual_type) ‘column’</h3>
<p>In a stored proc with multiple possible selects providing the result,
all of the columns of all the selects must be an exact type match.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb521"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb521-1"><a href="#cb521-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="cf">then</span></span>
<span id="cb521-2"><a href="#cb521-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="dv">1</span> A, <span class="dv">2</span> B</span>
<span id="cb521-3"><a href="#cb521-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb521-4"><a href="#cb521-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="dv">3</span> A, <span class="fl">4.0</span> B;</span>
<span id="cb521-5"><a href="#cb521-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>Would provoke this error. In this case ‘B’ would be regarded as the
offending column and the error is reported on the second B.</p>
<hr />
<h3
id="cql0062-if-multiple-selects-all-columns-must-be-an-exact-type-match-including-nullability-expected-expected_type-found-actual_type-column">CQL0062:
if multiple selects, all columns must be an exact type match (including
nullability) (expected expected_type; found actual_type) ‘column’</h3>
<p>In a stored proc with multiple possible selects providing the result,
all of the columns of all the selects must be an exact type match. This
error indicates that the specified column differs by nullability.</p>
<hr />
<h3
id="cql0063-cant-mix-and-match-out-statement-with-selectcall-for-return-values-procedure_name">CQL0063:
can’t mix and match out statement with select/call for return values
‘procedure_name’</h3>
<p>If the procedure is using SELECT to create a result set it cannot
also use the OUT keyword to create a one-row result set.</p>
<hr />
<h3
id="cql0064-object-variables-may-not-appear-in-the-context-of-a-sql-statement">CQL0064:
object variables may not appear in the context of a SQL statement</h3>
<p>SQLite doesn’t understand object references, so that means you cannot
try to use a variable or parameter of type object inside of a SQL
statement.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb522"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb522-1"><a href="#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo(X <span class="dt">object</span>)</span>
<span id="cb522-2"><a href="#cb522-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb522-3"><a href="#cb522-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> X <span class="kw">is</span> <span class="kw">null</span>;</span>
<span id="cb522-4"><a href="#cb522-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>In this example X is an object parameter, but even to use X for an
<code>is null</code> check in a select statement would require binding
an object which is not possible.</p>
<p>On the other hand this compiles fine.</p>
<div class="sourceCode" id="cb523"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb523-1"><a href="#cb523-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo(X <span class="dt">object</span>, <span class="kw">out</span> is_null bool <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb523-2"><a href="#cb523-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb523-3"><a href="#cb523-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> is_null <span class="op">:=</span> X <span class="kw">is</span> <span class="kw">null</span>;</span>
<span id="cb523-4"><a href="#cb523-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>This is another example of XQL being a two-headed beast.</p>
<hr />
<h3 id="cql0065-identifier-is-ambiguous-name">CQL0065: identifier is
ambiguous ‘name’</h3>
<p>There is more than one variable/column with indicated name in equally
near scopes. The most common reason for this is that there are two
column in a join with the same name and that name has not been qualified
elsewhere.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb524"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> A</span>
<span id="cb524-2"><a href="#cb524-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">AS</span> A, <span class="dv">2</span> <span class="kw">AS</span> B) <span class="kw">AS</span> T1</span>
<span id="cb524-3"><a href="#cb524-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> (<span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">AS</span> A, <span class="dv">2</span> <span class="kw">AS</span> B) <span class="kw">AS</span> T2;</span></code></pre></div>
<p>There are two possible columns named <code>A</code>. Fix this by
using <code>T1.A</code> or <code>T2.A</code>.</p>
<hr />
<h3
id="cql0066-if-a-table-is-marked-recreate-its-indices-must-be-in-its-schema-region-index_name">CQL0066:
if a table is marked <code>@recreate</code>, its indices must be in its
schema region ‘index_name’</h3>
<p>If a table is marked <code>@recreate</code> that means that when it
changes it is dropped and created during schema maintenance. Of course
when it is dropped its indices are also dropped. So the indices must
also be recreated when the table changes. So with such a table it makes
no sense to have indices that are in a different schema region. This can
only work if they are all always visible together.</p>
<p>Tables on the <code>@create</code> plan are not dropped so their
indices can be maintained separately. So they get a little extra
flexibility.</p>
<p>To fix this error move the offending index into the same schema
region as the table. And probably put them physically close for
maintenance sanity.</p>
<hr />
<h3
id="cql0067-cursor-was-not-used-with-fetch-cursor-cursor_name">CQL0067:
cursor was not used with ‘fetch [cursor]’ ‘cursor_name’</h3>
<p>The code is trying to access fields in the named cursor but the
automatic field generation form was not used so there are no such
fields.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb525"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb525-1"><a href="#cb525-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> a <span class="dt">integer</span>;</span>
<span id="cb525-2"><a href="#cb525-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> b <span class="dt">integer</span>;</span>
<span id="cb525-3"><a href="#cb525-3" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="dv">1</span> A, <span class="dv">2</span> B;</span>
<span id="cb525-4"><a href="#cb525-4" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">into</span> a, b; <span class="co">-- C.A and C.B not created (!)</span></span>
<span id="cb525-5"><a href="#cb525-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (C.A) <span class="cf">then</span> <span class="co">-- error</span></span>
<span id="cb525-6"><a href="#cb525-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb525-7"><a href="#cb525-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>Correct usage looks like this:</p>
<div class="sourceCode" id="cb526"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="dv">1</span> A, <span class="dv">2</span> B;</span>
<span id="cb526-2"><a href="#cb526-2" aria-hidden="true" tabindex="-1"></a>fetch C;  <span class="co">-- automatically creates C.A and C.B</span></span>
<span id="cb526-3"><a href="#cb526-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (C.A) <span class="cf">then</span></span>
<span id="cb526-4"><a href="#cb526-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb526-5"><a href="#cb526-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<hr />
<h3 id="cql0068-field-not-found-in-cursor-field">CQL0068: field not
found in cursor ‘field’</h3>
<p>The indicated field is not a valid field in a cursor expression.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb527"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb527-1"><a href="#cb527-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="dv">1</span> A, <span class="dv">2</span> B;</span>
<span id="cb527-2"><a href="#cb527-2" aria-hidden="true" tabindex="-1"></a>fetch C;  <span class="co">-- automatically creates C.A and C.B</span></span>
<span id="cb527-3"><a href="#cb527-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (C.X) <span class="cf">then</span> <span class="co">-- C has A and B, but no X</span></span>
<span id="cb527-4"><a href="#cb527-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb527-5"><a href="#cb527-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<hr />
<h3 id="cql0069-name-not-found-name">CQL0069: name not found ‘name’</h3>
<p>The indicated name could not be resolved in the scope in which it
appears. Probably there is a typo. But maybe the name you need isn’t
available in the scope you are trying to use it in.</p>
<hr />
<h3 id="cql0070-incompatible-object-type-incompatible_type">CQL0070:
incompatible object type ‘incompatible_type’</h3>
<p>Two expressions of type object are holding a different object type
e.g.</p>
<div class="sourceCode" id="cb528"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> x <span class="dt">object</span><span class="op">&lt;</span>Foo<span class="op">&gt;</span>;</span>
<span id="cb528-2"><a href="#cb528-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> y <span class="dt">object</span><span class="op">&lt;</span>Bar<span class="op">&gt;</span>;</span>
<span id="cb528-3"><a href="#cb528-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> x <span class="op">:=</span> y;</span></code></pre></div>
<p>Here the message would report that ‘Bar’ is incompatible. The message
generally refers to the 2nd object type as the first one was ok by
default then the second one caused the problem.</p>
<hr />
<h3
id="cql0071-first-operand-cannot-be-a-blob-in-betweennot-between">CQL0071:
first operand cannot be a blob in ‘BETWEEN/NOT BETWEEN’</h3>
<p>The BETWEEN operator works on numerics and strings only.</p>
<hr />
<h3
id="cql0072-first-operand-cannot-be-a-blob-in-betweennot-between">CQL0072:
first operand cannot be a blob in ‘BETWEEN/NOT BETWEEN’</h3>
<p>The BETWEEN operator works on numerics and strings only.</p>
<hr />
<h3
id="cql0073-cast-may-only-appear-in-the-context-of-sql-statement">CQL0073:
CAST may only appear in the context of SQL statement</h3>
<p>The CAST function does highly complex and subtle conversions,
including date/time functions and other things. It’s not possibly to
emulate this accurately and there is no sqlite helper to do the job
directly from a C call. Consequently it’s only supported in the context
of CQL statements. It can be used in normal expressions by using the
nested <code>SELECT</code> form <code>(select ...)</code></p>
<hr />
<h3 id="cql0074-too-few-arguments-provided-coalesce">CQL0074: too few
arguments provided ‘coalesce’</h3>
<p>There must be at least two arguments in a call to
<code>coalesce</code>.</p>
<hr />
<h3 id="cql0075-incorrect-number-of-arguments-ifnull">CQL0075: incorrect
number of arguments ‘ifnull’</h3>
<p>The <code>ifnull</code> function requires exactly two arguments.</p>
<hr />
<h3
id="cql0076-null-literal-is-useless-in-function-ifnullcoalesce">CQL0076:
NULL literal is useless in function ‘ifnull/coalesce’</h3>
<p>Adding a NULL literal to <code>IFNULL</code> or <code>COALESCE</code>
is a no-op. It’s most likely an error.</p>
<hr />
<h3
id="cql0077-encountered-arg-known-to-be-not-null-before-the-end-of-the-list-rendering-the-rest-useless-expression">CQL0077:
encountered arg known to be not null before the end of the list,
rendering the rest useless ‘expression’</h3>
<p>In an <code>IFNULL</code> or <code>COALESCE</code> call, only the
last argument may be known to be not null. If a not null argument comes
earlier in the list, then none of the others could ever be used. That is
almost certainly an error. The most egregious form of this error is if
the first argument is known to be not null in which case the entire
<code>IFNULL</code> or <code>COALESCE</code> can be removed.</p>
<hr />
<h3
id="cql0078-not-in-select-is-only-allowed-inside-of-select-lists-where-on-and-having-clauses">CQL0078:
[not] in (select …) is only allowed inside of select lists, where, on,
and having clauses</h3>
<p>The (select…) option for <code>IN</code> or <code>NOT IN</code> only
makes sense in certain expression contexts. Other uses are most likely
errors. It cannot appear in a loose expression because it fundamentally
requires sqlite to process it.</p>
<hr />
<h3
id="cql0079-function-got-incorrect-number-of-arguments-name">CQL0079:
function got incorrect number of arguments ‘name’</h3>
<p>The indicated function was called with the wrong number of arguments.
There are various functions supported each with different rules. See the
SQLite documentation for more information about the specified
function.</p>
<hr />
<h3 id="cql0080-function-may-not-appear-in-this-context-name">CQL0080:
function may not appear in this context ‘name’</h3>
<p>Many functions can only appear in certain contexts. For instance most
aggregate functions are limited to the select list or the HAVING clause.
They cannot appear in, for instance, a WHERE, or ON clause. The
particulars vary by function.</p>
<hr />
<h3
id="cql0081-aggregates-only-make-sense-if-there-is-a-from-clause-name">CQL0081:
aggregates only make sense if there is a FROM clause ‘name’</h3>
<p>The indicated aggregate function was used in a select statement with
no tables. For instance</p>
<div class="sourceCode" id="cb529"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb529-1"><a href="#cb529-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">MAX</span>(<span class="dv">7</span>);</span></code></pre></div>
<p>Doesn’t make any sense.</p>
<hr />
<h3 id="cql0082-argument-must-be-numeric">CQL0082: argument must be
numeric</h3>
<p>The argument of function must be numeric.</p>
<hr />
<h3 id="cql0083-argument-must-be-numeric-sum">CQL0083: argument must be
numeric ‘SUM’</h3>
<p>The argument of SUM must be numeric.</p>
<hr />
<h3
id="cql0084-second-argument-must-be-a-string-in-function-group_concat">CQL0084:
second argument must be a string in function ‘group_concat’</h3>
<p>The second argument of group_concat is the separator, it must be a
string. The first argument will be converted to a string.</p>
<hr />
<h3 id="cql0085-all-arguments-must-be-strings-strftime">CQL0085: all
arguments must be strings ‘strftime’</h3>
<p>The <code>strftime</code> function does complex data formatting. All
the arguments are strings. See the sqlite documentation for more details
on the options (there are many).</p>
<hr />
<h3
id="cql0086-first-argument-must-be-a-string-in-function-function">CQL0086:
first argument must be a string in function ‘function’</h3>
<p>The first argument of the function is the formatting string. The
other arguments are variable and many complex conversions will
apply.</p>
<hr />
<h3 id="cql0087-first-argument-must-be-of-type-real-function">CQL0087:
first argument must be of type real ‘function’</h3>
<p>The first argument of the function (e.g. round) should be of type
‘real’.</p>
<hr />
<h3
id="cql0088-user-function-may-not-appear-in-the-context-of-a-sql-statement-function_name">CQL0088:
user function may not appear in the context of a SQL statement
‘function_name’</h3>
<p>External C functions declared with <code>declare function ...</code>
are not for use in sqlite. They may not appear inside statements.</p>
<hr />
<h3
id="cql0089-user-function-may-only-appear-in-the-context-of-a-sql-statement-function_name">CQL0089:
user function may only appear in the context of a SQL statement
‘function_name’</h3>
<p>SQLite user defined functions (or builtins) declared with
<code>declare select function</code> may only appear inside of sql
statements. In the case of user defined functions they must be added to
sqlite by the appropriate C APIs before they can be used in CQL stored
procs (or any other context really). See the sqlite documentation on how
to add user defined functions. <a
href="http://www.sqlite.org/c3ref/create_function.html">Create Or
Redefine SQL Functions</a></p>
<hr />
<h3
id="cql0090-objectt-set-has-a-t-that-is-not-a-procedure-with-a-result-set-name">CQL0090:
<code>object&lt;T SET&gt;</code> has a T that is not a procedure with a
result set, ‘name’</h3>
<p>The data type <code>object&lt;T SET&gt;</code> refers to the shape of
a result set of a particular procedure. In this case the indicated name
is not such a procedure.</p>
<p>The most likely source of this problem is that there is a typo in the
indicated name. Alternatively the name might be a valid shape like a
cursor name or some other shape name but it’s a shape that isn’t coming
from a procedure.</p>
<hr />
<h3
id="cql0091-objectt-set-has-a-t-that-is-not-a-public-procedure-with-a-result-set-name">CQL0091:
<code>object&lt;T SET&gt;</code> has a T that is not a public procedure
with a result set, ‘name’</h3>
<p>The data type <code>object&lt;T SET&gt;</code> refers to the shape of
a result set of a particular procedure. In this case the indicated
procedure name was tagged with either the <code>cql:private</code>
attribute or the <code>cql:suppress_result_set</code> attribute.</p>
<p>Either of these attributes will make it impossible to actually use
this result set type. They must be removed.</p>
<hr />
<h3 id="cql0092-raise-may-only-be-used-in-a-trigger-statement">CQL0092:
RAISE may only be used in a trigger statement</h3>
<p>SQLite only supports this kind of control flow in the context of
triggers, certain trigger predicates might need to unconditionally fail
and complex logic can be implemented in this way. However this sort of
thing is not really recommended. In any case this is not a general
purpose construct.</p>
<hr />
<h3 id="cql0093-raise-2nd-argument-must-be-a-string">CQL0093: RAISE 2nd
argument must be a string</h3>
<p>Only forms with a string as the second argument are supported by
SQLite.</p>
<hr />
<h3 id="cql0094-function-not-yet-implemented-function">CQL0094: function
not yet implemented ‘function’</h3>
<p>The indicated function is not implemented in CQL. Possibly you
intended to declare it with <code>declare function</code> as an external
function or <code>declare select function</code> as a sqlite builtin.
Note not all sqlite builtins are automatically declared.</p>
<hr />
<h3 id="cql0095-tableview-not-defined-name">CQL0095: table/view not
defined ‘name’</h3>
<p>The indicated name is neither a table nor a view. It is possible that
the table/view is now deprecated with <code>@delete</code> and therefore
will appear to not exist in the current context.</p>
<hr />
<h3
id="cql0096-join-using-column-not-found-on-the-left-side-of-the-join-column_name">CQL0096:
join using column not found on the left side of the join
‘column_name’</h3>
<p>In the <code>JOIN ... USING(x,y,z)</code> form, all the columns in
the using clause must appear on both sides of the join. Here the
indicated name is not present on the left side of the join.</p>
<hr />
<h3
id="cql0097-join-using-column-not-found-on-the-right-side-of-the-join-column_name">CQL0097:
join using column not found on the right side of the join
‘column_name’</h3>
<p>In the <code>JOIN ... USING(x,y,z)</code> form, all the columns in
the using clause must appear on both sides of the join. Here the
indicated name is not present on the right side of the join.</p>
<hr />
<h3
id="cql0098-leftright-column-types-in-join-using-do-not-match-exactly-column_name">CQL0098:
left/right column types in join USING(…) do not match exactly
‘column_name’</h3>
<p>In the <code>JOIN ... USING(x,y,z)</code> form, all the columns in
the using clause must appear on both sides of the join and have the same
data type. Here the data types differ in the named column.</p>
<hr />
<h3 id="cql0099-having-clause-requires-group-by-clause">CQL0099: HAVING
clause requires GROUP BY clause</h3>
<p>The <code>HAVING</code> clause makes no sense unless there is also a
<code>GROUP BY</code> clause. SQLite enforces this as does CQL.</p>
<hr />
<h3 id="cql0100-duplicate-common-table-name-name">CQL0100: duplicate
common table name ‘name’</h3>
<p>In a <code>WITH</code> clause, the indicated common table name was
defined more than once.</p>
<hr />
<h3
id="cql0101-too-few-column-names-specified-in-common-table-expression-name">CQL0101:
too few column names specified in common table expression ‘name’</h3>
<p>In a <code>WITH</code> clause the indicated common table expression
doesn’t include enough column names to capture the result of the
<code>select</code> statement it is associated with.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb530"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb530-1"><a href="#cb530-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> foo(a) <span class="kw">as</span> (<span class="kw">SELECT</span> <span class="dv">1</span> A, <span class="dv">2</span> B) <span class="op">..</span>.`</span></code></pre></div>
<p>The select statement produces two columns the <code>foo</code>
declaration specifies one.</p>
<hr />
<h3
id="cql0102-too-many-column-names-specified-in-common-table-expression-name">CQL0102:
too many column names specified in common table expression ‘name’</h3>
<p>In a <code>WITH</code> clause the indicated common table expression
has more column names than the <code>select</code> expression it is
associated with.</p>
<p>e.g.</p>
<div class="sourceCode" id="cb531"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb531-1"><a href="#cb531-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> foo(a, b) <span class="kw">as</span> (<span class="kw">SELECT</span> <span class="dv">1</span>) <span class="op">..</span>. `</span></code></pre></div>
<p>The select statement produces one column the <code>foo</code>
declaration specifies two.</p>
<hr />
<h3 id="cql0103-duplicate-tableview-name-name">CQL0103: duplicate
table/view name ‘name’</h3>
<p>The indicated table or view must be unique in its context. The
version at the indicated line number is a duplicate of a previous
declaration.</p>
<hr />
<h3
id="cql0104-view-was-present-but-now-it-does-not-exist-use-delete-instead-name">CQL0104:
view was present but now it does not exist (use <code>@delete</code>
instead) ‘name’</h3>
<p>During schema validation, CQL found a view that used to exist but is
now totally gone. The correct procedure is to mark the view with
<code>@delete</code> (you can also make it stub with the same name to
save a little space). This is necessary so that CQL can know what views
should be deleted on client devices during an upgrade. If the view is
eradicated totally there would be no way to know that the view should be
deleted if it exists.</p>
<hr />
<h3 id="cql0105-object-was-a-view-but-is-now-a-table-name">CQL0105:
object was a view but is now a table ‘name’</h3>
<p>Converting a view into a table, or otherwise creating a table with
the same name as a view is not legal.</p>
<hr />
<h3
id="cql0106-trigger-was-present-but-now-it-does-not-exist-use-delete-instead-name">CQL0106:
trigger was present but now it does not exist (use <code>@delete</code>
instead) ‘name’</h3>
<p>During schema validation, CQL found a trigger that used to exist but
is now totally gone. The correct procedure is to mark the trigger with
<code>@delete</code> (you can also make it stub with the same name to
save a little space). This is necessary so that CQL can know what
triggers should be deleted on client devices during an upgrade. If the
trigger is eradicated totally there would be no way to know that the
trigger should be deleted if it exists. That would be bad.</p>
<hr />
<h3 id="cql0107-delete-version-cant-be-create-version-name">CQL0107:
delete version can’t be &lt;= create version ‘name’</h3>
<p>Attempting to declare that an object has been deleted before it was
created is an error. Probably there is a typo in one or both of the
version numbers of the named object.</p>
<hr />
<h3
id="cql0108-table-in-drop-statement-does-not-exist-table_name">CQL0108:
table in drop statement does not exist ‘table_name’</h3>
<p>The indicated table was not declared anywhere. Note that CQL requires
that you declare all tables you will work with, even if all you intend
to do with the table is drop it. When you put a
<code>CREATE TABLE</code> statement in global scope this only declares a
table, it doesn’t actually create the table. See the documentation on
DDL for more information.</p>
<hr />
<h3 id="cql0109-cannot-drop-a-view-with-drop-table-view_name">CQL0109:
cannot drop a view with drop table ‘view_name’</h3>
<p>The object named in a <code>DROP TABLE</code> statement must be a
table, not a view.</p>
<hr />
<h3
id="cql0110-view-in-drop-statement-does-not-exist-view_name">CQL0110:
view in drop statement does not exist ‘view_name’</h3>
<p>The indicated view was not declared anywhere. Note that CQL requires
that you declare all views you will work with, even if all you intend to
do with the view is drop it. When you put a <code>CREATE VIEW</code>
statement in global scope this only declares a view, it doesn’t actually
create the view. See the documentation on DDL for more information.</p>
<hr />
<h3 id="cql0111-cannot-drop-a-table-with-drop-view-name">CQL0111: cannot
drop a table with drop view ‘name’</h3>
<p>The object named in a <code>DROP VIEW</code> statement must be a
view, not a table.</p>
<hr />
<h3
id="cql0112-index-in-drop-statement-was-not-declared-index_name">CQL0112:
index in drop statement was not declared ‘index_name’</h3>
<p>The indicated index was not declared anywhere. Note that CQL requires
that you declare all indices you will work with, even if all you intend
to do with the index is drop it. When you put a
<code>CREATE INDEX</code> statement in global scope this only declares
an index, it doesn’t actually create the index. See the documentation on
DDL for more information.</p>
<hr />
<h3
id="cql0113-trigger-in-drop-statement-was-not-declared-name">CQL0113:
trigger in drop statement was not declared ‘name’</h3>
<p>The indicated trigger was not declared anywhere. Note that CQL
requires that you declare all triggers you will work with, even if all
you intend to do with the trigger is drop it. When you put a
<code>CREATE TRIGGER</code> statement in global scope this only declares
a trigger, it doesn’t actually create the trigger. See the documentation
on DDL for more information.</p>
<hr />
<h3
id="cql0114-current-schema-cant-go-back-to-recreate-semantics-for-table_name">CQL0114:
current schema can’t go back to recreate semantics for ‘table_name’</h3>
<p>The indicated table was previously marked with <code>@create</code>
indicating it has precious content and should be upgraded carefully. The
current schema marks the same table with <code>@recreate</code> meaning
it has discardable content and should be upgraded by dropping it and
recreating it. This transition is not allowed. If the table really is
non-precious now you can mark it with <code>@delete</code> and then make
a new similar table with <code>@recreate</code>. This really shouldn’t
happen very often if at all. Probably the error is due to a typo or
wishful thinking.</p>
<hr />
<h3
id="cql0115-current-create-version-not-equal-to-previous-create-version-for-table">CQL0115:
current create version not equal to previous create version for
‘table’</h3>
<p>The indicated table was previously marked with <code>@create</code>
at some version (x) and now it is being created at some different
version (y !=x ). This not allowed (if it were then objects might be
created in the wrong/different order during upgrade which would cause
all kinds of problems).</p>
<hr />
<h3
id="cql0116-current-delete-version-not-equal-to-previous-delete-version-for-table">CQL0116:
current delete version not equal to previous delete version for
‘table’</h3>
<p>The indicated table was previously marked with <code>@delete</code>
at some version (x) and now it is being deleted at some different
version (y != x). This not allowed (if it were then objects might be
deleted in the wrong/different order during upgrade which would cause
all kinds of problems).</p>
<hr />
<h3 id="cql0117-delete-procedure-changed-in-object-table_name">CQL0117:
<code>@delete</code> procedure changed in object ‘table_name’</h3>
<p>The <code>@delete</code> attribute can optional include a “migration
proc” that is run when the upgrade happens. Once set, this proc can
never be changed.</p>
<hr />
<h3 id="cql0118-create-procedure-changed-in-object-table_name">CQL0118:
<code>@create</code> procedure changed in object ‘table_name’</h3>
<p>The <code>@create</code> attribute can optional include a “migration
proc” that is run when the upgrade happens. Once set, this proc can
never be changed.</p>
<hr />
<h3
id="cql0119-column-name-is-different-between-previous-and-current-schema-name">CQL0119:
column name is different between previous and current schema ‘name’</h3>
<p>Since there is no sqlite operation that allows for columns to be
renamed, attempting to rename a column is not allowed.</p>
<blockquote>
<p>NOTE: you can also get this error if you remove a column entirely, or
add a column in the middle of the list somewhere.</p>
</blockquote>
<p>Since columns (also) cannot be reordered during upgrade, CQL expects
to find all the columns in exactly the same order in the previous and
new schema. Any reordering, or deletion could easily look like an
erroneous rename. New columns must appear at the end of any existing
columns.</p>
<hr />
<h3
id="cql0120-column-type-is-different-between-previous-and-current-schema-name">CQL0120:
column type is different between previous and current schema ‘name’</h3>
<p>It is not possible to change the data type of a column during an
upgrade, SQLite provides no such options. Attempting to do so results in
an error. This includes nullability.</p>
<hr />
<h3
id="cql0121-column-current-create-version-not-equal-to-previous-create-version-name">CQL0121:
column current create version not equal to previous create version
‘name’</h3>
<p>The indicated column was previously marked with <code>@create</code>
at some version (x) and now it is being created at some different
version (y !=x ). This not allowed (if it were then objects might be
created in the wrong/different order during upgrade which would cause
all kinds of problems).</p>
<h3
id="cql0122-column-current-delete-version-not-equal-to-previous-delete-version-name">CQL0122:
column current delete version not equal to previous delete version
‘name’</h3>
<p>The indicated column was previously marked with <code>@delete</code>
at some version (x) and now it is being deleted at some different
version (y != x). This not allowed (if it were then objects might be
deleted in the wrong/different order during upgrade which would cause
all kinds of problems).</p>
<hr />
<h3 id="cql0123-column-delete-procedure-changed-name">CQL0123: column
<code>@delete</code> procedure changed ‘name’</h3>
<p>The <code>@delete</code> attribute can optional include a “migration
proc” that is run when the upgrade happens. Once set, this proc can
never be changed.</p>
<hr />
<h3 id="cql0124-column-create-procedure-changed-name">CQL0124: column
<code>@create</code> procedure changed ‘name’</h3>
<p>The <code>@create</code> attribute can optional include a “migration
proc” that is run when the upgrade happens. Once set, this proc can
never be changed.</p>
<hr />
<h3
id="cql0125-column-current-default-value-not-equal-to-previous-default-value-column">CQL0125:
column current default value not equal to previous default value
‘column’</h3>
<p>The default value of a column may not be changed in later versions of
the schema. There is no SQLite operation that would allow this.</p>
<hr />
<h3
id="cql0126-table-was-present-but-now-it-does-not-exist-use-delete-instead-table">CQL0126:
table was present but now it does not exist (use <code>@delete</code>
instead) ‘table’</h3>
<p>During schema validation, CQL found a table that used to exist but is
now totally gone. The correct procedure is to mark the table with
<code>@delete</code>. This is necessary so that CQL can know what tables
should be deleted on client devices during an upgrade. If the table is
eradicated totally there would be no way to know that the table should
be deleted if it exists. That would be bad.</p>
<hr />
<h3 id="cql0127-object-was-a-table-but-is-now-a-view-name">CQL0127:
object was a table but is now a view ‘name’</h3>
<p>The indicated object was a table in the previous schema but is now a
view in the current schema. This transformation is not allowed.</p>
<hr />
<h3
id="cql0128-table-has-a-column-that-is-different-in-the-previous-and-current-schema-column">CQL0128:
table has a column that is different in the previous and current schema
‘column’</h3>
<p>The indicated column changed in one of its more exotic attributes,
examples:</p>
<ul>
<li>its <code>FOREIGN KEY</code> rules changed in some way</li>
<li>its <code>PRIMARY KEY</code> status changed</li>
<li>its <code>UNIQUE</code> status changed</li>
</ul>
<p>Basically the long form description of the column is now different
and it isn’t different in one of the usual way like type or default
value. This error is the catch all for all the other ways a column could
change such as “the FK rule for what happens when an update fk violation
occurs is now different” – there are dozens of such errors and they
aren’t very helpful anyway.</p>
<hr />
<h3
id="cql0129-a-column-was-removed-from-the-table-rather-than-marked-with-delete-column_name">CQL0129:
a column was removed from the table rather than marked with
<code>@delete</code> ‘column_name’</h3>
<p>During schema validation, CQL found a column that used to exist but
is now totally gone. The correct procedure is to mark the column with
<code>@delete</code>. This is necessary so that CQL can know what
columns existed during any version of the schema, thereby allowing them
to be used in migration scripts during an upgrade. If the column is
eradicated totally there would be no way to know that the exists, and
should no longer be used. That would be bad.</p>
<p>Of course <code>@recreate</code> tables will never get this error
because they can be altered at whim.</p>
<hr />
<h3
id="cql0130-table-has-columns-added-without-marking-them-create-column_name">CQL0130:
table has columns added without marking them <code>@create</code>
‘column_name’</h3>
<p>The indicated column was added but it was not marked with
<code>@create</code>. The table in question is not on the
<code>@recreate</code> plan so this is an error. Add a suitable
<code>@create</code> annotation to the column declaration.</p>
<hr />
<h3
id="cql0131-table-has-newly-added-columns-that-are-marked-both-create-and-delete-column_name">CQL0131:
table has newly added columns that are marked both <code>@create</code>
and <code>@delete</code> ‘column_name’</h3>
<p>The indicated column was simultaneously marked <code>@create</code>
and <code>@delete</code>. That’s surely some kind of typo. Creating a
column and deleting it in the same version is weird.</p>
<hr />
<h3
id="cql0132-table-has-a-facet-that-is-different-in-the-previous-and-current-schema-table_name">CQL0132:
table has a facet that is different in the previous and current schema
‘table_name’</h3>
<p>The indicated table has changes in one of its non-column features.
These changes might be:</p>
<ul>
<li>a primary key declaration</li>
<li>a unique key declaration</li>
<li>a foreign key declaration</li>
</ul>
<p>None of these are allowed to change. Of course <code>@recreate</code>
tables will never get this error because they can be altered at
whim.</p>
<hr />
<h3
id="cql0133-non-column-facets-have-been-removed-from-the-table-name">CQL0133:
non-column facets have been removed from the table ‘name’</h3>
<p>The error indicates that the table has had some stuff removed from
it. The “stuff” might be:</p>
<ul>
<li>a primary key declaration</li>
<li>a unique key declaration</li>
<li>a foreign key declaration</li>
</ul>
<p>Since there is no way to change any of the constraints after the
fact, they may not be changed at all if the table is on the
<code>@create</code> plan. Of course <code>@recreate</code> tables will
never get this error because they can be altered at whim.</p>
<hr />
<h3
id="cql0134-table-has-a-new-non-column-facet-in-the-current-schema-table_name">CQL0134:
table has a new non-column facet in the current schema ‘table_name’</h3>
<p>The error indicates that the table has had some stuff added to it.
The “stuff” might be:</p>
<ul>
<li>a primary key declaration</li>
<li>a unique key declaration</li>
<li>a foreign key declaration</li>
</ul>
<p>Since there is no way to change any of the constraints after the
fact, they may not be changed at all if the table is on the
<code>@create</code> plan. Of course <code>@recreate</code> tables will
never get this error because they can be altered at whim.</p>
<hr />
<h3
id="cql0135-table-create-statement-attributes-different-than-previous-version-table_name">CQL0135:
table create statement attributes different than previous version
‘table_name’</h3>
<p>The ‘flags’ on the <code>CREATE TABLE</code> statement changed
between versions. These flags capture the options like
the<code>TEMP</code> in <code>CREATE TEMP TABLE</code> and the
<code>IF NOT EXISTS</code>. Changing these is not allowed.</p>
<hr />
<h3 id="cql0136-trigger-already-exists-trigger_name">CQL0136: trigger
already exists ‘trigger_name’</h3>
<p>Trigger names may not be duplicated. Probably there is copy/pasta
going on here.</p>
<hr />
<h3 id="cql0137-tableview-not-found-name">CQL0137: table/view not found
‘name’</h3>
<p>In a <code>CREATE TRIGGER</code> statement, the indicated name is
neither a table or a view. Either a table or a view was expected in this
context.</p>
<hr />
<h3
id="cql0138-a-trigger-on-a-view-must-be-the-instead-of-form-name">CQL0138:
a trigger on a view must be the INSTEAD OF form ‘name’</h3>
<p>In a <code>CREATE TRIGGER</code> statement, the named target of the
trigger was a view but the trigger type is not <code>INSTEAD OF</code>.
Only <code>INSTEAD OF</code> can be applied to views because views are
not directly mutable so none of the other types make sense. e.g. there
can be no delete operations, on a view, so <code>BEFORE DELETE</code> or
<code>AFTER DELETE</code> are not really a thing.</p>
<hr />
<h3
id="cql0139-temp-objects-may-not-have-versioning-annotations-object_name">CQL0139:
temp objects may not have versioning annotations ‘object_name’</h3>
<p>The indicated object is a temporary. Since temporary do not survive
sessions it makes no sense to try to version them for schema upgrade.
They are always recreated on demand. If you need to remove one, simply
delete it entirely, it requires no tombstone.</p>
<hr />
<h3
id="cql0140-columns-in-a-temp-table-may-not-have-versioning-attributes-column_name">CQL0140:
columns in a temp table may not have versioning attributes
‘column_name’</h3>
<p>The indicated column is part of a temporary table. Since temp tables
do not survive sessions it makes no sense to try to version their
columns for schema upgrade. They are always recreated on demand.</p>
<hr />
<h3
id="cql0141-table-has-an-autoincrement-column-it-cannot-also-be-without-rowid-table_name">CQL0141:
table has an AUTOINCREMENT column; it cannot also be WITHOUT ROWID
‘table_name’</h3>
<p>SQLite uses its <code>ROWID</code> internally for
<code>AUTOINCREMENT</code> columns. Therefore <code>WITHOUT ROWID</code>
is not a possibility if <code>AUTOINCREMENT</code> is in use.</p>
<hr />
<h3 id="cql0142-duplicate-column-name-column_name">CQL0142: duplicate
column name ‘column_name’</h3>
<p>In a <code>CREATE TABLE</code> statement, the indicated column was
defined twice. This is probably a copy/pasta issue.</p>
<hr />
<h3 id="cql0143-more-than-one-primary-key-in-table-table_name">CQL0143:
more than one primary key in table ‘table_name’</h3>
<p>The indicated table has more than one column with the
<code>PRIMARY KEY</code> attribute or multiple <code>PRIMARY KEY</code>
constraints, or a combination of these things. You’ll have to decide
which one is really intended to be primary.</p>
<hr />
<h3 id="cql0144-cannot-alter-a-view-view_name">CQL0144: cannot alter a
view ‘view_name’</h3>
<p>In an <code>ALTER TABLE</code> statement, the table to be altered is
actually a view. This is not allowed.</p>
<hr />
<h3
id="cql0144-table-in-alter-statement-does-not-exist-table_name">CQL0144:
table in alter statement does not exist ‘table_name’</h3>
<p>In an <code>ALTER TABLE</code> statement, the table to be altered was
not defined, or perhaps was marked with <code>@delete</code> and is no
longer usable in the current schema version.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3
id="cql0145-version-annotations-not-valid-in-alter-statement-column_name">CQL0145:
version annotations not valid in alter statement ‘column_name’</h3>
<p>In an <code>ALTER TABLE</code> statement, the attributes on the
column may not include <code>@create</code> or <code>@delete</code>.
Those annotations go on the columns declaration in the corresponding
<code>CREATE TABLE</code> statement.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3
id="cql0146-adding-an-auto-increment-column-is-not-allowed-column_name">CQL0146:
adding an auto increment column is not allowed ‘column_name’</h3>
<p>In an <code>ALTER TABLE</code> statement, the attributes on the
column may not include <code>AUTOINCREMENT</code>. SQLite does not
support the addition of new <code>AUTOINCREMENT</code> columns.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3
id="cql0147-adding-a-not-nullable-column-with-no-default-value-is-not-allowed-column_name">CQL0147:
adding a not nullable column with no default value is not allowed
‘column_name’</h3>
<p>In an <code>ALTER TABLE</code> statement the attributes on the named
column must include a default value or else the column must be nullable.
This is so that SQLite knows what value to put on existing rows when the
column is added and also so that any existing insert statements will not
suddenly all become invalid. If the column is nullable or has a default
value then the existing insert statements that don’t specify the column
will continue to work, using either NULL or the default.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3
id="cql0148-added-column-must-already-be-reflected-in-declared-schema-with-create-exact-name-match-required-column_name">CQL0148:
added column must already be reflected in declared schema, with
<code>@create</code>, exact name match required ‘column_name’</h3>
<p>In CQL loose schema is a declaration, it does not actually create
anything unless placed inside of a procedure. A column that is added
with <code>ALTER TABLE</code> is not actually declared as part of the
schema by the <code>ALTER</code>. Rather the schema declaration is
expected to include any columns you plan to add. Normally the way this
all happens is that you put <code>@create</code> notations on a column
in the schema and the automatic schema upgrader then creates suitable
<code>ALTER TABLE</code> statements to arrange for that column to be
added. If you manually write an <code>ALTER TABLE</code> statement it
isn’t allowed to add columns at whim; in some sense it must be creating
the reality already described in the declaration. This is exactly what
the automated schema upgrader does – it declares the end state and then
alters the world to get to that state.</p>
<p>It’s important to remember that from CQL’s perspective the schema is
fixed for any given compilation, so runtime alterations to it are not
really part of the type system. They can’t be. Even
<code>DROP TABLE</code> does not remove the table from type system – it
can’t – the most likely situation is that you are about to recreate that
same table again for another iteration with the proc that creates
it.</p>
<p>This particular error is saying that the column you are trying to add
does not exist in the declared schema.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3
id="cql0149-added-column-must-be-an-exact-match-for-the-column-type-declared-in-the-table-column_name">CQL0149:
added column must be an exact match for the column type declared in the
table ‘column_name’</h3>
<p>In CQL loose schema is a declaration, it does not actually create
anything unless placed inside of a procedure. A column that is added
with <code>ALTER TABLE</code> is not actually declared as part of the
schema by the <code>ALTER</code>. Rather the schema declaration is
expected to include any columns you plan to add. Normally the way this
all happens is that you put <code>@create</code> notations on a column
in the schema and the automatic schema upgrader then creates suitable
<code>ALTER TABLE</code> statements to arrange for that column to be
added. If you manually write an <code>ALTER TABLE</code> statement it
isn’t allowed to add columns at whim; in some sense it must be creating
the reality already described in the declaration. This is exactly what
the automated schema upgrader does – it declares the end state and then
alters the world to get to that state.</p>
<p>It’s important to remember that from CQL’s perspective the schema is
fixed for any given compilation, so runtime alterations to it are not
really part of the type system. They can’t be. Even
<code>DROP TABLE</code> does not remove the table from type system – it
can’t – the most likely situation is that you are about to recreate that
same table again for another iteration with the proc that creates
it.</p>
<p>This particular error is saying that the column you are trying to add
exists in the declared schema, but its definition is different than you
have specified in the <code>ALTER TABLE</code> statement.</p>
<blockquote>
<p>NOTE: <code>ALTER TABLE</code> is typically not used directly; the
automated schema upgrade script generation system uses it.</p>
</blockquote>
<hr />
<h3 id="cql0150-expected-numeric-expression-in-if-predicate">CQL0150:
expected numeric expression in IF predicate</h3>
<p>In an <code>IF</code> statement the condition (predicate) must be a
numeric. The body of the <code>IF</code> runs if the value is not null
and not zero.</p>
<hr />
<h3
id="cql0151-table-in-delete-statement-does-not-exist-table_name">CQL0151:
table in delete statement does not exist ‘table_name’</h3>
<p>In a <code>DELETE</code> statement, the indicated table does not
exist. Probably it’s a spelling mistake, or else the table has been
marked with <code>@delete</code> and may no longer be used in
<code>DELETE</code> statements.</p>
<hr />
<h3 id="cql0152-cannot-delete-from-a-view-view_name">CQL0152: cannot
delete from a view ‘view_name’</h3>
<p>In a <code>DELETE</code> statement, the target of the delete must be
a table, but the indicated name is a view.</p>
<hr />
<h3
id="cql0153-duplicate-target-column-name-in-update-statement-column_name">CQL0153:
duplicate target column name in update statement ‘column_name’</h3>
<p>In an <code>UPDATE</code> statement, you can only specify any
particular column to update once.</p>
<p>e.g. <code>UPDATE coordinates set x = 1, x = 3;</code> will produce
this error. <code>UPDATE coordinates set x = 1, y = 3;</code> might be
correct.</p>
<p>This error is most likely caused by a typo or a copy/pasta of the
column names, especially if they were written one per line.</p>
<hr />
<h3
id="cql0154-table-in-update-statement-does-not-exist-table_name">CQL0154:
table in update statement does not exist ‘table_name’</h3>
<p>In an <code>UPDATE</code> statement, the target table does not exist.
Probably it’s a spelling mistake, or else the table has been marked with
<code>@delete</code> and may no longer be used in <code>UPDATE</code>
statements.</p>
<hr />
<h3 id="cql0155-cannot-update-a-view-view_name">CQL0155: cannot update a
view ‘view_name’</h3>
<p>In an <code>UPDATE</code> statement, the target of the update must be
a table but the name of a view was provided.</p>
<hr />
<h3 id="cql0156-seed-expression-must-be-a-non-nullable-integer">CQL0156:
seed expression must be a non-nullable integer</h3>
<p>The <code>INSERT</code> statement statement supports the notion of
synthetically generated values for dummy data purposes. A ‘seed’ integer
is used to derive the values. That seed (in the <code>@seed()</code>
position) must be a non-null integer.</p>
<p>The most common reason for this error is that the seed is an input
parameter and it was not declared <code>NOT NULL</code>.</p>
<hr />
<h3 id="cql0157-count-of-columns-differs-from-count-of-values">CQL0157:
count of columns differs from count of values</h3>
<p>In an <code>INSERT</code> statement of the form
<code>INSERT INTO foo(a, b, c) VALUES(x, y, z)</code> the number of
values (x, y, z) must be the same as the number of columns (a, b, c).
Note that there are many reasons you might not have to specify all the
columns of the table but whichever columns you do specify should have
values.</p>
<hr />
<h3
id="cql0158-required-column-missing-in-insert-statement-column_name">CQL0158:
required column missing in INSERT statement ‘column_name’</h3>
<p>In an <code>INSERT</code> statement such as
<code>INSERT INTO foo(a,b,c) VALUES(x,yz)</code> this error is
indicating that there is a column in <code>foo</code> (the one indicated
in the error) which was not in the list (i.e. not one of a, b, c) and
that column is neither nullable, nor does it have a default value. In
order to insert a row a value must be provided. To fix this include the
indicated column in your insert statement.</p>
<hr />
<h3
id="cql0159-cannot-add-an-index-to-a-virtual-table-table_name">CQL0159:
cannot add an index to a virtual table ‘table_name’</h3>
<p>Adding an index to a virtual table isn’t possible, the virtual table
includes whatever indexing its module provides, no further indexing is
possible.</p>
<p>From the SQLite documentation: “One cannot create additional indices
on a virtual table. (Virtual tables can have indices but that must be
built into the virtual table implementation. Indices cannot be added
separately using CREATE INDEX statements.)”</p>
<hr />
<h3
id="cql0160-table-in-insert-statement-does-not-exist-table_name">CQL0160:
table in insert statement does not exist ‘table_name’</h3>
<p>In an <code>INSERT</code> statement attempting to insert into the
indicated table name is not possible because there is no such table.
This error might happen because of a typo, or it might happen because
the indicated table has been marked with <code>@delete</code> and is
logically hidden.</p>
<hr />
<h3 id="cql0161-cannot-insert-into-a-view-view_name">CQL0161: cannot
insert into a view ‘view_name’</h3>
<p>In an <code>INSERT</code> statement attempting to insert into the
indicated name is not possible because that name is a view not a table.
Inserting into views is not supported.</p>
<hr />
<h3
id="cql0162-cannot-add-a-trigger-to-a-virtual-table-table_name">CQL0162:
cannot add a trigger to a virtual table ‘table_name’</h3>
<p>Adding a trigger to a virtual table isn’t possible.</p>
<p>From the SQLite documentation: “One cannot create a trigger on a
virtual table.”</p>
<hr />
<h3
id="cql0163-from-arguments-construct-is-only-valid-inside-a-procedure">CQL0163:
FROM ARGUMENTS construct is only valid inside a procedure</h3>
<p>Several statements support the <code>FROM ARGUMENTS</code> sugar
format like <code>INSERT INTO foo(a,b,c) FROM ARGUMENTS</code> which
causes the arguments of the current procedure to be used as the values.
This error is complaining that you have used this form but the statement
does not occur inside of a procedure so there can be no arguments. This
form does not make sense outside of any procedure.</p>
<hr />
<h3
id="cql0164-cannot-use-alter-table-on-a-virtual-table-table_name">CQL0164:
cannot use ALTER TABLE on a virtual table ‘table_name’</h3>
<p>This is not supported by SQLite.</p>
<p>From the SQLite documentation: “One cannot run ALTER TABLE … ADD
COLUMN commands against a virtual table.”</p>
<hr />
<h3
id="cql0165-fetch-values-is-only-for-value-cursors-not-for-sqlite-cursors-cursor_name">CQL0165:
fetch values is only for value cursors, not for sqlite cursors
‘cursor_name’</h3>
<p>Cursors come in two flavors. There are “statement cursors” which are
built from something like this:</p>
<div class="sourceCode" id="cb532"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb532-1"><a href="#cb532-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo;</span>
<span id="cb532-2"><a href="#cb532-2" aria-hidden="true" tabindex="-1"></a>fetch C;</span>
<span id="cb532-3"><a href="#cb532-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- or --</span></span>
<span id="cb532-4"><a href="#cb532-4" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">into</span> a, b, c;</span></code></pre></div>
<p>That is, they come from a SQLite statement and you can fetch values
from that statement. The second type comes from procedural values like
this.</p>
<div class="sourceCode" id="cb533"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb533-1"><a href="#cb533-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_table;</span>
<span id="cb533-2"><a href="#cb533-2" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">values</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>);</span></code></pre></div>
<p>In the second example <code>C</code>’s data type will be the same as
the columns in <code>my_table</code> and we will fetch its values from
<code>1,2,3</code> – this version has no database backing at all, it’s
just data.</p>
<p>This error says that you declared the cursor in the first form (with
a SQL statement) but then you tried to fetch it using the second form,
the one for data. These forms don’t mix. If you need a value cursor for
a row you can copy data from one cursor into another.</p>
<hr />
<h3 id="cql0166-count-of-columns-differs-from-count-of-values">CQL0166:
count of columns differs from count of values</h3>
<p>In a value cursor, declared something like this:</p>
<div class="sourceCode" id="cb534"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb534-1"><a href="#cb534-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_table;</span>
<span id="cb534-2"><a href="#cb534-2" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">values</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>);</span></code></pre></div>
<p>The type of the cursor ( in this case from <code>my_table</code>)
requires a certain number of columns, but that doesn’t match the number
that were provided in the values.</p>
<p>To fix this you’ll need to add/remove values so that the type
match.</p>
<hr />
<h3
id="cql0167-required-column-missing-in-fetch-statement-column_name">CQL0167:
required column missing in FETCH statement ‘column_name’</h3>
<p>In a value cursor, declared something like this:</p>
<div class="sourceCode" id="cb535"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb535-1"><a href="#cb535-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> my_table;</span>
<span id="cb535-2"><a href="#cb535-2" aria-hidden="true" tabindex="-1"></a>fetch C(a,b,c) <span class="kw">from</span> <span class="kw">values</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>);</span></code></pre></div>
<p>This error is saying that there is some other field in the table ‘d’
and it was not specified in the values. Nor was there a usable dummy
data for that column that could be used. You need to provide a value for
the missing column.</p>
<hr />
<h3
id="cql0168-cql-has-no-good-way-to-generate-dummy-blobs-not-supported-for-now">CQL0168:
CQL has no good way to generate dummy blobs; not supported for now</h3>
<p>In a value cursor with dummy data specified, one of the columns in
the cursor is of type blob. There’s no good way to create dummy data for
blobs so that isn’t supported.</p>
<hr />
<h3 id="cql0169-enum-not-found-enum_name">CQL0169: enum not found
‘enum_name’</h3>
<p>The indicated name was used in a context where an enumerated type
name was expected but there is no such type.</p>
<p>Perhaps the enum was not included (missing a #include) or else there
is a typo.</p>
<hr />
<h3
id="cql0170-cast-is-redundant-remove-to-reduce-code-size-expression">CQL0170:
cast is redundant, remove to reduce code size ‘expression’</h3>
<p>The operand of the <code>CAST</code> expression is already the type
that it is being cast to. The cast will do nothing but waste space in
the binary and make the code less clear. Remove it.</p>
<hr />
<h3 id="cql0171-name-not-found-name">CQL0171: name not found ‘name’</h3>
<p>In a scoped name list, like the columns of a cursor (for a fetch), or
the columns of a particular table (for an index) a name appeared that
did not belong to the universe of legal names. Trying to make a table
index using a column that is not in the table would produce this error.
There are many instances where a list of names belongs to some limited
scope.</p>
<hr />
<h3 id="cql0172-name-list-has-duplicate-name-name">CQL0172: name list
has duplicate name ‘name’</h3>
<p>In a scoped name list, like the columns of a cursor (for a fetch), or
the columns of a particular table (for an index) a name appeared twice
in the list where the names must be unique. Trying to make a table index
using the same column twice would produce this error.</p>
<hr />
<h3 id="cql0173-variable-not-found-variable_name">CQL0173: variable not
found ‘variable_name’</h3>
<p>In a <code>SET</code> statement, the target of the assignment is not
a valid variable name in that scope.</p>
<hr />
<h3 id="cql0174-cannot-set-a-cursor-cursor_name">CQL0174: cannot set a
cursor ‘cursor_name’</h3>
<p>In a <code>SET</code> statement, the target of the assignment is a
cursor variable, you cannot assign to a cursor variable.</p>
<hr />
<h3 id="cql0175-duplicate-parameter-name-parameter_name">CQL0175:
duplicate parameter name ‘parameter_name’</h3>
<p>In a parameter list for a function or a procedure, the named
parameter appears more than once. The formal names for function
arguments must be unique.</p>
<hr />
<h3
id="cql0176-indicated-procedure-or-group-already-has-a-recreate-action-name">CQL0176:
indicated procedure or group already has a recreate action ‘name’</h3>
<p>There can only be one migration rule for a table or group, the
indicated item already has such an action. If you need more than one
migration action you can create a containing procedure that dispatches
to other migrators.</p>
<hr />
<h3
id="cql0177-global-constants-must-be-either-constant-numeric-expressions-or-string-literals-constant_definition">CQL0177:
global constants must be either constant numeric expressions or string
literals ‘constant_definition’</h3>
<p>Global constants must be either a combination other constants for
numeric expressions or else string literals. The indicated expression
was not one of those.</p>
<p>This can happen if the expression uses variables, or has other
problems that prevent it from evaluating, or if a function is used that
is not supported.</p>
<hr />
<h3 id="cql0178-proc-has-no-result-like_name">CQL0178: proc has no
result ‘like_name’</h3>
<p>In an argument list, the <code>LIKE</code> construct was used to
create arguments that are the same as the return type of the named
procedure. However the named procedure does not produce a result set and
therefore has no columns to mimic. Probably the name is wrong.</p>
<hr />
<h3
id="cql0179-shared-fragments-must-consist-of-exactly-one-top-level-statement-procedure_name">CQL0179:
shared fragments must consist of exactly one top level statement
‘procedure_name’</h3>
<p>Any shared fragment can have only one statement. There are three
valid forms – IF/ELSE, WITH … SELECT, and SELECT.</p>
<p>This error indicates the named procedure, which is a shared fragment,
has more than one statement.</p>
<hr />
<h3
id="cql0180-duplicate-column-name-in-result-not-allowed-column_name">CQL0180:
duplicate column name in result not allowed ‘column_name’</h3>
<p>In a procedure that returns a result either with a loose
<code>SELECT</code> statement or in a place where the result of a
<code>SELECT</code> is captured with a <code>FETCH</code> statement the
named column appears twice in the projection of the <code>SELECT</code>
in question. The column names must be unique in order to have consistent
cursor field names or consistent access functions for the result set of
the procedure. One instance of the named column must be renamed with
something like
<code>select T1.foo first_foo, T2.foo second_foo</code>.</p>
<hr />
<h3 id="cql0181-autodrop-temp-table-does-not-exist-name">CQL0181:
autodrop temp table does not exist ‘name’</h3>
<p>In a <code>cql:autodrop</code> annotation, the given name is unknown
entirely.</p>
<hr />
<h3 id="cql0182-autodrop-target-is-not-a-table-name">CQL0182: autodrop
target is not a table ‘name’</h3>
<p>In a <code>cql:autodrop</code> annotation, the given name is not a
table (it’s probably a view).</p>
<hr />
<h3 id="cql0183-autodrop-target-must-be-a-temporary-table-name">CQL0183:
autodrop target must be a temporary table ‘name’</h3>
<p>In a <code>cql:autodrop</code> annotation, the given name is a table
but it is not a temp table. The annotation is only valid on temp tables,
it’s not for “durable” tables.</p>
<hr />
<h3 id="cql0184-stored-procedures-cannot-be-nested-name">CQL0184: stored
procedures cannot be nested ‘name’</h3>
<p>The <code>CREATE PROCEDURE</code> statement may not appear inside of
another stored procedure. The named procedure appears in a nested
context.</p>
<hr />
<h3 id="cql0185-proc-name-conflicts-with-func-name-name">CQL0185: proc
name conflicts with func name ‘name’</h3>
<p>In a <code>CREATE PROCEDURE</code> statement, the given name
conflicts with an already declared function
(<code>DECLARE FUNCTION</code> or <code>DECLARE SELECT FUNCTION</code>).
You’ll have to choose a different name.</p>
<hr />
<h3 id="cql0186-duplicate-stored-proc-name-name">CQL0186: duplicate
stored proc name ‘name’</h3>
<p>In a <code>CREATE PROCEDURE</code> statement, the indicated name
already corresponds to a created (not just declared) stored procedure.
You’ll have to choose a different name.</p>
<hr />
<h3
id="cql0187-schema_upgrade_version-not-declared-or-doesnt-match-upgrade-version-n-for-proc-name">CQL0187:
<span class="citation"
data-cites="schema_upgrade_version">@schema_upgrade_version</span> not
declared or doesn’t match upgrade version <code>N</code> for proc
‘name’</h3>
<p>The named procedure was declared as a schema migration procedure in
an <code>@create</code> or <code>@delete</code> annotation for schema
version <code>N</code>. In order to correctly type check such a
procedure it must be compiled in the context of schema version
<code>N</code>. This restriction is required so that the tables and
columns the procedure sees are the ones that existed in version
<code>N</code> not the ones that exist in the most recent version as
usual.</p>
<p>To create this condition, the procedure must appear in a file that
begins with the line:</p>
<div class="sourceCode" id="cb536"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb536-1"><a href="#cb536-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@schema_upgrade_version &lt;N&gt;;</span></span></code></pre></div>
<p>And this declaration must come before any <code>CREATE TABLE</code>
statements. If there is no such declaration, or if it is for the wrong
version, then this error will be generated.</p>
<hr />
<h3
id="cql0188-procedure-is-supposed-to-do-schema-migration-but-it-doesnt-have-any-dml-name">CQL0188:
procedure is supposed to do schema migration but it doesn’t have any DML
‘name’</h3>
<p>The named procedure was declared as a schema migration procedure in
an <code>@create</code> or <code>@delete</code> annotation, however the
procedure does not have any DML in it. That can’t be right. Some kind of
data reading and writing is necessary.</p>
<hr />
<h3
id="cql0189-procedure-declarationsdefinitions-do-not-match-name">CQL0189:
procedure declarations/definitions do not match ‘name’</h3>
<p>The named procedure was previously declared with a
<code>DECLARE PROCEDURE</code> statement but when the
<code>CREATE PROCEDURE</code> was encountered, it did not match the
previous declaration.</p>
<hr />
<h3 id="cql0190-duplicate-column-name-name">CQL0190: duplicate column
name ‘name’</h3>
<p>In a context with a typed name list
(e.g. <code>id integer, t text</code>) the named column occurs twice.
Typed name lists happen in many contexts, but a common one is the type
of the result in a declared procedure statement or declared function
statement.</p>
<hr />
<h3
id="cql0191-declared-functions-must-be-top-level-function_name">CQL0191:
declared functions must be top level ‘function_name’</h3>
<p>A <code>DECLARE FUNCTION</code> statement for the named function is
happening inside of a procedure. This is not legal. To correct this move
the declaration outside of the procedure.</p>
<hr />
<h3 id="cql0192-func-name-conflicts-with-proc-name-name">CQL0192: func
name conflicts with proc name ‘name’</h3>
<p>The named function in a <code>DECLARE FUNCTION</code> statement
conflicts with an existing declared or created procedure. One or the
other must be renamed to resolve this issue.</p>
<hr />
<h3 id="cql0193-duplicate-function-name-name">CQL0193: duplicate
function name ‘name’</h3>
<p>The named function in a <code>DECLARE FUNCTION</code> statement
conflicts with an existing declared function, or it was declared twice.
One or the other declaration must be renamed or removed to resolve this
issue.</p>
<hr />
<h3 id="cql0194-declared-procedures-must-be-top-level-name">CQL0194:
declared procedures must be top level ‘name’</h3>
<p>A <code>DECLARE PROCEDURE</code> statement for the named procedure is
itself happening inside of a procedure. This is not legal. To correct
this move the declaration outside of the procedure.</p>
<hr />
<h3 id="cql0195-proc-name-conflicts-with-func-name-name">CQL0195: proc
name conflicts with func name ‘name’</h3>
<p>The named procedure in a <code>DECLARE PROCEDURE</code> statement
conflicts with an existing declared function. One or the other
declaration must be renamed or removed to resolve this issue.</p>
<hr />
<h3
id="cql0196-procedure-declarationsdefinitions-do-not-match-name">CQL0196:
procedure declarations/definitions do not match ‘name’</h3>
<p>The named procedure was previously declared with a
<code>DECLARE PROCEDURE</code> statement. Now there is another
declaration and it does not match the previous declaration</p>
<hr />
<h3 id="cql0197-duplicate-variable-name-in-the-same-scope-name">CQL0197:
duplicate variable name in the same scope ‘name’</h3>
<p>In a <code>DECLARE</code> statement, a variable of the same name
already exists in that scope. Note that CQL does not have block level
scope, all variables are procedure level, so they are in scope until the
end of the procedure. To resolve this problem, either re-use the old
variable if appropriate or rename the new variable.</p>
<hr />
<h3 id="cql0198-global-variable-hides-tableview-name-name">CQL0198:
global variable hides table/view name ‘name’</h3>
<p>In a <code>DECLARE</code> statement, the named variable is a global
(declared outside of any procedure) and has the same name as a table or
view. This creates a lot of confusion and is therefore disallowed. To
correct the problem, rename the variable. Global variables generally are
problematic, but sometimes necessary.</p>
<hr />
<h3
id="cql0199-cursor-requires-a-procedure-that-returns-a-result-set-via-select-procedure_name">CQL0199:
cursor requires a procedure that returns a result set via select
‘procedure_name’</h3>
<p>In a <code>DECLARE</code> statement that declares a
<code>CURSOR FOR CALL</code> the procedure that is being called does not
produce a result set with the <code>SELECT</code> statement. As it has
no row results it is meaningless to try to put a cursor on it. Probably
the error is due to a copy/pasta of the procedure name.</p>
<hr />
<h3 id="cql0200-variable-is-not-a-cursor-another_cursor">CQL0200:
variable is not a cursor ‘another_cursor’</h3>
<p>In a <code>DECLARE</code> statement that declares a
<code>CURSOR LIKE</code> another cursor, the indicated name is a
variable but it is not a cursor, so we cannot make another cursor like
it. Probably the error is due to a typo in the ‘like_name’.</p>
<hr />
<h3
id="cql0201-expanding-from-arguments-there-is-no-argument-matching-required_arg">CQL0201:
expanding FROM ARGUMENTS, there is no argument matching
‘required_arg’</h3>
<p>In an <code>INSERT</code> or <code>FETCH</code> statement using the
form <code>FROM ARGUMENTS(LIKE [name])</code> The shape
<code>[name]</code> had columns that did not appear in as arguments to
the current procedure. Maybe arguments are missing or maybe the name in
the <code>like</code> part is the wrong name.</p>
<hr />
<h3 id="cql0202-must-be-a-cursor-proc-table-or-view-like_name">CQL0202:
must be a cursor, proc, table, or view ‘like_name’</h3>
<p>In a <code>DECLARE</code> statement that declares a
<code>CURSOR LIKE</code> some other name, the indicated name is not the
name of any of the things that might have a valid shape to copy, like
other cursors, procedures, tables, or views. Probably there is a typo in
the name.</p>
<hr />
<h3
id="cql0203-cursor-requires-a-procedure-that-returns-a-cursor-with-out-cursor_name">CQL0203:
cursor requires a procedure that returns a cursor with OUT
‘cursor_name’</h3>
<p>In the
<code>DECLARE [cursor_name] CURSOR FETCH FROM CALL &lt;something&gt;</code>
form, the code is trying to create the named cursor by calling a
procedure that doesn’t actually produce a single row result set with the
<code>OUT</code> statement. The procedure is valid (that would be a
different error) so it’s likely that the wrong procedure is being called
rather than being an outright typo. Or perhaps the procedure was changed
such that it no longer produces a single row result set.</p>
<p>This form is equivalent to:</p>
<div class="sourceCode" id="cb537"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb537-1"><a href="#cb537-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> [cursor_name] <span class="kw">LIKE</span> <span class="kw">procedure</span>;</span>
<span id="cb537-2"><a href="#cb537-2" aria-hidden="true" tabindex="-1"></a>FETCH [cursor_name] <span class="kw">FROM</span> <span class="kw">CALL</span> <span class="kw">procedure</span>(args);</span></code></pre></div>
<p>It’s the declaration that’s failing here, not the call.</p>
<hr />
<p>CQL0204 Unused.</p>
<hr />
<h3 id="cql0205-not-a-cursor-name">CQL0205: not a cursor ‘name’</h3>
<p>The indicated name appeared in a context where the name of a cursor
was expected, but the name does not refer to a cursor.</p>
<hr />
<h3 id="cql0206-duplicate-name-in-list-name">CQL0206: duplicate name in
list ‘name’</h3>
<p>There are many contexts where a list of names appears in the CQL
grammar and the list must not contain duplicate names. Some examples
are:</p>
<ul>
<li>the column names in a <code>JOIN ... USING(x,y,z,...)</code>
clause</li>
<li>the fetched variables in a <code>FETCH [cursor] INTO x,y,z...</code>
statement</li>
<li>the column names listed in a common table expression
<code>CTE(x,y,z,...) as (SELECT ...)</code></li>
<li>the antecedent schema region names in
<code>@declare_schema_region &lt;name&gt; USING x,y,z,...</code></li>
</ul>
<p>The indicated name was duplicated in such a context.</p>
<hr />
<h3
id="cql0207-expected-a-variable-name-for-out-or-inout-argument-param_name">CQL0207:
expected a variable name for OUT or INOUT argument ‘param_name’</h3>
<p>In a procedure call, the indicated parameter of the procedure is an
OUT or INOUT parameter but the call site doesn’t have a variable in that
position in the argument list.</p>
<p>Example:</p>
<div class="sourceCode" id="cb538"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb538-1"><a href="#cb538-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc foo(<span class="kw">out</span> x <span class="dt">integer</span>);</span>
<span id="cb538-2"><a href="#cb538-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb538-3"><a href="#cb538-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- the constant 1 cannot be used in the out position when calling foo</span></span>
<span id="cb538-4"><a href="#cb538-4" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> foo(<span class="dv">1</span>); <span class="st">&#39;</span></span></code></pre></div>
<hr />
<h3
id="cql0208-shared-fragments-cannot-have-any-out-or-inout-parameters-param_name">CQL0208:
shared fragments cannot have any out or in/out parameters
‘param_name’</h3>
<p>A shared fragment will be expanded into the body of a SQL select
statement, as such it can have no side-effects such as out
arguments.</p>
<hr />
<h3
id="cql0209-proc-out-parameter-arg-must-be-an-exact-type-match-expected-expected_type-found-actual_type-param_name">CQL0209:
proc out parameter: arg must be an exact type match (expected
expected_type; found actual_type) ‘param_name’</h3>
<p>In a procedure call, the indicated parameter is in an ‘out’ position,
it is a viable local variable but it is not an exact type match for the
parameter. The type of variable used to capture out parameters must be
an exact match.</p>
<div class="sourceCode" id="cb539"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb539-1"><a href="#cb539-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc foo(<span class="kw">out</span> x <span class="dt">integer</span>);</span>
<span id="cb539-2"><a href="#cb539-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb539-3"><a href="#cb539-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc bar(<span class="kw">out</span> y <span class="dt">real</span>)</span>
<span id="cb539-4"><a href="#cb539-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb539-5"><a href="#cb539-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> foo(y); <span class="co">-- y is a real variable, not an integer.</span></span>
<span id="cb539-6"><a href="#cb539-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above produces:</p>
<div class="sourceCode" id="cb540"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb540-1"><a href="#cb540-1" aria-hidden="true" tabindex="-1"></a>CQL0209: proc <span class="kw">out</span> parameter: arg must be an exact <span class="kw">type</span> match</span>
<span id="cb540-2"><a href="#cb540-2" aria-hidden="true" tabindex="-1"></a>(expected <span class="dt">integer</span>; found <span class="dt">real</span>) <span class="st">&#39;y&#39;</span></span></code></pre></div>
<hr />
<h3
id="cql0210-proc-out-parameter-arg-must-be-an-exact-type-match-even-nullability">CQL0210:
proc out parameter: arg must be an exact type match (even
nullability)</h3>
<p>(expected expected_type; found actual_type) ‘variable_name’</p>
<p>In a procedure call, the indicated parameter is in an ‘out’ position,
it is a viable local variable of the correct type but the nullability
does not match. The type of variable used to capture out parameters must
be an exact match.</p>
<div class="sourceCode" id="cb541"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb541-1"><a href="#cb541-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc foo(<span class="kw">out</span> x <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb541-2"><a href="#cb541-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb541-3"><a href="#cb541-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc bar(<span class="kw">out</span> y <span class="dt">integer</span>)</span>
<span id="cb541-4"><a href="#cb541-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb541-5"><a href="#cb541-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> foo(y); <span class="co">-- y is nullable but foo is expecting not null.</span></span>
<span id="cb541-6"><a href="#cb541-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above produces:</p>
<div class="sourceCode" id="cb542"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb542-1"><a href="#cb542-1" aria-hidden="true" tabindex="-1"></a>CQL0210: proc <span class="kw">out</span> parameter: arg must be an exact <span class="kw">type</span> match (even nullability)</span>
<span id="cb542-2"><a href="#cb542-2" aria-hidden="true" tabindex="-1"></a>(expected <span class="dt">integer</span> notnull; found <span class="dt">integer</span>) <span class="st">&#39;y&#39;</span></span></code></pre></div>
<hr />
<h3
id="cql0211-procedure-without-trailing-out-parameter-used-as-function-procedure_name">CQL0211:
procedure without trailing OUT parameter used as function
‘procedure_name’</h3>
<p>In a function call, the target of the function call was a procedure,
procedures can be used like functions but their last parameter must be
marked <code>out</code>. That will be the return value. In this case the
last argument was not marked as <code>out</code> and so the call is
invalid.</p>
<p>Example:</p>
<div class="sourceCode" id="cb543"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb543-1"><a href="#cb543-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc foo(x <span class="dt">integer</span>);</span>
<span id="cb543-2"><a href="#cb543-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb543-3"><a href="#cb543-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc bar(<span class="kw">out</span> y <span class="dt">integer</span>)</span>
<span id="cb543-4"><a href="#cb543-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb543-5"><a href="#cb543-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> y <span class="op">:=</span> foo(); <span class="co">-- foo does not have an out argument at the end</span></span>
<span id="cb543-6"><a href="#cb543-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<hr />
<h3 id="cql0212-too-few-arguments-provided-to-procedure-name">CQL0212:
too few arguments provided to procedure ‘name’</h3>
<p>In a procedure call to the named procedure, not enough arguments were
provided to make the call. One or more arguments may have been omitted
or perhaps the called procedure has changed such that it now requires
more arguments.</p>
<hr />
<h3 id="cql0213-procedure-had-errors-cant-call.-procedure_name">CQL0213:
procedure had errors, can’t call. ‘procedure_name’</h3>
<p>In a procedure call to the named procedure, the target of the call
had compilation errors. As a consequence this call cannot be checked and
therefore must be marked in error, too. Fix the errors in the named
procedure.</p>
<hr />
<h3
id="cql0214-procedures-with-results-can-only-be-called-using-a-cursor-in-global-context-name">CQL0214:
procedures with results can only be called using a cursor in global
context ‘name’</h3>
<p>The named procedure results a result set, either with the
<code>SELECT</code> statement or the <code>OUT</code> statement. However
it is being called from outside of any procedure. Because of this, its
result cannot then be returned anywhere. As a result, at the global
level the result must be capture with a cursor.</p>
<p>Example:</p>
<div class="sourceCode" id="cb544"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb544-1"><a href="#cb544-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo()</span>
<span id="cb544-2"><a href="#cb544-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb544-3"><a href="#cb544-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> bar;</span>
<span id="cb544-4"><a href="#cb544-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb544-5"><a href="#cb544-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb544-6"><a href="#cb544-6" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> foo();  <span class="co">-- this is not valid</span></span>
<span id="cb544-7"><a href="#cb544-7" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">cursor</span> C <span class="cf">for</span> <span class="kw">call</span> foo();  <span class="co">-- C captures the result of foo, this is ok.</span></span></code></pre></div>
<hr />
<h3
id="cql0215-value-cursors-are-not-used-with-fetch-c-or-fetch-c-into-cursor_name">CQL0215:
value cursors are not used with FETCH C, or FETCH C INTO
‘cursor_name’</h3>
<p>In a <code>FETCH</code> statement of the form
<code>FETCH [cursor]</code> or <code>FETCH [cursor] INTO</code> the
named cursor is a value cursor. These forms of the <code>FETCH</code>
statement apply only to statement cursors.</p>
<p>Example:good</p>
<div class="sourceCode" id="cb545"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb545-1"><a href="#cb545-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- value cursor shaped like a table</span></span>
<span id="cb545-2"><a href="#cb545-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> bar;</span>
<span id="cb545-3"><a href="#cb545-3" aria-hidden="true" tabindex="-1"></a><span class="co">--ok, C is fetched from the select results</span></span>
<span id="cb545-4"><a href="#cb545-4" aria-hidden="true" tabindex="-1"></a>fetch C;</span></code></pre></div>
<p>Example: bad</p>
<div class="sourceCode" id="cb546"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb546-1"><a href="#cb546-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- value cursor shaped like a table</span></span>
<span id="cb546-2"><a href="#cb546-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="kw">like</span> bar;</span>
<span id="cb546-3"><a href="#cb546-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- invalid, there is no source for fetching a value cursor</span></span>
<span id="cb546-4"><a href="#cb546-4" aria-hidden="true" tabindex="-1"></a>fetch C;</span>
<span id="cb546-5"><a href="#cb546-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- ok assuming bar is made up of 3 integers</span></span>
<span id="cb546-6"><a href="#cb546-6" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">from</span> <span class="kw">values</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>);</span></code></pre></div>
<ul>
<li>statement cursors come from SQL statements and can be fetched</li>
<li>value cursors are of a prescribed shape and can only be loaded from
value sources</li>
</ul>
<hr />
<h3 id="cql0216-fetch-variable-not-found-cursor_name">CQL0216: FETCH
variable not found ‘cursor_name’</h3>
<p>In a <code>FETCH</code> statement, the indicated name, which is
supposed to be a cursor, is not in fact a valid name at all.</p>
<p>Probably there is a typo in the name. Or else the declaration is
entirely missing.</p>
<hr />
<h3
id="cql0217-number-of-variables-did-not-match-count-of-columns-in-cursor-cursor_name">CQL0217:
number of variables did not match count of columns in cursor
‘cursor_name’</h3>
<p>In a <code>FETCH [cursor] INTO [variables]</code> the number of
variables specified did not match the number of columns in the named
cursor. Perhaps the source of the cursor (a select statement or some
such) has changed.</p>
<hr />
<h3
id="cql0218-continue-must-be-inside-of-a-loop-or-while-statement">CQL0218:
continue must be inside of a ‘loop’ or ‘while’ statement</h3>
<p>The <code>CONTINUE</code> statement may only appear inside of looping
constructs. CQL only has two <code>LOOP FETCH ...</code> and
<code>WHILE</code></p>
<hr />
<h3
id="cql0219-leave-must-be-inside-of-a-loop-while-or-switch-statement">CQL0219:
leave must be inside of a ‘loop’, ‘while’, or ‘switch’ statement</h3>
<p>The <code>LEAVE</code> statement may only appear inside of looping
constructs or the switch statement.</p>
<p>CQL has two loop types: <code>LOOP FETCH ...</code> and
<code>WHILE</code> and of course the <code>SWITCH</code> statement.</p>
<p>The errant <code>LEAVE</code> statement is not in any of those.</p>
<hr />
<h3
id="cql0220-savepoint-has-not-been-mentioned-yet-probably-wrong-name">CQL0220:
savepoint has not been mentioned yet, probably wrong ‘name’</h3>
<p>In a <code>ROLLBACK</code> statement that is rolling back to a named
savepoint, the indicated savepoint was never mentioned before. It should
have appeared previously in a <code>SAVEPOINT</code> statement. This
probably means there is a typo in the name.</p>
<hr />
<h3
id="cql0221-savepoint-has-not-been-mentioned-yet-probably-wrong-name">CQL0221:
savepoint has not been mentioned yet, probably wrong ‘name’</h3>
<p>In a <code>RELEASE SAVEPOINT</code> statement that is rolling back to
a named savepoint, the indicated savepoint was never mentioned before.
It should have appeared previously in a <code>SAVEPOINT</code>
statement. This probably means there is a typo in the name.</p>
<hr />
<h3
id="cql0222-out-cursor-statement-only-makes-sense-inside-of-a-procedure">CQL0222:
out cursor statement only makes sense inside of a procedure</h3>
<p>The statement form <code>OUT [cursor_name]</code> makes a procedure
that returns a single row result set. It doesn’t make any sense to do
this outside of any procedure because there is no procedure to return
that result. Perhaps the <code>OUT</code> statement was mis-placed.</p>
<hr />
<h3
id="cql0223-cursor-was-not-fetched-with-the-auto-fetch-syntax-fetch-cursor-cursor_name">CQL0223:
cursor was not fetched with the auto-fetch syntax ‘fetch [cursor]’
‘cursor_name’</h3>
<p>The statement form <code>OUT [cursor_name]</code> makes a procedure
that returns a single row result set that corresponds to the current
value of the cursor. If the cursor never held values directly then there
is nothing to return.</p>
<p>Example:</p>
<div class="sourceCode" id="cb547"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb547-1"><a href="#cb547-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> bar;</span>
<span id="cb547-2"><a href="#cb547-2" aria-hidden="true" tabindex="-1"></a><span class="kw">out</span> C;  <span class="co">-- error C was never fetched</span></span>
<span id="cb547-3"><a href="#cb547-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb547-4"><a href="#cb547-4" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> bar;</span>
<span id="cb547-5"><a href="#cb547-5" aria-hidden="true" tabindex="-1"></a>fetch C <span class="kw">into</span> x, y, z;</span>
<span id="cb547-6"><a href="#cb547-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- error C was used to load x, y, z so it&#39;s not holding any data</span></span>
<span id="cb547-7"><a href="#cb547-7" aria-hidden="true" tabindex="-1"></a><span class="kw">out</span> C;</span>
<span id="cb547-8"><a href="#cb547-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb547-9"><a href="#cb547-9" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> bar;</span>
<span id="cb547-10"><a href="#cb547-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- create storage in C to hold bar columns (e.g. C.x, C,y, C.z)</span></span>
<span id="cb547-11"><a href="#cb547-11" aria-hidden="true" tabindex="-1"></a>fetch C;</span>
<span id="cb547-12"><a href="#cb547-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- ok, C holds data</span></span>
<span id="cb547-13"><a href="#cb547-13" aria-hidden="true" tabindex="-1"></a><span class="kw">out</span> C;</span></code></pre></div>
<hr />
<h3
id="cql0224-a-call-statement-inside-sql-may-call-only-a-shared-fragment-i.e.-attributecqlshared_fragment">CQL0224:
a CALL statement inside SQL may call only a shared fragment i.e. <span
class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment)</h3>
<p>Inside of a WITH clause you can create a CTE by calling a shared
fragment like so:</p>
<pre><code>WITH
  my_shared_something(*) AS (CALL shared_proc(5))
SELECT * from my shared_something;</code></pre>
<p>or you can use a nested select expression like</p>
<pre><code> SELECT * FROM (CALL shared_proc(5)) as T;</code></pre>
<p>However <code>shared_proc</code> must define a shareable fragment,
like so:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc shared_proc(lim_ integer)
begin
   select * from somewhere limit lim_;
end;</code></pre>
<p>Here the target of the CALL is not a shared fragment.</p>
<hr />
<h3
id="cql0225-switching-to-previous-schema-validation-mode-must-be-outside-of-any-proc">CQL0225:
switching to previous schema validation mode must be outside of any
proc</h3>
<p>The <code>@previous_schema</code> directive says that any schema that
follows should be compared against what was declared before this point.
This gives CQL the opportunity to detect changes in schema that are not
supportable.</p>
<p>The previous schema directive must be outside of any stored
procedure.</p>
<p>Example:</p>
<div class="sourceCode" id="cb551"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb551-1"><a href="#cb551-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@previous_schema;  -- ok here</span></span>
<span id="cb551-2"><a href="#cb551-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb551-3"><a href="#cb551-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo()</span>
<span id="cb551-4"><a href="#cb551-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb551-5"><a href="#cb551-5" aria-hidden="true" tabindex="-1"></a>  @previous <span class="kw">schema</span>; <span class="co">-- nope</span></span>
<span id="cb551-6"><a href="#cb551-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<hr />
<h3
id="cql0226-schema-upgrade-declaration-must-be-outside-of-any-proc">CQL0226:
schema upgrade declaration must be outside of any proc</h3>
<p>The <code>@schema_upgrade_script</code> directive tells CQL that the
code that follows is intended to upgrade schema from one version to
another. This kind of script is normally generated by the
<code>--rt schema_upgrade</code> option discussed elsewhere. When
processing such a script, a different set of rules are used for DDL
analysis. In particular, it’s normal to declare the final versions of
tables but have DDL that creates the original version and more DDL to
upgrade them from wherever they are to the final version (as declared).
Ordinarily these duplicate definitions would produce errors. This
directive allows those duplications.</p>
<p>This error is reporting that the directive happened inside of a
stored procedure, this is not allowed.</p>
<p>Example:</p>
<div class="sourceCode" id="cb552"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb552-1"><a href="#cb552-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@schema_upgrade_script;  -- ok here</span></span>
<span id="cb552-2"><a href="#cb552-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb552-3"><a href="#cb552-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc foo()</span>
<span id="cb552-4"><a href="#cb552-4" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb552-5"><a href="#cb552-5" aria-hidden="true" tabindex="-1"></a>  @schema_upgrade_script; <span class="co">-- nope</span></span>
<span id="cb552-6"><a href="#cb552-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<hr />
<h3
id="cql0227-schema-upgrade-declaration-must-come-before-any-tables-are-declared">CQL0227:
schema upgrade declaration must come before any tables are declared</h3>
<p>The <code>@schema_upgrade_script</code> directive tells CQL that the
code that follows is intended to upgrade schema from one version to
another. This kind of script is normally generated by the
<code>--rt schema_upgrade</code> option discussed elsewhere. When
processing such a script, a different set of rules are used for DDL
analysis. In particular, it’s normal to declare the final versions of
tables but have DDL that creates the original version and more DDL to
upgrade them from wherever they are to the final version (as declared).
Ordinarily these duplicate definitions would produce errors. This
directive allows those duplications.</p>
<p>In order to do its job properly the directive must come before any
tables are created with DDL. This error tells you that the directive
came too late in the stream. Or perhaps there were two such directives
and one is late in the stream.</p>
<hr />
<h3
id="cql0228-schema-upgrade-version-must-be-a-positive-integer">CQL0228:
schema upgrade version must be a positive integer</h3>
<p>When authoring a schema migration procedure that was previously
declared in an <code>@create</code> or <code>@delete</code> directive,
the code in that procedure expects to see the schema as it existed at
the version it is to migrate. The <code>@schema_upgrade_version</code>
directive allows you to set the visible schema version to something
other than the latest. There can only be one such directive.</p>
<p>This error says that the version you are trying to view is not a
positive integer version (e.g version -2)</p>
<hr />
<h3
id="cql0229-schema-upgrade-version-declaration-may-only-appear-once">CQL0229:
schema upgrade version declaration may only appear once</h3>
<p>When authoring a schema migration procedure that was previously
declared in an <code>@create</code> or <code>@delete</code> directive,
the code in that procedure expects to see the schema as it existed at
the version it is to migrate. The <code>@schema_upgrade_version</code>
directive allows you to set the visible schema version to something
other than the latest. There can only be one such directive.</p>
<p>This error says that a second <code>@schema_upgrade_version</code>
directive has been found.</p>
<hr />
<h3
id="cql0230-schema-upgrade-version-declaration-must-be-outside-of-any-proc">CQL0230:
schema upgrade version declaration must be outside of any proc</h3>
<p>When authoring a schema migration procedure that was previously
declared in an <code>@create</code> or <code>@delete</code> directive,
the code in that procedure expects to see the schema as it existed at
the version it is to migrate. The <code>@schema_upgrade_version</code>
directive allows you to set the visible schema version to something
other than the latest. There can only be one such directive.</p>
<p>This error says that the <code>@schema_upgrade_version</code>
directive was found inside of a stored procedure. This is not
allowed.</p>
<hr />
<h3
id="cql0231-schema-upgrade-version-declaration-must-come-before-any-tables-are-declared">CQL0231:
schema upgrade version declaration must come before any tables are
declared</h3>
<p>When authoring a schema migration procedure that was previously
declared in an <code>@create</code> or <code>@delete</code> directive,
the code in that procedure expects to see the schema as it existed at
the version it is to migrate. The <code>@schema_upgrade_version</code>
directive allows you to set the visible schema version to something
other than the latest. There can only be one such directive.</p>
<p>This error says that the <code>@schema_upgrade_version</code>
directive came after tables were already declared. This is not allowed,
the directive must come before any DDL.</p>
<hr />
<h3
id="cql0232-nested-select-expression-must-return-exactly-one-column">CQL0232:
nested select expression must return exactly one column</h3>
<p>In a <code>SELECT</code> expression like
<code>set x := (select id from bar)</code> the select statement must
return exactly one column as in the example provided. Note that a
runtime error will ensue if the statement returns zero rows, or more
than one row, so this form is very limited. To fix this error change
your select statement to return exactly one column. Consider how many
rows you will get very carefully also, that cannot be checked at compile
time.</p>
<hr />
<h3
id="cql0233-procedure-previously-declared-as-schema-upgrade-proc-it-can-have-no-args-procedure_name">CQL0233:
procedure previously declared as schema upgrade proc, it can have no
args ‘procedure_name’</h3>
<p>When authoring a schema migration procedure that was previously
declared in an <code>@create</code> or <code>@delete</code> directive
that procedure will be called during schema migration with no context
available. Therefore, the schema migration proc is not allowed to have
any arguments.</p>
<hr />
<h3
id="cql0234-autodrop-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name">CQL0234:
autodrop annotation can only go on a procedure that returns a result set
‘procedure_name’</h3>
<p>The named procedure has the <code>autodrop</code> annotation (to
automatically drop a temporary table) but the procedure in question
doesn’t return a result set so it has no need of the autodrop feature.
The purpose that that feature is to drop the indicated temporary tables
once all the select results have been fetched.</p>
<hr />
<h3
id="cql0235-too-many-arguments-provided-to-procedure-procedure_name">CQL0235:
too many arguments provided to procedure ‘procedure_name’</h3>
<p>In a <code>CALL</code> statement, or a function call, the named
procedure takes fewer arguments than were provided. This error might be
due to some copy/pasta going on or perhaps the argument list of the
procedure/function changed to fewer items. To fix this, consult the
argument list and adjust the call accordingly.</p>
<hr />
<h3
id="cql0236-autodrop-annotation-can-only-go-on-a-procedure-that-uses-the-database-name">CQL0236:
autodrop annotation can only go on a procedure that uses the database
‘name’</h3>
<p>The named procedure has the <code>autodrop</code> annotation (to
automatically drop a temporary table) but the procedure in question
doesn’t even use the database at all, much less the named table. This
annotation is therefore redundant.</p>
<hr />
<h3
id="cql0237-strict-fk-validation-requires-that-some-on-update-option-be-selected-for-every-foreign-key">CQL0237:
strict FK validation requires that some ON UPDATE option be selected for
every foreign key</h3>
<p><code>@enforce_strict</code> has been use to enable strict foreign
key enforcement. When enabled every foreign key must have an action for
the <code>ON UPDATE</code> rule. You can specify <code>NO ACTION</code>
but you can’t simply leave the action blank.</p>
<hr />
<h3
id="cql0238-strict-fk-validation-requires-that-some-on-delete-option-be-selected-for-every-foreign-key">CQL0238:
strict FK validation requires that some ON DELETE option be selected for
every foreign key</h3>
<p><code>@enforce_strict</code> has been use to enable strict foreign
key enforcement. When enabled every foreign key must have an action for
the <code>ON DELETE</code> rule. You can specify <code>NO ACTION</code>
but you can’t simply leave the action blank.</p>
<hr />
<h3
id="cql0239-annotation-column-does-not-exist-in-result-set-column_name">CQL0239:
‘annotation’ column does not exist in result set ‘column_name’</h3>
<p>The <code>@attribute(cql:identity=(col1, col2, ...))</code> form has
been used to list the identity columns of a stored procedures result
set. These columns must exist in the result set and they must be unique.
The indicated column name is not part of the result of the procedure
that is being annotated.</p>
<p>The <code>@attribute(cql:vault_sensitive=(col1, col2, ...)</code>
form has been used to list the columns of a stored procedures result
set. These columns must exist in the result set. The indicated column
name will be encoded if they are sensitive and the cursor that produced
the result_set is a DML.</p>
<hr />
<h3
id="cql0240-identity-annotation-can-only-go-on-a-procedure-that-returns-a-result-set-procedure_name">CQL0240:
identity annotation can only go on a procedure that returns a result set
‘procedure_name’</h3>
<p>The <code>@attribute(cql:identity=(col1, col2,...))</code> form has
been used to list the identity columns of a stored procedures result
set. These columns must exist in the result set and they must be unique.
In this case, the named procedure doesn’t even return a result set.
Probably there is a copy/pasta going on. The identity attribute can
likely be removed.</p>
<hr />
<h3
id="cql0241-concat-may-only-appear-in-the-context-of-sql-statement">CQL0241:
CONCAT may only appear in the context of SQL statement</h3>
<p>The SQLite <code>||</code> operator has complex string conversion
rules making it impossible to faithfully emulate. Since there is no
helper function for doing concatenations, CQL choses to support this
operator only in contexts where it will be evaluated by SQLite. That is,
inside of some SQL statement.</p>
<p>Examples:</p>
<div class="sourceCode" id="cb553"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb553-1"><a href="#cb553-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> X text;</span>
<span id="cb553-2"><a href="#cb553-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb553-3"><a href="#cb553-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> X <span class="op">:=</span> <span class="st">&#39;foo&#39;</span> <span class="op">||</span> <span class="st">&#39;bar&#39;</span>;   <span class="co">-- error</span></span>
<span id="cb553-4"><a href="#cb553-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb553-5"><a href="#cb553-5" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> X <span class="op">:=</span> (<span class="kw">select</span> <span class="st">&#39;foo&#39;</span> <span class="op">||</span> <span class="st">&#39;bar&#39;</span>);  <span class="co">-- ok</span></span></code></pre></div>
<p>If concatenation is required in some non-sql context, use the
<code>(select ..)</code> expression form to let SQLite do the
evaluation.</p>
<hr />
<h3 id="cql0242-lossy-conversion-from-type-type">CQL0242: lossy
conversion from type ‘type’</h3>
<p>There is an explicit (<code>set x := y</code>) or implicit assignment
(e.g. conversion of a parameter) where the storage for the target is a
smaller numeric type than the expression that is being stored. This
usually means a variable that should have been declared
<code>LONG</code> is instead declared <code>INTEGER</code> or that you
are typing to pass a LONG to a procedure that expects an
<code>INTEGER</code></p>
<hr />
<h3
id="cql0243-blob-operand-must-be-converted-to-string-first-in">CQL0243:
blob operand must be converted to string first in ‘||’</h3>
<p>We explicitly do not wish to support string concatenation for blobs
that holds non-string data. If the blob contains string data, make your
intent clear by converting it to string first using <code>CAST</code>
before doing the concatenation.</p>
<hr />
<h3 id="cql0244-unknown-schema-region-region">CQL0244: unknown schema
region ‘region’</h3>
<p>In a <code>@declare_schema_region</code> statement one of the USING
regions is not a valid region name. Or in
<code>@begin_schema_region</code> the region name is not valid. This
probably means there is a typo in your code.</p>
<hr />
<h3 id="cql0245-schema-region-already-defined-region">CQL0245: schema
region already defined ‘region’</h3>
<p>The indicated region was previously defined, it cannot be
redefined.</p>
<hr />
<h3
id="cql0246-schema-regions-do-not-nest-end-the-current-region-before-starting-a-new-one">CQL0246:
schema regions do not nest; end the current region before starting a new
one</h3>
<p>Another <code>@begin_schema_region</code> directive was encountered
before the previous <code>@end_schema_region</code> was found.</p>
<hr />
<h3
id="cql0247-you-must-begin-a-schema-region-before-you-can-end-one">CQL0247:
you must begin a schema region before you can end one</h3>
<p>An <code>@end_schema_region</code> directive was encountered but
there was no corresponding <code>@begin_schema_region</code>
directive.</p>
<hr />
<h3
id="cql0248-schema-region-directives-may-not-appear-inside-of-a-procedure">CQL0248:
schema region directives may not appear inside of a procedure</h3>
<p>All of the <code>*_schema_region</code> directives must be used at
the top level of your program, where tables are typically declared. They
do not belong inside of procedures. If you get this error, move the
directive out of the procedure near the DDL that it affects.</p>
<hr />
<h3
id="cql0249-function-is-not-a-table-valued-function-function_name">CQL0249:
function is not a table-valued-function ‘function_name’</h3>
<p>The indicated identifier appears in the context of a table, it is a
function, but it is not a table-valued function. Either the declaration
is wrong (use something like
<code>declare select function foo(arg text) (id integer, t text)</code>)
or the name is wrong. Or both.</p>
<hr />
<h3
id="cql0250-table-valued-function-not-declared-function_name">CQL0250:
table-valued function not declared ‘function_name’</h3>
<p>In a select statement, there is a reference to the indicated
table-valued-function. For instance:</p>
<div class="sourceCode" id="cb554"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb554-1"><a href="#cb554-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- the above error happens if my_function has not been declared</span></span>
<span id="cb554-2"><a href="#cb554-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- as a table valued function</span></span>
<span id="cb554-3"><a href="#cb554-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> my_function(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>);</span></code></pre></div>
<p>However , <code>my_function</code> has not been declared as a
function at all. A correct declaration might look like this:</p>
<div class="sourceCode" id="cb555"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb555-1"><a href="#cb555-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">select</span> <span class="kw">function</span> my_function(a <span class="dt">int</span>, b <span class="dt">int</span>, c <span class="dt">int</span>)</span>
<span id="cb555-2"><a href="#cb555-2" aria-hidden="true" tabindex="-1"></a>                                   (x <span class="dt">int</span>, y text);</span></code></pre></div>
<p>Either there is a typo in the name or the declaration is missing, or
both…</p>
<hr />
<h3 id="cql0251-unused">CQL0251 Unused</h3>
<hr />
<h3
id="cql0252-proc-literal-can-only-appear-inside-of-procedures">CQL0252:
<span class="citation" data-cites="PROC">@PROC</span> literal can only
appear inside of procedures</h3>
<p>An <span class="citation" data-cites="PROC">@PROC</span> literal was
used outside of any procedure. It cannot be resolved if it isn’t inside
a procedure.</p>
<hr />
<h3 id="cql0253-unused">CQL0253 Unused</h3>
<hr />
<h3
id="cql0254-switching-to-previous-schema-validation-mode-not-allowed-if-schema_upgrade_version-was-used">CQL0254:
switching to previous schema validation mode not allowed if
<code>@schema_upgrade_version</code> was used</h3>
<p>When authoring a schema migration script (a stored proc named in an
<code>@create</code> or <code>@delete</code> annotation) you must create
that procedure in a file that is marked with
<code>@schema_upgrade_verison</code> specifying the schema version it is
upgrading. If you do this, then the proc (correctly) only sees the
schema as it existed at that version. However that makes the schema
unsuitable for analysis using <code>@previous_schema</code> because it
could be arbitrarily far in the past. This error prevents you from
combining those features. Previous schema validation should only happen
against the current schema.</p>
<hr />
<h3 id="cql0255-unused">CQL0255 Unused</h3>
<hr />
<h3 id="cql0256-unused">CQL0256 Unused</h3>
<hr />
<h3
id="cql0257-argument-must-be-a-string-or-numeric-in-function">CQL0257:
argument must be a string or numeric in ‘function’</h3>
<p>The indicated function (usually min or max) only works on strings and
numerics. <code>NULL</code> literals, blobs, or objects are not allowed
in this context.</p>
<hr />
<h3 id="cql0258-unused">CQL0258 Unused</h3>
<hr />
<h3 id="cql0259-unused">CQL0259 Unused</h3>
<hr />
<h3 id="cql0260-unused">CQL0260 Unused</h3>
<hr />
<h3
id="cql0261-cursor-did-not-originate-from-a-sqlite-statement-it-only-has-values-cursor_name">CQL0261:
cursor did not originate from a SQLite statement, it only has values
‘cursor_name’</h3>
<p>The form:</p>
<div class="sourceCode" id="cb556"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb556-1"><a href="#cb556-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SET</span> [name] <span class="kw">FROM</span> <span class="kw">CURSOR</span> [cursor_name]</span></code></pre></div>
<p>Is used to wrap a cursor in an object so that it can be returned for
forwarded. This is the so-called “boxing” operation on the cursor. The
object can then be “unboxed” later to make a cursor again. However the
point of this is to keep reading forward on the cursor perhaps in
another procedure. You can only read forward on a cursor that has an
associated SQLite statement. That is the cursor was created with
something like this</p>
<div class="sourceCode" id="cb557"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb557-1"><a href="#cb557-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">DECLARE</span> [name] <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">SELECT</span> <span class="op">..</span>. | <span class="kw">CALL</span> <span class="op">..</span>.</span></code></pre></div>
<p>If the cursor isn’t of this form it’s just values, you can’t move it
forward and so “boxing” it is of no value. Hence not allowed. You can
return the cursor values with <code>OUT</code> instead.</p>
<hr />
<h3
id="cql0262-like-arguments-used-on-a-procedure-with-no-arguments-procedure_name">CQL0262:
LIKE … ARGUMENTS used on a procedure with no arguments
‘procedure_name’</h3>
<p>The LIKE [procedure] ARGUMENTS form creates a shape for use in a
cursor or procedure arguments.</p>
<p>The indicated name is a procedure with no arguments so it cannot be
used to make a shape.</p>
<hr />
<h3
id="cql0263-non-ansi-joins-are-forbidden-if-strict-join-mode-is-enabled.">CQL0263:
non-ANSI joins are forbidden if strict join mode is enabled.</h3>
<p>You can enable strict enforcement of joins to avoid the form</p>
<div class="sourceCode" id="cb558"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb558-1"><a href="#cb558-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A, B;</span></code></pre></div>
<p>which sometimes confuses people (the above is exactly the same as</p>
<div class="sourceCode" id="cb559"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb559-1"><a href="#cb559-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A <span class="kw">inner</span> <span class="kw">join</span> B <span class="kw">on</span> <span class="dv">1</span>;</span></code></pre></div>
<p>Usually there are constraints on the join also in the WHERE clause
but there don’t have to be.</p>
<p><code>@enforce_strict join</code> turns on this mode.</p>
<hr />
<h3 id="cql0264-unused">CQL0264 Unused</h3>
<hr />
<h3 id="cql0265-unused">CQL0265 Unused</h3>
<hr />
<h3 id="cql0266-unused">CQL0266 Unused</h3>
<hr />
<h3 id="cql0267-unused">CQL0267 Unused</h3>
<hr />
<h3 id="cql0268-unused">CQL0268 Unused</h3>
<hr />
<h3
id="cql0269-at-least-part-of-this-unique-key-is-redundant-with-previous-unique-keys">CQL0269:
at least part of this unique key is redundant with previous unique
keys</h3>
<p>The new unique key must have at least one column that is not in a
previous key AND it must not have all the columns from any previous
key.</p>
<p>e.g:</p>
<div class="sourceCode" id="cb560"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb560-1"><a href="#cb560-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1 (</span>
<span id="cb560-2"><a href="#cb560-2" aria-hidden="true" tabindex="-1"></a>  a <span class="dt">int</span>,</span>
<span id="cb560-3"><a href="#cb560-3" aria-hidden="true" tabindex="-1"></a>  b <span class="dt">long</span>,</span>
<span id="cb560-4"><a href="#cb560-4" aria-hidden="true" tabindex="-1"></a>  c text,</span>
<span id="cb560-5"><a href="#cb560-5" aria-hidden="true" tabindex="-1"></a>  d <span class="dt">real</span>,</span>
<span id="cb560-6"><a href="#cb560-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (a, b),</span>
<span id="cb560-7"><a href="#cb560-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (a, b, c), <span class="co">-- INVALID  (a, b) is already unique key</span></span>
<span id="cb560-8"><a href="#cb560-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (b, a), <span class="co">-- INVALID (b, a) is the same as (a, b)</span></span>
<span id="cb560-9"><a href="#cb560-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (c, d, b, a), <span class="co">-- INVALID subset (b, a) is already unique key</span></span>
<span id="cb560-10"><a href="#cb560-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (a), <span class="co">-- INVALID a is part of (a, b) key</span></span>
<span id="cb560-11"><a href="#cb560-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (a, c), <span class="co">-- VALID</span></span>
<span id="cb560-12"><a href="#cb560-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (d), <span class="co">-- VALID</span></span>
<span id="cb560-13"><a href="#cb560-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNIQUE</span> (b, d) <span class="co">-- VALID</span></span>
<span id="cb560-14"><a href="#cb560-14" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<hr />
<h3
id="cql0270-use-fetch-from-for-procedures-that-returns-a-cursor-with-out-cursor">CQL0270:
use FETCH FROM for procedures that returns a cursor with OUT
‘cursor’</h3>
<p>If you are calling a procedure that returns a value cursor (using
<code>OUT</code>) then you accept that cursor using the pattern</p>
<div class="sourceCode" id="cb561"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb561-1"><a href="#cb561-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> FETCH <span class="kw">FROM</span> <span class="kw">CALL</span> foo(<span class="op">..</span>.);</span></code></pre></div>
<p>The pattern</p>
<div class="sourceCode" id="cb562"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb562-1"><a href="#cb562-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> C <span class="kw">CURSOR</span> <span class="cf">FOR</span> <span class="kw">CALL</span> foo(<span class="op">..</span>.);</span></code></pre></div>
<p>Is used for procedures that provide a full <code>select</code>
statement.</p>
<p>Note that in the former cause you don’t then use <code>fetch</code>
on the cursor. There is at most one row anyway and it’s fetched for you
so a fetch would be useless. In the second case you fetch as many rows
as there are and/or you want.</p>
<hr />
<h3
id="cql0271-offset-clause-may-only-be-used-if-limit-is-also-present">CQL0271:
OFFSET clause may only be used if LIMIT is also present</h3>
<div class="sourceCode" id="cb563"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb563-1"><a href="#cb563-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo offset <span class="dv">1</span>;</span></code></pre></div>
<p>Is not supported by SQLite. <code>OFFSET</code> may only be used if
<code>LIMIT</code> is also present. Also, both should be small because
offset is not cheap. There is no way to do offset other than to read and
ignore the indicated number of rows. So something like
<code>offset 1000</code> is always horrible.</p>
<hr />
<h3
id="cql0272-columns-referenced-in-the-foreign-key-statement-should-match-exactly-a-unique-key-in-parent-table">CQL0272:
columns referenced in the foreign key statement should match exactly a
unique key in parent table</h3>
<p>If you’re creating a table t2 with foreign keys on table t1, then the
set of t1’s columns reference in the foreign key statement for table t2
should be: - A primary key in <code>t1</code></p>
<div class="sourceCode" id="cb564"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb564-1"><a href="#cb564-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb564-2"><a href="#cb564-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(a text <span class="kw">primary</span> <span class="kw">key</span>);</span>
<span id="cb564-3"><a href="#cb564-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(a text <span class="kw">primary</span> <span class="kw">key</span>, <span class="kw">foreign</span> <span class="kw">key</span>(a) <span class="kw">references</span> t1(a));</span></code></pre></div>
<ul>
<li>A unique key in <code>t1</code></li>
</ul>
<div class="sourceCode" id="cb565"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb565-1"><a href="#cb565-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb565-2"><a href="#cb565-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(a text <span class="kw">unique</span>);</span>
<span id="cb565-3"><a href="#cb565-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(a text <span class="kw">primary</span> <span class="kw">key</span>, <span class="kw">foreign</span> <span class="kw">key</span>(a) <span class="kw">references</span> t1(a));</span></code></pre></div>
<ul>
<li>A group of unique key in <code>t1</code></li>
</ul>
<div class="sourceCode" id="cb566"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb566-1"><a href="#cb566-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb566-2"><a href="#cb566-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(a text, b <span class="dt">int</span>, <span class="kw">unique</span>(a, b));</span>
<span id="cb566-3"><a href="#cb566-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(a text, b <span class="dt">int</span>, <span class="kw">foreign</span> <span class="kw">key</span>(a, b) <span class="kw">references</span> t1(a, b));</span></code></pre></div>
<ul>
<li>A group of primary key in <code>t1</code></li>
</ul>
<div class="sourceCode" id="cb567"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb567-1"><a href="#cb567-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb567-2"><a href="#cb567-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(a text, b <span class="dt">int</span>, <span class="kw">primary</span> <span class="kw">key</span>(a, b));</span>
<span id="cb567-3"><a href="#cb567-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(a text, b <span class="dt">int</span>, <span class="kw">foreign</span> <span class="kw">key</span>(a, b) <span class="kw">references</span> t1(a, b));</span></code></pre></div>
<ul>
<li>A unique index in <code>t1</code></li>
</ul>
<div class="sourceCode" id="cb568"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb568-1"><a href="#cb568-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb568-2"><a href="#cb568-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t1(a text, b <span class="dt">int</span>);</span>
<span id="cb568-3"><a href="#cb568-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">unique</span> <span class="kw">index</span> unq <span class="kw">on</span> t1(a, b);</span>
<span id="cb568-4"><a href="#cb568-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t2(a text, b <span class="dt">int</span>, <span class="kw">foreign</span> <span class="kw">key</span>(a, b) <span class="kw">references</span> t1(a, b));</span></code></pre></div>
<hr />
<h3
id="cql0273-autotest-attribute-has-incorrect-format-in-dummy_test">CQL0273:
autotest attribute has incorrect format (…) in ‘dummy_test’</h3>
<p>In a <code>cql:autotest</code> annotation, the given
<strong>dummy_test</strong> info (table name, column name, column value)
has incorrect format.</p>
<hr />
<h3
id="cql0274-autotest-attribute-dummy_test-has-non-existent-table">CQL0274:
autotest attribute ‘dummy_test’ has non existent table</h3>
<p>In a <code>cql:autotest</code> annotation, the given table name for
<strong>dummy_test</strong> attribute does not exist.</p>
<hr />
<h3
id="cql0275-autotest-attribute-dummy_test-has-non-existent-column">CQL0275:
autotest attribute ‘dummy_test’ has non existent column</h3>
<p>In a <code>cql:autotest</code> annotation, the given column name for
<strong>dummy_test</strong> attribute does not exist.</p>
<hr />
<h3
id="cql0276-autotest-attribute-dummy_test-has-invalid-value-type-in">CQL0276:
autotest attribute ‘dummy_test’ has invalid value type in</h3>
<p>In a <code>cql:autotest</code> annotation, the given column value’s
type for <strong>dummy_test</strong> attribute does not match the column
type.</p>
<hr />
<h3 id="cql0277-autotest-has-incorrect-format">CQL0277: autotest has
incorrect format</h3>
<p>In a <code>cql:autotest</code> annotation, the format is
incorrect.</p>
<hr />
<h3 id="cql0278-autotest-attribute-name-is-not-valid">CQL0278: autotest
attribute name is not valid</h3>
<p>In a <code>cql:autotest</code> annotation, the given attribute name
is not valid.</p>
<hr />
<h3
id="cql0279-columns-referenced-in-an-upsert-conflict-target-must-exactly-match-a-unique-key-the-target-table">CQL0279:
columns referenced in an UPSERT conflict target must exactly match a
unique key the target table</h3>
<p>If you’re doing an UPSERT on table <code>T</code>, the columns listed
in the conflict target should be: - A primary key in <code>T</code> - A
unique key in <code>T</code> - A group of unique key in <code>T</code> -
A group of primary key in <code>T</code> - A unique index in
<code>T</code></p>
<hr />
<h3
id="cql0280-upsert-statement-requires-a-where-clause-if-the-insert-clause-uses-select">CQL0280:
upsert statement requires a where clause if the insert clause uses
select</h3>
<p>When the <code>INSERT</code> statement to which the UPSERT is
attached takes its values from a <code>SELECT</code> statement, there is
a potential parsing ambiguity. The SQLite parser might not be able to
tell if the <code>ON</code> keyword is introducing the UPSERT or if it
is the <code>ON</code> clause of a join. To work around this, the
<code>SELECT</code> statement should always include a <code>WHERE</code>
clause, even if that <code>WHERE</code> clause is just
<code>WHERE 1</code> (always true).</p>
<blockquote>
<p>NOTE: The CQL parser doesn’t have this ambiguity because it treats
“ON CONFLICT” as a single token so this is CQL reporting that SQLite
might have trouble with the query as written.</p>
</blockquote>
<p>e.g:</p>
<div class="sourceCode" id="cb569"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb569-1"><a href="#cb569-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> foo <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> bar <span class="kw">where</span> <span class="dv">1</span> <span class="kw">on</span> conflict(<span class="kw">id</span>) do <span class="kw">nothing</span>;</span></code></pre></div>
<hr />
<h3
id="cql0281-upsert-statement-does-not-include-table-name-in-the-update-statement">CQL0281:
upsert statement does not include table name in the update
statement</h3>
<p>The UPDATE statement of and UPSERT should not include the table name
because the name is already known from the INSERT statement part of the
UPSERT e.g:</p>
<div class="sourceCode" id="cb570"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb570-1"><a href="#cb570-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> foo <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> bar <span class="kw">where</span> <span class="dv">1</span> <span class="kw">on</span> conflict(<span class="kw">id</span>) do <span class="kw">update</span> <span class="kw">set</span> <span class="kw">id</span><span class="op">=</span><span class="dv">10</span>;</span></code></pre></div>
<hr />
<h3 id="cql0282-update-statement-require-table-name">CQL0282: update
statement require table name</h3>
<p>The UPDATE statement should always include a table name except if the
UPDATE statement is part of an UPSERT statement.</p>
<p>e.g:</p>
<div class="sourceCode" id="cb571"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb571-1"><a href="#cb571-1" aria-hidden="true" tabindex="-1"></a><span class="kw">update</span> foo <span class="kw">set</span> <span class="kw">id</span><span class="op">=</span><span class="dv">10</span>;</span>
<span id="cb571-2"><a href="#cb571-2" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>) <span class="kw">values</span>(<span class="dv">1</span>) do <span class="kw">update</span> <span class="kw">set</span> <span class="kw">id</span><span class="op">=</span><span class="dv">10</span>;</span></code></pre></div>
<hr />
<h3 id="cql0283-upsert-syntax-only-support-insert-into">CQL0283: upsert
syntax only support INSERT INTO</h3>
<p>The INSERT statement part of an UPSERT statement can only uses INSERT
INTO …</p>
<div class="sourceCode" id="cb572"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb572-1"><a href="#cb572-1" aria-hidden="true" tabindex="-1"></a>e.g:</span>
<span id="cb572-2"><a href="#cb572-2" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>) <span class="kw">values</span>(<span class="dv">1</span>) <span class="kw">on</span> conflict do <span class="kw">nothing</span>;</span>
<span id="cb572-3"><a href="#cb572-3" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> foo(<span class="kw">id</span>) <span class="kw">values</span>(<span class="dv">1</span>) <span class="kw">on</span> conflict do <span class="kw">update</span> <span class="kw">set</span> <span class="kw">id</span><span class="op">=</span><span class="dv">10</span>;</span></code></pre></div>
<hr />
<h3
id="cql0284-ad-hoc-schema-migration-directive-must-provide-a-procedure-to-run">CQL0284:
ad hoc schema migration directive must provide a procedure to run</h3>
<p><code>@schema_ad_hoc_migration</code> must provide both a version
number and a migrate procedure name. This is unlike the other version
directives like <code>@create</code> where the version number is
optional. This is because the whole point of this migrator is to invoke
a procedure of your choice.</p>
<hr />
<h3
id="cql0285-ad-hoc-schema-migration-directive-version-number-changed-procedure_name">CQL0285:
ad hoc schema migration directive version number changed
‘procedure_name’</h3>
<p>In <code>@schema_ad_hoc_migration</code> you cannot change the
version number of the directive once it has been added to the schema
because this could cause inconsistencies when upgrading.</p>
<p>You can change the body of the method if you need to but this is also
not recommended because again there could be inconsistencies. However
careful replacement and compensation is possible. This is like going to
110% on the reactor… possible, but not recommended.</p>
<hr />
<h3
id="cql0286-ad-hoc-schema-migration-directive-was-removed-this-is-not-allowed-procedure_name">CQL0286:
ad hoc schema migration directive was removed; this is not allowed
‘procedure_name’</h3>
<p>An <code>@schema_ad_hoc_migration</code> cannot be removed because it
could cause inconsistencies on upgrade.</p>
<p>You can change the body of the method if you need to but this is also
not recommended because again there could be inconsistencies. However
careful replacement and compensation is possible. This is like going to
110% on the reactor… possible, but not recommended.</p>
<hr />
<h3 id="cql0287-unused">CQL0287 Unused</h3>
<hr />
<h3 id="cql0288-unused">CQL0288 Unused</h3>
<hr />
<h3
id="cql0289-upsert-statement-are-forbidden-if-strict-upsert-statement-mode-is-enabled">CQL0289:
upsert statement are forbidden if strict upsert statement mode is
enabled</h3>
<p><code>@enforce_strict</code> has been use to enable strict upsert
statement enforcement. When enabled all sql statement should not use the
upsert statement. This is because sqlite version running in some iOS and
Android version is old. Upsert statement was added to sqlite in the
version <strong>3.24.0 (2018-06-04)</strong>.</p>
<hr />
<h3 id="cql0290-unused">CQL0290 Unused</h3>
<hr />
<h3
id="cql0291-region-links-into-the-middle-of-a-deployable-region-you-must-point-to-the-root-of-deployable_region-not-into-the-middle-error_region">CQL0291:
region links into the middle of a deployable region; you must point to
the root of <code>&lt;deployable_region&gt;</code> not into the middle:
<code>&lt;error_region&gt;</code></h3>
<p>Deployable regions have an “inside” that is in some sense “private”.
In order to keep the consistent (and independently deployable) you can’t
peek into the middle of such a region, you have to depend on the root
(i.e. <code>&lt;deployable_region&gt;</code> itself). This allows the
region to remain independently deployable and for its internal logical
regions to be reorganized in whatever manner makes sense.</p>
<p>To fix this error probably you should change
<code>error_region</code> so that it depends directly on
<code>deployable_region</code></p>
<hr />
<h3
id="cql0292-explain-statement-is-only-available-in-dev-mode-because-its-result-set-may-vary-between-sqlite-versions">CQL0292:
explain statement is only available in dev mode because its result set
may vary between sqlite versions</h3>
<p>The EXPLAIN statement is intended for interactive debugging only. It
helps engineer understand how Sqlite will execute their query and the
cost attached to it. This is why this grammar is only available in dev
mode in CQL and should never be used in production.</p>
<hr />
<h3 id="cql0293-only-explain-query-plan-statement-is-supported">CQL0293:
only [EXPLAIN QUERY PLAN …] statement is supported</h3>
<p>CQL only support [EXPLAIN QUERY PLAN stmt] sql statement.</p>
<hr />
<h3
id="cql0294-window-function-invocations-can-only-appear-in-the-select-list-of-a-select-statement">CQL0294:
window function invocations can only appear in the select list of a
select statement</h3>
<p>Not all SQLite builtin function can be used as a window function.</p>
<hr />
<h3 id="cql0295-window-name-is-not-defined">CQL0295: window name is not
defined</h3>
<p>Window name referenced in the select list should be defined in the
Window clause of the same select statement.</p>
<hr />
<h3 id="cql0296-window-name-definition-is-not-used">CQL0296: window name
definition is not used</h3>
<p>Window name defined in the window clause of a select statement should
always be used within that statement.</p>
<hr />
<h3
id="cql0297-from-shape-is-redundant-if-column-list-is-empty">CQL0297:
FROM [shape] is redundant if column list is empty</h3>
<p>In this form:</p>
<p><code>insert into YourTable() FROM your_cursor;</code></p>
<p>The <code>()</code> means no columns are being specified, the cursor
will never be used. The only source of columns is maybe dummy data (if
it was specified) or the default values or null. In no case will the
cursor be used. If you really want this use <code>FROM VALUES()</code>
and don’t implicate a cursor or an argument bundle.</p>
<hr />
<h3
id="cql0298-cannot-read-from-a-cursor-without-fields-cursor_name">CQL0298:
cannot read from a cursor without fields ‘cursor_name’</h3>
<p>The cursor in question has no storage associated with it. It was
loaded with something like:</p>
<p><code>fetch C into x, y, z;</code></p>
<p>You can only use a cursor as a source of data if it was fetched with
its own storage like</p>
<p><code>fetch C</code></p>
<p>This results in a structure for the cursor. This gives you C.x, C.y,
C.z etc.</p>
<p>If you fetched the cursor into variables then you have to use the
variables for any inserting.</p>
<hr />
<h3 id="cql0299-cursor-has-too-few-fields-shape_name">CQL0299: [cursor]
has too few fields, ‘shape_name’</h3>
<p>The named shape was used in a fetch statement but the number of
columns fetched is smaller than the number required by the statement we
are processing.</p>
<p>If you need to use the cursor plus some other data then you can’t use
this form, you’ll have to use each field individually like
<code>from values(C.x, C.y, C.z, other_stuff)</code>.</p>
<p>The shape with too few fields might be the source or the target of
the statement.</p>
<hr />
<h3
id="cql0300-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name">CQL0300:
argument must be an integer (between 1 and max integer) in function
‘function_name’</h3>
<p>The argument of the function should be an integer.</p>
<hr />
<h3
id="cql0301-second-argument-must-be-an-integer-between-0-and-max-integer-in-function-function_name">CQL0301:
second argument must be an integer (between 0 and max integer) in
function ‘function_name’</h3>
<p>The second argument of the function should be an integer between 0
and INTEGER_MAX.</p>
<hr />
<h3
id="cql0302-first-and-third-arguments-must-be-compatible-in-function-function_name">CQL0302:
first and third arguments must be compatible in function
‘function_name’</h3>
<p>The first and third arguments of the function have to be of the same
type because the third argument provide a default value in cause the
first argument is NULL.</p>
<hr />
<h3
id="cql0303-second-argument-must-be-an-integer-between-1-and-max-integer-in-function-function_name">CQL0303:
second argument must be an integer between 1 and max integer in function
‘function_name’</h3>
<p>The second argument of the function must be and integer between 1 and
INTEGER_MAX.</p>
<hr />
<h3
id="cql0304-distinct-may-only-be-used-with-one-explicit-argument-in-an-aggregate-function">CQL0304:
DISTINCT may only be used with one explicit argument in an aggregate
function</h3>
<p>The keyword DISTINCT can only be used with one argument in an
aggregate function.</p>
<hr />
<h3
id="cql0305-distinct-may-only-be-used-in-function-that-are-aggregated-or-user-defined">CQL0305:
DISTINCT may only be used in function that are aggregated or user
defined</h3>
<p>Only aggregated functions and user defined functions can use the
keyword DISTINCT. Others type of functions are not allowed to use
it.</p>
<hr />
<h3
id="cql0306-filter-clause-may-only-be-used-in-function-that-are-aggregated-or-user-defined">CQL0306:
FILTER clause may only be used in function that are aggregated or user
defined</h3>
<hr />
<h3
id="cql0307-return-statement-should-be-in-a-procedure-and-not-at-the-top-level">CQL0307:
return statement should be in a procedure and not at the top level</h3>
<p>There are basically two checks here both of which have to do with the
“nesting level” at which the <code>return</code> occurs.</p>
<p>A loose <code>return</code> statement (not in a procedure) is
meaningless so that produce an error. There is nothing to return
from.</p>
<p>If the return statement is not inside of an “if” or something like
that then it will run unconditionally. Nothing should follow the return
(see CQL0308) so if we didn’t fall afoul of CQL0308 and we’re at the top
level then the return is the last thing in the proc, in which case it is
totally redundant.</p>
<p>Both these situations produce an error.</p>
<hr />
<h3
id="cql0308-statement-should-be-the-last-thing-in-a-statement-list">CQL0308:
statement should be the last thing in a statement list</h3>
<p>Control flow will exit the containing procedure after a
<code>return</code> statement, so any statements that follow in its
statement list will certainly not run. So the return statement must be
the last statement, otherwise there are dead/unreachable statements
which is most likely done by accident.</p>
<p>To fix this probably the things that came after the return should be
deleted. Or alternately there was a condition on the return that should
have been added but wasn’t, so the return should have been inside a
nested statement list (like the body of an <code>if</code> maybe).</p>
<hr />
<h3
id="cql0309-new-table-must-be-added-with-createnumber-or-later-table_name">CQL0309:
new table must be added with <span class="citation"
data-cites="create">@create</span>([number]) or later ‘table_name’</h3>
<p>The indicated table was newly added – it is not present in the
previous schema. However the version number it was added at is in the
past. The new table must appear at the current schema version or later.
That version is provided in the error message.</p>
<p>To fix this, change the <code>@create</code> annotation on the table
to be at the indicated version or later.</p>
<hr />
<h3
id="cql0310-new-column-must-be-added-with-createnumber-or-later-column_name">CQL0310:
new column must be added with <span class="citation"
data-cites="create">@create</span>([number]) or later”
‘column_name’</h3>
<p>The indicated column was newly added – it is not present in the
previous schema. However the version number it was added at is in the
past. The new column must appear at the current schema version or later.
That version is provided in the error message.</p>
<p>To fix this, change the <code>@create</code> annotation on the table
to be at the indicated version or later.</p>
<hr />
<h3
id="cql0311-objects-deployment-region-changed-from-to-object_name">CQL0311:
object’s deployment region changed from ‘<previous_region>’ to
‘<current_region>’ ‘object_name’</h3>
<p>An object may not move between deployment regions, because users of
the schema will depend on its contents. New objects can be added to a
deployment region but nothing can move from one region to another. The
indicated object appears to be moving.</p>
<hr />
<h3
id="cql0312-window-function-invocation-are-forbidden-if-strict-window-function-mode-is-enabled">CQL0312:
window function invocation are forbidden if strict window function mode
is enabled</h3>
<p><code>@enforce_strict</code> has been use to enable strict window
function enforcement. When enabled all sql statement should not invoke
window function. This is because sqlite version running in some iOS
version is old. Window function was added to SQLite in the version
<strong>3.25.0 (2018-09-15)</strong>.</p>
<hr />
<h3
id="cql0313-blob-literals-may-only-appear-in-the-context-of-a-sql-statement">CQL0313:
blob literals may only appear in the context of a SQL statement</h3>
<p>CQL (currently) limits use of blob literals to inside of SQL
fragments. There’s no easy way to get a blob constant variable into the
data section so any implementation would be poor. These don’t come up
very often in any case so this is a punt basically. You can fake it with
(select x’1234’) which makes it clear that you are doing something
expensive. This is not recommended. Better to pass the blob you need
into CQL rather than cons it from a literal. Within SQL it’s just text
and SQLite does the work as usual so that poses no problems. And of
course non-literal blobs (as args) work find and are bound as usual.</p>
<hr />
<h3
id="cql0314-select-function-does-not-require-a-declaration-it-is-a-cql-built-in">CQL0314:
select function does not require a declaration, it is a CQL
built-in</h3>
<p>CQL built-in function does not require a select function declaration.
You can used it directly in your SQL statement.</p>
<hr />
<h3
id="cql0315-mandatory-column-with-no-default-value-in-insert-into-name-default-values-statement.">CQL0315:
mandatory column with no default value in INSERT INTO name DEFAULT
VALUES statement.</h3>
<p>Columns on a table must have default value or be nullable in order to
use INSERT INTO <code>&lt;table&gt;</code> DEFAULT VALUES statement.</p>
<hr />
<h3
id="cql0316-upsert-clause-is-not-compatible-with-default-values">CQL0316:
upsert-clause is not compatible with DEFAULT VALUES</h3>
<p>INSERT statement with DEFAULT VALUES can not be used in a upsert
statement. This form is not supported by SQLite.</p>
<hr />
<h3 id="cql0317-char-function-arguments-must-be-integer">CQL0317: char
function arguments must be integer</h3>
<p>All parameters of the built-In scalar CQL functions
<code>char(...)</code> must be of type integer.</p>
<hr />
<h3 id="cql0318-unused">CQL0318 Unused</h3>
<hr />
<h3 id="cql0319-unused">CQL0319 Unused</h3>
<hr />
<h3 id="cql0320-unused">CQL0320 Unused</h3>
<hr />
<h3
id="cql0321-migration-proc-not-allowed-on-object-object_name">CQL0321:
migration proc not allowed on object ‘object_name’</h3>
<p>The indicated name is an index or a trigger. These objects may not
have a migration script associated with them when they are deleted.</p>
<p>The reason for this is that both these types of objects are attached
to a table and the table itself might be deleted. If the table is
deleted it becomes impossible to express even a tombstone for the
deleted trigger or index without getting errors. As a consequence the
index/trigger must be completely removed. But if there had been a
migration procedure on it then some upgrade sequences would have run it,
but others would not (anyone who upgraded after the table was deleted
would not get the migration procedure). To avoid this problem, migration
procedures are not allowed on indices and triggers.</p>
<hr />
<h3 id="cql0322-unused">CQL0322 Unused</h3>
<hr />
<h3
id="cql0323-calls-to-undeclared-procedures-are-forbidden-declaration-missing-or-typo-procedure">CQL0323:
calls to undeclared procedures are forbidden; declaration missing or
typo ‘procedure’</h3>
<p>If you get this error it means that there is a typo in the name of
the procedure you are trying to call, or else the declaration for the
procedure is totally missing. Maybe a necessary <code>#include</code>
needs to be added to the compiland.</p>
<p>Previously if you attempted to call an unknown CQL would produce a
generic function call. If you need to do this, especially a function
with varargs, then you must declare the function with something
like:</p>
<p><code>DECLARE PROCEDURE printf NO CHECK;</code></p>
<p>This option only works for void functions. For more complex
signatures check <code>DECLARE FUNCTION</code> and
<code>DECLARE SELECT FUNCTION</code>. Usually these will require a
simple wrapper to call from CQL.</p>
<p>In all cases there must be some kind of declaration,to avoid
mysterious linker failures or argument signature mismatches.</p>
<hr />
<h3
id="cql0324-referenced-table-was-created-in-a-later-version-so-it-cannot-be-used-in-a-foreign-key-referenced_table">CQL0324:
referenced table was created in a later version so it cannot be used in
a foreign key ‘referenced_table’</h3>
<p>In a foreign key, we enforce the following rules: *
<code>@recreate</code> tables can see any version they like, if the name
is in scope that’s good enough * other tables may only “see” the same
version or an earlier version.</p>
<p>Normal processing can’t actually get into this state because if you
tried to create the referencing table with the smaller version number
first you would get errors because the name of the referenced table
doesn’t yet exist. But if you created them at the same time and you made
a typo in the version number of the referenced table such that it was
accidentally bigger you’d create a weirdness. So we check for that
situation here and reject it to prevent that sort of typo.</p>
<p>If you see this error there is almost certainly a typo in the version
number of the referenced table; it should be fixed.</p>
<hr />
<h3 id="cql0325-ok_table_scan-attribute-must-be-a-name">CQL0325:
ok_table_scan attribute must be a name</h3>
<p>The values for the attribute <code>ok_table_scan</code> can only be
names.</p>
<p>CQL attributes can have a variety of values but in this case the
attribute refers to the names of tables so no other type of attribute is
reasonable.</p>
<hr />
<h3
id="cql0326-table-name-in-ok_table_scan-does-not-exist-table_name">CQL0326:
table name in ok_table_scan does not exist ‘table_name’</h3>
<p>The names provided to <code>ok_table_scan</code> attribute should be
names of existing tables.</p>
<p>The attribute indicates tables that are ok to scan in this procedure
even though they are typically not ok to scan due to ‘no_table_scan’.
Therefore the attribute must refer to an existing table. There is likely
a typo in the the table name that needs to be corrected.</p>
<hr />
<h3
id="cql0327-a-value-should-not-be-assigned-to-attribute_name-attribute">CQL0327:
a value should not be assigned to ‘attribute_name’ attribute</h3>
<p>The attribute <code>attribute_name</code> doesn’t take a value.</p>
<p>When marking a statement with
<code>@attribute(cql:&lt;attribute_name&gt;)</code> there is no need for
an attribute value.</p>
<hr />
<h3
id="cql0328-attribute_name-attribute-may-only-be-added-to-a-statement_name">CQL0328:
‘attribute_name’ attribute may only be added to a ‘statement_name’</h3>
<p>The <code>attribute_name</code> attribute can only be assigned to
specific statements.</p>
<p>The marking <code>@attribute(cql:&lt;attribute_name&gt;)</code> only
makes sense on specific statement. It’s likely been put somewhere
strange, If it isn’t obviously on the wrong thing, look into possibly
how the source is after macro expansion.</p>
<hr />
<h3
id="cql0329-ok_table_scan-attribute-can-only-be-used-in-a-create-procedure-statement">CQL0329:
ok_table_scan attribute can only be used in a create procedure
statement</h3>
<p>The <code>ok_table_scan</code> can only be placed on a create
procedure statement.</p>
<p>The marking <code>@attribute(cql:ok_table_scan=...)</code> indicates
that the procedure may scan the indicated tables. This marking doesn’t
make sense on other kinds of statements.</p>
<hr />
<h3 id="cql0330-unused">CQL0330 Unused</h3>
<hr />
<h3 id="cql0331-unused">CQL0331 Unused</h3>
<hr />
<h3 id="cql0332-unused">CQL0332 Unused</h3>
<hr />
<h3 id="cql0333-unused">CQL0333 Unused</h3>
<hr />
<h3
id="cql0334-dummy_seed-dummy_nullables-dummy_defaults-many-only-be-used-with-a-single-values-row">CQL0334:
<span class="citation" data-cites="dummy_seed">@dummy_seed</span> <span
class="citation" data-cites="dummy_nullables">@dummy_nullables</span>
<span class="citation"
data-cites="dummy_defaults">@dummy_defaults</span> many only be used
with a single VALUES row</h3>
<p>Dummy insert feature makes only sense when it’s used in a VALUES
clause that is not part of a compound select statement.</p>
<h3
id="cql0336-select-statement-with-values-clause-requires-a-non-empty-list-of-values">CQL0336:
select statement with VALUES clause requires a non empty list of
values</h3>
<p>VALUES clause requires at least a value for each of the values list.
Empty values list are not supported.</p>
<hr />
<h3
id="cql0337-number-of-columns-values-for-each-row-should-be-identical-in-values-clause">CQL0337:
number of columns values for each row should be identical in VALUES
clause</h3>
<p>The number of values for each values list in VALUES clause should
always be the same.</p>
<hr />
<h3
id="cql0338-name-of-a-migration-procedure-may-not-end-in-_crc-procedure_name">CQL0338:
name of a migration procedure may not end in ’_crc’
‘procedure_name’</h3>
<p>To avoid name conflicts in the upgrade script, migration procedures
are not allowed to end in ’_crc’ this suffix is reserved for internal
use.</p>
<hr />
<h3
id="cql0339-without-rowid-tables-are-forbidden-if-strict-without-rowid-mode-is-enabled">CQL0339:
WITHOUT ROWID tables are forbidden if strict without rowid mode is
enabled</h3>
<p><code>@enforce_strict</code> has been used to enable strict
<code>WITHOUT ROWID</code> enforcement. When enabled no CREATE TABLE
statement can have WITHOUT ROWID clause.</p>
<hr />
<h3
id="cql0340-from-arguments-used-in-a-procedure-with-no-arguments-procedure_name">CQL0340:
FROM ARGUMENTS used in a procedure with no arguments
‘procedure_name’</h3>
<p>The named procedure has a call that uses the FROM ARGUMENTS pattern
but it doesn’t have any arguments. This is almost certainly a cut/paste
from a different location that needs to be adjusted.</p>
<hr />
<h3
id="cql0341-argument-must-be-a-variable-in-function-function_name">CQL0341:
argument must be a variable in function ‘function_name’</h3>
<p>The argument for the CQL builtin function ‘function_name’ should
always be a variable. It can not be an expression for example</p>
<hr />
<h3
id="cql0342-cursor-arguments-must-have-identical-column-count-function_name">CQL0342:
cursor arguments must have identical column count ‘function_name’</h3>
<p>The number of column in the cursor arguments must be identical to
accurately do diffing between two cursors.</p>
<hr />
<h3 id="cql0343-all-arguments-must-be-blob-cql_get_blob_size">CQL0343:
all arguments must be blob ‘cql_get_blob_size’</h3>
<p>The argument for the CQL builtin function cql_get_blob_size should
always be of type blob</p>
<hr />
<h3
id="cql0344-argument-must-be-a-nullable-type-but-not-constant-null-in-function">CQL0344:
argument must be a nullable type (but not constant NULL) in
‘function’</h3>
<p>Functions like <code>ifnull_crash</code> only make sense if the
argument is nullable. If it’s already not null the operation is
uninteresting/redundant.</p>
<p>The most likely cause is that the function call in question is
vestigial and you can simply remove it.</p>
<hr />
<h3 id="cql0345-arguments-must-be-of-type-blob-function_name">CQL0345:
arguments must be of type blob ‘function_name’</h3>
<p>The indicated function accepts only a single argument of type
blob.</p>
<hr />
<h3
id="cql0346-expression-must-be-of-type-objectt-cursor-where-t-is-a-valid-shape-name-variable">CQL0346:
expression must be of type <code>object&lt;T cursor&gt;</code> where T
is a valid shape name ‘variable’</h3>
<p>It’s possible to take the statement associated with a statement
cursor and store it in an object variable. Using the form:</p>
<div class="sourceCode" id="cb573"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb573-1"><a href="#cb573-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> C <span class="kw">cursor</span> <span class="cf">for</span> X;</span></code></pre></div>
<p>The object variable ‘X’ must be declared as follows:</p>
<div class="sourceCode" id="cb574"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb574-1"><a href="#cb574-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> X <span class="dt">object</span><span class="op">&lt;</span>T <span class="kw">cursor</span><span class="op">&gt;</span>;</span></code></pre></div>
<p>Where <code>T</code> refers to a named object with a shape, like a
table, a view, or a stored procedure that returns a result set. This
type <code>T</code> must match the shape of the cursor exactly
i.e. having the column names and types.</p>
<p>The reverse operation, storing a statement cursor in a variable is
also possible with this form:</p>
<div class="sourceCode" id="cb575"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb575-1"><a href="#cb575-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> X <span class="kw">from</span> <span class="kw">cursor</span> C;</span></code></pre></div>
<p>This has similar constraints on the variable <code>X</code>.</p>
<p>This error indicates that the variable in question (<code>X</code> in
this example) is not a typed object variable so it can’t be the source
of a cursor, or accept a cursor.</p>
<p>See Chapter 5 of the CQL Programming Language.</p>
<hr />
<h3
id="cql0347-select-function-may-not-return-type-object-function_name">CQL0347:
select function may not return type OBJECT ‘function_name’</h3>
<p>The indicated function was declared with
<code>DECLARE SELECT FUNCTION</code> meaning it is to be used in the
context of SQLite statements. However, SQLite doesn’t understand
functions that return type object at all. Therefore declaration is
illegal.</p>
<p>When working with pointer type through SQLite it is often possibly to
encode the object as an long integer assuming it can pass through
unchanged with no retain/release semantics or any such thing. If that is
practical you can move objects around by returning long integers.</p>
<hr />
<h3
id="cql0348-collate-applied-to-a-non-text-column-column_name">CQL0348:
collate applied to a non-text column ‘column_name’</h3>
<p>Collation order really only makes sense on text fields. Possibly blob
fields but we’re taking a stand on blob for now. This can be relaxed
later if that proves to be a mistake. For now, only text</p>
<hr />
<h3
id="cql0349-column-definitions-may-not-come-after-constraints-column_name">CQL0349:
column definitions may not come after constraints ‘column_name’</h3>
<p>In a CREATE TABLE statement, the indicated column name came after a
constraint. SQLite expects all the column definitions to come before any
constraint definitions. You must move the offending column definition
above the constraints.</p>
<hr />
<h3
id="cql0350-statement-must-appear-inside-of-a-proc-savepoint-block">CQL0350:
statement must appear inside of a PROC SAVEPOINT block</h3>
<p>The <code>ROLLBACK RETURN</code> and <code>COMMIT RETURN</code> forms
are only usable inside of a <code>PROC SAVEPOINT</code> block because
they rollback or commit the savepoint that was created at the top
level.</p>
<hr />
<h3
id="cql0351-statement-should-be-in-a-procedure-and-at-the-top-level">CQL0351:
statement should be in a procedure and at the top level</h3>
<p>The indicated statement may only appear inside procedure and not
nested. The classic example of this is the <code>PROC SAVEPOINT</code>
form which can only be used at the top level of procedures.</p>
<hr />
<h3
id="cql0352-use-commit-return-or-rollback-return-in-within-a-proc-savepoint-block">CQL0352:
use COMMIT RETURN or ROLLBACK RETURN in within a proc savepoint
block</h3>
<p>The normal <code>RETURN</code> statement cannot be used inside of
<code>PROC SAVEPOINT</code> block, you have to indicate if you want to
commit or rollback the savepoint when you return. This makes it
impossible to forget to do so which is in some sense the whole point of
<code>PROC SAVEPOINT</code>.</p>
<hr />
<h3 id="cql0353-evaluation-of-constant-failed">CQL0353: evaluation of
constant failed</h3>
<p>The constant expression could not be evaluated. This is most likely
because it includes an operator that is not supported or a function call
which is not support. Very few functions can be used in constant
expressions The supported functions include <code>iif</code>, which is
rewritten; <code>abs</code>; <code>ifnull</code>, <code>nullif</code>,
and <code>coalesce</code>.</p>
<hr />
<h3 id="cql0354-duplicate-enum-member-enum_name">CQL0354: duplicate enum
member ‘enum_name’</h3>
<p>While processing a <code>declare enum</code> statement the indicated
member of the enum appeared twice.</p>
<p>This is almost certainly a copy/paste of the same enum member
twice.</p>
<hr />
<h3 id="cql0355-evaluation-failed-enum_name">CQL0355: evaluation failed
‘enum_name’</h3>
<p>While processing a <code>declare enum</code> statement the indicated
member of the enum could not be evaluated as a constant expression.</p>
<p>There could be a non-constant in the expression or there could be a
divide-by-zero error.</p>
<hr />
<h3 id="cql0356-enum-definitions-do-not-match-name">CQL0356: enum
definitions do not match ‘name’</h3>
<p>The two described <code>declare enum</code> statements have the same
name but they are not identical.</p>
<p>The error output contains the full text of both declarations to
compare.</p>
<hr />
<h3 id="cql0357-enum-does-not-contain-enum_name">CQL0357: enum does not
contain ‘enum_name’</h3>
<p>The indicated member is not part of the enumeration.</p>
<hr />
<h3 id="cql0358-declared-enums-must-be-top-level-enum">CQL0358: declared
enums must be top level ‘enum’</h3>
<p>A <code>DECLARE ENUM</code> statement for the named enum is happening
inside of a procedure. This is not legal.</p>
<p>To correct this move the declaration outside of the procedure.</p>
<hr />
<h3 id="cql0359-duplicate-type-declaration-type_name">CQL0359: duplicate
type declaration ‘type_name’</h3>
<p>The name of a declared type should always be unique.</p>
<hr />
<h3 id="cql0360-unknown-type-type_name">CQL0360: unknown type
‘type_name’</h3>
<p>The indicated name is not a valid type name.</p>
<hr />
<h3
id="cql0361-return-data-type-in-a-create-function-declaration-can-only-be-text-blob-or-object">CQL0361:
return data type in a create function declaration can only be Text, Blob
or Object</h3>
<p>Return data type in a create function definition can only be TEXT,
BLOB or OBJECT.</p>
<p>These are the only reference types and so CREATE makes sense only
with those types. An integer, for instance, can’t start with a +1
reference count.</p>
<hr />
<h3
id="cql0362-hidden-column-attribute-must-be-the-first-attribute-if-present">CQL0362:
HIDDEN column attribute must be the first attribute if present</h3>
<p>In order to ensure that SQLite will parse HIDDEN as part of the type
it has to come before any other attributes like NOT NULL.</p>
<p>This limitation is due to the fact that CQL and SQLite use slightly
different parsing approaches for attributes and in SQLite HIDDEN isn’t
actually an attribute. The safest place to put the attribute is right
after the type name and before any other attributes as it is totally
unambiguous there so CQL enforces this.</p>
<hr />
<h3 id="cql0363-all-arguments-must-be-names-vault_sensitive">CQL0363:
all arguments must be names ‘vault_sensitive’</h3>
<p>vault_sensitive attribution only allow names. Integer, string
literal, c string or blob are not allowed, only IDs should be
provided.</p>
<hr />
<h3
id="cql0364-vault_sensitive-annotation-can-only-go-on-a-procedure-that-uses-the-database">CQL0364:
vault_sensitive annotation can only go on a procedure that uses the
database</h3>
<p>The named procedure has the <code>vault_sensitive</code> annotation
to automatically encode sensitive value in the result set. Encoding
value require the database, but the procedure in question doesn’t even
use the database at all. This annotation is therefore useless.</p>
<hr />
<h3 id="cql0365-enforce_pop-used-but-there-is-nothing-to-pop">CQL0365:
<span class="citation" data-cites="enforce_pop">@enforce_pop</span> used
but there is nothing to pop</h3>
<p>Each <code>@enforce_pop</code> should match an
<code>@enforce_push</code>, but there is nothing to pop on the stack
now.</p>
<hr />
<h3
id="cql0366-transaction-operations-disallowed-while-strict-transaction-enforcement-is-on">CQL0366:
transaction operations disallowed while STRICT TRANSACTION enforcement
is on</h3>
<p><code>@enforce_strict transaction</code> has been used, while active
no transaction operations are allowed. Savepoints may be used. This is
typically done to prevent transactions from being used in any ad hoc way
because they don’t nest and typically need to be used with some “master
plan” in mind.</p>
<hr />
<h3
id="cql0367-an-attribute-was-specified-twice-attribute_name">CQL0367: an
attribute was specified twice ‘attribute_name’</h3>
<p>In the indicated type declaration, the indicated attribute was
specified twice. This is almost certainly happening because the line in
question looks like this <code>declare x type_name not null;</code> but
<code>type_name</code> is already <code>not null</code>.</p>
<hr />
<h3
id="cql0368-strict-select-if-nothing-requires-that-all-select-expressions-include-if-nothing">CQL0368:
strict select if nothing requires that all (select …) expressions
include ‘if nothing’</h3>
<p><code>@enforce_strict select if nothing</code> has been enabled. This
means that select expressions must include <code>if nothing throw</code>
(the old default) <code>if nothing [value]</code> or
<code>if nothing or null [value]</code>. This options exists because
commonly the case where a row does not exist is not handled correctly
when <code>(select ...)</code> is used without the
<code>if nothing</code> options.</p>
<p>If your select expression uses a <a
href="https://www.sqlite.org/lang_aggfunc.html">built-in aggregate
function</a>, this check may not be enforced because they can always
return a row. But there are exceptions. The check is still enforced when
one of the following is in the expression: - a <code>GROUP BY</code>
clause - a <code>LIMIT</code> that evaluates to less than 1, or is a
variable - an <code>OFFSET</code> clause - You have a <code>min</code>
or <code>max</code> function with more than 1 argument. Those are <a
href="https://sqlite.org/lang_corefunc.html#max_scalar">scalar
functions</a>.</p>
<hr />
<h3
id="cql0369-select-if-nothing-construct-is-for-use-in-top-level-expressions-not-inside-of-other-dml">CQL0369:
(SELECT … IF NOTHING) construct is for use in top level expressions, not
inside of other DML</h3>
<p>This form allows for error control of (select…) expressions. But
SQLite does not understand the form at all, so it can only appear at the
top level of expressions where CQL can strip it out. Here are some
examples:</p>
<p>good:</p>
<div class="sourceCode" id="cb576"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb576-1"><a href="#cb576-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> x <span class="op">:=</span> (<span class="kw">select</span> foo <span class="kw">from</span> bar <span class="kw">where</span> baz <span class="cf">if</span> <span class="kw">nothing</span> <span class="dv">0</span>);</span>
<span id="cb576-2"><a href="#cb576-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">select</span> foo <span class="kw">from</span> bar <span class="kw">where</span> baz <span class="cf">if</span> <span class="kw">nothing</span> <span class="dv">1</span>) <span class="cf">then</span> <span class="op">..</span>. <span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>bad:</p>
<div class="sourceCode" id="cb577"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb577-1"><a href="#cb577-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> foo <span class="kw">from</span> bar <span class="kw">where</span> (<span class="kw">select</span> something <span class="kw">from</span> somewhere <span class="cf">if</span> <span class="kw">nothing</span> <span class="kw">null</span>);</span>
<span id="cb577-2"><a href="#cb577-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span> <span class="kw">from</span> foo <span class="kw">where</span> (<span class="kw">select</span> something <span class="kw">from</span> somewhere <span class="cf">if</span> <span class="kw">nothing</span> <span class="dv">1</span>);</span></code></pre></div>
<p>Basically if you are already in a SQL context, the form isn’t usable
because SQLite simply doesn’t understand if nothing at all. This error
makes it so that you’ll get a build time failure from CQL rather than a
run time failure from SQLite.</p>
<hr />
<h3
id="cql0370-due-to-a-memory-leak-bug-in-old-sqlite-versions-the-select-part-of-an-insert-must-not-have-a-top-level-join-or-compound-operator.-use-with-and-a-cte-or-a-nested-select-to-work-around-this.">CQL0370:
due to a memory leak bug in old SQLite versions, the select part of an
insert must not have a top level join or compound operator. Use WITH and
a CTE, or a nested select to work around this.</h3>
<p>There is an unfortunate memory leak in older versions of SQLite
(research pending on particular versions, but 3.28.0 has it). It causes
this pattern to leak:</p>
<div class="sourceCode" id="cb578"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb578-1"><a href="#cb578-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- must be autoinc table</span></span>
<span id="cb578-2"><a href="#cb578-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> x (</span>
<span id="cb578-3"><a href="#cb578-3" aria-hidden="true" tabindex="-1"></a>  pk <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> autoincrement</span>
<span id="cb578-4"><a href="#cb578-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb578-5"><a href="#cb578-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb578-6"><a href="#cb578-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- any join will do (this is a minimal repro)</span></span>
<span id="cb578-7"><a href="#cb578-7" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> x</span>
<span id="cb578-8"><a href="#cb578-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">NULL</span> pk <span class="kw">from</span></span>
<span id="cb578-9"><a href="#cb578-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">select</span> <span class="dv">1</span>) t1 <span class="kw">inner</span> <span class="kw">join</span> (<span class="kw">select</span> <span class="dv">1</span>) t2;</span></code></pre></div>
<p>You can workaround this with a couple of fairly simple rewrites. This
form is probably the cleanest.</p>
<div class="sourceCode" id="cb579"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb579-1"><a href="#cb579-1" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb579-2"><a href="#cb579-2" aria-hidden="true" tabindex="-1"></a>cte (pk) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">..</span> anything you need)</span>
<span id="cb579-3"><a href="#cb579-3" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> x</span>
<span id="cb579-4"><a href="#cb579-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> cte;</span></code></pre></div>
<p>Simply wrapping your desired select in a nested select also suffices.
So long as the top level is simple.</p>
<div class="sourceCode" id="cb580"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb580-1"><a href="#cb580-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> x</span>
<span id="cb580-2"><a href="#cb580-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> (</span>
<span id="cb580-3"><a href="#cb580-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> anything you need<span class="op">....</span></span>
<span id="cb580-4"><a href="#cb580-4" aria-hidden="true" tabindex="-1"></a>  );</span></code></pre></div>
<hr />
<h3
id="cql0371-table-valued-function-used-in-a-leftrightcross-context-this-would-hit-a-sqlite-bug.-wrap-it-in-a-cte-instead.">CQL0371:
table valued function used in a left/right/cross context; this would hit
a SQLite bug. Wrap it in a CTE instead.</h3>
<p>This error is generated by
<code>@enforce_strict table function</code>. It is there to allow safe
use of Table Valued Functions (TVFs) even though there was a bug in
SQLite prior to v 3.31.0 when joining against them. The bug appears when
the TVF is on the right of a left join. For example:</p>
<div class="sourceCode" id="cb581"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb581-1"><a href="#cb581-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">left</span> <span class="kw">join</span> some_tvf(<span class="dv">1</span>);</span></code></pre></div>
<p>In this case the join becomes an INNER join even though you wrote a
left join. Likewise</p>
<div class="sourceCode" id="cb582"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb582-1"><a href="#cb582-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> some_tvf(<span class="dv">1</span>) <span class="kw">right</span> <span class="kw">join</span> foo;</span></code></pre></div>
<p>Becomes an inner join even though you wrote a right join. The same
occurs when a TVF is on either side of a cross join.</p>
<p>The workaround is very simple. You don’t want the TVF to be the
target of the join directly. Instead:</p>
<div class="sourceCode" id="cb583"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb583-1"><a href="#cb583-1" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> tvf_(<span class="op">*</span>) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> some_tvf(<span class="dv">1</span>))</span>
<span id="cb583-2"><a href="#cb583-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">left</span> <span class="kw">join</span> tvf_;</span></code></pre></div>
<p>OR</p>
<div class="sourceCode" id="cb584"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb584-1"><a href="#cb584-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> foo <span class="kw">left</span> <span class="kw">join</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> some_tvf(<span class="dv">1</span>));</span></code></pre></div>
<hr />
<h3
id="cql0372-select-if-nothing-or-null-null-is-redundant-use-select-if-nothing-null-instead.">CQL0372:
SELECT … IF NOTHING OR NULL NULL is redundant; use SELECT … IF NOTHING
NULL instead.</h3>
<p>It is always the case that
<code>SELECT ... IF NOTHING OR NULL NULL</code> is equivalent to
<code>SELECT ... IF NOTHING NULL</code>. As such, do not do this:</p>
<div class="sourceCode" id="cb585"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb585-1"><a href="#cb585-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> foo <span class="kw">from</span> bar <span class="kw">where</span> baz <span class="cf">if</span> <span class="kw">nothing</span> <span class="kw">or</span> <span class="kw">null</span> <span class="kw">null</span></span></code></pre></div>
<p>Do this instead:</p>
<div class="sourceCode" id="cb586"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb586-1"><a href="#cb586-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> foo <span class="kw">from</span> bar <span class="kw">where</span> baz <span class="cf">if</span> <span class="kw">nothing</span> <span class="kw">null</span></span></code></pre></div>
<hr />
<h3
id="cql0373-comparing-against-null-always-yields-null-use-is-and-is-not-instead.">CQL0373:
comparing against NULL always yields NULL; use IS and IS NOT
instead.</h3>
<p>Attempting to check if some value <code>x</code> is NULL via
<code>x = NULL</code> or <code>x == NULL</code>, or isn’t NULL via
<code>x &lt;&gt; NULL</code> or <code>x != NULL</code>, will always
produce NULL regardless of the value of <code>x</code>. Instead, use
<code>x IS NULL</code> or <code>x IS NOT NULL</code> to get the expected
boolean result.</p>
<hr />
<h3 id="cql0374-select-expression-is-equivalent-to-null.">CQL0374:
SELECT expression is equivalent to NULL.</h3>
<p>CQL found a redundant select operation (e.g.,
<code>set x := (select NULL);</code>).</p>
<p>There is no need to write a select expression that always evaluates
to NULL. Simply use NULL instead (e.g.,
<code>set x := NULL;</code>).</p>
<hr />
<p>CQL 0375 Unused, this was added to prevent merge conflicts at the end
on literally every checkin</p>
<hr />
<p>CQL 0376 Unused, this was added to prevent merge conflicts at the end
on literally every checkin</p>
<hr />
<h3
id="cql0377-table-transitioning-from-recreate-to-create-must-use-createnncqlfrom_recreate-table-name">CQL0377:
table transitioning from <code>@recreate</code> to <code>@create</code>
must use <code>@create(nn,cql:from_recreate)</code> ‘table name’</h3>
<p>The indicated table is moving from <code>@recreate</code> to
<code>@create</code> meaning it will now be schema managed in an
upgradable fashion. When this happens end-user databases might have some
stale version of the table from a previous installation. This stale
version must get a one-time cleanup in order to ensure that the now
current schema is correctly applied. The <code>cql:from_recreate</code>
annotation does this. It is required because otherwise there would be no
record that this table “used to be recreate” and therefore might have an
old version still in the database.</p>
<p>A correct table might look something like this:</p>
<div class="sourceCode" id="cb587"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb587-1"><a href="#cb587-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> correct_migration_to_create(</span>
<span id="cb587-2"><a href="#cb587-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb587-3"><a href="#cb587-3" aria-hidden="true" tabindex="-1"></a> t text</span>
<span id="cb587-4"><a href="#cb587-4" aria-hidden="true" tabindex="-1"></a>) @create(<span class="dv">7</span>, cql<span class="ch">:from_recreate</span>);</span></code></pre></div>
<hr />
<h3
id="cql0378-built-in-migration-procedure-not-valid-in-this-context-name">CQL0378:
built-in migration procedure not valid in this context ‘name’</h3>
<p>The indicated name is a valid built-in migration procedure but it is
not valid on this kind of item. For instance
<code>cql:from_recreate</code> can only be applied to tables.</p>
<hr />
<h3 id="cql0379-unknown-built-in-migration-procedure-name">CQL0379:
unknown built-in migration procedure ‘name’</h3>
<p>Certain schema migration steps are built-in. Currently the only one
is <code>cql:from_recreate</code> for moving to <code>@create</code>
from <code>@recreate</code>. Others may be added in the future. The
<code>cql:</code> prefix ensures that this name cannot conflict with a
valid user migration procedure.</p>
<hr />
<h3
id="cql0380-when-expression-cannot-be-evaluated-to-a-constant">CQL0380:
WHEN expression cannot be evaluated to a constant</h3>
<p>In a <code>SWITCH</code> statement each expression each expression in
a <code>WHEN</code> clause must be made up of constants and simple
numeric math operations. See the reference on the <code>const(..)</code>
expression for the valid set.</p>
<p>It’s most likely that a variable or function call appears in the
errant expression.</p>
<hr />
<h3
id="cql0381-case-expression-must-be-a-not-null-integral-type">CQL0381:
case expression must be a not-null integral type</h3>
<p>The <code>SWITCH</code> statement can only switch over integers or
long integers. It will be translated directly to the C switch statement
form. <code>TEXT</code>, <code>REAL</code>, <code>BLOB</code>,
<code>BOOL</code>, and <code>OBJECT</code> cannot be used in this
way.</p>
<hr />
<h3
id="cql0382-type-of-a-when-expression-is-bigger-than-the-type-of-the-switch-expression">CQL0382:
type of a WHEN expression is bigger than the type of the SWITCH
expression</h3>
<p>The <code>WHEN</code> expression evaluates to a
<code>LONG INTEGER</code> but the expression in the <code>SWITCH</code>
is <code>INTEGER</code>.</p>
<hr />
<h3
id="cql0383-switch-all-values-is-useless-with-an-else-clause">CQL0383:
switch … ALL VALUES is useless with an ELSE clause</h3>
<p>The <code>ALL VALUES</code> form of switch means that: * the
<code>SWITCH</code> expression is an enumerated type * the
<code>WHEN</code> cases will completely cover the values of the enum</p>
<p>If you allow the <code>ELSE</code> form then <code>ALL VALUES</code>
becomes meaningless because of course they are all covered. So with
<code>ALL VALUES</code> there can be no <code>ELSE</code>.</p>
<p>You can list items that have no action with this form:</p>
<div class="sourceCode" id="cb588"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb588-1"><a href="#cb588-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">WHEN</span> <span class="dv">10</span>, <span class="dv">15</span> <span class="cf">THEN</span> <span class="kw">NOTHING</span> <span class="co">-- explicitly do nothing in these cases so they are still covered</span></span></code></pre></div>
<p>No code is generated for such cases.</p>
<hr />
<h3
id="cql0384-switch-statement-did-not-have-any-actual-statements-in-it">CQL0384:
switch statement did not have any actual statements in it</h3>
<p>Either there were no <code>WHEN</code> clauses at all, or they were
all <code>WHEN ... THEN NOTHING</code> so there is no actual code to
execute. You need to add some cases that do work.</p>
<hr />
<h3 id="cql0385-when-clauses-contain-duplicate-values-value">CQL0385:
WHEN clauses contain duplicate values ‘value’</h3>
<p>In a <code>SWITCH</code> statement all of the values in the
<code>WHEN</code> clauses must be unique. The indicated errant entry is
a duplicate.</p>
<hr />
<h3
id="cql0386-switch-all-values-is-used-but-the-switch-expression-is-not-an-enum-type">CQL0386:
SWITCH … ALL VALUES is used but the switch expression is not an enum
type</h3>
<p>In a <code>SWITCH</code> statement with <code>ALL VALUES</code>
specified the switch expression was not an enumerated type.
<code>ALL VALUES</code> is used to ensure that there is a case for every
value of an enumerated type so this switch cannot be so checked. Either
correct the expression, or remove <code>ALL VALUES</code>.</p>
<hr />
<h3
id="cql0387-a-value-exists-in-the-enum-that-is-not-present-in-the-switch-enum_member">CQL0387:
a value exists in the enum that is not present in the switch
‘enum_member’</h3>
<p>In a <code>SWITCH</code> statement with <code>ALL VALUES</code>
specified the errant enum member did not appear in any <code>WHEN</code>
clause. All members must be specified when <code>ALL VALUES</code> is
used.</p>
<hr />
<h3
id="cql0388-a-value-exists-in-the-switch-that-is-not-present-in-the-enum-numeric_value">CQL0388:
a value exists in the switch that is not present in the enum
‘numeric_value’</h3>
<p>In a <code>SWITCH</code> statement with <code>ALL VALUES</code>
specified the errant integer value appeared in in a <code>WHEN</code>
clause. This value is not part of the members of the enum. Note that
enum members that begin with ’_’ are ignored as they are, by convention,
considered to be pseudo-members. e.g. in
<code>declare enum v integer (v0 = 0, v1 =1, v2 =2, _count = 3)</code>
<code>_count</code> is a pseudo-member.</p>
<p>The errant entry should probably be removed. Alternatively,
<code>ALL VALUES</code> isn’t appropriate as the domain of the switch is
actually bigger than the domain of the enumeration. One of these changes
must happen.</p>
<hr />
<h3
id="cql0389-declare-out-requires-that-the-procedure-be-already-declared">CQL0389:
DECLARE OUT requires that the procedure be already declared</h3>
<p>The purpose of the <code>DECLARE OUT</code> form is to automatically
declare the out parameters for that procedure.</p>
<p>This cannot be done if the type of the procedure is not yet
known.</p>
<hr />
<h3
id="cql0390-declare-out-call-used-on-a-procedure-with-no-missing-out-arguments">CQL0390:
DECLARE OUT CALL used on a procedure with no missing OUT arguments</h3>
<p>The <code>DECLARE OUT CALL</code> form was used, but the procedure
has no <code>OUT</code> arguments that need any implicit declaration.
Either they have already all been declared or else there are no
<code>OUT</code> arguments at all, or even no arguments of any kind.</p>
<hr />
<h3 id="cql0391-close-cannot-be-used-on-a-boxed-cursor">CQL0391: CLOSE
cannot be used on a boxed cursor</h3>
<p>When a cursor is boxed—i.e., wrapped in an object—the lifetime of the
box and underlying statement are automatically managed via reference
counting. Accordingly, it does not make sense to manually call CLOSE on
such a cursor as it may be retained elsewhere. Instead, to allow the box
to be freed and the underlying statement to be finalized, set all
references to the cursor to NULL.</p>
<p>Note: As with all other objects, boxed cursors are automatically
released when they fall out of scope. You only have to set a reference
to NULL if you want to release the cursor sooner, for some reason.</p>
<hr />
<h3
id="cql0392-when-deleting-a-virtual-table-you-must-specify-deletenn-cqlmodule_must_not_be_deleted_see_docs_for_cql0392-as-a-reminder-not-to-delete-the-module-for-this-virtual-table">CQL0392:
when deleting a virtual table you must specify <span class="citation"
data-cites="delete">@delete</span>(nn,
cql:module_must_not_be_deleted_see_docs_for_CQL0392) as a reminder not
to delete the module for this virtual table</h3>
<p>When the schema upgrader runs, if the virtual table is deleted it
will attempt to do <code>DROP TABLE IF EXISTS</code> on the indicated
table. This table is a virtual table. SQLite will attempt to initialize
the table even when you simply try to drop it. For that to work the
module must still be present. This means modules can never be deleted!
This attribute is here to remind you of this fact so that you are not
tempted to delete the module for the virtual table when you delete the
table. You may, however, replace it with a shared do-nothing stub.</p>
<p>The attribute itself does nothing other than hopefully cause you to
read this documentation.</p>
<hr />
<h3
id="cql0393-not-deterministic-user-function-cannot-appear-in-a-constraint-expression-function_name">CQL0393:
not deterministic user function cannot appear in a constraint expression
‘function_name’</h3>
<p><code>CHECK</code> expressions and partial indexes
(<code>CREATE INDEX</code> with a <code>WHERE</code> clause) require
that the expressions be deterministic. User defined functions may or may
not be deterministic.</p>
<p>Use <span class="citation"
data-cites="attribute">@attribute</span>(cql:deterministic) on a UDF
declaration (declare select function…) to mark it deterministic and
allow its use in an index.</p>
<hr />
<h3
id="cql0394-nested-select-expressions-may-not-appear-inside-of-a-constraint-expression">CQL0394:
nested select expressions may not appear inside of a constraint
expression</h3>
<p>SQLite does not allow the use of correlated subqueries or other
embedded select statements inside of a CHECK expression or the WHERE
clauses of a partial index. This would require additional joins on every
such operation which would be far too expensive.</p>
<hr />
<h3
id="cql0395-table-valued-functions-may-not-be-used-in-an-expression-context-function_name">CQL0395:
table valued functions may not be used in an expression context
‘function_name’</h3>
<p>A table valued function should be used like a table e.g.</p>
<div class="sourceCode" id="cb589"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb589-1"><a href="#cb589-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is right</span></span>
<span id="cb589-2"><a href="#cb589-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> table_valued_func(<span class="dv">5</span>);</span></code></pre></div>
<p>Not like a value e.g.</p>
<div class="sourceCode" id="cb590"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb590-1"><a href="#cb590-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is wrong</span></span>
<span id="cb590-2"><a href="#cb590-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> table_valued_func(<span class="dv">5</span>);</span>
<span id="cb590-3"><a href="#cb590-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb590-4"><a href="#cb590-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- this is also wrong</span></span>
<span id="cb590-5"><a href="#cb590-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="dv">1</span> <span class="kw">where</span> table_valued_func(<span class="dv">5</span>) <span class="op">=</span> <span class="dv">3</span>;</span></code></pre></div>
<hr />
<h3
id="cql0396-versioning-attributes-may-not-be-used-on-ddl-inside-a-procedure">CQL0396:
versioning attributes may not be used on DDL inside a procedure</h3>
<p>If you are putting DDL inside of a procedure then that is going to
run regardless of any <code>@create</code>, <code>@delete</code>, or
<code>@recreate</code> attributes;</p>
<p>DDL in entires do not get versioning attributes, attributes are
reserved for schema declarations outside of any procedure.</p>
<hr />
<h3
id="cql0397-object-is-an-orphan-because-its-table-is-deleted.-remove-rather-than-delete-object_name">CQL0397:
object is an orphan because its table is deleted. Remove rather than
<span class="citation" data-cites="delete">@delete</span>
‘object_name’</h3>
<p>This error is about either a trigger or an index. In both cases you
are trying to use <code>@delete</code> on the index/trigger but the
table that the named object is based on is itself deleted, so the object
is an orphan. Because of this, the orphaned object doesn’t need, or no
longer needs, an <code>@delete</code> tombstone because when the table
is dropped, all of its orphaned indices and triggers will also be
dropped.</p>
<p>To fix this error, remove the named object entirely rather than
marking it <code>@delete</code>.</p>
<p>Note: if the index/trigger was previously deleted and now the table
is also deleted, it is now safe to remove the index/trigger
<code>@delete</code> tombstone and this error reminds you to do so.</p>
<hr />
<h3
id="cql0398-a-compound-select-cannot-be-ordered-by-the-result-of-an-expression">CQL0398:
a compound select cannot be ordered by the result of an expression</h3>
<p>When specifying an <code>ORDER BY</code> for a compound select, you
may only order by indices (e.g., <code>3</code>) or names (e.g.,
<code>foo</code>) that correspond to an output column, not by the result
of an arbitrary expression (e.g., <code>foo + bar</code>).</p>
<p>For example, this is allowed:</p>
<div class="sourceCode" id="cb591"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb591-1"><a href="#cb591-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> x, y <span class="kw">FROM</span> t0 <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">select</span> x, y <span class="kw">FROM</span> t1 <span class="kw">ORDER</span> <span class="kw">BY</span> y</span></code></pre></div>
<p>The equivalent using an index is also allowed:</p>
<div class="sourceCode" id="cb592"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb592-1"><a href="#cb592-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> x, y <span class="kw">FROM</span> t0 <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">select</span> x, y <span class="kw">FROM</span> t1 <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">2</span></span></code></pre></div>
<p>This seemingly equivalent version containing an arbitrary expression,
however, is not:</p>
<div class="sourceCode" id="cb593"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb593-1"><a href="#cb593-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> x, y <span class="kw">FROM</span> t0 <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">select</span> x, y <span class="kw">FROM</span> t1 <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span>;</span></code></pre></div>
<hr />
<h3
id="cql0399-table-must-leave-recreate-management-with-createnn-or-later-table_name">CQL0399:
table must leave <span class="citation"
data-cites="recreate">@recreate</span> management with <span
class="citation" data-cites="create">@create</span>(nn) or later
‘table_name’</h3>
<p>The indicated table changed from <code>@recreate</code> to
<code>@create</code> but it did so in a past schema version. The change
must happen in the current schema version. That version is indicated by
the value of nn.</p>
<p>To fix this you can change the <code>@create</code> annotation so
that it matches the number in this error message</p>
<hr />
<h3 id="cql0400-encode-context-column-cant-be-sensitive">CQL0400: encode
context column can’t be sensitive</h3>
<p>The encode context column will be used to encode sensitive fields, it
can’t be exposed to encode functions</p>
<hr />
<h3
id="cql0401-encode-context-column-must-be-specified-if-strict-encode-context-column-mode-is-enabled">CQL0401:
encode context column must be specified if strict encode context column
mode is enabled</h3>
<p>encode context column must be specified in vault_sensitive attribute
with format: <span class="citation"
data-cites="attribute">@attribute</span>(cql:vault_sensitive=(encode_context_col,
(col1, col2, …))</p>
<hr />
<h3
id="cql0402-encode-context-column-in-vault_sensitive-attribute-must-match-the-specified-type-in-strict-mode">CQL0402:
encode context column in vault_sensitive attribute must match the
specified type in strict mode</h3>
<p>encode context column must match the specified type in
vault_sensitive attribute with format: <span class="citation"
data-cites="attribute">@attribute</span>(cql:vault_sensitive=(encode_context_col,
(col1, col2, …))</p>
<hr />
<h3
id="cql0403-operator-may-not-be-used-because-it-is-not-supported-on-old-versions-of-sqlite-operator">CQL0403:
operator may not be used because it is not supported on old versions of
SQLite, ‘operator’</h3>
<p>The indicated operator has been suppressed with
<code>@enforce_strict is true</code> because it is not available on
older versions of sqlite.</p>
<hr />
<h3
id="cql0404-procedure-cannot-be-both-a-normal-procedure-and-an-unchecked-procedure-procedure_name">CQL0404:
procedure cannot be both a normal procedure and an unchecked procedure,
‘procedure_name’</h3>
<p>The construct:</p>
<div class="sourceCode" id="cb594"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb594-1"><a href="#cb594-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> printf <span class="kw">NO</span> <span class="kw">CHECK</span>;</span></code></pre></div>
<p>Is used to tell CQL about an external procedure that might take any
combination of arguments. The canonical example is <code>printf</code>.
All the arguments are converted from CQL types to basic C types when
making the call (e.g. TEXT variables become temporary C strings). Once a
procedure has been declared in this way it can’t then also be declared
as a normal CQL procedure via <code>CREATE</code> or
<code>DECLARE PROCEDURE</code>. Likewise a normal procedure can’t be
redeclared with the <code>NO CHECK</code> pattern.</p>
<hr />
<h3
id="cql0405-procedure-of-an-unknown-type-used-in-an-expression-procedure_name">CQL0405:
procedure of an unknown type used in an expression ‘procedure_name’</h3>
<p>If a procedure has no known type—that is, it was originally declared
with <code>NO CHECK</code>, and has not been subsequently re-declared
with <code>DECLARE FUNCTION</code> or
<code>DECLARE SELECT FUNCTION</code>—it is not possible to use it in an
expression. You must either declare the type before using it or call the
procedure outside of an expression via a <code>CALL</code>
statement:</p>
<div class="sourceCode" id="cb595"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb595-1"><a href="#cb595-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">PROCEDURE</span> some_external_proc <span class="kw">NO</span> <span class="kw">CHECK</span>;</span>
<span id="cb595-2"><a href="#cb595-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb595-3"><a href="#cb595-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- This works even though `some_external_proc` has no known type</span></span>
<span id="cb595-4"><a href="#cb595-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- because we&#39;re using a CALL statement.</span></span>
<span id="cb595-5"><a href="#cb595-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> some_external_proc(<span class="ot">&quot;Hello!&quot;</span>);</span>
<span id="cb595-6"><a href="#cb595-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb595-7"><a href="#cb595-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">FUNCTION</span> some_external_proc(t TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>) <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb595-8"><a href="#cb595-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb595-9"><a href="#cb595-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Now that we&#39;ve declared the type, we can use it in an expression.</span></span>
<span id="cb595-10"><a href="#cb595-10" aria-hidden="true" tabindex="-1"></a>let result <span class="op">:=</span> some_external_proc(<span class="ot">&quot;Hello!&quot;</span>);</span></code></pre></div>
<hr />
<h3
id="cql0406-substr-uses-1-based-indices-the-2nd-argument-of-substr-may-not-be-zero">CQL0406:
substr uses 1 based indices, the 2nd argument of substr may not be
zero”</h3>
<p>A common mistake with substr is to assume it uses zero based indices
like C does. It does not. In fact the result when using 0 as the second
argument is not well defined. If you want the first <code>n</code>
characters of a string you use <code>substr(haystack, 1, n)</code>.</p>
<hr />
<p>CQL 0407 Unused, this was added to prevent merge conflicts at the end
on literally every checkin</p>
<hr />
<h3
id="cql0408-encode-context-column-can-be-only-specified-once">CQL0408:
encode context column can be only specified once</h3>
<p>The encode context column can be only specified once in <span
class="citation" data-cites="vault_sensitive">@vault_sensitive</span>
attribute</p>
<hr />
<h3
id="cql0409-cannot-use-is-null-or-is-not-null-on-a-value-of-a-not-null-type-nonnull_expr">CQL0409:
cannot use IS NULL or IS NOT NULL on a value of a NOT NULL type
‘nonnull_expr’</h3>
<p>If the left side of an <code>IS NULL</code> or
<code>IS NOT NULL</code> expression is of a <code>NOT NULL</code> type,
the answer will always be the same (<code>FALSE</code> or
<code>TRUE</code>, respectively). Such a check often indicates confusion
that may lead to unexpected behavior (e.g., checking, incorrectly, if a
cursor has a row via <code>cursor IS NOT NULL</code>).</p>
<p><strong>NOTE</strong>: Cursor fields of cursors without a row and
uninitialized variables of a NOT NULL reference type are exceptions to
the above rule: Something may be NULL even if it is of a NOT NULL type
in those cases. CQL will eventually eliminate these exceptions. In the
cursor case, one can check whether or not a cursor has a row by using
the cursor-as-boolean-expression syntax (e.g.,
<code>IF cursor THEN ... END IF;</code>,
<code>IF NOT cursor ROLLBACK RETURN;</code>, et cetera). In the
uninitialized variables case, writing code that checks for
initialization is not recommended (and, indeed, use before
initialization will soon be impossible anyway): One should simply always
initialize the variable.</p>
<hr />
<p>CQL 0410 Unused, this was added to prevent merge conflicts at the end
on literally every checkin</p>
<hr />
<h3 id="cql0411-duplicate-flag-in-substitution-flag">CQL0411: duplicate
flag in substitution ‘flag’</h3>
<p>The same flag cannot be used more than once per substitution within a
format string.</p>
<hr />
<h3 id="cql0412-cannot-combine-flag-with-space-flag">CQL0412: cannot
combine ‘+’ flag with space flag</h3>
<p>It is not sensible to use both the <code>+</code> flag and the space
flag within the same substitution (e.g., <code>%+ d</code>) as it is
equivalent to just using the <code>+</code> flag (e.g.,
<code>%+d</code>).</p>
<hr />
<h3
id="cql0413-width-required-when-using-flag-in-substitution-flag">CQL0413:
width required when using flag in substitution ‘flag’</h3>
<p>The flag used (<code>-</code> or <code>0</code>) for a substitution
within a format string does not make sense unless accompanied by a width
(e.g., <code>%-10d</code>).</p>
<hr />
<h3
id="cql0414-l-length-specifier-has-no-effect-consider-ll-instead">CQL0414:
‘l’ length specifier has no effect; consider ‘ll’ instead</h3>
<p>The use of the <code>l</code> length specifier within a format
string, e.g. <code>%ld</code>, has no effect in SQLite. If the argument
is to be a <code>LONG</code>, use <code>ll</code> instead (e.g.,
<code>%lld</code>). If the argument is to be an <code>INTEGER</code>,
simply omit the length specifier entirely (e.g., <code>%d</code>).</p>
<hr />
<h3 id="cql0415-length-specifier-cannot-be-combined-with-flag">CQL0415:
length specifier cannot be combined with ‘!’ flag</h3>
<p>Length specifiers are only for use with integer type specifiers
(e.g. <code>%lld</code>) and the <code>!</code> flag is only for use
with non-integer type specifiers (e.g. <code>%!10s</code> and
<code>%!f</code>). It therefore makes no sense to use both within the
same substitution.</p>
<hr />
<h3
id="cql0416-type-specifier-not-allowed-in-cql-type_specifier">CQL0416:
type specifier not allowed in CQL ‘type_specifier’</h3>
<p>The type specifier used is accepted by SQLite, but it would be either
useless or unsafe if used within the context of CQL.</p>
<hr />
<h3 id="cql0417-unrecognized-type-specifier-type_specifier">CQL0417:
unrecognized type specifier ‘type_specifier’</h3>
<p>The type specifier used within the format string is not known to
SQLite.</p>
<hr />
<h3
id="cql0418-type-specifier-combined-with-inappropriate-flags-type_specifier">CQL0418:
type specifier combined with inappropriate flags ‘type_specifier’</h3>
<p>The type specifier provided does not make sense given one or more
flags that appear within the same substitution. For example, it makes no
sense to have a substitution like <code>%+u</code>: the <code>+</code>
indicates the sign of the number will be shown, while the <code>u</code>
indicates the number will be shown as an unsigned integer.</p>
<hr />
<h3
id="cql0419-type-specifier-cannot-be-combined-with-length-specifier-type_specifier">CQL0419:
type specifier cannot be combined with length specifier
‘type_specifier’</h3>
<p>The type specifier provided cannot be used with a length specifier.
For example, <code>%lls</code> makes no sense because <code>ll</code>
only makes sense with integer types and <code>s</code> is a type
specifier for strings.</p>
<hr />
<h3 id="cql0420-incomplete-substitution-in-format-string">CQL0420:
incomplete substitution in format string</h3>
<p>The format string ends with a substitution that is incomplete. This
can be the case if a format string ends with a <code>%</code> (e.g.,
<code>"%d %s %"</code>). If the intent is to have a literal
<code>%</code> printed, use <code>%%</code> instead (e.g., “%d %s
%%”`).</p>
<hr />
<h3
id="cql0421-first-argument-must-be-a-string-literal-function">CQL0421:
first argument must be a string literal ‘function’</h3>
<p>The first argument to the function must be a string literal.</p>
<hr />
<h3
id="cql0422-more-arguments-provided-than-expected-by-format-string-function">CQL0422:
more arguments provided than expected by format string ‘function’</h3>
<p>More arguments were provided to the function than its format string
indicates are necessary. The most likely cause for this problem is that
the format string is missing a substitution.</p>
<hr />
<h3
id="cql0423-fewer-arguments-provided-than-expected-by-format-string-function">CQL0423:
fewer arguments provided than expected by format string ‘function’</h3>
<p>Fewer arguments were provided to the function than its format string
indicates are necessary. The most likely cause for this problem is that
an argument was accidentally omitted.</p>
<hr />
<h3
id="cql0424-procedure-with-inout-parameter-used-as-function-procedure_name">CQL0424:
procedure with INOUT parameter used as function ‘procedure_name’</h3>
<p>If a procedure has an <code>INOUT</code> parameter, it cannot be used
as a function: It may only be called via a <code>CALL</code>
statement.</p>
<hr />
<h3
id="cql0425-procedure-with-non-trailing-out-parameter-used-as-function-procedure_name">CQL0425:
procedure with non-trailing OUT parameter used as function
‘procedure_name’</h3>
<p>For a procedure to be used as a function, it must have exactly one
<code>OUT</code> parameter, and that parameter must be the last
parameter of the procedure. In all other cases, procedures with one or
more <code>OUT</code> parameters may only be called via a
<code>CALL</code> statement.</p>
<hr />
<h3
id="cql0426-out-or-inout-argument-cannot-be-used-again-in-same-call-variable">CQL0426:
OUT or INOUT argument cannot be used again in same call ‘variable’</h3>
<p>When a variable is passed as an <code>OUT</code> or
<code>INOUT</code> argument, it may not be used as another argument
within the same procedure call. It can, however, be used within a
<em>subexpression</em> of another argument. For example:</p>
<div class="sourceCode" id="cb596"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb596-1"><a href="#cb596-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> PROC some_proc(<span class="kw">IN</span> a TEXT, <span class="kw">OUT</span> b TEXT)</span>
<span id="cb596-2"><a href="#cb596-2" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb596-3"><a href="#cb596-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.</span>
<span id="cb596-4"><a href="#cb596-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb596-5"><a href="#cb596-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-6"><a href="#cb596-6" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> t TEXT;</span>
<span id="cb596-7"><a href="#cb596-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-8"><a href="#cb596-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- This is NOT legal.</span></span>
<span id="cb596-9"><a href="#cb596-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> some_proc(t, t);</span>
<span id="cb596-10"><a href="#cb596-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-11"><a href="#cb596-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- This, however, is perfectly fine.</span></span>
<span id="cb596-12"><a href="#cb596-12" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> some_proc(some_other_proc(t), t);</span></code></pre></div>
<hr />
<h3
id="cql0427-like-cte-form-may-only-be-used-inside-a-shared-fragment-at-the-top-level-i.e.-attributecqlshared_fragment-procedure_name">CQL0427:
LIKE CTE form may only be used inside a shared fragment at the top level
i.e. <span class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment)
‘procedure_name’</h3>
<p>When creating a shared fragment you can specify “table parameters” by
defining their shape like so:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc shared_proc(lim_ integer)
begin
   with source(*) LIKE any_shape
   select * from source limit lim_;
end;</code></pre>
<p>However this LIKE form only makes sense withing a shared fragment,
and only as a top level CTE in such a fragment. So either:</p>
<ul>
<li>the LIKE appeared outside of any procedure</li>
<li>the LIKE appeared in a procedure, but that procedure is not a shared
fragment</li>
<li>the LIKE appeared in a nested WITH clause</li>
</ul>
<hr />
<h3
id="cql0428-duplicate-binding-of-table-in-callusing-clause-table_name">CQL0428:
duplicate binding of table in CALL/USING clause ‘table_name’</h3>
<p>In a CALL clause to access a shared fragment there is a duplicate
table name in the USING portion.</p>
<p>Example:</p>
<pre><code>my_cte(*) AS (call my_fragment(1) USING something as param1, something_else as param1),</code></pre>
<p>Here <code>param1</code> is supposed to take on the value of both
<code>something</code> and <code>something_else</code>. Each parameter
may appear only once in the <code>USING</code> clause.</p>
<h3
id="cql0429-called-procedure-has-no-table-arguments-but-a-using-clause-is-present-procedure_name">CQL0429:
called procedure has no table arguments but a USING clause is present
‘procedure_name’</h3>
<p>In a CALL clause to access a shared fragment there are table bindings
but the shared fragment that is being called does not have any table
bindings.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 select * from a_location limit lim;
end;

-- here we try to use my_fragment with table parameter but it has none
with
  my_cte(*) AS (call my_fragment(1) USING something as param)
  select * from my_cte;</code></pre>
<hr />
<h3
id="cql0430-no-actual-table-was-provided-for-the-table-parameter-table_name">CQL0430:
no actual table was provided for the table parameter ‘table_name’</h3>
<p>In a CALL clause to access a shared fragment the table bindings are
missing a table parameter.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 with source LIKE source_shape
 select * from source limit lim;
end;

-- here we try to use my_fragment but no table was specified to play the role of &quot;source&quot;
with
  my_cte(*) AS (call my_fragment(1))
  select * from my_cte;</code></pre>
<hr />
<h3
id="cql0431-an-actual-table-was-provided-for-a-table-parameter-that-does-not-exist-table_name">CQL0431:
an actual table was provided for a table parameter that does not exist
‘table_name’</h3>
<p>In a CALL clause to access a shared fragment the table bindings refer
to a table parameter that does not exist.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 with source LIKE source_shape
 select * from source limit lim;
end;

-- here we try to use my_fragment but there is a table name &quot;soruce&quot; that doesn&#39;t match source
with
  my_cte(*) AS (call my_fragment(1) USING something as soruce)
  select * from my_cte;</code></pre>
<hr />
<h3
id="cql0432-table-provided-must-have-the-same-number-of-columns-as-the-table-parameter-table_name">CQL0432:
table provided must have the same number of columns as the table
parameter ‘table_name’</h3>
<p>In a CALL clause to access a shared fragment the table bindings are
trying to use a table that has the wrong number of columns. The column
count, names, and types must be compatible. Extra columns for instance
are not allowed because they might create ambiguities that were not
present in the shared fragment.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 with source LIKE (select 1 x, 2 y)
 select * from source limit lim;
end;

-- here we try to use my_fragment but we provided 3 columns not 2
with
  my_source(*) AS (select 1 x, 2 y, 3 z),
  my_cte(*) AS (call my_fragment(1) USING my_source as source)
  select * from my_cte;</code></pre>
<p>Here <code>my_fragment</code> wants a <code>source</code> table with
2 columns (x, y). But 3 were provided.</p>
<hr />
<h3
id="cql0433-table-argument-formal_name-requires-column-column_name-but-it-is-missing-in-provided-table-actual_name">CQL0433:
table argument ‘formal_name’ requires column ‘column_name’ but it is
missing in provided table ‘actual_name’</h3>
<p>In a CALL clause to access a shared fragment the table bindings are
trying to use a table that is missing a required column.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 with source LIKE (select 1 x, 2 y)
 select * from source limit lim;
end;

-- here we try to use my_fragment but we passed in a table with (w,x) not (x,y)
with
  my_source(*) AS (select 1 w, 2 x),
  my_cte(*) AS (call my_fragment(1) USING my_source as source)
  select * from my_cte;</code></pre>
<hr />
<h3
id="cql0434-shared-fragments-may-not-be-called-outside-of-a-sql-statement-procedure_name">CQL0434:
shared fragments may not be called outside of a SQL statement
‘procedure_name’</h3>
<p>The indicated name is the name of a shared fragment, these fragments
may be used inside of SQL code (e.g. select statements) but they have no
meaning in a normal call outside of a SQL statement.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
 select * from somewhere limit lim;
end;

call my_fragment();</code></pre>
<p>Here <code>my_fragment</code> is being used like a normal procedure.
This is not valid. A correct use of a fragment might look something like
this:</p>
<pre><code>with
  (call my_fragment())
  select * from my_fragment;</code></pre>
<hr />
<h3
id="cql0435-must-use-qualified-form-to-avoid-ambiguity-with-alias-column">CQL0435:
must use qualified form to avoid ambiguity with alias ‘column’</h3>
<p>In a SQLite <code>SELECT</code> expression, <code>WHERE</code>,
<code>GROUP BY</code>, <code>HAVING</code>, and <code>WINDOW</code>
clauses see the columns of the <code>FROM</code> clause before they see
any aliases in the expression list. For example, assuming some table
<code>t</code> has columns <code>x</code> and <code>y</code>, the
following two expressions are equivalent:</p>
<pre><code>SELECT x AS y FROM t WHERE y &gt; 100
SELECT x AS y FROM t WHERE t.y &gt; 100</code></pre>
<p>In the first expression, the use of <code>y &gt; 100</code> makes it
seem as though the <code>y</code> referred to could be the
<code>y</code> resulting from <code>x as y</code> in the expression
list, but that is not the case. To avoid such confusion, CQL requires
the use of the qualified form <code>t.y &gt; 100</code> instead.</p>
<hr />
<h3
id="cql0436-alias-referenced-from-where-group-by-having-or-window-clause">CQL0436:
alias referenced from WHERE, GROUP BY, HAVING, or WINDOW clause</h3>
<p>Unlike many databases (e.g., PostgreSQL and SQL Server), SQLite
allows the aliases of a <code>SELECT</code> expression list to be
referenced from clauses that are evaluated <em>before</em> the
expression list. It does this by replacing all such alias references
with the expressions to which they are equivalent. For example, assuming
<code>t</code> does <em>not</em> have a column <code>x</code>, the
following two expressions are equivalent:</p>
<pre><code>SELECT a + b AS x FROM t WHERE x &gt; 100
SELECT a + b AS x FROM t WHERE a + b &gt; 100</code></pre>
<p>This can be convenient, but it is also error-prone. As mentioned
above, the above equivalency only holds if <code>x</code> is
<em>not</em> a column in <code>t</code>: If <code>x</code> <em>is</em> a
column in <code>t</code>, the <code>WHERE</code> clause would be
equivalent to <code>t.x &gt; 100</code> instead, and there would be no
syntactically obvious way to know this without first manually
determining all of the columns present in <code>t</code>.</p>
<p>To avoid such confusion, CQL disallows referencing expression list
aliases from <code>WHERE</code>, <code>GROUP BY</code>,
<code>HAVING</code>, and <code>WINDOW</code> clauses altogether.
Instead, one should simply use the expression to which the alias is
equivalent (as is done in the second example above).</p>
<hr />
<h3
id="cql0437-common-table-name-shadows-previously-declared-table-or-view-name">CQL0437:
common table name shadows previously declared table or view ‘name’</h3>
<p>The name of a common table expression may not shadow a previously
declared table or view. To rectify the problem, simply use a different
name.</p>
<hr />
<h3
id="cql0438-variable-possibly-used-before-initialization-name">CQL0438:
variable possibly used before initialization ‘name’</h3>
<p>The variable indicated must be initialized before it is used because
it is of a reference type (<code>BLOB</code>, <code>OBJECT</code>, or
<code>TEXT</code>) that is also <code>NOT NULL</code>.</p>
<p>CQL is usually smart enough to issue this error only in cases where
initialization is truly lacking. Be sure to verify that the variable
will be initialized before it is used for all possible code paths.</p>
<hr />
<h3
id="cql0439-nonnull-reference-out-parameter-possibly-not-always-initialized-name">CQL0439:
nonnull reference OUT parameter possibly not always initialized
‘name’</h3>
<p>The parameter indicated must be initialized before the procedure
returns because it is of a reference type (<code>BLOB</code>,
<code>OBJECT</code>, or <code>TEXT</code>) that is also
<code>NOT NULL</code>.</p>
<p>CQL is usually smart enough to issue this error only in cases where
initialization is truly lacking. Be sure to verify that the parameter
will be initialized both before the end of the procedure and before all
cases of <code>RETURN</code> and <code>ROLLBACK RETURN</code>.
(Initialization before <code>THROW</code> is not required.)</p>
<hr />
<h3
id="cql0440-fragments-may-not-have-an-empty-body-procedure_name">CQL0440:
fragments may not have an empty body ‘procedure_name’</h3>
<p>The indicated procedure is one of the fragment types but has an empty
body. This is not valid for any fragment type.</p>
<p>Example:</p>
<pre><code>@attribute(cql:shared_fragment)
create proc my_fragment(lim integer not null)
begin
  /* something has to go here */
end;</code></pre>
<hr />
<h3
id="cql0441-shared-fragments-may-only-have-if-select-or-withselect-at-the-top-level-procedure_name">CQL0441:
shared fragments may only have IF, SELECT, or WITH…SELECT at the top
level ‘procedure_name’</h3>
<p>A shared fragment may consist of just one SELECT statement (including
WITH…SELECT) or it can be an IF/ELSE statement that has a series of
compatible select statements. There are no other valid options.</p>
<hr />
<h3
id="cql0442-shared-fragments-with-conditionals-must-include-an-else-clause-procedure_name">CQL0442:
shared fragments with conditionals must include an else clause
‘procedure_name’</h3>
<p>In shared fragment with conditionals (i.e. it has an IF statement at
the top) the fragment must have an ELSE block so that it is guaranteed
to create chunk of SQL text in its expansion. When no rows are required
you can do so with something like:</p>
<pre><code>IF ... THEN
  ...
ELSE
   select 1 x, &#39;2&#39; y WHERE 0;
END IF;</code></pre>
<p>If the <code>ELSE</code> condition indicates that some join should
not happen you might generate default values or NULLs for the join
result like so:</p>
<pre><code>IF ... THEN
  ...
ELSE
  select input_stuff.*, NULL x, -1 y;
END IF;</code></pre>
<hr />
<h3
id="cql0443-shared-fragments-with-conditionals-must-have-exactly-one-select-or-withselect-in-each-statement-list-procedure_name">CQL0443:
shared fragments with conditionals must have exactly one SELECT or
WITH…SELECT in each statement list ‘procedure_name’</h3>
<p>In a shared fragment with conditionals the top level statement is an
“IF”. All of the statement lists in the IF must have exactly one valid
select statement. This error indicates that a statement list has the
wrong number or type of statement.</p>
<hr />
<h3
id="cql0444-this-use-of-the-named-shared-fragment-is-not-legal-because-of-name-conflict-procedure_name">CQL0444:
this use of the named shared fragment is not legal because of name
conflict ‘procedure_name’</h3>
<p>This error will be followed by additional diagnostic information
about the call chain that is problematic. For instance:</p>
<pre><code>Procedure innermost has a different CTE that is also named foo
The above originated from CALL inner USING foo AS source
The above originated from CALL middle USING foo AS source
The above originated from CALL outer USING foo AS source</code></pre>
<p>This indicates that you are trying to call <code>outer</code> which
in turn calls <code>middle</code> which in turn called
<code>inner</code>. The conflict happened when the <code>foo</code>
parameter was passed in to <code>inner</code> because it already has a
CTE named <code>foo</code> that means something else.</p>
<p>The way to fix this problem is to rename the CTE in probably the
outermost call as that is likely the one you control. Renaming it in the
innermost procedure might also be wise if that procedure is using a
common name likely to conflict.</p>
<p>It is wise to name the CTEs in shared fragments such that they are
unlikely to eclipse outer CTEs that will be needed as table
parameters.</p>
<hr />
<h3 id="cql0445-attributecqltry_is_proc_body-accepts-no-values">CQL0445:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:try_is_proc_body) accepts
no values</h3>
<p>The attribute <code>cql:try_is_proc_body</code> cannot be used with
any values (e.g., <code>cql:try_is_proc_body=(...)</code>).</p>
<hr />
<h3
id="cql0446-attributecqltry_is_proc_body-cannot-be-used-more-than-once-per-procedure">CQL0446:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:try_is_proc_body) cannot be
used more than once per procedure</h3>
<p>The purpose of <code>cql:try_is_proc_body</code> is to indicate that
a particular <code>TRY</code> block contains what should be considered
to be the true body of the procedure. As it makes no sense for a
procedure to have multiple bodies, <code>cql:try_is_proc_body</code>
must appear only once within any given procedure.</p>
<hr />
<h3
id="cql0447-virtual-table-table-claims-to-be-eponymous-but-its-module-name-module-differs-from-its-table-name">CQL0447:
virtual table ‘table’ claims to be eponymous but its module name
‘module’ differs from its table name</h3>
<p>By definition, an eponymous virtual table has the same name as its
module. If you use the <span class="citation"
data-cites="eponymous">@eponymous</span> notation on a virtual table,
you must also make the module and table name match.</p>
<hr />
<h3
id="cql0448-table-was-marked-delete-but-it-needs-to-be-marked-recreate-delete-table">CQL0448:
table was marked <span class="citation"
data-cites="delete">@delete</span> but it needs to be marked <span
class="citation" data-cites="recreate">@recreate</span> <span
class="citation" data-cites="delete">@delete</span> ‘table’</h3>
<p>The indicated table was on the recreate plan and was then deleted by
adding an <code>@delete(version)</code> attribute.</p>
<p>However, the previous <code>@recreate</code> annotation was removed.
This would make the table look like it was a baseline table that had
been deleted, and it isn’t. To correctly drop a table on the
<code>@recreate</code> you leave the recreate directive as it was and
simply add <code>@delete</code>. No version information is required
because the table is on the recreate plan anyway.</p>
<p>Example:</p>
<pre><code>create table dropping_this
(
  f1 integer,
  f2 text
) @recreate(optional_group) @delete;</code></pre>
<p>This error indicates that the <code>@recreate(optional_group)</code>
annotation was removed. You should put it back.</p>
<hr />
<h3
id="cql0449-unsubscribe-does-not-make-sense-on-non-physical-tables-table_name">CQL0449:
unsubscribe does not make sense on non-physical tables ‘table_name’</h3>
<p>The indicated table was marked for blob storage or is a backed table.
In both cases there is no physical schema associated with it so
unsubscribe does not make any sense there. If it’s a backed table
perhaps the intent was to remove the backing table?</p>
<h3
id="cql0450-a-shared-fragment-used-like-a-function-must-be-a-simple-select-with-no-from-clause">CQL0450:
a shared fragment used like a function must be a simple SELECT with no
FROM clause</h3>
<p>When using a shared fragment like an expression, the shared fragment
must consist of a simple SELECT without a FROM clause. That SELECT,
however, may contain a nested SELECT expression which, itself, may have
a FROM clause.</p>
<p>Additional constraints:</p>
<ul>
<li>the target of the call is a shared fragment
<ul>
<li>the target therefore a single select statement</li>
<li>the target therefore has no out-arguments</li>
</ul></li>
<li>the target has no select clauses other than the select list, e.g. no
FROM, WHERE, LIMIT etc.</li>
<li>the target returns exactly one column, i.e. it’s just one SQL
expression</li>
</ul>
<hr />
<h3
id="cql0451-procedure-as-function-call-is-not-compatible-with-distinct-or-filter-clauses">CQL0451:
procedure as function call is not compatible with DISTINCT or filter
clauses</h3>
<p>Certain built-in functions like <code>COUNT</code> can be used with
<code>DISTINCT</code> or <code>FILTER</code> options like so:</p>
<pre><code>select count(distinct ...);

select sum(...) filter(where ...) over (...)</code></pre>
<p>These options are not valid when calling a procedure as a function
and so they generate errors if used.</p>
<hr />
<h3
id="cql0452-function-may-not-be-used-in-sql-because-it-is-not-supported-on-old-versions-of-sqlite-function">CQL0452:
function may not be used in SQL because it is not supported on old
versions of SQLite ‘function’</h3>
<p>Due to an enabled enforcement (e.g.,
<code>@enforce_strict sign function;</code>), the indicated function may
not be used within SQL because it is not supported on old versions of
SQLite.</p>
<hr />
<h3 id="cql0453-blob-type-is-not-a-valid-table-table_name">CQL0453: blob
type is not a valid table ‘table_name’</h3>
<p>The CQL forms <code>SET [blob] FROM CURSOR [cursor]</code> and
<code>FETCH [cursor] FROM [blob]</code> require that the blob variable
be declared with a type kind and the type of the blob matches a suitable
table.</p>
<p>In this case the blob was declared like so:</p>
<pre><code>DECLARE blob_var blob&lt;table_name&gt;</code></pre>
<p>But the named table <code>table_name</code> is not a table.</p>
<hr />
<h3
id="cql0454-cursor-was-not-declared-for-storage-cursor_name">CQL0454:
cursor was not declared for storage ‘cursor_name’</h3>
<p>The CQL forms <code>SET [blob] FROM CURSOR [cursor]</code> and
<code>FETCH [cursor] FROM [blob]</code> require that the cursor variable
have storage associated with it. This means it must be a value cursor or
else a cursor that was fetched using the <code>fetch C</code> form and
not the <code>fetch C into [variables]</code> form.</p>
<p>The indicated cursor was either not fetched at all, or else is using
only the <code>fetch into</code> form so it does not have storage that
could be used to create a blob.</p>
<hr />
<h3
id="cql0455-blob-variable-must-have-a-type-kind-for-type-safety-blob_name">CQL0455:
blob variable must have a type kind for type safety, ‘blob_name’</h3>
<p>The CQL forms <code>SET [blob] FROM CURSOR [cursor]</code> and
<code>FETCH [cursor] FROM [blob]</code> require that the blob variable
be declared with a type kind and the type of the blob matches a suitable
table.</p>
<p>In this case the blob was declared like so:</p>
<pre><code>DECLARE blob_name blob;</code></pre>
<p>But it must be:</p>
<pre><code>DECLARE blob_name blob&lt;table_name&gt;;</code></pre>
<p>Where <code>table_name</code> is a suitable table.</p>
<hr />
<h3 id="cql0456-blob-type-is-a-view-not-a-table-view_name">CQL0456: blob
type is a view, not a table ‘view_name’</h3>
<p>The CQL forms <code>SET [blob] FROM CURSOR [cursor]</code> and
<code>FETCH [cursor] FROM [blob]</code> require that the blob variable
be declared with a type kind and the type of the blob matches a suitable
table.</p>
<p>In this case the blob was declared like:</p>
<pre><code>DECLARE blob_var blob&lt;view_name&gt;</code></pre>
<p>Where the named type <code>view_name</code> is a view, not a
table.</p>
<hr />
<h3
id="cql0457-the-indicated-table-is-not-marked-with-attributecqlblob_storage-table_name">CQL0457:
the indicated table is not marked with <span class="citation"
data-cites="attribute">@attribute</span>(cql:blob_storage)
‘table_name’</h3>
<p>The CQL forms <code>SET [blob] FROM CURSOR [cursor]</code> and
<code>FETCH [cursor] FROM [blob]</code> require that the blob variable
be declared with a type kind and the type of the blob matches a suitable
table.</p>
<p>In this case the blob was declared like:</p>
<pre><code>DECLARE blob_var blob&lt;table_name&gt;</code></pre>
<p>but the indicated table is missing the necessary attribute
<code>@attribute(cql:blob_storage)</code>.</p>
<p>This attribute is necessary so that CQL can enforce additional rules
on the table to ensure that it is viable for blob storage. For instance,
the table can have no primary key, no foreign keys, and may not be used
in normal SQL statements.</p>
<hr />
<h3
id="cql0458-the-indicated-table-may-only-be-used-for-blob-storage-table_name">CQL0458:
the indicated table may only be used for blob storage ‘table_name’</h3>
<p>The indicated table has been marked with
<code>@attribute(cql:blob_storage)</code>. This means that it isn’t a
real table – it will have no SQL schema. Since it’s only a storage
shape, it cannot be used in normal operations that use tables such as
<code>DROP TABLE</code>, <code>CREATE INDEX</code>, or inside of
<code>SELECT</code> statements.</p>
<p>The <code>CREATE TABLE</code> construct is used to declare a blob
storage type because it’s the natural way to define a structure in SQL
and also because the usual versioning rules are helpful for such tables.
But otherwise, blob storage isn’t really a table at all.</p>
<hr />
<h3
id="cql0459-table-is-not-suitable-for-use-as-blob-storage-reason-table_name">CQL0459:
table is not suitable for use as blob storage: [reason]
‘table_name’</h3>
<p>The indicated table was marked with
<code>@attribute(cql:blob_storage)</code>. This indicates that the table
is going to be used to define the shape of blobs that could be stored in
the database. It isn’t going to be a “real” table.</p>
<p>There are a number of reasons why a table might not be a valid as
blob storage.</p>
<p>For instance:</p>
<ul>
<li>it has a primary key</li>
<li>it has foreign keys</li>
<li>it has constraints</li>
<li>it is a virtual table</li>
</ul>
<p>This error indicates that one of these items is present. The specific
cause is included in the text of the message.</p>
<hr />
<h3
id="cql0460-field-of-a-nonnull-reference-type-accessed-before-verifying-that-the-cursor-has-a-row-cursor.field">CQL0460:
field of a nonnull reference type accessed before verifying that the
cursor has a row ‘cursor.field’</h3>
<p>If a cursor has a field of a nonnull reference type (e.g.,
<code>TEXT NOT NULL</code>), it is necessary to verify that the cursor
has a row before accessing the field (unless the cursor has been fetched
in such a way that it <em>must</em> have a row, e.g., via
<code>FETCH ... FROM VALUES</code> or <code>LOOP FETCH</code>). The
reason for this is that, should the cursor <em>not</em> have a row, the
field will be <code>NULL</code> despite the nonnull type.</p>
<p>Assume we have the following:</p>
<div class="sourceCode" id="cb619"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb619-1"><a href="#cb619-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> t (x text <span class="kw">not</span> <span class="kw">null</span>);</span>
<span id="cb619-2"><a href="#cb619-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc requires_text_notnull(x text <span class="kw">not</span> <span class="kw">null</span>);</span></code></pre></div>
<p>The following code is <strong>illegal</strong>:</p>
<div class="sourceCode" id="cb620"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb620-1"><a href="#cb620-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t;</span>
<span id="cb620-2"><a href="#cb620-2" aria-hidden="true" tabindex="-1"></a>fetch c;</span>
<span id="cb620-3"><a href="#cb620-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- ILLEGAL because `c` may not have a row and thus</span></span>
<span id="cb620-4"><a href="#cb620-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- `c.x` may be `NULL`</span></span>
<span id="cb620-5"><a href="#cb620-5" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> requires_text_notnull(c.x);</span></code></pre></div>
<p>To fix it, the cursor must be verified to have a row before the field
is accessed:</p>
<div class="sourceCode" id="cb621"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb621-1"><a href="#cb621-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t;</span>
<span id="cb621-2"><a href="#cb621-2" aria-hidden="true" tabindex="-1"></a>fetch c;</span>
<span id="cb621-3"><a href="#cb621-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> c <span class="cf">then</span></span>
<span id="cb621-4"><a href="#cb621-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- legal due to the above check</span></span>
<span id="cb621-5"><a href="#cb621-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> requires_text_notnull(c.x);</span>
<span id="cb621-6"><a href="#cb621-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span></code></pre></div>
<p>Alternatively, one can perform a “negative” check by returning (or
using another control flow statement) when the cursor does not have a
row:</p>
<div class="sourceCode" id="cb622"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb622-1"><a href="#cb622-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t;</span>
<span id="cb622-2"><a href="#cb622-2" aria-hidden="true" tabindex="-1"></a>fetch c;</span>
<span id="cb622-3"><a href="#cb622-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> c <span class="cf">then</span></span>
<span id="cb622-4"><a href="#cb622-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">call</span> some_logging_function(<span class="ot">&quot;no rows in t&quot;</span>);</span>
<span id="cb622-5"><a href="#cb622-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span>;</span>
<span id="cb622-6"><a href="#cb622-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb622-7"><a href="#cb622-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- legal as we would have returned if `c` did not</span></span>
<span id="cb622-8"><a href="#cb622-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- have a row</span></span>
<span id="cb622-9"><a href="#cb622-9" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> requires_text_notnull(c.x);</span></code></pre></div>
<p>If you are sure that a row <em>must</em> be present, you can throw to
make that explicit:</p>
<div class="sourceCode" id="cb623"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb623-1"><a href="#cb623-1" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> c <span class="kw">cursor</span> <span class="cf">for</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> t;</span>
<span id="cb623-2"><a href="#cb623-2" aria-hidden="true" tabindex="-1"></a>fetch c;</span>
<span id="cb623-3"><a href="#cb623-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> c throw;</span>
<span id="cb623-4"><a href="#cb623-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- legal as we would have thrown if `c` did not</span></span>
<span id="cb623-5"><a href="#cb623-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- have a row</span></span>
<span id="cb623-6"><a href="#cb623-6" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> requires_text_notnull(c.x);</span></code></pre></div>
<hr />
<h3 id="cql0461-fetch-from-blob-operand-is-not-a-blob">CQL0461: fetch
from blob operand is not a blob</h3>
<p>The blob operand in the form
<code>FETCH [cursor] FROM BLOB [blob]</code> must be a blob. The given
expression is of some other type.</p>
<hr />
<h3
id="cql0462-group-declared-variables-must-be-top-level-name">CQL0462:
group declared variables must be top level ‘name’</h3>
<p>A <code>DECLARE GROUP</code> statement for the named enum is
happening inside of a procedure. This is not legal.</p>
<p>To correct this, move the declaration outside of the procedure.</p>
<hr />
<h4
id="cql0463-variable-definitions-do-not-match-in-group-name">CQL0463:
variable definitions do not match in group ‘name’</h4>
<p>The two described <code>DECLARE GROUP</code> statements have the same
name but they are not identical.</p>
<p>The error output contains the full text of both declarations to
compare.</p>
<hr />
<h3 id="cql0464-group-not-found-group_name">CQL0464: group not found
‘group_name’</h3>
<p>The indicated name was used in a context where a variable group name
was expected but there is no such group.</p>
<p>Perhaps the group was not included (missing an #include) or else
there is a typo.</p>
<hr />
<h3 id="cql0465-avaiable-for-re-use">CQL0465 avaiable for re-use</h3>
<hr />
<h3
id="cql0466-the-tableview-named-in-an-unsub-directive-does-not-exist-name">CQL0466:
the table/view named in an <span class="citation"
data-cites="unsub">@unsub</span> directive does not exist ‘name’</h3>
<p>The indicated name is not a valid table or view.</p>
<hr />
<h3
id="cql0467-a-shared-fragment-used-like-a-function-cannot-nest-fragments-that-use-arguments">CQL0467:
a shared fragment used like a function cannot nest fragments that use
arguments</h3>
<p>When using a shared fragment like an expression, the shared fragment
may contain a nested select with a WITH statement that calls other
fragments, like this:</p>
<div class="sourceCode" id="cb624"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb624-1"><a href="#cb624-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:shared_fragment)</span></span>
<span id="cb624-2"><a href="#cb624-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc expression_frag()</span>
<span id="cb624-3"><a href="#cb624-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb624-4"><a href="#cb624-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> (</span>
<span id="cb624-5"><a href="#cb624-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">with</span></span>
<span id="cb624-6"><a href="#cb624-6" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">call</span> frag())</span>
<span id="cb624-7"><a href="#cb624-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> frag.col <span class="kw">from</span> frag</span>
<span id="cb624-8"><a href="#cb624-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb624-9"><a href="#cb624-9" aria-hidden="true" tabindex="-1"></a>  ) val</span>
<span id="cb624-10"><a href="#cb624-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>However the nested fragment(s) cannot take any arguments. The inner
fragment must be moved outside to allow the fragment be used like a sql
function.</p>
<hr />
<h3
id="cql0468-attributecqlshared_fragment-may-only-be-placed-on-a-create-proc-statement-proc_name">CQL0468:
<span class="citation"
data-cites="attribute">@attribute</span>(cql:shared_fragment) may only
be placed on a CREATE PROC statement ‘proc_name’</h3>
<p>In order to use a shared fragment the compiler must see the full body
of the fragment, this is because the fragment will be inlined into the
SQL in which it appears. As a consequence it makes no sense to try to
apply the attribute to a procedure declaration. Instead put the shared
fragment you want to use somewhere where it can be #included in
full.</p>
<p>example error:</p>
<div class="sourceCode" id="cb625"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb625-1"><a href="#cb625-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:shared_fragment)</span></span>
<span id="cb625-2"><a href="#cb625-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> proc x() (x <span class="dt">integer</span>);</span>
<span id="cb625-3"><a href="#cb625-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb625-4"><a href="#cb625-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc y()</span>
<span id="cb625-5"><a href="#cb625-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb625-6"><a href="#cb625-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">with</span> (<span class="kw">call</span> x())</span>
<span id="cb625-7"><a href="#cb625-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> x;</span>
<span id="cb625-8"><a href="#cb625-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>Instead, include the entire body like so (this example is ultra
simple).</p>
<div class="sourceCode" id="cb626"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb626-1"><a href="#cb626-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:shared_fragment)</span></span>
<span id="cb626-2"><a href="#cb626-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc x()</span>
<span id="cb626-3"><a href="#cb626-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb626-4"><a href="#cb626-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="dv">1</span> x; <span class="co">-- the procedure body must be present</span></span>
<span id="cb626-5"><a href="#cb626-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<hr />
<h3 id="cql0469-tableview-is-already-deleted-name">CQL0469: table/view
is already deleted ‘name’</h3>
<p>In an <span class="citation" data-cites="unsub">@unsub</span>
directive, the indicated table/view has already been deleted. It can no
longer be managed via subscriptions.</p>
<hr />
<h3 id="cql0470-available-for-re-use">CQL0470 available for re-use</h3>
<hr />
<h3 id="cql0471-available-for-re-use">CQL0471 available for re-use</h3>
<hr />
<h3 id="cql0472-tableview-is-already-unsubscribed-name">CQL0472:
table/view is already unsubscribed ‘name’</h3>
<p>In an <span class="citation" data-cites="unsub">@unsub</span>
directive, the indicated table/view has already been unsubscribed. It
doesn’t need another unsubscription.</p>
<hr />
<h3
id="cql0473-unsub-is-invalid-because-the-tableview-is-still-used-by-name">CQL0473:
<span class="citation" data-cites="unsub">@unsub</span> is invalid
because the table/view is still used by ‘name’</h3>
<p>This error indicates that you are attempting to <span
class="citation" data-cites="unsub">@unsub</span> a table/view while
there are still other tables/views that refer to it (e.g. by FK). You
must <span class="citation" data-cites="unsub">@unsub</span> all of
those as well in order to safely <span class="citation"
data-cites="unsub">@unsub</span> the present table/view. All such
dependencies will be listed. Note that some of those might, in turn,
have the same issue. In short, a whole subtree has to be removed in
order to do this operation safely.</p>
<hr />
<h3 id="cql0474-available-for-re-use">CQL0474 available for re-use</h3>
<hr />
<h3 id="cql0475-available-for-re-use">CQL0475 available for re-use</h3>
<hr />
<h3 id="cql0476-available-for-re-use">CQL0476 available for re-use</h3>
<hr />
<h3 id="cql0477-interface-name-conflicts-with-func-name-name">CQL0477:
interface name conflicts with func name ‘name’</h3>
<p>In a <code>DECLARE INTERFACE</code> statement, the given name
conflicts with an already declared function
(<code>DECLARE FUNCTION</code> or <code>DECLARE SELECT FUNCTION</code>).
You’ll have to choose a different name.</p>
<h3
id="cql0478-interface-name-conflicts-with-procedure-name-name">CQL0478:
interface name conflicts with procedure name ‘name’</h3>
<p>In a <code>DECLARE INTERFACE</code> statement, the indicated name
already corresponds to a created or declared stored procedure. You’ll
have to choose a different name.</p>
<h3 id="cql0479-interface-declarations-do-not-match-name">CQL0479:
interface declarations do not match ‘name’</h3>
<p>The interface was previously declared with a
<code>DECLARE INTERFACE</code> statement but when subsequent
<code>DECLARE INTERFACE</code> was encountered, it did not match the
previous declaration.</p>
<h3 id="cql0480-declared-interface-must-be-top-level-name">CQL0480:
declared interface must be top level ‘name’</h3>
<p>A <code>DECLARE INTERFACE</code> statement is happening inside of a
procedure. This is not legal. To correct this move the declaration
outside of the procedure.</p>
<h3 id="cql0481-proc-name-conflicts-with-interface-name-name">CQL0481:
proc name conflicts with interface name ‘name’</h3>
<p>In a <code>CREATE PROCEDURE</code> / <code>DECLARE PROCEDURE</code>
statement, the given name conflicts with an already declared interface
(<code>DECLARE INTERFACE</code>). You’ll have to choose a different
name.</p>
<h3 id="cql0482-interface-not-found-name">CQL0482: interface not found
‘name’</h3>
<p>Interface with the name provided in <code>cql:implements</code>
attribute does not exist</p>
<h3
id="cql0483-table-is-not-suitable-for-use-as-backing-storage-reason-table_name">CQL0483:
table is not suitable for use as backing storage: [reason]
‘table_name’</h3>
<p>The indicated table was marked with
<code>@attribute(cql:backing_table)</code>. This indicates that the
table is going to be used to as a generic storage location stored in the
database.</p>
<p>There are a number of reasons why a table might not be a valid as
backing storage.</p>
<p>For instance:</p>
<ul>
<li>it has foreign keys</li>
<li>it has constraints</li>
<li>it is a virtual table</li>
<li>it has schema versioning</li>
</ul>
<p>This error indicates that one of these items is present. The specific
cause is included in the text of the message.</p>
<h3 id="cql0484-procedure-s-is-missing-column-s-of-interface-s">CQL0484:
procedure ‘%s’ is missing column ‘%s’ of interface ‘%s’</h3>
<p>Procedure should return all columns defined by the interface (and
possibly others). The columns may be returned in any order.</p>
<h3
id="cql0485-column-types-returned-by-proc-need-to-be-the-same-as-defined-on-the-interface">CQL0485:
column types returned by proc need to be the same as defined on the
interface</h3>
<p>Procedure should return at least all columns defined by the interface
and column type should be the same.</p>
<h3
id="cql0486-function-cannot-be-both-a-normal-function-and-an-unchecked-function-function_name">CQL0486:
function cannot be both a normal function and an unchecked function,
‘function_name’</h3>
<p>The same function cannot be declared as a function with unchecked
parameters with the <code>NO CHECK</code> clause and then redeclared
with typed parameters, or vice versa.</p>
<div class="sourceCode" id="cb627"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb627-1"><a href="#cb627-1" aria-hidden="true" tabindex="-1"></a><span class="co">--- Declaration of an external function foo with unchecked parameters.</span></span>
<span id="cb627-2"><a href="#cb627-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">SELECT</span> <span class="kw">FUNCTION</span> foo <span class="kw">NO</span> <span class="kw">CHECK</span> t text;</span>
<span id="cb627-3"><a href="#cb627-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-4"><a href="#cb627-4" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb627-5"><a href="#cb627-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-6"><a href="#cb627-6" aria-hidden="true" tabindex="-1"></a><span class="co">--- A redeclaration of foo with typed paramters. This would be invalid if the previous declaration exists.</span></span>
<span id="cb627-7"><a href="#cb627-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> <span class="kw">SELECT</span> <span class="kw">FUNCTION</span> foo() t text;</span></code></pre></div>
<p>Make sure the redeclaration of the function is consistent with the
original declaration, or remove the redeclaration.</p>
<h3
id="cql0487-table-is-not-suitable-as-backed-storage-reason-table_name">CQL0487:
table is not suitable as backed storage: [reason] ‘table_name’</h3>
<p>The indicated table was marked with
<code>@attribute(cql:backing_table)</code>. This indicates that the
table is going to be used to as a generic storage location stored in the
database.</p>
<p>There are a number of reasons why a table might not be a valid as
backing storage.</p>
<p>For instance:</p>
<ul>
<li>it has foreign keys</li>
<li>it has constraints</li>
<li>it is a virtual table</li>
<li>it has schema versioning</li>
</ul>
<p>This error indicates that one of these items is present. The specific
cause is included in the text of the message.</p>
<h3
id="cql0488-the-indicated-table-is-not-declared-for-backed-storage-table_name">CQL0488:
the indicated table is not declared for backed storage ‘table_name’</h3>
<p>When declaring a backed table, you must specify the physical table
that will hold its data. The backed table is marked with
<code>@attribute(cql:backed_by=table_name)</code>. The backing table is
marked with <code>@attribute(cql:backing)</code>. The backing and
backed_by attributes applies extra checks to tables to ensure they are
suitable candidates.</p>
<p>This error indicates that the named table is not marked as a backed
table.</p>
<h3
id="cql0489-the-indicated-column-is-not-present-in-the-named-backed-storage-table_name.column_name">CQL0489:
the indicated column is not present in the named backed storage
‘table_name.column_name’</h3>
<p>The named table is a backed table, but it does not have the indicated
column.</p>
<h3
id="cql0490-argument-must-be-table.column-where-table-is-a-backed-table-function">CQL0490:
argument must be table.column where table is a backed table
’function”</h3>
<p>The database blob access functions <code>cql_blob_get</code>,
<code>cql_blob_create</code>, <code>cql_blob_update</code> all allow you
to specify the backed table name and column you are trying to
read/create/update. The named function was called with a table.column
combination where the table is not a backed table, hence the call is
invalid. Note that normally this error doesn’t happen because these
functions are typically called by CQL itself as part of the rewriting
process for backed tables. However it is possible to use them manually,
hence they are error checked.</p>
<h3
id="cql0491-argument-1-must-be-a-table-name-that-is-a-backed-table-cql_blob_create">CQL0491:
argument 1 must be a table name that is a backed table
‘cql_blob_create’</h3>
<p>When using the <code>cql_blob_create</code> helper function, the
first argument must be a valid backed table (i.e. one that was marked
with <code>@attribute(cql:backed_by=some_backing_table))</code>. The
type signature of this table is used to create a hash valid for the type
of the blob that is created. This error indicates that the first
argument is not even an identifier, much less a table name that is
backed. There are more specific errors if the table is not found or the
table is not backed. Note that normally this error doesn’t happen
because this functions is typically called by CQL itself as part of the
rewriting process for backed tables. However it is possible to
<code>cql_blob_create</code> manually, hence it is error checked.</p>
<h3 id="cql0492-available-for-use">CQL0492 available for use</h3>
<h3
id="cql0493-backed-storage-tables-may-not-be-used-in-indexestriggersdrop-table_name">CQL0493:
backed storage tables may not be used in indexes/triggers/drop
‘table_name’</h3>
<p>The indicated table name was marked as backed storage. Therefore it
does not have a physical manifestation, and therefore it cannot be used
in an index or in a trigger. You may be able to get the index or trigger
you want by creating an index on the backing storage and then using the
blob access functions to index a column or check colulmns in a trigger.
For instance this index is pretty normal:</p>
<pre><code>@attribute(cql:backing_table)
create table backing (
  k blob primary key,
  v blob not null
);

create index backing_type_index on backing(cql_blob_get_type(k));</code></pre>
<p>This gives you a useful index on the type field of the blob for all
backed tables that use <code>backing_table</code>.</p>
<p>But generally, physical operations like indices, triggers, and drop
are not applicable to backed tables.</p>
<h3
id="cql0494-mixing-adding-and-removing-columns-from-a-shape-name">CQL0494:
mixing adding and removing columns from a shape ‘name’</h3>
<p>When selecting columns from a shape you can use this form</p>
<pre><code>LIKE some_shape(name1, name2)</code></pre>
<p>to extract the named columns or this form</p>
<pre><code>LIKE some_shape(-name1, -name2)</code></pre>
<p>to extract everything but the named columns. You can’t mix the
positive and negative forms</p>
<h3
id="cql0495-no-columns-were-selected-in-the-like-expression">CQL0495: no
columns were selected in the LIKE expression</h3>
<p>An expression that is supposed to select some columns from a shape
such as</p>
<pre><code>LIKE some_shape(-name1, -name2)</code></pre>
<p>ended up removing all the columns from <code>some_shape</code>.</p>
<h3
id="cql0496-select-nothing-may-only-appear-in-the-else-clause-of-a-shared-fragment">CQL0496:
SELECT NOTHING may only appear in the else clause of a shared
fragment</h3>
<p>A common case for conditional shared fragments is that there are rows
that should be optionally included. The normal way this is handled is to
have a condition like this</p>
<div class="sourceCode" id="cb632"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb632-1"><a href="#cb632-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> something <span class="cf">THEN</span></span>
<span id="cb632-2"><a href="#cb632-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> your_data;</span>
<span id="cb632-3"><a href="#cb632-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb632-4"><a href="#cb632-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> dummy <span class="kw">data</span> <span class="kw">WHERE</span> <span class="dv">0</span>;</span>
<span id="cb632-5"><a href="#cb632-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<p>The problem here is that dummy_data could be complex and involve a
lot of typing to get nothing. To make this less tedious CQL allows:</p>
<div class="sourceCode" id="cb633"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb633-1"><a href="#cb633-1" aria-hidden="true" tabindex="-1"></a><span class="cf">IF</span> something <span class="cf">THEN</span></span>
<span id="cb633-2"><a href="#cb633-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> your_data;</span>
<span id="cb633-3"><a href="#cb633-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ELSE</span></span>
<span id="cb633-4"><a href="#cb633-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">NOTHING</span>;</span>
<span id="cb633-5"><a href="#cb633-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="cf">IF</span>;</span></code></pre></div>
<p>However this is the only place SELECT NOTHING is allowed. It must be:
* in a procedure * which is a conditional shared fragment * in the else
clause</p>
<p>Any violation results in the present error.</p>
<h3
id="cql0497-from-clause-not-supported-when-updating-backed-table-table_name">CQL0497:
FROM clause not supported when updating backed table, ‘table_name’</h3>
<p>SQLite supports an extended format of the update statement with a
FROM clause. At this time backed tables cannot be updated using this
form. This is likely to change fairly soon.</p>
<h3
id="cql0498-strict-update-from-validation-requires-that-the-update-statement-not-include-a-from-clause">CQL0498:
strict UPDATE … FROM validation requires that the UPDATE statement not
include a FROM clause</h3>
<p><code>@enforce_strict</code> has been use to enable strict update
enforcement. When enabled update statements may not include a FROM
clause. This is done if the code expects to target SQLite version 3.33
or lower.</p>
<h3
id="cql0499-alias_of-attribute-may-only-be-added-to-a-declare-function-statement">CQL0499:
alias_of attribute may only be added to a declare function
statement</h3>
<p><code>cql:alias_of</code> attributes may only be used in <a
href="#ordinary-scalar-functions"><code>DECLARE FUNC</code>
statements</a> or <a
href="#declaring-procedures-defined-elsewhere"><code>DECLARE PROC</code>
statements</a>.</p>
<h3
id="cql0500-alias_of-attribute-must-be-a-non-empty-string-argument">CQL0500:
alias_of attribute must be a non-empty string argument</h3>
<p><code>cql:alias_of</code> must have a string argument to indicate the
underlying function name that the aliased function references. For
example:</p>
<div class="sourceCode" id="cb634"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb634-1"><a href="#cb634-1" aria-hidden="true" tabindex="-1"></a><span class="ot">@attribute(cql:alias_of=foo)</span></span>
<span id="cb634-2"><a href="#cb634-2" aria-hidden="true" tabindex="-1"></a><span class="kw">declare</span> <span class="kw">function</span> bar() <span class="dt">int</span></span></code></pre></div>
<p>All subsequent calls to <code>bar()</code> in CQL will call the
<code>foo()</code> function.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-5-json-schema-grammar">Appendix 5: JSON Schema
Grammar</h2>
<p>What follows is taken from the JSON validation grammar with the tree
building rules removed.</p>
<p>Snapshot as of Sat Aug 26 16:04:57 PDT 2023</p>
<h3 id="rules-1">Rules</h3>
<pre><code>

json_schema: &#39;{&#39;
         &#39;&quot;tables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_tables &#39;]&#39; &#39;,&#39;
         &#39;&quot;virtualTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_virtual_tables &#39;]&#39; &#39;,&#39;
         &#39;&quot;views&quot;&#39; &#39;:&#39; &#39;[&#39; opt_views &#39;]&#39; &#39;,&#39;
         &#39;&quot;indices&quot;&#39; &#39;:&#39; &#39;[&#39; opt_indices &#39;]&#39; &#39;,&#39;
         &#39;&quot;triggers&quot;&#39; &#39;:&#39; &#39;[&#39; opt_triggers &#39;]&#39; &#39;,&#39;
         &#39;&quot;attributes&quot;&#39; &#39;:&#39; &#39;[&#39; opt_attribute_list &#39;]&#39; &#39;,&#39;
         &#39;&quot;queries&quot;&#39; &#39;:&#39; &#39;[&#39; opt_queries &#39;]&#39; &#39;,&#39;
         &#39;&quot;inserts&quot;&#39; &#39;:&#39; &#39;[&#39; opt_inserts &#39;]&#39; &#39;,&#39;
         &#39;&quot;generalInserts&quot;&#39; &#39;:&#39; &#39;[&#39; opt_inserts_general &#39;]&#39; &#39;,&#39;
         &#39;&quot;updates&quot;&#39; &#39;:&#39; &#39;[&#39; opt_updates &#39;]&#39; &#39;,&#39;
         &#39;&quot;deletes&quot;&#39; &#39;:&#39; &#39;[&#39; opt_deletes &#39;]&#39; &#39;,&#39;
         &#39;&quot;general&quot;&#39; &#39;:&#39; &#39;[&#39; opt_generals &#39;]&#39; &#39;,&#39;
         &#39;&quot;declareProcs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_declare_procs&#39;]&#39; &#39;,&#39;
         &#39;&quot;declareFuncs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_declare_funcs&#39;]&#39; &#39;,&#39;
         &#39;&quot;interfaces&quot;&#39; &#39;:&#39; &#39;[&#39; opt_interfaces &#39;]&#39; &#39;,&#39;
         &#39;&quot;regions&quot;&#39; &#39;:&#39; &#39;[&#39; opt_regions &#39;]&#39; &#39;,&#39;
         &#39;&quot;adHocMigrationProcs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_ad_hoc_migrations &#39;]&#39; &#39;,&#39;
         &#39;&quot;enums&quot;&#39; &#39;:&#39;  &#39;[&#39; opt_enums &#39;]&#39; &#39;,&#39;
         &#39;&quot;constantGroups&quot;&#39; &#39;:&#39;  &#39;[&#39; opt_const_groups &#39;]&#39; &#39;,&#39;
         &#39;&quot;subscriptions&quot;&#39; &#39;:&#39;  &#39;[&#39; opt_subscriptions &#39;]&#39;
         &#39;}&#39;
  ;

BOOL_LITERAL: &#39;0&#39; | &#39;1&#39;
  ;

opt_tables: | tables
  ;

tables: table | table &#39;,&#39; tables
  ;

opt_backing_details: | &#39;&quot;isBacking&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39; | &#39;&quot;isBacked&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39; &#39;&quot;typeHash&quot;&#39; &#39;:&#39; num_literal &#39;,&#39;
  ;

opt_type_hash: | &#39;&quot;typeHash&quot;&#39; &#39;:&#39; num_literal &#39;,&#39;
  ;

table: &#39;{&#39;
       &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;schema&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;isTemp&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;ifNotExists&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;withoutRowid&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;isAdded&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_added_version
       &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_deleted_version
       &#39;&quot;isRecreated&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_recreate_group_name
       opt_unsub_version
       opt_backing_details
       opt_region_info
       opt_table_indices
       opt_attributes
       &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; columns &#39;]&#39; &#39;,&#39;
       &#39;&quot;primaryKey&quot;&#39; &#39;:&#39; &#39;[&#39; opt_column_names &#39;]&#39; &#39;,&#39;
       &#39;&quot;primaryKeySortOrders&quot;&#39; &#39;:&#39; &#39;[&#39; opt_sort_order_names &#39;]&#39; &#39;,&#39;
       opt_primary_key_name
       &#39;&quot;foreignKeys&quot;&#39; &#39;:&#39; &#39;[&#39; opt_foreign_keys &#39;]&#39; &#39;,&#39;
       &#39;&quot;uniqueKeys&quot;&#39; &#39;:&#39; &#39;[&#39; opt_unique_keys &#39;]&#39; &#39;,&#39;
       &#39;&quot;checkExpressions&quot;&#39; &#39;:&#39; &#39;[&#39; opt_check_expressions &#39;]&#39;
       &#39;}&#39;
  ;

opt_primary_key_name:  | &#39;&quot;primaryKeyName&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_virtual_tables: | virtual_tables
  ;

virtual_tables: virtual_table | virtual_table &#39;,&#39; virtual_tables
  ;

virtual_table: &#39;{&#39;
       &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;schema&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;isTemp&quot;&#39; &#39;:&#39; &#39;0&#39; &#39;,&#39;
       &#39;&quot;ifNotExists&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;withoutRowid&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;isAdded&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_added_version
       &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_deleted_version
       &#39;&quot;isRecreated&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_region_info
       &#39;&quot;isVirtual&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39;
       &#39;&quot;isEponymous&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;module&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       opt_module_args
       opt_attributes
       &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; columns &#39;]&#39; &#39;,&#39;
       &#39;&quot;primaryKey&quot;&#39; &#39;:&#39; &#39;[&#39; opt_column_names &#39;]&#39; &#39;,&#39;
       &#39;&quot;primaryKeySortOrders&quot;&#39; &#39;:&#39; &#39;[&#39; opt_sort_order_names &#39;]&#39; &#39;,&#39;
       &#39;&quot;foreignKeys&quot;&#39; &#39;:&#39; &#39;[&#39; opt_foreign_keys &#39;]&#39; &#39;,&#39;
       &#39;&quot;uniqueKeys&quot;&#39; &#39;:&#39; &#39;[&#39; opt_unique_keys &#39;]&#39; &#39;,&#39;
       &#39;&quot;checkExpressions&quot;&#39; &#39;:&#39; &#39;[&#39; opt_check_expressions &#39;]&#39;
       &#39;}&#39;
  ;

opt_module_args: | &#39;&quot;moduleArgs&quot;&#39; &#39;:&#39;  STRING_LITERAL &#39;,&#39;
  ;

opt_added_version: | &#39;&quot;addedVersion&quot;&#39; &#39;:&#39; any_integer &#39;,&#39; opt_added_migration_proc
  ;

opt_added_migration_proc: | &#39;&quot;addedMigrationProc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_unsub_version: | &#39;&quot;unsubscribedVersion&quot;&#39; &#39;:&#39; any_integer &#39;,&#39;
  ;

opt_deleted_version: | &#39;&quot;deletedVersion&quot;&#39; &#39;:&#39; any_integer &#39;,&#39; opt_deleted_migration_proc
  ;

opt_deleted_migration_proc: | &#39;&quot;deletedMigrationProc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_recreate_group_name: | &#39;&quot;recreateGroupName&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_index_names: | index_names
  ;

index_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; index_names
  ;

opt_arg_names: | arg_names
  ;

arg_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; arg_names
  ;

opt_column_names: | column_names
  ;

column_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; column_names
  ;

opt_table_names: | table_names
  ;

table_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; table_names
  ;

opt_view_names: | view_names
  ;

view_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; view_names
  ;

opt_procedure_names: | procedure_names
  ;

procedure_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; procedure_names
  ;

opt_sort_order_names: | sort_order_names
  ;

sort_order_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; sort_order_names
  ;

columns: column | column &#39;,&#39; columns
  ;

column: &#39;{&#39;
        &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
        opt_attributes
        &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
        opt_kind
        opt_is_sensitive
        &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        &#39;&quot;isAdded&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        opt_added_version
        &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        opt_deleted_version
        opt_default_value
        opt_collate
        opt_check_expr
        opt_type_hash
        &#39;&quot;isPrimaryKey&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        &#39;&quot;isUniqueKey&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        &#39;&quot;isAutoIncrement&quot;&#39; &#39;:&#39; BOOL_LITERAL
        &#39;}&#39;
  ;

opt_collate : | &#39;&quot;collate&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_check_expr: | &#39;&quot;checkExpr&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39; &#39;&quot;checkExprArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39; &#39;,&#39;
  ;

opt_default_value: | &#39;&quot;defaultValue&quot;&#39; &#39;:&#39; any_literal &#39;,&#39;
  ;

opt_foreign_keys : | foreign_keys
  ;

opt_kind: | &#39;&quot;kind&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_is_sensitive: | &#39;&quot;isSensitive&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39;
  ;

foreign_keys :  foreign_key | foreign_key &#39;,&#39; foreign_keys
  ;

foreign_key : &#39;{&#39;
               opt_name
               &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; column_names &#39;]&#39; &#39;,&#39;
               &#39;&quot;referenceTable&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
               &#39;&quot;referenceColumns&quot;&#39; &#39;:&#39; &#39;[&#39; column_names &#39;]&#39; &#39;,&#39;
               &#39;&quot;onUpdate&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
               &#39;&quot;onDelete&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
               &#39;&quot;isDeferred&quot;&#39; &#39;:&#39; BOOL_LITERAL
              &#39;}&#39;
  ;

opt_unique_keys :  | unique_keys
  ;

unique_keys : unique_key | unique_key &#39;,&#39; unique_keys
  ;

unique_key:  &#39;{&#39;
              opt_name
              &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; column_names &#39;]&#39; &#39;,&#39;
              &#39;&quot;sortOrders&quot;&#39; &#39;:&#39; &#39;[&#39; sort_order_names &#39;]&#39;
             &#39;}&#39;
  ;

opt_check_expressions: | check_expressions
  ;

check_expressions: check_expression | check_expression &#39;,&#39; check_expressions
  ;

check_expression: &#39;{&#39;
                   opt_name
                   &#39;&quot;checkExpr&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                   &#39;&quot;checkExprArgs&quot;&#39; &#39;:&#39; &#39;[&#39; &#39;]&#39;
                  &#39;}&#39;
  ;

opt_name: | &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_table_indices: | table_indices
  ;

table_indices: &#39;&quot;indices&quot;&#39; &#39;:&#39; &#39;[&#39; opt_index_names &#39;]&#39; &#39;,&#39;
  ;

opt_attributes:  | attributes
  ;

attributes: &#39;&quot;attributes&quot;&#39; &#39;:&#39; &#39;[&#39; attribute_list &#39;]&#39; &#39;,&#39;
  ;

opt_attribute_list: | attribute_list
  ;

attribute_list: attribute | attribute &#39;,&#39; attribute_list
  ;

attribute:  &#39;{&#39;
             &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             &#39;&quot;value&quot;&#39; &#39;:&#39; attribute_value
            &#39;}&#39;
  ;

attribute_array: &#39;[&#39; opt_attribute_value_list &#39;]&#39;
  ;

opt_attribute_value_list: | attribute_value_list
  ;

attribute_value_list: attribute_value | attribute_value &#39;,&#39; attribute_value_list
  ;

attribute_value: any_literal | attribute_array
  ;

any_integer: BOOL_LITERAL | INT_LITERAL
  ;

any_literal:  BOOL_LITERAL |
              INT_LITERAL | &#39;-&#39; INT_LITERAL |
              LONG_LITERAL | &#39;-&#39; LONG_LITERAL |
              REAL_LITERAL | &#39;-&#39; REAL_LITERAL |
              STRING_LITERAL | NULL_LITERAL
  ;

num_literal:  BOOL_LITERAL |
              INT_LITERAL | &#39;-&#39; INT_LITERAL |
              LONG_LITERAL | &#39;-&#39; LONG_LITERAL |
              REAL_LITERAL | &#39;-&#39; REAL_LITERAL
  ;

opt_views: | views
  ;

views: view | view &#39;,&#39; views
  ;

view:  &#39;{&#39;
       &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;isTemp&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
       opt_deleted_version
       opt_region_info
       opt_attributes
       projection
       &#39;&quot;select&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;selectArgs&quot;&#39; &#39;:&#39; &#39;[&#39; &#39;]&#39; &#39;,&#39;
       dependencies
       &#39;}&#39;
  ;

opt_region_info: | &#39;&quot;region&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39; |  &#39;&quot;region&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39; &#39;&quot;deployedInRegion&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_projection: | projection
  ;

projection: &#39;&quot;projection&quot;&#39; &#39;:&#39; &#39;[&#39; projected_columns &#39;]&#39; &#39;,&#39;
  ;

projected_columns: projected_column | projected_column &#39;,&#39; projected_columns
  ;

projected_column: &#39;{&#39;
                   &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                   &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                   opt_kind
                   opt_is_sensitive
                   &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL
                  &#39;}&#39;
  ;

opt_indices:  | indices
  ;

indices: index  | index &#39;,&#39; indices
  ;

index: &#39;{&#39;
        &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
        &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
        &#39;&quot;table&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
        &#39;&quot;isUnique&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        &#39;&quot;ifNotExists&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
        opt_deleted_version
        opt_region_info
        opt_partial_index_where
        opt_attributes
        &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; column_names &#39;]&#39; &#39;,&#39;
        &#39;&quot;sortOrders&quot;&#39; &#39;:&#39; &#39;[&#39; sort_order_names &#39;]&#39;
       &#39;}&#39;
  ;

opt_partial_index_where: | &#39;&quot;where&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_triggers: | triggers
  ;

triggers: trigger | trigger &#39;,&#39; triggers
  ;

trigger: &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;target&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;isTemp&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
          &#39;&quot;ifNotExists&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
          &#39;&quot;isDeleted&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
          opt_deleted_version
          before_after_instead &#39;,&#39;
          delete_insert_update &#39;,&#39;
          opt_for_each_row
          opt_when_expr
          &#39;&quot;statement&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;statementArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39; &#39;,&#39;
          opt_region_info
          opt_attributes
          dependencies
         &#39;}&#39;
  ;

before_after_instead: &#39;&quot;isBeforeTrigger&quot;&#39; &#39;:&#39; &#39;1&#39; | &#39;&quot;isAfterTrigger&quot;&#39; &#39;:&#39; &#39;1&#39;  | &#39;&quot;isInsteadOfTrigger&quot;&#39; &#39;:&#39; &#39;1&#39;
  ;

delete_insert_update: &#39;&quot;isDeleteTrigger&quot;&#39; &#39;:&#39; &#39;1&#39; | &#39;&quot;isInsertTrigger&quot;&#39; &#39;:&#39; &#39;1&#39; | &#39;&quot;isUpdateTrigger&quot;&#39; &#39;:&#39; &#39;1&#39;
  ;

opt_for_each_row: | &#39;&quot;forEachRow&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
  ;

opt_when_expr: | &#39;&quot;whenExpr&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39; &#39;&quot;whenExprArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39; &#39;,&#39;
  ;

dependencies: opt_insert_tables
            opt_update_tables
            opt_delete_tables
            opt_from_tables
            opt_uses_procedures
            opt_uses_views
            &#39;&quot;usesTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_table_names &#39;]&#39;
  ;

opt_uses_views: | &#39;&quot;usesViews&quot;&#39; &#39;:&#39; &#39;[&#39; opt_view_names &#39;]&#39; &#39;,&#39;
  ;

opt_insert_tables: | &#39;&quot;insertTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_table_names &#39;]&#39; &#39;,&#39;
  ;

opt_update_tables: | &#39;&quot;updateTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_table_names &#39;]&#39; &#39;,&#39;
  ;

opt_delete_tables: | &#39;&quot;deleteTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_table_names &#39;]&#39; &#39;,&#39;
  ;

opt_from_tables: | &#39;&quot;fromTables&quot;&#39; &#39;:&#39; &#39;[&#39; opt_table_names &#39;]&#39; &#39;,&#39;
  ;

opt_uses_procedures : | &#39;&quot;usesProcedures&quot;&#39; &#39;:&#39; &#39;[&#39; opt_procedure_names &#39;]&#39; &#39;,&#39;
  ;

opt_queries: | queries ;

queries: query | query &#39;,&#39; queries ;

query: &#39;{&#39;
       &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
       &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_args &#39;]&#39; &#39;,&#39;
       dependencies &#39;,&#39;
       opt_region_info
       opt_attributes
       projection
       &#39;&quot;statement&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
       &#39;&quot;statementArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39;
       &#39;}&#39;
  ;

opt_args: | args
  ;

args: arg | arg &#39;,&#39; args
  ;

arg: &#39;{&#39;
      &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      &#39;&quot;argOrigin&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      opt_kind
      opt_is_sensitive
      &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL
      &#39;}&#39;
  ;

opt_inserts: | inserts
  ;

inserts: insert | insert &#39;,&#39; inserts
  ;

insert : &#39;{&#39; insert_details &#39;,&#39; &#39;&quot;values&quot;&#39; &#39;:&#39; &#39;[&#39; opt_values &#39;]&#39; &#39;}&#39;
  ;

opt_inserts_general: | inserts_general
  ;

inserts_general: insert_general | insert_general &#39;,&#39; inserts_general
  ;

insert_details:
         &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
         &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_args &#39;]&#39; &#39;,&#39;
         dependencies &#39;,&#39;
         opt_region_info
         opt_attributes
         &#39;&quot;table&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statement&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statementArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39; &#39;,&#39;
         &#39;&quot;statementType&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;columns&quot;&#39; &#39;:&#39; &#39;[&#39; column_names &#39;]&#39;

insert_general : &#39;{&#39; insert_details &#39;}&#39;
  ;

opt_values: | values
  ;

values: value | value &#39;,&#39; values
  ;

value:  &#39;{&#39;
         &#39;&quot;value&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;valueArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39;
        &#39;}&#39;
  ;

opt_updates: | updates
  ;

updates: update | update &#39;,&#39; updates
  ;

update : &#39;{&#39;
         &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
         &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_args &#39;]&#39; &#39;,&#39;
         dependencies &#39;,&#39;
         opt_region_info
         opt_attributes
         &#39;&quot;table&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statement&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statementArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39;
         &#39;}&#39;
  ;

opt_deletes: | deletes
  ;

deletes: delete | delete &#39;,&#39; deletes
  ;

delete : &#39;{&#39;
         &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
         &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_args &#39;]&#39; &#39;,&#39;
         dependencies &#39;,&#39;
         opt_region_info
         opt_attributes
         &#39;&quot;table&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statement&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
         &#39;&quot;statementArgs&quot;&#39; &#39;:&#39; &#39;[&#39; opt_arg_names &#39;]&#39;
         &#39;}&#39;
  ;

opt_generals: | generals
  ;

generals: general | general &#39;,&#39; generals
  ;

general: &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
          &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_complex_args &#39;]&#39; &#39;,&#39;
          dependencies &#39;,&#39;
          opt_regions
          opt_attributes
          opt_projection
          opt_result_contract
          &#39;&quot;usesDatabase&quot;&#39; &#39;:&#39; BOOL_LITERAL
         &#39;}&#39;
  ;

opt_result_contract: | &#39;&quot;hasSelectResult&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39; | &#39;&quot;hasOutResult&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39; | &#39;&quot;hasOutUnionResult&quot;&#39; &#39;:&#39;&#39;1&#39; &#39;,&#39;
  ;

opt_complex_args: | complex_args
  ;

complex_args: complex_arg | complex_arg &#39;,&#39; complex_args
  ;

complex_arg: &#39;{&#39;
              binding
              &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
              opt_arg_origin
              &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
              opt_kind
              opt_is_sensitive
              &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL
             &#39;}&#39;
  ;

binding: | &#39;&quot;binding&quot;&#39; &#39;:&#39; &#39;&quot;inout&quot;&#39; &#39;,&#39; | &#39;&quot;binding&quot;&#39; &#39;:&#39; &#39;&quot;out&quot;&#39; &#39;,&#39;
  ;

opt_arg_origin: | arg_origin
  ;

arg_origin: &#39;&quot;argOrigin&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
  ;

opt_enums: | enums
  ;

enums: enum | enum &#39;,&#39; enums
  ;

enum: &#39;{&#39;
      &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; &#39;1&#39; &#39;,&#39;
      &#39;&quot;values&quot;&#39; &#39;:&#39; &#39;[&#39; enum_values &#39;]&#39;
      &#39;}&#39;
  ;

enum_values: enum_value | enum_value &#39;,&#39; enum_values
  ;

enum_value: &#39;{&#39;
             &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             &#39;&quot;value&quot;&#39; &#39;:&#39; num_literal
            &#39;}&#39;
  ;

opt_declare_procs: | declare_procs
  ;

declare_procs: declare_proc | declare_proc &#39;,&#39; declare_procs

declare_proc: &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_complex_args &#39;]&#39; &#39;,&#39;
          opt_attributes
          opt_projection
          &#39;&quot;usesDatabase&quot;&#39; &#39;:&#39; BOOL_LITERAL
         &#39;}&#39;
  ;

opt_declare_funcs:  | declare_funcs
  ;

declare_funcs: declare_func | declare_func &#39;,&#39; declare_funcs
  ;

declare_func: &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;args&quot;&#39; &#39;:&#39; &#39;[&#39; opt_complex_args &#39;]&#39; &#39;,&#39;
          opt_attributes
          return_type &#39;,&#39;
          &#39;&quot;createsObject&quot;&#39; &#39;:&#39; BOOL_LITERAL
         &#39;}&#39;
  ;

return_type: &#39;&quot;returnType&quot;&#39; &#39;:&#39; &#39;{&#39;
          &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          opt_kind
          opt_is_sensitive
          &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL
         &#39;}&#39;
  ;

opt_interfaces: | interfaces
  ;

interfaces: interface | interface &#39;,&#39; interfaces
  ;

interface: &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;definedInFile&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;definedOnLine&quot;&#39; &#39;:&#39; INT_LITERAL &#39;,&#39;
          opt_attributes
          &#39;&quot;projection&quot;&#39; &#39;:&#39; &#39;[&#39; projected_columns &#39;]&#39;
         &#39;}&#39;
  ;

opt_subscriptions: | subscriptions
  ;

subscriptions: subscription | subscription &#39;,&#39; subscriptions
  ;

subscription: &#39;{&#39;
     &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
     &#39;&quot;table&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
     opt_region_info
     &#39;&quot;version&quot;&#39; &#39;:&#39; any_integer
     &#39;}&#39;
  ;

opt_const_groups: | const_groups
  ;

const_groups: const_group | const_group &#39;,&#39; const_groups
  ;

const_group: &#39;{&#39;
      &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
      &#39;&quot;values&quot;&#39; &#39;:&#39; &#39;[&#39; const_values &#39;]&#39;
      &#39;}&#39;
  ;

const_values: const_value | const_value &#39;,&#39; const_values
  ;

const_value: &#39;{&#39;
             &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             opt_kind
             &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
             &#39;&quot;value&quot;&#39; &#39;:&#39; num_literal
            &#39;}&#39;
  | &#39;{&#39;
             &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             &#39;&quot;type&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
             opt_kind
             &#39;&quot;isNotNull&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
             &#39;&quot;value&quot;&#39; &#39;:&#39; STRING_LITERAL
            &#39;}&#39;
  ;

opt_regions: | regions
  ;

regions: region | region &#39;,&#39; regions
  ;

region:  &#39;{&#39;
          &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;isDeployableRoot&quot;&#39; &#39;:&#39; BOOL_LITERAL &#39;,&#39;
          &#39;&quot;deployedInRegion&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
          &#39;&quot;using&quot;&#39; &#39;:&#39; &#39;[&#39; opt_region_names &#39;]&#39; &#39;,&#39;
          &#39;&quot;usingPrivately&quot;&#39; &#39;:&#39; &#39;[&#39; opt_bool_list &#39;]&#39;
         &#39;}&#39;
  ;

opt_region_names: | region_names
  ;

region_names: STRING_LITERAL | STRING_LITERAL &#39;,&#39; region_names
  ;

opt_bool_list: | bool_list
  ;

bool_list: BOOL_LITERAL | BOOL_LITERAL &#39;,&#39; bool_list
  ;

opt_ad_hoc_migrations: | ad_hoc_migrations
  ;

ad_hoc_migrations: ad_hoc_migration | ad_hoc_migration &#39;,&#39; ad_hoc_migrations
  ;

ad_hoc_migration: &#39;{&#39;
                  &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                  &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                  opt_attributes
                  &#39;&quot;version&quot;&#39; &#39;:&#39; any_integer
                  &#39;}&#39;
  | &#39;{&#39;
                  &#39;&quot;name&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                  &#39;&quot;crc&quot;&#39; &#39;:&#39; STRING_LITERAL &#39;,&#39;
                  opt_attributes
                  &#39;&quot;onRecreateOf&quot;&#39; &#39;:&#39; STRING_LITERAL
                  &#39;}&#39;
  ;
</code></pre>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-6-cql-in-20-minutes">Appendix 6: CQL In 20 Minutes</h2>
<p>What follows is a series of examples intended to illustrate the most
important features of the CQL language. This appendix was significantly
influenced by a similar article on Python at
https://learnxinyminutes.com/docs/python/</p>
<p>Also of interest: * http://sqlite.org *
https://learnxinyminutes.com/docs/sql</p>
<p>And with no further delay, CQL in 20 minutes…</p>
<pre><code>-- Single line comments start with two dashes

/* C style comments also work
 *
 * C pre-processor features like #include and #define are generally available
 * CQL is typically run through the C pre-processor before it is compile.
 */

/**********************************************************
 * 1. Primitive Datatypes and Operators
 *********************************************************/

-- You have numbers
3     -- an integer
3L    -- a long integer
3.5   -- a real literal
0x10  -- 16 in hex

-- Math is what you would expect
1 + 1     --&gt; 2
8 - 1     --&gt; 7
10 * 2    --&gt; 20
35.0 / 5  --&gt; 7.0

-- Modulo operation, same as C and SQLite
7 % 3    --&gt; 1
-7 % 3   --&gt; -1
7 % -3   --&gt; 1
-7 % 3   --&gt; -1

-- Bitwise operators bind left to right like in SQLite
1 | 4 &amp; 3  --&gt;  1  (not 0)

-- Enforce precedence with parentheses
1 + 3 * 2    --&gt; 7
(1 + 3) * 2  --&gt; 8

-- Use true and false for bools, nullable bool is possible
true    --&gt; how to true
false   --&gt; how to false
null    --&gt; null means &quot;unknown&quot; in CQL like SQLite

-- Negate with not
not true   --&gt; false
not false  --&gt; true
not null   --&gt; null (not unknown is unknown)

-- Logical Operators
1 and 0 --&gt; 0
0 or 1  --&gt; 1
0 and x --&gt; 0 and x not evaluated
1 or x  --&gt; 1 and x not evaluated

-- Remember null is &quot;unknown&quot;
null or false  --&gt; null
null or true   --&gt; true
null and false --&gt; false
null and true  --&gt; null

-- Non-zero values are truthy
0        --&gt; false
4        --&gt; true
-6       --&gt; true
0 and 2  --&gt; 0 (false)
-5 or 0  --&gt; 1 (true)

-- Equality is == or =
1 == 1       --&gt; true
1 = 1        --&gt; true  (= and == are the same thing)
2 == 1       --&gt; false

-- Note that null is not equal to anything (like SQL)
null == 1    --&gt; null (hence not true)
null == null --&gt; null (hence not true)
&quot;x&quot; == &quot;x&quot;   --&gt; true

-- IS lets you compare against null
1 IS 1       --&gt; true
2 IS 1       --&gt; false
null IS 1    --&gt; false
null IS null --&gt; true  (Unknown is Unknown?  Yes it is!)
&quot;x&quot; IS &quot;x&quot;   --&gt; true

-- x IS NOT y is the same as NOT (x IS y)
1 IS NOT 1       --&gt; false
2 IS NOT 1       --&gt; true
null IS NOT 1    --&gt; true
null IS NOT null --&gt; false
&quot;x&quot; IS NOT &quot;x&quot;   --&gt; false

-- Inequality is != or &lt;&gt;
1 != 1       --&gt; false
2 &lt;&gt; 1       --&gt; true
null != 1    --&gt; null
null &lt;&gt; null --&gt; null

-- More comparisons
1 &lt; 10    --&gt; true
1 &gt; 10    --&gt; false
2 &lt;= 2    --&gt; true
2 &gt;= 2    --&gt; true
10 &lt; null --&gt; null

-- To test if a value is in a range
1 &lt; 2 and 2 &lt; 3  --&gt; true
2 &lt; 3 and 3 &lt; 2  --&gt; false

-- BETWEEN makes this look nicer
2 between 1 and 3 --&gt; true
3 between 2 and 2 --&gt; false

-- Strings are created with &quot;x&quot; or &#39;x&#39;
&quot;This is a string.\n&quot;           -- can have C style escapes (no embedded nulls)
&quot;Th\x69s is a string.\n&quot;        -- even hex literals
&#39;This isn&#39;&#39;t a C style string&#39;  -- use &#39;&#39; to escape single quote ONLY

/**********************************************************
 * 2. Simple Variables
 *********************************************************/

-- CQL can call simple libc methods with a no-check declaration
-- we&#39;ll need this for later examples so we can do something
-- with our expressions (i.e. print them)
declare procedure printf no check;

call printf(&quot;I&#39;m CQL. Nice to meet you!\n&quot;);

-- Variables are declared with DECLARE.
-- Keywords and identifiers are not case sensitive.
declare x integer not null;

-- You can call it X, it is the same thing.
set X := 0;

-- All variables begin with a null value if allowed, else a zero value.
declare y integer not null;
if y == 0 then
  call printf(&quot;Yes, this will run.\n&quot;);
end if;

-- A nullable variable (i.e. not marked with not null) is initialized to null
declare z real;
if z is null then
  call printf(&quot;Yes, this will run.\n&quot;);
end if;

-- The various types
declare a_blob blob;
declare a_string text;
declare a_real real;
declare an_int integer;
declare a_long long;
declare an_object object;

-- There are some typical SQL synonyms
declare an_int int;
declare a_long long integer;
declare a_long long int;
declare a_long long_int;

-- The basic types can be tagged to make them less miscible
declare m real&lt;meters&gt;;
declare kg real&lt;kilos&gt;;

set m := kg;  -- error!

-- Object variables can also be tagged so that they are not mixed-up easily
declare dict object&lt;dict&gt; not null;
declare list object&lt;list&gt; not null;
set dict := create_dict();  -- an external function that creates a dict
set dict := create_list();  -- error
set list := create_list();  -- ok
set list := dict;           -- error

-- Implied type initialization
LET i := 1;      -- integer not null
LET l := 1L;     -- long not null
LET t := &quot;x&quot;;    -- text not null
LET b := x IS y; -- bool not null
LET b := x = y;  -- bool (maybe not null depending on x/y)

-- The psuedo function &quot;nullable&quot; converts the type of its arg to the nullable
-- version of the same thing.

LET n_i := nullable(1);   -- nullable integer variable initialized to 1
LET l_i := nullable(1L);  -- nullable long variable initialized to 1

/**********************************************************
 * 3. Control Flow
 *********************************************************/

-- Just make a variable
declare some_var integer not null;
set some_var := 5

-- Here is an IF statement
if some_var &gt; 10 then
    call printf(&quot;some_var is totally bigger than 10.\n&quot;)
else if some_var &lt; 10 then  -- else if is optional
    call printf(&quot;some_var is smaller than 10.\n&quot;)
else -- else is optional
    call printf(&quot;some_var is indeed 10.\n&quot;)
end if;


-- WHILE loops iterate as usual
declare i integer not null;
set i := 0;
while i &lt; 5
begin
   call printf(&quot;%d\n&quot;, i);
   set i := i + 1;
end;

-- Use LEAVE to end a loop early
declare i integer not null;
set i := 0;
while i &lt; 500
begin
   if i &gt;= 5 then
     -- we are not going to get anywhere near 500
     leave;
   end if;

   call printf(&quot;%d\n&quot;, i);
   set i := i + 1;
end;

-- Use CONTINUE to go back to the loop test
declare i integer not null;
set i := 0;
while i &lt; 500
begin
   set i := i + 1;
   if i % 2 then
     -- Note: we to do this after &quot;i&quot; is incremented!
     -- to avoid an infinite loop
     continue;
   end if;

   -- odd numbers will not be printed because of continue above
   call printf(&quot;%d\n&quot;, i);
end;

 /**********************************************************
 * 4. Complex Expression Forms
 *********************************************************/

 -- Case is an expression, so it is more like the C &quot;?:&quot; operator
 -- than a switch statement.  It is like &quot;?:&quot; on steroids.

 case i              -- a switch expression is optional
   when 1 then &quot;one&quot; -- one or more cases
   when 2 then &quot;two&quot;
   else &quot;other&quot;      -- else is optional
 end;

-- Case with no common expression is a series of independent tests
case
   when i == 1 then &quot;i = one&quot;   -- booleans could be completely unrelated
   when j == 2 then &quot;j = two&quot;   -- first match wins
   else &quot;other&quot;
end;

-- If nothing matches the cases, the result is null.
-- The following expression yields null because 7 is not 1.
case 7 when 1 then &quot;one&quot; end


-- Case is just an expression, so it can nest
case X
  when 1
    case y when 1 &quot;x:1 y:1&quot;
           else &quot;x:1 y:other&quot;
    end
  else
    case when z == 1 &quot;x:other z:1&quot;
         else &quot;x:other z:other&quot;
    end
end;

-- IN is used to test for membership
5 IN (1, 2, 3, 4, 5)  --&gt; true
7 IN (1, 2)           --&gt; false
null in (1, 2, 3)     --&gt; null
null in (1, null, 3)  --&gt; null  (null == null is not true)
7 NOT IN (1, 2)       --&gt; true
null not in (null, 3) --&gt; null

/**********************************************************
 * 4. Working with and &quot;getting rid of&quot; null
 *********************************************************/

-- Null can be annoying, you might need a not null value.
-- In most operations null is radioactive:
null + x     --&gt; null
null * x     --&gt; null
null == null --&gt; null

-- IS and IS NOT always return 0 or 1
null is 1     -&gt; 0
1 is not null -&gt; 1

-- COALESCE returns the first non null arg, or the last arg if all were null.
-- If the last arg is not null, you get a non null result for sure.
-- The following is never null, but it&#39;s false if either x or y is null
COALESCE(x==y, false) -&gt; thought excercise: how is this different than x IS y?

-- IFNULL is coalesce with 2 args only (COALESCE is more general)
IFNULL(x, -1) --&gt; use -1 if x is null

-- The reverse, NULLIF, converts a sentinel value to unknown, more exotic
NULLIF(x, -1) --&gt; if x is -1 then use null

-- the else part of a case can get rid of nulls
CASE when x == y then 1 else 0 end;  --&gt; true iff x = y and neither is null

-- CASE can be used to give you a default value after various tests
-- The following expression is never null; &quot;other&quot; is returned if x is null.
CASE when x &gt; 0 then &quot;pos&quot; when x &lt; 0 then &quot;neg&quot; else &quot;other&quot; end;

-- You can &quot;throw&quot; out of the current procedure (see exceptions below)
declare x integer not null;
set x := ifnull_throw(nullable_int_expr); -- returns non null, throws if null

-- If you have already tested the expression then control flow analysis
-- improves its type to &quot;not null&quot;.  Many common check patterns are recognized.
if nullable_int_expr is not null then
  -- nullable_int_expression is known to be not null in this context
  set x := nullable_int_expr;
end if;

/**********************************************************
 * 5. Tables, Views, Indices, Triggers
 *********************************************************/

-- Most forms of data definition language DDL are supported.
-- &quot;Loose&quot; DDL (outside of any procedure) simply declares
-- schema, it does not actually create it; the schema is assumed to
-- exist as you specified.

create table T1(
  id integer primary key,
  t text,
  r real
);

create table T2(
  id integer primary key references T1(id),
  l long,
  b blob
);

-- CQL can take a series of schema declarations (DDL) and
-- automatically create a procedure that will materialize
-- that schema and even upgrade previous versions of the schema.
-- This system is discussed in Chapter 10 of The Guide.
-- To actually create tables and other schema you need
-- procedures that look like the below:

create proc make_tables()
begin
  create table T1 if not exists (
    id integer primary key,
    t text,
    r real
  );
end;

-- Views are supported
create view V1 as (select * from T1);

-- Triggers are supported
create trigger if not exists trigger1
  before delete on T1
begin
  delete from T2 where id = old.id;
end;

-- Indices are supported
create index I1 on T1(t);
create index I2 on T1(r);

-- The various drop forms are supported
drop index I1;
drop index I2;
drop view V1;
drop table T2;
drop table T1;

-- A complete discussion of DDL is out of scope, refer to sqlite.org

/**********************************************************
 * 6. Selecting Data
 *********************************************************/

-- We will use this scratch variable in the following examples
declare rr real;

-- First observe CQL is a two-headed language
set rr := 1+1;           -- this is evaluated in generated C code
set rr := (select 1+1);  -- this expresion goes to SQLite; SQLite does the addition

-- CQL tries to do most things the same as SQLite in the C context
-- but some things are exceedingly hard to emulate correctly.
-- Even simple looking things such as:
set rr := (select cast(&quot;1.23&quot; as real));   --&gt;  rr := 1.23
set rr := cast(&quot;1.23&quot; as real);            --&gt;  error (not safe to emulate SQLite)

-- In general, numeric/text conversions have to happen in SQLite context
-- because the specific library that does the conversion could be and usually
-- is different than the one CQL would use.  It would not do to give different answers
-- in one context or another so those conversions are simply not supported.

-- Loose concatenation is not supported because of the implied conversions.
-- Loose means &quot;not in the context of a SQL statement&quot;.
set r := 1.23;
set r := (select cast(&quot;100&quot;||r as real));  --&gt; 1001.23 (a number)
set r := cast(&quot;100&quot;||r as real);  --&gt; error, concat not supported in loose expr

-- A simple insertion
insert into T1 values (1, &quot;foo&quot;, 3.14);

-- Finally, reading from the database
set r := (select r from T1 where id = 1);  --&gt; r = 3.14

-- The (select ...) form requires the result to have at least one row.
-- You can use IF NOTHING forms to handle other cases such as:
set r := (select r from T1
          where id = 2
          if nothing -1);  --&gt; r = -1

-- If the SELECT statement might return a null result you can handle that as well
set r := (select r from T1
          where id = 2
          if nothing or null -1);  --&gt; r = -1

-- With no IF NOTHING clause, lack of a row will cause the SELECT expression to throw
-- an exception.  IF NOTHING THROW merely makes this explicit.
set r := (select r from T1 where id = 2 if nothing throw);  --&gt; will throw

/**********************************************************
 * 6. Procedures, Results, Exceptions
 *********************************************************/

-- Procedures are a list of statements that can be executed, with arguments.
create proc hello()
begin
  call printf(&quot;Hello, world\n&quot;);
end;

-- IN, OUT, and INOUT parameters are possible
create proc swizzle(x integer, inout y integer, out z real not null)
begin
  set y := x + y;  -- any computation you like

  -- bizarre way to compute an id but this is just an illustration
  set z := (select r from T1 where id = x if nothing or null -1);
end;

-- Procedures like &quot;hello&quot; (above) have a void signature -- they return nothing
-- as nothing can go wrong. Procedures that use the database like &quot;swizzle&quot; (above)
-- can return an error code if there is a problem.
-- &quot;will_fail&quot; (below)  will always return SQLITE_CONSTRAINT, the second insert
-- is said to &quot;throw&quot;.  In CQL exceptions are just result codes.
create proc will_fail()
begin
   insert into T1 values (1, &quot;x&quot;, 1);
   insert into T1 values (1, &quot;x&quot;, 1);  --&gt; duplicate key
end;

-- DML that fails generates an exception and
-- exceptions can be caught. Here is a example:
create proc upsert_t1(
  id_ integer primary key,
  t_ text,
  r_ real
)
begin
  begin try
    -- try to insert
    insert into T1(id, t, r) values (id_, t_, r_);
  end try;
  begin catch
    -- if the insert fails, try to update
    update T1 set t = t_, r = r_ where id = id_;
  end catch;
end;

-- Shapes can be very useful in avoiding boilerplate code
-- the following is equivalent to the above.
-- More on shapes later.
create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1
begin
  begin try
    insert into T1 from arguments
  end try;
  begin catch
    update T1 set t = t_, r = r_ where id = id_;
  end catch;
end;

-- You can (re)throw an error explicitly.
-- If there is no current error you get SQLITE_ERROR
create proc upsert_wrapper(LIKE t1) -- my args are the same as the columns of T1
begin
  if r_ &gt; 10 then throw end if; -- throw if r_ is too big
  call upsert_t1(from arguments);
end;

-- Procedures can also produce a result set.
-- The compiler generates the code to create this result set
-- and helper functions to read rows out of it.
create proc get_low_r(r_ real)
begin
   -- optionally insert some rows or do other things
   select * from T1 where T1.r &lt;= r_;
end;

-- A procedure can choose between various results, the choices must be compatible.
-- The last &quot;select&quot; to run controls the ultimate result.
create proc get_hi_or_low(r_ real, hi_not_low bool not null)
begin
  -- trying to do this with one query would result in a poor plan, so
  -- instead we use two economical queries.
  if hi_not_low then
    select * from T1 where T1.r &gt;= r_;
  else
    select * from T1 where T1.r &lt;= r_;
  end if;
end;

-- Using IF to create to nice selects above is a powerful thing.
-- SQLite has no IF, if we tried to create a shared query we get
-- something that does not use indices at all.  As in the below.
-- The two-headed CQL beast has its advantages!
select * from T1 where case hi_not_low then T1.r &gt;= r_ else T1.r &lt;= r_ end;

-- You can get the current return code and use it in your CATCH logic.
-- This upsert is a bit better than the first:
create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1
begin
  begin try
    insert into T1 from arguments
  end try;
  begin catch;
    if @rc == 19 /* SQLITE_CONSTRAINT */ then
      update T1 set t = t_, r = r_ where id = id_;
    else
      throw;  -- rethrow, something bad happened.
    end if;
  end catch;
end;

-- By convention, you can call a procedure that has an OUT argument
-- as its last argument using function notation.  The out argument
-- is used as the return value.   If the called procedure uses the
-- database then it could throw which causes the caller to throw
-- as usual.
create proc fib(n integer not null, out result integer not null)
begin
   set result := case n &lt;= 2 then 1 else fib(n-1) + fib(n-2) end;
end;

/**********************************************************
 * 7. Statement Cursors
 *********************************************************/

-- Statement cursors let you iterate over a select result.
-- Here we introduce cursors, LOOP and FETCH.
create proc count_t1(r_ real, out rows_ integer not null)
begin
  declare rows integer not null;  -- starts at zero guaranteed
  declare C cursor for select * from T1 where r &lt; r_;
  loop fetch C -- iterate until fetch returns no row
  begin
    -- goofy code to illustrate you can process the cursor
    -- in whatever way you deem appropriate
    if C.r &lt; 5 then
      rows := rows + 1; -- count rows with C.r &lt; 5
    end if;
  end;
  set rows_ := rows;
end;

-- Cursors can be tested for presence of a row
-- and they can be closed before the enumeration is finished.
-- As before the below is somewhat goofy example code.
create proc peek_t1(r_ real, out rows_ integer not null)
begin
   /* rows_ is set to zero for sure! */
   declare C cursor for select * from T1 where r &lt; r_ limit 2;
   open C;  -- this is no-op, present because other systems have it
   fetch C;  -- fetch might find a row or not
   if C then  -- cursor name as bool indicates presence of a row
     set rows_ = rows_ + (C.r &lt; 5);
     fetch C;
     set rows_ = rows_ + (C and C.r &lt; 5);
   end if;
   close C;  -- cursors auto-closed at end of method but early close possible
end;

-- The FETCH...INTO form can be used to fetch directly into variables
fetch C into id_, t_, r_;  --&gt; loads named locals instead of C.id, C.t, C.r

-- A procedure can be the source of a cursor
declare C cursor for call get_low_r(3.2);  -- valid cursor source

-- OUT can be used to create a result set that is just one row
create proc one_t1(r_ real)
begin
   declare C cursor for select * from T1 where r &lt; r_ limit 1;
   fetch C;
   out C;  -- emits a row if we have one, no row is ok too, empty result set.
end;

/**********************************************************
 * 8. Value Cursors, Out, and Out Union
 *********************************************************/

-- To consume a procedure that uses &quot;out&quot; you can declare a value cursor.
-- By itself such as cursor does not imply use of the database, but often
-- the source of the cursor uses the database.  In this example
-- consume_one_t1 uses the database because of the call to one_t1.
create proc consume_one_t1()
begin
  -- a cursor whose shape matches the one_t1 &quot;out&quot; statement
  declare C cursor like one_t1;

  -- load it from the call
  fetch C from call one_t1(7);
  if C.r &gt; 10 then
    -- use values as you see fit
    call printf(&quot;woohoo&quot;);
  end if;
end;

-- You can do the above in one step with the compound form:
declare C cursor fetch from call one_t1(7); -- declare and fetch

-- Value cursors can come from anywhere and can be a procedure result
create proc use_t1_a_lot()
begin
  -- T1 is the same shape as one_t1, this will work, too
  declare C cursor like T1;
  fetch C from call one_t1(7);  -- load it from the call

  -- some arbitrary logic might be here

  -- load C again with different args
  fetch C from call one_t1(12);   -- load it again

  -- some arbitrary logic might be here

  -- now load C yet again with explicit args
  fetch C using
     1 id,
     &quot;foo&quot; t,
     8.2 r;

  -- now return it
  out C;
end;

-- Make a complex result set one row at a time
create proc out_union_example()
begin
  -- T1 is the same shape as one_t1, this will work, too
  declare C cursor like T1;

  -- load it from the call
  fetch C from call one_t1(7);

  -- note out UNION rather than just out, indicating potentially many rows
  out union C;

  -- load it again with different args
  fetch C from call one_t1(12);
  out union C;

  -- do something, then maybe load it again with explicit args
  fetch C using
     1 id,
     &quot;foo&quot; t,
     8.2 r;
  out union C;

  -- we have generated a 3 row result set
end;

-- Consume the above
create proc consume_result()
begin
  declare C cursor for call out_union_example();
  loop fetch C
  begin
    -- use builtin cql_cursor_format to make the cursor into a string
    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value
  end;
end;

/**********************************************************
 * 9. Named Types and Enumerations
 *********************************************************/

-- Create a simple named types
declare my_type type integer not null;   -- make an alias for integer not null
declare i my_type;  -- use it, &quot;i&quot; is an integer

-- Mixing in type kinds is helpful
declare distance type real&lt;meters&gt;;  -- e.g., distances to be measured in meters
declare time type real&lt;seconds&gt;;     -- e.g., time to be measured in seconds
declare job_id type long&lt;job_id&gt;;
declare person_id type long&lt;person_id&gt;;

-- With the above done
--  * vars/cols of type &quot;distance&quot; are incompatible with those of type &quot;time&quot;
--  * vars/cols of types job_id are incompatible with person_id
-- This is true even though the underlying type is the same for both!

-- ENUM declarations can have any numeric type as their base type
declare enum implement integer (
   pencil,       -- values start at 1 unless you use = to choose something
   pen,          -- the next enum gets previous + 1 as its value (2)
   brush = 7     -- with = expression you get the indicated value
);

-- The above also implicitly does this
declare implement type integer&lt;implement&gt; not null;

-- Using the enum -- simply use dot notation
declare impl implement;
set impl := implement.pen;  -- value &quot;2&quot;

-- You can emit an emum into the current .h file we are going to generate.
-- Do not put this directive in an include file, you want it to go to one place.
-- Instead, pick one compiland that will &quot;own&quot; the emission of the enum.
-- C code can then #include that one .h file.
@emit_enums implement;

/**********************************************************
 * 10. Shapes and Their Uses
 *********************************************************/

-- Shapes first appeared to help define value cursors like so:

-- A table or view name defines a shape
declare C cursor like T1;

-- The result of a proc defines a shape
declare D cursor like one_t1;

-- A dummy select statement defines a shape (the select does not run)
-- this one is the same as (x integer not null, y text not null)
declare E cursor like select 1 x, &quot;2&quot; y;

-- Another cursor defines a shape
declare F cursor like C;

-- The arguments of a procedure define a shape. If you have
-- create proc count_t1(r_ real, out rows_ integer not null) ...
-- the shape will be:
--  (r_ real, rows_ integer not null)
declare G cursor like count_t1 arguments;

-- A loaded cursor can be used to make a call
call count_t1(from G);  -- the args become G.r_, G.rows_

-- A shape can be used to define a procedures args, or some of the args
-- In the following &quot;p&quot; will have arguments:s id_, t_, and r_ with types
-- matching table T1.
-- Note: To avoid ambiguity, an _ was added to each name!
create proc p(like T1)
begin
  -- do whatever you like
end;

-- The arguments of the current procedure are a synthetic shape
-- called &quot;arguments&quot; and can used where other shapes can appear.
-- For instance, you can have &quot;q&quot; shim to &quot;p&quot; using this form:
create proc q(like T1, print bool not null)
begin
  -- maybe pre-process, silly example
  set id_ := id_ + 1;

  -- shim to p
  call p(from arguments); -- pass my args through, whatever they are

  -- maybe post-process, silly example
  set r_ := r_ - 1;

  if print then
    -- convert args to cursor
    declare C like q arguments;
    fetch C from arguments;
    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value
  end if;

  -- insert a row based on the args
  insert into T1 from arguments;
end;

-- You an use a given shape more than once if you name each use.
-- This would be more exciting if T1 was like a &quot;person&quot; or something.
create proc r(a like T1, b like T1)
begin
  call p(from a);
  call p(from b);
  -- you can refer to a.id, b.id etc.
  declare C like a;
  fetch C from a;
  call printf(&quot;%s\n&quot;, cql_cursor_format(C));
  fetch C from b;
  call printf(&quot;%s\n&quot;, cql_cursor_format(C));
end;

-- Shapes can be subsetted, for instance in the following example
-- only the arguments that match C are used in the FETCH.
fetch C from arguments(like C);

-- Fetch the columns of D into C using the cursor D for the data source.
-- Other columns get default values.
fetch C(like D) from D;

-- Use the D shape to load C, dummy values for the others.
-- In this example, dummy_seed means use the provided value, 11, for
-- any numerics that are not specified (not in D) and and use
-- &quot;col_name_11&quot; for any strings/blobs.  This pattern is useful in test code
-- to create dummy data, hence the name.
fetch C(like D) from D @dummy_seed(11);

-- Use the Z shape to control which fields are copied.
-- Use the dummy value even if the field is nullable and null would have be ok.
fetch C(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;

-- The above patterns also work for insert statements
-- The shape constraints are generally useful.  The dummy data
-- sources are useful for inserting test data.
insert into T1(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;

-- We&#39;ll need this dummy procedure some_shape so we can use its return
-- value in the examples that follow.  We will never actual create this
-- proc, we only declare it to define the shape, so this is kind of like
-- a typedef.
declare proc some_shape() (x integer not null, y integer not null, z integer not null);

-- You can make a helper procedure to create test args that are mostly constant
-- or computable.
create get_foo_args(X like some_shape, seed_ integer not null)
begin
  declare C cursor like foo arguments;
  -- any way of loading C could work this is one
  fetch C(like X) from X @dummy_seed(seed_);
  out C;
end;

-- Now we can use the &quot;get_foo_args&quot; to get full set of arguments for &quot;foo&quot; and then
-- call &quot;foo&quot; with those arguments.  In this example we&#39;re providing
-- some of the arguments explicitly, &quot;some_shape&quot; is the part of the args that
-- needs to manually vary in each test iteration, the rest of the arguments will
-- be dummy values.  There could be zillions of args in either category.
-- In the below &quot;some_shape&quot; is going to get the manual values 1, 2, 3 while 100
-- will be the seed for the dummy args.
declare foo_args cursor fetch from call get_foo_args(1,2,3, 100);
call foo(from foo_args);

/**********************************************************
 * 11. INSERT USING and FETCH USING
 *********************************************************/

 -- This kind of thing is a pain
 insert into foo(a, b, c, d, e, f, g)
    values(1, 2, 3, null, null, 5, null);

-- Instead, write this form:
insert into foo USING
    1 a, 2 b, 3 c, null d, null e, 5 f, null g;

-- The FETCH statement can also be &quot;fetch using&quot;
declare C cursor like foo;
fetch C USING
    1 a, 2 b, 3 c, null d, null e, 5 f, null g;</code></pre>
<p>If you’ve read this far you know more than most now. :)</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-7-cql-anti-patterns">Appendix 7: CQL Anti-patterns</h2>
<p>These are a few of the antipatterns I’ve seen while travelling
through various CQL source files. They are in various categories.</p>
<p>Refer also to Appendix 8: CQL Best Practices.</p>
<h3 id="common-schema">Common Schema</h3>
<p>For these examples let’s create a couple of tables we might need for
examples</p>
<div class="sourceCode" id="cb637"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> foo (</span>
<span id="cb637-2"><a href="#cb637-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb637-3"><a href="#cb637-3" aria-hidden="true" tabindex="-1"></a>    name text</span>
<span id="cb637-4"><a href="#cb637-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb637-5"><a href="#cb637-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb637-6"><a href="#cb637-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> bar (</span>
<span id="cb637-7"><a href="#cb637-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb637-8"><a href="#cb637-8" aria-hidden="true" tabindex="-1"></a>    rate <span class="dt">real</span></span>
<span id="cb637-9"><a href="#cb637-9" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h3 id="declarations">Declarations</h3>
<div class="sourceCode" id="cb638"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb638-1"><a href="#cb638-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> v <span class="dt">LONG</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb638-2"><a href="#cb638-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> v <span class="op">:=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>better:</p>
<div class="sourceCode" id="cb639"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb639-1"><a href="#cb639-1" aria-hidden="true" tabindex="-1"></a>LET v <span class="op">:=</span> 1L;  <span class="co">-- long literals have the L suffix like in C</span></span></code></pre></div>
<p>Similarly:</p>
<div class="sourceCode" id="cb640"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb640-1"><a href="#cb640-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> v <span class="dt">REAL</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb640-2"><a href="#cb640-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> v <span class="op">:=</span> <span class="dv">1</span>;</span></code></pre></div>
<p>better:</p>
<div class="sourceCode" id="cb641"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb641-1"><a href="#cb641-1" aria-hidden="true" tabindex="-1"></a>LET v <span class="op">:=</span> <span class="fl">1.0</span>; <span class="co">-- use scientific notation or add .0 to make a real literal</span></span></code></pre></div>
<h3 id="casts">Casts</h3>
<p>Redundant casts fatten the code and don’t really add anything to
readability. Sometimems it’s necessary to cast NULL to a particular type
so that you can be sure that generated result set has the right data
type, but most of the casts below are not necessary.</p>
<div class="sourceCode" id="cb642"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb642-1"><a href="#cb642-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb642-2"><a href="#cb642-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(foo.<span class="kw">id</span> <span class="kw">as</span> <span class="dt">INTEGER</span>) <span class="kw">as</span> <span class="kw">id</span>,</span>
<span id="cb642-3"><a href="#cb642-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(foo.name <span class="kw">as</span> TEXT) <span class="kw">as</span> name,</span>
<span id="cb642-4"><a href="#cb642-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> <span class="dt">REAL</span>) <span class="kw">as</span> rate</span>
<span id="cb642-5"><a href="#cb642-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb642-6"><a href="#cb642-6" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb642-7"><a href="#cb642-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb642-8"><a href="#cb642-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(bar.<span class="kw">id</span> <span class="kw">as</span> <span class="dt">INTEGER</span>) <span class="kw">as</span> <span class="kw">id</span>,</span>
<span id="cb642-9"><a href="#cb642-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> TEXT) <span class="kw">as</span> name,</span>
<span id="cb642-10"><a href="#cb642-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(bar.rate <span class="kw">as</span> <span class="dt">REAL</span>) <span class="kw">as</span> rate</span>
<span id="cb642-11"><a href="#cb642-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> bar</span></code></pre></div>
<p>Better [at some point, redundant casts actually started generating
errors.]</p>
<div class="sourceCode" id="cb643"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb643-1"><a href="#cb643-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb643-2"><a href="#cb643-2" aria-hidden="true" tabindex="-1"></a>    foo.<span class="kw">id</span>,</span>
<span id="cb643-3"><a href="#cb643-3" aria-hidden="true" tabindex="-1"></a>    foo.name,</span>
<span id="cb643-4"><a href="#cb643-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> <span class="dt">REAL</span>) <span class="kw">as</span> rate</span>
<span id="cb643-5"><a href="#cb643-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb643-6"><a href="#cb643-6" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb643-7"><a href="#cb643-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb643-8"><a href="#cb643-8" aria-hidden="true" tabindex="-1"></a>    bar.<span class="kw">id</span>,</span>
<span id="cb643-9"><a href="#cb643-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> TEXT) <span class="kw">as</span> name,</span>
<span id="cb643-10"><a href="#cb643-10" aria-hidden="true" tabindex="-1"></a>    bar.rate</span>
<span id="cb643-11"><a href="#cb643-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> bar</span></code></pre></div>
<p>It’s possible to do the following to make this even cleaner:</p>
<div class="sourceCode" id="cb644"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb644-1"><a href="#cb644-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- somewhere central</span></span>
<span id="cb644-2"><a href="#cb644-2" aria-hidden="true" tabindex="-1"></a>#define NULL_TEXT <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> TEXT)</span>
<span id="cb644-3"><a href="#cb644-3" aria-hidden="true" tabindex="-1"></a>#define NULL_REAL <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> <span class="dt">REAL</span>)</span>
<span id="cb644-4"><a href="#cb644-4" aria-hidden="true" tabindex="-1"></a>#define NULL_INT <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> <span class="dt">INTEGER</span>)</span>
<span id="cb644-5"><a href="#cb644-5" aria-hidden="true" tabindex="-1"></a>#define NULL_LONG <span class="fu">CAST</span>(<span class="kw">NULL</span> <span class="kw">as</span> <span class="dt">LONG</span>)</span></code></pre></div>
<p>Then you can write</p>
<div class="sourceCode" id="cb645"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb645-1"><a href="#cb645-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb645-2"><a href="#cb645-2" aria-hidden="true" tabindex="-1"></a>    foo.<span class="kw">id</span>,</span>
<span id="cb645-3"><a href="#cb645-3" aria-hidden="true" tabindex="-1"></a>    foo.name,</span>
<span id="cb645-4"><a href="#cb645-4" aria-hidden="true" tabindex="-1"></a>    NULL_REAL <span class="kw">as</span> rate</span>
<span id="cb645-5"><a href="#cb645-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb645-6"><a href="#cb645-6" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb645-7"><a href="#cb645-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb645-8"><a href="#cb645-8" aria-hidden="true" tabindex="-1"></a>    bar.<span class="kw">id</span>,</span>
<span id="cb645-9"><a href="#cb645-9" aria-hidden="true" tabindex="-1"></a>    NULL_TEXT <span class="kw">as</span> name,</span>
<span id="cb645-10"><a href="#cb645-10" aria-hidden="true" tabindex="-1"></a>    bar.rate</span>
<span id="cb645-11"><a href="#cb645-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> bar</span></code></pre></div>
<h4 id="booleans">Booleans</h4>
<p>TRUE and FALSE can be used as boolean literals.</p>
<p>SQLite doesn’t care about the type but CQL will get the type
information it needs to make the columns of type BOOL</p>
<div class="sourceCode" id="cb646"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb646-1"><a href="#cb646-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb646-2"><a href="#cb646-2" aria-hidden="true" tabindex="-1"></a>    foo.<span class="kw">id</span>,</span>
<span id="cb646-3"><a href="#cb646-3" aria-hidden="true" tabindex="-1"></a>    foo.name,</span>
<span id="cb646-4"><a href="#cb646-4" aria-hidden="true" tabindex="-1"></a>    NULL_REAL <span class="kw">as</span> rate,</span>
<span id="cb646-5"><a href="#cb646-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">TRUE</span> <span class="kw">as</span> has_name,  <span class="co">-- this is a bit artificial but you get the idea</span></span>
<span id="cb646-6"><a href="#cb646-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FALSE</span> <span class="kw">as</span> has_rate</span>
<span id="cb646-7"><a href="#cb646-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb646-8"><a href="#cb646-8" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb646-9"><a href="#cb646-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb646-10"><a href="#cb646-10" aria-hidden="true" tabindex="-1"></a>    bar.<span class="kw">id</span>,</span>
<span id="cb646-11"><a href="#cb646-11" aria-hidden="true" tabindex="-1"></a>    NULL_TEXT <span class="kw">as</span> name,</span>
<span id="cb646-12"><a href="#cb646-12" aria-hidden="true" tabindex="-1"></a>    bar.rate,</span>
<span id="cb646-13"><a href="#cb646-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FALSE</span> <span class="kw">as</span> has_name,</span>
<span id="cb646-14"><a href="#cb646-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">TRUE</span> <span class="kw">as</span> has_rate</span>
<span id="cb646-15"><a href="#cb646-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> bar</span></code></pre></div>
<h3 id="boolean-expressions-and-casewhen">Boolean expressions and
CASE/WHEN</h3>
<p>It’s easy to get carried away with the power of <code>CASE</code>
expressions, I’ve seen this kind of thing:</p>
<div class="sourceCode" id="cb647"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb647-1"><a href="#cb647-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CAST</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> foo.name <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span> <span class="dv">0</span> <span class="cf">ELSE</span> <span class="dv">1</span> <span class="cf">END</span> <span class="kw">AS</span> BOOL)</span></code></pre></div>
<p>But this is simply</p>
<div class="sourceCode" id="cb648"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb648-1"><a href="#cb648-1" aria-hidden="true" tabindex="-1"></a>foo.name <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span></code></pre></div>
<p>In general, if your case alternates are booleans a direct boolean
expression would have served you better.</p>
<h3 id="case-and-cast-and-null">CASE and CAST and NULL</h3>
<p>Somtimes there’s clamping or filtering going on in a case
statement</p>
<div class="sourceCode" id="cb649"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb649-1"><a href="#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CAST</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> foo.name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span> <span class="cf">THEN</span> foo.name <span class="cf">ELSE</span> <span class="kw">NULL</span> <span class="cf">END</span> <span class="kw">AS</span> TEXT)</span></code></pre></div>
<p>Here the <code>CAST</code> is not needed at all so we could go to</p>
<div class="sourceCode" id="cb650"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb650-1"><a href="#cb650-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span> <span class="cf">WHEN</span> foo.name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span> <span class="cf">THEN</span> foo.name <span class="cf">ELSE</span> <span class="kw">NULL</span> <span class="cf">END</span></span></code></pre></div>
<p><code>NULL</code> is already the default value for the
<code>ELSE</code> clause so you never need <code>ELSE NULL</code></p>
<p>So better:</p>
<div class="sourceCode" id="cb651"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span> <span class="cf">WHEN</span> foo.name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span> <span class="cf">THEN</span> foo.name <span class="cf">END</span></span></code></pre></div>
<h3 id="filtering-out-nulls">Filtering out NULLs</h3>
<p>Consider</p>
<div class="sourceCode" id="cb652"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb652-1"><a href="#cb652-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb652-2"><a href="#cb652-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> foo</span>
<span id="cb652-3"><a href="#cb652-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> foo.name <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> foo.name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span>;</span></code></pre></div>
<p>There’s no need to test for <code>NOT NULL</code> here, the boolean
will result in <code>NULL</code> if <code>foo.name</code> is null which
is not true so the <code>WHERE</code> test will fail.</p>
<p>Better:</p>
<div class="sourceCode" id="cb653"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb653-2"><a href="#cb653-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> foo</span>
<span id="cb653-3"><a href="#cb653-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> foo.name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span>;</span></code></pre></div>
<h3 id="not-null-boolean-expressions">Not null boolean expressions</h3>
<p>In this statement we do not want to have a null result for the
boolean expression</p>
<div class="sourceCode" id="cb654"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb654-1"><a href="#cb654-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb654-2"><a href="#cb654-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span>,</span>
<span id="cb654-3"><a href="#cb654-3" aria-hidden="true" tabindex="-1"></a>    name,</span>
<span id="cb654-4"><a href="#cb654-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(IFNULL(name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span>, <span class="dv">0</span>) <span class="kw">AS</span> BOOL) <span class="kw">AS</span> name_bigger_than_m</span>
<span id="cb654-5"><a href="#cb654-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> FOO;</span></code></pre></div>
<p>So now we’ve made several mistakes. We could have used the usual
<code>FALSE</code> defintion to avoid the cast. But even that would have
left us with an IFNULL that’s harder to read. Here’s a much simpler
formulation:</p>
<div class="sourceCode" id="cb655"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb655-1"><a href="#cb655-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb655-2"><a href="#cb655-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span>,</span>
<span id="cb655-3"><a href="#cb655-3" aria-hidden="true" tabindex="-1"></a>    name,</span>
<span id="cb655-4"><a href="#cb655-4" aria-hidden="true" tabindex="-1"></a>    name <span class="op">&gt;</span> <span class="st">&#39;m&#39;</span> <span class="kw">IS</span> <span class="kw">TRUE</span> <span class="kw">AS</span> name_bigger_than_m</span>
<span id="cb655-5"><a href="#cb655-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> FOO;</span></code></pre></div>
<p>Even without the <code>TRUE</code> macro you could do
<code>IS 1</code> above and still get a result of type
<code>BOOL NOT NULL</code></p>
<h3 id="using-is-when-it-makes-sense-to-do-so">Using <code>IS</code>
when it makes sense to do so</h3>
<p>This kind of boolean expression is also verbose for no reason</p>
<div class="sourceCode" id="cb656"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb656-1"><a href="#cb656-1" aria-hidden="true" tabindex="-1"></a>    rate <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> rate <span class="op">=</span> <span class="dv">20</span></span></code></pre></div>
<p>In a <code>WHERE</code> clause probably <code>rate = 20</code>
suffices but even if you really need a <code>NOT NULL BOOL</code> result
the expression above is exactly what the <code>IS</code> operator is
for. e.g.</p>
<div class="sourceCode" id="cb657"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb657-1"><a href="#cb657-1" aria-hidden="true" tabindex="-1"></a>    rate <span class="kw">IS</span> <span class="dv">20</span></span></code></pre></div>
<p>The <code>IS</code> operator is frequently avoided except for
<code>IS NULL</code> and <code>IS NOT NULL</code> but it’s a general
equality operator with the added semantic that it never returns
<code>NULL</code>. <code>NULL IS NULL</code> is true.
<code>NULL IS [anything not null]</code> is false.</p>
<h3 id="left-joins-that-are-not-left-joins">Left joins that are not left
joins</h3>
<p>Consider</p>
<div class="sourceCode" id="cb658"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb658-1"><a href="#cb658-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> foo.<span class="kw">id</span>,</span>
<span id="cb658-2"><a href="#cb658-2" aria-hidden="true" tabindex="-1"></a>         foo.name,</span>
<span id="cb658-3"><a href="#cb658-3" aria-hidden="true" tabindex="-1"></a>         bar.rate</span>
<span id="cb658-4"><a href="#cb658-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb658-5"><a href="#cb658-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> bar <span class="kw">ON</span> foo.<span class="kw">id</span> <span class="op">=</span> bar.<span class="kw">id</span></span>
<span id="cb658-6"><a href="#cb658-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bar.rate <span class="op">&gt;</span> <span class="dv">5</span>;</span></code></pre></div>
<p>This is no longer a left join because the <code>WHERE</code> clause
demands a value for at least one column from <code>bar</code>.</p>
<p>Better:</p>
<div class="sourceCode" id="cb659"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb659-1"><a href="#cb659-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> foo.<span class="kw">id</span>,</span>
<span id="cb659-2"><a href="#cb659-2" aria-hidden="true" tabindex="-1"></a>         foo.name,</span>
<span id="cb659-3"><a href="#cb659-3" aria-hidden="true" tabindex="-1"></a>         bar.rate</span>
<span id="cb659-4"><a href="#cb659-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> foo</span>
<span id="cb659-5"><a href="#cb659-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> bar <span class="kw">ON</span> foo.<span class="kw">id</span> <span class="op">=</span> bar.<span class="kw">id</span></span>
<span id="cb659-6"><a href="#cb659-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> bar.rate <span class="op">&gt;</span> <span class="dv">5</span>;</span></code></pre></div>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-8-cql-best-practices">Appendix 8: CQL Best
Practices</h2>
<p>This is a brief discussion of every statement type and some general
best practices for that statement. The statements are in mostly
alphabetical order except related statements were moved up in the order
to make logical groups.</p>
<p>Refer also to Appendix 7: CQL Anti-patterns.</p>
<h3 id="data-definition-language-ddl">Data Definition Language
(DDL)</h3>
<ul>
<li><code>ALTER TABLE ADD COLUMN</code></li>
<li><code>CREATE INDEX</code></li>
<li><code>CREATE PROC</code></li>
<li><code>CREATE TABLE</code></li>
<li><code>CREATE TRIGGER</code></li>
<li><code>CREATE VIEW</code></li>
<li><code>CREATE VIRTUAL TABLE</code></li>
<li><code>DROP INDEX</code></li>
<li><code>DROP TABLE</code></li>
<li><code>DROP TRIGGER</code></li>
<li><code>DROP VIEW</code></li>
</ul>
<p>These statements almost never appear in normal procedures and
generally should be avoided. The normal way of handling schema in CQL is
to have one or more files declare all the schema you need and then let
CQL create a schema upgrader for you. This means you’ll never manually
drop tables or indices etc. The <code>create</code> declarations with
their annotations will totally drive the schema.</p>
<p>Any ad hoc DDL is usually a very bad sign. Test code is an obvious
exception to this as it often does setup and teardown of schema to set
up things for the test.</p>
<h3 id="ad-hoc-migrations-1">Ad Hoc Migrations</h3>
<ul>
<li><code>@SCHEMA_AD_HOC_MIGRATION</code></li>
</ul>
<p>This is a special upgrade step that should be taken at the version
indicated in the statement. These can be quite complex and even super
important but should not be used lightly. Any migration procedure has to
be highly tolerant of a variety of incoming schema versions and previous
partial successes. In any case this directive should not appear in
normal code. It should be part of the schema DDL declarations.</p>
<h3 id="transactions">Transactions</h3>
<ul>
<li><code>BEGIN TRANSACTION</code></li>
<li><code>COMMIT TRANSACTION</code></li>
<li><code>ROLLBACK TRANSACTION</code></li>
</ul>
<p>Transactions do not nest and most procedures do not know the context
in which they will be called, so the vast majority of procedures will
not and should not actually start transactions. You can only do this if
you know, somehow, for sure, that the procedure in question is somehow a
“top level” procedure. So generally, don’t use these statements.</p>
<h3 id="savepoints">Savepoints</h3>
<ul>
<li><code>SAVEPOINT</code></li>
<li><code>ROLLBACK TO SAVEPOINT</code></li>
<li><code>RELEASE SAVEPOINT</code></li>
<li><code>PROC SAVEPOINT</code></li>
<li><code>COMMIT RETURN</code></li>
<li><code>ROLLBACK RETURN</code></li>
</ul>
<p>Savepoints are the preferred tool for having interim state that can
be rolled back if needed. You can use ad hoc savepoints, just give your
save point and name then use <code>RELEASE SAVEPOINT</code> to commit
it, or else <code>ROLLBACK TO SAVEPOINT</code> followed by a
<code>RELEASE</code> to abort it. Note that you always
<code>RELEASE</code> savepoints in both the rollback and the commit
case.</p>
<p>Managing savepoints can be tricky, especially given the various error
cases. They combine nicely with <code>TRY CATCH</code> to do this job.
However, even that is a lot of boilerplate. The best way to use
savepoints is with <code>PROC SAVEPOINT BEGIN</code> ..
<code>END</code>;</p>
<p>When you use <code>PROC SAVEPOINT</code>, a savepoint is created for
you with the name of your procedure. When the block exits the savepoint
is released (committed). However you also get an automatically generated
try/catch block which will rollback the savepoint if anything inside the
block were to invoke <code>THROW</code>. Also, you may not use a regular
<code>RETURN</code> inside this block, you must use either
<code>ROLLBACK RETURN</code> or <code>COMMIT RETURN</code>. Both of
these directly indicate the fate of the automatically generated
statement when they run. This gives you useful options to early-out
(with no error) while keeping or abandoning any work in progress. Of
course you can use <code>THROW</code> to return an error and abandon the
work in progress.</p>
<h3 id="compilation-options">Compilation options</h3>
<ul>
<li><code>@ENFORCE_NORMAL</code></li>
<li><code>@ENFORCE_POP</code></li>
<li><code>@ENFORCE_PUSH</code></li>
<li><code>@ENFORCE_RESET</code></li>
<li><code>@ENFORCE_STRICT</code></li>
</ul>
<p>CQL allows you to specify a number of useful options such as “do not
allow Window Functions” or “all foreign keys must choose some update or
delete strategy”. These additional enforcements are designed to prevent
errors. Because of this they should be established once, somewhere
central and they should be rarely if ever overridden. For instance
<code>@ENFORCE_NORMAL WINDOW FUNCTION</code> would allow you to use
window functions again, but this is probably a bad idea. If strict mode
is on, disallowing them, that probably means your project is expected to
target versions of SQLite that do not have window functions. Overriding
that setting is likely to lead to runtime errors.</p>
<p>In general you don’t want to see these options in most code.</p>
<h3 id="previous-schema">Previous Schema</h3>
<ul>
<li><code>@PREVIOUS_SCHEMA</code></li>
</ul>
<p>CQL can ensure that the current schema is compatible with the
previous schema, meaning that an upgrade script could reasonably be
generated to go from the previous to the current. This directive demarks
the start of the previous schema section when that validation happens.
This directive is useless except for creating that schema validation so
it should never appear in normal procedures.</p>
<h3 id="schema-regions-1">Schema Regions</h3>
<ul>
<li><code>@BEGIN_SCHEMA_REGION</code></li>
<li><code>@DECLARE_DEPLOYABLE_REGION</code></li>
<li><code>@DECLARE_SCHEMA_REGION</code></li>
<li><code>@END_SCHEMA_REGION</code></li>
</ul>
<p>CQL allows you to declare arbitrary schema regions and limit what
parts of the schema any given region may consume. This helps you to
prevent schema from getting entangled. There is never a reason to use
this directives inside normal procedures; They should appear only in
your schema declaration files.</p>
<h3 id="schema-version">Schema Version</h3>
<ul>
<li><code>@SCHEMA_UPGRADE_SCRIPT</code></li>
<li><code>@SCHEMA_UPGRADE_VERSION</code></li>
</ul>
<p>The <code>@SCHEMA_UPGRADE_SCRIPT</code> directive is only used by CQL
itself to declare that the incoming file is an autogenerated schema
upgrade script. These scripts have slightly different rules for schema
declaration that are not useful outside of such scripts. So you should
never use this.</p>
<p><code>@SCHEMA_UPGRADE_VERSION</code> on the other hand is used if you
are creating a manual migration script. You need this script to run in
the context of the schema version that it affects. Use this directive at
the start of the file to do so. Generally manual migration scripts are
to be avoided so hopefully this directive is rarely if ever used.</p>
<h3 id="c-text-echo">C Text Echo</h3>
<ul>
<li><code>@ECHO</code></li>
</ul>
<p>This directive emits plain text directly into the compiler’s output
stream. It can be invaluable for adding new runtime features and for
ensuring that (e.g.) additional <code>#include</code> or
<code>#define</code> directives are present in the output but you can
really break things by over-using this feature. Most parts of the CQL
output are subject to change so any use of this should be super clean.
The intended use was, as mentioned, to allow an extra
<code>#include</code> in your code so that CQL could call into some
library. Most uses of this combine with <code>DECLARE FUNCTION</code> or
<code>DECLARE PROCEDURE</code> to declare an external entity.</p>
<h3 id="enumerations">Enumerations</h3>
<ul>
<li><code>DECLARE ENUM</code></li>
<li><code>@EMIT_ENUMS</code></li>
</ul>
<p>Avoid embedded constants whenever possible. Instead declare a
suitable enumeration. Use <code>@EMIT_ENUMS Some_Enum</code> to get the
enumeration constants into the generated .h file for C. But be sure to
do this only from one compiland. You do not want the enumerations in
every .h file. Choose a single .sql file (not included by lots of other
things) to place the <code>@EMIT_ENUMS</code> directive. You can make a
file specifically for this purpose if nothing else is serviceable.</p>
<h3 id="cursor-lifetime">Cursor Lifetime</h3>
<ul>
<li><code>CLOSE</code></li>
<li><code>OPEN</code></li>
</ul>
<p>The <code>OPEN</code> statement is a no-op, SQLite has no such
notion. It was included because it is present in <code>MYSQL</code> and
other variants and its inclusion can ease readability sometimes. But it
does nothing. The <code>CLOSE</code> statement is normally not necessary
because all cursors are closed at the end of the procedure they are
declared in (unless they are boxed, see below). You only need
<code>CLOSE</code> if you want to close a global cursor (which has no
scope) or if you want to close a local cursor “sooner” because waiting
to the end of the procedure might be a very long time. Using close more
than once is safe, the second and later close operations do nothing.</p>
<h3 id="procedure-calls-and-exceptions">Procedure Calls and
Exceptions</h3>
<ul>
<li><code>CALL</code></li>
<li><code>THROW</code></li>
<li><code>TRY CATCH</code></li>
</ul>
<p>Remember that if you call a procedure and it uses <code>THROW</code>
or else uses some SQL that failed, this return code will cause your code
to <code>THROW</code> when the procedure returns. Normally that’s
exactly what you want, the error will ripple out and some top-level
<code>CATCH</code> will cause a <code>ROLLBACK</code> and the top level
callers sees the error. If you have your own rollback needs be sure to
install your own <code>TRY</code>/<code>CATCH</code> block or else use
<code>PROC SAVEPOINT</code> as above to do it for you.</p>
<p>Inside of a <code>CATCH</code> block you can use the special variable
<code>@RC</code> to see the most recent return code from SQLite.</p>
<h3 id="control-flow-with-big-moves">Control Flow with “Big Moves”</h3>
<ul>
<li><code>CONTINUE</code></li>
<li><code>LEAVE</code></li>
<li><code>RETURN</code></li>
</ul>
<p>These work as usual but beware, you can easily use any of these to
accidentally leave a block with a savepoint or transaction and you might
skip over the <code>ROLLBACK</code> or <code>COMMIT</code> portions of
the logic. Avoid this problem by using <code>PROC SAVEPOINT</code>.</p>
<h3 id="getting-access-to-external-code">Getting access to external
code</h3>
<ul>
<li><code>DECLARE FUNCTION</code></li>
<li><code>DECLARE SELECT FUNCTION</code></li>
<li><code>DECLARE PROCEDURE</code></li>
</ul>
<p>The best practice is to put any declarations into a shared header
file which you can <code>#include</code> in all the places it is needed.
This is especially important should you have to forward declare a
procedure. CQL normally provides exports for all procedures so you
basically get an automatically generated and certain-to-be-correct
<code>#include</code> file. But, if the procedures are being compiled
together then an export file won’t have been generated yet at the time
you need it; To work around this you use the
<code>DECLARE PROCEDURE</code> form. However, procedure declarations are
tricky; they include not just the type of the arguments but the types of
any/all of the columns in any result set the procedure might have. This
must not be wrong or callers will get unpredictable failures.</p>
<p>The easiest way to ensure it is correct is to use the same trick as
you would in C – make sure that you <code>#include</code> the
declaration the in the translation unit with the definition. If they
don’t match there will be an error.</p>
<p>A very useful trick: the error will include the exact text of the
correct declaration. So if you don’t know it, or are too lazy to figure
it out; simply put <code>ANY</code> declaration in the shared header
file and then paste in the correct declaration from the error. should
the definition ever change you will get a compilation error which you
can again harvest to get the correct declaration.</p>
<p>In this way you can be sure the declarations are correct.</p>
<p>Functions have no CQL equivalent, but they generally don’t change
very often. Use <code>DECLARE FUNCTION</code> to allow access to some C
code that returns a result of some kind. Be sure to add the
<code>CREATE</code> option if the function returns a reference that the
caller owns.</p>
<p>Use <code>DECLARE SELECT FUNCTION</code> to tell CQL about any User
Defined Functions you have added to SQLite so that it knows how to call
them. Note that CQL does not register those UDFs, it couldn’t make that
call lacking the essential C information required to do so. If you find
that you are getting errors when calling a UDF the most likely reason
for the failure is that the UDF was declared but never registered with
SQLite at runtime. This happens in test code a lot – product code tends
to have some central place to register the UDFs and it normally runs at
startup, e.g. right after the schema is upgraded.</p>
<h3 id="regular-data-manipulation-language-dml">Regular Data
Manipulation Language (DML)</h3>
<ul>
<li><code>DELETE</code></li>
<li><code>INSERT</code></li>
<li><code>SELECT</code></li>
<li><code>UPDATE</code></li>
<li><code>UPSERT</code></li>
</ul>
<p>These statements are the most essential and they’ll appear in almost
every procedure. There are a few general best practices we can go
over.</p>
<ul>
<li><p>Try to do as much as you can in one batch rather than iterating;
e.g.</p>
<ul>
<li>don’t write a loop with a <code>DELETE</code> statement that deletes
one row if you can avoid it, write a delete statement that deletes all
you need to delete</li>
<li>don’t write a loop with of <code>SELECT</code> statement that
fetches one row, try to fetch all the rows you need with one select</li>
</ul></li>
<li><p>Make sure <code>UPSERT</code> is supported on the SQLite system
you are using, older versions do not support it</p></li>
<li><p>Don’t put unnecessary casts in your <code>SELECT</code>
statements, they just add fat</p></li>
<li><p>Don’t use <code>CASE</code>/<code>WHEN</code> to compute a
boolean, the boolean operations are more economical (e.g. use
<code>IS</code>)</p></li>
<li><p>Don’t use <code>COUNT</code> if all you need to know is whether a
row exists or not, use <code>EXISTS</code></p></li>
<li><p>Don’t use <code>GROUP BY</code>, <code>ORDER BY</code>, or
<code>DISTINCT</code> on large rowsets, the sort is expensive and it
will make your <code>SELECT</code> statements write to disk rather than
just read</p></li>
<li><p>Always use the <code>INSERT INTO FOO USING</code> form of the
<code>INSERT</code> statement, it’s much easier to read than the
standard form and compiles to the same thing</p></li>
</ul>
<h3 id="variable-and-cursor-declarations">Variable and Cursor
declarations</h3>
<ul>
<li><code>DECLARE OUT CALL</code></li>
<li><code>DECLARE</code></li>
<li><code>LET</code></li>
<li><code>SET</code></li>
</ul>
<p>These are likely to appear all over as well. If you can avoid a
variable declaration by using <code>LET</code> then do so; The code will
be more concise and you’ll get the exact variable type you need. This is
the same as <code>var x = foo();</code> in other languages. Once the
variable is declared use <code>SET</code>.</p>
<p>You can save yourself a lot of declarations of <code>OUT</code>
variables with <code>DECLARE OUT CALL</code>. That declaration form
automatically declares the <code>OUT</code> variables used in the call
you are about to make with the correct type. If the number of arguments
changes you just have to add the args you don’t have to also add new
declarations.</p>
<p>The <code>LIKE</code> construct can be used to let you declare things
whose type is the same as another thing. Patterns like
<code>DECLARE ARGS CURSOR LIKE FOO ARGUMENTS</code> save you a lot of
typing and also enhance correctness. There’s a whole chapter dedicated
to “shapes” defined by <code>LIKE</code>.</p>
<h3 id="query-plans">Query Plans</h3>
<ul>
<li><code>EXPLAIN</code></li>
</ul>
<p>Explain can be used in front of other queries to generate a plan. The
way SQLite handles this is that you fetch the rows of the plan as usual.
So basically <code>EXPLAIN</code> is kind of like
<code>SELECT QUERY PLAN OF</code>. This hardly ever comes up in normal
coding. CQL has an output option where it will generate code that gives
you the query plan for a procedures queries rather than the normal body
of the procedure.</p>
<h3 id="fetching-data-from-a-cursor-or-from-loose-data">Fetching Data
from a Cursor or from Loose Data</h3>
<ul>
<li><code>FETCH</code></li>
<li><code>UPDATE CURSOR</code></li>
</ul>
<p>The <code>FETCH</code> statement has many variations, all are useful
at some time or another. There are a few helpful guidelines.</p>
<ul>
<li>If fetching from loose values into a cursor use the
<code>FETCH USING</code> form (as you would with
<code>INSERT INTO USING</code>) because it is less error prone</li>
<li><code>FETCH INTO</code> is generally a bad idea, you’ll have to
declare a lot of variables, instead just rely on automatic storage in
the cursor e.g. <code>fetch my_cursor</code> rather than
<code>fetch my_cursor into a, b, c</code></li>
<li>If you have data already in a cursor you can mutate some of the
columns using <code>UPDATE CURSOR</code>, this can let you adjust values
or apply defaults</li>
</ul>
<h3 id="control-flow">Control Flow</h3>
<ul>
<li><code>IF</code></li>
<li><code>LOOP</code></li>
<li><code>SWITCH</code></li>
<li><code>WHILE</code></li>
</ul>
<p>These are your bread and butter and they will appear all over.</p>
<blockquote>
<p>TIP: Use the <code>ALL VALUES</code> variant of switch whenever
possible to ensure that you haven’t missed any cases.</p>
</blockquote>
<h3 id="manual-control-of-results">Manual Control of Results</h3>
<ul>
<li><p><code>OUT</code></p></li>
<li><p><code>OUT UNION</code></p></li>
<li><p>If you know you are producing exactly one row <code>OUT</code> is
more economical than <code>SELECT</code></p></li>
<li><p>If you need complete flexibility on what rows to produce
(e.g. skip some, add extras, mutate some) then <code>OUT UNION</code>
will give you that, use it only when needed, it’s more expensive than
just <code>SELECT</code></p></li>
</ul>
<h3 id="ctes-and-shared-fragments">CTEs and Shared Fragments</h3>
<p>To understand what kinds of things you can reasonably do with
fragments, really you just have to understand the things that you can do
with common table expressions or CTEs. For those who don’t know, CTEs
are the things you declare in the WITH clause of a SELECT statement.
They’re kind of like local views. Well, actually, they are exactly like
local views.</p>
<p>Query fragments help you to define useful CTEs so basically what you
can do economically in a CTE directly determines what you can do
economically in a fragment.</p>
<p>To demonstrate some things that happen with CTEs we’re going to use
these three boring tables.</p>
<div class="sourceCode" id="cb660"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb660-1"><a href="#cb660-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> A</span>
<span id="cb660-2"><a href="#cb660-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb660-3"><a href="#cb660-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb660-4"><a href="#cb660-4" aria-hidden="true" tabindex="-1"></a>   this text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb660-5"><a href="#cb660-5" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb660-6"><a href="#cb660-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb660-7"><a href="#cb660-7" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> B</span>
<span id="cb660-8"><a href="#cb660-8" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb660-9"><a href="#cb660-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb660-10"><a href="#cb660-10" aria-hidden="true" tabindex="-1"></a>   that text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb660-11"><a href="#cb660-11" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb660-12"><a href="#cb660-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb660-13"><a href="#cb660-13" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> C</span>
<span id="cb660-14"><a href="#cb660-14" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb660-15"><a href="#cb660-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb660-16"><a href="#cb660-16" aria-hidden="true" tabindex="-1"></a>   other text <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb660-17"><a href="#cb660-17" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>Let’s start with a very simple example, the first few examples are
like control cases.</p>
<div class="sourceCode" id="cb661"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb661-1"><a href="#cb661-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb661-2"><a href="#cb661-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A</span>
<span id="cb661-3"><a href="#cb661-3" aria-hidden="true" tabindex="-1"></a><span class="kw">inner</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> A.<span class="kw">id</span>;</span>
<span id="cb661-4"><a href="#cb661-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb661-5"><a href="#cb661-5" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb661-6"><a href="#cb661-6" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SCAN TABLE A</span></span>
<span id="cb661-7"><a href="#cb661-7" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>OK as we can see <code>A</code> is not constrained so it has to be
scanned but <code>B</code> isn’t scanned, we use its primary key for the
join. This is the most common kind of join: a search based on a key of
the table you are joining to.</p>
<p>Let’s make it a bit more realistic.</p>
<div class="sourceCode" id="cb662"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb662-1"><a href="#cb662-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb662-2"><a href="#cb662-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A</span>
<span id="cb662-3"><a href="#cb662-3" aria-hidden="true" tabindex="-1"></a><span class="kw">inner</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> A.<span class="kw">id</span></span>
<span id="cb662-4"><a href="#cb662-4" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> A.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb662-5"><a href="#cb662-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb662-6"><a href="#cb662-6" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb662-7"><a href="#cb662-7" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb662-8"><a href="#cb662-8" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>Now <code>A</code> is constrained by the <code>WHERE</code> clause so
we can use its index and then use the <code>B</code> index. So we get a
nice economical join from <code>A</code> to <code>B</code> and no scans
at all.</p>
<p>Now suppose we try this with some CTE replacements for <code>A</code>
and <code>B</code>. Does this make it worse?</p>
<div class="sourceCode" id="cb663"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb663-1"><a href="#cb663-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb663-2"><a href="#cb663-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb663-3"><a href="#cb663-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb663-4"><a href="#cb663-4" aria-hidden="true" tabindex="-1"></a>  BB(<span class="kw">id</span>, that) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> B)</span>
<span id="cb663-5"><a href="#cb663-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AA</span>
<span id="cb663-6"><a href="#cb663-6" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> BB <span class="kw">on</span> BB.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span></span>
<span id="cb663-7"><a href="#cb663-7" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> AA.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb663-8"><a href="#cb663-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb663-9"><a href="#cb663-9" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb663-10"><a href="#cb663-10" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb663-11"><a href="#cb663-11" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>The answer is a resounding no. The CTE <code>AA</code> was not
materialized it was expanded in place, as was the CTE <code>BB</code>.
We get <em>exactly</em> the same query plan. Now this means that the
inner expressions like <code>select * from A</code> could have been
fragments such as:</p>
<div class="sourceCode" id="cb664"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb664-1"><a href="#cb664-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb664-2"><a href="#cb664-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc A_()</span>
<span id="cb664-3"><a href="#cb664-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb664-4"><a href="#cb664-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A;</span>
<span id="cb664-5"><a href="#cb664-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb664-6"><a href="#cb664-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-7"><a href="#cb664-7" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb664-8"><a href="#cb664-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc B_()</span>
<span id="cb664-9"><a href="#cb664-9" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb664-10"><a href="#cb664-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> B;</span>
<span id="cb664-11"><a href="#cb664-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb664-12"><a href="#cb664-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-13"><a href="#cb664-13" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb664-14"><a href="#cb664-14" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb664-15"><a href="#cb664-15" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call</span> A_()),    <span class="co">-- short for A_(*) AS (call A_())</span></span>
<span id="cb664-16"><a href="#cb664-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call</span> B_())     <span class="co">-- short for B_(*) AS (call B_())</span></span>
<span id="cb664-17"><a href="#cb664-17" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A_</span>
<span id="cb664-18"><a href="#cb664-18" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> B_ <span class="kw">on</span> B_.<span class="kw">id</span> <span class="op">=</span> A_.<span class="kw">id</span></span>
<span id="cb664-19"><a href="#cb664-19" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> A_.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span></code></pre></div>
<blockquote>
<p>NOTE: I’ll use the convention that <code>A_</code> is the fragment
proc that could have generated the CTE <code>AA</code>, likewise with
<code>B_</code> and so forth.</p>
</blockquote>
<p>The above will expand into exactly what we had before and hence will
have the exactly same good query plan. Of course this is totally goofy,
why make a fragment like that – it’s just more typing. Well now lets
generalize the fragments just a bit.</p>
<div class="sourceCode" id="cb665"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb665-1"><a href="#cb665-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb665-2"><a href="#cb665-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc A_(experiment bool <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb665-3"><a href="#cb665-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb665-4"><a href="#cb665-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- data source might come from somewhere else due to an experiment</span></span>
<span id="cb665-5"><a href="#cb665-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> experiment <span class="cf">then</span></span>
<span id="cb665-6"><a href="#cb665-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A;</span>
<span id="cb665-7"><a href="#cb665-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb665-8"><a href="#cb665-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="kw">id</span>, this <span class="kw">from</span> somewhere_else;</span>
<span id="cb665-9"><a href="#cb665-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb665-10"><a href="#cb665-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb665-11"><a href="#cb665-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb665-12"><a href="#cb665-12" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb665-13"><a href="#cb665-13" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc B_()</span>
<span id="cb665-14"><a href="#cb665-14" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb665-15"><a href="#cb665-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- we don&#39;t actually refer to &quot;B&quot; if the filter is null</span></span>
<span id="cb665-16"><a href="#cb665-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> b_filter <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span> <span class="cf">then</span></span>
<span id="cb665-17"><a href="#cb665-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- applies b_filter if specified</span></span>
<span id="cb665-18"><a href="#cb665-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> B <span class="kw">where</span> B.other <span class="kw">like</span> b_filter;</span>
<span id="cb665-19"><a href="#cb665-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb665-20"><a href="#cb665-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- generates the correct shape but zero rows of it</span></span>
<span id="cb665-21"><a href="#cb665-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="kw">null</span> <span class="kw">as</span> <span class="kw">id</span>, <span class="kw">null</span> <span class="kw">as</span> that <span class="kw">where</span> <span class="kw">false</span>;</span>
<span id="cb665-22"><a href="#cb665-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb665-23"><a href="#cb665-23" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb665-24"><a href="#cb665-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb665-25"><a href="#cb665-25" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc getAB(</span>
<span id="cb665-26"><a href="#cb665-26" aria-hidden="true" tabindex="-1"></a>    id_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb665-27"><a href="#cb665-27" aria-hidden="true" tabindex="-1"></a>    experiment bool <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb665-28"><a href="#cb665-28" aria-hidden="true" tabindex="-1"></a>    b_filter text)</span>
<span id="cb665-29"><a href="#cb665-29" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb665-30"><a href="#cb665-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">with</span></span>
<span id="cb665-31"><a href="#cb665-31" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">call</span> A_(experiment)),</span>
<span id="cb665-32"><a href="#cb665-32" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">call</span> B_(b_filter))</span>
<span id="cb665-33"><a href="#cb665-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A_</span>
<span id="cb665-34"><a href="#cb665-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">left</span> <span class="kw">join</span> B_ <span class="kw">on</span> B_.<span class="kw">id</span> <span class="op">=</span> A_.<span class="kw">id</span></span>
<span id="cb665-35"><a href="#cb665-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> A_.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb665-36"><a href="#cb665-36" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above now has 4 combos economically encoded and all of them have
a good plan. Importantly though, if <code>b_filter</code> is not
specified then we don’t actually join to <code>B</code>. The
<code>B_</code> CTE will have no reference to <code>B</code>, it just
has zero rows.</p>
<p>Now lets look at some things you don’t want to do.</p>
<p>Consider this form:</p>
<div class="sourceCode" id="cb666"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb666-2"><a href="#cb666-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb666-3"><a href="#cb666-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb666-4"><a href="#cb666-4" aria-hidden="true" tabindex="-1"></a>  BB(<span class="kw">id</span>, that) <span class="kw">as</span> (<span class="kw">select</span> A.<span class="kw">id</span>, B.that <span class="kw">from</span> A <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> A.<span class="kw">id</span>)</span>
<span id="cb666-5"><a href="#cb666-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AA</span>
<span id="cb666-6"><a href="#cb666-6" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> BB <span class="kw">on</span> BB.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span></span>
<span id="cb666-7"><a href="#cb666-7" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> AA.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb666-8"><a href="#cb666-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb666-9"><a href="#cb666-9" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb666-10"><a href="#cb666-10" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb666-11"><a href="#cb666-11" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb666-12"><a href="#cb666-12" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>Note that here we get 3 joins. Now a pretty cool thing happened here
– even though the expression for <code>BB</code> does not include a
<code>WHERE</code> clause SQLite has figured out the <code>AA.id</code>
being 5 forces <code>A.id</code> to be 5 which in turn gives a
constraint on <code>BB</code>. Nice job SQLite. If it hadn’t been able
to figure that out then the expansion of <code>BB</code> would have
resulted in a table scan.</p>
<p>Still, 3 joins is bad when we only need 2 joins to do the job. What
happened? Well, when we did the original fragments with extensions and
stuff we saw this same pattern in fragment code. Basically the fragment
for <code>BB</code> isn’t just doing the <code>B</code> things it’s
restarting from <code>A</code> and doing its own join to get
<code>B</code>. This results in a wasted join. And it might result in a
lot of work on the <code>A</code> table as well if the filtering was
more complex and couldn’t be perfectly inferred.</p>
<p>You might think, “oh, no problem, I can save this, I’ll just refer to
<code>AA</code> instead of <code>A</code> in the second query.”</p>
<p>This does not help (but it’s going in the right direction):</p>
<div class="sourceCode" id="cb667"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb667-1"><a href="#cb667-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb667-2"><a href="#cb667-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb667-3"><a href="#cb667-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb667-4"><a href="#cb667-4" aria-hidden="true" tabindex="-1"></a>  BB(<span class="kw">id</span>, that) <span class="kw">as</span> (<span class="kw">select</span> AA.<span class="kw">id</span>, B.that <span class="kw">from</span> AA <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span>)</span>
<span id="cb667-5"><a href="#cb667-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AA</span>
<span id="cb667-6"><a href="#cb667-6" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> BB <span class="kw">on</span> BB.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span></span>
<span id="cb667-7"><a href="#cb667-7" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> AA.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb667-8"><a href="#cb667-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb667-9"><a href="#cb667-9" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb667-10"><a href="#cb667-10" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb667-11"><a href="#cb667-11" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb667-12"><a href="#cb667-12" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>In terms of fragments the anti-pattern is this.</p>
<div class="sourceCode" id="cb668"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb668-2"><a href="#cb668-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc B_()</span>
<span id="cb668-3"><a href="#cb668-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb668-4"><a href="#cb668-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> B.<span class="op">*</span> <span class="kw">from</span> A <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> A.<span class="kw">id</span>;</span>
<span id="cb668-5"><a href="#cb668-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>The above starts the query for <code>B</code> again from the root.
You can save this, the trick is to not try to generate just the
<code>B</code> columns and then join them later. You can get a nice data
flow going with chain of CTEs.</p>
<div class="sourceCode" id="cb669"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb669-1"><a href="#cb669-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb669-2"><a href="#cb669-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb669-3"><a href="#cb669-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb669-4"><a href="#cb669-4" aria-hidden="true" tabindex="-1"></a>  AB(<span class="kw">id</span>, this, that) <span class="kw">as</span> (<span class="kw">select</span> AA.<span class="op">*</span>, B.that <span class="kw">from</span> AA <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span>)</span>
<span id="cb669-5"><a href="#cb669-5" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AB</span>
<span id="cb669-6"><a href="#cb669-6" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> AB.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb669-7"><a href="#cb669-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb669-8"><a href="#cb669-8" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb669-9"><a href="#cb669-9" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb669-10"><a href="#cb669-10" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>And we’re right back to the perfect plan. The good form creates a CTE
chain where we only need the result of the final CTE. A straight line of
CTEs each depending on the previous one results in a excellent data
flow.</p>
<p>In terms of fragments this is now:</p>
<div class="sourceCode" id="cb670"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb670-1"><a href="#cb670-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb670-2"><a href="#cb670-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc A_()</span>
<span id="cb670-3"><a href="#cb670-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb670-4"><a href="#cb670-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A;</span>
<span id="cb670-5"><a href="#cb670-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb670-6"><a href="#cb670-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb670-7"><a href="#cb670-7" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb670-8"><a href="#cb670-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc AB_()</span>
<span id="cb670-9"><a href="#cb670-9" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb670-10"><a href="#cb670-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">with</span></span>
<span id="cb670-11"><a href="#cb670-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call</span> A_)</span>
<span id="cb670-12"><a href="#cb670-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> A_.<span class="op">*</span>, B.that <span class="kw">from</span> A_ <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> A_.<span class="kw">id</span></span>
<span id="cb670-13"><a href="#cb670-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb670-14"><a href="#cb670-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb670-15"><a href="#cb670-15" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> (<span class="kw">call</span> AB_())</span>
<span id="cb670-16"><a href="#cb670-16" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AB_ <span class="kw">where</span> AB_.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span></code></pre></div>
<p>For brevity we haven’t included the possibility of using conditional
fragments (i.e. <code>IF</code> statements) the same good query plan
could be generated in that way.</p>
<p>We can generalize <code>AB_</code> so that it doesn’t know where the
base data is coming from and can be used in more cases.</p>
<div class="sourceCode" id="cb671"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb671-1"><a href="#cb671-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb671-2"><a href="#cb671-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc A_()</span>
<span id="cb671-3"><a href="#cb671-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb671-4"><a href="#cb671-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A;</span>
<span id="cb671-5"><a href="#cb671-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb671-6"><a href="#cb671-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb671-7"><a href="#cb671-7" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb671-8"><a href="#cb671-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc AB_()</span>
<span id="cb671-9"><a href="#cb671-9" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb671-10"><a href="#cb671-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">with</span></span>
<span id="cb671-11"><a href="#cb671-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">source</span>(<span class="op">*</span>) <span class="kw">like</span> A <span class="co">-- you must provide some source that is the same shape as A</span></span>
<span id="cb671-12"><a href="#cb671-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="kw">source</span>.<span class="op">*</span>, B.that <span class="kw">from</span> <span class="kw">source</span> <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> <span class="kw">source</span>.<span class="kw">id</span></span>
<span id="cb671-13"><a href="#cb671-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb671-14"><a href="#cb671-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb671-15"><a href="#cb671-15" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb671-16"><a href="#cb671-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">call</span> A_())</span>
<span id="cb671-17"><a href="#cb671-17" aria-hidden="true" tabindex="-1"></a>(<span class="kw">call</span> AB_() <span class="kw">using</span> A_ <span class="kw">as</span> <span class="kw">source</span>)</span>
<span id="cb671-18"><a href="#cb671-18" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AB_ <span class="kw">where</span> AB_.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span></code></pre></div>
<p>Again this results in a nice straight chain of CTEs and even though
the where clause is last the <code>A</code> table is constrained
properly.</p>
<p>It’s important not to fork the chain in the query plan, if that
happens then whatever came before the fork must be materialized for use
in both branches. That can be quite bad because then the filtering might
come after the materialization. This is an example that is quite
bad.</p>
<div class="sourceCode" id="cb672"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb672-1"><a href="#cb672-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb672-2"><a href="#cb672-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb672-3"><a href="#cb672-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb672-4"><a href="#cb672-4" aria-hidden="true" tabindex="-1"></a>  BB(<span class="kw">id</span>, that) <span class="kw">as</span> (<span class="kw">select</span> AA.<span class="kw">id</span>, B.that <span class="kw">from</span> AA <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span>),</span>
<span id="cb672-5"><a href="#cb672-5" aria-hidden="true" tabindex="-1"></a>  CC(<span class="kw">id</span>, other) <span class="kw">as</span> (<span class="kw">select</span> AA.<span class="kw">id</span>, C.other <span class="kw">from</span> AA <span class="kw">left</span> <span class="kw">join</span> C <span class="kw">on</span> C.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span>)</span>
<span id="cb672-6"><a href="#cb672-6" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> AA</span>
<span id="cb672-7"><a href="#cb672-7" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> BB <span class="kw">on</span> BB.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span></span>
<span id="cb672-8"><a href="#cb672-8" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> CC <span class="kw">on</span> CC.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span></span>
<span id="cb672-9"><a href="#cb672-9" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> AA.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb672-10"><a href="#cb672-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb672-11"><a href="#cb672-11" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb672-12"><a href="#cb672-12" aria-hidden="true" tabindex="-1"></a>|<span class="co">--MATERIALIZE 2</span></span>
<span id="cb672-13"><a href="#cb672-13" aria-hidden="true" tabindex="-1"></a>|  |<span class="co">--SCAN TABLE A</span></span>
<span id="cb672-14"><a href="#cb672-14" aria-hidden="true" tabindex="-1"></a>|  \<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb672-15"><a href="#cb672-15" aria-hidden="true" tabindex="-1"></a>|<span class="co">--MATERIALIZE 3</span></span>
<span id="cb672-16"><a href="#cb672-16" aria-hidden="true" tabindex="-1"></a>|  |<span class="co">--SCAN TABLE A</span></span>
<span id="cb672-17"><a href="#cb672-17" aria-hidden="true" tabindex="-1"></a>|  \<span class="co">--SEARCH TABLE C USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb672-18"><a href="#cb672-18" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb672-19"><a href="#cb672-19" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SCAN SUBQUERY 2</span></span>
<span id="cb672-20"><a href="#cb672-20" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH SUBQUERY 3 USING AUTOMATIC COVERING INDEX (id=?)</span></span></code></pre></div>
<p>Things have gone poorly here. As you can see <code>A</code> is now
scanned twice. and there are many more joins. We could make this a lot
better by moving the <code>A</code> condition all the way up into the
first CTE. With fragments that would just mean creating something
like:</p>
<div class="sourceCode" id="cb673"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb673-1"><a href="#cb673-1" aria-hidden="true" tabindex="-1"></a>[[shared_fragment]]</span>
<span id="cb673-2"><a href="#cb673-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc A_(id_)</span>
<span id="cb673-3"><a href="#cb673-3" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb673-4"><a href="#cb673-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A <span class="kw">where</span> A.<span class="kw">id</span> <span class="op">=</span> id_;</span>
<span id="cb673-5"><a href="#cb673-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<p>At least then if we have to materialize we’ll get only one row. This
could be a good thing to do universally, but it’s especially important
if you know that forking in the query shape is mandatory for some
reason.</p>
<p>A better pattern might be this:</p>
<div class="sourceCode" id="cb674"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb674-1"><a href="#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="kw">explain</span> <span class="kw">query</span> <span class="kw">plan</span></span>
<span id="cb674-2"><a href="#cb674-2" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span></span>
<span id="cb674-3"><a href="#cb674-3" aria-hidden="true" tabindex="-1"></a>  AA(<span class="kw">id</span>, this) <span class="kw">as</span> (<span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> A),</span>
<span id="cb674-4"><a href="#cb674-4" aria-hidden="true" tabindex="-1"></a>  AB(<span class="kw">id</span>, this, that) <span class="kw">as</span> (<span class="kw">select</span> AA.<span class="op">*</span>, B.that <span class="kw">from</span> AA <span class="kw">left</span> <span class="kw">join</span> B <span class="kw">on</span> B.<span class="kw">id</span> <span class="op">=</span> AA.<span class="kw">id</span>),</span>
<span id="cb674-5"><a href="#cb674-5" aria-hidden="true" tabindex="-1"></a>  ABC(<span class="kw">id</span>, this, that, other) <span class="kw">as</span> (<span class="kw">select</span> AB.<span class="op">*</span>, C.other <span class="kw">from</span> AB <span class="kw">left</span> <span class="kw">join</span> C <span class="kw">on</span> C.<span class="kw">id</span> <span class="op">=</span> AB.<span class="kw">id</span>)</span>
<span id="cb674-6"><a href="#cb674-6" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> ABC</span>
<span id="cb674-7"><a href="#cb674-7" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> ABC.<span class="kw">id</span> <span class="op">=</span> <span class="dv">5</span>;</span>
<span id="cb674-8"><a href="#cb674-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb674-9"><a href="#cb674-9" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span> <span class="kw">PLAN</span></span>
<span id="cb674-10"><a href="#cb674-10" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE A USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb674-11"><a href="#cb674-11" aria-hidden="true" tabindex="-1"></a>|<span class="co">--SEARCH TABLE B USING INTEGER PRIMARY KEY (rowid=?)</span></span>
<span id="cb674-12"><a href="#cb674-12" aria-hidden="true" tabindex="-1"></a>\<span class="co">--SEARCH TABLE C USING INTEGER PRIMARY KEY (rowid=?)</span></span></code></pre></div>
<p>Here we’ve just extended the chain. With shared fragments you could
easily build an <code>AB_</code> proc as before and then build an
<code>ABC_</code> proc either by calling <code>AB_</code> directly or by
having a table parameter that is <code>LIKE AB_</code>.</p>
<p>Both cases will give you a great plan.</p>
<p>So the most important things are:</p>
<ul>
<li>Avoid forking the chain of CTEs/fragments, a straight chain works
great.</li>
<li>Avoid re-joining to tables, even unconstrained CTEs result in great
plans if they don’t have to be materialized.</li>
<li>If you do need to fork in your CTE chain, because of your desired
shape, be sure to move as many filters as you can further upstream so
that by the time you materialize only a very small number of rows need
to be materialiized.</li>
</ul>
<p>These few rules will go far in helping you to create shapes.</p>
<p>One last thing, without shared fragments, if you wanted to create a
large join the normal way, maybe 10 tables or so, then you have to type
that join into your file and it would be very much in your face. Shared
fragments might hide that join from you in a nice easy-to-use fragment.
Which you might then decide you want to use the fragment 3 times… And
now with a tiny amount of code you have 30 joins.</p>
<p>The thing is shared fragments make it easy to generate a lot of SQL.
It’s not bad that shared fragments make things easy, but with great
power comes great responsibility, so give a care as to what it is you
are assembling. Understanding your fragments, especially any big ones,
will help you to create great code.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-9-using-the-cql-amalgam">Appendix 9: Using the CQL
Amalgam</h2>
<p>This is a brief discussion of the CQL Amalgam and its normal usage
patterns.</p>
<h3 id="building-the-amalgam">Building the Amalgam</h3>
<p>The amalgam has to include the results of bison and flex, so a normal
build must run first. The simplest way to build it starting from the
<code>sources</code> directory is:</p>
<div class="sourceCode" id="cb675"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb675-1"><a href="#cb675-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb675-2"><a href="#cb675-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./make_amalgam.sh</span></span></code></pre></div>
<p>The result goes in <code>out/cql_amalgam.c</code>. It can then be
built using <code>cc</code> with whatever flags you might desire. With a
few <code>-D</code> directives it can readily be compiled with Microsoft
C and it also works with Emscripten (<code>emcc</code>) basically
unchanged. Clang and Gcc of course also work.</p>
<p>The standard test script <code>test.sh</code> builds the amalgam and
attempts to compile it as well, which ensures that the amalgam can at
least compile at all times.</p>
<h3 id="testing-the-amalgam">Testing the Amalgam</h3>
<p>Of course you can do whatever tests you might like by simply
compiling the amalgam as is and then using it to compile things. But
importantly the test script <code>test.sh</code> can test the amalgam
build like so:</p>
<div class="sourceCode" id="cb676"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb676-1"><a href="#cb676-1" aria-hidden="true" tabindex="-1"></a><span class="ex">test.sh</span> <span class="at">--use_amalgam</span></span></code></pre></div>
<p>This runs all the normal tests using the binary built from the
amalgam rather than the normal binary.</p>
<p>Normal CQL development practices result in this happening pretty
often so the amalgam tends to stay in good shape. The code largely works
in either form with very few affordances for the amalgam build needed.
Most developers don’t even think about the amalgam build flavor; to a
first approximation “it just works”.</p>
<h3 id="using-the-amalgam">Using the Amalgam</h3>
<p>To use the amalgam you’ll want to do something like this:</p>
<div class="sourceCode" id="cb677"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb677-1"><a href="#cb677-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CQL_IS_NOT_MAIN </span><span class="dv">1</span></span>
<span id="cb677-2"><a href="#cb677-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-3"><a href="#cb677-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Suppresses a bunch of warnings because the code</span></span>
<span id="cb677-4"><a href="#cb677-4" aria-hidden="true" tabindex="-1"></a><span class="co">// is in an #include context</span></span>
<span id="cb677-5"><a href="#cb677-5" aria-hidden="true" tabindex="-1"></a><span class="co">// PR&#39;s to remove these are welcome :D</span></span>
<span id="cb677-6"><a href="#cb677-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma clang diagnostic ignored &quot;-Wnullability-completeness&quot;</span></span>
<span id="cb677-7"><a href="#cb677-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-8"><a href="#cb677-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;cql_amalgam.c&quot;</span></span>
<span id="cb677-9"><a href="#cb677-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-10"><a href="#cb677-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> go_for_it<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>your_buffer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb677-11"><a href="#cb677-11" aria-hidden="true" tabindex="-1"></a>  YY_BUFFER_STATE my_string_buffer <span class="op">=</span> yy_scan_string<span class="op">(</span>your_buffer<span class="op">);</span></span>
<span id="cb677-12"><a href="#cb677-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-13"><a href="#cb677-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Note: &quot;--in&quot; is irrelevant because the scanner is</span></span>
<span id="cb677-14"><a href="#cb677-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// going to read from the buffer above.</span></span>
<span id="cb677-15"><a href="#cb677-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb677-16"><a href="#cb677-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If you don&#39;t use yy_scan_string, you could use &quot;--in&quot;</span></span>
<span id="cb677-17"><a href="#cb677-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// to get data from a file.</span></span>
<span id="cb677-18"><a href="#cb677-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-19"><a href="#cb677-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> argc <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb677-20"><a href="#cb677-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="st">&quot;cql&quot;</span><span class="op">,</span> <span class="st">&quot;--cg&quot;</span><span class="op">,</span> <span class="st">&quot;foo.h&quot;</span><span class="op">,</span> <span class="st">&quot;foo.c&quot;</span> <span class="op">};</span></span>
<span id="cb677-21"><a href="#cb677-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-22"><a href="#cb677-22" aria-hidden="true" tabindex="-1"></a>  cql_main<span class="op">(</span>argc<span class="op">,</span> argv<span class="op">);</span></span>
<span id="cb677-23"><a href="#cb677-23" aria-hidden="true" tabindex="-1"></a>  yy_delete_buffer<span class="op">(</span>my_string_buffer<span class="op">);</span></span>
<span id="cb677-24"><a href="#cb677-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So the general pattern is:</p>
<ul>
<li>predefine the options you want to use (see below)</li>
<li>include the amalgam</li>
<li>add any functions you want that will call the amalgam</li>
</ul>
<p>Most amalgam functions are <code>static</code> to avoid name
conflicts. You will want to create your own public functions such as
<code>go_for_it</code> above that use the amalgam in all the ways you
desire.</p>
<p>You’ll want to avoid calling any internal functions other than
<code>cql_main</code> because they are liable to change.</p>
<blockquote>
<p>NOTE: The amalgam is C code not C++ code. Do not attempt to use it
inside of an <code>extern "C"</code> block in a C++ file. It won’t
build. If you want a C++ API, expose the C functions you need and write
a wrapper class.</p>
</blockquote>
<h3 id="cql-amalgam-options">CQL Amalgam Options</h3>
<p>The amalgam includes the following useful <code>#ifdef</code> options
to allow you to customize it.</p>
<ul>
<li>CQL_IS_NOT_MAIN</li>
<li>CQL_NO_SYSTEM_HEADERS</li>
<li>CQL_NO_DIAGNOSTIC_BLOCK</li>
<li>cql_emit_error</li>
<li>cql_emit_output</li>
<li>cql_open_file_for_write</li>
<li>cql_write_file</li>
</ul>
<h4 id="cql_is_not_main">CQL_IS_NOT_MAIN</h4>
<p>If this symbol is defined then <code>cql_main</code> will not be
redefined to be <code>main</code>.</p>
<p>As the comments in the source say:</p>
<div class="sourceCode" id="cb678"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb678-1"><a href="#cb678-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef CQL_IS_NOT_MAIN</span></span>
<span id="cb678-2"><a href="#cb678-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb678-3"><a href="#cb678-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Normally CQL is the main entry point.  If you are using CQL</span></span>
<span id="cb678-4"><a href="#cb678-4" aria-hidden="true" tabindex="-1"></a><span class="co">// in an embedded fashion then you want to invoke its main at</span></span>
<span id="cb678-5"><a href="#cb678-5" aria-hidden="true" tabindex="-1"></a><span class="co">// some other time. If you define CQL_IS_NOT_MAIN then cql_main</span></span>
<span id="cb678-6"><a href="#cb678-6" aria-hidden="true" tabindex="-1"></a><span class="co">// is not renamed to main.  You call cql_main when you want.</span></span>
<span id="cb678-7"><a href="#cb678-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb678-8"><a href="#cb678-8" aria-hidden="true" tabindex="-1"></a>  <span class="pp">#define cql_main main</span></span>
<span id="cb678-9"><a href="#cb678-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Set this symbol so that you own main and cql_main is called at your
pleasure.</p>
<h4 id="cql_no_system_headers">CQL_NO_SYSTEM_HEADERS</h4>
<p>The amalgam includes the normal <code>#include</code> directives
needed to make it compile, things like stdio and such. In your situation
these headers may not be appropriate. If
<code>CQL_NO_SYSTEM_HEADERS</code> is defined then the amalgam will not
include anything; you can then add whatever headers you need before you
include the amalgam.</p>
<h4 id="cql_no_diagnostic_block">CQL_NO_DIAGNOSTIC_BLOCK</h4>
<p>The amalgam includes a set of recommended directives for warnings to
suppress and include. If you want to make other choices for these you
can suppress the defaults by defining
<code>CQL_NO_DIAGNOSTIC_BLOCK</code>; you can then add whatever
diagnostic pragmas you want/need.</p>
<h4 id="cql_emit_error">cql_emit_error</h4>
<p>The amalgam uses <code>cql_emit_error</code> to write its messages to
stderr. The documentation is included in the code which is attached
here. If you want the error messages to go somewhere else, define
<code>cql_emit_error</code> as the name of your error handling function.
It should accept a <code>const char *</code> and record that string
however you deem appropriate.</p>
<div class="sourceCode" id="cb679"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb679-1"><a href="#cb679-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_emit_error</span></span>
<span id="cb679-2"><a href="#cb679-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb679-3"><a href="#cb679-3" aria-hidden="true" tabindex="-1"></a><span class="co">// CQL &quot;stderr&quot; outputs are emitted with this API.</span></span>
<span id="cb679-4"><a href="#cb679-4" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb679-5"><a href="#cb679-5" aria-hidden="true" tabindex="-1"></a><span class="co">// You can define it to be a method of your choice with</span></span>
<span id="cb679-6"><a href="#cb679-6" aria-hidden="true" tabindex="-1"></a><span class="co">// &quot;#define cql_emit_error your_method&quot; and then your method</span></span>
<span id="cb679-7"><a href="#cb679-7" aria-hidden="true" tabindex="-1"></a><span class="co">// will get the data instead. This will be whatever output the</span></span>
<span id="cb679-8"><a href="#cb679-8" aria-hidden="true" tabindex="-1"></a><span class="co">// compiler would have emitted to stderr.  This includes</span></span>
<span id="cb679-9"><a href="#cb679-9" aria-hidden="true" tabindex="-1"></a><span class="co">// semantic errors or invalid argument combinations.  Note that</span></span>
<span id="cb679-10"><a href="#cb679-10" aria-hidden="true" tabindex="-1"></a><span class="co">// CQL never emits error fragments with this API; you always</span></span>
<span id="cb679-11"><a href="#cb679-11" aria-hidden="true" tabindex="-1"></a><span class="co">// get all the text of one error.  This is important if you</span></span>
<span id="cb679-12"><a href="#cb679-12" aria-hidden="true" tabindex="-1"></a><span class="co">// are filtering or looking for particular errors in a test</span></span>
<span id="cb679-13"><a href="#cb679-13" aria-hidden="true" tabindex="-1"></a><span class="co">// harness or some such.</span></span>
<span id="cb679-14"><a href="#cb679-14" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb679-15"><a href="#cb679-15" aria-hidden="true" tabindex="-1"></a><span class="co">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></span>
<span id="cb679-16"><a href="#cb679-16" aria-hidden="true" tabindex="-1"></a><span class="co">// be freed.</span></span>
<span id="cb679-17"><a href="#cb679-17" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb679-18"><a href="#cb679-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Note: you may use cql_cleanup_and_exit to force a failure from</span></span>
<span id="cb679-19"><a href="#cb679-19" aria-hidden="true" tabindex="-1"></a><span class="co">// within this API but doing so might result in unexpected cleanup</span></span>
<span id="cb679-20"><a href="#cb679-20" aria-hidden="true" tabindex="-1"></a><span class="co">// paths that have not been tested.</span></span>
<span id="cb679-21"><a href="#cb679-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb679-22"><a href="#cb679-22" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cql_emit_error<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>err<span class="op">)</span> <span class="op">{</span></span>
<span id="cb679-23"><a href="#cb679-23" aria-hidden="true" tabindex="-1"></a>  fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> err<span class="op">);</span></span>
<span id="cb679-24"><a href="#cb679-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>error_capture<span class="op">)</span> <span class="op">{</span></span>
<span id="cb679-25"><a href="#cb679-25" aria-hidden="true" tabindex="-1"></a>    bprintf<span class="op">(</span>error_capture<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> err<span class="op">);</span></span>
<span id="cb679-26"><a href="#cb679-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb679-27"><a href="#cb679-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb679-28"><a href="#cb679-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb679-29"><a href="#cb679-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Typically you would
<code>#define cql_emit_error your_error_function</code> before you
include the amalgam and then define your_error_function elsewhere in
that file (before or after the amalgam is included are both fine).</p>
<h4 id="cql_emit_output">cql_emit_output</h4>
<p>The amalgam uses <code>cql_emit_output</code> to write its messages
to stdout. The documentation is included in the code which is attached
here. If you want the standard output to go somewhere else, define
<code>cql_emit_output</code> as the name of your output handling
function. It should accept a <code>const char *</code> and record that
string however you deem appropriate.</p>
<div class="sourceCode" id="cb680"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb680-1"><a href="#cb680-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_emit_output</span></span>
<span id="cb680-2"><a href="#cb680-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb680-3"><a href="#cb680-3" aria-hidden="true" tabindex="-1"></a><span class="co">// CQL &quot;stdout&quot; outputs are emitted (in arbitrarily small pieces)</span></span>
<span id="cb680-4"><a href="#cb680-4" aria-hidden="true" tabindex="-1"></a><span class="co">// with this API.</span></span>
<span id="cb680-5"><a href="#cb680-5" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb680-6"><a href="#cb680-6" aria-hidden="true" tabindex="-1"></a><span class="co">// You can define it to be a method of your choice with</span></span>
<span id="cb680-7"><a href="#cb680-7" aria-hidden="true" tabindex="-1"></a><span class="co">// &quot;#define cql_emit_output your_method&quot; and then your method will</span></span>
<span id="cb680-8"><a href="#cb680-8" aria-hidden="true" tabindex="-1"></a><span class="co">// get the data instead. This will be whatever output the</span></span>
<span id="cb680-9"><a href="#cb680-9" aria-hidden="true" tabindex="-1"></a><span class="co">// compiler would have emitted to stdout.  This is usually</span></span>
<span id="cb680-10"><a href="#cb680-10" aria-hidden="true" tabindex="-1"></a><span class="co">// reformated CQL or semantic trees and such -- not the normal</span></span>
<span id="cb680-11"><a href="#cb680-11" aria-hidden="true" tabindex="-1"></a><span class="co">// compiler output.</span></span>
<span id="cb680-12"><a href="#cb680-12" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb680-13"><a href="#cb680-13" aria-hidden="true" tabindex="-1"></a><span class="co">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></span>
<span id="cb680-14"><a href="#cb680-14" aria-hidden="true" tabindex="-1"></a><span class="co">// be freed.</span></span>
<span id="cb680-15"><a href="#cb680-15" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb680-16"><a href="#cb680-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Note: you may use cql_cleanup_and_exit to force a failure from</span></span>
<span id="cb680-17"><a href="#cb680-17" aria-hidden="true" tabindex="-1"></a><span class="co">// within this API but doing so might result in unexpected cleanup</span></span>
<span id="cb680-18"><a href="#cb680-18" aria-hidden="true" tabindex="-1"></a><span class="co">// paths that have not been tested.</span></span>
<span id="cb680-19"><a href="#cb680-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb680-20"><a href="#cb680-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cql_emit_output<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb680-21"><a href="#cb680-21" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb680-22"><a href="#cb680-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb680-23"><a href="#cb680-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb680-24"><a href="#cb680-24" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Typically you would
<code>#define cql_emit_output your_output_function</code> before you
include the amalgam and then define your_error_function elsewhere in
that file (before or after the amalgam is included are both fine).</p>
<h4 id="cql_open_file_for_write">cql_open_file_for_write</h4>
<p>If you still want normal file i/o for your output but you simply want
to control the placement of the output (such as forcing it to be on some
virtual drive) you can replace this function by defining
<code>cql_open_file_for_write</code>.</p>
<p>If all you need to do is control the origin of the
<code>FILE *</code> that is written to, you can replace just this
function.</p>
<div class="sourceCode" id="cb681"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb681-1"><a href="#cb681-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_open_file_for_write</span></span>
<span id="cb681-2"><a href="#cb681-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-3"><a href="#cb681-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Not a normal integration point, the normal thing to do is</span></span>
<span id="cb681-4"><a href="#cb681-4" aria-hidden="true" tabindex="-1"></a><span class="co">// replace cql_write_file but if all you need to do is adjust</span></span>
<span id="cb681-5"><a href="#cb681-5" aria-hidden="true" tabindex="-1"></a><span class="co">// the path or something like that you could replace</span></span>
<span id="cb681-6"><a href="#cb681-6" aria-hidden="true" tabindex="-1"></a><span class="co">// this method instead.  This presumes that a FILE * is still ok</span></span>
<span id="cb681-7"><a href="#cb681-7" aria-hidden="true" tabindex="-1"></a><span class="co">// for your scenario.</span></span>
<span id="cb681-8"><a href="#cb681-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-9"><a href="#cb681-9" aria-hidden="true" tabindex="-1"></a><span class="dt">FILE</span> <span class="op">*</span>_Nonnull cql_open_file_for_write<span class="op">(</span></span>
<span id="cb681-10"><a href="#cb681-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>_Nonnull file_name<span class="op">)</span></span>
<span id="cb681-11"><a href="#cb681-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb681-12"><a href="#cb681-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">FILE</span> <span class="op">*</span>file<span class="op">;</span></span>
<span id="cb681-13"><a href="#cb681-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!(</span>file <span class="op">=</span> fopen<span class="op">(</span>file_name<span class="op">,</span> <span class="st">&quot;w&quot;</span><span class="op">)))</span> <span class="op">{</span></span>
<span id="cb681-14"><a href="#cb681-14" aria-hidden="true" tabindex="-1"></a>    cql_error<span class="op">(</span><span class="st">&quot;unable to open </span><span class="sc">%s</span><span class="st"> for write</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> file_name<span class="op">);</span></span>
<span id="cb681-15"><a href="#cb681-15" aria-hidden="true" tabindex="-1"></a>    cql_cleanup_and_exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb681-16"><a href="#cb681-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb681-17"><a href="#cb681-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> file<span class="op">;</span></span>
<span id="cb681-18"><a href="#cb681-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb681-19"><a href="#cb681-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-20"><a href="#cb681-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Typically you would
<code>#define cql_open_file_for_write your_open_function</code> before
you include the amalgam and then define your_open_function elsewhere in
that file (before or after the amalgam is included are both fine).</p>
<h4 id="cql_write_file">cql_write_file</h4>
<p>The amalgam uses <code>cql_write_file</code> to write its compilation
outputs to the file system. The documentation is included in the code
which is attached here. If you want the compilation output to go
somewhere else, define <code>cql_write_file</code> as the name of your
output handling function. It should accept a <code>const char *</code>
for the file name and another for the data to be written. You can then
store those compilation results however you deem appropriate.</p>
<div class="sourceCode" id="cb682"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb682-1"><a href="#cb682-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_write_file</span></span>
<span id="cb682-2"><a href="#cb682-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb682-3"><a href="#cb682-3" aria-hidden="true" tabindex="-1"></a><span class="co">// CQL code generation outputs are emitted in one &quot;gulp&quot; with this</span></span>
<span id="cb682-4"><a href="#cb682-4" aria-hidden="true" tabindex="-1"></a><span class="co">// API. You can define it to be a method of your choice with</span></span>
<span id="cb682-5"><a href="#cb682-5" aria-hidden="true" tabindex="-1"></a><span class="co">// &quot;#define cql_write_file your_method&quot; and then your method will</span></span>
<span id="cb682-6"><a href="#cb682-6" aria-hidden="true" tabindex="-1"></a><span class="co">// get the filename and the data. This will be whatever output the</span></span>
<span id="cb682-7"><a href="#cb682-7" aria-hidden="true" tabindex="-1"></a><span class="co">// compiler would have emitted to one of it&#39;s --cg arguments.</span></span>
<span id="cb682-8"><a href="#cb682-8" aria-hidden="true" tabindex="-1"></a><span class="co">// You can then write it to a location of your choice.</span></span>
<span id="cb682-9"><a href="#cb682-9" aria-hidden="true" tabindex="-1"></a><span class="co">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></span>
<span id="cb682-10"><a href="#cb682-10" aria-hidden="true" tabindex="-1"></a><span class="co">// be freed.</span></span>
<span id="cb682-11"><a href="#cb682-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb682-12"><a href="#cb682-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Note: you *may* use cql_cleanup_and_exit to force a failure</span></span>
<span id="cb682-13"><a href="#cb682-13" aria-hidden="true" tabindex="-1"></a><span class="co">// from within this API.  That&#39;s a normal failure mode that is</span></span>
<span id="cb682-14"><a href="#cb682-14" aria-hidden="true" tabindex="-1"></a><span class="co">// well-tested.</span></span>
<span id="cb682-15"><a href="#cb682-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb682-16"><a href="#cb682-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cql_write_file<span class="op">(</span></span>
<span id="cb682-17"><a href="#cb682-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>_Nonnull file_name<span class="op">,</span></span>
<span id="cb682-18"><a href="#cb682-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>_Nonnull data<span class="op">)</span></span>
<span id="cb682-19"><a href="#cb682-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb682-20"><a href="#cb682-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">FILE</span> <span class="op">*</span>file <span class="op">=</span> cql_open_file_for_write<span class="op">(</span>file_name<span class="op">);</span></span>
<span id="cb682-21"><a href="#cb682-21" aria-hidden="true" tabindex="-1"></a>  fprintf<span class="op">(</span>file<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb682-22"><a href="#cb682-22" aria-hidden="true" tabindex="-1"></a>  fclose<span class="op">(</span>file<span class="op">);</span></span>
<span id="cb682-23"><a href="#cb682-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb682-24"><a href="#cb682-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb682-25"><a href="#cb682-25" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Typically you would
<code>#define cql_write_file your_write_function</code> before you
include the amalgam and then define your_write_function elsewhere in
that file (before or after the amalgam is included are both fine).</p>
<h3 id="amalgam-lean-choices">Amalgam LEAN choices</h3>
<p>When you include the amalgam, you get everything by default. You may,
however, only want some limited subset of the compiler’s functions in
your build.</p>
<p>To customize the amalgam, there are a set of configuration
pre-processor options. To opt-in to configuration, first define
<code>CQL_AMALGAM_LEAN</code>. You then have to opt-in to the various
pieces you might want. The system is useless without the parser, so you
can’t remove that; but you can choose from the list below.</p>
<p>The options are: *
CQL_AMALGAM_LEAN<code>: enable lean mode; this must be set or you get everything *</code>CQL_AMALGAM_CG_C<code>: C codegen *</code>CQL_AMALGAM_CG_COMMON<code>: common code generator pieces *</code>CQL_AMALGAM_GEN_SQL<code>: the echoing features *</code>CQL_AMALGAM_JSON<code>: JSON schema output *</code>CQL_AMALGAM_OBJC<code>: Objective-C code gen *</code>CQL_AMALGAM_QUERY_PLAN<code>: the query plan creator *</code>CQL_AMALGAM_SCHEMA<code>: the assorted schema output types *</code>CQL_AMALGAM_SEM<code>: semantic analysis (needed by most things) *</code>CQL_AMALGAM_TEST_HELPERS<code>: test helper output *</code>CQL_AMALGAM_UNIT_TESTS`
: some internal unit tests, which are pretty much needed by nobody</p>
<p>Note that <code>CQL_AMALGAM_SEM</code> is necessary for any of the
code generation features to work. Likewise, several generators require
<code>CQL_AMALGAM_CG_COMMON</code> (e.g., C does).</p>
<p>Pick what you want; stubs are created for what you omit to avoid
linkage errors.</p>
<h3 id="other-notes">Other Notes</h3>
<p>The amalgam will use malloc/calloc for its allocations and it is
designed to release all memory it has allocated when cql_main returns
control to you, even in the face of error.</p>
<p>Internal compilation errors result in an <code>assert</code> failure
leading to an abort. This is not supposed to ever happen but there can
always be bugs. Normal errors just prevent later phases of the compiler
from running so you might not see file output, but rather just error
output. In all cases things should be cleaned up.</p>
<p>The compiler can be called repeatedly with no troubles; it
re-initializes on each use. The compiler is not multi-threaded so if
there is threading you should use some mutex arrangement to keep it
safe. A thread-safe version would require extensive modifications.</p>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-10-cql-working-example">Appendix 10: CQL Working
Example</h2>
<p>This is a working example that shows all of the basic DML statements
and the call patterns to access them. The code also includes the various
helpers you can use to convert C types to CQL types.</p>
<h4 id="todo.sql"><code>todo.sql</code></h4>
<div class="sourceCode" id="cb683"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb683-1"><a href="#cb683-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- This is a simple schema for keeping track of tasks and whether or not they have been completed</span></span>
<span id="cb683-2"><a href="#cb683-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-3"><a href="#cb683-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- this serves to both declare the table and create the schema</span></span>
<span id="cb683-4"><a href="#cb683-4" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc todo_create_tables()</span>
<span id="cb683-5"><a href="#cb683-5" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb683-6"><a href="#cb683-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">create</span> <span class="kw">table</span> <span class="cf">if</span> <span class="kw">not</span> <span class="kw">exists</span> tasks(</span>
<span id="cb683-7"><a href="#cb683-7" aria-hidden="true" tabindex="-1"></a>    description text <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb683-8"><a href="#cb683-8" aria-hidden="true" tabindex="-1"></a>    done bool <span class="kw">default</span> <span class="kw">false</span> <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb683-9"><a href="#cb683-9" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb683-10"><a href="#cb683-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb683-11"><a href="#cb683-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-12"><a href="#cb683-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- adds a new not-done task</span></span>
<span id="cb683-13"><a href="#cb683-13" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc todo_add(task TEXT <span class="kw">NOT</span> <span class="kw">null</span>)</span>
<span id="cb683-14"><a href="#cb683-14" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb683-15"><a href="#cb683-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> <span class="kw">into</span> tasks <span class="kw">values</span>(task, <span class="kw">false</span>);</span>
<span id="cb683-16"><a href="#cb683-16" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb683-17"><a href="#cb683-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-18"><a href="#cb683-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- gets the tasks in inserted order</span></span>
<span id="cb683-19"><a href="#cb683-19" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc todo_tasks()</span>
<span id="cb683-20"><a href="#cb683-20" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb683-21"><a href="#cb683-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="dt">rowid</span>, description, done <span class="kw">from</span> tasks <span class="kw">order</span> <span class="kw">by</span> <span class="dt">rowid</span>;</span>
<span id="cb683-22"><a href="#cb683-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb683-23"><a href="#cb683-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-24"><a href="#cb683-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- updates a given task by rowid</span></span>
<span id="cb683-25"><a href="#cb683-25" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc todo_setdone_(rowid_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>, done_ bool <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb683-26"><a href="#cb683-26" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb683-27"><a href="#cb683-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">update</span> tasks <span class="kw">set</span> done <span class="op">=</span> done_ <span class="kw">where</span> <span class="dt">rowid</span> <span class="op">==</span> rowid_;</span>
<span id="cb683-28"><a href="#cb683-28" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span>
<span id="cb683-29"><a href="#cb683-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-30"><a href="#cb683-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- deletes a given task by rowid</span></span>
<span id="cb683-31"><a href="#cb683-31" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> proc todo_delete(rowid_ <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>)</span>
<span id="cb683-32"><a href="#cb683-32" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb683-33"><a href="#cb683-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span> <span class="kw">from</span> tasks <span class="kw">where</span> <span class="dt">rowid</span> <span class="op">==</span> rowid_;</span>
<span id="cb683-34"><a href="#cb683-34" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span>;</span></code></pre></div>
<h4 id="main.c"><code>main.c</code></h4>
<div class="sourceCode" id="cb684"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb684-1"><a href="#cb684-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb684-2"><a href="#cb684-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sqlite3.h&gt;</span></span>
<span id="cb684-3"><a href="#cb684-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-4"><a href="#cb684-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;todo.h&quot;</span></span>
<span id="cb684-5"><a href="#cb684-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-6"><a href="#cb684-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb684-7"><a href="#cb684-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb684-8"><a href="#cb684-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Note: not exactly world class error handling but that isn&#39;t the point */</span></span>
<span id="cb684-9"><a href="#cb684-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-10"><a href="#cb684-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// create a db</span></span>
<span id="cb684-11"><a href="#cb684-11" aria-hidden="true" tabindex="-1"></a>  sqlite3 <span class="op">*</span>db<span class="op">;</span></span>
<span id="cb684-12"><a href="#cb684-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> rc <span class="op">=</span> sqlite3_open<span class="op">(</span><span class="st">&quot;:memory:&quot;</span><span class="op">,</span> <span class="op">&amp;</span>db<span class="op">);</span></span>
<span id="cb684-13"><a href="#cb684-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-14"><a href="#cb684-14" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb684-15"><a href="#cb684-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-16"><a href="#cb684-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-17"><a href="#cb684-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make schema if needed (in memory databases always begin empty)</span></span>
<span id="cb684-18"><a href="#cb684-18" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> todo_create_tables<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb684-19"><a href="#cb684-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-20"><a href="#cb684-20" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb684-21"><a href="#cb684-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-22"><a href="#cb684-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-23"><a href="#cb684-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add some tasks</span></span>
<span id="cb684-24"><a href="#cb684-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> <span class="dt">const</span> default_tasks<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb684-25"><a href="#cb684-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Buy milk&quot;</span><span class="op">,</span></span>
<span id="cb684-26"><a href="#cb684-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Walk dog&quot;</span><span class="op">,</span></span>
<span id="cb684-27"><a href="#cb684-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Write code&quot;</span></span>
<span id="cb684-28"><a href="#cb684-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb684-29"><a href="#cb684-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-30"><a href="#cb684-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb684-31"><a href="#cb684-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// note we make a string reference from a c string here</span></span>
<span id="cb684-32"><a href="#cb684-32" aria-hidden="true" tabindex="-1"></a>    cql_string_ref dtask <span class="op">=</span> cql_string_ref_new<span class="op">(</span>default_tasks<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb684-33"><a href="#cb684-33" aria-hidden="true" tabindex="-1"></a>    rc <span class="op">=</span> todo_add<span class="op">(</span>db<span class="op">,</span> dtask<span class="op">);</span></span>
<span id="cb684-34"><a href="#cb684-34" aria-hidden="true" tabindex="-1"></a>    cql_string_release<span class="op">(</span>dtask<span class="op">);</span> <span class="co">// and then dispose of the reference</span></span>
<span id="cb684-35"><a href="#cb684-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-36"><a href="#cb684-36" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb684-37"><a href="#cb684-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb684-38"><a href="#cb684-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-39"><a href="#cb684-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-40"><a href="#cb684-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// mark a task as done</span></span>
<span id="cb684-41"><a href="#cb684-41" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> todo_setdone_<span class="op">(</span>db<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> true<span class="op">);</span></span>
<span id="cb684-42"><a href="#cb684-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-43"><a href="#cb684-43" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb684-44"><a href="#cb684-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-45"><a href="#cb684-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-46"><a href="#cb684-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// delete a row in the middle, rowid = 2</span></span>
<span id="cb684-47"><a href="#cb684-47" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> todo_delete<span class="op">(</span>db<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb684-48"><a href="#cb684-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-49"><a href="#cb684-49" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb684-50"><a href="#cb684-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-51"><a href="#cb684-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-52"><a href="#cb684-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// select out some results</span></span>
<span id="cb684-53"><a href="#cb684-53" aria-hidden="true" tabindex="-1"></a>  todo_tasks_result_set_ref result_set<span class="op">;</span></span>
<span id="cb684-54"><a href="#cb684-54" aria-hidden="true" tabindex="-1"></a>  rc <span class="op">=</span> todo_tasks_fetch_results<span class="op">(</span>db<span class="op">,</span> <span class="op">&amp;</span>result_set<span class="op">);</span></span>
<span id="cb684-55"><a href="#cb684-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>rc <span class="op">!=</span> SQLITE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb684-56"><a href="#cb684-56" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;error: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> rc<span class="op">);</span></span>
<span id="cb684-57"><a href="#cb684-57" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">6</span><span class="op">);</span></span>
<span id="cb684-58"><a href="#cb684-58" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-59"><a href="#cb684-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-60"><a href="#cb684-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// get result count</span></span>
<span id="cb684-61"><a href="#cb684-61" aria-hidden="true" tabindex="-1"></a>  cql_int32 result_count <span class="op">=</span> todo_tasks_result_count<span class="op">(</span>result_set<span class="op">);</span></span>
<span id="cb684-62"><a href="#cb684-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-63"><a href="#cb684-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">// loop to print</span></span>
<span id="cb684-64"><a href="#cb684-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>cql_int32 row <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> row <span class="op">&lt;</span> result_count<span class="op">;</span> row<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb684-65"><a href="#cb684-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// note &quot;get&quot; semantics mean that a ref count is not added</span></span>
<span id="cb684-66"><a href="#cb684-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if you want to keep the string you must &quot;retain&quot; it</span></span>
<span id="cb684-67"><a href="#cb684-67" aria-hidden="true" tabindex="-1"></a>    cql_string_ref text <span class="op">=</span> todo_tasks_get_description<span class="op">(</span>result_set<span class="op">,</span> row<span class="op">);</span></span>
<span id="cb684-68"><a href="#cb684-68" aria-hidden="true" tabindex="-1"></a>    cql_bool done <span class="op">=</span> todo_tasks_get_done<span class="op">(</span>result_set<span class="op">,</span> row<span class="op">);</span></span>
<span id="cb684-69"><a href="#cb684-69" aria-hidden="true" tabindex="-1"></a>    cql_int32 rowid <span class="op">=</span> todo_tasks_get_rowid<span class="op">(</span>result_set<span class="op">,</span> row<span class="op">);</span></span>
<span id="cb684-70"><a href="#cb684-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-71"><a href="#cb684-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// convert to c string format</span></span>
<span id="cb684-72"><a href="#cb684-72" aria-hidden="true" tabindex="-1"></a>    cql_alloc_cstr<span class="op">(</span>ctext<span class="op">,</span> text<span class="op">);</span></span>
<span id="cb684-73"><a href="#cb684-73" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: rowid:</span><span class="sc">%d</span><span class="st"> </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%s</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb684-74"><a href="#cb684-74" aria-hidden="true" tabindex="-1"></a>      row<span class="op">,</span> rowid<span class="op">,</span> ctext<span class="op">,</span> done <span class="op">?</span> <span class="st">&quot;done&quot;</span> <span class="op">:</span> <span class="st">&quot;not done&quot;</span><span class="op">);</span></span>
<span id="cb684-75"><a href="#cb684-75" aria-hidden="true" tabindex="-1"></a>    cql_free_cstr<span class="op">(</span>ctext<span class="op">,</span> text<span class="op">);</span></span>
<span id="cb684-76"><a href="#cb684-76" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-77"><a href="#cb684-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-78"><a href="#cb684-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">// done with results, free the lot</span></span>
<span id="cb684-79"><a href="#cb684-79" aria-hidden="true" tabindex="-1"></a>  cql_result_set_release<span class="op">(</span>result_set<span class="op">);</span></span>
<span id="cb684-80"><a href="#cb684-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-81"><a href="#cb684-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and close the database</span></span>
<span id="cb684-82"><a href="#cb684-82" aria-hidden="true" tabindex="-1"></a>  sqlite3_close<span class="op">(</span>db<span class="op">);</span></span>
<span id="cb684-83"><a href="#cb684-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="build-steps">Build Steps</h3>
<div class="sourceCode" id="cb685"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb685-1"><a href="#cb685-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ${cgsql} refers to the root of the CG/SQL repo</span></span>
<span id="cb685-2"><a href="#cb685-2" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> cql <span class="at">--in</span> todo.sql <span class="at">--cg</span> todo.h todo.c</span>
<span id="cb685-3"><a href="#cb685-3" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> cc <span class="at">-o</span> todo <span class="at">-I</span><span class="va">${cqsql}</span>/sources main.c todo.c <span class="va">${cgsql}</span>/sources/cqlrt.c <span class="at">-lsqlite3</span></span></code></pre></div>
<h3 id="results">Results</h3>
<p>Note that rowid 2 has been deleted, the leading number is the index
in the result set. The rowid is of course the database rowid.</p>
<pre><code>% ./todo
0: rowid:1 Buy milk (done)
1: rowid:3 Write code (not done)</code></pre>
<!---
-- Copyright (c) Meta Platforms, Inc. and affiliates.
--
-- This source code is licensed under the MIT license found in the
-- LICENSE file in the root directory of this source tree.
-->
<h2 id="appendix-11-production-considerations">Appendix 11: Production
Considerations</h2>
<h3 id="production-considerations">Production Considerations</h3>
<p>This system as it appears in the sources here is designed to get some
basic SQLite scenarios working but the runtime systems that are packaged
here are basic, if only for clarity. There are some important things you
should think about improving or customizing for your production
environment. Here’s a brief list.</p>
<h4 id="concurrency">Concurrency</h4>
<p>The reference counting solution in the stock <code>CQLRT</code>
implementation is single threaded. This might be ok, in many
environments only one thread is doing all the data access. But if you
plan to share objects between threads this is something you’ll want to
address. <code>CQLRT</code> is designed to be replacable. In fact there
is another version included in the distribution <code>cqlrt_cf</code>
that is more friendly to iOS and CoreFoundation. This alternate version
is an excellent demonstration of what is possible. There are more
details in <a href="internal.md#part-5-cql-runtime">Internals Part 5:
CQL Runtime</a></p>
<h4 id="statement-caching">Statement Caching</h4>
<p>SQLite statement management includes the ability to reset and
re-prepare statements. This is an important performance optimization but
the stock <code>CQLRT</code> does not take advantage of this. This is
for two reasons: first, simplicity, and secondly (though more
importantly), any kind of statement cache would require a caching policy
and this simple <code>CQLRT</code> cannot possibly know what might
consitute a good policy for your application.</p>
<p>The following three macros can be defined in your
<code>cqlrt.h</code> and they can be directed at a version that keeps a
cache of your choice.</p>
<div class="sourceCode" id="cb687"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb687-1"><a href="#cb687-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_sqlite3_exec</span></span>
<span id="cb687-2"><a href="#cb687-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define cql_sqlite3_exec</span><span class="op">(</span><span class="pp">db</span><span class="op">,</span><span class="pp"> sql</span><span class="op">)</span><span class="pp"> sqlite3_exec</span><span class="op">((</span><span class="pp">db</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">sql</span><span class="op">),</span><span class="pp"> NULL</span><span class="op">,</span><span class="pp"> NULL</span><span class="op">,</span><span class="pp"> NULL</span><span class="op">)</span></span>
<span id="cb687-3"><a href="#cb687-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb687-4"><a href="#cb687-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb687-5"><a href="#cb687-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_sqlite3_prepare_v2</span></span>
<span id="cb687-6"><a href="#cb687-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define cql_sqlite3_prepare_v2</span><span class="op">(</span><span class="pp">db</span><span class="op">,</span><span class="pp"> sql</span><span class="op">,</span><span class="pp"> len</span><span class="op">,</span><span class="pp"> stmt</span><span class="op">,</span><span class="pp"> tail</span><span class="op">)</span><span class="pp"> sqlite3_prepare_v2</span><span class="op">((</span><span class="pp">db</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">sql</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">len</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">stmt</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">tail</span><span class="op">))</span></span>
<span id="cb687-7"><a href="#cb687-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb687-8"><a href="#cb687-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb687-9"><a href="#cb687-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef cql_sqlite3_finalize</span></span>
<span id="cb687-10"><a href="#cb687-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define cql_sqlite3_finalize</span><span class="op">(</span><span class="pp">stmt</span><span class="op">)</span><span class="pp"> sqlite3_finalize</span><span class="op">((</span><span class="pp">stmt</span><span class="op">))</span></span>
<span id="cb687-11"><a href="#cb687-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>As you might expect, <code>prepare</code> creates a statement or else
returns one from the cache. When the <code>finalize</code> API is called
the indicated statement can be returned to the cache or discarded. The
<code>exec</code> API does both of these operations, but also, recall
that <code>exec</code> can get a semicolon separated list of statements.
Your <code>exec</code> implementation will have to use SQLite’s prepare
functions to split the list and get prepared statements for part of the
string. Alternately, you could choose not to cache in the
<code>exec</code> case.</p>
<h4 id="your-underlying-runtime">Your Underlying Runtime</h4>
<p>As you can see in <code>cqlrt_cf</code>, there is considerable
ability to define what the basic data types mean. Importantly, the
reference types <code>text</code>, <code>blob</code>, and
<code>object</code> can become something different (e.g., something
already supported by your environment). For instance, on Windows you
could use COM or .NET types for your objects. All object references are
substantially opaque to <code>CQLRT</code>; they have comparatively few
APIs that are defined in the runtime: things like getting the text out
of the string reference and so forth.</p>
<p>In addition to the basic types and operations you can also define a
few helper functions that allow you to create some more complex object
types. For instance, list, set, and dictionary creation and management
functions can be readily created and then you can declare them using the
<code>DECLARE FUNCTION</code> language features. These objects will then
be whatever list, set, or dictionary they need to be in order to
interoperate with the rest of your environment. You can define all the
data types you might need in your <code>CQLRT</code> and you can employ
whatever threading model and locking primitives you need for
correctness.</p>
<h4 id="debugging-and-tracing">Debugging and Tracing</h4>
<p>The <code>CQLRT</code> interface includes some helper macros for
logging. These are defined as no-ops by default but, of course, they can
be changed.</p>
<pre><code>#define cql_contract assert
#define cql_invariant assert
#define cql_tripwire assert
#define cql_log_database_error(...)
#define cql_error_trace()</code></pre>
<p><code>cql_contract</code> and <code>cql_invariant</code> are for
fatal errors. They both assert something that is expected to always be
true (like <code>assert</code>) with the only difference being that the
former is conventionally used to validate preconditions of
functions.</p>
<p><code>cql_tripwire</code> is a slightly softer form of assert that
should crash in debug builds but only log an error in production builds.
It is generally used to enforce a new condition that may not always hold
with the goal of eventually transitioning over to
<code>cql_contract</code> or <code>cql_invariant</code> once logging has
demonstrated that the tripwire is never hit. When a
<code>fetch_results</code> method is called, a failure results in a call
to <code>cql_log_database_error</code>. Presently the log format is very
simple. The invocation looks like this:</p>
<div class="sourceCode" id="cb689"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb689-1"><a href="#cb689-1" aria-hidden="true" tabindex="-1"></a> cql_log_database_error<span class="op">(</span>info<span class="op">-&gt;</span>db<span class="op">,</span> <span class="st">&quot;cql&quot;</span><span class="op">,</span> <span class="st">&quot;database error&quot;</span><span class="op">);</span></span></code></pre></div>
<p>The logging facility is expected to send the message to wherever is
appropriate for your environment. Additionally it will typically get the
failing result code and error message from SQLite, however these are
likely to be stale. Failed queries usually still require cleanup and so
the SQLite error codes be lost because (e.g.) a <code>finalize</code>
has happened, clearing the code. You can do better if, for instance,
your runtime caches the results of recent failed <code>prepare</code>
calls. In any case, what you log and where you log it is entirely up to
you.</p>
<p>The <code>cql_error_trace</code> macro is described in <a
href="internal.md#cleanup-and-errors">Internals Part 3</a> It will
typically invoke <code>printf</code> or <code>fprintf</code> or
something like that to trace the origin of thrown exceptions and to get
the error text from SQLite as soon as possible.</p>
<p>An example might be:</p>
<pre><code>#define cql_error_trace() fprintf(stderr, &quot;error %d in %s %s:%d\n&quot;, _rc_, _PROC_, __FILE__, __LINE_)</code></pre>
<p>Typically the cost of all these diagnostics is too high to include in
production code so this is turned on when debugging failures. But you
can make that choice for yourself.</p>
<h4 id="customizing-code-generation">Customizing Code Generation</h4>
<p>The file <code>rt_common.c</code> defines the common result types,
but the skeleton file <code>rt.c</code> includes affordances to add your
own types without having to worry about conflicts with the common types.
These macros define</p>
<div class="sourceCode" id="cb691"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb691-1"><a href="#cb691-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define RT_EXTRAS</span></span>
<span id="cb691-2"><a href="#cb691-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define RT_EXTRA_CLEANUP</span></span></code></pre></div>
<p>Simply define these two to create whatever <code>rt_</code> data
structures you want and add any cleanup function that might be needed to
release resources. The other cleanup functions should provide a good
template for you to make your own.</p>
<p>The C data type <code>rtdata</code> includes many text fragments that
directly control the code generation. If you want to make your generated
code look more like say CoreFoundation you can define an
<code>rtdata</code> that will do the job. This will mean a lot of your
generated code won’t require the <code>#defines</code> for the CQL
types, it can use your runtime directly. You can also enable things like
Pascal casing for procedure names and a common prefix on procedure names
if those are useful in your environment. However, the system is designed
so that such changes aren’t necessary. The data types in
<code>cqlrt.h</code> are enough for any remapping, additional changes
with <code>rtdata</code> are merely cosmetic.</p>
<h4 id="summary-1">Summary</h4>
<p>The <code>CQLRT</code> macros are very powerful, they allow you to
target almost any runtime with a C API. The <code>cqlrt_cf</code>
version is a good example of the sorts of changes you can make.</p>
<p>Concurrency and Statement Caching are not supported in the basic
version for <code>cqlrt.h</code>. If this is important to you you might
want to customize for that.</p>
<p>Helper functions for additional data types can be added, and they can
be unique to your runtime.</p>
<p>There are tracing macros to help with debugability. Providing some
useful versions of those can be of great help in production
environments.</p>
</body>
</html>
